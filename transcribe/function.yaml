kind: job
metadata:
  name: transcribe
  tag: ''
  hash: 6733477ea9a039b956a85db586cc0e9c1dc90527
  project: ''
  labels:
    author: yonatans
  categories:
  - data-preparation
  - machine-learning
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCmltcG9ydCBwYXRobGliCmltcG9ydCB0ZW1wZmlsZQpmcm9tIHR5cGluZyBpbXBvcnQgTGl0ZXJhbCwgVHVwbGUKCmltcG9ydCBtbHJ1bgppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCB3aGlzcGVyCmZyb20gbXV0YWdlbi5tcDMgaW1wb3J0IE1QMwpmcm9tIHRxZG0uYXV0byBpbXBvcnQgdHFkbQoKCmRlZiB0cmFuc2NyaWJlKAogICAgY29udGV4dDogbWxydW4uTUxDbGllbnRDdHgsCiAgICBhdWRpb19maWxlc19kaXJlY3Rvcnk6IHN0ciwKICAgIG1vZGVsX25hbWU6IHN0ciA9ICJiYXNlIiwKICAgIGRldmljZTogTGl0ZXJhbFsiY3VkYSIsICJjcHUiXSA9IE5vbmUsCiAgICBkZWNvZGluZ19vcHRpb25zOiBkaWN0ID0gTm9uZSwKICAgIG91dHB1dF9kaXJlY3Rvcnk6IHN0ciA9IE5vbmUsCikgLT4gVHVwbGVbcGF0aGxpYi5QYXRoLCBwZC5EYXRhRnJhbWUsIGRpY3RdOgogICAgIiIiCiAgICBUcmFuc2NyaWJlIGF1ZGlvIGZpbGVzIGludG8gdGV4dCBmaWxlcyBhbmQgY29sbGVjdCBhZGRpdGlvbmFsIGRhdGEuIFRoZSBlbmQgcmVzdWx0IGlzIGEgZGlyZWN0b3J5IG9mIHRyYW5zY3JpYmVkCiAgICB0ZXh0IGZpbGVzIGFuZCBhIGRhdGFmcmFtZSBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgY29sdW1uczoKCiAgICAqIGF1ZGlvX2ZpbGUgLSBUaGUgb3JpZ2luYWwgYXVkaW8gZmlsZSBuYW1lLgogICAgKiB0cmFuc2NyaXB0aW9uX2ZpbGUgLSBUaGUgdHJhbnNjcmliZWQgdGV4dCBmaWxlIG5hbWUgaW4gdGhlIG91dHB1dCBkaXJlY3RvcnkuCiAgICAqIGxhbmd1YWdlIC0gVGhlIGRldGVjdGVkIGxhbmd1YWdlIGluIHRoZSBhdWRpbyBmaWxlLgogICAgKiBsZW5ndGggLSBUaGUgbGVuZ3RoIG9mIHRoZSBhdWRpbyBmaWxlLgogICAgKiByYXRlX29mX3NwZWVjaCAtIFRoZSBudW1iZXIgb2Ygd29yZHMgZGl2aWRlZCBieSB0aGUgYXVkaW8gZmlsZSBsZW5ndGguCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBhdWRpb19maWxlc19kaXJlY3Rvcnk6IEEgZGlyZWN0b3J5IG9mIHRoZSBhdWRpbyBmaWxlcyB0byB0cmFuc2NyaWJlLgogICAgOnBhcmFtIG91dHB1dF9kaXJlY3Rvcnk6ICAgICAgUGF0aCB0byBhIGRpcmVjdG9yeSB0byBzYXZlIGFsbCB0cmFuc2NyaWJlZCBhdWRpbyBmaWxlcy4KICAgIDpwYXJhbSBtb2RlbF9uYW1lOiAgICAgICAgICAgIE9uZSBvZiB0aGUgb2ZmaWNpYWwgbW9kZWwgbmFtZXMgbGlzdGVkIGJ5IGB3aGlzcGVyLmF2YWlsYWJsZV9tb2RlbHMoKWAuCiAgICA6cGFyYW0gZGV2aWNlOiAgICAgICAgICAgICAgICBEZXZpY2UgdG8gbG9hZCB0aGUgbW9kZWwuIENhbiBiZSBvbmUgb2YgeyJjdWRhIiwgImNwdSJ9LiBEZWZhdWx0IHdpbGwgcHJlZmVyICJjdWRhIiBpZgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlLgogICAgOnBhcmFtIGRlY29kaW5nX29wdGlvbnM6ICAgICAgQSBkaWN0aW9uYXJ5IG9mIG9wdGlvbnMgdG8gY29uc3RydWN0IGEgYHdoaXNwZXIuRGVjb2RpbmdPcHRpb25zYC4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKCiAgICAgICAgICAgICAgKiBQYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5LgogICAgICAgICAgICAgICogQSBkYXRhZnJhbWUgZGF0YXNldCBvZiB0aGUgdHJhbnNjcmliZWQgZmlsZSBuYW1lcy4KICAgICAgICAgICAgICAqIEEgZGljdGlvbmFyeSBvZiBlcnJvcmVkIGZpbGVzIHRoYXQgd2VyZSBub3QgdHJhbnNjcmliZWQuCiAgICAiIiIKICAgICMgU2V0IG91dHB1dCBkaXJlY3Rvcnk6CiAgICBpZiBvdXRwdXRfZGlyZWN0b3J5IGlzIE5vbmU6CiAgICAgICAgb3V0cHV0X2RpcmVjdG9yeSA9IHRlbXBmaWxlLm1rZHRlbXAoKQoKICAgIGRlY29kaW5nX29wdGlvbnMgPSBkZWNvZGluZ19vcHRpb25zIG9yIGRpY3QoKQoKICAgICMgTG9hZCB0aGUgbW9kZWw6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9hZGluZyB3aGlzcGVyIG1vZGVsOiAne21vZGVsX25hbWV9JyIpCiAgICBtb2RlbCA9IHdoaXNwZXIubG9hZF9tb2RlbChtb2RlbF9uYW1lLCBkZXZpY2U9ZGV2aWNlKQogICAgY29udGV4dC5sb2dnZXIuaW5mbygiTW9kZWwgbG9hZGVkLiIpCgogICAgIyBQcmVwYXJlIHRoZSBkYXRhZnJhbWUgYW5kIGVycm9ycyB0byBiZSByZXR1cm5lZDoKICAgIGRmID0gcGQuRGF0YUZyYW1lKAogICAgICAgIGNvbHVtbnM9WwogICAgICAgICAgICAiYXVkaW9fZmlsZSIsCiAgICAgICAgICAgICJ0cmFuc2NyaXB0aW9uX2ZpbGUiLAogICAgICAgICAgICAibGFuZ3VhZ2UiLAogICAgICAgICAgICAibGVuZ3RoIiwKICAgICAgICAgICAgInJhdGVfb2Zfc3BlZWNoIiwKICAgICAgICBdCiAgICApCiAgICBlcnJvcnMgPSB7fQoKICAgICMgQ3JlYXRlIHRoZSBvdXRwdXQgZGlyZWN0b3J5OgogICAgb3V0cHV0X2RpcmVjdG9yeSA9IHBhdGhsaWIuUGF0aChvdXRwdXRfZGlyZWN0b3J5KQogICAgaWYgbm90IG91dHB1dF9kaXJlY3RvcnkuZXhpc3RzKCk6CiAgICAgICAgb3V0cHV0X2RpcmVjdG9yeS5ta2RpcigpCgogICAgIyBHbyBvdmVyIHRoZSBhdWRpbyBmaWxlcyBhbmQgdHJhbnNjcmliZToKICAgIGF1ZGlvX2ZpbGVzX2RpcmVjdG9yeSA9IHBhdGhsaWIuUGF0aChhdWRpb19maWxlc19kaXJlY3RvcnkpLmFic29sdXRlKCkKICAgIGZvciBpLCBhdWRpb19maWxlIGluIGVudW1lcmF0ZSgKICAgICAgICB0cWRtKGxpc3QoYXVkaW9fZmlsZXNfZGlyZWN0b3J5LnJnbG9iKCIqLioiKSksIGRlc2M9IlRyYW5zY3JpYmluZyIsIHVuaXQ9ImZpbGUiKQogICAgKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTG9hZCB0aGUgYXVkaW86CiAgICAgICAgICAgIGF1ZGlvID0gd2hpc3Blci5hdWRpby5sb2FkX2F1ZGlvKGZpbGU9c3RyKGF1ZGlvX2ZpbGUpKQogICAgICAgICAgICAjIEdldCBhdWRpbyBsZW5ndGg6CiAgICAgICAgICAgIGxlbmd0aCA9IE1QMyhhdWRpb19maWxlKS5pbmZvLmxlbmd0aAogICAgICAgICAgICAjIFRyYW5zY3JpYmU6CiAgICAgICAgICAgIHJlc3VsdCA9IG1vZGVsLnRyYW5zY3JpYmUoYXVkaW89YXVkaW8sICoqZGVjb2Rpbmdfb3B0aW9ucykKICAgICAgICAgICAgIyBVbnBhY2sgdGhlIG1vZGVsJ3MgcmVzdWx0OgogICAgICAgICAgICB0cmFuc2NyaXB0aW9uID0gcmVzdWx0WyJ0ZXh0Il0KICAgICAgICAgICAgbGFuZ3VhZ2UgPSByZXN1bHRbImxhbmd1YWdlIl0gb3IgZGVjb2Rpbmdfb3B0aW9ucy5sYW5ndWFnZQogICAgICAgICAgICB0cmFuc2NyaXB0aW9uX2ZpbGUgPSAoCiAgICAgICAgICAgICAgICBvdXRwdXRfZGlyZWN0b3J5CiAgICAgICAgICAgICAgICAvIGYie3N0cihhdWRpb19maWxlLnJlbGF0aXZlX3RvKGF1ZGlvX2ZpbGVzX2RpcmVjdG9yeSkpLnNwbGl0KCcuJylbMF19LnR4dCIKICAgICAgICAgICAgKQogICAgICAgICAgICB0cmFuc2NyaXB0aW9uX2ZpbGUucGFyZW50Lm1rZGlyKGV4aXN0X29rPVRydWUsIHBhcmVudHM9VHJ1ZSkKICAgICAgICAgICAgIyBXcml0ZSB0aGUgdHJhbnNjcmlwdGlvbiB0byBmaWxlOgogICAgICAgICAgICB3aXRoIG9wZW4odHJhbnNjcmlwdGlvbl9maWxlLCAidyIpIGFzIGZwOgogICAgICAgICAgICAgICAgZnAud3JpdGUodHJhbnNjcmlwdGlvbikKICAgICAgICAgICAgIyBDYWxjdWxhdGUgcmF0ZSBvZiBzcGVlY2ggKG51bWJlciBvZiB3b3JkcyAvIGF1ZGlvIGxlbmd0aCk6CiAgICAgICAgICAgIHJhdGVfb2Zfc3BlZWNoID0gbGVuKHRyYW5zY3JpcHRpb24uc3BsaXQoKSkgLyBsZW5ndGgKICAgICAgICAgICAgIyBOb3RlIGluIHRoZSBkYXRhZnJhbWU6CiAgICAgICAgICAgIGRmLmxvY1tpIC0gbGVuKGVycm9ycyldID0gWwogICAgICAgICAgICAgICAgc3RyKGF1ZGlvX2ZpbGUucmVsYXRpdmVfdG8oYXVkaW9fZmlsZXNfZGlyZWN0b3J5KSksCiAgICAgICAgICAgICAgICBzdHIodHJhbnNjcmlwdGlvbl9maWxlLnJlbGF0aXZlX3RvKG91dHB1dF9kaXJlY3RvcnkpKSwKICAgICAgICAgICAgICAgIGxhbmd1YWdlLAogICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgcmF0ZV9vZl9zcGVlY2gsCiAgICAgICAgICAgIF0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBDb2xsZWN0IHRoZSBleGNlcHRpb246CiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLndhcm4oZiJFcnJvciBpbiBmaWxlOiAne2F1ZGlvX2ZpbGV9JyIpCiAgICAgICAgICAgIGVycm9yc1tzdHIoYXVkaW9fZmlsZSldID0gc3RyKGV4Y2VwdGlvbikKCiAgICAjIFJldHVybiB0aGUgZGF0YWZyYW1lOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkRvbmU6XG57ZGYuaGVhZCgpfSIpCgogICAgcmV0dXJuIG91dHB1dF9kaXJlY3RvcnksIGRmLCBlcnJvcnMK
    commands:
    - python -m pip install openai-whisper tqdm
    code_origin: https://github.com/yonishelach/functions.git#5ef41eefc2d0f8a4393d80cf99fea4ab07511f80:/Users/Yonatan_Shelach/projects/functions/transcribe/transcribe.py
    origin_filename: /Users/Yonatan_Shelach/projects/functions/transcribe/transcribe.py
  entry_points:
    transcribe:
      name: transcribe
      doc: 'Transcribe audio files into text files and collect additional data. The
        end result is a directory of transcribed

        text files and a dataframe containing the following columns:


        * audio_file - The original audio file name.

        * transcription_file - The transcribed text file name in the output directory.

        * language - The detected language in the audio file.

        * length - The length of the audio file.

        * rate_of_speech - The number of words divided by the audio file length.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
        default: ''
      - name: audio_files_directory
        type: str
        doc: A directory of the audio files to transcribe.
        default: ''
      - name: model_name
        type: str
        doc: One of the official model names listed by `whisper.available_models()`.
        default: base
      - name: device
        type: Literal[, ]
        doc: Device to load the model. Can be one of {"cuda", "cpu"}. Default will
          prefer "cuda" if available.
        default: null
      - name: decoding_options
        type: dict
        doc: A dictionary of options to construct a `whisper.DecodingOptions`.
        default: null
      - name: output_directory
        type: str
        doc: Path to a directory to save all transcribed audio files.
        default: null
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 27
  description: Transcribe audio files into text files
  default_handler: transcribe
  disable_auto_mount: false
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
