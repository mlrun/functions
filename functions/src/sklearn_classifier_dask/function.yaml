spec:
  filename: sklearn_classifier_dask.py
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKIyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCgppbXBvcnQgbWxydW4KCndhcm5pbmdzLmZpbHRlcndhcm5pbmdzKCJpZ25vcmUiKQoKaW1wb3J0IGpvYmxpYgppbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzCmZyb20gZGFzayBpbXBvcnQgZGF0YWZyYW1lIGFzIGRkCmZyb20gZGFzay5kZWxheWVkIGltcG9ydCBkZWxheWVkCmZyb20gZGFza19tbCBpbXBvcnQgbW9kZWxfc2VsZWN0aW9uCmZyb20gZGFza19tbC5wcmVwcm9jZXNzaW5nIGltcG9ydCBMYWJlbEVuY29kZXIsIFN0YW5kYXJkU2NhbGVyCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QKZnJvbSBtbHJ1bi5tbHV0aWxzLm1vZGVscyBpbXBvcnQgZ2VuX3NrbGVhcm5fbW9kZWwKZnJvbSBtbHJ1bi51dGlscy5oZWxwZXJzIGltcG9ydCBjcmVhdGVfY2xhc3MKZnJvbSB5ZWxsb3dicmljay5jbGFzc2lmaWVyIGltcG9ydCBST0NBVUMsIENsYXNzaWZpY2F0aW9uUmVwb3J0LCBDb25mdXNpb25NYXRyaXgKZnJvbSB5ZWxsb3dicmljay5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IEZlYXR1cmVJbXBvcnRhbmNlcwoKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgZGF0YXNldDogbWxydW4uRGF0YUl0ZW0sCiAgICBtb2RlbF9wa2dfY2xhc3M6IHN0ciwKICAgIGxhYmVsX2NvbHVtbjogc3RyID0gImxhYmVsIiwKICAgIHRyYWluX3ZhbGlkYXRpb25fc2l6ZTogZmxvYXQgPSAwLjc1LAogICAgc2FtcGxlOiBmbG9hdCA9IDEuMCwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAibW9kZWxzIiwKICAgIHRlc3Rfc2V0X2tleTogc3RyID0gInRlc3Rfc2V0IiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBkYXNrX2Z1bmN0aW9uOiBzdHIgPSBOb25lLAogICAgZGFza19jbGllbnQ9Tm9uZSwKICAgIGZpbGVfZXh0OiBzdHIgPSAicGFycXVldCIsCiAgICByYW5kb21fc3RhdGU6IGludCA9IDQyLAopIC0+IE5vbmU6CiAgICAiIiIKICAgIFRyYWluIGEgc2tsZWFybiBjbGFzc2lmaWVyIHdpdGggRGFzawoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgICAgICAgRnVuY3Rpb24gY29udGV4dC4KICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgICAgICAgUmF3IGRhdGEgZmlsZS4KICAgIDpwYXJhbSBtb2RlbF9wa2dfY2xhc3M6ICAgICAgICAgTW9kZWwgdG8gdHJhaW4sIGUuZywgInNrbGVhcm4uZW5zZW1ibGUuUmFuZG9tRm9yZXN0Q2xhc3NpZmllciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yIGpzb24gbW9kZWwgY29uZmlnLgogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgICAgICAgICAobGFiZWwpIEdyb3VuZC10cnV0aCB5IGxhYmVscy4KICAgIDpwYXJhbSB0cmFpbl92YWxpZGF0aW9uX3NpemU6ICAgKDAuNzUpIFRyYWluIHZhbGlkYXRpb24gc2V0IHByb3BvcnRpb24gb3V0IG9mIHRoZSBmdWxsIGRhdGFzZXQuCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgICAgICAgICgxLjApIFNlbGVjdCBzYW1wbGUgZnJvbSBkYXRhc2V0IChuLXJvd3MvJSBvZiB0b3RhbCksIHJhbmRvbXppZSByb3dzIGFzIGRlZmF1bHQuCiAgICA6cGFyYW0gbW9kZWxzX2Rlc3Q6ICAgICAgICAgICAgIChtb2RlbHMpIE1vZGVscyBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aC4KICAgIDpwYXJhbSB0ZXN0X3NldF9rZXk6ICAgICAgICAgICAgKHRlc3Rfc2V0KSBNbHJ1biBkYiBrZXkgb2YgaGVsZCBvdXQgZGF0YSBpbiBhcnRpZmFjdCBzdG9yZS4KICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICAgICAgICAgKHBsb3RzKSBQbG90IHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoLgogICAgOnBhcmFtIGRhc2tfZnVuY3Rpb246ICAgICAgICAgICBkYXNrIGZ1bmN0aW9uIHVybCAoZGI6Ly8uLikKICAgIDpwYXJhbSBkYXNrX2NsaWVudDogICAgICAgICAgICAgZGFzayBjbGllbnQgb2JqZWN0CiAgICA6cGFyYW0gZmlsZV9leHQ6ICAgICAgICAgICAgICAgIChwYXJxdWV0KSBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICA6cGFyYW0gcmFuZG9tX3N0YXRlOiAgICAgICAgICAgICg0Mikgc2tsZWFybiBzZWVkCiAgICAiIiIKICAgIGlmIGRhc2tfZnVuY3Rpb246CiAgICAgICAgY2xpZW50ID0gbWxydW4uaW1wb3J0X2Z1bmN0aW9uKGRhc2tfZnVuY3Rpb24pLmNsaWVudAogICAgZWxpZiBkYXNrX2NsaWVudDoKICAgICAgICBjbGllbnQgPSBkYXNrX2NsaWVudAogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJkYXNrIGNsaWVudCB3YXMgbm90IHByb3ZpZGVkIikKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJSZWFkIERhdGEiKQogICAgZGYgPSBkYXRhc2V0LmFzX2RmKGRmX21vZHVsZT1kZCkKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJQcmVwIERhdGEiKQogICAgbnVtZXJpY3MgPSBbImludDE2IiwgImludDMyIiwgImludDY0IiwgImZsb2F0MTYiLCAiZmxvYXQzMiIsICJmbG9hdDY0Il0KICAgIGRmID0gZGYuc2VsZWN0X2R0eXBlcyhpbmNsdWRlPW51bWVyaWNzKQoKICAgIGlmIGRmLmlzbmEoKS5hbnkoKS5hbnkoKS5jb21wdXRlKCkgPT0gVHJ1ZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oIk5BcyB2YWx1cyBmb3VuZCIpCgogICAgZGZfaGVhZGVyID0gZGYuY29sdW1ucwoKICAgIGRmID0gZGYuc2FtcGxlKGZyYWM9c2FtcGxlKS5yZXNldF9pbmRleChkcm9wPVRydWUpCiAgICBlbmNvZGVyID0gTGFiZWxFbmNvZGVyKCkKICAgIGVuY29kZXIgPSBlbmNvZGVyLmZpdChkZltsYWJlbF9jb2x1bW5dKQogICAgWCA9IGRmLmRyb3AobGFiZWxfY29sdW1uLCBheGlzPTEpLnRvX2Rhc2tfYXJyYXkobGVuZ3Rocz1UcnVlKQogICAgeSA9IGVuY29kZXIudHJhbnNmb3JtKGRmW2xhYmVsX2NvbHVtbl0pCgogICAgY2xhc3NlcyA9IGRmW2xhYmVsX2NvbHVtbl0uZHJvcF9kdXBsaWNhdGVzKCkgICMgbm8gdW5pcXVlIHZhbHVlcyBpbiBkYXNrCiAgICBjbGFzc2VzID0gW3N0cihpKSBmb3IgaSBpbiBjbGFzc2VzXQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIlNwbGl0IGFuZCBUcmFpbiIpCiAgICBYX3RyYWluLCBYX3Rlc3QsIHlfdHJhaW4sIHlfdGVzdCA9IG1vZGVsX3NlbGVjdGlvbi50cmFpbl90ZXN0X3NwbGl0KAogICAgICAgIFgsIHksIHRyYWluX3NpemU9dHJhaW5fdmFsaWRhdGlvbl9zaXplLCByYW5kb21fc3RhdGU9cmFuZG9tX3N0YXRlCiAgICApCgogICAgc2NhbGVyID0gU3RhbmRhcmRTY2FsZXIoKQogICAgc2NhbGVyID0gc2NhbGVyLmZpdChYX3RyYWluKQogICAgWF90cmFpbl90cmFuc2Zvcm1lZCA9IHNjYWxlci50cmFuc2Zvcm0oWF90cmFpbikKICAgIFhfdGVzdF90cmFuc2Zvcm1lZCA9IHNjYWxlci50cmFuc2Zvcm0oWF90ZXN0KQoKICAgIG1vZGVsX2NvbmZpZyA9IGdlbl9za2xlYXJuX21vZGVsKG1vZGVsX3BrZ19jbGFzcywgY29udGV4dC5wYXJhbWV0ZXJzLml0ZW1zKCkpCgogICAgbW9kZWxfY29uZmlnWyJGSVQiXS51cGRhdGUoeyJYIjogWF90cmFpbl90cmFuc2Zvcm1lZCwgInkiOiB5X3RyYWlufSkKCiAgICBDbGFzc2lmaWVyQ2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCgogICAgbW9kZWwgPSBDbGFzc2lmaWVyQ2xhc3MoKiptb2RlbF9jb25maWdbIkNMQVNTIl0pCgogICAgd2l0aCBqb2JsaWIucGFyYWxsZWxfYmFja2VuZCgiZGFzayIpOgogICAgICAgIG1vZGVsID0gbW9kZWwuZml0KCoqbW9kZWxfY29uZmlnWyJGSVQiXSkKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJFdmFsdWF0ZSIpCiAgICBleHRyYV9kYXRhX2RpY3QgPSB7fQogICAgZm9yIHJlcG9ydCBpbiAoUk9DQVVDLCBDbGFzc2lmaWNhdGlvblJlcG9ydCwgQ29uZnVzaW9uTWF0cml4KToKICAgICAgICByZXBvcnRfbmFtZSA9IHN0cihyZXBvcnQuX19uYW1lX18pCiAgICAgICAgcGx0LmNsYSgpCiAgICAgICAgcGx0LmNsZigpCiAgICAgICAgcGx0LmNsb3NlKCkKCiAgICAgICAgdml6ID0gcmVwb3J0KG1vZGVsLCBjbGFzc2VzPWNsYXNzZXMsIHBlcl9jbGFzcz1UcnVlLCBpc19maXR0ZWQ9VHJ1ZSkKICAgICAgICB2aXouZml0KFhfdHJhaW5fdHJhbnNmb3JtZWQsIHlfdHJhaW4pICAjIEZpdCB0aGUgdHJhaW5pbmcgZGF0YSB0byB0aGUgdmlzdWFsaXplcgogICAgICAgIHZpei5zY29yZSgKICAgICAgICAgICAgWF90ZXN0X3RyYW5zZm9ybWVkLCB5X3Rlc3QuY29tcHV0ZSgpCiAgICAgICAgKSAgIyBFdmFsdWF0ZSB0aGUgbW9kZWwgb24gdGhlIHRlc3QgZGF0YQoKICAgICAgICBwbG90ID0gY29udGV4dC5sb2dfYXJ0aWZhY3QoCiAgICAgICAgICAgIFBsb3RBcnRpZmFjdChyZXBvcnRfbmFtZSwgYm9keT12aXouZmlnLCB0aXRsZT1yZXBvcnRfbmFtZSksIGRiX2tleT1GYWxzZQogICAgICAgICkKICAgICAgICBleHRyYV9kYXRhX2RpY3Rbc3RyKHJlcG9ydCldID0gcGxvdAoKICAgICAgICBpZiByZXBvcnRfbmFtZSA9PSAiUk9DQVVDIjoKICAgICAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0cygKICAgICAgICAgICAgICAgIHsibWljcm8iOiB2aXoucm9jX2F1Yy5nZXQoIm1pY3JvIiksICJtYWNybyI6IHZpei5yb2NfYXVjLmdldCgibWFjcm8iKX0KICAgICAgICAgICAgKQoKICAgICAgICBlbGlmIHJlcG9ydF9uYW1lID09ICJDbGFzc2lmaWNhdGlvblJlcG9ydCI6CiAgICAgICAgICAgIGZvciBzY29yZV9uYW1lIGluIHZpei5zY29yZXNfOgogICAgICAgICAgICAgICAgZm9yIHNjb3JlX2NsYXNzIGluIHZpei5zY29yZXNfW3Njb3JlX25hbWVdOgogICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3JlX25hbWUgKyAiLSIgKyBzY29yZV9jbGFzczogdml6LnNjb3Jlc19bc2NvcmVfbmFtZV0uZ2V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3JlX2NsYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApCgogICAgdml6ID0gRmVhdHVyZUltcG9ydGFuY2VzKAogICAgICAgIG1vZGVsLAogICAgICAgIGNsYXNzZXM9Y2xhc3NlcywKICAgICAgICBwZXJfY2xhc3M9VHJ1ZSwKICAgICAgICBpc19maXR0ZWQ9VHJ1ZSwKICAgICAgICBsYWJlbHM9ZGZfaGVhZGVyLmRlbGV0ZShkZl9oZWFkZXIuZ2V0X2xvYyhsYWJlbF9jb2x1bW4pKSwKICAgICkKICAgIHZpei5maXQoWF90cmFpbl90cmFuc2Zvcm1lZCwgeV90cmFpbikKICAgIHZpei5zY29yZShYX3Rlc3RfdHJhbnNmb3JtZWQsIHlfdGVzdCkKCiAgICBwbG90ID0gY29udGV4dC5sb2dfYXJ0aWZhY3QoCiAgICAgICAgUGxvdEFydGlmYWN0KCJGZWF0dXJlSW1wb3J0YW5jZXMiLCBib2R5PXZpei5maWcsIHRpdGxlPSJGZWF0dXJlSW1wb3J0YW5jZXMiKSwKICAgICAgICBkYl9rZXk9RmFsc2UsCiAgICApCiAgICBleHRyYV9kYXRhX2RpY3RbIkZlYXR1cmVJbXBvcnRhbmNlcyJdID0gcGxvdAoKICAgIHBsdC5jbGEoKQogICAgcGx0LmNsZigpCiAgICBwbHQuY2xvc2UoKQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkxvZyBhcnRpZmFjdHMiKQogICAgYXJ0aWZhY3RfcGF0aCA9IGNvbnRleHQuYXJ0aWZhY3Rfc3VicGF0aChtb2RlbHNfZGVzdCkKCiAgICBjb250ZXh0LnNldF9sYWJlbCgiY2xhc3MiLCBtb2RlbF9wa2dfY2xhc3MpCgogICAgY29udGV4dC5sb2dfbW9kZWwoCiAgICAgICAgIm1vZGVsIiwKICAgICAgICBib2R5PWR1bXBzKG1vZGVsKSwKICAgICAgICBhcnRpZmFjdF9wYXRoPWFydGlmYWN0X3BhdGgsCiAgICAgICAgbW9kZWxfZmlsZT0ibW9kZWwucGtsIiwKICAgICAgICBleHRyYV9kYXRhPWV4dHJhX2RhdGFfZGljdCwKICAgICAgICBtZXRyaWNzPWNvbnRleHQucmVzdWx0cywKICAgICAgICBsYWJlbHM9eyJjbGFzcyI6IG1vZGVsX3BrZ19jbGFzc30sCiAgICApCgogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoCiAgICAgICAgInN0YW5kYXJkX3NjYWxlciIsCiAgICAgICAgYm9keT1kdW1wcyhzY2FsZXIpLAogICAgICAgIGFydGlmYWN0X3BhdGg9YXJ0aWZhY3RfcGF0aCwKICAgICkKCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgKICAgICAgICAibGFiZWxfZW5jb2RlciIsCiAgICAgICAgYm9keT1kdW1wcyhlbmNvZGVyKSwKICAgICAgICBhcnRpZmFjdF9wYXRoPWFydGlmYWN0X3BhdGgsCiAgICApCgogICAgZGZfdG9fc2F2ZSA9IGRlbGF5ZWQobnAuY29sdW1uX3N0YWNrKSgoWF90ZXN0LCB5X3Rlc3QpKS5jb21wdXRlKCkKICAgIGNvbnRleHQubG9nX2RhdGFzZXQoCiAgICAgICAgdGVzdF9zZXRfa2V5LAogICAgICAgIGRmPXBkLkRhdGFGcmFtZShkZl90b19zYXZlLCBjb2x1bW5zPWRmX2hlYWRlciksICAjIGltcHJvdmUgbG9nIGRhdGFzZXQgYWJpbGl0eQogICAgICAgIGZvcm1hdD1maWxlX2V4dCwKICAgICAgICBpbmRleD1GYWxzZSwKICAgICAgICBsYWJlbHM9eyJkYXRhLXR5cGUiOiAiaGVsZC1vdXQifSwKICAgICAgICBhcnRpZmFjdF9wYXRoPWNvbnRleHQuYXJ0aWZhY3Rfc3VicGF0aCgiZGF0YSIpLAogICAgKQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkRvbmUhIikK
    origin_filename: ''
    code_origin: ''
  command: ''
  entry_points:
    train_model:
      outputs:
      - type: None
      name: train_model
      doc: Train a sklearn classifier with Dask
      has_kwargs: false
      parameters:
      - name: context
        type: MLClientCtx
        doc: Function context.
      - name: dataset
        type: DataItem
        doc: Raw data file.
      - name: model_pkg_class
        type: str
        doc: Model to train, e.g, "sklearn.ensemble.RandomForestClassifier", or json
          model config.
      - name: label_column
        type: str
        doc: (label) Ground-truth y labels.
        default: label
      - name: train_validation_size
        type: float
        doc: (0.75) Train validation set proportion out of the full dataset.
        default: 0.75
      - name: sample
        type: float
        doc: (1.0) Select sample from dataset (n-rows/% of total), randomzie rows
          as default.
        default: 1.0
      - name: models_dest
        type: str
        doc: (models) Models subfolder on artifact path.
        default: models
      - name: test_set_key
        type: str
        doc: (test_set) Mlrun db key of held out data in artifact store.
        default: test_set
      - name: plots_dest
        type: str
        doc: (plots) Plot subfolder on artifact path.
        default: plots
      - name: dask_function
        type: str
        doc: dask function url (db://..)
        default: null
      - name: dask_client
        doc: dask client object
        default: null
      - name: file_ext
        type: str
        doc: (parquet) format for test_set_key hold out data
        default: parquet
      - name: random_state
        type: int
        doc: (42) sklearn seed
        default: 42
      lineno: 39
      has_varargs: false
  default_handler: train_model
  disable_auto_mount: false
  description: train any classifier using scikit-learn's API over Dask
  image: mlrun/ml-models
verbose: false
kind: job
metadata:
  tag: ''
  categories:
  - machine-learning
  - model-training
  name: sklearn-classifier-dask
