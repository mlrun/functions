name: System Tests Open Source

on:
  push:
    branches:
      - 'add-ci-helm'
      
#       - '.+-system-tests'

  workflow_dispatch:
    inputs:
      mlrun_version:
        description: 'mlrun version'
        required: true
        default: '0.7.1'


env:
  NAMESPACE: mlrun
  MLRUN_API_NODE_PORT: 30070




jobs:
  build_stategy_matrix:
    runs-on: ubuntu-latest    
    if: github.repository == 'mlrun/functions' || github.event_name == 'workflow_dispatch'
    steps:         

#       - name: Create k8s Kind Cluster
#         uses: helm/kind-action@v1.3.0

      - uses: manusa/actions-setup-minikube@v2.4.2
        with:
          minikube version: "v1.26.0"
          kubernetes version: "v1.23.9"
          driver: docker
          # I couldn't find a way to configure the IP (https://github.com/kubernetes/minikube/issues/951)
          # but this seems to work
          start args: '--addons=registry --insecure-registry="192.168.49.2:5000"'

      - uses: azure/setup-helm@v1
        with:
          version: "v3.9.1"


      - name: Get mlrun kit charts and create namespace
        run: |
          helm repo add mlrun https://mlrun.github.io/ce
          helm repo update
          kubectl create namespace ${NAMESPACE}


      - name: Install MLRun CE helm chart
        run: |
          helm install mlrun-ce --namespace ${NAMESPACE}  --set minio.resources.requests.memory="128Mi"   --set  jupyterNotebook.persistence.size="1Gi"  --set  mlrun.db.persistence.size="1Gi" --set  mlrun.api.persistence.size="1Gi" --set  mpi-operator.deployment.create="false" --set  mlrun.httpDB.dbType="sqlite" --set  mlrun.httpDB.dirPath="/mlrun/db" --set  mlrun.httpDB.dsn="sqlite:////mlrun/db/mlrun.db?check_same_thread=false"  --set  mlrun.httpDB.oldDsn=""  --set global.registry.url=$(minikube ip):5000  --set global.registry.secretName=""   --set global.externalHostAddress=$(minikube ip)  --set nuclio.dashboard.externalIPAddresses[0]=$(minikube ip)  --wait --debug   mlrun/mlrun-ce 
          
      - name: Prepare system tests env
        run: |
          kubectl get pods -A 
          kubectl get  nodes
          echo "MLRUN_DBPATH: http://$(minikube ip):${MLRUN_API_NODE_PORT}" > mlrun_tmp_env.yml
          cat mlrun_tmp_env.yml

