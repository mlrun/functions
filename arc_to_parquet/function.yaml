kind: job
metadata:
  name: arc-to-parquet
  tag: ''
  hash: 0054fdf4402a007f0bdda4cd009ccc6c0233dabe
  project: ''
  labels:
    author: yjb
  categories:
  - data-movement
  - utils
spec:
  command: ''
  args: []
  image: mlrun/ml-base
  env: []
  default_handler: arc_to_parquet
  entry_points:
    arc_to_parquet:
      name: arc_to_parquet
      doc: "Open a file/object archive and save as a parquet file or dataset\n\nNotes\n\
        -----\n* partitioning requires precise specification of column types.\n* the\
        \ archive_url can be any file readable by pandas read_csv, which includes\
        \ tar files\n* if the `dataset` parameter is not empty, then a partitioned\
        \ dataset will be created\ninstead of a single file in the folder `dataset`\n\
        * if a key exists already then it will not be re-acquired unless the `refresh_data`\
        \ param\nis set to `True`.  This is in case the original file is corrupt,\
        \ or a refresh is \nrequired."
      parameters:
      - name: context
        type: MLClientCtx
        doc: function context
      - name: archive_url
        type: DataItem
        doc: MLRun data input (DataItem object)
      - name: header
        type: str
        doc: column names
      - name: chunksize
        type: int
        doc: (0) row size retrieved per iteration
        default: 10000
      - name: dtype
      - name: encoding
        type: str
        default: latin-1
      - name: key
        type: str
        doc: key in artifact store
        default: data
      - name: dataset
        type: str
        doc: (None) if not None then "target_path/dataset" is folder for partitioned
          files
      - name: part_cols
        doc: ([]) list of partitioning columns
      - name: file_ext
        type: str
        doc: (parquet) csv/parquet file extension
        default: parquet
      - name: refresh_data
        type: bool
        doc: (False) overwrite existing data at that location/kye
      outputs: []
      lineno: 26
  description: retrieve remote archive, open and save as parquet
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA1LTAzIDE1OjEzCgppbXBvcnQgc3NsCgp0cnk6CiAgICBfY3JlYXRlX3VudmVyaWZpZWRfaHR0cHNfY29udGV4dCA9IHNzbC5fY3JlYXRlX3VudmVyaWZpZWRfY29udGV4dApleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgcGFzcwplbHNlOgogICAgc3NsLl9jcmVhdGVfZGVmYXVsdF9odHRwc19jb250ZXh0ID0gX2NyZWF0ZV91bnZlcmlmaWVkX2h0dHBzX2NvbnRleHQKCmltcG9ydCBvcwppbXBvcnQganNvbgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgcHlhcnJvdy5wYXJxdWV0IGFzIHBxCmltcG9ydCBweWFycm93IGFzIHBhCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXAsIGxvYWQKCmZyb20gbWxydW4uZXhlY3V0aW9uIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IFBsb3RBcnRpZmFjdCwgVGFibGVBcnRpZmFjdAoKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QsIE9wdGlvbmFsCgpkZWYgYXJjX3RvX3BhcnF1ZXQoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGFyY2hpdmVfdXJsOiBEYXRhSXRlbSwKICAgIGhlYWRlcjogc3RyID0gIiIsCiAgICBjaHVua3NpemU6IGludCA9IDEwXzAwMCwKICAgIGR0eXBlPU5vbmUsCiAgICBlbmNvZGluZzogc3RyID0gImxhdGluLTEiLAogICAga2V5OiBzdHIgPSAiZGF0YSIsCiAgICBkYXRhc2V0OiBzdHIgPSAiIiwKICAgIHBhcnRfY29scyA9IFtdLAogICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IiwKICAgIHJlZnJlc2hfZGF0YTogYm9vbCA9IEZhbHNlCikgLT4gTm9uZToKICAgICIiIk9wZW4gYSBmaWxlL29iamVjdCBhcmNoaXZlIGFuZCBzYXZlIGFzIGEgcGFycXVldCBmaWxlIG9yIGRhdGFzZXQKCiAgICBOb3RlcwogICAgLS0tLS0KICAgICogcGFydGl0aW9uaW5nIHJlcXVpcmVzIHByZWNpc2Ugc3BlY2lmaWNhdGlvbiBvZiBjb2x1bW4gdHlwZXMuCiAgICAqIHRoZSBhcmNoaXZlX3VybCBjYW4gYmUgYW55IGZpbGUgcmVhZGFibGUgYnkgcGFuZGFzIHJlYWRfY3N2LCB3aGljaCBpbmNsdWRlcyB0YXIgZmlsZXMKICAgICogaWYgdGhlIGBkYXRhc2V0YCBwYXJhbWV0ZXIgaXMgbm90IGVtcHR5LCB0aGVuIGEgcGFydGl0aW9uZWQgZGF0YXNldCB3aWxsIGJlIGNyZWF0ZWQKICAgIGluc3RlYWQgb2YgYSBzaW5nbGUgZmlsZSBpbiB0aGUgZm9sZGVyIGBkYXRhc2V0YAogICAgKiBpZiBhIGtleSBleGlzdHMgYWxyZWFkeSB0aGVuIGl0IHdpbGwgbm90IGJlIHJlLWFjcXVpcmVkIHVubGVzcyB0aGUgYHJlZnJlc2hfZGF0YWAgcGFyYW0KICAgIGlzIHNldCB0byBgVHJ1ZWAuICBUaGlzIGlzIGluIGNhc2UgdGhlIG9yaWdpbmFsIGZpbGUgaXMgY29ycnVwdCwgb3IgYSByZWZyZXNoIGlzIAogICAgcmVxdWlyZWQuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIGFyY2hpdmVfdXJsOiAgTUxSdW4gZGF0YSBpbnB1dCAoRGF0YUl0ZW0gb2JqZWN0KQogICAgOnBhcmFtIGhlYWRlcjogICAgICAgY29sdW1uIG5hbWVzCiAgICA6cGFyYW0gY2h1bmtzaXplOiAgICAoMCkgcm93IHNpemUgcmV0cmlldmVkIHBlciBpdGVyYXRpb24KICAgIDpwYXJhbSBkdHlwZXMgICAgICAgIGRlc3RpbmF0aW9uIGRhdGEgdHlwZSBvZiBjb2x1bW5zLCBhcyBkaWN0KGNvbCwgdHlwZSksIGZvciBleGFtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICB74oCYYeKAmTogbnAuZmxvYXQ2NCwg4oCYYuKAmTogbnAuaW50MzIsIOKAmGPigJk6IOKAmEludDY04oCZfSAgCiAgICA6cGFyYW0gZW5jb2RpbmcgICAgICAoImxhdGluLTgiKSBmaWxlIGVuY29kaW5nCiAgICA6cGFyYW0ga2V5OiAgICAgICAgICBrZXkgaW4gYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgIChOb25lKSBpZiBub3QgTm9uZSB0aGVuICJ0YXJnZXRfcGF0aC9kYXRhc2V0IgogICAgICAgICAgICAgICAgICAgICAgICAgaXMgZm9sZGVyIGZvciBwYXJ0aXRpb25lZCBmaWxlcwogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgKHBhcnF1ZXQpIGNzdi9wYXJxdWV0IGZpbGUgZXh0ZW5zaW9uCiAgICA6cGFyYW0gcGFydF9jb2xzOiAgICAoW10pIGxpc3Qgb2YgcGFydGl0aW9uaW5nIGNvbHVtbnMKICAgIDpwYXJhbSByZWZyZXNoX2RhdGE6IChGYWxzZSkgb3ZlcndyaXRlIGV4aXN0aW5nIGRhdGEgYXQgdGhhdCBsb2NhdGlvbi9reWUKICAgICIiIgogICAgYmFzZV9wYXRoID0gY29udGV4dC5hcnRpZmFjdF9wYXRoCiAgICBvcy5tYWtlZGlycyhiYXNlX3BhdGgsIGV4aXN0X29rPVRydWUpCiAgICAKICAgIGFyY2hpdmVfdXJsID0gYXJjaGl2ZV91cmwubG9jYWwoKQogICAgCiAgICBpZiBkYXRhc2V0OgogICAgICAgIGRlc3RfcGF0aCA9IG9zLnBhdGguam9pbihiYXNlX3BhdGgsIGRhdGFzZXQpCiAgICAgICAgZXhpc3RzID0gb3MucGF0aC5pc2RpcihkZXN0X3BhdGgpCiAgICBlbHNlOgogICAgICAgIGRlc3RfcGF0aCA9IG9zLnBhdGguam9pbihiYXNlX3BhdGgsIGtleStmIi57ZmlsZV9leHR9IikKICAgICAgICBleGlzdHMgPSBvcy5wYXRoLmlzZmlsZShkZXN0X3BhdGgpCgogICAgaWYgbm90IGV4aXN0czoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJkZXN0aW5hdGlvbiBmaWxlIGRvZXMgbm90IGV4aXN0LCBkb3dubG9hZGluZyIpCiAgICAgICAgcHF3cml0ZXIgPSBOb25lCiAgICAgICAgZm9yIGksIGRmIGluIGVudW1lcmF0ZShwZC5yZWFkX2NzdihhcmNoaXZlX3VybCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHVua3NpemU9Y2h1bmtzaXplLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzPWhlYWRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kaW5nPWVuY29kaW5nLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR0eXBlPWR0eXBlcykpOgogICAgICAgICAgICB0YWJsZSA9IHBhLlRhYmxlLmZyb21fcGFuZGFzKGRmKQogICAgICAgICAgICBpZiBpID09IDA6CiAgICAgICAgICAgICAgICBpZiBkYXRhc2V0OgogICAgICAgICAgICAgICAgICAgIHBxLlBhcnF1ZXRXcml0ZXIob3MucGF0aC5qb2luKGJhc2VfcGF0aCxmImhlYWRlci1vbmx5LntmaWxlX2V4dH0iKSwgdGFibGUuc2NoZW1hKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBwcXdyaXRlciA9IHBxLlBhcnF1ZXRXcml0ZXIoZGVzdF9wYXRoLCB0YWJsZS5zY2hlbWEpCiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgiaGVhZGVyIiwgbG9jYWxfcGF0aD1mImhlYWRlci1vbmx5LntmaWxlX2V4dH0iKQogICAgICAgICAgICBpZiBkYXRhc2V0OgogICAgICAgICAgICAgICAgcHEud3JpdGVfdG9fZGF0YXNldCh0YWJsZSwgcm9vdF9wYXRoPWRlc3RfcGF0aCwgcGFydGl0aW9uX2NvbHM9cGFydGl0aW9uX2NvbHMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcXdyaXRlci53cml0ZV90YWJsZSh0YWJsZSkKICAgICAgICBpZiBwcXdyaXRlcjoKICAgICAgICAgICAgcHF3cml0ZXIuY2xvc2UoKQoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYic2F2ZWQgdGFibGUgdG8ge2Rlc3RfcGF0aH0iKQogICAgZWxzZToKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJkZXN0aW5hdGlvbiBmaWxlIGFscmVhZHkgZXhpc3RzIikKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KGtleSwgbG9jYWxfcGF0aD1rZXkrZiIue2ZpbGVfZXh0fSIpCgo=
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#55200cb08b703b328ae8dbaede402e3555df7cbc:arc_to_parquet.ipynb
