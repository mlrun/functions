kind: job
metadata:
  name: pii-recognizer
  tag: ''
  hash: 88e5e4bfeefbf3357eb91d9e389194219adf73e9
  project: default
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCmltcG9ydCB3YXJuaW5ncwppbXBvcnQgb3MKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG1scnVuCmltcG9ydCBwYXRobGliCmltcG9ydCB0ZW1wZmlsZQpmcm9tIHRxZG0uYXV0byBpbXBvcnQgdHFkbQpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgVHVwbGUsIFNldAppbXBvcnQgcHJlc2lkaW9fYW5hbHl6ZXIgYXMgcGEKaW1wb3J0IHByZXNpZGlvX2Fub255bWl6ZXIgYXMgcHJlX2Fub3ltaXplcgppbXBvcnQgYW5ub3RhdGVkX3RleHQudXRpbCBhcyBhdF91dGlsCgp0cnk6CiAgICBpbXBvcnQgZmxhaXIgYXMgZmwKZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3I6CiAgICBwcmludCgiRmxhaXIgaXMgbm90IGluc3RhbGxlZCIpCgojIFRoZXJlIGlzIGEgY29uZmxpY3QgYmV0d2VlbiBSdXN0LWJhc2VkIHRva2VuaXplcnMnIHBhcmFsbGVsIHByb2Nlc3NpbmcKIyBhbmQgUHl0aG9uJ3MgZm9yayBvcGVyYXRpb25zIGR1cmluZyBtdWx0aXByb2Nlc3NpbmcuIFRvIGF2b2lkIHRoaXMsIHdlIG5lZWQKIyB0aGUgZm9sbG93aW5nIHR3byBsaW5lcwoKb3MuZW52aXJvblsiVE9LRU5JWkVSU19QQVJBTExFTElTTSJdID0gImZhbHNlIgp3YXJuaW5ncy5maWx0ZXJ3YXJuaW5ncygiaWdub3JlIikKCmxvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCJwaWktcmVjb2duaXplciIpCgoKY2xhc3MgUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5OgogICAgIiIiCiAgICBGYWN0b3J5IGZvciBjcmVhdGluZyBwYXR0ZXJuIHJlY29nbml6ZXJzLCBpdCBjYW4gYmUgZXh0ZW5kZWQgaW4gdGhlIGZ1dHVyZSB0bwogICAgYWRkIG1vcmUgcmVnZXggcGF0dGVybiBmb3IgZGlmZmVyZW50IGVudGl0aWVzLiBGb3IgdGhlIHBhdHRlcm4gcmVjb2duaXplciB0byB3b3JrLAogICAgd2UgbmVlZCBjb25zdHJ1Y3QgYSBsaXN0IG9mIHJlZ2V4IHBhdHRlcm5zIGZvciBlYWNoIGVudGl0eS4KICAgICIiIgoKICAgIF9ERUZBVUxUX0VOVElUSUVTID0gewogICAgICAgICJDUkVESVRfQ0FSRCI6IFtwYS5QYXR0ZXJuKCJDUkVESVRfQ0FSRCIsIHIiXGIoPzpcZFsgLV0qPyl7MTMsMTZ9XGIiLCAwLjUpXSwKICAgICAgICAiU1NOIjogW3BhLlBhdHRlcm4oIlNTTiIsIHIiXGJcZHszfS0/XGR7Mn0tP1xkezR9XGIiLCAwLjUpXSwKICAgICAgICAiUEhPTkUiOiBbcGEuUGF0dGVybigiUEhPTkUiLCByIlwoP1xkezN9XCk/Wy0uXHNdP1xkezN9Wy0uXHNdP1xkezR9IiwgMC41KV0sCiAgICAgICAgIkVNQUlMIjogW3BhLlBhdHRlcm4oIkVNQUlMIiwgciJcUytAXFMrIiwgMC41KV0sCiAgICB9CgogICAgIyBjcmVhdGUgYSBsaXN0IG9mIHBhdHRlcm4gcmVjb2duaXplcnMKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIF9jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKGNscyk6CiAgICAgICAgIiIiCiAgICAgICAgRm9yIGVhY2ggZW50aXR5LCBjcmVhdGUgYSBsaXN0IG9mIHBhdHRlcm5zIHRvIHJlY29nbml6ZSBpdAoKICAgICAgICA6cGFyYW0gY2xzOiBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkgY2xhc3MKCiAgICAgICAgOnJldHVybnM6IExpc3Qgb2YgcGF0dGVybiByZWNvZ25pemVycwogICAgICAgICIiIgoKICAgICAgICAjIEVudGl0aWVzIHRvIHJlY29nbml6ZSBhbmQgdGhlaXIgcmVnZXggcGF0dGVybnMKCiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgcGEuUGF0dGVyblJlY29nbml6ZXIoc3VwcG9ydGVkX2VudGl0eT1lbnRpdHksIHBhdHRlcm5zPXBhdHRlcm4pCiAgICAgICAgICAgIGZvciBlbnRpdHksIHBhdHRlcm4gaW4gY2xzLl9ERUZBVUxUX0VOVElUSUVTLml0ZW1zKCkKICAgICAgICBdCgoKY2xhc3MgQ3VzdG9tU3BhY3lSZWNvZ25pemVyKHBhLkxvY2FsUmVjb2duaXplcik6CiAgICAiIiIKICAgIEN1c3RvbSBTcGFjeSBSZWNvZ25pemVyIGZyb20gUHJlc2lkaW8gQW5hbHl6ZXIgdHJhaW5lZCBvbiBQcml2eSBkYXRhLgogICAgVGhlIHByaXZ5IGRhdGEgaXMgZ2VuZXJhdGVkIHVzaW5nIHRoaXMgaHR0cHM6Ly9naXRodWIuY29tL3BpeGllLWlvL3BpeGllL3RyZWUvbWFpbi9zcmMvZGF0YWdlbi9waWkvcHJpdnkKICAgIEl0IGNhbiBiZSB1c2VkIHRvIHJlY29nbml6ZSBjdXN0b20gZW50aXRpZXMsIFNpbmNlIHdlIHdhbnQgdG8gdXNlIFByZXNpZGlvJ3MgUmVnaXN0cmllcyB0byBnZW5lcmF0ZSBBbmFseXplckVuZ2luZSwKICAgIGl0IGluaGVyaXRzIGZyb20gUHJlc2lkaW8gQW5hbHl6ZXIncyBMb2NhbFJlY29nbml6ZXIgY2xhc3MuCiAgICAiIiIKCiAgICAjIEVudGl0aWVzIHRvIHJlY29nbml6ZQoKICAgIF9ERUZBVUxUX0VOVElUSUVTID0gWwogICAgICAgICJMT0NBVElPTiIsCiAgICAgICAgIlBFUlNPTiIsCiAgICAgICAgIk5SUCIsCiAgICAgICAgIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIkRBVEVfVElNRSIsCiAgICBdCgogICAgIyBEZWZhdWx0IGV4cGxhbmF0aW9uIGZvciB0aGlzIHJlY29nbml6ZXIKCiAgICBfREVGQVVMVF9FWFBMQU5BVElPTiA9ICgKICAgICAgICAiSWRlbnRpZmllZCBhcyB7fSBieSBTcGFjeSdzIE5hbWVkIEVudGl0eSBSZWNvZ25pdGlvbiAoUHJpdnktdHJhaW5lZCkiCiAgICApCgogICAgIyBMYWJlbCBncm91cHMgdG8gY2hlY2sKCiAgICBfREVGQVVMVF9DSEVDS19MQUJFTF9HUk9VUFMgPSBbCiAgICAgICAgKHsiTE9DQVRJT04ifSwgeyJMT0MiLCAiTE9DQVRJT04iLCAiU1RSRUVUX0FERFJFU1MiLCAiQ09PUkRJTkFURSJ9KSwKICAgICAgICAoeyJQRVJTT04ifSwgeyJQRVIiLCAiUEVSU09OIn0pLAogICAgICAgICh7Ik5SUCJ9LCB7Ik5PUlAiLCAiTlJQIn0pLAogICAgICAgICh7Ik9SR0FOSVpBVElPTiJ9LCB7Ik9SRyJ9KSwKICAgICAgICAoeyJEQVRFX1RJTUUifSwgeyJEQVRFX1RJTUUifSksCiAgICBdCgogICAgIyBwcmV0cmFpbmVkIG1vZGVsIGZvciB0aGlzIHJlY29nbml6ZXIKCiAgICBfREVGQVVMVF9NT0RFTF9MQU5HVUFHRVMgPSB7CiAgICAgICAgImVuIjogImJla2kvZW5fc3BhY3lfcGlpX2Rpc3RpbGJlcnQiLAogICAgfQoKICAgIF9ERUZBVUxUX1BSRVNJRElPX0VRVUlWQUxFTkNFUyA9IHsKICAgICAgICAiUEVSIjogIlBFUlNPTiIsCiAgICAgICAgIkxPQyI6ICJMT0NBVElPTiIsCiAgICAgICAgIk9SRyI6ICJPUkdBTklaQVRJT04iLAogICAgICAgICJOUk9QIjogIk5SUCIsCiAgICAgICAgIkRBVEVfVElNRSI6ICJEQVRFX1RJTUUiLAogICAgfQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZTogc3RyID0gImVuIiwKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICAgICAgY2hlY2tfbGFiZWxfZ3JvdXBzOiBUdXBsZVtTZXQsIFNldF0gPSBOb25lLAogICAgICAgIGNvbnRleHQ6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICAgICAgbmVyX3N0cmVuZ3RoOiBmbG9hdCA9IDAuODUsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgU3BhY3kgUmVjb2duaXplci4KCiAgICAgICAgOnBhcmFtIHN1cHBvcnRlZF9sYW5ndWFnZTogTGFuZ3VhZ2UgdG8gdXNlLCBkZWZhdWx0IGlzIEVuZ2xpc2gKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2VudGl0aWVzOiBFbnRpdGllcyB0byB1c2UgZm9yIHJlY29nbml0aW9uCiAgICAgICAgOnBhcmFtIGNoZWNrX2xhYmVsX2dyb3VwczogTGFiZWwgZ3JvdXBzIHRvIGNoZWNrIGZvciB0aGUgZW50aXRpZXMKICAgICAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICBDb250ZXh0IHRvIHVzZSBpZiBhbnkKICAgICAgICA6cGFyYW0gbmVyX3N0cmVuZ3RoOiAgICAgICBEZWZhdWx0IGNvbmZpZGVuY2UgZm9yIE5FUiBwcmVkaWN0aW9uCgogICAgICAgIDpyZXR1cm5zOiBTcGFjeVJlY29nbml6ZXIgb2JqZWN0CiAgICAgICAgIiIiCgogICAgICAgICMgRGVmYXVsdCBjb25maWRlbmNlIGZvciBORVIgcHJlZGljdGlvbgogICAgICAgIHNlbGYubmVyX3N0cmVuZ3RoID0gbmVyX3N0cmVuZ3RoCgogICAgICAgIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzID0gY2hlY2tfbGFiZWxfZ3JvdXBzIG9yIHNlbGYuX0RFRkFVTFRfQ0hFQ0tfTEFCRUxfR1JPVVBTCiAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzID0gc3VwcG9ydGVkX2VudGl0aWVzIG9yIHNlbGYuX0RFRkFVTFRfRU5USVRJRVMKICAgICAgICBzdXBlcigpLl9faW5pdF9fKAogICAgICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM9c3VwcG9ydGVkX2VudGl0aWVzLAogICAgICAgICAgICBzdXBwb3J0ZWRfbGFuZ3VhZ2U9c3VwcG9ydGVkX2xhbmd1YWdlLAogICAgICAgICkKCiAgICAjIGdldCB0aGUgcHJlc2lkaW8gZXhwbGFuYXRpb24gZm9yIHRoZSByZXN1bHQKCiAgICBkZWYgX2J1aWxkX3NwYWN5X2V4cGxhbmF0aW9uKAogICAgICAgIHNlbGYsIG9yaWdpbmFsX3Njb3JlOiBmbG9hdCwgZXhwbGFuYXRpb246IHN0cgogICAgKSAtPiBwYS5BbmFseXNpc0V4cGxhbmF0aW9uOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZSBleHBsYW5hdGlvbiBmb3Igd2h5IHRoaXMgcmVzdWx0IHdhcyBkZXRlY3RlZC4KCiAgICAgICAgOnBhcmFtIG9yaWdpbmFsX3Njb3JlOiBTY29yZSBnaXZlbiBieSB0aGlzIHJlY29nbml6ZXIKICAgICAgICA6cGFyYW0gZXhwbGFuYXRpb246ICAgIEV4cGxhbmF0aW9uIHN0cmluZwoKICAgICAgICA6cmV0dXJuczogUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbiBvYmplY3QKICAgICAgICAiIiIKICAgICAgICBleHBsYW5hdGlvbiA9IHBhLkFuYWx5c2lzRXhwbGFuYXRpb24oCiAgICAgICAgICAgIHJlY29nbml6ZXI9c2VsZi5fX2NsYXNzX18uX19uYW1lX18sCiAgICAgICAgICAgIG9yaWdpbmFsX3Njb3JlPW9yaWdpbmFsX3Njb3JlLAogICAgICAgICAgICB0ZXh0dWFsX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICkKICAgICAgICByZXR1cm4gZXhwbGFuYXRpb24KCiAgICAjIG1haW4gbWV0aG9kIGZvciB0aGUgcmVjb2duaXplcgogICAgZGVmIGFuYWx5emUoc2VsZiwgdGV4dDogc3RyLCBlbnRpdGllczogTGlzdFtzdHJdLCBubHBfYXJ0aWZhY3RzPU5vbmUpOiAgIyBub3FhIEQxMDIKICAgICAgICAiIiIKICAgICAgICBBbmFseXplIHRleHQgdXNpbmcgU3BhY3kuCgogICAgICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICBUZXh0IHRvIGFuYWx5emUKICAgICAgICA6cGFyYW0gZW50aXRpZXM6ICAgICAgRW50aXRpZXMgdG8gYW5hbHl6ZQogICAgICAgIDpwYXJhbSBubHBfYXJ0aWZhY3RzOiBOTFAgYXJ0aWZhY3RzIHRvIHVzZQoKICAgICAgICA6cmV0dXJuczogTGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IG9iamVjdHMKICAgICAgICAiIiIKICAgICAgICByZXN1bHRzID0gW10KICAgICAgICBpZiBub3QgbmxwX2FydGlmYWN0czoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlNraXBwaW5nIFNwYUN5LCBubHAgYXJ0aWZhY3RzIG5vdCBwcm92aWRlZC4uLiIpCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzCgogICAgICAgIG5lcl9lbnRpdGllcyA9IG5scF9hcnRpZmFjdHMuZW50aXRpZXMKCiAgICAgICAgIyByZWNvZ25pemUgdGhlIHN1cHBvcnRlZCBlbnRpdGllcwogICAgICAgIGZvciBlbnRpdHkgaW4gZW50aXRpZXM6CiAgICAgICAgICAgIGlmIGVudGl0eSBub3QgaW4gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXM6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBmb3IgZW50IGluIG5lcl9lbnRpdGllczoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9fY2hlY2tfbGFiZWwoZW50aXR5LCBlbnQubGFiZWxfLCBzZWxmLmNoZWNrX2xhYmVsX2dyb3Vwcyk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAjIHN0cmluZyBvZiB0aGUgZXhwbGFuYXRpb24gc2F5aW5nIHRoZSBlbnRpdHkgaXMgcmVjb2duaXplZCBieSBzcGFjeQogICAgICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbiA9IHNlbGYuX0RFRkFVTFRfRVhQTEFOQVRJT04uZm9ybWF0KGVudC5sYWJlbF8pCiAgICAgICAgICAgICAgICBleHBsYW5hdGlvbiA9IHNlbGYuX2J1aWxkX3NwYWN5X2V4cGxhbmF0aW9uKAogICAgICAgICAgICAgICAgICAgIHNlbGYubmVyX3N0cmVuZ3RoLCB0ZXh0dWFsX2V4cGxhbmF0aW9uCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgIyBjcmVhdGUgdGhlIHN0YW5kYXJkIHJlc3VsdCB3aXRoIHRoZSBlbnRpdHksIHN0YXJ0LCBlbmQsIHNjb3JlLCBhbmQgZXhwbGFuYXRpb24KICAgICAgICAgICAgICAgIHNwYWN5X3Jlc3VsdCA9IHBhLlJlY29nbml6ZXJSZXN1bHQoCiAgICAgICAgICAgICAgICAgICAgZW50aXR5X3R5cGU9ZW50aXR5LAogICAgICAgICAgICAgICAgICAgIHN0YXJ0PWVudC5zdGFydF9jaGFyLAogICAgICAgICAgICAgICAgICAgIGVuZD1lbnQuZW5kX2NoYXIsCiAgICAgICAgICAgICAgICAgICAgc2NvcmU9c2VsZi5uZXJfc3RyZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgYW5hbHlzaXNfZXhwbGFuYXRpb249ZXhwbGFuYXRpb24sCiAgICAgICAgICAgICAgICAgICAgcmVjb2duaXRpb25fbWV0YWRhdGE9ewogICAgICAgICAgICAgICAgICAgICAgICBwYS5SZWNvZ25pemVyUmVzdWx0LlJFQ09HTklaRVJfTkFNRV9LRVk6IHNlbGYubmFtZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByZXN1bHRzLmFwcGVuZChzcGFjeV9yZXN1bHQpCgogICAgICAgIHJldHVybiByZXN1bHRzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9fY2hlY2tfbGFiZWwoCiAgICAgICAgZW50aXR5OiBzdHIsIGxhYmVsOiBzdHIsIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdCiAgICApIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ2hlY2sgaWYgdGhlIGxhYmVsIGlzIGluIHRoZSBsYWJlbCBncm91cC4KCiAgICAgICAgOnBhcmFtIGVudGl0eTogICAgICAgICAgICAgRW50aXR5IHRvIGNoZWNrCiAgICAgICAgOnBhcmFtIGxhYmVsOiAgICAgICAgICAgICAgTGFiZWwgdG8gY2hlY2sKICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sKCiAgICAgICAgOnJldHVybnM6IFRydWUgaWYgdGhlIGxhYmVsIGlzIGluIHRoZSBsYWJlbCBncm91cCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGFueSgKICAgICAgICAgICAgZW50aXR5IGluIGVncnAgYW5kIGxhYmVsIGluIGxncnAgZm9yIGVncnAsIGxncnAgaW4gY2hlY2tfbGFiZWxfZ3JvdXBzCiAgICAgICAgKQoKCiMgQ2xhc3MgdG8gdXNlIEZsYWlyIHdpdGggUHJlc2lkaW8gYXMgYW4gZXh0ZXJuYWwgcmVjb2duaXplci4KY2xhc3MgRmxhaXJSZWNvZ25pemVyKHBhLkVudGl0eVJlY29nbml6ZXIpOgogICAgIiIiCiAgICBXcmFwcGVyIGZvciBhIGZsYWlyIG1vZGVsLCBpZiBuZWVkZWQgdG8gYmUgdXNlZCB3aXRoaW4gUHJlc2lkaW8gQW5hbHl6ZXIuCiAgICBUaGlzIGlzIHRvIG1ha2Ugc3VyZSB0aGUgcmVjb2duaXplciBjYW4gYmUgcmVnaXN0ZXJlZCB3aXRoIFByZXNpZGlvIHJlZ2lzdHJ5LgogICAgIiIiCgogICAgX0RFRkFVTFRfRU5USVRJRVMgPSBbCiAgICAgICAgIkxPQ0FUSU9OIiwKICAgICAgICAiUEVSU09OIiwKICAgICAgICAiTlJQIiwKICAgICAgICAiR1BFIiwKICAgICAgICAiT1JHQU5JWkFUSU9OIiwKICAgICAgICAiTUFDX0FERFJFU1MiLAogICAgICAgICJVU19CQU5LX05VTUJFUiIsCiAgICAgICAgIklNRUkiLAogICAgICAgICJUSVRMRSIsCiAgICAgICAgIkxJQ0VOU0VfUExBVEUiLAogICAgICAgICJVU19QQVNTUE9SVCIsCiAgICAgICAgIkNVUlJFTkNZIiwKICAgICAgICAiUk9VVElOR19OVU1CRVIiLAogICAgICAgICJVU19JVElOIiwKICAgICAgICAiVVNfQkFOS19OVU1CRVIiLAogICAgICAgICJVU19EUklWRVJfTElDRU5TRSIsCiAgICAgICAgIkFHRSIsCiAgICAgICAgIlBBU1NXT1JEIiwKICAgICAgICAiU1dJRlRfQ09ERSIsCiAgICBdCgogICAgIyBUaGlzIGlzIHVzZWQgdG8gY29uc3RydWN0IHRoZSBleHBsYW5hdGlvbiBmb3IgdGhlIHJlc3VsdAoKICAgIF9ERUZBVUxUX0VYUExBTkFUSU9OID0gIklkZW50aWZpZWQgYXMge30gYnkgRmxhaXIncyBOYW1lZCBFbnRpdHkgUmVjb2duaXRpb24iCgogICAgX0RFRkFVTFRfQ0hFQ0tfTEFCRUxfR1JPVVBTID0gWwogICAgICAgICh7IkxPQ0FUSU9OIn0sIHsiTE9DIiwgIkxPQ0FUSU9OIiwgIlNUUkVFVF9BRERSRVNTIiwgIkNPT1JESU5BVEUifSksCiAgICAgICAgKHsiUEVSU09OIn0sIHsiUEVSIiwgIlBFUlNPTiJ9KSwKICAgICAgICAoeyJOUlAifSwgeyJOT1JQIiwgIk5SUCJ9KSwKICAgICAgICAoeyJHUEUifSwgeyJHUEUifSksCiAgICAgICAgKHsiT1JHQU5JWkFUSU9OIn0sIHsiT1JHIn0pLAogICAgICAgICh7Ik1BQ19BRERSRVNTIn0sIHsiTUFDX0FERFJFU1MifSksCiAgICAgICAgKHsiVVNfQkFOS19OVU1CRVIifSwgeyJVU19CQU5LX05VTUJFUiJ9KSwKICAgICAgICAoeyJJTUVJIn0sIHsiSU1FSSJ9KSwKICAgICAgICAoeyJUSVRMRSJ9LCB7IlRJVExFIn0pLAogICAgICAgICh7IkxJQ0VOU0VfUExBVEUifSwgeyJMSUNFTlNFX1BMQVRFIn0pLAogICAgICAgICh7IlVTX1BBU1NQT1JUIn0sIHsiVVNfUEFTU1BPUlQifSksCiAgICAgICAgKHsiQ1VSUkVOQ1kifSwgeyJDVVJSRU5DWSJ9KSwKICAgICAgICAoeyJST1VUSU5HX05VTUJFUiJ9LCB7IlJPVVRJTkdfTlVNQkVSIn0pLAogICAgICAgICh7IkFHRSJ9LCB7IkFHRSJ9KSwKICAgICAgICAoeyJDVVJSRU5DWSJ9LCB7IkNVUlJFTkNZIn0pLAogICAgICAgICh7IlNXSUZUX0NPREUifSwgeyJTV0lGVF9DT0RFIn0pLAogICAgICAgICh7IlVTX0lUSU4ifSwgeyJVU19JVElOIn0pLAogICAgICAgICh7IlVTX0JBTktfTlVNQkVSIn0sIHsiVVNfQkFOS19OVU1CRVIifSksCiAgICAgICAgKHsiVVNfRFJJVkVSX0xJQ0VOU0UifSwgeyJVU19EUklWRVJfTElDRU5TRSJ9KSwKICAgIF0KCiAgICBfREVGQVVMVF9NT0RFTF9MQU5HVUFHRVMgPSB7CiAgICAgICAgImVuIjogImJla2kvZmxhaXItcGlpLWRpc3RpbGJlcnQiLAogICAgfQoKICAgIF9ERUZBVUxUX1BSRVNJRElPX0VRVUlWQUxFTkNFUyA9IHsKICAgICAgICAiUEVSIjogIlBFUlNPTiIsCiAgICAgICAgIkxPQyI6ICJMT0NBVElPTiIsCiAgICAgICAgIk9SRyI6ICJPUkdBTklaQVRJT04iLAogICAgICAgICJOUk9QIjogIk5SUCIsCiAgICAgICAgIlVSTCI6ICJVUkwiLAogICAgICAgICJVU19JVElOIjogIlVTX0lUSU4iLAogICAgICAgICJVU19QQVNTUE9SVCI6ICJVU19QQVNTUE9SVCIsCiAgICAgICAgIklCQU5fQ09ERSI6ICJJQkFOX0NPREUiLAogICAgICAgICJJUF9BRERSRVNTIjogIklQX0FERFJFU1MiLAogICAgICAgICJFTUFJTF9BRERSRVNTIjogIkVNQUlMIiwKICAgICAgICAiVVNfRFJJVkVSX0xJQ0VOU0UiOiAiVVNfRFJJVkVSX0xJQ0VOU0UiLAogICAgICAgICJVU19CQU5LX05VTUJFUiI6ICJVU19CQU5LX05VTUJFUiIsCiAgICB9CgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlOiBzdHIgPSAiZW4iLAogICAgICAgIHN1cHBvcnRlZF9lbnRpdGllczogTGlzdFtzdHJdID0gTm9uZSwKICAgICAgICBjaGVja19sYWJlbF9ncm91cHM6IFR1cGxlW1NldCwgU2V0XSA9IE5vbmUsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgdGhlIEZsYWlyUmVjb2duaXplci4KCiAgICAgICAgOnBhcmFtIHN1cHBvcnRlZF9sYW5ndWFnZTogTGFuZ3VhZ2UgdG8gdXNlCiAgICAgICAgOnBhcmFtIHN1cHBvcnRlZF9lbnRpdGllczogRW50aXRpZXMgdG8gdXNlCiAgICAgICAgOnBhcmFtIGNoZWNrX2xhYmVsX2dyb3VwczogTGFiZWwgZ3JvdXBzIHRvIGNoZWNrCgogICAgICAgIDpyZXR1cm5zOiBGbGFpclJlY29nbml6ZXIgb2JqZWN0CgogICAgICAgICIiIgogICAgICAgIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzID0gY2hlY2tfbGFiZWxfZ3JvdXBzIG9yIHNlbGYuX0RFRkFVTFRfQ0hFQ0tfTEFCRUxfR1JPVVBTCgogICAgICAgIHN1cHBvcnRlZF9lbnRpdGllcyA9IHN1cHBvcnRlZF9lbnRpdGllcyBvciBzZWxmLl9ERUZBVUxUX0VOVElUSUVTCiAgICAgICAgc2VsZi5tb2RlbCA9IGZsLm1vZGVscy5TZXF1ZW5jZVRhZ2dlci5sb2FkKAogICAgICAgICAgICBzZWxmLl9ERUZBVUxUX01PREVMX0xBTkdVQUdFUy5nZXQoc3VwcG9ydGVkX2xhbmd1YWdlKQogICAgICAgICkKCiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygKICAgICAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzPXN1cHBvcnRlZF9lbnRpdGllcywKICAgICAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlPXN1cHBvcnRlZF9sYW5ndWFnZSwKICAgICAgICAgICAgbmFtZT0iRmxhaXIgQW5hbHl0aWNzIiwKICAgICAgICApCgogICAgIyBtYWluIG1ldGhvZCBmb3IgdGhlIHJlY29nbml6ZXIKICAgIGRlZiBhbmFseXplKAogICAgICAgIHNlbGYsCiAgICAgICAgdGV4dDogc3RyLAogICAgICAgIGVudGl0aWVzOiBMaXN0W3N0cl0sCiAgICAgICAgbmxwX2FydGlmYWN0czogcGEubmxwX2VuZ2luZS5ObHBBcnRpZmFjdHMgPSBOb25lLAogICAgKSAtPiBMaXN0W3BhLlJlY29nbml6ZXJSZXN1bHRdOgogICAgICAgICIiIgogICAgICAgIEFuYWx5emUgdGV4dCBhbmQgcmV0dXJuIHRoZSByZXN1bHRzLgoKICAgICAgICA6cGFyYW0gdGV4dDogICAgICAgICAgVGhlIHRleHQgZm9yIGFuYWx5c2lzLgogICAgICAgIDpwYXJhbSBlbnRpdGllczogICAgICBUaGUgbGlzdCBvZiBlbnRpdGllcyB0byByZWNvZ25pemUuCiAgICAgICAgOnBhcmFtIG5scF9hcnRpZmFjdHM6IE5vdCB1c2VkIGJ5IHRoaXMgcmVjb2duaXplciBidXQgbmVlZGVkIGZvciB0aGUgaW50ZXJmYWNlLgogICAgICAgIDpwYXJhbSBsYW5ndWFnZTogICAgICBUZXh0IGxhbmd1YWdlLiBTdXBwb3J0ZWQgbGFuZ3VhZ2VzIGluIE1PREVMX0xBTkdVQUdFUwoKICAgICAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIHRoZSByZWNvZ25pemVkIEZsYWlyIGRldGVjdGlvbnMuCiAgICAgICAgIiIiCgogICAgICAgIHJlc3VsdHMgPSBbXQoKICAgICAgICBzZW50ZW5jZXMgPSBmbC5kYXRhLlNlbnRlbmNlKHRleHQpCiAgICAgICAgc2VsZi5tb2RlbC5wcmVkaWN0KHNlbnRlbmNlcykKCiAgICAgICAgIyBJZiB0aGVyZSBhcmUgbm8gc3BlY2lmaWMgbGlzdCBvZiBlbnRpdGllcywgd2Ugd2lsbCBsb29rIGZvciBhbGwgb2YgaXQuCiAgICAgICAgaWYgbm90IGVudGl0aWVzOgogICAgICAgICAgICBlbnRpdGllcyA9IHNlbGYuc3VwcG9ydGVkX2VudGl0aWVzCgogICAgICAgICMgR28gb3ZlciB0aGUgZW50aXRpZXMgYW5kIGNoZWNrIGlmIHRoZXkgYXJlIGluIHRoZSBzdXBwb3J0ZWQgZW50aXRpZXMgbGlzdC4KICAgICAgICBmb3IgZW50aXR5IGluIGVudGl0aWVzOgogICAgICAgICAgICBpZiBlbnRpdHkgbm90IGluIHNlbGYuc3VwcG9ydGVkX2VudGl0aWVzOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgR28gb3ZlciB0aGUgc2VudGVuY2VzIGFuZCBjaGVjayBpZiB0aGUgZW50aXR5IGlzIGluIHRoZSBzZW50ZW5jZS4KICAgICAgICAgICAgZm9yIGVudCBpbiBzZW50ZW5jZXMuZ2V0X3NwYW5zKCJuZXIiKToKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9fY2hlY2tfbGFiZWwoCiAgICAgICAgICAgICAgICAgICAgZW50aXR5LCBlbnQubGFiZWxzWzBdLnZhbHVlLCBzZWxmLmNoZWNrX2xhYmVsX2dyb3VwcwogICAgICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICMgSWYgdGhlIGVudGl0eSBpcyBpbiB0aGUgc2VudGVuY2UsIHdlIHdpbGwgYWRkIGl0IHRvIHRoZSByZXN1bHRzLgogICAgICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbiA9IHNlbGYuX0RFRkFVTFRfRVhQTEFOQVRJT04uZm9ybWF0KAogICAgICAgICAgICAgICAgICAgIGVudC5sYWJlbHNbMF0udmFsdWUKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICAjIEJ1aWxkIHRoZSBleHBsYW5hdGlvbiBmb3IgdGhlIHJlc3VsdAogICAgICAgICAgICAgICAgZXhwbGFuYXRpb24gPSBzZWxmLl9idWlsZF9mbGFpcl9leHBsYW5hdGlvbigKICAgICAgICAgICAgICAgICAgICByb3VuZChlbnQuc2NvcmUsIDIpLCB0ZXh0dWFsX2V4cGxhbmF0aW9uCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgZmxhaXJfcmVzdWx0ID0gc2VsZi5fY29udmVydF90b19yZWNvZ25pemVyX3Jlc3VsdChlbnQsIGV4cGxhbmF0aW9uKQoKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKGZsYWlyX3Jlc3VsdCkKCiAgICAgICAgcmV0dXJuIHJlc3VsdHMKCiAgICBkZWYgX2NvbnZlcnRfdG9fcmVjb2duaXplcl9yZXN1bHQoCiAgICAgICAgc2VsZiwgZW50aXR5OiBmbC5kYXRhLlNwYW4sIGV4cGxhbmF0aW9uOiBzdHIKICAgICkgLT4gcGEuUmVjb2duaXplclJlc3VsdDoKICAgICAgICAiIiIKICAgICAgICBDb252ZXJ0IEZsYWlyIHJlc3VsdCB0byBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0LgoKICAgICAgICA6cGFyYW0gZW50aXR5OiAgICAgIEZsYWlyIGVudGl0eSBvZiBTcGFuCiAgICAgICAgOnBhcmFtIGV4cGxhbmF0aW9uOiBQcmVzaWRpbyBBbmFseXNpc0V4cGxhbmF0aW9uCgogICAgICAgIDpyZXR1cm5zOiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0CiAgICAgICAgIiIiCgogICAgICAgICMgQ29udmVydCB0aGUgZW50aXR5IHR5cGUgdG8gUHJlc2lkaW8gZW50aXR5IHR5cGUKICAgICAgICBlbnRpdHlfdHlwZSA9IHNlbGYuX0RFRkFVTFRfUFJFU0lESU9fRVFVSVZBTEVOQ0VTLmdldChlbnRpdHkudGFnLCBlbnRpdHkudGFnKQoKICAgICAgICAjIENvbnZlcnQgdGhlIHNjb3JlIHRvIFByZXNpZGlvIHNjb3JlCiAgICAgICAgZmxhaXJfc2NvcmUgPSByb3VuZChlbnRpdHkuc2NvcmUsIDIpCgogICAgICAgICMgQ3JlYXRlIHRoZSBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGZyb20gdGhlIEZsYWlyIGVudGl0eQogICAgICAgIGZsYWlyX3Jlc3VsdHMgPSBwYS5SZWNvZ25pemVyUmVzdWx0KAogICAgICAgICAgICBlbnRpdHlfdHlwZT1lbnRpdHlfdHlwZSwKICAgICAgICAgICAgc3RhcnQ9ZW50aXR5LnN0YXJ0X3Bvc2l0aW9uLAogICAgICAgICAgICBlbmQ9ZW50aXR5LmVuZF9wb3NpdGlvbiwKICAgICAgICAgICAgc2NvcmU9ZmxhaXJfc2NvcmUsCiAgICAgICAgICAgIGFuYWx5c2lzX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICkKCiAgICAgICAgcmV0dXJuIGZsYWlyX3Jlc3VsdHMKCiAgICBkZWYgX2J1aWxkX2ZsYWlyX2V4cGxhbmF0aW9uKAogICAgICAgIHNlbGYsIG9yaWdpbmFsX3Njb3JlOiBmbG9hdCwgZXhwbGFuYXRpb246IHN0cgogICAgKSAtPiBwYS5BbmFseXNpc0V4cGxhbmF0aW9uOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZSBleHBsYW5hdGlvbiBmb3Igd2h5IHRoaXMgcmVzdWx0IHdhcyBkZXRlY3RlZC4KCiAgICAgICAgOnBhcmFtIG9yaWdpbmFsX3Njb3JlOiBTY29yZSBnaXZlbiBieSB0aGlzIHJlY29nbml6ZXIKICAgICAgICA6cGFyYW0gZXhwbGFuYXRpb246ICAgIEV4cGxhbmF0aW9uIHN0cmluZwoKICAgICAgICA6cmV0dXJuczogUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbgogICAgICAgICIiIgoKICAgICAgICAjIENyZWF0ZSB0aGUgUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbiBmb3IgdGhlIHJlc3VsdAogICAgICAgIGV4cGxhbmF0aW9uID0gcGEuQW5hbHlzaXNFeHBsYW5hdGlvbigKICAgICAgICAgICAgcmVjb2duaXplcj1zZWxmLl9fY2xhc3NfXy5fX25hbWVfXywKICAgICAgICAgICAgb3JpZ2luYWxfc2NvcmU9b3JpZ2luYWxfc2NvcmUsCiAgICAgICAgICAgIHRleHR1YWxfZXhwbGFuYXRpb249ZXhwbGFuYXRpb24sCiAgICAgICAgKQogICAgICAgIHJldHVybiBleHBsYW5hdGlvbgoKICAgICMgc2FuaXR5IGNoZWNrIG9mIHRoZSBlbnRpdHkgYW5kIGxhYmVsIGJlZm9yZSByZWNvZ25pdGlvbgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9fY2hlY2tfbGFiZWwoCiAgICAgICAgZW50aXR5OiBzdHIsIGxhYmVsOiBzdHIsIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdCiAgICApIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIGFueSgKICAgICAgICAgICAgZW50aXR5IGluIGVncnAgYW5kIGxhYmVsIGluIGxncnAgZm9yIGVncnAsIGxncnAgaW4gY2hlY2tfbGFiZWxfZ3JvdXBzCiAgICAgICAgKQoKCiMgZ2V0IHRoZSBhbmFseXplciBlbmdpbmUgYmFzZWQgb24gdGhlIG1vZGVsCmRlZiBfZ2V0X2FuYWx5emVyX2VuZ2luZShtb2RlbDogc3RyID0gIndob2xlIikgLT4gcGEuQW5hbHl6ZXJFbmdpbmU6CiAgICAiIiIKICAgIFJldHVybiBwYS5BbmFseXplckVuZ2luZS4KCiAgICA6cGFyYW0gbW9kZWw6IFRoZSBtb2RlbCB0byB1c2UuIENhbiBiZSAic3BhY3kiLCAiZmxhaXIiLCAicGF0dGVybiIgb3IgIndob2xlIi4KCiAgICA6cmV0dXJuczogcGEuQW5hbHl6ZXJFbmdpbmUKICAgICIiIgogICAgIyByZWNvZ25pemVyIHJlZ2lzdHJ5IHRoYXQgY2FuIHN0b3JlIG11bHRpcGxlIHJlY29nbml6ZXJzCiAgICByZWdpc3RyeSA9IHBhLlJlY29nbml6ZXJSZWdpc3RyeSgpCgogICAgaWYgbW9kZWwgPT0gInNwYWN5IjoKICAgICAgICAjIGN1c3RvbSBzcGFjeSByZWNvZ25pemVyCiAgICAgICAgc3BhY3lfcmVjb2duaXplciA9IEN1c3RvbVNwYWN5UmVjb2duaXplcigpCiAgICAgICAgIyBhZGQgdGhlIGN1c3RvbSBidWlsZCBzcGFjeSByZWNvZ25pemVyCiAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIoc3BhY3lfcmVjb2duaXplcikKICAgIGlmIG1vZGVsID09ICJmbGFpciI6CiAgICAgICAgIyBwcmUtdHJhaW5lZCBmbGFpciByZWNvZ25pemVyCiAgICAgICAgZmxhaXJfcmVjb2duaXplciA9IEZsYWlyUmVjb2duaXplcigpCiAgICAgICAgIyBhZGQgdGhlIGN1c3RvbSBidWlsZCBmbGFpciByZWNvZ25pemVyCiAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIoZmxhaXJfcmVjb2duaXplcikKICAgIGlmIG1vZGVsID09ICJwYXR0ZXJuIjoKICAgICAgICAjIGFkZCB0aGUgcGF0dGVybiByZWNvZ25pemVyCiAgICAgICAgcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkgPSBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkoKQogICAgICAgIGZvciByZWNvZ25pemVyIGluIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5Ll9jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKCk6CiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCiAgICBpZiBtb2RlbCA9PSAid2hvbGUiOgogICAgICAgIHNwYWN5X3JlY29nbml6ZXIgPSBDdXN0b21TcGFjeVJlY29nbml6ZXIoKQogICAgICAgIGZsYWlyX3JlY29nbml6ZXIgPSBGbGFpclJlY29nbml6ZXIoKQogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHNwYWN5X3JlY29nbml6ZXIpCiAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIoZmxhaXJfcmVjb2duaXplcikKICAgICAgICAjIGFkZCB0aGUgcGF0dGVybiByZWNvZ25pemVyCiAgICAgICAgcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkgPSBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkoKQogICAgICAgIGZvciByZWNvZ25pemVyIGluIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5Ll9jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKCk6CiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCgogICAgYW5hbHl6ZXIgPSBwYS5BbmFseXplckVuZ2luZShyZWdpc3RyeT1yZWdpc3RyeSwgc3VwcG9ydGVkX2xhbmd1YWdlcz1bImVuIl0pCiAgICByZXR1cm4gYW5hbHl6ZXIKCgpkZWYgX2dldF9hbm9ueW1pemVyX2VuZ2luZSgpIC0+IHByZV9hbm95bWl6ZXIuQW5vbnltaXplckVuZ2luZToKICAgICIiIgogICAgUmV0dXJuIEFub255bWl6ZXJFbmdpbmUuCgogICAgOnJldHVybnM6IFRoZSBBbm9ueW1pemVyRW5naW5lLgogICAgIiIiCiAgICByZXR1cm4gcHJlX2Fub3ltaXplci5Bbm9ueW1pemVyRW5naW5lKCkKCgpkZWYgX2FuYWx5emUoKiprd2FyZ3MpIC0+IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF06CiAgICAiIiIKICAgIEFuYWx5emUgaW5wdXQgdXNpbmcgQW5hbHl6ZXIgZW5naW5lIGFuZCBpbnB1dCBhcmd1bWVudHMgKGt3YXJncykuCgogICAgOnBhcmFtIGt3YXJnczogVGhlIGlucHV0IGFyZ3VtZW50cyBmb3IgdGhlIGFuYWx5emVyIGVuZ2luZS4KCiAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIHRoZSByZWNvZ25pemVkCiAgICAiIiIKICAgIGlmICJlbnRpdGllcyIgbm90IGluIGt3YXJncyBvciAiQWxsIiBpbiBrd2FyZ3NbImVudGl0aWVzIl06CiAgICAgICAga3dhcmdzWyJlbnRpdGllcyJdID0gTm9uZQogICAgcmV0dXJuIGFuYWx5emVyX2VuZ2luZSgpLmFuYWx5emUoKiprd2FyZ3MpCgoKZGVmIF9hbm9ueW1pemUodGV4dDogc3RyLCBhbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0pIC0+IHN0cjoKICAgICIiIgogICAgQW5vbnltaXplIGlkZW50aWZpZWQgaW5wdXQgdXNpbmcgUHJlc2lkaW8gQWJvbnltaXplci4KCiAgICA6cGFyYW0gdGV4dDogICAgICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gYW5hbHl6ZV9yZXN1bHRzOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20KCiAgICA6cmV0dXJuczogVGhlIGFub255bWl6ZWQgdGV4dC4KICAgICIiIgogICAgaWYgbm90IHRleHQ6CiAgICAgICAgcmV0dXJuCiAgICByZXMgPSBfZ2V0X2Fub255bWl6ZXJfZW5naW5lKCkuYW5vbnltaXplKHRleHQsIGFuYWx5emVfcmVzdWx0cykKICAgIHJldHVybiByZXMudGV4dAoKCmRlZiBfYW5ub3RhdGUodGV4dDogc3RyLCBzdF9hbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0pIC0+IExpc3Rbc3RyXToKICAgICIiIgogICAgQW5ub3RhdGUgaWRlbnRpZmllZCBpbnB1dCB1c2luZyBQcmVzaWRpbyBBbm9ueW1pemVyLgoKICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICAgICAgIFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgIDpwYXJhbSBzdF9hbmFseXplX3Jlc3VsdHM6IFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KCiAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgdG9rZW5zIHdpdGggdGhlIGlkZW50aWZpZWQgZW50aXRpZXMuCgogICAgIiIiCiAgICB0b2tlbnMgPSBbXQogICAgIyBzb3J0IGJ5IHN0YXJ0IGluZGV4CiAgICByZXN1bHRzID0gc29ydGVkKHN0X2FuYWx5emVfcmVzdWx0cywga2V5PWxhbWJkYSB4OiB4LnN0YXJ0KQogICAgZm9yIGksIHJlcyBpbiBlbnVtZXJhdGUocmVzdWx0cyk6CiAgICAgICAgaWYgaSA9PSAwOgogICAgICAgICAgICB0b2tlbnMuYXBwZW5kKHRleHRbOiByZXMuc3RhcnRdKQoKICAgICAgICAjIGFwcGVuZCBlbnRpdHkgdGV4dCBhbmQgZW50aXR5IHR5cGUKICAgICAgICB0b2tlbnMuYXBwZW5kKCh0ZXh0W3Jlcy5zdGFydCA6IHJlcy5lbmRdLCByZXMuZW50aXR5X3R5cGUpKQoKICAgICAgICAjIGlmIGFub3RoZXIgZW50aXR5IGNvbWluZyBpLmUuIHdlJ3JlIG5vdCBhdCB0aGUgbGFzdCByZXN1bHRzIGVsZW1lbnQsCiAgICAgICAgIyBhZGQgdGV4dCB1cCB0byBuZXh0IGVudGl0eQogICAgICAgIGlmIGkgIT0gbGVuKHJlc3VsdHMpIC0gMToKICAgICAgICAgICAgdG9rZW5zLmFwcGVuZCh0ZXh0W3Jlcy5lbmQgOiByZXN1bHRzW2kgKyAxXS5zdGFydF0pCiAgICAgICAgIyBpZiBubyBtb3JlIGVudGl0aWVzIGNvbWluZywgYWRkIGFsbCByZW1haW5pbmcgdGV4dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRva2Vucy5hcHBlbmQodGV4dFtyZXMuZW5kIDpdKQogICAgcmV0dXJuIHRva2VucwoKCmRlZiBfcHJvY2VzcygKICAgIHRleHQ6IHN0ciwKICAgIG1vZGVsOiBwYS5BbmFseXplckVuZ2luZSwKICAgIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUsCiAgICBpc19mdWxsX3JlcG9ydDogYm9vbCA9IFRydWUsCikgLT4gVHVwbGVbc3RyLCBzdHIsIHN0cl06CiAgICAiIiIKICAgIFByb2Nlc3MgdGhlIHRleHQgb2Ygc3RyIHVzaW5nIHRoZSBtb2RlbC4KCiAgICA6cGFyYW0gdHh0OiAgICAgICAgICAgIFRleHQgdG8gcHJvY2VzcwogICAgOnBhcmFtIG1vZGVsOiAgICAgICAgICBNb2RlbCB0byB1c2UgZm9yIHByb2Nlc3NpbmcKICAgIDpwYXJhbSBpc19mdWxsX2h0bWw6ICAgV2hldGhlciB0byByZXR1cm4gdGhlIGZ1bGwgaHRtbCBvciBqdXN0IHRoZSBhbm5vdGF0ZWQgdGV4dAogICAgOnBhcmFtIGlzX2Z1bGxfcmVwb3J0OiBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCByZXBvcnQgb3IganVzdCB0aGUgc2NvcmUKCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKCiAgICAgICAgICAgICAgKiB0aGUgYW5vbnltaXplZCB0ZXh0CiAgICAgICAgICAgICAgKiB0aGUgaHRtbCBzdHJpbmcgd2l0aCBlbnRpdGllcyBoaWdobGlnaHRlZAogICAgICAgICAgICAgICogdGhlIHN0YXRzIHJlcG9ydAogICAgIiIiCgogICAgIyBnZXQgdGhlIGFuYWx5emVyIGVuZ2luZQoKICAgIGFuYWx5emVyID0gbW9kZWwKCiAgICAjIGFuYWx5emUgdGhlIHRleHQgdGhhdCBjYW4gYmUgdXNlZCBmb3IgYW5vbnltaXphdGlvbgogICAgcmVzdWx0cyA9IGFuYWx5emVyLmFuYWx5emUoCiAgICAgICAgdGV4dD10ZXh0LAogICAgICAgIGxhbmd1YWdlPSJlbiIsCiAgICAgICAgZW50aXRpZXM9YW5hbHl6ZXIuZ2V0X3N1cHBvcnRlZF9lbnRpdGllcygpLAogICAgICAgIHJldHVybl9kZWNpc2lvbl9wcm9jZXNzPVRydWUsCiAgICApCgogICAgIyBhbm9ueW1pemUgdGhlIHRleHQsIHJlcGxhY2UgdGhlIHBpaSBlbnRpdGllcyB3aXRoIHRoZSBsYWJlbHMKICAgIGFub255bWl6ZWRfdGV4dCA9IF9hbm9ueW1pemUodGV4dCwgcmVzdWx0cykKCiAgICAjIGNvbnZlcnQgdGhlIHJlc3VsdHMgdG8gdG9rZW5zIHRvIGdlbmVyYXRlIHRoZSBodG1sCiAgICBhbm5vdGF0ZWRfdG9rZW5zID0gX2Fubm90YXRlKHRleHQsIHJlc3VsdHMpCiAgICBwYXJ0X2Fubm9udGF0ZWRfdG9rZW5zID0gW10KICAgIGlmIG5vdCBpc19mdWxsX2h0bWw6CiAgICAgICAgbGFzdF9lbmRfc2VudGVuY2UgPSAwCiAgICAgICAgZm9yIGksIHRva2VuIGluIGVudW1lcmF0ZShhbm5vdGF0ZWRfdG9rZW5zKToKICAgICAgICAgICAgaWYgYW55KGl0ZW0gaW4gdG9rZW4gZm9yIGl0ZW0gaW4gWyIuIiwgIiEiLCAiPyJdKSBhbmQgYW55KAogICAgICAgICAgICAgICAgdHlwZShpdGVtKSBpcyB0dXBsZSBmb3IgaXRlbSBpbiBhbm5vdGF0ZWRfdG9rZW5zW2xhc3RfZW5kX3NlbnRlbmNlOmldCiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBwYXJ0X2Fubm9udGF0ZWRfdG9rZW5zLmFwcGVuZChhbm5vdGF0ZWRfdG9rZW5zW2xhc3RfZW5kX3NlbnRlbmNlOmldKQogICAgICAgICAgICAgICAgbGFzdF9lbmRfc2VudGVuY2UgPSBpCiAgICAgICAgaHRtbCA9IGF0X3V0aWwuZ2V0X2Fubm90YXRlZF9odG1sKCpwYXJ0X2Fubm9udGF0ZWRfdG9rZW5zKQogICAgZWxzZToKICAgICAgICBodG1sID0gYXRfdXRpbC5nZXRfYW5ub3RhdGVkX2h0bWwoKmFubm90YXRlZF90b2tlbnMpCgogICAgIyBhdm9pZCB0aGUgZXJyb3IgZHVyaW5nIHJlbmRlcmluZyBvZiB0aGUgXG4gaW4gdGhlIGh0bWwKICAgIGJhY2tzbGFzaF9jaGFyID0gIlxcIgoKICAgIGh0bWxfc3RyID0gZiI8cD57aHRtbC5yZXBsYWNlKCd7YmFja3NsYXNoX2NoYXJ9bicsICc8YnI+Jyl9PC9wPiIKCiAgICAjIGdlbmVyYXRlIHRoZSBzdGF0cyByZXBvcnQgaWYgbmVlZGVkCiAgICBpZiBub3QgaXNfZnVsbF9yZXBvcnQ6CiAgICAgICAgc3RhdHMgPSBbXQogICAgICAgICMgYWRkIHRoZSBzaW1wbGlmeSBzdGF0cyBsb2dpYyBoZXJlCiAgICAgICAgZm9yIGl0ZW0gaW4gcmVzdWx0czoKICAgICAgICAgICAgaXRlbS5hbmFseXNpc19leHBsYW5hdGlvbiA9IE5vbmUKICAgICAgICAgICAgc3RhdHMuYXBwZW5kKGl0ZW0pCiAgICBlbHNlOgogICAgICAgIHN0YXRzID0gcmVzdWx0cwoKICAgIHJldHVybiBhbm9ueW1pemVkX3RleHQsIGh0bWxfc3RyLCBzdGF0cwoKCmRlZiByZWNvZ25pemVfcGlpKAogICAgY29udGV4dDogbWxydW4uTUxDbGllbnRDdHgsCiAgICBpbnB1dF9wYXRoOiBzdHIsCiAgICBvdXRwdXRfcGF0aDogc3RyLAogICAgb3V0cHV0X3N1ZmZpeDogc3RyLAogICAgaHRtbF9rZXk6IHN0ciwKICAgIG1vZGVsOiBzdHIgPSAid2hvbGUiLAogICAgaXNfZnVsbF9odG1sOiBib29sID0gVHJ1ZSwKICAgIGlzX2Z1bGxfcmVwb3J0OiBib29sID0gVHJ1ZSwKKSAtPiBUdXBsZVtwYXRobGliLlBhdGgsIGRpY3QsIGRpY3RdOgogICAgIiIiCiAgICBXYWxrIHRocm91Z2ggdGhlIGlucHV0IHBhdGgsIHJlY29nbml6ZSBQSUkgaW4gdGV4dCBhbmQgc3RvcmUgdGhlIGFub255bWl6ZWQgdGV4dCBpbiB0aGUgb3V0cHV0IHBhdGguIEdlbmVyYXRlIHRoZSBodG1sIHdpdGggZGlmZmVyZW50IGNvbG9ycyBmb3IgZWFjaCBlbnRpdHksIGpzb24gcmVwb3J0IG9mIHRoZSBleHBsYWluYXRpb24uCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgIFRoZSBNTFJ1biBjb250ZXh0LiB0aGlzIGlzIG5lZWRlZCBmb3IgbG9nIHRoZSBhcnRpZmFjdHMuCiAgICA6cGFyYW0gaW5wdXRfcGF0aDogICAgVGhlIGlucHV0IHBhdGggb2YgdGhlIHRleHQgZmlsZXMgbmVlZHMgdG8gYmUgYW5hbHl6aWVkLgogICAgOnBhcmFtIG91dHB1dF9wYXRoOiAgIFRoZSBvdXRwdXQgcGF0aCB0byBzdG9yZSB0aGUgYW5vbnltaXplZCB0ZXh0LgogICAgOnBhcmFtIG91dHB1dF9zdWZmaXg6IFRoZSBzdXJmaXggb2Ygb3V0cHV0IGtleSBmb3IgdGhlIGFub255bWl6ZWQgdGV4dC4gZm9yIGV4YW1wbGUgaWYgdGhlIGlucHV0IGZpbGUgaXMgcGlpLnR4dCwgdGhlIG91dHB1dCBrZXkgaXMgYW5veW1pemVkLCB0aGUgb3V0cHV0IGZpbGUgbmFtZSB3aWxsIGJlIHBpaV9hbm9ueW1pemVkLnR4dC4KICAgIDpwYXJhbSBodG1sX2tleTogICAgICBUaGUgaHRtbCBrZXkgZm9yIHRoZSBhcnRpZmFjdC4KICAgIDpwYXJhbSBtb2RlbDogICAgICAgICBUaGUgbW9kZWwgdG8gdXNlLiBDYW4gYmUgInNwYWN5IiwgImZsYWlyIiwgInBhdHRlcm4iIG9yICJ3aG9sZSIuCiAgICA6cGFyYW0gaXNfZnVsbF9odG1sOiAgIFdoZXRoZXIgdG8gcmV0dXJuIHRoZSBmdWxsIGh0bWwgb3IganVzdCB0aGUgYW5ub3RhdGVkIHRleHQKICAgIDpwYXJhbSBpc19mdWxsX3JlcG9ydDogV2hldGhlciB0byByZXR1cm4gdGhlIGZ1bGwgcmVwb3J0IG9yIGp1c3QgdGhlIHNjb3JlIGFuZCBzdGFydCwgZW5kIGluZGV4CgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CgogICAgICAgICAgICAgICogUGF0aCB0byB0aGUgb3V0cHV0IGRpcmVjdG9yeQogICAgICAgICAgICAgICogVGhlIGpzb24gcmVwb3J0IG9mIHRoZSBleHBsYWluYXRpb24KICAgICAgICAgICAgICAqIEEgZGljdGlvbmFyeSBvZiBlcnJvcnMgZmlsZXMgdGhhdCB3ZXJlIG5vdCBwcm9jZXNzZWQKCiAgICAiIiIKCiAgICAjIFNldCBvdXRwdXQgZGlyZWN0b3J5CiAgICBpZiBvdXRwdXRfcGF0aCBpcyBOb25lOgogICAgICAgIG91dHB1dF9wYXRoID0gdGVtcGZpbGUubWtkdGVtcCgpCgogICAgIyBDcmVhdGUgdGhlIG91dHB1dCBkaXJlY3Rvcnk6CiAgICBvdXRwdXRfZGlyZWN0b3J5ID0gcGF0aGxpYi5QYXRoKG91dHB1dF9wYXRoKQogICAgaWYgbm90IG91dHB1dF9kaXJlY3RvcnkuZXhpc3RzKCk6CiAgICAgICAgb3V0cHV0X2RpcmVjdG9yeS5ta2RpcigpCgogICAgIyBMb2FkIHRoZSBtb2RlbDoKICAgIGFuYWx5emVyID0gX2dldF9hbmFseXplcl9lbmdpbmUobW9kZWwpCiAgICBwcmludCgiTW9kZWwgbG9hZGVkIikKCiAgICAjIEdvIG92ZXIgdGhlIHRleHQgZmlsZXMgaW4gdGhlIGlucHV0IHBhdGgsIGFuYWx5emUgYW5kIGFub255bWl6ZSB0aGVtOgogICAgdHh0X2ZpbGVzX2RpcmVjdG9yeSA9IHBhdGhsaWIuUGF0aChpbnB1dF9wYXRoKQogICAgIyBUaGVzZSBhcmUgcGxhY2Vob2xkZXIgZm9yIHRoZSBodG1sIHN0cmluZyBhbmQgdGhlIHN0YXRzIHJlcG9ydAogICAgaHRtbF9pbmRleCA9ICI8aHRtbD48aGVhZD48dGl0bGU+SGlnaGxpZ2h0ZWQgUGlpIEVudGl0aWVzPC90aXRsZT48L2hlYWQ+PGJvZHk+PGgxPkhpZ2hsaWdodGVkIFBpaSBFbnRpdGllczwvaDE+PHVsPiIKICAgIGh0bWxfY29udGVudCA9ICIiCiAgICBycHRfanNvbiA9IHt9CiAgICBlcnJvcnMgPSB7fQoKICAgICMgR28gb3ZlciB0aGUgdGV4dCBmaWxlcyBpbiB0aGUgaW5wdXQgcGF0aCwgYW5hbHl6ZSBhbmQgYW5vbnltaXplIHRoZW06CiAgICBmb3IgaSwgdHh0X2ZpbGUgaW4gZW51bWVyYXRlKAogICAgICAgIHRxZG0oCiAgICAgICAgICAgIGxpc3QodHh0X2ZpbGVzX2RpcmVjdG9yeS5nbG9iKCIqLnR4dCIpKSwKICAgICAgICAgICAgZGVzYz0iUHJvY2Vzc2luZyBmaWxlcyIsCiAgICAgICAgICAgIHVuaXQ9ImZpbGUiLAogICAgICAgICkKICAgICk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIExvYWQgdGhlIHN0ciBmcm9tIHRoZSB0ZXh0IGZpbGUKICAgICAgICAgICAgdGV4dCA9IHR4dF9maWxlLnJlYWRfdGV4dCgpCiAgICAgICAgICAgICMgUHJvY2VzcyB0aGUgdGV4dCB0byByZWNvZ2luemUgdGhlIHBpaSBlbnRpdGllcyBpbiBpdAogICAgICAgICAgICBhbm9ueW1pemVkX3RleHQsIGh0bWxfc3RyLCBzdGF0cyA9IF9wcm9jZXNzKAogICAgICAgICAgICAgICAgdGV4dCwgYW5hbHl6ZXIsIGlzX2Z1bGxfaHRtbCwgaXNfZnVsbF9yZXBvcnQKICAgICAgICAgICAgKQogICAgICAgICAgICAjIEFkZCB0aGUgaW5kZXggYXQgdGhlIHRvcCBvZiB0aGUgaHRtbAogICAgICAgICAgICBodG1sX2luZGV4ICs9IGYnPGxpPjxhIGhyZWY9IiN7c3RyKHR4dF9maWxlKX0iPntzdHIodHh0X2ZpbGUpfTwvYT48L2xpPicKICAgICAgICAgICAgIyBBZGQgdGhlIGhpZ2h0bGlnaHRlZCBodG1sIHRvIHRoZSBodG1sIGNvbnRlbnQKICAgICAgICAgICAgaHRtbF9jb250ZW50ICs9IGYnPGgyIGlkPSJ7c3RyKHR4dF9maWxlKX0iPntzdHIodHh0X2ZpbGUpfTwvaDI+e2h0bWxfc3RyfScKCiAgICAgICAgICAgICMgU3RvcmUgdGhlIGFub255bWl6ZWQgdGV4dCBpbiB0aGUgb3V0cHV0IHBhdGgKICAgICAgICAgICAgb3V0cHV0X2ZpbGUgPSAoCiAgICAgICAgICAgICAgICBvdXRwdXRfZGlyZWN0b3J5CiAgICAgICAgICAgICAgICAvIGYie3N0cih0eHRfZmlsZS5yZWxhdGl2ZV90byh0eHRfZmlsZXNfZGlyZWN0b3J5KSkuc3BsaXQoJy4nKVswXX1fe291dHB1dF9zdWZmaXh9LnR4dCIKICAgICAgICAgICAgKQoKICAgICAgICAgICAgb3V0cHV0X2ZpbGUucGFyZW50Lm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAgICAgd2l0aCBvcGVuKG91dHB1dF9maWxlLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGFub255bWl6ZWRfdGV4dCkKCiAgICAgICAgICAgICMgUGxhY2Vob2xkZXIgZm9yIHRoZSBqc29uIHJlcG9ydCBmb3IgYSBzaW5nbGUgZmlsZQogICAgICAgICAgICBuZXdfc3RhdHMgPSBbXQogICAgICAgICAgICBmb3IgaXRlbSBpbiBzdGF0czoKICAgICAgICAgICAgICAgIGlmIGlzX2Z1bGxfcmVwb3J0OgogICAgICAgICAgICAgICAgICAgIGl0ZW0uYW5hbHlzaXNfZXhwbGFuYXRpb24gPSBpdGVtLmFuYWx5c2lzX2V4cGxhbmF0aW9uLnRvX2RpY3QoKQogICAgICAgICAgICAgICAgICAgIG5ld19zdGF0cy5hcHBlbmQoaXRlbS50b19kaWN0KCkpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHRtcF9kaWN0ID0gaXRlbS50b19kaWN0KCkKICAgICAgICAgICAgICAgICAgICB0bXBfZGljdC5wb3AoImFuYWx5c2lzX2V4cGxhbmF0aW9uIikKICAgICAgICAgICAgICAgICAgICB0bXBfZGljdC5wb3AoInJlY29nbml0aW9uX21ldGFkYXRhIikKICAgICAgICAgICAgICAgICAgICBuZXdfc3RhdHMuYXBwZW5kKHRtcF9kaWN0KQoKICAgICAgICAgICAgIyBBZGQgdGhlIGpzb24gcmVwb3J0IHRvIHRoZSBqc29uIHJlcG9ydCBkaWN0IHdpdGggZmlsZW5hbWUgYXMga2V5CiAgICAgICAgICAgIHJwdF9qc29uW3N0cih0eHRfZmlsZSldID0gbmV3X3N0YXRzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcnNbc3RyKHR4dF9maWxlKV0gPSBzdHIoZSkKICAgICAgICAgICAgcHJpbnQoZiJFcnJvciBwcm9jZXNzaW5nIHt0eHRfZmlsZX06IHtlfSIpCgogICAgaHRtbF9pbmRleCArPSAiPC91bD4iCiAgICBodG1sX3JlcyA9IGYie2h0bWxfaW5kZXh9e2h0bWxfY29udGVudH08L2JvZHk+PC9odG1sPiIKICAgIGFydGlfaHRtbCA9IG1scnVuLmFydGlmYWN0cy5BcnRpZmFjdChib2R5PWh0bWxfcmVzLCBmb3JtYXQ9Imh0bWwiLCBrZXk9aHRtbF9rZXkpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChhcnRpX2h0bWwpCiAgICByZXR1cm4gb3V0cHV0X3BhdGgsIHJwdF9qc29uLCBlcnJvcnMK
    base_image: mlrun/mlrun
    commands: []
    code_origin: git@github.com-personal:pengwei715/functions.git#b32223f4c3a8b5c1b4950555d054de2b8d88d464:pii_recognizer.py
    origin_filename: pii_recognizer.py
    requirements:
    - mlrun==1.4.0-rc19
    - pandas
    - presidio-anonymizer
    - presidio-analyzer
    - torch
    - flair@git+https://github.com/flairNLP/flair.git@d4ed67bf663e4066517f00397412510d90043653
    - st-annotated-text
    - https://huggingface.co/beki/en_spacy_pii_distilbert/resolve/main/en_spacy_pii_distilbert-any-py3-none-any.whl
  entry_points:
    analyze:
      name: analyze
      doc: Analyze text and return the results.
      parameters:
      - name: self
        default: ''
      - name: text
        type: str
        doc: The text for analysis.
        default: ''
      - name: entities
        type: List[str]
        doc: The list of entities to recognize.
        default: ''
      - name: nlp_artifacts
        type: pa.nlp_engine.NlpArtifacts
        doc: Not used by this recognizer but needed for the interface.
        default: null
      outputs:
      - default: ''
        doc: The list of Presidio RecognizerResult constructed from the recognized
          Flair detections.
      lineno: 343
    recognize_pii:
      name: recognize_pii
      doc: Walk through the input path, recognize PII in text and store the anonymized
        text in the output path. Generate the html with different colors for each
        entity, json report of the explaination.
      parameters:
      - name: context
        type: MLClientCtx
        doc: The MLRun context. this is needed for log the artifacts.
        default: ''
      - name: input_path
        type: str
        doc: The input path of the text files needs to be analyzied.
        default: ''
      - name: output_path
        type: str
        doc: The output path to store the anonymized text.
        default: ''
      - name: output_suffix
        type: str
        doc: The surfix of output key for the anonymized text. for example if the
          input file is pii.txt, the output key is anoymized, the output file name
          will be pii_anonymized.txt.
        default: ''
      - name: html_key
        type: str
        doc: The html key for the artifact.
        default: ''
      - name: model
        type: str
        doc: The model to use. Can be "spacy", "flair", "pattern" or "whole".
        default: whole
      - name: is_full_html
        type: bool
        doc: Whether to return the full html or just the annotated text
        default: true
      - name: is_full_report
        type: bool
        doc: Whether to return the full report or just the score and start, end index
        default: true
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 633
  description: This function is used to recognize PII in a given text
  default_handler: recognize_pii
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  resources:
    requests:
      memory: 1Mi
      cpu: 25m
    limits:
      memory: 20Gi
      cpu: '2'
  priority_class_name: igz-workload-medium
  preemption_mode: prevent
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: app.iguazio.com/lifecycle
            operator: NotIn
            values:
            - preemptible
          - key: eks.amazonaws.com/capacityType
            operator: NotIn
            values:
            - SPOT
          - key: node-lifecycle
            operator: NotIn
            values:
            - spot
  tolerations: null
  security_context: {}
verbose: false
