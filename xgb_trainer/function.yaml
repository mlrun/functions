kind: job
metadata:
  name: xgb-trainer
  tag: latest
  hash: 7e7d86632f18d53c6405db20cc0a7bc32f09aad3
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train an xgboost model.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7fb9896eacf8>
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
        doc: json model config file
      outputs: []
      lineno: 28
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTI3IDA5OjI5CgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmltcG9ydCBqc29uCmltcG9ydCBvcwoKZnJvbSBjbG91ZHBpY2tsZSBpbXBvcnQgZHVtcHMsIGxvYWQsIGR1bXAKCmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0Cgpmcm9tIHNrbGVhcm4ucHJlcHJvY2Vzc2luZyBpbXBvcnQgbGFiZWxfYmluYXJpemUKZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgdHJhaW5fdGVzdF9zcGxpdApmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKCmZyb20gdHlwaW5nIGltcG9ydCBMaXN0CmZyb20gbWxydW4uZXhlY3V0aW9uIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IFBsb3RBcnRpZmFjdApmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IChnZXRfY2xhc3NfZml0LCBjcmVhdGVfY2xhc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsb3Rfcm9jLCBwbG90X2ltcG9ydGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGdjZl9jbGVhcikKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhSXRlbSwKICAgIGxhYmVsX2NvbHVtbjogc3RyID0gImxhYmVscyIsCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgdGVzdF9zaXplOiBmbG9hdCA9IDAuMDUsCiAgICB0cmFpbl92YWxfc3BsaXQ6IGZsb2F0ID0gMC43NSwKICAgIHJuZzogaW50ID0gMSwKICAgIG1vZGVsX2ZpbGVuYW1lOiBzdHIgPSAibW9kZWwiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICIiLAogICAgcGxvdHNfZGVzdDogc3RyID0gIiIsCiAgICBzY29yZV9tZXRob2Q6IHN0ciA9ICJtaWNybyIsCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLCAgICAKKSAtPiBOb25lOgogICAgIiIidHJhaW4gYW4geGdib29zdCBtb2RlbC4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxfcGtnX2NsYXNzOiAgIHRoZSBtb2RlbCB0byB0cmFpbiwgZS5nLCAic2tsZWFybi5uZXVyYWxfbmV0d29ya3MuTUxQQ2xhc3NpZmllciIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBqc29uIG1vZGVsIGNvbmZpZwogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAoImRhdGEiKSBuYW1lIG9mIHJhdyBkYXRhIGZpbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBzYW1wbGU6ICAgICAgICAgICAgU2VsZWN0cyB0aGUgZmlyc3QgbiByb3dzLCBvciBzZWxlY3QgYSBzYW1wbGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRpbmcgZnJvbSB0aGUgZmlyc3QuIElmIG5lZ2F0aXZlIDwtMSwgc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEgcmFuZG9tIHNhbXBsZQogICAgOnBhcmFtIG1vZGVsX2ZpbGVuYW1lOiAgICBtb2RlbCBmaWxlIGZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludHMgdG8gYSBkaXJlY3RvcnkKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgICAgKDAuMDUpIHRlc3Qgc2V0IHNpemUKICAgIDpwYXJhbSB0cmFpbl92YWxfc3BsaXQ6ICAgKDAuNzUpIE9uY2UgdGhlIHRlc3Qgc2V0IGhhcyBiZWVuIHJlbW92ZWQgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWluaW5nIHNldCBnZXRzIHRoaXMgcHJvcG9ydGlvbi4KICAgIDpwYXJhbSBybmc6ICAgICAgICAgICAgICAgKDEpIHNrbGVhcm4gcm5nIHNlZWQKICAgIDpwYXJhbSBtb2RlbHNfZGVzdDogICAgICAgbW9kZWxzIHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgIHBsb3Qgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgICAgZm9yIG11bHRpY2xhc3MgY2xhc3NpZmljYXRpb24KICAgIAogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICA6cGFyYW0gbW9kZWxfcGtnX2ZpbGU6ICAgIGpzb24gbW9kZWwgY29uZmlnIGZpbGUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAiIiIKICAgIHNyY2ZpbGVwYXRoID0gc3RyKGRhdGFzZXQpCiAgICAKICAgIG1vZGVsc19kZXN0ID0gbW9kZWxzX2Rlc3Qgb3IgJ21vZGVscycKICAgIHBsb3RzX2Rlc3QgPSBwbG90c19kZXN0IG9yIGYncGxvdHMve2NvbnRleHQubmFtZX0nCiAgICAKICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCJjc3YiKToKICAgICAgICByZWFkZXIgPSBwZC5yZWFkX2NzdgogICAgZWxpZiBzcmNmaWxlcGF0aC5lbmRzd2l0aCgicGFycXVldCIpIG9yIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCJwcSIpOgogICAgICAgIHJlYWRlciA9IHBkLnJlYWRfcGFycXVldAogICAgZWxzZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZiJmaWxlIHR5cGUgdW5oYW5kbGVkIHtzcmNmaWxlcGF0aH0iKQoKICAgIGlmIChzYW1wbGUgPT0gLTEpIG9yIChzYW1wbGUgPj0gMSk6CiAgICAgICAgcmF3ID0gcmVhZGVyKHNyY2ZpbGVwYXRoKS5kcm9wbmEoKQogICAgICAgIGxhYmVscyA9IHJhdy5wb3AobGFiZWxfY29sdW1uKQogICAgICAgIHJhdyA9IHJhdy5pbG9jWzpzYW1wbGUsIDpdCiAgICAgICAgbGFiZWxzID0gbGFiZWxzLmlsb2NbOnNhbXBsZV0KICAgIGVsc2U6CiAgICAgICAgcmF3ID0gcmVhZGVyKHNyY2ZpbGVwYXRoKS5kcm9wbmEoKS5zYW1wbGUoc2FtcGxlICogLTEpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCgogICAgY29udGV4dC5oZWFkZXIgPSByYXcuY29sdW1ucy52YWx1ZXMKICAgIAogICAgeWIgPSBsYWJlbF9iaW5hcml6ZShsYWJlbHMsIGNsYXNzZXM9bGFiZWxzLnVuaXF1ZSgpKQogICAgCiAgICB4LCB4dGVzdCwgeSwgeXRlc3QgPSB0cmFpbl90ZXN0X3NwbGl0KG5wLmNvbmNhdGVuYXRlKFtyYXcsIHliXSwgYXhpcz0xKSwgbGFiZWxzLCB0ZXN0X3NpemU9dGVzdF9zaXplLCByYW5kb21fc3RhdGU9cm5nKQogICAgeHRyYWluLCB4dmFsaWQsIHl0cmFpbiwgeXZhbGlkID0gdHJhaW5fdGVzdF9zcGxpdCh4LCB5LCB0cmFpbl9zaXplPXRyYWluX3ZhbF9zcGxpdCwgcmFuZG9tX3N0YXRlPXJuZykKICAgIHl0cmFpbmIgPSB4dHJhaW5bOiwgLXliLnNoYXBlWzFdOl0uY29weSgpCiAgICB4dHJhaW4gPSB4dHJhaW5bOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpCiAgICB5dmFsaWRiID0geHZhbGlkWzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHZhbGlkID0geHZhbGlkWzosIDoteWIuc2hhcGVbMV1dLmNvcHkoKQogICAgeXRlc3RiID0geHRlc3RbOiwgLXliLnNoYXBlWzFdOl0uY29weSgpCiAgICB4dGVzdCA9IHh0ZXN0WzosIDoteWIuc2hhcGVbMV1dLmNvcHkoKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAKICAgIHRlc3Rfc2V0ID0gcGQuY29uY2F0KAogICAgICAgIFtwZC5EYXRhRnJhbWUoZGF0YT14dGVzdCwgY29sdW1ucz1jb250ZXh0LmhlYWRlciksCiAgICAgICAgIHBkLkRhdGFGcmFtZShkYXRhPXl0ZXN0LnZhbHVlcywgY29sdW1ucz1bbGFiZWxfY29sdW1uXSldLAogICAgICAgIGF4aXM9MSwpCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KCd0ZXN0X3NldCcsIGRmPXRlc3Rfc2V0LCBmb3JtYXQ9ZmlsZV9leHQsIGluZGV4PUZhbHNlKQoKICAgIGlmIG1vZGVsX3BrZ19maWxlOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGpzb24ubG9hZChvcGVuKG1vZGVsX3BrZ19maWxlLCAiciIpKQogICAgZWxpZiBtb2RlbF9wa2dfY2xhc3M6CiAgICAgICAgbW9kZWxfY29uZmlnID0gZ2V0X2NsYXNzX2ZpdChtb2RlbF9wa2dfY2xhc3MpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ21vZGVsX3BrZ19maWxlIG9yIG1vZGVsX3BrZ19jbGFzcyBtdXN0IGJlIHByb3ZpZGVkJykKICAgIAogICAgZm9yIGssIHYgaW4gY29udGV4dC5wYXJhbWV0ZXJzLml0ZW1zKCk6CiAgICAgICAgaWYgay5zdGFydHN3aXRoKCdDTEFTU18nKToKICAgICAgICAgICAgbW9kZWxfY29uZmlnWydDTEFTUyddW2tbNjpdXSA9IHYKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoJ0ZJVF8nKToKICAgICAgICAgICAgbW9kZWxfY29uZmlnWydGSVQnXVtrWzQ6XV0gPSB2CgogICAgbW9kZWxfY29uZmlnWyJGSVQiXS51cGRhdGUoeyJYIjogeHRyYWluLCJ5IjogeXRyYWluLnZhbHVlc30pCiAgICAKICAgIENsYXNzaWZpZXJDbGFzcyA9IGNyZWF0ZV9jbGFzcygieGdib29zdC4iICsgbW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKICAgIG1vZGVsLmZpdCgqKm1vZGVsX2NvbmZpZ1siRklUIl0pCiAgICAKICAgIHRyeToKICAgICAgICBtb2RlbC5zYXZlX21vZGVsKGYie21vZGVsc19kZXN0fS97bW9kZWxfZmlsZW5hbWV9LWxlZ2FjeS1zYXZlLnBrbCIpCiAgICAgICAgCiAgICAgICAgbW9kZWwuc2F2ZV9tb2RlbChmInttb2RlbHNfZGVzdH0ve21vZGVsX2ZpbGVuYW1lfS1leHAtc2F2ZS5qc29uIikKICAgICAgICAKICAgICAgICBfYm9vc3RlciA9IHhiZy5tb2RlbC5nZXRfYm9vc3RlcigpCiAgICAgICAgZHVtcChfYm9vc3Rlciwgb3BlbihmInttb2RlbHNfZGVzdH0ve21vZGVsX2ZpbGVuYW1lfS1sZWdhY3ktZHVtcC5wa2wiLCAid2IiKSkKICAgICAgICAKICAgICAgICBkYXRhID0gZHVtcHMoX2Jvb3N0ZXIpCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoJ21vZGVsJywgYm9keT1kYXRhLCBsb2NhbF9wYXRoPWYie21vZGVsc19kZXN0fS97bW9kZWxfZmlsZW5hbWV9LnBrbCIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIlNFUklBTElaRSBNT0RFTCBFUlJPUjoiLCBzdHIoZSkpCgogICAgeXByZWQgPSBtb2RlbC5wcmVkaWN0KHh2YWxpZCkKICAgIHlfc2NvcmUgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKHh2YWxpZCkKICAgIAogICAgdHJ5OgogICAgICAgIGlmIHl2YWxpZGIuc2hhcGVbMV0gPiAxOgogICAgICAgICAgICBhdmVyYWdlX3ByZWNpc2lvbiA9IG1ldHJpY3MuYXZlcmFnZV9wcmVjaXNpb25fc2NvcmUoeXZhbGlkYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl2YWxpZGIsIHlfc2NvcmUpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dmFsaWRiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZVs6LCAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXZhbGlkYiwgeV9zY29yZVs6LCAxXSkpCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY2FsY3VsYXRpbmcgcHJlY2lzaW9uJykKICAgICAgICAKICAgIHRyeToKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhY2N1cmFjeSIsIGZsb2F0KG1vZGVsLnNjb3JlKHh2YWxpZCwgeXZhbGlkKSkpCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY2FsY3VsYXRpbmcgYWNjdXJhY3knKQogICAgdHJ5OgogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZSh5dmFsaWQsIHlwcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkpCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY2FsY3VsYXRpbmcgZjFfc2NvcmUnKQoKICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl2YWxpZGIsIHlfc2NvcmUsIGtleT0icm9jIiwgcGxvdHNfZGlyPXBsb3RzX2Rlc3QpCiAgICBnY2ZfY2xlYXIocGx0KQogICAgbWV0cmljcy5wbG90X2NvbmZ1c2lvbl9tYXRyaXgobW9kZWwsIHh2YWxpZCwgeXZhbGlkLCBsYWJlbHM9bGFiZWxzLnVuaXF1ZSgpLCBub3JtYWxpemU9J3RydWUnKSAKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdCgiY29uZnVzaW9uIiwgYm9keT1wbHQuZ2NmKCkpLCBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L2NvbmZ1c2lvbi5odG1sIikKCg==
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#118a304d066eb14176edcd6f80d10b936a63f27f:xgb_trainer.ipynb
