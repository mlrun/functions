kind: job
metadata:
  name: speaker-diarization
  tag: ''
  hash: 57758dcbfe34df6d96d4f6a70f1310658867a51d
  project: ''
  labels:
    author: pgw
  categories:
  - data-preparation
  - machine-learning
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IG9zCmltcG9ydCBwYXRobGliCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgbWxydW4KaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIHRxZG0uYXV0byBpbXBvcnQgdHFkbQppbXBvcnQganNvbgppbXBvcnQgcHlkdWIKZnJvbSBweWFubm90ZS5jb3JlIGltcG9ydCBub3RlYm9vaywgQW5ub3RhdGlvbgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgcGFydGlhbApmcm9tIG9tZWdhY29uZiBpbXBvcnQgT21lZ2FDb25mCmZyb20gZGF0YWNsYXNzZXMgaW1wb3J0IGRhdGFjbGFzcywgZmllbGQsIGFzZGljdApmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgT3B0aW9uYWwsIFR1cGxlCmZyb20gbmVtby5jb2xsZWN0aW9ucy5hc3IubW9kZWxzIGltcG9ydCBDbHVzdGVyaW5nRGlhcml6ZXIKZnJvbSBuZW1vLmNvbGxlY3Rpb25zLmFzci5wYXJ0cy51dGlscy5zcGVha2VyX3V0aWxzIGltcG9ydCAoCiAgICBydHRtX3RvX2xhYmVscywKICAgIGxhYmVsc190b19weWFubm90ZV9vYmplY3QsCikKCgojIFVzaW5nIE5lbW8gdG8gZG8gc3BlYWtlciBkaWFyaXphdGlvbiB3ZSBuZWVkIHRoZSBmb2xsb3dpbmcgc3RlcHM6CiMgMS4gVm9pY2UgQWN0aXZpdHkgRGV0ZWN0aW9uLCB3aGljaCBwYXJ0IG9mIHRoZSBhdWRpbyBpcyBzcGVlY2ggYW5kIHdoaWNoIHBhcnQgaXMgbm90CiMgMi4gU3BlYWtlciBFbWJlZGRpbmcgaXMgdXNlZCB0byBleHRyYWN0IHRoZSBmZWF0dXJlcyBvZiB0aGUgc3BlZWNoCiMgMy4gQ2x1c3RlcmluZyB0aGUgZW1iZWRkaW5nIGdldCB0aGUgY2x1c3RlcnMgb2Ygc3BlYWtlcnMKIyA0LiBNdWx0aXNjYWxlIERpYXJpemF0aW9uIGRlY29kZXIgaXMgdXNlZCB0byBvYnRhaW4gdGhlIHNwZWFrZXIgcHJvZmlsZSBhbmQgZXN0aW1hdGVkIG51bWJlciBvZiBzcGVha2VycwoKCkBkYXRhY2xhc3MKY2xhc3MgR2VuZXJhbENvbmZpZzoKICAgIG5hbWU6IHN0ciA9ICJDbHVzdGVyRGlhcml6ZXIiCiAgICBudW1fd29ya2VyczogaW50ID0gMQogICAgc2FtcGxlX3JhdGU6IGludCA9IDE2MDAwCiAgICBiYXRjaF9zaXplOiBpbnQgPSA2NAogICAgZGV2aWNlOiBPcHRpb25hbFsKICAgICAgICBzdHIKICAgIF0gPSBOb25lICAjIFNldCB0byAnY3VkYToxJywgJ2N1ZGE6MicsIGV0Yy4sIGZvciBzcGVjaWZpYyBkZXZpY2VzCiAgICB2ZXJib3NlOiBib29sID0gVHJ1ZQoKCiMgUGFyYW1ldGVycyBmb3IgVkFEIChWb2ljZSBBY3Rpdml0eSBEZXRlY3Rpb24pCkBkYXRhY2xhc3MKY2xhc3MgVkFEUGFyYW1ldGVyczoKICAgIHdpbmRvd19sZW5ndGhfaW5fc2VjOiBmbG9hdCA9IDAuMTUgICMgV2luZG93IGxlbmd0aCBpbiBzZWNvbmRzIGZvciBWQUQgY29udGV4dCBpbnB1dAogICAgc2hpZnRfbGVuZ3RoX2luX3NlYzogZmxvYXQgPSAoCiAgICAgICAgMC4wMSAgIyBTaGlmdCBsZW5ndGggaW4gc2Vjb25kcyB0byBnZW5lcmF0ZSBmcmFtZS1sZXZlbCBWQUQgcHJlZGljdGlvbgogICAgKQogICAgc21vb3RoaW5nOiBzdHIgPSAibWVkaWFuIiAgIyBUeXBlIG9mIHNtb290aGluZyBtZXRob2QgKGUuZy4sICJtZWRpYW4iKQogICAgb3ZlcmxhcDogZmxvYXQgPSAwLjUgICMgT3ZlcmxhcCByYXRpbyBmb3Igb3ZlcmxhcHBlZCBtZWFuL21lZGlhbiBzbW9vdGhpbmcgZmlsdGVyCiAgICBvbnNldDogZmxvYXQgPSAwLjEgICMgT25zZXQgdGhyZXNob2xkIGZvciBkZXRlY3RpbmcgdGhlIGJlZ2lubmluZyBvZiBzcGVlY2gKICAgIG9mZnNldDogZmxvYXQgPSAwLjEgICMgT2Zmc2V0IHRocmVzaG9sZCBmb3IgZGV0ZWN0aW5nIHRoZSBlbmQgb2Ygc3BlZWNoCiAgICBwYWRfb25zZXQ6IGZsb2F0ID0gMC4xICAjIEFkZGl0aW9uYWwgZHVyYXRpb24gYmVmb3JlIGVhY2ggc3BlZWNoIHNlZ21lbnQKICAgIHBhZF9vZmZzZXQ6IGZsb2F0ID0gMCAgIyBBZGRpdGlvbmFsIGR1cmF0aW9uIGFmdGVyIGVhY2ggc3BlZWNoIHNlZ21lbnQKICAgIG1pbl9kdXJhdGlvbl9vbjogZmxvYXQgPSAwICAjIFRocmVzaG9sZCBmb3Igc21hbGwgbm9uLXNwZWVjaCBkZWxldGlvbgogICAgbWluX2R1cmF0aW9uX29mZjogZmxvYXQgPSAwLjIgICMgVGhyZXNob2xkIGZvciBzaG9ydCBzcGVlY2ggc2VnbWVudCBkZWxldGlvbgogICAgZmlsdGVyX3NwZWVjaF9maXJzdDogYm9vbCA9IFRydWUgICMgV2hldGhlciB0byBhcHBseSBhIHNwZWVjaC1maXJzdCBmaWx0ZXIKCgojIE1haW4gVkFEIENvbmZpZ3VyYXRpb24KQGRhdGFjbGFzcwpjbGFzcyBWQURDb25maWc6CiAgICBtb2RlbF9wYXRoOiBzdHIgPSAidmFkX211bHRpbGluZ3VhbF9tYXJibGVuZXQiICAjIFBhdGggdG8gdGhlIFZBRCBtb2RlbAogICAgZXh0ZXJuYWxfdmFkX21hbmlmZXN0OiBPcHRpb25hbFsKICAgICAgICBzdHIKICAgIF0gPSBOb25lICAjIE9wdGlvbmFsIHBhdGggdG8gYW4gZXh0ZXJuYWwgVkFEIG1hbmlmZXN0CiAgICBwYXJhbWV0ZXJzOiBWQURQYXJhbWV0ZXJzID0gZmllbGQoCiAgICAgICAgZGVmYXVsdF9mYWN0b3J5PVZBRFBhcmFtZXRlcnMKICAgICkgICMgTmVzdGVkIFZBRCBwYXJhbWV0ZXJzCgoKIyBQYXJhbWV0ZXJzIGZvciBTcGVha2VyIEVtYmVkZGluZ3MKQGRhdGFjbGFzcwpjbGFzcyBTcGVha2VyRW1iZWRkaW5nc1BhcmFtZXRlcnM6CiAgICB3aW5kb3dfbGVuZ3RoX2luX3NlYzogTGlzdFtmbG9hdF0gPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9bGFtYmRhOiBbMS41LCAxLjI1LCAxLjAsIDAuNzUsIDAuNV0KICAgICkgICMgV2luZG93IGxlbmd0aHMgZm9yIHNwZWFrZXIgZW1iZWRkaW5ncwogICAgc2hpZnRfbGVuZ3RoX2luX3NlYzogTGlzdFtmbG9hdF0gPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9bGFtYmRhOiBbMC43NSwgMC42MjUsIDAuNSwgMC4zNzUsIDAuMjVdCiAgICApICAjIFNoaWZ0IGxlbmd0aHMgZm9yIHNwZWFrZXIgZW1iZWRkaW5ncwogICAgbXVsdGlzY2FsZV93ZWlnaHRzOiBMaXN0W2ludF0gPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9bGFtYmRhOiBbMSwgMSwgMSwgMSwgMV0KICAgICkgICMgV2VpZ2h0cyBmb3IgZWFjaCBzY2FsZQogICAgc2F2ZV9lbWJlZGRpbmdzOiBib29sID0gVHJ1ZSAgIyBXaGV0aGVyIHRvIHNhdmUgdGhlIHNwZWFrZXIgZW1iZWRkaW5ncwoKCiMgTWFpbiBTcGVha2VyIEVtYmVkZGluZ3MgQ29uZmlndXJhdGlvbgpAZGF0YWNsYXNzCmNsYXNzIFNwZWFrZXJFbWJlZGRpbmdzQ29uZmlnOgogICAgbW9kZWxfcGF0aDogc3RyID0gInRpdGFuZXRfbGFyZ2UiICAjIFBhdGggdG8gdGhlIHNwZWFrZXIgZW1iZWRkaW5ncyBtb2RlbAogICAgcGFyYW1ldGVyczogU3BlYWtlckVtYmVkZGluZ3NQYXJhbWV0ZXJzID0gZmllbGQoCiAgICAgICAgZGVmYXVsdF9mYWN0b3J5PVNwZWFrZXJFbWJlZGRpbmdzUGFyYW1ldGVycwogICAgKSAgIyBOZXN0ZWQgc3BlYWtlciBlbWJlZGRpbmdzIHBhcmFtZXRlcnMKCgojIFBhcmFtZXRlcnMgZm9yIENsdXN0ZXJpbmcKQGRhdGFjbGFzcwpjbGFzcyBDbHVzdGVyaW5nUGFyYW1ldGVyczoKICAgIG9yYWNsZV9udW1fc3BlYWtlcnM6IGJvb2wgPSBGYWxzZSAgIyBXaGV0aGVyIHRvIHVzZSB0aGUgb3JhY2xlIG51bWJlciBvZiBzcGVha2VycwogICAgbWF4X251bV9zcGVha2VyczogaW50ID0gOCAgIyBNYXhpbXVtIG51bWJlciBvZiBzcGVha2VycyBwZXIgcmVjb3JkaW5nCiAgICBlbmhhbmNlZF9jb3VudF90aHJlczogaW50ID0gODAgICMgVGhyZXNob2xkIGZvciBlbmhhbmNlZCBzcGVha2VyIGNvdW50aW5nCiAgICBtYXhfcnBfdGhyZXNob2xkOiBmbG9hdCA9IDAuMjUgICMgTWF4IHJhbmdlIG9mIHAtdmFsdWUgc2VhcmNoIGZvciByZXNlZ21lbnRhdGlvbgogICAgc3BhcnNlX3NlYXJjaF92b2x1bWU6IGludCA9IDMwICAjIE51bWJlciBvZiB2YWx1ZXMgdG8gZXhhbWluZSBmb3Igc3BhcnNlIHNlYXJjaAogICAgbWFqX3ZvdGVfc3BrX2NvdW50OiBib29sID0gKAogICAgICAgIEZhbHNlICAjIFdoZXRoZXIgdG8gdGFrZSBhIG1ham9yaXR5IHZvdGUgZm9yIHNwZWFrZXIgY291bnQKICAgICkKCgojIE1haW4gQ2x1c3RlcmluZyBDb25maWd1cmF0aW9uCkBkYXRhY2xhc3MKY2xhc3MgQ2x1c3RlcmluZ0NvbmZpZzoKICAgIHBhcmFtZXRlcnM6IENsdXN0ZXJpbmdQYXJhbWV0ZXJzID0gZmllbGQoCiAgICAgICAgZGVmYXVsdF9mYWN0b3J5PUNsdXN0ZXJpbmdQYXJhbWV0ZXJzCiAgICApICAjIE5lc3RlZCBjbHVzdGVyaW5nIHBhcmFtZXRlcnMKCgojIFBhcmFtZXRlcnMgZm9yIE1TREQgKE11bHRpc2NhbGUgRGlhcml6YXRpb24gRGVjb2RlcikgTW9kZWwKQGRhdGFjbGFzcwpjbGFzcyBNU0REUGFyYW1ldGVyczoKICAgIHVzZV9zcGVha2VyX21vZGVsX2Zyb21fY2twdDogYm9vbCA9ICgKICAgICAgICBUcnVlICAjIFdoZXRoZXIgdG8gdXNlIHRoZSBzcGVha2VyIG1vZGVsIGZyb20gdGhlIGNoZWNrcG9pbnQKICAgICkKICAgIGluZmVyX2JhdGNoX3NpemU6IGludCA9IDI1ICAjIEJhdGNoIHNpemUgZm9yIE1TREQgaW5mZXJlbmNlCiAgICBzaWdtb2lkX3RocmVzaG9sZDogTGlzdFtmbG9hdF0gPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9bGFtYmRhOiBbMC43XQogICAgKSAgIyBTaWdtb2lkIHRocmVzaG9sZCBmb3IgYmluYXJpemVkIHNwZWFrZXIgbGFiZWxzCiAgICBzZXFfZXZhbF9tb2RlOiBib29sID0gKAogICAgICAgIEZhbHNlICAjIFdoZXRoZXIgdG8gdXNlIG9yYWNsZSBudW1iZXIgb2Ygc3BlYWtlcnMgZm9yIHNlcXVlbmNlIGV2YWx1YXRpb24KICAgICkKICAgIHNwbGl0X2luZmVyOiBib29sID0gVHJ1ZSAgIyBXaGV0aGVyIHRvIHNwbGl0IHRoZSBpbnB1dCBhdWRpbyBmb3IgaW5mZXJlbmNlCiAgICBkaWFyX3dpbmRvd19sZW5ndGg6IGludCA9ICgKICAgICAgICA1MCAgIyBMZW5ndGggb2YgdGhlIHNwbGl0IHNob3J0IHNlcXVlbmNlIHdoZW4gc3BsaXRfaW5mZXIgaXMgVHJ1ZQogICAgKQogICAgb3ZlcmxhcF9pbmZlcl9zcGtfbGltaXQ6IGludCA9ICgKICAgICAgICA1ICAjIExpbWl0IGZvciBlc3RpbWF0ZWQgbnVtYmVyIG9mIHNwZWFrZXJzIGZvciBvdmVybGFwIGluZmVyZW5jZQogICAgKQoKCiMgTWFpbiBNU0REIENvbmZpZ3VyYXRpb24KQGRhdGFjbGFzcwpjbGFzcyBNU0REQ29uZmlnOgogICAgbW9kZWxfcGF0aDogc3RyID0gImRpYXJfbXNkZF90ZWxlcGhvbmljIiAgIyBQYXRoIHRvIHRoZSBNU0REIG1vZGVsCiAgICBwYXJhbWV0ZXJzOiBNU0REUGFyYW1ldGVycyA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1NU0REUGFyYW1ldGVycwogICAgKSAgIyBOZXN0ZWQgTVNERCBwYXJhbWV0ZXJzCgoKIyBNYWluIERpYXJpemF0aW9uIENvbmZpZ3VyYXRpb24KQGRhdGFjbGFzcwpjbGFzcyBEaWFyaXphdGlvbkNvbmZpZzoKICAgIG1hbmlmZXN0X2ZpbGVwYXRoOiBzdHIgICMgUGF0aCB0byB0aGUgbWFuaWZlc3QgZmlsZQogICAgb3V0X2Rpcjogc3RyICAjIE91dHB1dCBkaXJlY3RvcnkKICAgIG9yYWNsZV92YWQ6IGJvb2wgPSBGYWxzZSAgIyBXaGV0aGVyIHRvIHVzZSBvcmFjbGUgVkFECiAgICBjb2xsYXI6IGZsb2F0ID0gMC4yNSAgIyBDb2xsYXIgdmFsdWUgZm9yIHNjb3JpbmcKICAgIGlnbm9yZV9vdmVybGFwOiBib29sID0gVHJ1ZSAgIyBXaGV0aGVyIHRvIGlnbm9yZSBvdmVybGFwIHNlZ21lbnRzCiAgICB2YWQ6IFZBRENvbmZpZyA9IGZpZWxkKGRlZmF1bHRfZmFjdG9yeT1WQURDb25maWcpICAjIE5lc3RlZCBWQUQgY29uZmlndXJhdGlvbgogICAgc3BlYWtlcl9lbWJlZGRpbmdzOiBTcGVha2VyRW1iZWRkaW5nc0NvbmZpZyA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1TcGVha2VyRW1iZWRkaW5nc0NvbmZpZwogICAgKSAgIyBOZXN0ZWQgc3BlYWtlciBlbWJlZGRpbmdzIGNvbmZpZ3VyYXRpb24KICAgIGNsdXN0ZXJpbmc6IENsdXN0ZXJpbmdDb25maWcgPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9Q2x1c3RlcmluZ0NvbmZpZwogICAgKSAgIyBOZXN0ZWQgY2x1c3RlcmluZyBjb25maWd1cmF0aW9uCiAgICBtc2RkX21vZGVsOiBNU0REQ29uZmlnID0gZmllbGQoCiAgICAgICAgZGVmYXVsdF9mYWN0b3J5PU1TRERDb25maWcKICAgICkgICMgTmVzdGVkIE1TREQgY29uZmlndXJhdGlvbgoKCiMgaGVscGVyIGZ1bmN0aW9uIHRvIGZvcm0gdGhlIGNvbmZpZ3MgdG8gZ2V0IGEgZGlhcml6ZXIgb2JqZWN0CmRlZiBfZ2V0X2NsdXN0ZXJpbmdfZGlhcml6ZXIoCiAgICBtYW5pZmVzdF9maWxlcGF0aDogc3RyLAogICAgYXVkaW9fZmlsZXBhdGg6IHN0ciwKICAgIG91dF9kaXI6IHN0ciwKICAgIHJ0dG1fZmlsZXBhdGg6IHN0ciA9IE5vbmUsCiAgICBvZmZzZXQ6IGludCA9IDAsCiAgICBkdXJhdGlvbjogT3B0aW9uYWxbZmxvYXRdID0gTm9uZSwKICAgIGxhYmVsOiBzdHIgPSAiaW5mZXIiLAogICAgdGV4dDogc3RyID0gIi0iLAogICAgbnVtX3NwZWFrZXJzOiBpbnQgPSAyLAogICAgdWVtX2ZpbGVwYXRoOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgIG51bV93b3JrZXJzOiBpbnQgPSAxLAogICAgc2FtcGxlX3JhdGU6IGludCA9IDE2MDAwLAogICAgYmF0Y2hfc2l6ZTogaW50ID0gNjQsCiAgICBkZXZpY2U6IE9wdGlvbmFsWwogICAgICAgIHN0cgogICAgXSA9IE5vbmUsICAjIFNldCB0byAnY3VkYToxJywgKGRlZmF1bHQgY3VkYSBpZiBjdWRhIGF2YWlsYWJsZSwgZWxzZSBjcHUpCiAgICB2ZXJib3NlOiBib29sID0gVHJ1ZSwKICAgICoqa3dhcmdzLAopIC0+IENsdXN0ZXJpbmdEaWFyaXplcjoKICAgICIiIgogICAgSGVscGVyIGZ1bmN0aW9uIHRvIGZvcm0gdGhlIGNvbmZpZ3MgdG8gZ2V0IGEgZGlhcml6ZXIgb2JqZWN0LgogICAgVG8gb3ZlcnJpZGUgYSBwYXJhbWV0ZXIgbmVzdGVkIGluc2lkZSBhIGNvbmZpZ3VyYXRpb24sIHRoZSBwYXR0ZXJuIGlzIDxjb25maWdfbmFtZT5fXzxwYXJhbWV0ZXJfbmFtZT5fXzxhdHRyaWJ1dGVfbmFtZT4uCgogICAgOnBhcmFtIG51bV93b3JrZXJzOiAgICAgICBOdW1iZXIgb2Ygd29ya2VycyBmb3IgY29tcHV0aW5nCiAgICA6cGFyYW0gc2FtcGxlX3JhdGU6ICAgICAgIFNhbXBsZSByYXRlIG9mIHRoZSBhdWRpbwogICAgOnBhcmFtIGJhdGNoX3NpemU6ICAgICAgICBCYXRjaCBzaXplIGZvciBjb21wdXRpbmcKICAgIDpwYXJhbSBkZXZpY2U6ICAgICAgICAgICAgRGV2aWNlIHRvIHVzZSBmb3IgY29tcHV0aW5nCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgIFdoZXRoZXIgdG8gcHJpbnQgaW50ZXJtZWRpYXRlIG91dHB1dHMKICAgIDpwYXJhbSBtYW5pZmVzdF9maWxlcGF0aDogUGF0aCB0byB0aGUgbWFuaWZlc3QgZmlsZQogICAgOnBhcmFtIGF1ZGlvX2ZpbGVwYXRoOiAgICBQYXRoIHRvIHRoZSBhdWRpbyBmaWxlCiAgICA6cGFyYW0gcnR0bV9maWxlcGF0aDogICAgIFBhdGggdG8gdGhlIFJUVE0gZmlsZSBpZiBpdCdzIGEgZ3JvdWQgdHJ1dGggaW5mZXJlbmNlCiAgICA6cGFyYW0gb2Zmc2V0OiAgICAgICAgICAgIE9mZnNldCB2YWx1ZQogICAgOnBhcmFtIGR1cmF0aW9uOiAgICAgICAgICBEdXJhdGlvbiBvZiB0aGUgYXVkaW8KICAgIDpwYXJhbSBsYWJlbDogICAgICAgICAgICAgTGFiZWwgZm9yIHRoZSBhdWRpbwogICAgOnBhcmFtIHRleHQ6ICAgICAgICAgICAgICBUZXh0IHJlcHJlc2VudGF0aW9uIG9mIHRoZSBhdWRpbwogICAgOnBhcmFtIG51bV9zcGVha2VyczogICAgICBOdW1iZXIgb2Ygc3BlYWtlcnMgaW4gdGhlIGF1ZGlvCiAgICA6cGFyYW0gdWVtX2ZpbGVwYXRoOiAgICAgIFBhdGggdG8gdGhlIFVFTSBmaWxlCiAgICA6cGFyYW0gb3V0X2RpcjogICAgICAgICAgIERpcmVjdG9yeSB0byBzdG9yZSBpbnRlcm1lZGlhdGUgZmlsZXMgYW5kIHByZWRpY3Rpb24gb3V0cHV0cwogICAgOnBhcmFtIGt3YXJnczogICAgICAgICAgICBBZGRpdGlvbmFsIGFyZ3VtZW50cyB0byBvdmVycmlkZSBkZWZhdWx0IGNvbmZpZyB2YWx1ZXMKCiAgICA6cmV0dXJuczogQ2x1c3RlcmluZ0RpYXJpemVyIG9iamVjdAogICAgIiIiCiAgICAjIENyZWF0ZSB0aGUgZ2VuZXJhbCBjb25maWcKICAgIGdlbmVyYWxfY29uZmlnID0gR2VuZXJhbENvbmZpZygKICAgICAgICBudW1fd29ya2Vycz1udW1fd29ya2VycywKICAgICAgICBzYW1wbGVfcmF0ZT1zYW1wbGVfcmF0ZSwKICAgICAgICBiYXRjaF9zaXplPWJhdGNoX3NpemUsCiAgICAgICAgZGV2aWNlPWRldmljZSwKICAgICAgICB2ZXJib3NlPXZlcmJvc2UsCiAgICApCgogICAgIyBDcmVhdGUgdGhlIG1hbmlmZXN0IGZpbGUKICAgIG1ldGEgPSB7CiAgICAgICAgImF1ZGlvX2ZpbGVwYXRoIjogYXVkaW9fZmlsZXBhdGgsCiAgICAgICAgIm9mZnNldCI6IG9mZnNldCwKICAgICAgICAiZHVyYXRpb24iOiBkdXJhdGlvbiwKICAgICAgICAibGFiZWwiOiBsYWJlbCwKICAgICAgICAidGV4dCI6IHRleHQsCiAgICAgICAgIm51bV9zcGVha2VycyI6IG51bV9zcGVha2VycywKICAgICAgICAicnR0bV9maWxlcGF0aCI6IHJ0dG1fZmlsZXBhdGgsCiAgICAgICAgInVlbV9maWxlcGF0aCI6IHVlbV9maWxlcGF0aCwKICAgIH0KCiAgICB3aXRoIG9wZW4obWFuaWZlc3RfZmlsZXBhdGgsICJ3IikgYXMgZnA6CiAgICAgICAganNvbi5kdW1wKG1ldGEsIGZwKQogICAgICAgIGZwLndyaXRlKCJcbiIpCgogICAgIyBFeHRyYWN0aW5nIHNwZWNpZmljIGt3YXJncyBmb3IgZWFjaCBjb25maWcgYW5kIHVwZGF0aW5nIHRoZW0KICAgIHZhZF9rd2FyZ3MgPSB7CiAgICAgICAgay5zcGxpdCgidmFkX18iKVsxXTogdiBmb3IgaywgdiBpbiBrd2FyZ3MuaXRlbXMoKSBpZiBrLnN0YXJ0c3dpdGgoInZhZF9fIikKICAgIH0KICAgIHZhZF9wYXJhbWV0ZXJzX2t3YXJncyA9IHsKICAgICAgICBrLnNwbGl0KCJ2YWRfX3BhcmFtZXRlcnNfXyIpWzFdOiB2CiAgICAgICAgZm9yIGssIHYgaW4ga3dhcmdzLml0ZW1zKCkKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoInZhZF9fcGFyYW1ldGVyc19fIikKICAgIH0KCiAgICBzcGVha2VyX2VtYmVkZGluZ3Nfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoInNwZWFrZXJfZW1iZWRkaW5nc19fIilbMV06IHYKICAgICAgICBmb3IgaywgdiBpbiBrd2FyZ3MuaXRlbXMoKQogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgic3BlYWtlcl9lbWJlZGRpbmdzX18iKQogICAgfQogICAgc3BlYWtlcl9wYXJhbWV0ZXJzX2t3YXJncyA9IHsKICAgICAgICBrLnNwbGl0KCJzcGVha2VyX2VtYmVkZGluZ3NfX3BhcmFtZXRlcnNfXyIpWzFdOiB2CiAgICAgICAgZm9yIGssIHYgaW4ga3dhcmdzLml0ZW1zKCkKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoInNwZWFrZXJfZW1iZWRkaW5nc19fcGFyYW1ldGVyc19fIikKICAgIH0KCiAgICBjbHVzdGVyaW5nX2t3YXJncyA9IHsKICAgICAgICBrLnNwbGl0KCJjbHVzdGVyaW5nX18iKVsxXTogdgogICAgICAgIGZvciBrLCB2IGluIGt3YXJncy5pdGVtcygpCiAgICAgICAgaWYgay5zdGFydHN3aXRoKCJjbHVzdGVyaW5nX18iKQogICAgfQogICAgY2x1c3RlcmluZ19wYXJhbWV0ZXJzX2t3YXJncyA9IHsKICAgICAgICBrLnNwbGl0KCJjbHVzdGVyaW5nX19wYXJhbWV0ZXJzX18iKVsxXTogdgogICAgICAgIGZvciBrLCB2IGluIGt3YXJncy5pdGVtcygpCiAgICAgICAgaWYgay5zdGFydHN3aXRoKCJjbHVzdGVyaW5nX19wYXJhbWV0ZXJzX18iKQogICAgfQoKICAgIG1zZGRfbW9kZWxfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoIm1zZGRfbW9kZWxfXyIpWzFdOiB2CiAgICAgICAgZm9yIGssIHYgaW4ga3dhcmdzLml0ZW1zKCkKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoIm1zZGRfbW9kZWxfXyIpCiAgICB9CiAgICBtc2RkX3BhcmFtZXRlcnNfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoIm1zZGRfbW9kZWxfX3BhcmFtZXRlcnNfXyIpWzFdOiB2CiAgICAgICAgZm9yIGssIHYgaW4ga3dhcmdzLml0ZW1zKCkKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoIm1zZGRfbW9kZWxfX3BhcmFtZXRlcnNfXyIpCiAgICB9CgogICAgIyBDb25zdHJ1Y3RpbmcgdGhlIG5lc3RlZCBwYXJhbWV0ZXIgY29uZmlncwogICAgdmFkX3BhcmFtZXRlcnMgPSBWQURQYXJhbWV0ZXJzKCoqdmFkX3BhcmFtZXRlcnNfa3dhcmdzKQogICAgc3BlYWtlcl9wYXJhbWV0ZXJzID0gU3BlYWtlckVtYmVkZGluZ3NQYXJhbWV0ZXJzKCoqc3BlYWtlcl9wYXJhbWV0ZXJzX2t3YXJncykKICAgIGNsdXN0ZXJpbmdfcGFyYW1ldGVycyA9IENsdXN0ZXJpbmdQYXJhbWV0ZXJzKCoqY2x1c3RlcmluZ19wYXJhbWV0ZXJzX2t3YXJncykKICAgIG1zZGRfcGFyYW1ldGVycyA9IE1TRERQYXJhbWV0ZXJzKCoqbXNkZF9wYXJhbWV0ZXJzX2t3YXJncykKCiAgICAjIENvbnN0cnVjdGluZyB0aGUgY29uZmlncyB1c2luZyB0aGUgbmVzdGVkIHBhcmFtZXRlciBjb25maWdzCiAgICB2YWRfY29uZmlnID0gVkFEQ29uZmlnKHBhcmFtZXRlcnM9dmFkX3BhcmFtZXRlcnMsICoqdmFkX2t3YXJncykKICAgIHNwZWFrZXJfZW1iZWRkaW5nc19jb25maWcgPSBTcGVha2VyRW1iZWRkaW5nc0NvbmZpZygKICAgICAgICBwYXJhbWV0ZXJzPXNwZWFrZXJfcGFyYW1ldGVycywgKipzcGVha2VyX2VtYmVkZGluZ3Nfa3dhcmdzCiAgICApCiAgICBjbHVzdGVyaW5nX2NvbmZpZyA9IENsdXN0ZXJpbmdDb25maWcoCiAgICAgICAgcGFyYW1ldGVycz1jbHVzdGVyaW5nX3BhcmFtZXRlcnMsICoqY2x1c3RlcmluZ19rd2FyZ3MKICAgICkKICAgIG1zZGRfY29uZmlnID0gTVNERENvbmZpZyhwYXJhbWV0ZXJzPW1zZGRfcGFyYW1ldGVycywgKiptc2RkX21vZGVsX2t3YXJncykKCiAgICAjIENvbnN0cnVjdGluZyB0aGUgbWFpbiBEaWFyaXphdGlvbkNvbmZpZwogICAgZGlhcml6YXRpb25fY29uZmlnID0gRGlhcml6YXRpb25Db25maWcoCiAgICAgICAgbWFuaWZlc3RfZmlsZXBhdGg9bWFuaWZlc3RfZmlsZXBhdGgsCiAgICAgICAgb3V0X2Rpcj1rd2FyZ3MuZ2V0KCJvdXRfZGlyIiwgIiIpIG9yIG91dF9kaXIsCiAgICAgICAgb3JhY2xlX3ZhZD1rd2FyZ3MuZ2V0KCJvcmFjbGVfdmFkIiwgRmFsc2UpLAogICAgICAgIGNvbGxhcj1rd2FyZ3MuZ2V0KCJjb2xsYXIiLCAwLjI1KSwKICAgICAgICBpZ25vcmVfb3ZlcmxhcD1rd2FyZ3MuZ2V0KCJpZ25vcmVfb3ZlcmxhcCIsIFRydWUpLAogICAgICAgIHZhZD12YWRfY29uZmlnLAogICAgICAgIHNwZWFrZXJfZW1iZWRkaW5ncz1zcGVha2VyX2VtYmVkZGluZ3NfY29uZmlnLAogICAgICAgIGNsdXN0ZXJpbmc9Y2x1c3RlcmluZ19jb25maWcsCiAgICAgICAgbXNkZF9tb2RlbD1tc2RkX2NvbmZpZywKICAgICkKCiAgICBkaWFyaXphdGlvbl9jb25maWdfZGljdCA9IHsiZGlhcml6ZXIiOiBhc2RpY3QoZGlhcml6YXRpb25fY29uZmlnKX0KICAgIGRpYXJpemF0aW9uX2NvbmZpZ19kaWN0LnVwZGF0ZShhc2RpY3QoZ2VuZXJhbF9jb25maWcpKQogICAgb21lZ2FfY29uZmlnID0gT21lZ2FDb25mLmNyZWF0ZShkaWFyaXphdGlvbl9jb25maWdfZGljdCkKCiAgICByZXR1cm4gQ2x1c3RlcmluZ0RpYXJpemVyKG9tZWdhX2NvbmZpZykKCgojIEhlbHBlciBmdW5jdGlvbiB0byBjb252ZXJ0IHRoZSBhdWRpbyBmaWxlIHRvIDE2ayBzaW5nbGUgY2hhbm5lbCB3YXYgZmlsZQpkZWYgX2NvbnZlcnRfdG9fc3VwcG9ydF9mb3JtYXQoYXVkaW9fZmlsZV9wYXRoOiBzdHIpIC0+IHN0cjoKICAgICIiIgogICAgQ29udmVydHMgdGhlIGF1ZGlvIGZpbGUgdG8gd2F2IGZvcm1hdC4gQ2x1c3RlcmluZ0RpYXJpemVyIGV4cGVjdHMgc2lnbmxlIGNoYW5uZWwgMTZrIHdhdiBmaWxlLgoKICAgIDpwYXJhbSBhdWRpb19maWxlX3BhdGg6ICAgUGF0aCB0byB0aGUgYXVkaW8gZmlsZQoKICAgIDpyZXR1cm5zIGF1ZGlvX2ZpbGVfcGF0aDogUGF0aCB0byB0aGUgY29udmVydGVkIGF1ZGlvIGZpbGUKICAgICIiIgogICAgYXVkaW9fZmlsZV9vYmogPSBwYXRobGliLlBhdGgoYXVkaW9fZmlsZV9wYXRoKQogICAgcmVhZF9mdW5jX2RpY3QgPSB7CiAgICAgICAgIi5tcDMiOiBweWR1Yi5BdWRpb1NlZ21lbnQuZnJvbV9tcDMsCiAgICAgICAgIi5mbHYiOiBweWR1Yi5BdWRpb1NlZ21lbnQuZnJvbV9mbHYsCiAgICAgICAgIi5tcDQiOiBwYXJ0aWFsKHB5ZHViLkF1ZGlvU2VnbWVudC5mcm9tX2ZpbGUsIGZvcm1hdD0ibXA0IiksCiAgICAgICAgIi53bWEiOiBwYXJ0aWFsKHB5ZHViLkF1ZGlvU2VnbWVudC5mcm9tX2ZpbGUsIGZvcm1hdD0id21hIiksCiAgICB9CiAgICAjIENoZWNrIGlmIHRoZSBmaWxlIGlzIGFscmVhZHkgaW4gc3VwcG9ydGVkIGZvcm1hdAogICAgaWYgYXVkaW9fZmlsZV9vYmouc3VmZml4ID09ICIud2F2IjoKICAgICAgICBhdWRpbyA9IHB5ZHViLkF1ZGlvU2VnbWVudC5mcm9tX3dhdihhdWRpb19maWxlX3BhdGgsIGZvcm1hdD0id2F2IikKICAgICAgICBpZiBhdWRpby5jaGFubmVscyAhPSAxOgogICAgICAgICAgICBhdWRpbyA9IGF1ZGlvLnNldF9jaGFubmVscygxKQogICAgICAgIGlmIGF1ZGlvLmZyYW1lX3JhdGUgIT0gMTYwMDA6CiAgICAgICAgICAgIGF1ZGlvID0gYXVkaW8uc2V0X2ZyYW1lX3JhdGUoMTYwMDApCiAgICAgICAgYXVkaW8uZXhwb3J0KGF1ZGlvX2ZpbGVfcGF0aCwgZm9ybWF0PSJ3YXYiKQogICAgICAgIHJldHVybiBhdWRpb19maWxlX3BhdGgKICAgIGVsc2U6CiAgICAgICAgd2F2X2ZpbGUgPSB0ZW1wZmlsZS5ta3N0ZW1wKHByZWZpeD0iY29udmVydGVkX2F1ZGlvXyIsIHN1ZmZpeD0iLndhdiIpCiAgICAgICAgaWYgYXVkaW9fZmlsZV9vYmouc3VmZml4IGluIHJlYWRfZnVuY19kaWN0LmtleXMoKToKICAgICAgICAgICAgYXVkaW8gPSByZWFkX2Z1bmNfZGljdFthdWRpb19maWxlX29iai5zdWZmaXhdKGF1ZGlvX2ZpbGVfcGF0aCkKICAgICAgICAgICAgaWYgYXVkaW8uY2hhbm5lbHMgIT0gMToKICAgICAgICAgICAgICAgIGF1ZGlvID0gYXVkaW8uc2V0X2NoYW5uZWxzKDEpCiAgICAgICAgICAgIGlmIGF1ZGlvLmZyYW1lX3JhdGUgIT0gMTYwMDA6CiAgICAgICAgICAgICAgICBhdWRpbyA9IGF1ZGlvLnNldF9mcmFtZV9yYXRlKDE2MDAwKQogICAgICAgICAgICBhdWRpby5leHBvcnQod2F2X2ZpbGVbMV0sIGZvcm1hdD0id2F2IikKICAgICAgICAgICAgcmV0dXJuIHdhdl9maWxlWzFdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIlVuc3VwcG9ydGVkIGF1ZGlvIGZvcm1hdCB7YXVkaW9fZmlsZV9vYmouc3VmZml4fSIpCgoKZGVmIF9kaWFyaXplX3NpbmdsZV9hdWRpbygKICAgIGF1ZGlvX2ZpbGVfcGF0aDogc3RyLAogICAgb3V0cHV0X2Rpcjogc3RyLAogICAgbnVtX3NwZWFrZXJzOiBpbnQgPSAyLAogICAgdmFkX21vZGVsOiBzdHIgPSAidmFkX211bHRpbGluZ3VhbF9tYXJibGVuZXQiLAogICAgc3BlYWtlcl9lbWJlZGRpbmdzX21vZGVsOiBzdHIgPSAidGl0YW5ldF9sYXJnZSIsCiAgICBtc2RkX21vZGVsOiBzdHIgPSAiZGlhcl9tc2RkX3RlbGVwaG9uaWMiLAogICAgZGV2aWNlOiBPcHRpb25hbFsKICAgICAgICBzdHIKICAgIF0gPSBOb25lLCAgIyBTZXQgdG8gJ2N1ZGE6MScsIChkZWZhdWx0IGN1ZGEgaWYgY3VkYSBhdmFpbGFibGUsIGVsc2UgY3B1KQogICAgKiprd2FyZ3MsCikgLT4gVHVwbGVbc3RyLCBzdHJdOgogICAgIiIiCiAgICBEaWFyaXplcyBhIHNpbmdsZSBhdWRpbyBmaWxlIGFuZCByZXR1cm5zIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzLgoKICAgIDpwYXJhbSBhdWRpb19maWxlX3BhdGg6ICAgICAgICAgIFBhdGggdG8gdGhlIGF1ZGlvIGZpbGUKICAgIDpwYXJhbSBvdXRwdXRfZGlyOiAgICAgICAgICAgICAgIFBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkKICAgIDpwYXJhbSBudW1fc3BlYWtlcnM6ICAgICAgICAgICAgIE51bWJlciBvZiBzcGVha2VycyBpbiB0aGUgYXVkaW8gZmlsZQogICAgOnBhcmFtIHZhZF9tb2RlbDogICAgICAgICAgICAgICAgTmFtZSBvZiB0aGUgVkFEIG1vZGVsIHRvIHVzZQogICAgOnBhcmFtIHNwZWFrZXJfZW1iZWRkaW5nc19tb2RlbDogTmFtZSBvZiB0aGUgc3BlYWtlciBlbWJlZGRpbmdzIG1vZGVsIHRvIHVzZQogICAgOnBhcmFtIG1zZGRfbW9kZWw6ICAgICAgICAgICAgICAgTmFtZSBvZiB0aGUgbXNkZCBtb2RlbCB0byB1c2UKICAgIDpwYXJhbSBkZXZpY2U6ICAgICAgICAgICAgICAgICAgIERldmljZSB0byB1c2UgZm9yIGRpYXJpemF0aW9uCiAgICA6cGFyYW0ga3dhcmdzOiAgICAgICAgICAgICAgICAgICBBZGRpdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBkaWFyaXplciBmb2xsb3dpbmcgdGhlIGZvcm1hdCA8Y29uZmlnX25hbWU+X188cGFyYW1ldGVyX25hbWU+X188YXR0cmlidXRlX25hbWU+LgoKICAgIDpyZXR1cm5zOiBUdXBsZSBvZiB0d28gcGF0aHM6CiAgICAgICAgICAgICAqIHBhdGggb2YgdGhlIHJlc3VsdCBvZiB0aGUgcGlwZWxpbmUKICAgICAgICAgICAgICogcGF0aCBvZiB0aGUgY29udmVydGVkIGF1ZGlvIGZpbGUKCiAgICAiIiIKICAgICMgQ29udmVydCB0aGUgYXVkaW8gZmlsZSB0byBzdXBwb3J0ZWQgZm9ybWF0CiAgICBhdWRpb19maWxlX3BhdGggPSBfY29udmVydF90b19zdXBwb3J0X2Zvcm1hdChhdWRpb19maWxlX3BhdGgpCgogICAgIyBDcmVhdGUgdGVtcG9yYXJ5IG1hbmlmZXN0IGZpbGUKICAgIHdpdGggdGVtcGZpbGUuTmFtZWRUZW1wb3JhcnlGaWxlKHN1ZmZpeD0iLmpzb24iLCBtb2RlPSJ3IikgYXMgdGVtcF9tYW5pZmVzdDoKICAgICAgICBtYW5pZmVzdF9kYXRhID0gewogICAgICAgICAgICAiYXVkaW9fZmlsZXBhdGgiOiBhdWRpb19maWxlX3BhdGgsCiAgICAgICAgICAgICJvZmZzZXQiOiAwLAogICAgICAgICAgICAiZHVyYXRpb24iOiBOb25lLAogICAgICAgICAgICAibGFiZWwiOiAiaW5mZXIiLAogICAgICAgICAgICAidGV4dCI6ICItIiwKICAgICAgICAgICAgIm51bV9zcGVha2VycyI6IG51bV9zcGVha2VycywKICAgICAgICAgICAgInVlbV9maWxlcGF0aCI6IE5vbmUsCiAgICAgICAgfQogICAgICAgIGpzb24uZHVtcChtYW5pZmVzdF9kYXRhLCB0ZW1wX21hbmlmZXN0KQogICAgICAgIHRlbXBfbWFuaWZlc3RfcGF0aCA9IHRlbXBfbWFuaWZlc3QubmFtZQoKICAgICAgICAjIENhbGwgdGhlIF9nZXRfY2x1c3RlcmluZ19kaWFyaXplciBmdW5jdGlvbgogICAgICAgIGRpYXJpemVyID0gX2dldF9jbHVzdGVyaW5nX2RpYXJpemVyKAogICAgICAgICAgICBtYW5pZmVzdF9maWxlcGF0aD10ZW1wX21hbmlmZXN0X3BhdGgsCiAgICAgICAgICAgIG91dF9kaXI9b3V0cHV0X2RpciwKICAgICAgICAgICAgdmFkX21vZGVsX3BhdGg9dmFkX21vZGVsLAogICAgICAgICAgICBzcGVha2VyX2VtYmVkZGluZ3NfbW9kZWxfcGF0aD1zcGVha2VyX2VtYmVkZGluZ3NfbW9kZWwsCiAgICAgICAgICAgIG1zZGRfbW9kZWxfcGF0aD1tc2RkX21vZGVsLAogICAgICAgICAgICBhdWRpb19maWxlcGF0aD1hdWRpb19maWxlX3BhdGgsCiAgICAgICAgICAgIGRldmljZT1kZXZpY2UsCiAgICAgICAgICAgICoqa3dhcmdzLAogICAgICAgICkKCiAgICAgICAgIyBEaWFyaXplIHRoZSBhdWRpbyBmaWxlCiAgICAgICAgZGlhcml6ZXIuZGlhcml6ZSgpCiAgICByZXR1cm4gb3V0cHV0X2RpciwgYXVkaW9fZmlsZV9wYXRoCgoKZGVmIF9jb252ZXJ0X3J0dG1fdG9fYW5ub3RhdGlvbl9kZihvdXRwdXRfZGlyOiBzdHIpIC0+IFR1cGxlW3BkLkRhdGFGcmFtZSwgQW5ub3RhdGlvbl06CiAgICAiIiIKICAgIENvbnZlcnRzIHRoZSBydHRtIGZpbGUgdG8gYSBweWFubm90ZS5Bbm5vdGF0aW9uIGFuZCBhIHBhbmRhcyBkYXRhZnJhbWUuCgogICAgOnBhcmFtIG91dHB1dF9kaXI6ICAgUGF0aCB0byB0aGUgb3V0cHV0IGRpcmVjdG9yeQoKICAgIDpyZXR1cm5zOiBUdXBsZSBvZiBwYW5kcyBkYXRhZnJhbWUgYW5kIHB5YW5ub3RlLkFubm90YXRpb24gb2JqZWN0OgogICAgICAgICAgICAgICogcGFuZGFzIGRhdGFmcmFtZSBjb250YWluaW5nIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzCiAgICAgICAgICAgICAgKiBweWFubm90ZS5Bbm5vdGF0aW9uIGNvbnRhaW5pbmcgdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMKICAgICIiIgogICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsob3V0cHV0X2Rpcik6CiAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgIGlmIGZpbGUuZW5kc3dpdGgoIi5ydHRtIik6CiAgICAgICAgICAgICAgICBydHRtX2ZpbGUgPSBvcy5wYXRoLmpvaW4ocm9vdCwgZmlsZSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICBwcmVkX2xhYmVscyA9IHJ0dG1fdG9fbGFiZWxzKHJ0dG1fZmlsZSkKICAgIGFubm90YXRpb24gPSBsYWJlbHNfdG9fcHlhbm5vdGVfb2JqZWN0KHByZWRfbGFiZWxzKQogICAgbHN0ID0gW2l0ZW0uc3BsaXQoIiAiKSBmb3IgaXRlbSBpbiBwcmVkX2xhYmVsc10KICAgIGxzdCA9IFtpdGVtIGZvciBpdGVtIGluIGxzdCBpZiBpdGVtXQogICAgZGYgPSBwZC5EYXRhRnJhbWUobHN0LCBjb2x1bW5zPVsic3RhcnQiLCAiZW5kIiwgInNwZWFrZXIiXSkKICAgIHJldHVybiBkZiwgYW5ub3RhdGlvbgoKCmRlZiBkaWFyaXplKAogICAgY29udGV4dDogbWxydW4uTUxDbGllbnRDdHgsCiAgICBpbnB1dF9wYXRoOiBzdHIsCiAgICBvdXRwdXRfZGlyZWN0b3J5OiBzdHIsCiAgICBjb25kaXRpb25fc2hvd19wbG90OiBib29sID0gRmFsc2UsCiAgICBudW1fc3BlYWtlcnM6IGludCA9IDIsCiAgICB2YWRfbW9kZWw6IHN0ciA9ICJ2YWRfbXVsdGlsaW5ndWFsX21hcmJsZW5ldCIsCiAgICBzcGVha2VyX2VtYmVkZGluZ3NfbW9kZWw6IHN0ciA9ICJ0aXRhbmV0X2xhcmdlIiwKICAgIG1zZGRfbW9kZWw6IHN0ciA9ICJkaWFyX21zZGRfdGVsZXBob25pYyIsCiAgICBkZXZpY2U6IE9wdGlvbmFsWwogICAgICAgIHN0cgogICAgXSA9IE5vbmUsICAjIFNldCB0byAnY3VkYToxJywgKGRlZmF1bHQgY3VkYSBpZiBjdWRhIGF2YWlsYWJsZSwgZWxzZSBjcHUpCiAgICAqKmt3YXJncywKKSAtPiBUdXBsZVtwYXRobGliLlBhdGgsIHBkLkRhdGFGcmFtZSwgZGljdF06CiAgICAiIiIKICAgIERpYXJpemUgYXVkaW8gZmlsZXMgaW50byBzcGVha2VyIHNlZ21lbnRzCiAgICBUaGUgZmluYWwgcmVzdWx0IGlzIGEgZGlyZWN0b3J5IGNvbnRhaW5pbmcgdGhlIE5lbW8gZGlhcml6YXRpb24gcmVzdWx0cywgYSBkYXRhZnJhbWUgdGhhdCBoYXMgdGhlIG1hcHBpbmcgd2l0aCB0aGUgYXVkaW8gZmlsZSB0byB0aGUgcmVzdWx0CiAgICBhbmQgYSBwbG90IG9mIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzIGlmIGNvbmRpdGlvbl9zaG93X3Bsb3QgaXMgc2V0IHRvIFRydWUuIFRoZSBkYXRhZnJhbWUgKGNzdikgd2lsbCBoYXZlIHRoZSBmb2xsb3dpbmcgY29sdW1uczoKCiAgICAqIHN0YXJ0OiBTdGFydCB0aW1lIG9mIHRoZSBzcGVha2VyIHNlZ21lbnQKICAgICogZW5kOiBFbmQgdGltZSBvZiB0aGUgc3BlYWtlciBzZWdtZW50CiAgICAqIHNwZWFrZXI6IFNwZWFrZXIgbGFiZWwKCiAgICBUaGUgcGFuZGFzIGRhdGFmcmFtZSB3aWxsIGhhdmUgdGhlIGZvbGxvd2luZyBmb3JtYXQ6CgogICAgKiBvcmlnaW5hbF9hdWRpb19maWxlOiBQYXRoIHRvIHRoZSBvcmlnaW5hbCBhdWRpbyBmaWxlCiAgICAqIHJlc3VsdCBvZiBtb2RlbDogZGlyZWN0b3J5IG9mIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzCiAgICAqIGNvbnZlcnRlZF9hdWRpb19maWxlOiBQYXRoIHRvIHRoZSBjb252ZXJ0ZWQgYXVkaW8gZmlsZQogICAgKiBzcGVha2VyX3NlZ21lbnRzOiBQYXRoIHRvIHRoZSBkYXRhaXRlbSB0aGF0IGhhcyB0aGUgc3BlYWtlciBsYWJlbHMsIHN0YXJ0LCBlbmQKCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgICAgICBNTFJ1biBjb250ZXh0CiAgICA6cGFyYW0gaW5wdXRfcGF0aDogICAgICAgICAgICAgICBBIGRpcmVjdG9yeSBvZiB0aGUgYXVkaW8gZmlsZXMgb3IgYSBzaW5nbGUgZmlsZSB0byBkaWFyaXplCiAgICA6cGFyYW0gb3V0cHV0X2RpcmVjdG9yeTogICAgICAgICBQYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5IHRoaXMgaXMgd2hlcmUgbmVtbyB3aWxsIHN0b3JlIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzCiAgICA6cGFyYW0gY29uZGl0aW9uX3Nob3dfcGxvdDogICAgICBJZiBzZXQgdG8gVHJ1ZSwgdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMgd2lsbCBiZSBwbG90dGVkCiAgICA6cGFyYW0gbnVtX3NwZWFrZXJzOiAgICAgICAgICAgICBOdW1iZXIgb2Ygc3BlYWtlcnMgaW4gdGhlIGF1ZGlvIGZpbGUKICAgIDpwYXJhbSB2YWRfbW9kZWw6ICAgICAgICAgICAgICAgIE5hbWUgb2YgdGhlIFZBRCBtb2RlbCB0byB1c2UKICAgIDpwYXJhbSBzcGVha2VyX2VtYmVkZGluZ3NfbW9kZWw6IE5hbWUgb2YgdGhlIHNwZWFrZXIgZW1iZWRkaW5ncyBtb2RlbCB0byB1c2UKICAgIDpwYXJhbSBtc2RkX21vZGVsOiAgICAgICAgICAgICAgIE5hbWUgb2YgdGhlIG1zZGQgbW9kZWwgdG8gdXNlCiAgICA6cGFyYW0gZGV2aWNlOiAgICAgICAgICAgICAgICAgICBEZXZpY2UgdG8gdXNlIGZvciBkaWFyaXphdGlvbiAoZGVmYXVsdCBjdWRhIGlmIGN1ZGEgYXZhaWxhYmxlLCBlbHNlIGNwdSkKICAgIDpwYXJhbSBrd2FyZ3M6ICAgICAgICAgICAgICAgICAgIEFkZGl0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIGRpYXJpemVyIGZvbGxvd2luZyB0aGUgZm9ybWF0IDxjb25maWdfbmFtZT5fXzxwYXJhbWV0ZXJfbmFtZT5fXzxhdHRyaWJ1dGVfbmFtZT4uCgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CiAgICAgICAgICAgICAgKiBQYXRoIHRvIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzCiAgICAgICAgICAgICAgKiBQYW5kYXMgZGF0YWZyYW1lIHRoYXQgaGF2ZSB0aGUgbWFwcGluZyBiZXR3ZWVuIGF1ZGlvX2ZpbGUsIGNvbnZlcnRlZF9hdWRpb19maWxlLCBkaXJhcml6YXRpb25fcmVzdWx0LgogICAgICAgICAgICAgICogQSBkaWN0aW9uYXJ5IG9mIGVycm9yZWQgZmlsZXMgdGhhdCB3ZXJlIG5vdCBkaWFyaXplZAogICAgIiIiCiAgICAjIFNldCBvdXRwdXQgZGlyZWN0b3J5OgogICAgaWYgb3V0cHV0X2RpcmVjdG9yeSBpcyBOb25lOgogICAgICAgIG91dHB1dF9kaXJlY3RvcnkgPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKCiAgICAjIFByZXBhcmUgdGhlIGRhdGFmcmFtZSBhbmQgZXJyb3JzIHRvIGJlIHJldHVybmVkOgogICAgZGYgPSBwZC5EYXRhRnJhbWUoCiAgICAgICAgY29sdW1ucz1bCiAgICAgICAgICAgICJhdWRpb19maWxlIiwKICAgICAgICAgICAgImRpYXJpemF0aW9uX3Jlc3VsdHMiLAogICAgICAgICAgICAiY29udmVydGVkX2F1ZGlvX2ZpbGUiLAogICAgICAgICAgICAic3BlYWtlcl9zZWdtZW50cyIsCiAgICAgICAgXQogICAgKQoKICAgIGVycm9ycyA9IHt9CgogICAgIyBDcmVhdGUgdGhlIG91dHB1dCBkaXJlY3Rvcnk6CiAgICBvdXRwdXRfZGlyZWN0b3J5ID0gcGF0aGxpYi5QYXRoKG91dHB1dF9kaXJlY3RvcnkpCiAgICBpZiBub3Qgb3V0cHV0X2RpcmVjdG9yeS5leGlzdHMoKToKICAgICAgICBvdXRwdXRfZGlyZWN0b3J5Lm1rZGlyKCkKCiAgICAjIEdvIG92ZXIgdGhlIGF1ZGlvIGZpbGVzIGFuZCB0cmFuc2NyaWJlOgogICAgYXVkaW9fZmlsZXNfcGF0aCA9IHBhdGhsaWIuUGF0aChpbnB1dF9wYXRoKS5hYnNvbHV0ZSgpCiAgICBpZiBhdWRpb19maWxlc19wYXRoLmlzX2RpcigpOgogICAgICAgIGF1ZGlvX2ZpbGVzID0gbGlzdChhdWRpb19maWxlc19wYXRoLnJnbG9iKCIqLioiKSkKICAgIGVsaWYgYXVkaW9fZmlsZXNfcGF0aC5pc19maWxlKCk6CiAgICAgICAgYXVkaW9fZmlsZXMgPSBbYXVkaW9fZmlsZXNfcGF0aF0KICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgZiJhdWRpb19maWxlcyB7c3RyKGF1ZGlvX2ZpbGVzX3BhdGgpfSBtdXN0IGJlIGVpdGhlciBhIGRpcmVjdG9yeSBwYXRoIG9yIGEgZmlsZSBwYXRoIgogICAgICAgICkKCiAgICBmb3IgaSwgYXVkaW9fZmlsZSBpbiBlbnVtZXJhdGUodHFkbShhdWRpb19maWxlcywgZGVzYz0iRGlhcml6aW5nIiwgdW5pdD0iZmlsZSIpKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG91dHB1dF9kaXIgPSBvdXRwdXRfZGlyZWN0b3J5IC8gZiJ7YXVkaW9fZmlsZS5zdGVtfSIKICAgICAgICAgICAgb3V0cHV0X2RpciwgY29udmVydGVkX2F1ZGlvX2ZpbGVfcGF0aCA9IF9kaWFyaXplX3NpbmdsZV9hdWRpbygKICAgICAgICAgICAgICAgIGF1ZGlvX2ZpbGVfcGF0aD1hdWRpb19maWxlLAogICAgICAgICAgICAgICAgb3V0cHV0X2Rpcj1vdXRwdXRfZGlyLAogICAgICAgICAgICAgICAgbnVtX3NwZWFrZXJzPW51bV9zcGVha2VycywKICAgICAgICAgICAgICAgIHZhZF9tb2RlbD12YWRfbW9kZWwsCiAgICAgICAgICAgICAgICBzcGVha2VyX2VtYmVkZGluZ3NfbW9kZWw9c3BlYWtlcl9lbWJlZGRpbmdzX21vZGVsLAogICAgICAgICAgICAgICAgbXNkZF9tb2RlbD1tc2RkX21vZGVsLAogICAgICAgICAgICAgICAgZGV2aWNlPWRldmljZSwKICAgICAgICAgICAgICAgICoqa3dhcmdzLAogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGNlcHRpb246CiAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgZXhjZXB0aW9uOgogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci53YXJuKGYiRXJyb3IgaW4gZmlsZTogJ3thdWRpb19maWxlfSciKQogICAgICAgICAgICBlcnJvcnNbc3RyKGF1ZGlvX2ZpbGUpXSA9IHN0cihleGNlcHRpb24pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBDb252ZXJ0IHRoZSBydHRtIGZpbGUgdG8gYSBwYW5kYXMgZGF0YWZyYW1lIGFuZCBhIHB5YW5ub3RlLkFubm90YXRpb246CiAgICAgICAgICAgIHNpbmdsZV9kZiwgYW5ub3RhdGlvbiA9IF9jb252ZXJ0X3J0dG1fdG9fYW5ub3RhdGlvbl9kZihvdXRwdXRfZGlyKQoKICAgICAgICAgICAgY29udGV4dC5sb2dfZGF0YXNldCgKICAgICAgICAgICAgICAgIGYie2F1ZGlvX2ZpbGUuc3RlbX0iLAogICAgICAgICAgICAgICAgZGY9c2luZ2xlX2RmLAogICAgICAgICAgICAgICAgaW5kZXg9RmFsc2UsCiAgICAgICAgICAgICAgICBmb3JtYXQ9ImNzdiIsCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgY29uZGl0aW9uX3Nob3dfcGxvdDoKICAgICAgICAgICAgICAgIG5vdGVib29rLnBsb3RfYW5ub3RhdGlvbihhbm5vdGF0aW9uKQoKICAgICAgICAgICAgIyBOb3RlIGluIHRoZSBkYXRhZnJhbWU6CiAgICAgICAgICAgIGRmLmxvY1tpIC0gbGVuKGVycm9ycyldID0gWwogICAgICAgICAgICAgICAgc3RyKGF1ZGlvX2ZpbGUpLAogICAgICAgICAgICAgICAgc3RyKG91dHB1dF9kaXIpLAogICAgICAgICAgICAgICAgY29udmVydGVkX2F1ZGlvX2ZpbGVfcGF0aCwKICAgICAgICAgICAgICAgIGNvbnRleHQuZ2V0X2RhdGFpdGVtKGYie2F1ZGlvX2ZpbGUuc3RlbX0iKS5wYXRoLAogICAgICAgICAgICBdCgogICAgIyBSZXR1cm4gdGhlIGRhdGFmcmFtZToKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJEb25lOlxue2RmLmhlYWQoKX0iKQoKICAgIHJldHVybiBvdXRwdXRfZGlyZWN0b3J5LCBkZiwgZXJyb3JzCg==
    base_image: mlrun/mlrun
    commands: []
    code_origin: git@github.com:pengwei715/functions.git#d7d1a5e366066d1e982eef8086293780d8da6831:/User/functions/speaker_diarization/speaker_diarization.py
    origin_filename: /User/functions/speaker_diarization/speaker_diarization.py
    requirements:
    - ffmpeg
    - ffprobe
    - tqdm
    - Cython
    - Cmake
    - pyannote.core
    - torch
    - torchaudio
    - pydub
    - nemo_toolkit[all]
  entry_points:
    diarize:
      name: diarize
      doc: 'Diarize audio files into speaker segments

        The final result is a directory containing the Nemo diarization results, a
        dataframe that has the mapping with the audio file to the result

        and a plot of the diarization results if condition_show_plot is set to True.
        The dataframe (csv) will have the following columns:


        * start: Start time of the speaker segment

        * end: End time of the speaker segment

        * speaker: Speaker label


        The pandas dataframe will have the following format:


        * original_audio_file: Path to the original audio file

        * result of model: directory of the diarization results

        * converted_audio_file: Path to the converted audio file

        * speaker_segments: Path to the dataitem that has the speaker labels, start,
        end'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context
        default: ''
      - name: input_path
        type: str
        doc: A directory of the audio files or a single file to diarize
        default: ''
      - name: output_directory
        type: str
        doc: Path to the output directory this is where nemo will store the diarization
          results
        default: ''
      - name: condition_show_plot
        type: bool
        doc: If set to True, the diarization results will be plotted
        default: false
      - name: num_speakers
        type: int
        doc: Number of speakers in the audio file
        default: 2
      - name: vad_model
        type: str
        doc: Name of the VAD model to use
        default: vad_multilingual_marblenet
      - name: speaker_embeddings_model
        type: str
        doc: Name of the speaker embeddings model to use
        default: titanet_large
      - name: msdd_model
        type: str
        doc: Name of the msdd model to use
        default: diar_msdd_telephonic
      - name: device
        type: Optional[str]
        doc: Device to use for diarization (default cuda if cuda available, else cpu)
        default: null
      outputs:
      - default: ''
        doc: 'A tuple of: * Path to the diarization results * Pandas dataframe that
          have the mapping between audio_file, converted_audio_file, dirarization_result.
          * A dictionary of errored files that were not diarized'
      lineno: 453
  description: speaker diarization on the audio file
  default_handler: diarize
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  resources:
    requests:
      memory: 1Mi
      cpu: 25m
    limits:
      memory: 20Gi
      cpu: '2'
  priority_class_name: igz-workload-medium
  preemption_mode: prevent
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: app.iguazio.com/lifecycle
            operator: NotIn
            values:
            - preemptible
          - key: eks.amazonaws.com/capacityType
            operator: NotIn
            values:
            - SPOT
          - key: node-lifecycle
            operator: NotIn
            values:
            - spot
  tolerations: null
  security_context: {}
verbose: false
