kind: job
metadata:
  name: sklearn-classifier
  tag: ''
  hash: 00616eb65c92d476cfdee803e77e9bca732fbfd8
  project: ''
  labels:
    author: yjb
    framework: sklearn
  categories:
  - ml
  - training
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: encode_cols
        type: List[str]
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7fb2279fd190>
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.3
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: cmap
        doc: matplotlib `Colormap`
        default: <_ast.Attribute object at 0x7fb1a016fd50>
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
        default: plots
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
        doc: json model config file
      - name: random_state
        type: int
        default: 1
      outputs: []
      lineno: 33
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgppbXBvcnQganNvbgppbXBvcnQgb3MKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzLCBsb2FkLCBkdW1wCgpmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAoKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IGxhYmVsX2JpbmFyaXplCmZyb20gc2tsZWFybi5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IHRyYWluX3Rlc3Rfc3BsaXQKZnJvbSBza2xlYXJuIGltcG9ydCBtZXRyaWNzCgpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdApmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QKCmZyb20gbWx1dGlscyBpbXBvcnQgKGdldF9zYW1wbGUsCiAgICAgICAgICAgICAgICAgICAgIGdldF9zcGxpdHMsCiAgICAgICAgICAgICAgICAgICAgIGdlbl9za2xlYXJuX21vZGVsLAogICAgICAgICAgICAgICAgICAgICBjcmVhdGVfY2xhc3MsCiAgICAgICAgICAgICAgICAgICAgIGdldF9jbGFzc19maXQsCiAgICAgICAgICAgICAgICAgICAgIGV2YWxfY2xhc3NfbW9kZWwsCiAgICAgICAgICAgICAgICAgICAgIGdjZl9jbGVhcikKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhSXRlbSwKICAgIGxhYmVsX2NvbHVtbjogc3RyID0gImxhYmVscyIsCiAgICBlbmNvZGVfY29sczogTGlzdFtzdHJdID0gW10sCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgdGVzdF9zaXplOiBmbG9hdCA9IDAuMzAsCiAgICB0cmFpbl92YWxfc3BsaXQ6IGZsb2F0ID0gMC43NSwKICAgIHJuZzogaW50ID0gMSwKICAgIG1vZGVsX2ZpbGVuYW1lOiBzdHIgPSAibW9kZWwiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICIiLAogICAgY21hcCA9IHBsdC5jbS5CbHVlcywKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBzY29yZV9tZXRob2Q6IHN0ciA9ICJtaWNybyIsCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLAogICAgcmFuZG9tX3N0YXRlOiBpbnQgPSAxLAopIC0+IE5vbmU6CiAgICAiIiJ0cmFpbiBhIGNsYXNzaWZpZXIuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIG1vZGVsX3BrZ19jbGFzczogICB0aGUgbW9kZWwgdG8gdHJhaW4sIGUuZywgInNrbGVhcm4ubmV1cmFsX25ldHdvcmtzLk1MUENsYXNzaWZpZXIiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3IganNvbiBtb2RlbCBjb25maWcKICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgKCJkYXRhIikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uOiAgICAgIGdyb3VuZC10cnV0aCAoeSkgbGFiZWxzCiAgICA6cGFyYW0gZW5jb2RlX2NvbHM6ICAgICAgIGRpY3Rpb25hcnkgb2YgbmFtZXMgYW5kIHByZWZpeGVzIGZvciBjb2x1bW5zIHRoYXQgYXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGhvdCBiZSBlbmNvZGVkLgogICAgOnBhcmFtIHNhbXBsZTogICAgICAgICAgICBTZWxlY3RzIHRoZSBmaXJzdCBuIHJvd3MsIG9yIHNlbGVjdCBhIHNhbXBsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydGluZyBmcm9tIHRoZSBmaXJzdC4gSWYgbmVnYXRpdmUgPC0xLCBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYSByYW5kb20gc2FtcGxlCiAgICA6cGFyYW0gbW9kZWxfZmlsZW5hbWU6ICAgIG1vZGVsIGZpbGUgZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cyB0byBhIGRpcmVjdG9yeQogICAgOnBhcmFtIHRlc3Rfc2l6ZTogICAgICAgICAoMC4wNSkgdGVzdCBzZXQgc2l6ZQogICAgOnBhcmFtIHRyYWluX3ZhbF9zcGxpdDogICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHJuZzogICAgICAgICAgICAgICAoMSkgc2tsZWFybiBybmcgc2VlZAogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICBtb2RlbHMgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBjbWFwOiAgICAgICAgICAgICAgbWF0cGxvdGxpYiBgQ29sb3JtYXBgCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgIHBsb3Qgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgICAgZm9yIG11bHRpY2xhc3MgY2xhc3NpZmljYXRpb24KICAgIAogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICA6cGFyYW0gbW9kZWxfcGtnX2ZpbGU6ICAgIGpzb24gbW9kZWwgY29uZmlnIGZpbGUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAiIiIKICAgIG1vZGVsc19kZXN0ID0gbW9kZWxzX2Rlc3Qgb3IgIm1vZGVscyIKICAgIHBsb3RzX2Rlc3QgPSBwbG90c19kZXN0IG9yIGYicGxvdHMve2NvbnRleHQubmFtZX0iCiAgICAKICAgIHJhdywgbGFiZWxzLCBoZWFkZXIgPSBnZXRfc2FtcGxlKGRhdGFzZXQsIHNhbXBsZSwgbGFiZWxfY29sdW1uKQogICAgCiAgICBpZiBlbmNvZGVfY29sczoKICAgICAgICByYXcgPSBwZC5nZXRfZHVtbWllcyhyYXcsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnM9bGlzdChlbmNvZGVfY29scy5rZXlzKCkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg9bGlzdChlbmNvZGVfY29scy52YWx1ZXMoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyb3BfZmlyc3Q9VHJ1ZSkKICAgIAogICAgKHh0cmFpbiwgeXRyYWluKSwgKHh2YWxpZCwgeXZhbGlkKSwgKHh0ZXN0LCB5dGVzdCkgPSAgICAgICAgIGdldF9zcGxpdHMocmF3LCBsYWJlbHMsIDMsIHRlc3Rfc2l6ZSwgMS10cmFpbl92YWxfc3BsaXQsIHJhbmRvbV9zdGF0ZSkKICAgIAogICAgdGVzdF9zZXQgPSBwZC5jb25jYXQoW3h0ZXN0LCB5dGVzdC50b19mcmFtZSgpXSwgYXhpcz0xKQogICAgY29udGV4dC5sb2dfZGF0YXNldCgndGVzdF9zZXQnLCBkZj10ZXN0X3NldCwgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKCiAgICBpZiBtb2RlbF9wa2dfZmlsZToKICAgICAgICBtb2RlbF9jb25maWcgPSBqc29uLmxvYWQob3Blbihtb2RlbF9wa2dfZmlsZSwgInIiKSkKICAgIGVsaWYgbW9kZWxfcGtnX2NsYXNzOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGdldF9jbGFzc19maXQobW9kZWxfcGtnX2NsYXNzKQogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdtb2RlbF9wa2dfZmlsZSBvciBtb2RlbF9wa2dfY2xhc3MgbXVzdCBiZSBwcm92aWRlZCcpCiAgICAKICAgIGZvciBrLCB2IGluIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpOgogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnQ0xBU1NfJyk6CiAgICAgICAgICAgIG1vZGVsX2NvbmZpZ1snQ0xBU1MnXVtrWzY6XV0gPSB2CiAgICAgICAgaWYgay5zdGFydHN3aXRoKCdGSVRfJyk6CiAgICAgICAgICAgIG1vZGVsX2NvbmZpZ1snRklUJ11ba1s0Ol1dID0gdgoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0cmFpbiwieSI6IHl0cmFpbi52YWx1ZXN9KQogICAgCiAgICBDbGFzc2lmaWVyQ2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKICAgIG1vZGVsLmZpdCgqKm1vZGVsX2NvbmZpZ1siRklUIl0pCiAgICAKICAgIGV2YWxfbWV0cmljcyA9IGV2YWxfY2xhc3NfbW9kZWwoY29udGV4dCwgeHZhbGlkLCB5dmFsaWQsIG1vZGVsKQoKICAgIG1vZGVsX3Bsb3RzID0gZXZhbF9tZXRyaWNzLnBvcCgicGxvdHMiKQogICAgbW9kZWxfdGFibGVzID0gZXZhbF9tZXRyaWNzLnBvcCgidGFibGVzIikKICAgIGZvciBwbG90IGluIG1vZGVsX3Bsb3RzOgogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KHBsb3QsIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0ve3Bsb3Qua2V5fS5odG1sIikKICAgIGZvciB0YmwgaW4gbW9kZWxfdGFibGVzOgogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KHRibCwgbG9jYWxfcGF0aD1mIntwbG90c19kZXN0fS97cGxvdC5rZXl9LmNzdiIpCgogICAgbW9kZWxfYmluID0gZHVtcHMobW9kZWwpICMgLmdldF9ib29zdGVyKCkpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgibW9kZWwiLCBib2R5PW1vZGVsX2JpbiwKICAgICAgICAgICAgICAgICAgICAgIGFydGlmYWN0X3BhdGg9b3MucGF0aC5qb2luKGNvbnRleHQuYXJ0aWZhY3RfcGF0aCwgbW9kZWxzX2Rlc3QpLAogICAgICAgICAgICAgICAgICAgICAgbW9kZWxfZmlsZT0ibW9kZWwucGtsIiwKICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3M9ZXZhbF9tZXRyaWNzKQoKICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoZXZhbF9tZXRyaWNzKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#7184f1a0b94e16ddeba36df8930425f0d99c4a03:sklearn_classifier.ipynb
