kind: job
metadata:
  name: xgb-trainer
  tag: ''
  hash: 7ffd772398fdde37506d4ac16d760ddb54776549
  project: ''
  labels:
    author: yjb
    framework: xgboost
  categories:
  - training
  - ml
  - experimental
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.8
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train an xgboost model.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_type
        type: str
        doc: the model type to train, "classifier", "regressor"...
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: encode_cols
        type: dict
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
      - name: enc_drop_first
        type: bool
        doc: (True) whether to drop the first column of hot encoded  variables (avoid
          column exact dependencies)
        default: true
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f95542e3940>
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.25
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: destination subfolder for model artifacts
        default: models
      - name: plots_dest
        type: str
        doc: destination subfolder for plot artifacts
        default: plots
      - name: eval_metrics
        type: list
        doc: (["error", "auc"]) learning curve metrics
        default:
        - error
        - auc
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
      outputs: []
      lineno: 59
  description: train multiple model types using xgboost
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA1LTEzIDIwOjM0CgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmZyb20gbWxydW4ubWx1dGlscyBpbXBvcnQgKGdldF9zYW1wbGUsCiAgICAgICAgICAgICAgICAgICAgIGdldF9zcGxpdHMsCiAgICAgICAgICAgICAgICAgICAgIGdlbl9za2xlYXJuX21vZGVsLAogICAgICAgICAgICAgICAgICAgICBjcmVhdGVfY2xhc3MsIAogICAgICAgICAgICAgICAgICAgICBldmFsX2NsYXNzX21vZGVsLAogICAgICAgICAgICAgICAgICAgICBnY2ZfY2xlYXIpCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QsIFRhYmxlQXJ0aWZhY3QKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG9zCgpkZWYgX2dlbl94Z2JfbW9kZWwobW9kZWxfdHlwZTogc3RyLCB4Z2JfcGFyYW1zOiBkaWN0KToKICAgICIiImdlbmVyYXRlIGFuIHhnYm9vc3QgbW9kZWwKICAgIAogICAgTXVsdGlwbGUgbW9kZWwgdHlwZXMgdGhhdCBjYW4gYmUgZXN0aW1hdGVkIHVzaW5nCiAgICB0aGUgWEdCb29zdCBTY2lraXQtTGVhcm4gQVBJLgogICAgCiAgICBJbnB1dCBjYW4gZWl0aGVyIGJlIGEgcHJlZGVmaW5lZCBqc29uIG1vZGVsIGNvbmZpZ3VyYXRpb24gb3Igb25lCiAgICBvZiB0aGUgZml2ZSB4Z2Jvb3N0IG1vZGVsIHR5cGVzOiAiY2xhc3NpZmllciIsICJyZWdyZXNzb3IiLCAicmFua2VyIiwKICAgICJyZl9jbGFzc2lmaWVyIiwgb3IgInJmX3JlZ3Jlc3NvciIuCiAgICAKICAgIEluIGVpdGhlciBjYXNlIG9uZSBjYW4gcGFzcyBpbiBhIHBhcmFtcyBkaWN0IHRvIG1vZGlmeSBkZWZhdWx0cyB2YWx1ZXMuCiAgICAKICAgIEJhc2VkIG9uIGBtbHJ1bi5tbHV0aWxzLm1vZGVscy5nZW5fc2tsZWFybl9tb2RlbGAsIHNlZSB0aGUgZnVuY3Rpb24KICAgIGBza2xlYXJuX2NsYXNzaWZpZXJgIGluIHRoaXMgcmVwb3NpdG9yeS4KICAgIAogICAgOnBhcmFtIG1vZGVsX3R5cGU6IG9uZSBvZiAiY2xhc3NpZmllciIsICJyZWdyZXNzb3IiLAogICAgICAgICAgICAgICAgICAgICAgICJyYW5rZXIiLCAicmZfY2xhc3NpZmllciIsIG9yCiAgICAgICAgICAgICAgICAgICAgICAicmZfcmVncmVzc29yIgogICAgOnBhcmFtIHhnYl9wYXJhbXM6IGNsYXNzIGluaXQgcGFyYW1ldGVycwogICAgIiIiCiAgICBmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IGdldF9jbGFzc19maXQsIGdlbl9za2xlYXJuX21vZGVsCgogICAgbXR5cGVzID0gewogICAgICAgICJjbGFzc2lmaWVyIiAgIDogInhnYm9vc3QuWEdCQ2xhc3NpZmllciIsCiAgICAgICAgInJlZ3Jlc3NvciIgICAgOiAieGdib29zdC5YR0JSZWdyZXNzb3IiLAogICAgICAgICJyYW5rZXIiICAgICAgIDogInhnYm9vc3QuWEdCUmFua2VyIiwKICAgICAgICAicmZfY2xhc3NpZmllciI6ICJ4Z2Jvb3N0LlhHQlJGQ2xhc3NpZmllciIsCiAgICAgICAgInJmX3JlZ3Jlc3NvciIgOiAieGdib29zdC5YR0JSRlJlZ3Jlc3NvciIKICAgIH0KICAgIGlmIG1vZGVsX3R5cGUuZW5kc3dpdGgoImpzb24iKToKICAgICAgICBtb2RlbF9jb25maWcgPSBtb2RlbF90eXBlCiAgICBlbGlmIG1vZGVsX3R5cGUgaW4gbXR5cGVzLmtleXMoKToKICAgICAgICBtb2RlbF9jb25maWcgPSBtdHlwZXNbbW9kZWxfdHlwZV0KICAgIGVsc2U6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJ1bnJlY29nbml6ZWQgbW9kZWwgdHlwZSwgc2VlIGhlbHAgZG9jdW1lbnRhdGlvbiIpCgogICAgcmV0dXJuIGdlbl9za2xlYXJuX21vZGVsKG1vZGVsX2NvbmZpZywgeGdiX3BhcmFtcykKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfdHlwZTogc3RyLAogICAgZGF0YXNldDogRGF0YUl0ZW0sCiAgICBsYWJlbF9jb2x1bW46IHN0ciA9ICJsYWJlbHMiLAogICAgZW5jb2RlX2NvbHM6IGRpY3QgPSB7fSwKICAgIGVuY19kcm9wX2ZpcnN0OiBib29sID0gVHJ1ZSwKICAgIHNhbXBsZTogaW50ID0gLTEsCiAgICB0ZXN0X3NpemU6IGZsb2F0ID0gMC4yNSwKICAgIHZhbGlkX3NpemU6IGZsb2F0ID0gMC43NSwKICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gMSwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAibW9kZWxzIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBldmFsX21ldHJpY3M6IGxpc3Q9IFsiZXJyb3IiLCAiYXVjIl0sCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLCAgICAKKSAtPiBOb25lOgogICAgIiIidHJhaW4gYW4geGdib29zdCBtb2RlbC4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxfdHlwZTogICAgICAgIHRoZSBtb2RlbCB0eXBlIHRvIHRyYWluLCAiY2xhc3NpZmllciIsICJyZWdyZXNzb3IiLi4uCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICgiZGF0YSIpIG5hbWUgb2YgcmF3IGRhdGEgZmlsZQogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgICBncm91bmQtdHJ1dGggKHkpIGxhYmVscwogICAgOnBhcmFtIGVuY29kZV9jb2xzOiAgICAgICBkaWN0aW9uYXJ5IG9mIG5hbWVzIGFuZCBwcmVmaXhlcyBmb3IgY29sdW1ucyB0aGF0IGFyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBob3QgYmUgZW5jb2RlZC4KICAgIDpwYXJhbSBlbmNfZHJvcF9maXJzdDogICAgKFRydWUpIHdoZXRoZXIgdG8gZHJvcCB0aGUgZmlyc3QgY29sdW1uIG9mIGhvdCBlbmNvZGVkIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZXMgKGF2b2lkIGNvbHVtbiBleGFjdCBkZXBlbmRlbmNpZXMpCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgICAgKDAuMDUpIHRlc3Qgc2V0IHNpemUKICAgIDpwYXJhbSB2YWxpZF9zaXplOiAgICAgICAgKDAuNzUpIE9uY2UgdGhlIHRlc3Qgc2V0IGhhcyBiZWVuIHJlbW92ZWQgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWluaW5nIHNldCBnZXRzIHRoaXMgcHJvcG9ydGlvbi4KICAgIDpwYXJhbSByYW5kb21fc3RhdGU6ICAgICAgKDEpIHNrbGVhcm4gcm5nIHNlZWQKICAgIDpwYXJhbSBtb2RlbHNfZGVzdDogICAgICAgZGVzdGluYXRpb24gc3ViZm9sZGVyIGZvciBtb2RlbCBhcnRpZmFjdHMKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICAgZGVzdGluYXRpb24gc3ViZm9sZGVyIGZvciBwbG90IGFydGlmYWN0cwogICAgOnBhcmFtIGV2YWxfbWV0cmljczogICAgICAoWyJlcnJvciIsICJhdWMiXSkgbGVhcm5pbmcgY3VydmUgbWV0cmljcwogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICAiIiIKICAgIG1vZGVsc19kZXN0ID0gbW9kZWxzX2Rlc3Qgb3IgIm1vZGVscyIKICAgIHBsb3RzX2Rlc3QgPSBwbG90c19kZXN0IG9yIGYicGxvdHMve2NvbnRleHQubmFtZX0iCiAgICAKICAgIHJhdywgbGFiZWxzLCBoZWFkZXIgPSBnZXRfc2FtcGxlKGRhdGFzZXQsIHNhbXBsZSwgbGFiZWxfY29sdW1uKQogICAgCiAgICBpZiBlbmNvZGVfY29sczoKICAgICAgICByYXcgPSBwZC5nZXRfZHVtbWllcyhyYXcsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnM9bGlzdChlbmNvZGVfY29scy5rZXlzKCkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg9bGlzdChlbmNvZGVfY29scy52YWx1ZXMoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyb3BfZmlyc3Q9ZW5jX2Ryb3BfZmlyc3QpCiAgICAKICAgICh4dHJhaW4sIHl0cmFpbiksICh4dmFsaWQsIHl2YWxpZCksICh4dGVzdCwgeXRlc3QpLCBfID0gZ2V0X3NwbGl0cyhyYXcsIGxhYmVscywgMywgdGVzdF9zaXplLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZF9zaXplLCBbImxhYmVscyJdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbV9zdGF0ZSkKICAgIAogICAgCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KCJ0ZXN0LXNldCIsIGRmPXBkLmNvbmNhdChbeHRlc3QsIHl0ZXN0XSwgYXhpcz0xKSwgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKICAgIAogICAgbW9kZWxfY29uZmlnID0gX2dlbl94Z2JfbW9kZWwobW9kZWxfdHlwZSwgY29udGV4dC5wYXJhbWV0ZXJzLml0ZW1zKCkpCiAgICBtb2RlbF9zaG9ydF9uYW1lID0gbW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0uc3BsaXQoIi4iKVstMV0KICAgCiAgICBYR0JCb29zdENsYXNzID0gY3JlYXRlX2NsYXNzKG1vZGVsX2NvbmZpZ1siTUVUQSJdWyJjbGFzcyJdKQogICAgbW9kZWwgPSBYR0JCb29zdENsYXNzKCoqbW9kZWxfY29uZmlnWyJDTEFTUyJdKQoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0cmFpbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInkiOiB5dHJhaW4udmFsdWVzLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXZhbF9zZXQiOlsoeHRyYWluLCB5dHJhaW4pLCAoeHZhbGlkLCB5dmFsaWQpXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXZhbF9tZXRyaWMiOiBldmFsX21ldHJpY3N9KQogICAgCiAgICBtb2RlbC5maXQoKiptb2RlbF9jb25maWdbIkZJVCJdKQoKICAgIGV2YWxfbWV0cmljcyA9IGV2YWxfY2xhc3NfbW9kZWwoY29udGV4dCwgeHZhbGlkLCB5dmFsaWQsIG1vZGVsKQogICAgCiAgICBtb2RlbF9wbG90cyA9IGV2YWxfbWV0cmljcy5wb3AoInBsb3RzIikKICAgIG1vZGVsX3RhYmxlcyA9IGV2YWxfbWV0cmljcy5wb3AoInRhYmxlcyIpCiAgICBmb3IgcGxvdCBpbiBtb2RlbF9wbG90czoKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChwbG90LCBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L3twbG90LmtleX0uaHRtbCIpCiAgICBmb3IgdGJsIGluIG1vZGVsX3RhYmxlczoKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCh0YmwsIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0ve3Bsb3Qua2V5fS5jc3YiKQogICAgICAgIAogICAgbW9kZWxfYmluID0gZHVtcHMobW9kZWwpICMgLmdldF9ib29zdGVyKCkpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgibW9kZWwiLCBib2R5PW1vZGVsX2JpbiwKICAgICAgICAgICAgICAgICAgICAgIGFydGlmYWN0X3BhdGg9b3MucGF0aC5qb2luKGNvbnRleHQuYXJ0aWZhY3RfcGF0aCwgbW9kZWxzX2Rlc3QpLAogICAgICAgICAgICAgICAgICAgICAgbW9kZWxfZmlsZT0ibW9kZWwucGtsIiwKICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3M9ZXZhbF9tZXRyaWNzKQoKICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoZXZhbF9tZXRyaWNzKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#8645360c007329479cd2978eba44ef4c2784e859:xgb_trainer.ipynb
