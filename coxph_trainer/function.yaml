kind: job
metadata:
  name: cox-hazards
  tag: ''
  hash: 16ad1a506bb62359c7cfbeba9bf547e98e9ab605
  project: ''
  labels:
    author: yjb
    framework: survival
  categories:
  - training
  - ml
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: "train models to predict the timing of events\n\nAlthough identical in\
        \ structure to other training functions, this one\nrequires generating a 'Y'\
        \ that represents the age/duration/tenure of\nthe obervation, designated 'tenure'\
        \ here, and a binary labels columns that\nrepresents the event of interest,\
        \ churned/not-churned.\n\nIn addition, there is a strata_cols parameter, representing\
        \ a list of \nstratification (aka grouping) variables."
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: event_column
        type: str
        doc: ground-truth (y) labels (considered as events in this model)
        default: labels
      - name: time_column
        type: str
        doc: age or tenure column
        default: tenure
      - name: encode_cols
        type: dict
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
          (diff strata_cols)
      - name: strata_cols
        type: list
        doc: columns used to stratify analysis (aka groups)
      - name: plot_cov_groups
        type: bool
      - name: p_value
        type: float
        doc: (0.005) max p value for coeffcients selected
        default: 0.005
      - name: enc_drop_first
        type: bool
        doc: (True) whether to drop the first column of hot encoded  variables (avoid
          column exact dependencies)
        default: true
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f760c0f2a20>
      - name: test_size
        type: float
        doc: (0.25) test set size
        default: 0.25
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: destination subfolder for model artifacts
      - name: plots_dest
        type: str
        doc: destination subfolder for plot artifacts
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: csv
      outputs: []
      lineno: 89
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IChnZXRfc2FtcGxlLAogICAgICAgICAgICAgICAgICAgICBnZXRfc3BsaXRzLAogICAgICAgICAgICAgICAgICAgICBnZW5fc2tsZWFybl9tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgY3JlYXRlX2NsYXNzLCAKICAgICAgICAgICAgICAgICAgICAgZXZhbF9jbGFzc19tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgZ2NmX2NsZWFyKQoKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0LCBUYWJsZUFydGlmYWN0Cgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBvcwoKZnJvbSBsaWZlbGluZXMgaW1wb3J0IENveFBIRml0dGVyLCBLYXBsYW5NZWllckZpdHRlcgoKZGVmIF9jb3hwaF9sb2dfbW9kZWwoCiAgICBjb250ZXh0LAogICAgbW9kZWwsIAogICAgZGF0YXNldF9rZXk6IHN0ciAgPSAiY294aGF6YXJkLXN1bW1hcnkiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICJtb2RlbHMiLAogICAgcGxvdF9jb3ZfZ3JvdXBzOiBib29sID0gRmFsc2UsCiAgICBwX3ZhbHVlOiBmbG9hdCA9IDAuMDA1LAogICAgcGxvdF9rZXk6IHN0ciAgPSAia20tY3giLAogICAgcGxvdHNfZGVzdDogc3RyID0gInBsb3RzIiwKICAgIGZpbGVfZXh0PSJjc3YiLAogICAgZXh0cmFfZGF0YTogZGljdCA9IHt9Cik6CiAgICAiIiJsb2cgYSBjb3hwaCBtb2RlbCAoYW5kIHN1Ym1vZGVsIGxvY2F0aW9ucykKICAgIAogICAgOnBhcmFtIG1vZGVsOiAgICAgICAgZXN0aW1hdGVkIGNveHBoIG1vZGVsCiAgICA6cGFyYW0gZXh0cmFfZGF0YTogICBpZiB0aGlzIG1vZGVsIHdhbnRzIHRvIHN0b3JlIHRoZSBsb2NhdGlvbnMgb2Ygc3VibW9kZWxzCiAgICAgICAgICAgICAgICAgICAgICAgICB1c2UgdGhpcwogICAgIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICAKICAgIHN1bXRibCA9IG1vZGVsLnN1bW1hcnkKICAgIAogICAgY29udGV4dC5sb2dfZGF0YXNldChkYXRhc2V0X2tleSwgZGY9c3VtdGJsLAogICAgICAgICAgICAgICAgICAgICAgICBpbmRleD1UcnVlLCBmb3JtYXQ9ZmlsZV9leHQpCgogICAgbW9kZWxfYmluID0gZHVtcHMobW9kZWwpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgia20tbW9kZWwiLCBib2R5PW1vZGVsX2JpbiwgCiAgICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdF9wYXRoPW9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIG1vZGVsc19kZXN0KSwKICAgICAgICAgICAgICAgICAgICAgIG1vZGVsX2ZpbGU9Im1vZGVsLnBrbCIpCiAgICBpZiBwbG90X2Nvdl9ncm91cHM6CiAgICAgICAgc2VsZWN0X2NvdmFycyA9IHN1bW1hcnlbc3VtbWFyeS5wPD1wX3ZhbHVlXS5pbmRleC52YWx1ZXMKICAgICAgICBmb3IgZ3JvdXAgaW4gc2VsZWN0X2NvdmFyczoKICAgICAgICAgICAgYXhzID0gbW9kZWwucGxvdF9jb3ZhcmlhdGVfZ3JvdXBzKGdyb3VwLCB2YWx1ZXM9WzAsIDFdKQogICAgICAgICAgICBmb3IgaXgsIGF4IGluIGVudW1lcmF0ZShheHMpOgogICAgICAgICAgICAgICAgZiA9IGF4LmdldF9maWd1cmUoKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoCiAgICAgICAgICAgICAgICAgICAgUGxvdEFydGlmYWN0KGYiY3gte2dyb3VwfS17aXh9IiwgYm9keT1wbHQuZ2NmKCkpLCAKICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L2N4LXtncm91cH0te2l4fS5odG1sIikKICAgICAgICAgICAgICAgIGdjZl9jbGVhcihwbHQpCgpkZWYgX2thcGxhbl9tZWllcl9sb2dfbW9kZWwoCiAgICBjb250ZXh0LAogICAgbW9kZWwsIAogICAgdGltZV9jb2x1bW46IHN0ciA9ICJ0ZW51cmUiLAogICAgZGF0YXNldF9rZXk6IHN0ciAgPSAia20tdGltZWxpbmVzIiwKICAgIHBsb3Rfa2V5OiBzdHIgID0gImttLXN1cnZpdmFsIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBtb2RlbHNfZGVzdDogc3RyID0gIm1vZGVscyIsCiAgICBmaWxlX2V4dDogc3RyID0gImNzdiIKKToKICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKICAgIG8gPSBbXQogICAgZm9yIG9iaiBpbiBtb2RlbC5fX2RpY3RfXy5rZXlzKCk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShtb2RlbC5fX2RpY3RfX1tvYmpdLCBwZC5EYXRhRnJhbWUpOgogICAgICAgICAgICBvLmFwcGVuZChtb2RlbC5fX2RpY3RfX1tvYmpdKQogICAgZGYgPSBwZC5jb25jYXQobywgYXhpcz0xKQogICAgZGYuaW5kZXgubmFtZSA9IHRpbWVfY29sdW1uCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KGRhdGFzZXRfa2V5LCBkZj1kZiwgaW5kZXg9VHJ1ZSwgZm9ybWF0PWZpbGVfZXh0KQogICAgbW9kZWwucGxvdCgpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QocGxvdF9rZXksIGJvZHk9cGx0LmdjZigpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L3twbG90X2tleX0uaHRtbCIpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgiY294LW1vZGVsIiwgCiAgICAgICAgICAgICAgICAgICAgICBib2R5PWR1bXBzKG1vZGVsKSwgCiAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9kaXI9ZiJ7bW9kZWxzX2Rlc3R9L2ttIiwgCiAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9maWxlPSJtb2RlbC5wa2wiKQoKZGVmIHRyYWluX21vZGVsKAogICAgY29udGV4dDogTUxDbGllbnRDdHgsCiAgICBkYXRhc2V0OiBEYXRhSXRlbSwKICAgIGV2ZW50X2NvbHVtbjogc3RyID0gImxhYmVscyIsCiAgICB0aW1lX2NvbHVtbjogc3RyID0gInRlbnVyZSIsCiAgICBlbmNvZGVfY29sczogZGljdCA9IHt9LAogICAgc3RyYXRhX2NvbHM6IGxpc3QgPSBbXSwKICAgIHBsb3RfY292X2dyb3VwczogYm9vbCA9IEZhbHNlLAogICAgcF92YWx1ZTogZmxvYXQgPSAwLjAwNSwKICAgIGVuY19kcm9wX2ZpcnN0OiBib29sID0gVHJ1ZSwKICAgIHNhbXBsZTogaW50ID0gLTEsCiAgICB0ZXN0X3NpemU6IGZsb2F0ID0gMC4yNSwKICAgIHZhbGlkX3NpemU6IGZsb2F0ID0gMC43NSwgIyAoYWZ0ZXIgdGVzdCByZW1vdmVkKQogICAgcmFuZG9tX3N0YXRlOiBpbnQgPSAxLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICIiLAogICAgcGxvdHNfZGVzdDogc3RyID0gIiIsCiAgICBmaWxlX2V4dDogc3RyID0gImNzdiIsCikgLT4gTm9uZToKICAgICIiInRyYWluIG1vZGVscyB0byBwcmVkaWN0IHRoZSB0aW1pbmcgb2YgZXZlbnRzCiAgICAKICAgIEFsdGhvdWdoIGlkZW50aWNhbCBpbiBzdHJ1Y3R1cmUgdG8gb3RoZXIgdHJhaW5pbmcgZnVuY3Rpb25zLCB0aGlzIG9uZQogICAgcmVxdWlyZXMgZ2VuZXJhdGluZyBhICdZJyB0aGF0IHJlcHJlc2VudHMgdGhlIGFnZS9kdXJhdGlvbi90ZW51cmUgb2YKICAgIHRoZSBvYmVydmF0aW9uLCBkZXNpZ25hdGVkICd0ZW51cmUnIGhlcmUsIGFuZCBhIGJpbmFyeSBsYWJlbHMgY29sdW1ucyB0aGF0CiAgICByZXByZXNlbnRzIHRoZSBldmVudCBvZiBpbnRlcmVzdCwgY2h1cm5lZC9ub3QtY2h1cm5lZC4KICAgIAogICAgSW4gYWRkaXRpb24sIHRoZXJlIGlzIGEgc3RyYXRhX2NvbHMgcGFyYW1ldGVyLCByZXByZXNlbnRpbmcgYSBsaXN0IG9mIAogICAgc3RyYXRpZmljYXRpb24gKGFrYSBncm91cGluZykgdmFyaWFibGVzLgogICAgCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICgiZGF0YSIpIG5hbWUgb2YgcmF3IGRhdGEgZmlsZQogICAgOnBhcmFtIGV2ZW50X2NvbHVtbjogICAgICBncm91bmQtdHJ1dGggKHkpIGxhYmVscyAoY29uc2lkZXJlZCBhcyBldmVudHMgaW4gdGhpcyBtb2RlbCkKICAgIDpwYXJhbSB0aW1lX2NvbHVtbjogICAgICAgYWdlIG9yIHRlbnVyZSBjb2x1bW4KICAgIDpwYXJhbSBlbmNvZGVfY29sczogICAgICAgZGljdGlvbmFyeSBvZiBuYW1lcyBhbmQgcHJlZml4ZXMgZm9yIGNvbHVtbnMgdGhhdCBhcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gaG90IGJlIGVuY29kZWQuIChkaWZmIHN0cmF0YV9jb2xzKQogICAgOnBhcmFtIGVuY19kcm9wX2ZpcnN0OiAgICAoVHJ1ZSkgd2hldGhlciB0byBkcm9wIHRoZSBmaXJzdCBjb2x1bW4gb2YgaG90IGVuY29kZWQgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlcyAoYXZvaWQgY29sdW1uIGV4YWN0IGRlcGVuZGVuY2llcykKICAgIDpwYXJhbSBzdHJhdGFfY29sczogICAgICAgY29sdW1ucyB1c2VkIHRvIHN0cmF0aWZ5IGFuYWx5c2lzIChha2EgZ3JvdXBzKQogICAgOnBhcmFtIHBfdmFsdWU6ICAgICAgICAgICAoMC4wMDUpIG1heCBwIHZhbHVlIGZvciBjb2VmZmNpZW50cyBzZWxlY3RlZAogICAgOnBhcmFtIHNhbXBsZTogICAgICAgICAgICBTZWxlY3RzIHRoZSBmaXJzdCBuIHJvd3MsIG9yIHNlbGVjdCBhIHNhbXBsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydGluZyBmcm9tIHRoZSBmaXJzdC4gSWYgbmVnYXRpdmUgPC0xLCBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYSByYW5kb20gc2FtcGxlCiAgICA6cGFyYW0gdGVzdF9zaXplOiAgICAgICAgICgwLjI1KSB0ZXN0IHNldCBzaXplCiAgICA6cGFyYW0gdmFsaWRfc2l6ZTogICAgICAgICgwLjc1KSBPbmNlIHRoZSB0ZXN0IHNldCBoYXMgYmVlbiByZW1vdmVkIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFpbmluZyBzZXQgZ2V0cyB0aGlzIHByb3BvcnRpb24uCiAgICA6cGFyYW0gcmFuZG9tX3N0YXRlOiAgICAgICgxKSBza2xlYXJuIHJuZyBzZWVkCiAgICA6cGFyYW0gbW9kZWxzX2Rlc3Q6ICAgICAgIGRlc3RpbmF0aW9uIHN1YmZvbGRlciBmb3IgbW9kZWwgYXJ0aWZhY3RzCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgIGRlc3RpbmF0aW9uIHN1YmZvbGRlciBmb3IgcGxvdCBhcnRpZmFjdHMKICAgIDpwYXJhbSBmaWxlX2V4dDogICAgICAgICAgZm9ybWF0IGZvciB0ZXN0X3NldF9rZXkgaG9sZCBvdXQgZGF0YQogICAgIiIiCiAgICBmcm9tIGxpZmVsaW5lcy5wbG90dGluZyBpbXBvcnQgcGxvdF9saWZldGltZXMKICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKICAgIAogICAgbW9kZWxzX2Rlc3QgPSBtb2RlbHNfZGVzdCBvciAibW9kZWxzIgogICAgcGxvdHNfZGVzdCA9IHBsb3RzX2Rlc3Qgb3IgZiJwbG90cy97Y29udGV4dC5uYW1lfSIKICAgIAogICAgcmF3LCB0ZW51cmUsIGhlYWRlciA9IGdldF9zYW1wbGUoZGF0YXNldCwgc2FtcGxlLCB0aW1lX2NvbHVtbikKCiAgICBpZiBlbmNvZGVfY29sczoKICAgICAgICByYXcgPSBwZC5nZXRfZHVtbWllcyhyYXcsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnM9bGlzdChlbmNvZGVfY29scy5rZXlzKCkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg9bGlzdChlbmNvZGVfY29scy52YWx1ZXMoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyb3BfZmlyc3Q9ZW5jX2Ryb3BfZmlyc3QpCgogICAgKHh0cmFpbiwgeXRyYWluKSwgKHh2YWxpZCwgeXZhbGlkKSwgICAgICAgICAoeHRlc3QsIHl0ZXN0KSwgXyA9IGdldF9zcGxpdHMocmF3LCB0ZW51cmUsIDMsIHRlc3Rfc2l6ZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkX3NpemUsIFt0aW1lX2NvbHVtbl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbV9zdGF0ZSkKICAgIGZvciBYIGluIFt4dHJhaW4sIHh2YWxpZCwgeHRlc3RdOgogICAgICAgIGRyb3BfY29scyA9IFguY29sdW1ucy5zdHIuc3RhcnRzd2l0aCh0aW1lX2NvbHVtbikKICAgICAgICBYLmRyb3AoWC5jb2x1bW5zW2Ryb3BfY29sc10sIGF4aXM9MSwgaW5wbGFjZT1UcnVlKQogICAgZm9yIFkgaW4gW3l0cmFpbiwgeXZhbGlkLCB5dGVzdF06CiAgICAgICAgWS5uYW1lID0gdGltZV9jb2x1bW4KICAgIAogICAgY29udGV4dC5sb2dfZGF0YXNldCgidGVudXJlZC10ZXN0LXNldCIsIAogICAgICAgICAgICAgICAgICAgICAgICBkZj1wZC5jb25jYXQoW3h0ZXN0LCB5dGVzdC50b19mcmFtZSgpXSwgYXhpcz0xKSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdD1maWxlX2V4dCwgaW5kZXg9RmFsc2UpCgogICAga21fbW9kZWwgPSBLYXBsYW5NZWllckZpdHRlcigpLmZpdCh5dHJhaW4sIHh0cmFpbi5sYWJlbHMpCiAgICBfa2FwbGFuX21laWVyX2xvZ19tb2RlbChjb250ZXh0LCBrbV9tb2RlbCwgbW9kZWxzX2Rlc3Q9bW9kZWxzX2Rlc3QpCiAgICAKICAgIGNveGRhdGEgPSBwZC5jb25jYXQoW3h0cmFpbiwgeXRyYWluLnRvX2ZyYW1lKCldLCBheGlzPTEpCiAgICBjeF9tb2RlbCA9IENveFBIRml0dGVyKCkuZml0KGNveGRhdGEsIHRpbWVfY29sdW1uLCBldmVudF9jb2x1bW4sIHN0cmF0YT1zdHJhdGFfY29scykgICAgCiAgICBfY294cGhfbG9nX21vZGVsKGNvbnRleHQsIGN4X21vZGVsLCBtb2RlbHNfZGVzdD1tb2RlbHNfZGVzdCwgCiAgICAgICAgICAgICAgICAgICAgIHBsb3RfY292X2dyb3Vwcz1wbG90X2Nvdl9ncm91cHMsIAogICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhPXsia20iOiBmInttb2RlbHNfZGVzdH0va20ifSkKCg==
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#bbaf91c5a14454dea6ba72cafa3f035608315b67:cox_hazards.ipynb
