kind: job
metadata:
  name: pii-recognizer
  tag: ''
  hash: d91012c81b76e17888b481f46d8dccbc47f2d7ee
  project: default
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: aW1wb3J0IG1scnVuCmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgQXJ0aWZhY3QKZnJvbSBwcmVzaWRpb19hbm9ueW1pemVyIGltcG9ydCBBbm9ueW1pemVyRW5naW5lCmZyb20gYW5ub3RhdGVkX3RleHQudXRpbCBpbXBvcnQgZ2V0X2Fubm90YXRlZF9odG1sCmZyb20ganNvbiBpbXBvcnQgSlNPTkVuY29kZXIKaW1wb3J0IGpzb24KaW1wb3J0IHdhcm5pbmdzCmltcG9ydCBvcwppbXBvcnQgbG9nZ2luZwpmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwsIExpc3QsIFR1cGxlLCBTZXQKCmZyb20gcHJlc2lkaW9fYW5hbHl6ZXIgaW1wb3J0ICgKICAgIFJlY29nbml6ZXJSZWdpc3RyeSwKICAgIEFuYWx5emVyRW5naW5lLAogICAgUmVjb2duaXplclJlc3VsdCwKICAgIExvY2FsUmVjb2duaXplciwKICAgIEVudGl0eVJlY29nbml6ZXIsCiAgICBQYXR0ZXJuLAogICAgUGF0dGVyblJlY29nbml6ZXIsCiAgICBBbmFseXNpc0V4cGxhbmF0aW9uLAopCmZyb20gcHJlc2lkaW9fYW5hbHl6ZXIubmxwX2VuZ2luZSBpbXBvcnQgTmxwQXJ0aWZhY3RzCmZyb20gcHJlc2lkaW9fYW5hbHl6ZXIucHJlZGVmaW5lZF9yZWNvZ25pemVycy5zcGFjeV9yZWNvZ25pemVyIGltcG9ydCBTcGFjeVJlY29nbml6ZXIKCnRyeToKICAgIGZyb20gZmxhaXIuZGF0YSBpbXBvcnQgU2VudGVuY2UKICAgIGZyb20gZmxhaXIubW9kZWxzIGltcG9ydCBTZXF1ZW5jZVRhZ2dlcgpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBwcmludCgiRmxhaXIgaXMgbm90IGluc3RhbGxlZCIpCgpvcy5lbnZpcm9uWyJUT0tFTklaRVJTX1BBUkFMTEVMSVNNIl0gPSAiZmFsc2UiCndhcm5pbmdzLmZpbHRlcndhcm5pbmdzKCJpZ25vcmUiKQpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcigicGlpLXJlY29nbml6ZXIiKQoKCmNsYXNzIFBhdHRlcm5SZWNvZ25pemVyRmFjdG9yeToKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBjcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKCk6CiAgICAgICAgRU5USVRJRVMgPSB7CiAgICAgICAgICAgICJDUkVESVRfQ0FSRCI6IFtQYXR0ZXJuKCJDUkVESVRfQ0FSRCIsIHIiXGIoPzpcZFsgLV0qPyl7MTMsMTZ9XGIiLCAwLjUpXSwKICAgICAgICAgICAgIlNTTiI6IFtQYXR0ZXJuKCJTU04iLCByIlxiXGR7M30tP1xkezJ9LT9cZHs0fVxiIiwgMC41KV0sCiAgICAgICAgICAgICJQSE9ORSI6IFtQYXR0ZXJuKCJQSE9ORSIsIHIiXCg/XGR7M31cKT9bLS5cc10/XGR7M31bLS5cc10/XGR7NH0iLCAwLjUpXSwKICAgICAgICAgICAgIkVNQUlMIjogW1BhdHRlcm4oIkVNQUlMIiwgciJcUytAXFMrIiwgMC41KV0sCiAgICAgICAgfQogICAgICAgIHJlcyA9IFtdCiAgICAgICAgZm9yIGVudGl0eSwgcGF0dGVybiBpbiBFTlRJVElFUy5pdGVtcygpOgogICAgICAgICAgICByZXMuYXBwZW5kKFBhdHRlcm5SZWNvZ25pemVyKHN1cHBvcnRlZF9lbnRpdHk9ZW50aXR5LCBwYXR0ZXJucz1wYXR0ZXJuKSkKICAgICAgICByZXR1cm4gcmVzCgoKY2xhc3MgQ3VzdG9tU3BhY3lSZWNvZ25pemVyKExvY2FsUmVjb2duaXplcik6CiAgICBFTlRJVElFUyA9IFsKICAgICAgICAiTE9DQVRJT04iLAogICAgICAgICJQRVJTT04iLAogICAgICAgICJOUlAiLAogICAgICAgICJPUkdBTklaQVRJT04iLAogICAgICAgICJEQVRFX1RJTUUiLAogICAgXQoKICAgIERFRkFVTFRfRVhQTEFOQVRJT04gPSAoCiAgICAgICAgIklkZW50aWZpZWQgYXMge30gYnkgU3BhY3kncyBOYW1lZCBFbnRpdHkgUmVjb2duaXRpb24gKFByaXZ5LXRyYWluZWQpIgogICAgKQoKICAgIENIRUNLX0xBQkVMX0dST1VQUyA9IFsKICAgICAgICAoeyJMT0NBVElPTiJ9LCB7IkxPQyIsICJMT0NBVElPTiIsICJTVFJFRVRfQUREUkVTUyIsICJDT09SRElOQVRFIn0pLAogICAgICAgICh7IlBFUlNPTiJ9LCB7IlBFUiIsICJQRVJTT04ifSksCiAgICAgICAgKHsiTlJQIn0sIHsiTk9SUCIsICJOUlAifSksCiAgICAgICAgKHsiT1JHQU5JWkFUSU9OIn0sIHsiT1JHIn0pLAogICAgICAgICh7IkRBVEVfVElNRSJ9LCB7IkRBVEVfVElNRSJ9KSwKICAgIF0KCiAgICBNT0RFTF9MQU5HVUFHRVMgPSB7CiAgICAgICAgImVuIjogImJla2kvZW5fc3BhY3lfcGlpX2Rpc3RpbGJlcnQiLAogICAgfQoKICAgIFBSRVNJRElPX0VRVUlWQUxFTkNFUyA9IHsKICAgICAgICAiUEVSIjogIlBFUlNPTiIsCiAgICAgICAgIkxPQyI6ICJMT0NBVElPTiIsCiAgICAgICAgIk9SRyI6ICJPUkdBTklaQVRJT04iLAogICAgICAgICJOUk9QIjogIk5SUCIsCiAgICAgICAgIkRBVEVfVElNRSI6ICJEQVRFX1RJTUUiLAogICAgfQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZTogc3RyID0gImVuIiwKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM6IE9wdGlvbmFsW0xpc3Rbc3RyXV0gPSBOb25lLAogICAgICAgIGNoZWNrX2xhYmVsX2dyb3VwczogT3B0aW9uYWxbVHVwbGVbU2V0LCBTZXRdXSA9IE5vbmUsCiAgICAgICAgY29udGV4dDogT3B0aW9uYWxbTGlzdFtzdHJdXSA9IE5vbmUsCiAgICAgICAgbmVyX3N0cmVuZ3RoOiBmbG9hdCA9IDAuODUsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgU3BhY3kgUmVjb2duaXplci4KICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2xhbmd1YWdlOiBMYW5ndWFnZSB0byB1c2UKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2VudGl0aWVzOiBFbnRpdGllcyB0byB1c2UKICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sKICAgICAgICA6cGFyYW0gY29udGV4dDogQ29udGV4dCB0byB1c2UKICAgICAgICA6cGFyYW0gbmVyX3N0cmVuZ3RoOiBORVIgc3RyZW5ndGggdG8gdXNlCiAgICAgICAgOnJldHVybnMgU3BhY3lSZWNvZ25pemVyIG9iamVjdAogICAgICAgICIiIgogICAgICAgIHNlbGYubmVyX3N0cmVuZ3RoID0gbmVyX3N0cmVuZ3RoCiAgICAgICAgc2VsZi5jaGVja19sYWJlbF9ncm91cHMgPSAoCiAgICAgICAgICAgIGNoZWNrX2xhYmVsX2dyb3VwcyBpZiBjaGVja19sYWJlbF9ncm91cHMgZWxzZSBzZWxmLkNIRUNLX0xBQkVMX0dST1VQUwogICAgICAgICkKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXMgPSBzdXBwb3J0ZWRfZW50aXRpZXMgaWYgc3VwcG9ydGVkX2VudGl0aWVzIGVsc2Ugc2VsZi5FTlRJVElFUwogICAgICAgIHN1cGVyKCkuX19pbml0X18oCiAgICAgICAgICAgIHN1cHBvcnRlZF9lbnRpdGllcz1zdXBwb3J0ZWRfZW50aXRpZXMsCiAgICAgICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZT1zdXBwb3J0ZWRfbGFuZ3VhZ2UsCiAgICAgICAgKQoKICAgIGRlZiBsb2FkKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiTG9hZCB0aGUgbW9kZWwsIG5vdCB1c2VkLiBNb2RlbCBpcyBsb2FkZWQgZHVyaW5nIGluaXRpYWxpemF0aW9uLiIiIgogICAgICAgIHBhc3MKCiAgICBkZWYgZ2V0X3N1cHBvcnRlZF9lbnRpdGllcyhzZWxmKSAtPiBMaXN0W3N0cl06CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHN1cHBvcnRlZCBlbnRpdGllcyBieSB0aGlzIG1vZGVsLgogICAgICAgIDpyZXR1cm5zIExpc3Qgb2YgdGhlIHN1cHBvcnRlZCBlbnRpdGllcy4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXMKCiAgICBkZWYgYnVpbGRfc3BhY3lfZXhwbGFuYXRpb24oCiAgICAgICAgc2VsZiwgb3JpZ2luYWxfc2NvcmU6IGZsb2F0LCBleHBsYW5hdGlvbjogc3RyCiAgICApIC0+IEFuYWx5c2lzRXhwbGFuYXRpb246CiAgICAgICAgIiIiCiAgICAgICAgQ3JlYXRlIGV4cGxhbmF0aW9uIGZvciB3aHkgdGhpcyByZXN1bHQgd2FzIGRldGVjdGVkLgogICAgICAgIDpwYXJhbSBvcmlnaW5hbF9zY29yZTogU2NvcmUgZ2l2ZW4gYnkgdGhpcyByZWNvZ25pemVyCiAgICAgICAgOnBhcmFtIGV4cGxhbmF0aW9uOiBFeHBsYW5hdGlvbiBzdHJpbmcKICAgICAgICA6cmV0dXJuczogQW5hbHlzaXNFeHBsYW5hdGlvbiBvYmplY3QKICAgICAgICAiIiIKICAgICAgICBleHBsYW5hdGlvbiA9IEFuYWx5c2lzRXhwbGFuYXRpb24oCiAgICAgICAgICAgIHJlY29nbml6ZXI9c2VsZi5fX2NsYXNzX18uX19uYW1lX18sCiAgICAgICAgICAgIG9yaWdpbmFsX3Njb3JlPW9yaWdpbmFsX3Njb3JlLAogICAgICAgICAgICB0ZXh0dWFsX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICkKICAgICAgICByZXR1cm4gZXhwbGFuYXRpb24KCiAgICBkZWYgYW5hbHl6ZShzZWxmLCB0ZXh0LCBlbnRpdGllcywgbmxwX2FydGlmYWN0cz1Ob25lKTogICMgbm9xYSBEMTAyCiAgICAgICAgIiIiCiAgICAgICAgQW5hbHl6ZSB0ZXh0IHVzaW5nIFNwYWN5LgogICAgICAgIDpwYXJhbSB0ZXh0OiBUZXh0IHRvIGFuYWx5emUKICAgICAgICA6cGFyYW0gZW50aXRpZXM6IEVudGl0aWVzIHRvIGFuYWx5emUKICAgICAgICA6cGFyYW0gbmxwX2FydGlmYWN0czogTkxQIGFydGlmYWN0cyB0byB1c2UKICAgICAgICA6cmV0dXJuczogTGlzdCBvZiBSZWNvZ25pemVyUmVzdWx0IG9iamVjdHMKICAgICAgICAiIiIKICAgICAgICByZXN1bHRzID0gW10KICAgICAgICBpZiBub3QgbmxwX2FydGlmYWN0czoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlNraXBwaW5nIFNwYUN5LCBubHAgYXJ0aWZhY3RzIG5vdCBwcm92aWRlZC4uLiIpCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzCgogICAgICAgIG5lcl9lbnRpdGllcyA9IG5scF9hcnRpZmFjdHMuZW50aXRpZXMKCiAgICAgICAgZm9yIGVudGl0eSBpbiBlbnRpdGllczoKICAgICAgICAgICAgaWYgZW50aXR5IG5vdCBpbiBzZWxmLnN1cHBvcnRlZF9lbnRpdGllczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGZvciBlbnQgaW4gbmVyX2VudGl0aWVzOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX19jaGVja19sYWJlbChlbnRpdHksIGVudC5sYWJlbF8sIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbiA9IHNlbGYuREVGQVVMVF9FWFBMQU5BVElPTi5mb3JtYXQoZW50LmxhYmVsXykKICAgICAgICAgICAgICAgIGV4cGxhbmF0aW9uID0gc2VsZi5idWlsZF9zcGFjeV9leHBsYW5hdGlvbigKICAgICAgICAgICAgICAgICAgICBzZWxmLm5lcl9zdHJlbmd0aCwgdGV4dHVhbF9leHBsYW5hdGlvbgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgc3BhY3lfcmVzdWx0ID0gUmVjb2duaXplclJlc3VsdCgKICAgICAgICAgICAgICAgICAgICBlbnRpdHlfdHlwZT1lbnRpdHksCiAgICAgICAgICAgICAgICAgICAgc3RhcnQ9ZW50LnN0YXJ0X2NoYXIsCiAgICAgICAgICAgICAgICAgICAgZW5kPWVudC5lbmRfY2hhciwKICAgICAgICAgICAgICAgICAgICBzY29yZT1zZWxmLm5lcl9zdHJlbmd0aCwKICAgICAgICAgICAgICAgICAgICBhbmFseXNpc19leHBsYW5hdGlvbj1leHBsYW5hdGlvbiwKICAgICAgICAgICAgICAgICAgICByZWNvZ25pdGlvbl9tZXRhZGF0YT17CiAgICAgICAgICAgICAgICAgICAgICAgIFJlY29nbml6ZXJSZXN1bHQuUkVDT0dOSVpFUl9OQU1FX0tFWTogc2VsZi5uYW1lCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKHNwYWN5X3Jlc3VsdCkKCiAgICAgICAgcmV0dXJuIHJlc3VsdHMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX19jaGVja19sYWJlbCgKICAgICAgICBlbnRpdHk6IHN0ciwgbGFiZWw6IHN0ciwgY2hlY2tfbGFiZWxfZ3JvdXBzOiBUdXBsZVtTZXQsIFNldF0KICAgICkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBDaGVjayBpZiB0aGUgbGFiZWwgaXMgaW4gdGhlIGxhYmVsIGdyb3VwLgogICAgICAgIDpwYXJhbSBlbnRpdHk6IEVudGl0eSB0byBjaGVjawogICAgICAgIDpwYXJhbSBsYWJlbDogTGFiZWwgdG8gY2hlY2sKICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sKICAgICAgICA6cmV0dXJuczogVHJ1ZSBpZiB0aGUgbGFiZWwgaXMgaW4gdGhlIGxhYmVsIGdyb3VwLCBGYWxzZSBvdGhlcndpc2UKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gYW55KAogICAgICAgICAgICBbZW50aXR5IGluIGVncnAgYW5kIGxhYmVsIGluIGxncnAgZm9yIGVncnAsIGxncnAgaW4gY2hlY2tfbGFiZWxfZ3JvdXBzXQogICAgICAgICkKCgpjbGFzcyBGbGFpclJlY29nbml6ZXIoRW50aXR5UmVjb2duaXplcik6CiAgICAiIiIKICAgIFdyYXBwZXIgZm9yIGEgZmxhaXIgbW9kZWwsIGlmIG5lZWRlZCB0byBiZSB1c2VkIHdpdGhpbiBQcmVzaWRpbyBBbmFseXplci4KICAgICIiIgoKICAgIEVOVElUSUVTID0gWwogICAgICAgICJMT0NBVElPTiIsCiAgICAgICAgIlBFUlNPTiIsCiAgICAgICAgIk5SUCIsCiAgICAgICAgIkdQRSIsCiAgICAgICAgIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIk1BQ19BRERSRVNTIiwKICAgICAgICAiVVNfQkFOS19OVU1CRVIiLAogICAgICAgICJJTUVJIiwKICAgICAgICAiVElUTEUiLAogICAgICAgICJMSUNFTlNFX1BMQVRFIiwKICAgICAgICAiVVNfUEFTU1BPUlQiLAogICAgICAgICJDVVJSRU5DWSIsCiAgICAgICAgIlJPVVRJTkdfTlVNQkVSIiwKICAgICAgICAiVVNfSVRJTiIsCiAgICAgICAgIlVTX0JBTktfTlVNQkVSIiwKICAgICAgICAiVVNfRFJJVkVSX0xJQ0VOU0UiLAogICAgICAgICJBR0UiLAogICAgICAgICJQQVNTV09SRCIsCiAgICAgICAgIlNXSUZUX0NPREUiLAogICAgXQoKICAgIERFRkFVTFRfRVhQTEFOQVRJT04gPSAiSWRlbnRpZmllZCBhcyB7fSBieSBGbGFpcidzIE5hbWVkIEVudGl0eSBSZWNvZ25pdGlvbiIKCiAgICBDSEVDS19MQUJFTF9HUk9VUFMgPSBbCiAgICAgICAgKHsiTE9DQVRJT04ifSwgeyJMT0MiLCAiTE9DQVRJT04iLCAiU1RSRUVUX0FERFJFU1MiLCAiQ09PUkRJTkFURSJ9KSwKICAgICAgICAoeyJQRVJTT04ifSwgeyJQRVIiLCAiUEVSU09OIn0pLAogICAgICAgICh7Ik5SUCJ9LCB7Ik5PUlAiLCAiTlJQIn0pLAogICAgICAgICh7IkdQRSJ9LCB7IkdQRSJ9KSwKICAgICAgICAoeyJPUkdBTklaQVRJT04ifSwgeyJPUkcifSksCiAgICAgICAgKHsiTUFDX0FERFJFU1MifSwgeyJNQUNfQUREUkVTUyJ9KSwKICAgICAgICAoeyJVU19CQU5LX05VTUJFUiJ9LCB7IlVTX0JBTktfTlVNQkVSIn0pLAogICAgICAgICh7IklNRUkifSwgeyJJTUVJIn0pLAogICAgICAgICh7IlRJVExFIn0sIHsiVElUTEUifSksCiAgICAgICAgKHsiTElDRU5TRV9QTEFURSJ9LCB7IkxJQ0VOU0VfUExBVEUifSksCiAgICAgICAgKHsiVVNfUEFTU1BPUlQifSwgeyJVU19QQVNTUE9SVCJ9KSwKICAgICAgICAoeyJDVVJSRU5DWSJ9LCB7IkNVUlJFTkNZIn0pLAogICAgICAgICh7IlJPVVRJTkdfTlVNQkVSIn0sIHsiUk9VVElOR19OVU1CRVIifSksCiAgICAgICAgKHsiQUdFIn0sIHsiQUdFIn0pLAogICAgICAgICh7IkNVUlJFTkNZIn0sIHsiQ1VSUkVOQ1kifSksCiAgICAgICAgKHsiU1dJRlRfQ09ERSJ9LCB7IlNXSUZUX0NPREUifSksCiAgICAgICAgKHsiVVNfSVRJTiJ9LCB7IlVTX0lUSU4ifSksCiAgICAgICAgKHsiVVNfQkFOS19OVU1CRVIifSwgeyJVU19CQU5LX05VTUJFUiJ9KSwKICAgICAgICAoeyJVU19EUklWRVJfTElDRU5TRSJ9LCB7IlVTX0RSSVZFUl9MSUNFTlNFIn0pLAogICAgXQoKICAgIE1PREVMX0xBTkdVQUdFUyA9IHsKICAgICAgICAiZW4iOiAiYmVraS9mbGFpci1waWktZGlzdGlsYmVydCIsCiAgICB9CgogICAgUFJFU0lESU9fRVFVSVZBTEVOQ0VTID0gewogICAgICAgICJQRVIiOiAiUEVSU09OIiwKICAgICAgICAiTE9DIjogIkxPQ0FUSU9OIiwKICAgICAgICAiT1JHIjogIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIk5ST1AiOiAiTlJQIiwKICAgICAgICAiVVJMIjogIlVSTCIsCiAgICAgICAgIlVTX0lUSU4iOiAiVVNfSVRJTiIsCiAgICAgICAgIlVTX1BBU1NQT1JUIjogIlVTX1BBU1NQT1JUIiwKICAgICAgICAiSUJBTl9DT0RFIjogIklCQU5fQ09ERSIsCiAgICAgICAgIklQX0FERFJFU1MiOiAiSVBfQUREUkVTUyIsCiAgICAgICAgIkVNQUlMX0FERFJFU1MiOiAiRU1BSUwiLAogICAgICAgICJVU19EUklWRVJfTElDRU5TRSI6ICJVU19EUklWRVJfTElDRU5TRSIsCiAgICAgICAgIlVTX0JBTktfTlVNQkVSIjogIlVTX0JBTktfTlVNQkVSIiwKICAgIH0KCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBzdXBwb3J0ZWRfbGFuZ3VhZ2U6IHN0ciA9ICJlbiIsCiAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzOiBPcHRpb25hbFtMaXN0W3N0cl1dID0gTm9uZSwKICAgICAgICBjaGVja19sYWJlbF9ncm91cHM6IE9wdGlvbmFsW1R1cGxlW1NldCwgU2V0XV0gPSBOb25lLAogICAgICAgIG1vZGVsOiBTZXF1ZW5jZVRhZ2dlciA9IE5vbmUsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgdGhlIEZsYWlyUmVjb2duaXplci4KICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2xhbmd1YWdlOiBMYW5ndWFnZSB0byB1c2UKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2VudGl0aWVzOiBFbnRpdGllcyB0byB1c2UKICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sKICAgICAgICA6cGFyYW0gbW9kZWw6IEZsYWlyIG1vZGVsIHRvIHVzZQogICAgICAgIDpyZXR1cm5zOiBGbGFpclJlY29nbml6ZXIgb2JqZWN0CgogICAgICAgICIiIgogICAgICAgIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzID0gKAogICAgICAgICAgICBjaGVja19sYWJlbF9ncm91cHMgaWYgY2hlY2tfbGFiZWxfZ3JvdXBzIGVsc2Ugc2VsZi5DSEVDS19MQUJFTF9HUk9VUFMKICAgICAgICApCgogICAgICAgIHN1cHBvcnRlZF9lbnRpdGllcyA9IHN1cHBvcnRlZF9lbnRpdGllcyBpZiBzdXBwb3J0ZWRfZW50aXRpZXMgZWxzZSBzZWxmLkVOVElUSUVTCiAgICAgICAgc2VsZi5tb2RlbCA9ICgKICAgICAgICAgICAgbW9kZWwKICAgICAgICAgICAgaWYgbW9kZWwKICAgICAgICAgICAgZWxzZSBTZXF1ZW5jZVRhZ2dlci5sb2FkKHNlbGYuTU9ERUxfTEFOR1VBR0VTLmdldChzdXBwb3J0ZWRfbGFuZ3VhZ2UpKQogICAgICAgICkKCiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygKICAgICAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzPXN1cHBvcnRlZF9lbnRpdGllcywKICAgICAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlPXN1cHBvcnRlZF9sYW5ndWFnZSwKICAgICAgICAgICAgbmFtZT0iRmxhaXIgQW5hbHl0aWNzIiwKICAgICAgICApCgogICAgZGVmIGxvYWQoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiJMb2FkIHRoZSBtb2RlbCwgbm90IHVzZWQuIE1vZGVsIGlzIGxvYWRlZCBkdXJpbmcgaW5pdGlhbGl6YXRpb24uIiIiCiAgICAgICAgcGFzcwoKICAgIGRlZiBnZXRfc3VwcG9ydGVkX2VudGl0aWVzKHNlbGYpIC0+IExpc3Rbc3RyXToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm4gc3VwcG9ydGVkIGVudGl0aWVzIGJ5IHRoaXMgbW9kZWwuCiAgICAgICAgOnJldHVybnM6IExpc3Qgb2YgdGhlIHN1cHBvcnRlZCBlbnRpdGllcy4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXMKCiAgICAjIENsYXNzIHRvIHVzZSBGbGFpciB3aXRoIFByZXNpZGlvIGFzIGFuIGV4dGVybmFsIHJlY29nbml6ZXIuCiAgICBkZWYgYW5hbHl6ZSgKICAgICAgICBzZWxmLCB0ZXh0OiBzdHIsIGVudGl0aWVzOiBMaXN0W3N0cl0sIG5scF9hcnRpZmFjdHM6IE5scEFydGlmYWN0cyA9IE5vbmUKICAgICkgLT4gTGlzdFtSZWNvZ25pemVyUmVzdWx0XToKICAgICAgICAiIiIKICAgICAgICBBbmFseXplIHRleHQgdXNpbmcgVGV4dCBBbmFseXRpY3MuCiAgICAgICAgOnBhcmFtIHRleHQ6IFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgICAgICA6cGFyYW0gZW50aXRpZXM6IE5vdCB3b3JraW5nIHByb3Blcmx5IGZvciB0aGlzIHJlY29nbml6ZXIuCiAgICAgICAgOnBhcmFtIG5scF9hcnRpZmFjdHM6IE5vdCB1c2VkIGJ5IHRoaXMgcmVjb2duaXplci4KICAgICAgICA6cGFyYW0gbGFuZ3VhZ2U6IFRleHQgbGFuZ3VhZ2UuIFN1cHBvcnRlZCBsYW5ndWFnZXMgaW4gTU9ERUxfTEFOR1VBR0VTCiAgICAgICAgOnJldHVybnM6IFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSB0aGUgcmVjb2duaXplZAogICAgICAgICAgICBGbGFpciBkZXRlY3Rpb25zLgogICAgICAgICIiIgoKICAgICAgICByZXN1bHRzID0gW10KCiAgICAgICAgc2VudGVuY2VzID0gU2VudGVuY2UodGV4dCkKICAgICAgICBzZWxmLm1vZGVsLnByZWRpY3Qoc2VudGVuY2VzKQoKICAgICAgICAjIElmIHRoZXJlIGFyZSBubyBzcGVjaWZpYyBsaXN0IG9mIGVudGl0aWVzLCB3ZSB3aWxsIGxvb2sgZm9yIGFsbCBvZiBpdC4KICAgICAgICBpZiBub3QgZW50aXRpZXM6CiAgICAgICAgICAgIGVudGl0aWVzID0gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXMKCiAgICAgICAgZm9yIGVudGl0eSBpbiBlbnRpdGllczoKICAgICAgICAgICAgaWYgZW50aXR5IG5vdCBpbiBzZWxmLnN1cHBvcnRlZF9lbnRpdGllczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBmb3IgZW50IGluIHNlbnRlbmNlcy5nZXRfc3BhbnMoIm5lciIpOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX19jaGVja19sYWJlbCgKICAgICAgICAgICAgICAgICAgICBlbnRpdHksIGVudC5sYWJlbHNbMF0udmFsdWUsIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzCiAgICAgICAgICAgICAgICApOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0ZXh0dWFsX2V4cGxhbmF0aW9uID0gc2VsZi5ERUZBVUxUX0VYUExBTkFUSU9OLmZvcm1hdCgKICAgICAgICAgICAgICAgICAgICBlbnQubGFiZWxzWzBdLnZhbHVlCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBleHBsYW5hdGlvbiA9IHNlbGYuYnVpbGRfZmxhaXJfZXhwbGFuYXRpb24oCiAgICAgICAgICAgICAgICAgICAgcm91bmQoZW50LnNjb3JlLCAyKSwgdGV4dHVhbF9leHBsYW5hdGlvbgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZmxhaXJfcmVzdWx0ID0gc2VsZi5fY29udmVydF90b19yZWNvZ25pemVyX3Jlc3VsdChlbnQsIGV4cGxhbmF0aW9uKQoKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKGZsYWlyX3Jlc3VsdCkKCiAgICAgICAgcmV0dXJuIHJlc3VsdHMKCiAgICBkZWYgX2NvbnZlcnRfdG9fcmVjb2duaXplcl9yZXN1bHQoc2VsZiwgZW50aXR5LCBleHBsYW5hdGlvbikgLT4gUmVjb2duaXplclJlc3VsdDoKICAgICAgICAiIiIKICAgICAgICBDb252ZXJ0IEZsYWlyIHJlc3VsdCB0byBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0LgogICAgICAgIDpwYXJhbSBlbnRpdHk6IEZsYWlyIGVudGl0eQogICAgICAgIDpwYXJhbSBleHBsYW5hdGlvbjogQW5hbHlzaXNFeHBsYW5hdGlvbgogICAgICAgIDpyZXR1cm5zOiBSZWNvZ25pemVyUmVzdWx0CiAgICAgICAgIiIiCiAgICAgICAgZW50aXR5X3R5cGUgPSBzZWxmLlBSRVNJRElPX0VRVUlWQUxFTkNFUy5nZXQoZW50aXR5LnRhZywgZW50aXR5LnRhZykKICAgICAgICBmbGFpcl9zY29yZSA9IHJvdW5kKGVudGl0eS5zY29yZSwgMikKCiAgICAgICAgZmxhaXJfcmVzdWx0cyA9IFJlY29nbml6ZXJSZXN1bHQoCiAgICAgICAgICAgIGVudGl0eV90eXBlPWVudGl0eV90eXBlLAogICAgICAgICAgICBzdGFydD1lbnRpdHkuc3RhcnRfcG9zaXRpb24sCiAgICAgICAgICAgIGVuZD1lbnRpdHkuZW5kX3Bvc2l0aW9uLAogICAgICAgICAgICBzY29yZT1mbGFpcl9zY29yZSwKICAgICAgICAgICAgYW5hbHlzaXNfZXhwbGFuYXRpb249ZXhwbGFuYXRpb24sCiAgICAgICAgKQoKICAgICAgICByZXR1cm4gZmxhaXJfcmVzdWx0cwoKICAgIGRlZiBidWlsZF9mbGFpcl9leHBsYW5hdGlvbigKICAgICAgICBzZWxmLCBvcmlnaW5hbF9zY29yZTogZmxvYXQsIGV4cGxhbmF0aW9uOiBzdHIKICAgICkgLT4gQW5hbHlzaXNFeHBsYW5hdGlvbjoKICAgICAgICAiIiIKICAgICAgICBDcmVhdGUgZXhwbGFuYXRpb24gZm9yIHdoeSB0aGlzIHJlc3VsdCB3YXMgZGV0ZWN0ZWQuCiAgICAgICAgOnBhcmFtIG9yaWdpbmFsX3Njb3JlOiBTY29yZSBnaXZlbiBieSB0aGlzIHJlY29nbml6ZXIKICAgICAgICA6cGFyYW0gZXhwbGFuYXRpb246IEV4cGxhbmF0aW9uIHN0cmluZwogICAgICAgIDpyZXR1cm5zOiBBbmFseXNpc0V4cGxhbmF0aW9uCiAgICAgICAgIiIiCiAgICAgICAgZXhwbGFuYXRpb24gPSBBbmFseXNpc0V4cGxhbmF0aW9uKAogICAgICAgICAgICByZWNvZ25pemVyPXNlbGYuX19jbGFzc19fLl9fbmFtZV9fLAogICAgICAgICAgICBvcmlnaW5hbF9zY29yZT1vcmlnaW5hbF9zY29yZSwKICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbj1leHBsYW5hdGlvbiwKICAgICAgICApCiAgICAgICAgcmV0dXJuIGV4cGxhbmF0aW9uCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9fY2hlY2tfbGFiZWwoCiAgICAgICAgZW50aXR5OiBzdHIsIGxhYmVsOiBzdHIsIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdCiAgICApIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIGFueSgKICAgICAgICAgICAgW2VudGl0eSBpbiBlZ3JwIGFuZCBsYWJlbCBpbiBsZ3JwIGZvciBlZ3JwLCBsZ3JwIGluIGNoZWNrX2xhYmVsX2dyb3Vwc10KICAgICAgICApCgoKZGVmIGFuYWx5emVyX2VuZ2luZShtb2RlbD0id2hvbGUiKToKICAgICIiIlJldHVybiBBbmFseXplckVuZ2luZS4KICAgIDpwYXJhbSBtb2RlbDogVGhlIG1vZGVsIHRvIHVzZS4gQ2FuIGJlICJzcGFjeSIsICJmbGFpciIsICJwYXR0ZXJuIiBvciAid2hvbGUiLgogICAgOnJldHVybnM6IEFuYWx5emVyRW5naW5lCiAgICAiIiIKICAgIHJlZ2lzdHJ5ID0gUmVjb2duaXplclJlZ2lzdHJ5KCkKCiAgICBzcGFjeV9yZWNvZ25pemVyID0gQ3VzdG9tU3BhY3lSZWNvZ25pemVyKCkKCiAgICBmbGFpcl9yZWNvZ25pemVyID0gRmxhaXJSZWNvZ25pemVyKCkKCiAgICBpZiBtb2RlbCA9PSAic3BhY3kiOgogICAgICAgICMgYWRkIHRoZSBjdXN0b20gYnVpbGQgc3BhY3kgcmVjb2duaXplcgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHNwYWN5X3JlY29nbml6ZXIpCiAgICBpZiBtb2RlbCA9PSAiZmxhaXIiOgogICAgICAgICMgYWRkIHRoZSBjdXN0b20gYnVpbGQgZmxhaXIgcmVjb2duaXplcgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICBpZiBtb2RlbCA9PSAicGF0dGVybiI6CiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICBmb3IgcmVjb2duaXplciBpbiBwYXR0ZXJuX3JlY29nbml6ZXJfZmFjdG9yeS5jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKCk6CiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCiAgICBpZiBtb2RlbCA9PSAid2hvbGUiOgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHNwYWN5X3JlY29nbml6ZXIpCiAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIoZmxhaXJfcmVjb2duaXplcikKICAgICAgICAjIGFkZCB0aGUgcGF0dGVybiByZWNvZ25pemVyCiAgICAgICAgcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkgPSBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkoKQogICAgICAgIGZvciByZWNvZ25pemVyIGluIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5LmNyZWF0ZV9wYXR0ZXJuX3JlY29nbml6ZXIoKToKICAgICAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIocmVjb2duaXplcikKCiAgICBhbmFseXplciA9IEFuYWx5emVyRW5naW5lKHJlZ2lzdHJ5PXJlZ2lzdHJ5LCBzdXBwb3J0ZWRfbGFuZ3VhZ2VzPVsiZW4iXSkKICAgIHJldHVybiBhbmFseXplcgoKCmRlZiBhbm9ueW1pemVyX2VuZ2luZSgpOgogICAgIiIiUmV0dXJuIEFub255bWl6ZXJFbmdpbmUuCiAgICA6cmV0dXJuczogVGhlIEFub255bWl6ZXJFbmdpbmUuCiAgICAiIiIKICAgIHJldHVybiBBbm9ueW1pemVyRW5naW5lKCkKCgpkZWYgZ2V0X3N1cHBvcnRlZF9lbnRpdGllcygpOgogICAgIiIiUmV0dXJuIHN1cHBvcnRlZCBlbnRpdGllcyBmcm9tIHRoZSBBbmFseXplciBFbmdpbmUuCiAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2Ygc3VwcG9ydGVkIGVudGl0aWVzLgogICAgIiIiCiAgICByZXR1cm4gYW5hbHl6ZXJfZW5naW5lKCkuZ2V0X3N1cHBvcnRlZF9lbnRpdGllcygpCgoKZGVmIGFuYWx5emUoKiprd2FyZ3MpOgogICAgIiIiQW5hbHl6ZSBpbnB1dCB1c2luZyBBbmFseXplciBlbmdpbmUgYW5kIGlucHV0IGFyZ3VtZW50cyAoa3dhcmdzKS4KICAgIDpwYXJhbSBrd2FyZ3M6IFRoZSBpbnB1dCBhcmd1bWVudHMgZm9yIHRoZSBhbmFseXplciBlbmdpbmUuCiAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIHRoZSByZWNvZ25pemVkCiAgICAiIiIKICAgIGlmICJlbnRpdGllcyIgbm90IGluIGt3YXJncyBvciAiQWxsIiBpbiBrd2FyZ3NbImVudGl0aWVzIl06CiAgICAgICAga3dhcmdzWyJlbnRpdGllcyJdID0gTm9uZQogICAgcmV0dXJuIGFuYWx5emVyX2VuZ2luZSgpLmFuYWx5emUoKiprd2FyZ3MpCgoKZGVmIGFub255bWl6ZSh0ZXh0LCBhbmFseXplX3Jlc3VsdHMpOgogICAgIiIiQW5vbnltaXplIGlkZW50aWZpZWQgaW5wdXQgdXNpbmcgUHJlc2lkaW8gQWJvbnltaXplci4KICAgIDpwYXJhbSB0ZXh0OiBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gYW5hbHl6ZV9yZXN1bHRzOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20KICAgIDpyZXR1cm5zOiBUaGUgYW5vbnltaXplZCB0ZXh0LgogICAgIiIiCiAgICBpZiBub3QgdGV4dDoKICAgICAgICByZXR1cm4KICAgIHJlcyA9IGFub255bWl6ZXJfZW5naW5lKCkuYW5vbnltaXplKHRleHQsIGFuYWx5emVfcmVzdWx0cykKICAgIHJldHVybiByZXMudGV4dAoKCmRlZiBhbm5vdGF0ZSh0ZXh0LCBzdF9hbmFseXplX3Jlc3VsdHMsIHN0X2VudGl0aWVzKToKICAgICIiIkFubm90YXRlIGlkZW50aWZpZWQgaW5wdXQgdXNpbmcgUHJlc2lkaW8gQW5vbnltaXplci4KICAgIDpwYXJhbSB0ZXh0OiBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gc3RfYW5hbHl6ZV9yZXN1bHRzOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20KICAgIDpyZXR1cm5zOiBUaGUgbGlzdCBvZiB0b2tlbnMgd2l0aCB0aGUgaWRlbnRpZmllZCBlbnRpdGllcy4KCiAgICAiIiIKICAgIHRva2VucyA9IFtdCiAgICAjIHNvcnQgYnkgc3RhcnQgaW5kZXgKICAgIHJlc3VsdHMgPSBzb3J0ZWQoc3RfYW5hbHl6ZV9yZXN1bHRzLCBrZXk9bGFtYmRhIHg6IHguc3RhcnQpCiAgICBmb3IgaSwgcmVzIGluIGVudW1lcmF0ZShyZXN1bHRzKToKICAgICAgICBpZiBpID09IDA6CiAgICAgICAgICAgIHRva2Vucy5hcHBlbmQodGV4dFs6IHJlcy5zdGFydF0pCgogICAgICAgICMgYXBwZW5kIGVudGl0eSB0ZXh0IGFuZCBlbnRpdHkgdHlwZQogICAgICAgIHRva2Vucy5hcHBlbmQoKHRleHRbcmVzLnN0YXJ0IDogcmVzLmVuZF0sIHJlcy5lbnRpdHlfdHlwZSkpCgogICAgICAgICMgaWYgYW5vdGhlciBlbnRpdHkgY29taW5nIGkuZS4gd2UncmUgbm90IGF0IHRoZSBsYXN0IHJlc3VsdHMgZWxlbWVudCwKICAgICAgICAjIGFkZCB0ZXh0IHVwIHRvIG5leHQgZW50aXR5CiAgICAgICAgaWYgaSAhPSBsZW4ocmVzdWx0cykgLSAxOgogICAgICAgICAgICB0b2tlbnMuYXBwZW5kKHRleHRbcmVzLmVuZCA6IHJlc3VsdHNbaSArIDFdLnN0YXJ0XSkKICAgICAgICAjIGlmIG5vIG1vcmUgZW50aXRpZXMgY29taW5nLCBhZGQgYWxsIHJlbWFpbmluZyB0ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgdG9rZW5zLmFwcGVuZCh0ZXh0W3Jlcy5lbmQgOl0pCiAgICByZXR1cm4gdG9rZW5zCgoKY2xhc3MgQ3VzdG9tRW5jb2RlcihKU09ORW5jb2Rlcik6CiAgICAiIiJDdXN0b20gZW5jb2RlciBmb3IgSlNPTkVuY29kZXIuCiAgICA6cGFyYW0gSlNPTkVuY29kZXI6IFRoZSBKU09ORW5jb2Rlci4KICAgIDpyZXR1cm5zOiBUaGUgSlNPTkVuY29kZXIuCiAgICAiIiIKCiAgICBkZWYgZGVmYXVsdChzZWxmLCBvKToKICAgICAgICByZXR1cm4gby5fX2RpY3RfXwoKCmRlZiBwcm9jZXNzKHRleHQ6IHN0ciwgbW9kZWw6IEFuYWx5emVyRW5naW5lKToKICAgICIiIgogICAgUHJvY2VzcyB0aGUgdGV4dCBvZiBzdHIgdXNpbmcgdGhlIG1vZGVsLgogICAgOnBhcmFtIHR4dDogVGV4dCB0byBwcm9jZXNzCiAgICA6cGFyYW0gbW9kZWw6IE1vZGVsIHRvIHVzZSBmb3IgcHJvY2Vzc2luZwogICAgOnJldHVybnM6IFRoZSBhbm9ueW1pemVkIHRleHQsIHRoZSBodG1sIHN0cmluZyBhbmQgdGhlIHN0YXRzIHJlcG9ydC4KICAgICIiIgogICAgYW5hbHl6ZXIgPSBtb2RlbAogICAgcmVzdWx0cyA9IGFuYWx5emVyLmFuYWx5emUoCiAgICAgICAgdGV4dD10ZXh0LAogICAgICAgIGxhbmd1YWdlPSJlbiIsCiAgICAgICAgZW50aXRpZXM9Z2V0X3N1cHBvcnRlZF9lbnRpdGllcygpLAogICAgICAgIHJldHVybl9kZWNpc2lvbl9wcm9jZXNzPVRydWUsCiAgICApCiAgICBhbm9ueW1pemVkX3RleHQgPSBhbm9ueW1pemUodGV4dCwgcmVzdWx0cykKCiAgICBhbm5vdGF0ZWRfdG9rZW5zID0gYW5ub3RhdGUodGV4dCwgcmVzdWx0cywgZ2V0X3N1cHBvcnRlZF9lbnRpdGllcygpKQogICAgaHRtbCA9IGdldF9hbm5vdGF0ZWRfaHRtbCgqYW5ub3RhdGVkX3Rva2VucykKICAgIGJhY2tzbGFzaF9jaGFyID0gIlxcIgoKICAgIGh0bWxfc3RyID0gZiI8cD57aHRtbC5yZXBsYWNlKCd7YmFja3NsYXNoX2NoYXJ9bicsICc8YnI+Jyl9PC9wPiIKCiAgICBzdGF0cyA9IHJlc3VsdHMKCiAgICByZXR1cm4gYW5vbnltaXplZF90ZXh0LCBodG1sX3N0ciwgc3RhdHMKCgpkZWYgcGlpX3JlY29nbml6ZSgKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgbW9kZWw6IHN0ciwKICAgIGlucHV0X3BhdGg6IHN0ciwKICAgIG91dHB1dF9wYXRoOiBzdHIsCiAgICBvdXRwdXRfc3VmZml4OiBzdHIsCiAgICBodG1sX2tleTogc3RyLAogICAgcnB0X2tleTogc3RyLAopIC0+IHN0cjoKICAgICIiIgogICAgUmVjb2duaXplIFBJSSBpbiB0ZXh0LgogICAgOnBhcmFtIGNvbnRleHQ6IFRoZSBNTFJ1biBjb250ZXh0LgogICAgOnBhcmFtIG1vZGVsOiBUaGUgbW9kZWwgdG8gdXNlLiBDYW4gYmUgInNwYWN5IiwgImZsYWlyIiwgInBhdHRlcm4iIG9yICJ3aG9sZSIuCiAgICA6cGFyYW0gaW5wdXRfcGF0aDogVGhlIGlucHV0IHBhdGggdG8gdGhlIGFydGlmYWN0LgogICAgOnBhcmFtIG91dHB1dF9wYXRoOiBUaGUgb3V0cHV0IHBhdGggdG8gc3RvcmUgdGhlIGFub255bWl6ZWQgdGV4dC4KICAgIDpwYXJhbSBvdXRwdXRfc3VmZml4OiBUaGUgc3VyZml4IG9mIG91dHB1dCBrZXkgZm9yIHRoZSBhbm9ueW1pemVkIHRleHQuIGZvciBleGFtcGxlIGlmIHRoZSBpbnB1dCBmaWxlIGlzIHBpaS50eHQsIHRoZSBvdXRwdXQga2V5IHdpbGwgYmUgcGlpX2Fub255bWl6ZWQudHh0LgogICAgOnBhcmFtIGh0bWxfa2V5OiBUaGUgaHRtbCBrZXkgZm9yIHRoZSBhcnRpZmFjdC4KICAgIDpwYXJhbSBycHRfa2V5OiBUaGUgcmVwb3J0IGtleSBmb3IgdGhlIGFydGlmYWN0LgogICAgOnJldHVybnM6IG91dHB1dF9wYXRoCiAgICAiIiIKICAgIGlmIG5vdCBvdXRwdXRfcGF0aDoKICAgICAgICBvdXRwdXRfcGF0aCA9IGlucHV0X3BhdGggKyAiL291dHB1dC8iCiAgICBhbmFseXplciA9IGFuYWx5emVyX2VuZ2luZShtb2RlbCkKICAgIHR4dF9maWxlX3BhdGhzLCB0eHRfZmlsZV9uYW1lcyA9IGdldF90ZXh0X2ZpbGVzKGlucHV0X3BhdGgpCiAgICBodG1sX2luZGV4ID0gIjxodG1sPjxoZWFkPjx0aXRsZT5IaWdobGlnaHRlZCBQaWkgRW50aXRpZXM8L3RpdGxlPjwvaGVhZD48Ym9keT48aDE+SGlnaGxpZ2h0ZWQgUGlpIEVudGl0aWVzPC9oMT48dWw+IgogICAgaHRtbF9jb250ZW50ID0gIiIKICAgIHJwdF9qc29uID0ge30KICAgIGZvciBmaWxlX3BhdGgsIGZpbGVfbmFtZSBpbiB6aXAodHh0X2ZpbGVfcGF0aHMsIHR4dF9maWxlX25hbWVzKToKICAgICAgICB0ZXh0ID0gbWxydW4uZ2V0X2RhdGFpdGVtKGZpbGVfcGF0aCkuZ2V0KCkuZGVjb2RlKCJ1dGYtOCIpCiAgICAgICAgYW5vbnltaXplZF90ZXh0LCBodG1sX3N0ciwgc3RhdHMgPSBwcm9jZXNzKHRleHQsIGFuYWx5emVyKQogICAgICAgIGh0bWxfaW5kZXggKz0gZic8bGk+PGEgaHJlZj0iI3tmaWxlX25hbWV9Ij57ZmlsZV9uYW1lfTwvYT48L2xpPicKICAgICAgICBodG1sX2NvbnRlbnQgKz0gZic8aDIgaWQ9IntmaWxlX25hbWV9Ij57ZmlsZV9uYW1lfTwvaDI+e2h0bWxfc3RyfScKICAgICAgICB3aXRoIG9wZW4oZiJ7b3V0cHV0X3BhdGh9L3tmaWxlX25hbWV9X3tvdXRwdXRfc3VmZml4fS50eHQiLCAidyIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoYW5vbnltaXplZF90ZXh0KQogICAgICAgIG5ld19zdGF0cyA9IFtdCiAgICAgICAgZm9yIGl0ZW0gaW4gc3RhdHM6CiAgICAgICAgICAgIGl0ZW0uYW5hbHlzaXNfZXhwbGFuYXRpb24gPSBpdGVtLmFuYWx5c2lzX2V4cGxhbmF0aW9uLnRvX2RpY3QoKQogICAgICAgICAgICBuZXdfc3RhdHMuYXBwZW5kKGl0ZW0udG9fZGljdCgpKQogICAgICAgIHJwdF9qc29uW2ZpbGVfbmFtZV0gPSBuZXdfc3RhdHMKICAgIGh0bWxfaW5kZXggKz0gIjwvdWw+IgogICAgaHRtbF9yZXMgPSBmIntodG1sX2luZGV4fXtodG1sX2NvbnRlbnR9PC9ib2R5PjwvaHRtbD4iCiAgICBhcnRpX2h0bWwgPSBBcnRpZmFjdChib2R5PWh0bWxfcmVzLCBmb3JtYXQ9Imh0bWwiLCBrZXk9aHRtbF9rZXkpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChhcnRpX2h0bWwpCiAgICByZXR1cm4gcnB0X2pzb24sIG91dHB1dF9wYXRoCgoKZGVmIGdldF90ZXh0X2ZpbGVzKHBhdGgpOgogICAgIiIiCiAgICBHZXQgYSBsaXN0IG9mIHRleHQgZmlsZSBwYXRocyBmcm9tIGEgZ2l2ZW4gcGF0aC4KICAgIDpwYXJhbSBwYXRoOiBUaGUgcGF0aCB0byB3YWxrIHRocm91Z2guCiAgICA6cmV0dXJuczogQSBsaXN0IG9mIHRleHQgZmlsZSBwYXRocyBhbmQgbGlzdCBvZiBmaWxlIG5hbWVzLgogICAgIiIiCiAgICB0eHRfZmlsZV9sc3QgPSBbXQogICAgdHh0X2ZpbGVfbmFtZXMgPSBbXQogICAgZm9yIHJvb3QsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsocGF0aCk6CiAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgIGlmIGZpbGUuZW5kc3dpdGgoIi50eHQiKToKICAgICAgICAgICAgICAgIHR4dF9maWxlX2xzdC5hcHBlbmQob3MucGF0aC5qb2luKHJvb3QsIGZpbGUpKQogICAgICAgICAgICAgICAgdHh0X2ZpbGVfbmFtZXMuYXBwZW5kKGZpbGVbOi00XSkKICAgICAgICBicmVhawogICAgcmV0dXJuIHR4dF9maWxlX2xzdCwgdHh0X2ZpbGVfbmFtZXMK
    base_image: mlrun/mlrun
    commands: []
    code_origin: git@github.com-personal:pengwei715/pii_masker.git#6b594824a47b9c07be2a4801244427be4468010c:pii_recognizer.py
    origin_filename: pii_recognizer.py
    requirements:
    - mlrun==1.4.0-rc19
    - pandas
    - presidio-anonymizer
    - presidio-analyzer
    - torch
    - flair@git+https://github.com/flairNLP/flair.git@d4ed67bf663e4066517f00397412510d90043653
    - st-annotated-text
    - https://huggingface.co/beki/en_spacy_pii_distilbert/resolve/main/en_spacy_pii_distilbert-any-py3-none-any.whl
  entry_points:
    create_pattern_recognizer:
      name: create_pattern_recognizer
      doc: ''
      parameters: []
      outputs:
      - default: ''
      lineno: 39
    load:
      name: load
      doc: Load the model, not used. Model is loaded during initialization.
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 297
    get_supported_entities:
      name: get_supported_entities
      doc: Return supported entities from the Analyzer Engine.
      parameters: []
      outputs:
      - default: ''
        doc: The list of supported entities.
      lineno: 438
    build_spacy_explanation:
      name: build_spacy_explanation
      doc: Create explanation for why this result was detected.
      parameters:
      - name: self
        default: ''
      - name: original_score
        type: float
        doc: Score given by this recognizer
        default: ''
      - name: explanation
        type: str
        doc: Explanation string
        default: ''
      outputs:
      - default: ''
        doc: AnalysisExplanation object
        type: AnalysisExplanation
      lineno: 123
    analyze:
      name: analyze
      doc: Analyze input using Analyzer engine and input arguments (kwargs).
      parameters: []
      outputs:
      - default: ''
        doc: The list of Presidio RecognizerResult constructed from the recognized
      lineno: 445
    build_flair_explanation:
      name: build_flair_explanation
      doc: Create explanation for why this result was detected.
      parameters:
      - name: self
        default: ''
      - name: original_score
        type: float
        doc: Score given by this recognizer
        default: ''
      - name: explanation
        type: str
        doc: Explanation string
        default: ''
      outputs:
      - default: ''
        doc: AnalysisExplanation
        type: AnalysisExplanation
      lineno: 372
    analyzer_engine:
      name: analyzer_engine
      doc: Return AnalyzerEngine.
      parameters:
      - name: model
        doc: The model to use. Can be "spacy", "flair", "pattern" or "whole".
        default: whole
      outputs:
      - default: ''
        doc: AnalyzerEngine
      lineno: 397
    anonymizer_engine:
      name: anonymizer_engine
      doc: Return AnonymizerEngine.
      parameters: []
      outputs:
      - default: ''
        doc: The AnonymizerEngine.
      lineno: 431
    anonymize:
      name: anonymize
      doc: Anonymize identified input using Presidio Abonymizer.
      parameters:
      - name: text
        doc: The text for analysis.
        default: ''
      - name: analyze_results
        doc: The list of Presidio RecognizerResult constructed from
        default: ''
      outputs:
      - default: ''
        doc: The anonymized text.
      lineno: 455
    annotate:
      name: annotate
      doc: Annotate identified input using Presidio Anonymizer.
      parameters:
      - name: text
        doc: The text for analysis.
        default: ''
      - name: st_analyze_results
        doc: The list of Presidio RecognizerResult constructed from
        default: ''
      - name: st_entities
        default: ''
      outputs:
      - default: ''
        doc: The list of tokens with the identified entities.
      lineno: 467
    default:
      name: default
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: o
        default: ''
      outputs:
      - default: ''
      lineno: 500
    process:
      name: process
      doc: Process the text of str using the model.
      parameters:
      - name: text
        type: str
        default: ''
      - name: model
        type: AnalyzerEngine
        doc: Model to use for processing
        default: ''
      outputs:
      - default: ''
        doc: The anonymized text, the html string and the stats report.
      lineno: 504
    pii_recognize:
      name: pii_recognize
      doc: Recognize PII in text.
      parameters:
      - name: context
        type: MLClientCtx
        doc: The MLRun context.
        default: ''
      - name: model
        type: str
        doc: The model to use. Can be "spacy", "flair", "pattern" or "whole".
        default: ''
      - name: input_path
        type: str
        doc: The input path to the artifact.
        default: ''
      - name: output_path
        type: str
        doc: The output path to store the anonymized text.
        default: ''
      - name: output_suffix
        type: str
        doc: The surfix of output key for the anonymized text. for example if the
          input file is pii.txt, the output key will be pii_anonymized.txt.
        default: ''
      - name: html_key
        type: str
        doc: The html key for the artifact.
        default: ''
      - name: rpt_key
        type: str
        doc: The report key for the artifact.
        default: ''
      outputs:
      - default: ''
        doc: output_path
        type: str
      lineno: 531
    get_text_files:
      name: get_text_files
      doc: Get a list of text file paths from a given path.
      parameters:
      - name: path
        doc: The path to walk through.
        default: ''
      outputs:
      - default: ''
        doc: A list of text file paths and list of file names.
      lineno: 577
  description: This function is used to recognize PII in a given text
  default_handler: pii_recognize
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
