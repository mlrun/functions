kind: remote
metadata:
  name: sklearn-server
  tag: latest
  hash: 1cc380a46fd33203e97d67b75560fd4f5424f160
  project: default
  labels:
    author: yaronh
  categories:
  - serving
  - models
spec:
  command: ''
  args: []
  image: ''
  description: generic sklearn model server
  env:
  - name: MODEL_CLASS
    value: ClassifierModel
  - name: ENABLE_EXPLAINER
    value: 'False'
  config:
    spec.triggers.http:
      kind: http
      maxWorkers: 8
      attributes:
        ingresses: {}
      annotations: {}
  base_spec:
    apiVersion: nuclio.io/v1
    kind: nuclio:serving
    metadata:
      annotations:
        nuclio.io/generated_by: function generated at 26-04-2020 by admin from /User/repos/functions/model_server/model_server.ipynb
      labels: {}
      name: sklearn-server
    spec:
      build:
        baseImage: mlrun/ml-models:0.4.6
        commands:
        - python -m pip install -U kfserving
        - python -m pip install v3io
        functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTI2IDEwOjE3CgppbXBvcnQgb3MKZnJvbSBjbG91ZHBpY2tsZSBpbXBvcnQgbG9hZAppbXBvcnQga2ZzZXJ2aW5nCmltcG9ydCBudW1weSBhcyBucApmcm9tIHR5cGluZyBpbXBvcnQgTGlzdApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQoKaW1wb3J0IGpzb24KaW1wb3J0IHNvY2tldAppbXBvcnQgdjNpby5kYXRhcGxhbmUKCnYzaW9fY2xpZW50ID0gdjNpby5kYXRhcGxhbmUuQ2xpZW50KCkKaG9zdG5hbWUgPSBOb25lCgpkZWYgc3BsaXRfcGF0aChtbnRwYXRoPScnKToKICAgIGlmIG1udHBhdGhbMF0gPT0gJy8nOgogICAgICAgIG1udHBhdGggPSBtbnRwYXRoWzE6XQogICAgcGF0aHMgPSBtbnRwYXRoLnNwbGl0KCcvJykKICAgIGNvbnRhaW5lciA9IHBhdGhzWzBdCiAgICBzdWJwYXRoID0gJycKICAgIGlmIGxlbihwYXRocykgPiAxOgogICAgICAgIHN1YnBhdGggPSBtbnRwYXRoW2xlbihjb250YWluZXIpOl0KICAgIHJldHVybiBjb250YWluZXIsIHN1YnBhdGgKIAoKZGVmIGluaXRfc3RyZWFtKHN0cmVhbV9wYXRoLCBzaGFyZHM9MSk6CiAgICBnbG9iYWwgaG9zdG5hbWUKICAgIGhvc3RuYW1lID0gc29ja2V0LmdldGhvc3RuYW1lKCkKICAgIGNvbnRhaW5lciwgc3RyZWFtX3BhdGggPSBzcGxpdF9wYXRoKHN0cmVhbV9wYXRoKQogICAgcmVzcG9uc2UgPSB2M2lvX2NsaWVudC5jcmVhdGVfc3RyZWFtKGNvbnRhaW5lcj1jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0aD1zdHJlYW1fcGF0aCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmRfY291bnQ9c2hhcmRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX2Zvcl9zdGF0dXM9djNpby5kYXRhcGxhbmUuUmFpc2VGb3JTdGF0dXMubmV2ZXIpCiAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKFs0MDksIDIwNF0pCiAgICBwcmludChyZXNwb25zZS5fX2RpY3RfXykKICAgIApkZWYgcHVzaF90b19zdHJlYW0oc3RyZWFtX3BhdGgsIGRhdGEpOgogICAgcmVjb3JkcyA9IFt7J2RhdGEnOiBqc29uLmR1bXBzKHJlYyl9IGZvciByZWMgaW4gZGF0YV0KICAgIGNvbnRhaW5lciwgc3RyZWFtX3BhdGggPSBzcGxpdF9wYXRoKHN0cmVhbV9wYXRoKQogICAgcmVzcG9uc2UgPSB2M2lvX2NsaWVudC5wdXRfcmVjb3Jkcyhjb250YWluZXI9Y29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoPXN0cmVhbV9wYXRoLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3Jkcz1yZWNvcmRzKQogICAgCgpjbGFzcyBDbGFzc2lmaWVyTW9kZWwoa2ZzZXJ2aW5nLktGTW9kZWwpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWU6IHN0ciwgbW9kZWxfZGlyOiBzdHIsIGNsYXNzaWZpZXIgPSBOb25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKG5hbWUpCiAgICAgICAgc2VsZi5tb2RlbF9kaXIgPSBtb2RlbF9kaXIKICAgICAgICBzZWxmLmxvZ19zdHJlYW0gPSBvcy5lbnZpcm9uLmdldCgnSU5GRVJFTkNFX1NUUkVBTScsICcnKQogICAgICAgIGlmIHNlbGYubG9nX3N0cmVhbToKICAgICAgICAgICAgaW5pdF9zdHJlYW0oc2VsZi5sb2dfc3RyZWFtKQogICAgICAgIGlmIGNsYXNzaWZpZXI6CiAgICAgICAgICAgIHNlbGYuY2xhc3NpZmllciA9IGNsYXNzaWZpZXIKICAgICAgICAgICAgc2VsZi5yZWFkeSA9IFRydWUKCiAgICBkZWYgbG9hZChzZWxmKToKICAgICAgICAiIiJMb2FkIG1vZGVsIGZyb20gS3ViZUZsb3cgc3RvcmFnZS4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLm1vZGVsX2Rpci5lbmRzd2l0aCgnLnBrbCcpOgogICAgICAgICAgICBtb2RlbF9maWxlID0gc2VsZi5tb2RlbF9kaXIKICAgICAgICBlbHNlOgogICAgICAgICAgICBmb3IgZmlsZSBpbiBvcy5wYXRoLmxpc3RkaXIoc2VsZi5tb2RlbF9kaXIpOgogICAgICAgICAgICAgICAgaWYgZmlsZS5lbmRzd2l0aCgnLnBrbCcpOgogICAgICAgICAgICAgICAgICAgIG1vZGVsX2ZpbGUgPSBvcy5wdGguam9pbihzZWxmLm1vZGVsX2RpciwgZmlsZSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIHNlbGYuY2xhc3NpZmllciA9IGxvYWQob3Blbihtb2RlbF9maWxlLCAncmInKSkKICAgICAgICBzZWxmLnJlYWR5ID0gVHJ1ZQoKICAgIGRlZiBwcmVkaWN0KHNlbGYsIGJvZHk6IGRpY3QpIC0+IExpc3Q6CiAgICAgICAgIiIiR2VuZXJhdGUgbW9kZWwgcHJlZGljdGlvbnMgZnJvbSBzYW1wbGUuCiAgICAgICAgCiAgICAgICAgOnBhcmFtIGJvZHkgOiBBIGRpY3Qgb2Ygb2JzZXJ2YXRpb25zLCBlYWNoIG9mIHdoaWNoIGlzIGFuIDEtZGltZW5zaW9uYWwgZmVhdHVyZSB2ZWN0b3IuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnMgbW9kZWwgcHJlZGljdGlvbnMgYXMgYSBgTGlzdGAsIG9uZSBmb3IgZWFjaCByb3cgaW4gdGhlIGBib2R5YCBpbnB1dCBgTGlzdGAuCiAgICAgICAgIiIiCiAgICAgICAgc3RhcnQgPSBkYXRldGltZS5ub3coKQogICAgICAgIHRyeToKICAgICAgICAgICAgZmVhdHMgPSBucC5hc2FycmF5KGJvZHlbJ2luc3RhbmNlcyddKQogICAgICAgICAgICByZXN1bHQ6IG5wLm5kYXJyYXkgPSBzZWxmLmNsYXNzaWZpZXIucHJlZGljdChmZWF0cykKICAgICAgICAgICAgcmVzcCA9IHJlc3VsdC50b2xpc3QoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGYiRmFpbGVkIHRvIHByZWRpY3Qge2V9IikKICAgICAgICAKICAgICAgICBpZiBzZWxmLmxvZ19zdHJlYW06CiAgICAgICAgICAgIGRhdGEgPSB7J3JlcXVlc3QnOiBib2R5LCAncmVzcCc6IHJlc3AsIAogICAgICAgICAgICAgICAgICAgICdjbGFzcyc6ICdDbGFzc2lmaWVyTW9kZWwnLCAKICAgICAgICAgICAgICAgICAgICAnbW9kZWwnOiBzZWxmLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgJ2hvc3QnOiBob3N0bmFtZSwKICAgICAgICAgICAgICAgICAgICAnd2hlbic6IHN0cihzdGFydCksIAogICAgICAgICAgICAgICAgICAgICdtaWNyb3NlYyc6IChkYXRldGltZS5ub3coKS1zdGFydCkubWljcm9zZWNvbmRzfQogICAgICAgICAgICBwdXNoX3RvX3N0cmVhbShzZWxmLmxvZ19zdHJlYW0sIFtkYXRhXSkKCiAgICAgICAgcmV0dXJuIHJlc3AKCgpmcm9tIG1scnVuLnJ1bnRpbWVzIGltcG9ydCBudWNsaW9faW5pdF9ob29rCmRlZiBpbml0X2NvbnRleHQoY29udGV4dCk6CiAgICBudWNsaW9faW5pdF9ob29rKGNvbnRleHQsIGdsb2JhbHMoKSwgJ3NlcnZpbmcnKQoKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgogICAgcmV0dXJuIGNvbnRleHQubWxydW5faGFuZGxlcihjb250ZXh0LCBldmVudCkK
        noBaseImagesPull: true
      env:
      - name: MODEL_CLASS
        value: ClassifierModel
      handler: model_server:handler
      runtime: python:3.6
      volumes: []
  source: ''
  function_kind: serving
