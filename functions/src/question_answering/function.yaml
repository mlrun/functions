spec:
  default_handler: answer_questions
  entry_points:
    open_mpi_handler:
      has_varargs: false
      has_kwargs: false
      lineno: 58
      doc: ''
      parameters:
      - name: worker_inputs
        type: list[str]
      - name: root_worker_inputs
        type: dict[str, Any]
        default: null
      name: open_mpi_handler
    decorator:
      has_varargs: false
      has_kwargs: false
      lineno: 66
      doc: ''
      parameters:
      - name: handler
      name: decorator
    wrapper:
      has_varargs: false
      has_kwargs: true
      lineno: 71
      doc: ''
      name: wrapper
    answer_questions:
      has_varargs: false
      has_kwargs: false
      outputs:
      - doc: 'A tuple of:'
        type: tuple[pd.DataFrame, dict]
      lineno: 130
      doc: 'Answer questions with a context to the given text files contents by a
        pretrained LLM model. Each text file will have

        the following prompt built:


        start of `text_wrapper`

        <text file content>

        end of `text_wrapper`


        start of `questions_wrapper`

        1. <questions[0]>

        2. <questions[1]>

        ...

        n. <questions[n-1]>

        end of `questions_wrapper`'
      parameters:
      - name: data_path
        doc: A path to a directory of text files or a path to a text file to ask questions
          about.
      - name: model_name
        type: str
        doc: The pre-trained model name from the huggingface hub to use for asking
          questions.
      - name: questions
        doc: The questions to ask. A list of lists of questions to ask per text file,
          and devided by question groups, the groups can be dtermained by size (in
          order to avoid large inputs to the llm) or by questioning method (regular
          or poll like questioning).
      - name: device_map
        doc: A map to use for loading the model on multiple devices.
        default: null
      - name: model_kwargs
        type: dict
        doc: Keyword arguments to pass for loading the model using HuggingFace's `transformers.AutoModelForCausalLM.from_pretrained`
          function.
        default: null
      - name: auto_gptq_exllama_max_input_length
        type: int
        doc: For AutoGPTQ models to set and extend the model's input buffer size.
        default: null
      - name: tokenizer_name
        type: str
        doc: The tokenizer name from the huggingface hub to use. If not given, the
          model name will be used.
        default: null
      - name: tokenizer_kwargs
        type: dict
        doc: Keyword arguments to pass for loading the tokenizer using HuggingFace's
          `transformers.AutoTokenizer.from_pretrained` function.
        default: null
      - name: text_wrapper
        doc: A wrapper for the file's text. Will be added at the start of the prompt.
          Must have a placeholder ('{}') for the text of the file.
        default: ''
      - name: questions_wrapper
        doc: A wrapper for the questions received. Will be added after the text wrapper
          in the prompt template. Must have a placeholder ('{}') for the questions.
        default: ''
      - name: generation_config
        doc: HuggingFace's `GenerationConfig` keyword arguments to pass to the `generate`
          method.
        default: null
      - name: questions_config
        doc: A dictionary or list of dictionaries containing specific ways to answer
          questions (using a poll for example), each dictionary in the list is for
          corresponding question group and determines the question asking method for
          said group.
        default: null
      - name: batch_size
        type: int
        doc: Batch size for inference.
        default: 1
      - name: questions_columns
        type: list[str]
        doc: Columns to use for the dataframe returned.
        default: null
      - name: verbose
        type: bool
        doc: 'Whether to present logs of a progress bar and errors. Default: True.'
        default: false
      name: answer_questions
    answer:
      has_varargs: false
      has_kwargs: false
      outputs:
      - type: list[list[str]]
      lineno: 665
      doc: Answer questions with a context to the given text files contents by a pretrained
        LLM model in given pipeline.
      parameters:
      - name: self
      - name: questions_amount
        type: int
      - name: batched_input
        type: list[str]
      - name: generation_pipeline
        type: Pipeline
      - name: generation_config
        type: GenerationConfig
      name: answer
    most_common:
      has_varargs: false
      has_kwargs: false
      lineno: 629
      doc: Calculate the most common answer for a given list of answers.
      parameters:
      - name: answers
      name: most_common
    average:
      has_varargs: false
      has_kwargs: false
      lineno: 638
      doc: Calculate the average answer for a given list of answers.
      parameters:
      - name: answers
      name: average
    do:
      has_varargs: false
      has_kwargs: false
      lineno: 654
      doc: Perform the strategy.
      parameters:
      - name: self
      - name: answers
      name: do
  image: ''
  disable_auto_mount: false
  description: GenAI approach of question answering on a given data
  build:
    code_origin: ''
    origin_filename: ''
    base_image: mlrun/mlrun
    requirements:
    - transformers
    - torch
    - tqdm
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAojCiMgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQojIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiMgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiMgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAojIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgppbXBvcnQgZW51bQppbXBvcnQgbG9nZ2luZwppbXBvcnQgb3BlcmF0b3IKaW1wb3J0IHBhdGhsaWIKZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgQ291bnRlcgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgcmVkdWNlLCB3cmFwcwpmcm9tIHR5cGluZyBpbXBvcnQgQW55CgppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCB0cmFuc2Zvcm1lcnMKZnJvbSB0cWRtIGltcG9ydCB0cWRtCgojIEdldCB0aGUgZ2xvYmFsIGxvZ2dlcjoKX0xPR0dFUiA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCkKCgpkZWYgX2NoZWNrX21scnVuX2FuZF9vcGVuX21waSgpIC0+IHR1cGxlWyJtbHJ1bi5NTENsaWVudEN0eCIsICJtcGk0cHkuTVBJLkludHJhY29tbSJdOgogICAgZ2xvYmFsIF9MT0dHRVIKCiAgICBpc19tcGkgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIGltcG9ydCBtbHJ1bgoKICAgICAgICBjb250ZXh0ID0gbWxydW4uZ2V0X29yX2NyZWF0ZV9jdHgobmFtZT0ibWxydW4iKQogICAgICAgIF9MT0dHRVIgPSBjb250ZXh0LmxvZ2dlcgogICAgICAgIGlzX21waSA9IGNvbnRleHQubGFiZWxzLmdldCgia2luZCIsICJqb2IiKSA9PSAibXBpam9iIgoKICAgICAgICBpZiBpc19tcGk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZyb20gbXBpNHB5IGltcG9ydCBNUEkKCiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dCwgTVBJLkNPTU1fV09STEQKICAgICAgICAgICAgZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3IgYXMgbXBpNHB5X25vdF9mb3VuZDoKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmVycm9yKAogICAgICAgICAgICAgICAgICAgICJUbyBkaXN0cmlidXRlIHRoZSBmdW5jdGlvbiB1c2luZyBNTFJ1bidzICdtcGlqb2InIHlvdSBuZWVkIHRvIGhhdmUgYG1waTRweWAgcGFja2FnZSBpbiB5b3VyICIKICAgICAgICAgICAgICAgICAgICAiaW50ZXJwcmV0ZXIuIFBsZWFzZSBydW4gYHBpcCBpbnN0YWxsIG1waTRweWAgYW5kIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvcGVuLW1waS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByYWlzZSBtcGk0cHlfbm90X2ZvdW5kCiAgICBleGNlcHQgTW9kdWxlTm90Rm91bmRFcnJvciBhcyBtb2R1bGVfbm90X2ZvdW5kOgogICAgICAgIGlmIGlzX21waToKICAgICAgICAgICAgcmFpc2UgbW9kdWxlX25vdF9mb3VuZAogICAgcmV0dXJuIE5vbmUsIE5vbmUKCgpkZWYgb3Blbl9tcGlfaGFuZGxlcigKICAgIHdvcmtlcl9pbnB1dHM6IGxpc3Rbc3RyXSwgcm9vdF93b3JrZXJfaW5wdXRzOiBkaWN0W3N0ciwgQW55XSA9IE5vbmUKKToKICAgIGdsb2JhbCBfTE9HR0VSCgogICAgIyBDaGVjayBmb3IgTUxSdW4gYW5kIE9wZW5NUEkgYXZhaWxhYmlsaXR5OgogICAgY29udGV4dCwgY29tbSA9IF9jaGVja19tbHJ1bl9hbmRfb3Blbl9tcGkoKQoKICAgIGRlZiBkZWNvcmF0b3IoaGFuZGxlcik6CiAgICAgICAgaWYgY29tbSBpcyBOb25lIG9yIGNvbW0uR2V0X3NpemUoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gaGFuZGxlcgoKICAgICAgICBAd3JhcHMoaGFuZGxlcikKICAgICAgICBkZWYgd3JhcHBlcigqKmt3YXJncyk6CiAgICAgICAgICAgICMgR2V0IHRoZSBvcGVuIG1waSBlbnZpcm9ubWVudCBwcm9wZXJ0aWVzOgogICAgICAgICAgICBzaXplID0gY29tbS5HZXRfc2l6ZSgpCiAgICAgICAgICAgIHJhbmsgPSBjb21tLkdldF9yYW5rKCkKCiAgICAgICAgICAgICMgR2l2ZSB0aGUgY29ycmVjdCBjaHVuayBvZiB0aGUgd29ya2VycyBpbnB1dHM6CiAgICAgICAgICAgIGZvciB3b3JrZXJfaW5wdXQgaW4gd29ya2VyX2lucHV0czoKICAgICAgICAgICAgICAgIGlucHV0X2FyZ3VtZW50ID0ga3dhcmdzW3dvcmtlcl9pbnB1dF0KICAgICAgICAgICAgICAgIGlmIGlucHV0X2FyZ3VtZW50IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaW5wdXRfYXJndW1lbnQsIHN0cik6CiAgICAgICAgICAgICAgICAgICAgaW5wdXRfYXJndW1lbnQgPSBfZ2V0X3RleHRfZmlsZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFfcGF0aD1wYXRobGliLlBhdGgoaW5wdXRfYXJndW1lbnQpLmFic29sdXRlKCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBsZW4oaW5wdXRfYXJndW1lbnQpIDwgc2l6ZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICBmIkNhbm5vdCBzcGxpdCB0aGUgaW5wdXQgJ3t3b3JrZXJfaW5wdXR9JyBvZiBsZW5ndGgge2xlbihpbnB1dF9hcmd1bWVudCl9IHRvIHtzaXplfSB3b3JrZXJzLiAiCiAgICAgICAgICAgICAgICAgICAgICAgIGYiUGxlYXNlIHJlZHVjZSB0aGUgYW1vdW50IG9mIHdvcmtlcnMgZm9yIHRoaXMgaW5wdXQuIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGV2ZW5fY2h1bmtfc2l6ZSA9IGxlbihpbnB1dF9hcmd1bWVudCkgLy8gc2l6ZQogICAgICAgICAgICAgICAgY2h1bmtfc3RhcnQgPSByYW5rICogZXZlbl9jaHVua19zaXplCiAgICAgICAgICAgICAgICBjaHVua19lbmQgPSAoCiAgICAgICAgICAgICAgICAgICAgKHJhbmsgKyAxKSAqIGV2ZW5fY2h1bmtfc2l6ZQogICAgICAgICAgICAgICAgICAgIGlmIHJhbmsgKyAxIDwgc2l6ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgbGVuKGlucHV0X2FyZ3VtZW50KQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICAgICBmIlJhbmsgI3tyYW5rfTogUHJvY2Vzc2luZyBpbnB1dCBjaHVuayBvZiAne3dvcmtlcl9pbnB1dH0nICIKICAgICAgICAgICAgICAgICAgICBmImZyb20gaW5kZXgge2NodW5rX3N0YXJ0fSB0byB7Y2h1bmtfZW5kfS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGlucHV0X2FyZ3VtZW50LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IGlucHV0X2FyZ3VtZW50W2NodW5rX3N0YXJ0OmNodW5rX2VuZF0KICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShpbnB1dF9hcmd1bWVudCwgcGQuRGF0YUZyYW1lKToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IGlucHV0X2FyZ3VtZW50Lmlsb2NbY2h1bmtfc3RhcnQ6Y2h1bmtfZW5kOiwgOl0KICAgICAgICAgICAgICAgIGt3YXJnc1t3b3JrZXJfaW5wdXRdID0gaW5wdXRfYXJndW1lbnQKCiAgICAgICAgICAgICMgU2V0IHRoZSByb290IHdvcmtlciBvbmx5IGFyZ3VtZW50czoKICAgICAgICAgICAgaWYgcmFuayA9PSAwIGFuZCByb290X3dvcmtlcl9pbnB1dHM6CiAgICAgICAgICAgICAgICBrd2FyZ3MudXBkYXRlKHJvb3Rfd29ya2VyX2lucHV0cykKCiAgICAgICAgICAgICMgUnVuIHRoZSB3b3JrZXI6CiAgICAgICAgICAgIG91dHB1dCA9IGhhbmRsZXIoKiprd2FyZ3MpCgogICAgICAgICAgICAjIFNlbmQgdGhlIG91dHB1dCB0byB0aGUgcm9vdCByYW5rIChyYW5rICMwKToKICAgICAgICAgICAgb3V0cHV0ID0gY29tbS5nYXRoZXIob3V0cHV0LCByb290PTApCiAgICAgICAgICAgIGlmIHJhbmsgPT0gMDoKICAgICAgICAgICAgICAgICMgSm9pbiB0aGUgb3V0cHV0czoKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkNvbGxlY3RpbmcgZGF0YSBmcm9tIHdvcmtlcnMgdG8gcm9vdCB3b3JrZXIuIikKICAgICAgICAgICAgICAgIGRhdGFmcmFtZSA9IHBkLmNvbmNhdChvYmpzPVtkZiBmb3IgZGYsIF8gaW4gb3V0cHV0XSwgYXhpcz0wKQogICAgICAgICAgICAgICAgZXJyb3JzX2RpY3Rpb25hcnkgPSByZWR1Y2Uob3BlcmF0b3IuaW9yLCBbZXJyIGZvciBfLCBlcnIgaW4gb3V0cHV0XSwge30pCiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YWZyYW1lLCBlcnJvcnNfZGljdGlvbmFyeQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICByZXR1cm4gd3JhcHBlcgoKICAgIHJldHVybiBkZWNvcmF0b3IKCgpAb3Blbl9tcGlfaGFuZGxlcih3b3JrZXJfaW5wdXRzPVsiZGF0YV9wYXRoIl0sIHJvb3Rfd29ya2VyX2lucHV0cz17InZlcmJvc2UiOiBUcnVlfSkKZGVmIGFuc3dlcl9xdWVzdGlvbnMoCiAgICBkYXRhX3BhdGg6IHN0ciB8IGxpc3Rbc3RyXSwKICAgIG1vZGVsX25hbWU6IHN0ciwKICAgIHF1ZXN0aW9uczogbGlzdFtzdHJdIHwgbGlzdFtsaXN0W3N0cl1dLAogICAgZGV2aWNlX21hcDogc3RyIHwgZGljdCA9IE5vbmUsCiAgICBtb2RlbF9rd2FyZ3M6IGRpY3QgPSBOb25lLAogICAgYXV0b19ncHRxX2V4bGxhbWFfbWF4X2lucHV0X2xlbmd0aDogaW50ID0gTm9uZSwKICAgIHRva2VuaXplcl9uYW1lOiBzdHIgPSBOb25lLAogICAgdG9rZW5pemVyX2t3YXJnczogZGljdCA9IE5vbmUsCiAgICB0ZXh0X3dyYXBwZXI6IHN0ciB8IGxpc3Rbc3RyXSA9ICIiLAogICAgcXVlc3Rpb25zX3dyYXBwZXI6IHN0ciB8IGxpc3Rbc3RyXSA9ICIiLAogICAgZ2VuZXJhdGlvbl9jb25maWc6IGRpY3QgfCBsaXN0W2RpY3RdID0gTm9uZSwKICAgIHF1ZXN0aW9uc19jb25maWc6IGRpY3QgfCBsaXN0W2RpY3RdID0gTm9uZSwKICAgIGJhdGNoX3NpemU6IGludCA9IDEsCiAgICBxdWVzdGlvbnNfY29sdW1uczogbGlzdFtzdHJdID0gTm9uZSwKICAgIHZlcmJvc2U6IGJvb2wgPSBGYWxzZSwKKSAtPiB0dXBsZVtwZC5EYXRhRnJhbWUsIGRpY3RdOgogICAgIiIiCiAgICBBbnN3ZXIgcXVlc3Rpb25zIHdpdGggYSBjb250ZXh0IHRvIHRoZSBnaXZlbiB0ZXh0IGZpbGVzIGNvbnRlbnRzIGJ5IGEgcHJldHJhaW5lZCBMTE0gbW9kZWwuIEVhY2ggdGV4dCBmaWxlIHdpbGwgaGF2ZQogICAgdGhlIGZvbGxvd2luZyBwcm9tcHQgYnVpbHQ6CgogICAgc3RhcnQgb2YgYHRleHRfd3JhcHBlcmAKICAgIDx0ZXh0IGZpbGUgY29udGVudD4KICAgIGVuZCBvZiBgdGV4dF93cmFwcGVyYAoKICAgIHN0YXJ0IG9mIGBxdWVzdGlvbnNfd3JhcHBlcmAKICAgIDEuIDxxdWVzdGlvbnNbMF0+CiAgICAyLiA8cXVlc3Rpb25zWzFdPgogICAgLi4uCiAgICBuLiA8cXVlc3Rpb25zW24tMV0+CiAgICBlbmQgb2YgYHF1ZXN0aW9uc193cmFwcGVyYAoKICAgIDpwYXJhbSBkYXRhX3BhdGg6ICAgICAgICAgICAgICAgICAgICAgICAgICBBIHBhdGggdG8gYSBkaXJlY3Rvcnkgb2YgdGV4dCBmaWxlcyBvciBhIHBhdGggdG8gYSB0ZXh0IGZpbGUgdG8gYXNrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb25zIGFib3V0LgogICAgOnBhcmFtIG1vZGVsX25hbWU6ICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBwcmUtdHJhaW5lZCBtb2RlbCBuYW1lIGZyb20gdGhlIGh1Z2dpbmdmYWNlIGh1YiB0byB1c2UgZm9yIGFza2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXN0aW9ucy4KICAgIDpwYXJhbSBxdWVzdGlvbnM6ICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgcXVlc3Rpb25zIHRvIGFzay4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBIGxpc3Qgb2YgbGlzdHMgb2YgcXVlc3Rpb25zIHRvIGFzayBwZXIgdGV4dCBmaWxlLCBhbmQgZGV2aWRlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5IHF1ZXN0aW9uIGdyb3VwcywgdGhlIGdyb3VwcyBjYW4gYmUgZHRlcm1haW5lZCBieSBzaXplIChpbiBvcmRlciB0bwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2b2lkIGxhcmdlIGlucHV0cyB0byB0aGUgbGxtKSBvciBieSBxdWVzdGlvbmluZyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocmVndWxhciBvciBwb2xsIGxpa2UgcXVlc3Rpb25pbmcpLgogICAgOnBhcmFtIGRldmljZV9tYXA6ICAgICAgICAgICAgICAgICAgICAgICAgIEEgbWFwIHRvIHVzZSBmb3IgbG9hZGluZyB0aGUgbW9kZWwgb24gbXVsdGlwbGUgZGV2aWNlcy4KICAgIDpwYXJhbSBtb2RlbF9rd2FyZ3M6ICAgICAgICAgICAgICAgICAgICAgICBLZXl3b3JkIGFyZ3VtZW50cyB0byBwYXNzIGZvciBsb2FkaW5nIHRoZSBtb2RlbCB1c2luZyBIdWdnaW5nRmFjZSdzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYHRyYW5zZm9ybWVycy5BdXRvTW9kZWxGb3JDYXVzYWxMTS5mcm9tX3ByZXRyYWluZWRgIGZ1bmN0aW9uLgogICAgOnBhcmFtIGF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGg6IEZvciBBdXRvR1BUUSBtb2RlbHMgdG8gc2V0IGFuZCBleHRlbmQgdGhlIG1vZGVsJ3MgaW5wdXQgYnVmZmVyIHNpemUuCiAgICA6cGFyYW0gdG9rZW5pemVyX25hbWU6ICAgICAgICAgICAgICAgICAgICAgVGhlIHRva2VuaXplciBuYW1lIGZyb20gdGhlIGh1Z2dpbmdmYWNlIGh1YiB0byB1c2UuIElmIG5vdCBnaXZlbiwgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwgbmFtZSB3aWxsIGJlIHVzZWQuCiAgICA6cGFyYW0gdG9rZW5pemVyX2t3YXJnczogICAgICAgICAgICAgICAgICAgS2V5d29yZCBhcmd1bWVudHMgdG8gcGFzcyBmb3IgbG9hZGluZyB0aGUgdG9rZW5pemVyIHVzaW5nIEh1Z2dpbmdGYWNlJ3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkYCBmdW5jdGlvbi4KICAgIDpwYXJhbSB0ZXh0X3dyYXBwZXI6ICAgICAgICAgICAgICAgICAgICAgICBBIHdyYXBwZXIgZm9yIHRoZSBmaWxlJ3MgdGV4dC4gV2lsbCBiZSBhZGRlZCBhdCB0aGUgc3RhcnQgb2YgdGhlIHByb21wdC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNdXN0IGhhdmUgYSBwbGFjZWhvbGRlciAoJ3t9JykgZm9yIHRoZSB0ZXh0IG9mIHRoZSBmaWxlLgogICAgOnBhcmFtIHF1ZXN0aW9uc193cmFwcGVyOiAgICAgICAgICAgICAgICAgIEEgd3JhcHBlciBmb3IgdGhlIHF1ZXN0aW9ucyByZWNlaXZlZC4gV2lsbCBiZSBhZGRlZCBhZnRlciB0aGUgdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBwZXIgaW4gdGhlIHByb21wdCB0ZW1wbGF0ZS4gTXVzdCBoYXZlIGEgcGxhY2Vob2xkZXIgKCd7fScpIGZvciB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVzdGlvbnMuCiAgICA6cGFyYW0gZ2VuZXJhdGlvbl9jb25maWc6ICAgICAgICAgICAgICAgICAgSHVnZ2luZ0ZhY2UncyBgR2VuZXJhdGlvbkNvbmZpZ2Aga2V5d29yZCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgZ2VuZXJhdGVgIG1ldGhvZC4KICAgIDpwYXJhbSBxdWVzdGlvbnNfY29uZmlnOiAgICAgICAgICAgICAgICAgICBBIGRpY3Rpb25hcnkgb3IgbGlzdCBvZiBkaWN0aW9uYXJpZXMgY29udGFpbmluZyBzcGVjaWZpYyB3YXlzIHRvIGFuc3dlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXN0aW9ucyAodXNpbmcgYSBwb2xsIGZvciBleGFtcGxlKSwgZWFjaCBkaWN0aW9uYXJ5IGluIHRoZSBsaXN0IGlzIGZvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcnJlc3BvbmRpbmcgcXVlc3Rpb24gZ3JvdXAgYW5kIGRldGVybWluZXMgdGhlIHF1ZXN0aW9uIGFza2luZyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3Igc2FpZCBncm91cC4KICAgIDpwYXJhbSBiYXRjaF9zaXplOiAgICAgICAgICAgICAgICAgICAgICAgICBCYXRjaCBzaXplIGZvciBpbmZlcmVuY2UuCiAgICA6cGFyYW0gcXVlc3Rpb25zX2NvbHVtbnM6ICAgICAgICAgICAgICAgICAgQ29sdW1ucyB0byB1c2UgZm9yIHRoZSBkYXRhZnJhbWUgcmV0dXJuZWQuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgICAgICAgICAgICAgICAgV2hldGhlciB0byBwcmVzZW50IGxvZ3Mgb2YgYSBwcm9ncmVzcyBiYXIgYW5kIGVycm9ycy4gRGVmYXVsdDogVHJ1ZS4KCgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CgogICAgICAgICAgICAgICogQSBkYXRhZnJhbWUgZGF0YXNldCBvZiB0aGUgcXVlc3Rpb25zIGFuc3dlcnMuCiAgICAgICAgICAgICAgKiBBIGRpY3Rpb25hcnkgb2YgZXJyb3JlZCBmaWxlcyB0aGF0IHdlcmUgbm90IGluZmVycmVkIG9yIHdlcmUgbm90IGFuc3dlcmVkIHByb3Blcmx5LgogICAgIiIiCiAgICBnbG9iYWwgX0xPR0dFUgoKICAgICMgU2V0IGNvbmZpZ3MgdG8gZW1wdHkgZGljdCBpZiBub3QgZ2l2ZW46CiAgICBpZiBnZW5lcmF0aW9uX2NvbmZpZyBpcyBOb25lOgogICAgICAgIGdlbmVyYXRpb25fY29uZmlnID0ge30KICAgIGlmIHF1ZXN0aW9uc19jb25maWcgaXMgTm9uZToKICAgICAgICBxdWVzdGlvbnNfY29uZmlnID0ge30KCiAgICAjIEdldCB0aGUgaW5wdXQgdGV4dCBmaWxlcyB0byBxdWVzdGlvbjoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJDb2xsZWN0aW5nIHRleHQgZmlsZXMuIikKICAgIGlmIGlzaW5zdGFuY2UoZGF0YV9wYXRoLCBzdHIpOgogICAgICAgIGRhdGFfcGF0aCA9IHBhdGhsaWIuUGF0aChkYXRhX3BhdGgpLmFic29sdXRlKCkKICAgICAgICB0ZXh0X2ZpbGVzID0gX2dldF90ZXh0X2ZpbGVzKGRhdGFfcGF0aD1kYXRhX3BhdGgpCiAgICBlbHNlOgogICAgICAgIHRleHRfZmlsZXMgPSBkYXRhX3BhdGgKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKGYiQ29sbGVjdGVkIHtsZW4odGV4dF9maWxlcyl9IHRleHQgZmlsZXMuIikKCiAgICAjIEdldCB0aGUgcHJvbXB0IHRlbXBsYXRlOgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIkNyZWF0aW5nIHByb21wdCB0ZW1wbGF0ZS4iKQoKICAgICMgT3JnYW5pemUgcXVlc3Rpb25zIGFzIGEgbGlzdCBvZiBsaXN0LCBhbmQgY291bnQgbnVtYmVyIG9mIHN1Yi1saXN0cyBmb3IgZnV0dXJlIHVzZQogICAgbnVtYmVyX29mX3F1ZXN0aW9uX2dyb3VwcyA9IDEgaWYgaXNpbnN0YW5jZShxdWVzdGlvbnNbMF0sIHN0cikgZWxzZSBsZW4ocXVlc3Rpb25zKQogICAgcXVlc3Rpb25zID0gX3RvX2dyb3VwX2xpc3QoCiAgICAgICAgYXJndW1lbnRfdmFsdWU9cXVlc3Rpb25zLAogICAgICAgIGFyZ3VtZW50X25hbWU9InF1ZXN0aW9ucyIsCiAgICAgICAgbGVuZ3RoPW51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMsCiAgICApCgogICAgIyBPcmdhbml6ZSBwcm9tcHQgcGFydHMgYXQgcHJvcGVyIGxlbmd0aAogICAgdGV4dF93cmFwcGVyID0gX3RvX2dyb3VwX2xpc3QoCiAgICAgICAgYXJndW1lbnRfdmFsdWU9dGV4dF93cmFwcGVyLAogICAgICAgIGFyZ3VtZW50X25hbWU9InRleHRfd3JhcHBlciIsCiAgICAgICAgbGVuZ3RoPW51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMsCiAgICApCiAgICBxdWVzdGlvbnNfd3JhcHBlciA9IF90b19ncm91cF9saXN0KAogICAgICAgIGFyZ3VtZW50X3ZhbHVlPXF1ZXN0aW9uc193cmFwcGVyLAogICAgICAgIGFyZ3VtZW50X25hbWU9InF1ZXN0aW9uc193cmFwcGVyIiwKICAgICAgICBsZW5ndGg9bnVtYmVyX29mX3F1ZXN0aW9uX2dyb3VwcywKICAgICkKCiAgICAjIENyZWF0ZSBhIGxpc3Qgb2YgcHJvbXB0IGFjY29yZGluZyB0byBnaXZlbiBwYXJ0cyBhbmQgcXVlc3Rpb25zCiAgICBwcm9tcHRfdGVtcGxhdGUgPSBbXQogICAgcXVlc3Rpb25zID0gcXVlc3Rpb25zIGlmIGlzaW5zdGFuY2UocXVlc3Rpb25zWzBdLCBsaXN0KSBlbHNlIFtxdWVzdGlvbnNdCgogICAgIyBCdWlsZCBhbGwgcHJvbXB0cwogICAgZm9yIGkgaW4gcmFuZ2UobnVtYmVyX29mX3F1ZXN0aW9uX2dyb3Vwcyk6CiAgICAgICAgcHJvbXB0X3RlbXBsYXRlLmFwcGVuZCgKICAgICAgICAgICAgX2dldF9wcm9tcHRfdGVtcGxhdGUoCiAgICAgICAgICAgICAgICB0ZXh0X3dyYXBwZXI9dGV4dF93cmFwcGVyW2ldLAogICAgICAgICAgICAgICAgcXVlc3Rpb25zX3dyYXBwZXI9cXVlc3Rpb25zX3dyYXBwZXJbaV0sCiAgICAgICAgICAgICAgICBxdWVzdGlvbnM9cXVlc3Rpb25zW2ldLAogICAgICAgICAgICApCiAgICAgICAgKQogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oZiJQcm9tcHQgdGVtcGxhdGUgY3JlYXRlZDpcblxue3Byb21wdF90ZW1wbGF0ZX1cbiIpCgogICAgIyBHZXQgdGhlIHRvdGFsIGFtb3VudCBvZiBxdWVzdGlvbnM6CiAgICBxdWVzdGlvbnNfYW1vdW50ID0gc3VtKFtsZW4oc3VibGlzdCkgZm9yIHN1Ymxpc3QgaW4gcXVlc3Rpb25zXSkKCiAgICAjIEdldCB0aGUgcXVlc3Rpb25zIGNvbHVtbnM6CiAgICBxdWVzdGlvbnNfY29sdW1ucyA9IHF1ZXN0aW9uc19jb2x1bW5zIG9yIFsKICAgICAgICBmInF7aX0iIGZvciBpIGluIHJhbmdlKDEsIHF1ZXN0aW9uc19hbW91bnQgKyAxKQogICAgXQoKICAgICMgQ2hlY2sgaWYgd2UgaGF2ZSB0aGUgY29ycmVjdCBhbW91bnQgb2YgcXVlc3Rpb25zIGNvbHVtbnM6CiAgICBpZiBsZW4ocXVlc3Rpb25zX2NvbHVtbnMpICE9IHF1ZXN0aW9uc19hbW91bnQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgZiJUaGUgcHJvdmlkZWQgcXVlc3Rpb25zIGNvbHVtbnMgbGVuZ3RoICh7bGVuKHF1ZXN0aW9uc19jb2x1bW5zKX0pICIKICAgICAgICAgICAgZiJkb2VzIG5vdCBtYXRjaCB0aGUgcXVlc3Rpb25zIGFtb3VudCAoe3F1ZXN0aW9uc19hbW91bnR9KSIKICAgICAgICApCgogICAgIyBMb2FkIHRoZSBnZW5lcmF0aW9uIGNvbmZpZzoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJMb2FkaW5nIGdlbmVyYXRpb24gY29uZmlndXJhdGlvbi4iKQogICAgZ2VuZXJhdGlvbl9jb25maWcgPSBbCiAgICAgICAgdHJhbnNmb3JtZXJzLkdlbmVyYXRpb25Db25maWcoKiooY2ZnIG9yIHt9KSkKICAgICAgICBmb3IgY2ZnIGluIF90b19ncm91cF9saXN0KAogICAgICAgICAgICBhcmd1bWVudF92YWx1ZT1nZW5lcmF0aW9uX2NvbmZpZywKICAgICAgICAgICAgYXJndW1lbnRfbmFtZT0iZ2VuZXJhdGlvbl9jb25maWciLAogICAgICAgICAgICBsZW5ndGg9bnVtYmVyX29mX3F1ZXN0aW9uX2dyb3VwcywKICAgICAgICApCiAgICBdCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIkdlbmVyYXRpb24gY29uZmlndXJhdGlvbiBsb2FkZWQ6IHtnZW5lcmF0aW9uX2NvbmZpZ30iKQoKICAgICMgTG9hZCB0aGUgbW9kZWwgYW5kIHRva2VuaXplciBpbnRvIGEgcGlwZWxpbmUgb2JqZWN0OgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oZiJMb2FkaW5nIG1vZGVsICd7bW9kZWxfbmFtZX0nLiIpCiAgICBnZW5lcmF0aW9uX3BpcGVsaW5lID0gX2dldF9nZW5lcmF0aW9uX3BpcGVsaW5lKAogICAgICAgIG1vZGVsX25hbWU9bW9kZWxfbmFtZSwKICAgICAgICBkZXZpY2VfbWFwPWRldmljZV9tYXAsCiAgICAgICAgdG9rZW5pemVyX25hbWU9dG9rZW5pemVyX25hbWUgb3IgbW9kZWxfbmFtZSwKICAgICAgICBtb2RlbF9rd2FyZ3M9bW9kZWxfa3dhcmdzIG9yIHt9LAogICAgICAgIHRva2VuaXplcl9rd2FyZ3M9dG9rZW5pemVyX2t3YXJncyBvciB7fSwKICAgICAgICBhdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoPWF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGgsCiAgICAgICAgYmF0Y2hfc2l6ZT1iYXRjaF9zaXplLAogICAgKQogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIk1vZGVsIGxvYWRlZC4iKQoKICAgICMgUHJlcGFyZSB0aGUgc3VjY2Vzc2VzIGRhdGFmcmFtZSBhbmQgZXJyb3JzIGRpY3Rpb25hcnkgdG8gYmUgcmV0dXJuZWQ6CiAgICBzdWNjZXNzZXMgPSBbXQogICAgZXJyb3JzID0ge30KCiAgICAjIFNwbGl0IHRoZSBmaWxlcyBpbnRvIGJhdGNoZXM6CiAgICBmaWxlX2JhdGNoZXMgPSBbCiAgICAgICAgdGV4dF9maWxlc1tpIDogaSArIGJhdGNoX3NpemVdCiAgICAgICAgaWYgaSArIGJhdGNoX3NpemUgPCBsZW4odGV4dF9maWxlcykKICAgICAgICBlbHNlIHRleHRfZmlsZXNbaTpdCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMCwgbGVuKHRleHRfZmlsZXMpLCBiYXRjaF9zaXplKQogICAgXQogICAgcXVlc3Rpb25zX2NvbmZpZyA9IF90b19ncm91cF9saXN0KAogICAgICAgIGFyZ3VtZW50X3ZhbHVlPXF1ZXN0aW9uc19jb25maWcsCiAgICAgICAgYXJndW1lbnRfbmFtZT0icXVlc3Rpb25zX2NvbmZpZyIsCiAgICAgICAgbGVuZ3RoPW51bWJlcl9vZl9xdWVzdGlvbl9ncm91cHMsCiAgICApCgogICAgIyBDcmVhdGUgYSBsaXN0IG9mIHF1ZXN0aW9uIGhhbmRsZXJzIGFjY29yZGluZyB0byBnaXZlbiBjb25maWdzCiAgICBoYW5kbGVycyA9IFtdCiAgICBmb3IgY2ZnIGluIHF1ZXN0aW9uc19jb25maWc6CiAgICAgICAgcXVlc3Rpb25fdHlwZSA9IGNmZy5wb3AoInR5cGUiLCAiZGVmYXVsdCIpCiAgICAgICAgaGFuZGxlcnMuYXBwZW5kKFFVRVNUSU9OX01BUFBJTkcuZ2V0KHF1ZXN0aW9uX3R5cGUpKCoqY2ZnKSkKCiAgICAjIEdvIG92ZXIgdGhlIGJhdGNoZXMgb2YgdGV4dCBmaWxlcyBhbmQgcXVlc3Rpb24gdGhlbToKICAgIGZvciBmaWxlX2JhdGNoIGluIHRxZG0oCiAgICAgICAgZmlsZV9iYXRjaGVzLAogICAgICAgIGRlc2M9IkdlbmVyYXRpbmcgYW5zd2VycyIsCiAgICAgICAgdW5pdD1mImZpbGUgKGJhdGNoIG9mIHtiYXRjaF9zaXplfSkiLAogICAgICAgIGRpc2FibGU9bm90IHZlcmJvc2UsCiAgICApOgogICAgICAgIHRyeToKICAgICAgICAgICAgdG90YWxfYW5zd2VycyA9IFtbXSBmb3IgXyBpbiByYW5nZShiYXRjaF9zaXplKV0KCiAgICAgICAgICAgICMgR28gb3ZlciBhbGwgcXVlc3Rpb24gZ3JvdXAgcGVyIGJhdGNoIG9mIGRvY3VtZW50cwogICAgICAgICAgICBmb3IgcXVlc3Rpb25fZ3JvdXAgaW4gcmFuZ2UobnVtYmVyX29mX3F1ZXN0aW9uX2dyb3Vwcyk6CiAgICAgICAgICAgICAgICBjdXJyZW50X3F1ZXN0aW9uc19hbW91bnQgPSBsZW4ocXVlc3Rpb25zW3F1ZXN0aW9uX2dyb3VwXSkKCiAgICAgICAgICAgICAgICAjIFJlYWQgYmF0Y2ggKHJlYWQgdGhlIHRleHQgZnJvbSB0aGUgdGV4dCBmaWxlcyk6CiAgICAgICAgICAgICAgICBiYXRjaGVkX2lucHV0ID0gX3JlYWRfZmlsZV9iYXRjaCgKICAgICAgICAgICAgICAgICAgICBmaWxlX2JhdGNoPWZpbGVfYmF0Y2gsCiAgICAgICAgICAgICAgICAgICAgcHJvbXB0X3RlbXBsYXRlPXByb21wdF90ZW1wbGF0ZVtxdWVzdGlvbl9ncm91cF0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgIyBBbnN3ZXIgdGhlIHF1ZXN0aW9ucyB3aXRoIGVhY2ggcXVlc3Rpb24gaGFuZGxlcjoKICAgICAgICAgICAgICAgIGJhdGNoZWRfYW5zd2VycyA9IGhhbmRsZXJzW3F1ZXN0aW9uX2dyb3VwXS5hbnN3ZXIoCiAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb25zX2Ftb3VudD1jdXJyZW50X3F1ZXN0aW9uc19hbW91bnQsCiAgICAgICAgICAgICAgICAgICAgYmF0Y2hlZF9pbnB1dD1iYXRjaGVkX2lucHV0LAogICAgICAgICAgICAgICAgICAgIGdlbmVyYXRpb25fcGlwZWxpbmU9Z2VuZXJhdGlvbl9waXBlbGluZSwKICAgICAgICAgICAgICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZz1nZW5lcmF0aW9uX2NvbmZpZ1txdWVzdGlvbl9ncm91cF0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgIyBQdXQgdGhlIGFuc3dlcnMgaW4gdGhlIGNvcnJlY3QgcGxhY2UgaW4gdGhlIHRvdGFsIGFuc3dlcnMgbGlzdCBhY2NvcmRpbmcgdG8gdGhlIHBsYWNlIGluIHRoZSBiYXRjaDoKICAgICAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKGJhdGNoX3NpemUpOgogICAgICAgICAgICAgICAgICAgIHRvdGFsX2Fuc3dlcnNbaV0uZXh0ZW5kKGJhdGNoZWRfYW5zd2Vyc1tpXSkKCiAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgYW5zd2VycyBhbmQgYXR0YWNoIHRoZSBmaWxlIG5hbWU6CiAgICAgICAgICAgIHN1Y2Nlc3Nlcy5leHRlbmQoCiAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgW2ZpbGUubmFtZSwgKmFuc3dlcnNdCiAgICAgICAgICAgICAgICAgICAgZm9yIGZpbGUsIGFuc3dlcnMgaW4gemlwKGZpbGVfYmF0Y2gsIHRvdGFsX2Fuc3dlcnMpCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBOb3RlIHRoZSBleGNlcHRpb24gYXMgZXJyb3IgaW4gdGhlIGRpY3Rpb25hcnk6CiAgICAgICAgICAgIGJhdGNoX2ZpbGVfbmFtZXMgPSAiLCAiLmpvaW4oW2ZpbGUubmFtZSBmb3IgZmlsZSBpbiBmaWxlX2JhdGNoXSkKICAgICAgICAgICAgaWYgdmVyYm9zZToKICAgICAgICAgICAgICAgIF9MT0dHRVIud2FybmluZygKICAgICAgICAgICAgICAgICAgICBmIkVycm9yIGluIGJhdGNoICd7YmF0Y2hfZmlsZV9uYW1lc30nOiB7c3RyKGV4Y2VwdGlvbil9IgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlcnJvcnNbYmF0Y2hfZmlsZV9uYW1lc10gPSBzdHIoZXhjZXB0aW9uKQogICAgICAgICAgICBjb250aW51ZQoKICAgICMgQ29uc3RydWN0IHRoZSBhbnN3ZXJzIGRhdGFmcmFtZToKICAgIGNvbHVtbnMgPSBbCiAgICAgICAgInRleHRfZmlsZSIsCiAgICAgICAgKnF1ZXN0aW9uc19jb2x1bW5zLAogICAgXQoKICAgICMgQ3JlYXRlIGEgZGF0YSBmcmFtZSBvZiBhbnN3ZXJzIGJ5IGZpbGVzCiAgICBzdWNjZXNzZXMgPSBwZC5EYXRhRnJhbWUoCiAgICAgICAgc3VjY2Vzc2VzLAogICAgICAgIGNvbHVtbnM9Y29sdW1ucywKICAgICkKCiAgICAjIFByaW50IHRoZSBoZWFkIG9mIHRoZSBwcm9kdWNlZCBkYXRhZnJhbWUgYW5kIHJldHVybjoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKAogICAgICAgICAgICBmIkRvbmUgKHtzdWNjZXNzZXMuc2hhcGVbMF19L3tsZW4odGV4dF9maWxlcyl9KVxuIgogICAgICAgICAgICBmIkFuc3dlcnMgc3VtbWFyeTpcbiIKICAgICAgICAgICAgZiJ7c3VjY2Vzc2VzLmhlYWQoKX0iCiAgICAgICAgKQogICAgcmV0dXJuIHN1Y2Nlc3NlcywgZXJyb3JzCgoKZGVmIF9nZXRfdGV4dF9maWxlcygKICAgIGRhdGFfcGF0aDogcGF0aGxpYi5QYXRoLAopIC0+IGxpc3RbcGF0aGxpYi5QYXRoXToKICAgICMgQ2hlY2sgaWYgdGhlIHBhdGggaXMgb2YgYSBkaXJlY3Rvcnkgb3IgYSBmaWxlOgogICAgaWYgZGF0YV9wYXRoLmlzX2RpcigpOgogICAgICAgICMgR2V0IGFsbCBmaWxlcyBpbnNpZGUgdGhlIGRpcmVjdG9yeToKICAgICAgICB0ZXh0X2ZpbGVzID0gbGlzdChkYXRhX3BhdGguZ2xvYigiKi4qIikpCiAgICBlbGlmIGRhdGFfcGF0aC5pc19maWxlKCk6CiAgICAgICAgdGV4dF9maWxlcyA9IFtkYXRhX3BhdGhdCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiVW5yZWNvZ25pemVkIGRhdGEgcGF0aC4gVGhlIHBhcmFtZXRlciBgZGF0YV9wYXRoYCBtdXN0IGJlIGVpdGhlciBhIGRpcmVjdG9yeSBwYXRoIG9yIGEgZmlsZSBwYXRoLiAiCiAgICAgICAgICAgIGYiR2l2ZW46IHtzdHIoZGF0YV9wYXRoKX0gIgogICAgICAgICkKCiAgICByZXR1cm4gdGV4dF9maWxlcwoKCmRlZiBfZ2V0X3Byb21wdF90ZW1wbGF0ZSgKICAgIHRleHRfd3JhcHBlcjogc3RyLAogICAgcXVlc3Rpb25zX3dyYXBwZXI6IHN0ciwKICAgIHF1ZXN0aW9uczogbGlzdFtzdHJdLAopIC0+IHN0cjoKICAgICMgVmFsaWRhdGUgYW5kIGJ1aWxkIHRoZSB0ZXh0IHdyYXBwZXI6CiAgICB0ZXh0X3dyYXBwZXIgPSB0ZXh0X3dyYXBwZXIgb3IgKCJHaXZlbiB0aGUgZm9sbG93aW5nIHRleHQ6XG4tLS0tLVxue31cbi0tLS0tIikKICAgIGlmIHRleHRfd3JhcHBlci5jb3VudCgie30iKSAhPSAxOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICJUaGUgYHRleHRfd3JhcHBlcmAgbXVzdCBpbmNsdWRlIG9uZSBwbGFjZWhvbGRlciAne30nIGZvciB0aGUgdGV4dCBvZiB0aGUgZmlsZSB0byBiZSBhc2tlZCBhYm91dC4iCiAgICAgICAgKQoKICAgICMgVmFsaWRhdGUgYW5kIGJ1aWxkIHRoZSBxdWVzdGlvbiB3cmFwcGVyOgogICAgcXVlc3Rpb25zX3dyYXBwZXIgPSBxdWVzdGlvbnNfd3JhcHBlciBvciAiQW5zd2VyIHRoZSBxdWVzdGlvbnM6XG57fSIKICAgIGlmIHF1ZXN0aW9uc193cmFwcGVyLmNvdW50KCJ7fSIpICE9IDE6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgIlRoZSBgcXVlc3Rpb25zX3dyYXBwZXJgIG11c3QgaW5jbHVkZSBvbmUgcGxhY2Vob2xkZXIgJ3t9JyBmb3IgdGhlIGxpc3Qgb2YgcXVlc3Rpb25zLiIKICAgICAgICApCgogICAgIyBWYWxpZGF0ZSBhbmQgcGFyc2UgdGhlIHF1ZXN0aW9uczoKICAgIGlmIGxlbihxdWVzdGlvbnMpID09IDA6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiUGxlYXNlIGluY2x1ZGUgYXQgbGVhc3Qgb25lIHF1ZXN0aW9uLiIpCiAgICBxdWVzdGlvbnMgPSAiXG4iLmpvaW4oCiAgICAgICAgW2Yie2l9LiB7cXVlc3Rpb259IiBmb3IgaSwgcXVlc3Rpb24gaW4gZW51bWVyYXRlKHF1ZXN0aW9ucywgMSldCiAgICApCgogICAgIyBDb25zdHJ1Y3QgdGhlIHRlbXBsYXRlOgogICAgcmV0dXJuIGYie3RleHRfd3JhcHBlcn1cbntxdWVzdGlvbnNfd3JhcHBlci5mb3JtYXQocXVlc3Rpb25zKX1cbiIKCgpkZWYgX2dldF9nZW5lcmF0aW9uX3BpcGVsaW5lKAogICAgbW9kZWxfbmFtZTogc3RyLAogICAgZGV2aWNlX21hcDogc3RyIHwgZGljdCwKICAgIHRva2VuaXplcl9uYW1lOiBzdHIsCiAgICBtb2RlbF9rd2FyZ3M6IGRpY3QsCiAgICB0b2tlbml6ZXJfa3dhcmdzOiBkaWN0LAogICAgYXV0b19ncHRxX2V4bGxhbWFfbWF4X2lucHV0X2xlbmd0aDogaW50ID0gTm9uZSwKICAgIGJhdGNoX3NpemU6IGludCA9IDEsCik6CiAgICAjIExvYWQgdGhlIG1vZGVsOgogICAgbW9kZWwgPSB0cmFuc2Zvcm1lcnMuQXV0b01vZGVsRm9yQ2F1c2FsTE0uZnJvbV9wcmV0cmFpbmVkKAogICAgICAgIG1vZGVsX25hbWUsIGRldmljZV9tYXA9ZGV2aWNlX21hcCwgKiptb2RlbF9rd2FyZ3MKICAgICkKCiAgICAjIFNldCBleGxsYW1hIG1heCBpbnB1dCBsZW5ndGggaWYgcHJvdmlkZWQ6CiAgICAjIFRoaXMgY2hhbmdlcyB0aGUgbW9kZWwncyBjb250ZXh0IHNpemUuCiAgICBpZiBhdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoOgogICAgICAgIGZyb20gYXV0b19ncHRxIGltcG9ydCBleGxsYW1hX3NldF9tYXhfaW5wdXRfbGVuZ3RoCgogICAgICAgIG1vZGVsID0gZXhsbGFtYV9zZXRfbWF4X2lucHV0X2xlbmd0aCgKICAgICAgICAgICAgbW9kZWw9bW9kZWwsIG1heF9pbnB1dF9sZW5ndGg9YXV0b19ncHRxX2V4bGxhbWFfbWF4X2lucHV0X2xlbmd0aAogICAgICAgICkKCiAgICAjIExvYWQgdGhlIHRva2VuaXplcjoKICAgIHRva2VuaXplciA9IHRyYW5zZm9ybWVycy5BdXRvVG9rZW5pemVyLmZyb21fcHJldHJhaW5lZCgKICAgICAgICB0b2tlbml6ZXJfbmFtZSwgKip0b2tlbml6ZXJfa3dhcmdzCiAgICApCgogICAgIyBJbml0aWFsaXplIGEgZ2VuZXJhdGlvbiBwaXBsaW5lIGFuZCByZXR1cm46CiAgICBwaXBlID0gdHJhbnNmb3JtZXJzLnBpcGVsaW5lKAogICAgICAgIHRhc2s9InRleHQtZ2VuZXJhdGlvbiIsCiAgICAgICAgbW9kZWw9bW9kZWwsCiAgICAgICAgdG9rZW5pemVyPXRva2VuaXplciwKICAgICAgICBiYXRjaF9zaXplPWJhdGNoX3NpemUsCiAgICApCiAgICBwaXBlLnRva2VuaXplci5wYWRfdG9rZW5faWQgPSBtb2RlbC5jb25maWcuZW9zX3Rva2VuX2lkCiAgICByZXR1cm4gcGlwZQoKCmRlZiBfcmVhZF9maWxlX2JhdGNoKAogICAgZmlsZV9iYXRjaDogbGlzdFtwYXRobGliLlBhdGhdLAogICAgcHJvbXB0X3RlbXBsYXRlOiBzdHIsCikgLT4gbGlzdFtzdHJdOgogICAgYmF0Y2ggPSBbXQoKICAgICMgR28gb3ZlciBhbGwgZmlsZXMgYW5kIHJlYWQgaW4gdXNhYmxlIGZvcm1hdAogICAgZm9yIGZpbGUgaW4gZmlsZV9iYXRjaDoKICAgICAgICB3aXRoIG9wZW4oZmlsZSwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZnA6CiAgICAgICAgICAgIGJhdGNoLmFwcGVuZChwcm9tcHRfdGVtcGxhdGUuZm9ybWF0KGZwLnJlYWQoKSkpCiAgICByZXR1cm4gYmF0Y2gKCgpkZWYgX3RvX2dyb3VwX2xpc3QoYXJndW1lbnRfdmFsdWU6IGxpc3QsIGFyZ3VtZW50X25hbWU6IHN0ciwgbGVuZ3RoOiBpbnQpOgogICAgIyBDaGVjayBpZiBpcyBsaXN0LCB0dXJuIHRvIGxpc3QgaWYgbm90CiAgICBhcmd1bWVudF92YWx1ZSA9ICgKICAgICAgICBhcmd1bWVudF92YWx1ZSBpZiBpc2luc3RhbmNlKGFyZ3VtZW50X3ZhbHVlLCBsaXN0KSBlbHNlIFthcmd1bWVudF92YWx1ZV0KICAgICkKICAgIGxpc3RfbGVuID0gbGVuKGFyZ3VtZW50X3ZhbHVlKQoKICAgICMgSWYgbm90IGEgbGlzdCwgb3IgaXMgYSBsaXN0IG9mIGxlbiAxIHdlIGR1cGxpY2F0ZSBmb3IgY29ycmVjdCBsZW5ndGgKICAgICMgSWYgbGlzdCBpbiB3cm9uZyBsZW5ndGggdGhyb3cgYW4gZXJyb3IKICAgIGlmIGxpc3RfbGVuICE9IGxlbmd0aDoKICAgICAgICBpZiBsaXN0X2xlbiA9PSAxOgogICAgICAgICAgICByZXR1cm4gYXJndW1lbnRfdmFsdWUgKiBsZW5ndGgKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICBmIlRoZSBhcmd1bWVudCB2YWx1ZSBvZiAne2FyZ3VtZW50X25hbWV9JyBpcyBub3QgZXF1YWwgdG8gdGhlIGxlbmd0aCBvZiB0aGUgZ2l2ZW4gcXVlc3Rpb25zIC0ge2xlbmd0aH0iCiAgICAgICAgKQogICAgcmV0dXJuIGFyZ3VtZW50X3ZhbHVlCgoKY2xhc3MgUXVlc3Rpb25IYW5kbGVyOgogICAgIiIiCiAgICBBIGNsYXNzIGZvciBoYW5kbGluZyBxdWVzdGlvbnMgYW5zd2VyaW5nIGZvciBhIGdpdmVuIHF1ZXN0aW9uIHR5cGUuCiAgICBUaGlzIGNsYXNzIGlzIHVzZWQgYXMgYSBiYXNlIGNsYXNzIGZvciBhbGwgcXVlc3Rpb24gdHlwZXMsIGFuZCBmb3IgZGVmYXVsdCBxdWVzdGlvbiB0eXBlIChyZWd1bGFyIHF1ZXN0aW9uCiAgICBhbnN3ZXJpbmcgd2l0aG91dCBhbnkgc3BlY2lhbCBoYW5kbGluZykuCiAgICAiIiIKCiAgICBjbGFzcyBDb25maWdLZXlzOgogICAgICAgIHBhc3MKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZ2V0X2Fuc3dlcnMoZ2VuZXJhdGVkX3RleHQ6IHN0ciwgcXVlc3Rpb25zX2Ftb3VudDogaW50KSAtPiBsaXN0W3N0cl06CiAgICAgICAgIyBDbGVhciBhbnN3ZXIgc3RhcnQgKHBhcnQgYmVmb3JlIG51bWJlcnMpOgogICAgICAgICMgVE9ETyBmaW5kIGJldHRlciB3YXkgdG8gdmVyaWZ5LCBmb3IgbGlzdCBvZiBxdWVzdGlvbnMgdGhpcyBpcyByZWR1bmRhbnQgZm9yIGV4YW1wbGUKICAgICAgICBpZiAiMS4iIG5vdCBpbiBnZW5lcmF0ZWRfdGV4dDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgIGYiQW5zd2VyIDEuIGlzIG1pc3NpbmcgZnJvbSB0aGUgZ2VuZXJhdGVkIHRleHQ6ICd7Z2VuZXJhdGVkX3RleHR9JyIKICAgICAgICAgICAgKQogICAgICAgIHRleHQgPSBnZW5lcmF0ZWRfdGV4dC5zcGxpdCgiMS4iLCAxKVsxXQoKICAgICAgICAjIFN0YXJ0IGV4dHJhY3RpbmcgdGhlIGFuc3dlcnM6CiAgICAgICAgYW5zd2VycyA9IFtdCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMSwgcXVlc3Rpb25zX2Ftb3VudCArIDEpOgogICAgICAgICAgICAjIElmIGl0J3MgdGhlIGxhc3QgYW5zd2VyIHRvIGxvb2sgZm9yLCB0YWtlIHRoZSByZXN0IG9mIHRoZSB0ZXh0OgogICAgICAgICAgICBpZiBpID09IHF1ZXN0aW9uc19hbW91bnQ6CiAgICAgICAgICAgICAgICBhbnN3ZXJfaSA9IHRleHQKICAgICAgICAgICAgIyBWZXJpZnkgdGhlcmUgaXMgYSBxdWVzdGlvbiBudW1iZXIgaW4gdGhlIHRleHQ6CiAgICAgICAgICAgIGVsaWYgZiJ7aSArIDF9LiIgbm90IGluIHRleHQ6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgIGYiQW5zd2VyIHtpICsgMX0uIGlzIG1pc3NpbmcgZnJvbSB0aGUgZ2VuZXJhdGVkIHRleHQ6ICd7Z2VuZXJhdGVkX3RleHR9JyIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgIyBUYWtlIGkncyBhbnN3ZXI6CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBhbnN3ZXJfaSwgdGV4dCA9IHRleHQuc3BsaXQoZiJ7aSArIDF9LiIsIDEpCiAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgYW5zd2VyIHJlbW92aW5nIHJlZHVuZGFudCBzcGFjZXM6CiAgICAgICAgICAgIGFuc3dlcnMuYXBwZW5kKGFuc3dlcl9pLnN0cmlwKCkpCgogICAgICAgIHJldHVybiBhbnN3ZXJzCgogICAgZGVmIF9pbmZlcl9xdWVzdGlvbnMoCiAgICAgICAgc2VsZiwKICAgICAgICBxdWVzdGlvbnNfYW1vdW50OiBpbnQsCiAgICAgICAgYmF0Y2hlZF9pbnB1dDogbGlzdFtzdHJdLAogICAgICAgIGdlbmVyYXRpb25fcGlwZWxpbmU6IHRyYW5zZm9ybWVycy5QaXBlbGluZSwKICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZzogdHJhbnNmb3JtZXJzLkdlbmVyYXRpb25Db25maWcsCiAgICApIC0+IGxpc3RbbGlzdFtzdHJdXToKICAgICAgICAjIEluZmVyIHRocm91Z2ggdGhlIGxsbToKICAgICAgICBiYXRjaGVkX291dHB1dCA9IGdlbmVyYXRpb25fcGlwZWxpbmUoCiAgICAgICAgICAgIGJhdGNoZWRfaW5wdXQsCiAgICAgICAgICAgIGdlbmVyYXRpb25fY29uZmlnPWdlbmVyYXRpb25fY29uZmlnLAogICAgICAgICAgICBlb3NfdG9rZW5faWQ9Z2VuZXJhdGlvbl9waXBlbGluZS50b2tlbml6ZXIuZW9zX3Rva2VuX2lkLAogICAgICAgICAgICByZXR1cm5fZnVsbF90ZXh0PUZhbHNlLAogICAgICAgICAgICBudW1fcmV0dXJuX3NlcXVlbmNlcz0xLAogICAgICAgICkKCiAgICAgICAgIyBQcm9jZXNzIHRoZSBvdXRwdXRzIHRvIGdldCB0aGUgYW5zd2VyczoKICAgICAgICBiYXRjaGVkX2Fuc3dlcnMgPSBbXQogICAgICAgIGZvciBvdXRwdXQgaW4gYmF0Y2hlZF9vdXRwdXQ6CiAgICAgICAgICAgICMgR2V0IHRoZSBnZW5lcmF0ZWQgYW5zd2VyczoKICAgICAgICAgICAgYW5zd2VycyA9IHNlbGYuX2dldF9hbnN3ZXJzKAogICAgICAgICAgICAgICAgZ2VuZXJhdGVkX3RleHQ9b3V0cHV0WzBdWyJnZW5lcmF0ZWRfdGV4dCJdLAogICAgICAgICAgICAgICAgcXVlc3Rpb25zX2Ftb3VudD1xdWVzdGlvbnNfYW1vdW50LAogICAgICAgICAgICApCiAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgcHJvY2Vzc2VkIGFuc3dlcnM6CiAgICAgICAgICAgIGJhdGNoZWRfYW5zd2Vycy5hcHBlbmQoYW5zd2VycykKICAgICAgICByZXR1cm4gYmF0Y2hlZF9hbnN3ZXJzCgogICAgZGVmIGFuc3dlcigKICAgICAgICBzZWxmLAogICAgICAgIHF1ZXN0aW9uc19hbW91bnQ6IGludCwKICAgICAgICBiYXRjaGVkX2lucHV0OiBsaXN0W3N0cl0sCiAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZTogdHJhbnNmb3JtZXJzLlBpcGVsaW5lLAogICAgICAgIGdlbmVyYXRpb25fY29uZmlnOiB0cmFuc2Zvcm1lcnMuR2VuZXJhdGlvbkNvbmZpZywKICAgICkgLT4gbGlzdFtsaXN0W3N0cl1dOgogICAgICAgICIiIgogICAgICAgIEFuc3dlciBxdWVzdGlvbnMgd2l0aCBhIGNvbnRleHQgdG8gdGhlIGdpdmVuIHRleHQgZmlsZXMgY29udGVudHMgYnkgYSBwcmV0cmFpbmVkIExMTSBtb2RlbCBpbiBnaXZlbiBwaXBlbGluZS4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5faW5mZXJfcXVlc3Rpb25zKAogICAgICAgICAgICBxdWVzdGlvbnNfYW1vdW50PXF1ZXN0aW9uc19hbW91bnQsCiAgICAgICAgICAgIGJhdGNoZWRfaW5wdXQ9YmF0Y2hlZF9pbnB1dCwKICAgICAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZT1nZW5lcmF0aW9uX3BpcGVsaW5lLAogICAgICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZz1nZW5lcmF0aW9uX2NvbmZpZywKICAgICAgICApCgoKY2xhc3MgUG9sbFF1ZXN0aW9uSGFuZGxlcihRdWVzdGlvbkhhbmRsZXIpOgogICAgIiIiCiAgICBTdGF0aWMgY2xhc3MgdG8gaG9sZCBhbGwgdGhlIHBvc3NpYmxlIHBvbGwgcXVlc3Rpb24gY29uZmlndXJhdGlvbnMgb3B0aW9ucyBrZXlzCiAgICAiIiIKCiAgICBjbGFzcyBDb25maWdLZXlzOgogICAgICAgICIiIgogICAgICAgIEEgY2xhc3MgZm9yIGhhbmRsaW5nIHF1ZXN0aW9ucyBhbnN3ZXJpbmcgZm9yIHBvbGwgdHlwZSBxdWVzdGlvbnMuCiAgICAgICAgVGhlc2UgdHlwZSBvZiBxdWVzdGlvbiBhcmUgYW5zd2VyZWQgYnkgYXNraW5nIHRoZSBzYW1lIHF1ZXN0aW9uIG11bHRpcGxlIHRpbWVzCiAgICAgICAgYW5kIGNob29zaW5nIHRoZSBtb3N0IGNvbW1vbiBhbnN3ZXIgb3IgdGhlIGF2ZXJhZ2UgYW5zd2VyLgogICAgICAgICIiIgoKICAgICAgICAjOiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRvIGFzayB0aGUgc2FtZSBxdWVzdGlvbi4KICAgICAgICBQT0xMX0NPVU5UID0gInBvbGxfY291bnQiCgogICAgICAgICM6IFRoZSBzdHJhdGVneSB0byB1c2UgZm9yIGNob29zaW5nIHRoZSBhbnN3ZXIgZnJvbSB0aGUgcG9sbC4KICAgICAgICBQT0xMX1NUUkFURUdZID0gInBvbGxfc3RyYXRlZ3kiCgogICAgY2xhc3MgU3RyYXRlZ3koZW51bS5FbnVtKToKICAgICAgICAjOiBUaGUgbW9zdCBjb21tb24gYW5zd2VyIHN0cmF0ZWd5LgogICAgICAgIE1PU1RfQ09NTU9OID0gIm1vc3RfY29tbW9uIgoKICAgICAgICAjOiBUaGUgYXZlcmFnZSBhbnN3ZXIgc3RyYXRlZ3kuCiAgICAgICAgQVZFUkFHRSA9ICJhdmVyYWdlIgoKICAgICAgICBAc3RhdGljbWV0aG9kCiAgICAgICAgZGVmIG1vc3RfY29tbW9uKGFuc3dlcnMpOgogICAgICAgICAgICAiIiIKICAgICAgICAgICAgQ2FsY3VsYXRlIHRoZSBtb3N0IGNvbW1vbiBhbnN3ZXIgZm9yIGEgZ2l2ZW4gbGlzdCBvZiBhbnN3ZXJzLgogICAgICAgICAgICAiIiIKICAgICAgICAgICAgY291bnQgPSBDb3VudGVyKGFuc3dlcnMpCiAgICAgICAgICAgIG1vc3RfY29tbW9uID0gY291bnQubW9zdF9jb21tb24oMSkKICAgICAgICAgICAgcmV0dXJuIG1vc3RfY29tbW9uWzBdWzBdCgogICAgICAgIEBzdGF0aWNtZXRob2QKICAgICAgICBkZWYgYXZlcmFnZShhbnN3ZXJzKToKICAgICAgICAgICAgIiIiCiAgICAgICAgICAgIENhbGN1bGF0ZSB0aGUgYXZlcmFnZSBhbnN3ZXIgZm9yIGEgZ2l2ZW4gbGlzdCBvZiBhbnN3ZXJzLgogICAgICAgICAgICAiIiIKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShhbnN3ZXJzWzBdLCBzdHIpOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgICAgICAiQ2Fubm90IHBlcmZvcm0gcG9sbCB3aXRoIGF2ZXJhZ2UgYW5zd2VyIHN0cmF0ZWd5IG9mIG5vbiBudW1lcmljIHZhbHVlcywiCiAgICAgICAgICAgICAgICAgICAgIiBwbGVhc2UgY2hhbmdlIHRoZSBxdWVzdGlvbiB0byBnaXZlIG51bWVyaWMgZGF0YSwgb3IgY2hvb3NlICdtb3N0X2NvbW1vbicgYXMgc3RyYXRlZ3kuIgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbnVtZXJpY192YWx1ZXMgPSBhbnN3ZXJzCiAgICAgICAgICAgIGF2ZyA9IHN1bShudW1lcmljX3ZhbHVlcykgLyBsZW4obnVtZXJpY192YWx1ZXMpCgogICAgICAgICAgICAjIFJvdW5kIHRvIHRoZSBjbG9zZXN0IGludGVnZXIgYW5kIHJldHVybiBjb3JyZXNwb25kaW5nIHZhbHVlCiAgICAgICAgICAgIHJldHVybiByb3VuZChhdmcpCgogICAgICAgIGRlZiBkbyhzZWxmLCBhbnN3ZXJzKToKICAgICAgICAgICAgIiIiCiAgICAgICAgICAgIFBlcmZvcm0gdGhlIHN0cmF0ZWd5LgogICAgICAgICAgICAiIiIKICAgICAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgc2VsZi52YWx1ZSkoYW5zd2VycykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgcG9sbF9jb3VudDogaW50ID0gNSwgcG9sbF9zdHJhdGVneTogc3RyID0gIm1vc3RfY29tbW9uIik6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpCiAgICAgICAgc2VsZi5wb2xsX2NvdW50ID0gcG9sbF9jb3VudAogICAgICAgIHNlbGYucG9sbF9zdHJhdGVneSA9IHNlbGYuU3RyYXRlZ3kocG9sbF9zdHJhdGVneSkKCiAgICBkZWYgYW5zd2VyKAogICAgICAgIHNlbGYsCiAgICAgICAgcXVlc3Rpb25zX2Ftb3VudDogaW50LAogICAgICAgIGJhdGNoZWRfaW5wdXQ6IGxpc3Rbc3RyXSwKICAgICAgICBnZW5lcmF0aW9uX3BpcGVsaW5lOiB0cmFuc2Zvcm1lcnMuUGlwZWxpbmUsCiAgICAgICAgZ2VuZXJhdGlvbl9jb25maWc6IHRyYW5zZm9ybWVycy5HZW5lcmF0aW9uQ29uZmlnLAogICAgKSAtPiBsaXN0W2xpc3Rbc3RyXV06CiAgICAgICAgIiIiCiAgICAgICAgQW5zd2VyIHF1ZXN0aW9ucyB3aXRoIGEgY29udGV4dCB0byB0aGUgZ2l2ZW4gdGV4dCBmaWxlcyBjb250ZW50cyBieSBhIHByZXRyYWluZWQgTExNIG1vZGVsIGluIGdpdmVuIHBpcGVsaW5lLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLl9hbnN3ZXJfcG9sbF9xdWVzdGlvbnMoCiAgICAgICAgICAgIHF1ZXN0aW9uc19hbW91bnQ9cXVlc3Rpb25zX2Ftb3VudCwKICAgICAgICAgICAgYmF0Y2hlZF9pbnB1dD1iYXRjaGVkX2lucHV0LAogICAgICAgICAgICBnZW5lcmF0aW9uX3BpcGVsaW5lPWdlbmVyYXRpb25fcGlwZWxpbmUsCiAgICAgICAgICAgIGdlbmVyYXRpb25fY29uZmlnPWdlbmVyYXRpb25fY29uZmlnLAogICAgICAgICkKCiAgICBkZWYgX2Fuc3dlcl9wb2xsX3F1ZXN0aW9ucygKICAgICAgICBzZWxmLAogICAgICAgIHF1ZXN0aW9uc19hbW91bnQ6IGludCwKICAgICAgICBiYXRjaGVkX2lucHV0OiBsaXN0W3N0cl0sCiAgICAgICAgZ2VuZXJhdGlvbl9waXBlbGluZTogdHJhbnNmb3JtZXJzLlBpcGVsaW5lLAogICAgICAgIGdlbmVyYXRpb25fY29uZmlnOiB0cmFuc2Zvcm1lcnMuR2VuZXJhdGlvbkNvbmZpZywKICAgICkgLT4gbGlzdFtsaXN0W3N0cl1dOgogICAgICAgIHZvdGVzID0gW10KCiAgICAgICAgIyBSdW4gdGhlIHBvbGwgZm9yIGVhY2ggcXVlc3Rpb24KICAgICAgICBmb3IgXyBpbiByYW5nZShzZWxmLnBvbGxfY291bnQpOgogICAgICAgICAgICBiYXRjaGVkX2Fuc3dlcnMgPSBzZWxmLl9pbmZlcl9xdWVzdGlvbnMoCiAgICAgICAgICAgICAgICBxdWVzdGlvbnNfYW1vdW50PXF1ZXN0aW9uc19hbW91bnQsCiAgICAgICAgICAgICAgICBiYXRjaGVkX2lucHV0PWJhdGNoZWRfaW5wdXQsCiAgICAgICAgICAgICAgICBnZW5lcmF0aW9uX3BpcGVsaW5lPWdlbmVyYXRpb25fcGlwZWxpbmUsCiAgICAgICAgICAgICAgICBnZW5lcmF0aW9uX2NvbmZpZz1nZW5lcmF0aW9uX2NvbmZpZywKICAgICAgICAgICAgKQogICAgICAgICAgICB2b3Rlcy5hcHBlbmQoYmF0Y2hlZF9hbnN3ZXJzKQogICAgICAgIGFuc3dlcnMgPSBbXQoKICAgICAgICAjIENvbGxlY3QgdGhlIGFuc3dlcnMgYWNjb3JkaW5nIHRvIHRoZSBwb2xsIHN0cmF0ZWd5CiAgICAgICAgIyBBdmVyYWdlIHN0cmF0ZWd5IHdvcmtzIGZvciBudW1lcmljIHZhbHVlcyBvbmx5CiAgICAgICAgZm9yIGJhdGNoIGluIHJhbmdlKGxlbih2b3Rlc1swXSkpOgogICAgICAgICAgICBiYXRjaGVkX2Fuc3dlcnMgPSBbXQogICAgICAgICAgICBmb3IgcXVlc3Rpb24gaW4gcmFuZ2UocXVlc3Rpb25zX2Ftb3VudCk6CiAgICAgICAgICAgICAgICAjIENyZWF0ZSBhIGxpc3Qgb2YgYWxsIGFuc3dlcnMgdG8gcmVsZXZhbnQgcXVlc3Rpb24KICAgICAgICAgICAgICAgIGFuc3dlciA9IFsKICAgICAgICAgICAgICAgICAgICB2b3Rlc1t2b3Rlcl1bYmF0Y2hdW3F1ZXN0aW9uXSBmb3Igdm90ZXIgaW4gcmFuZ2Uoc2VsZi5wb2xsX2NvdW50KQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgYW5zd2VyID0gc2VsZi5wb2xsX3N0cmF0ZWd5LmRvKGFuc3dlcikKICAgICAgICAgICAgICAgIGJhdGNoZWRfYW5zd2Vycy5hcHBlbmQoYW5zd2VyKQogICAgICAgICAgICBhbnN3ZXJzLmFwcGVuZChiYXRjaGVkX2Fuc3dlcnMpCiAgICAgICAgcmV0dXJuIGFuc3dlcnMKCgojIEhvbGRzIG5hbWVzIG9mIFF1ZXN0aW9uSGFuZGxlcwpjbGFzcyBRdWVzdGlvblR5cGVzOgogICAgREVGQVVMVCA9ICJkZWZhdWx0IgogICAgUE9MTCA9ICJwb2xsIgoKCiMgTWFwcyBxdWVzdGlvbiB0eXBlcyB0byB0aGVpciBoYW5kbGVycwpRVUVTVElPTl9NQVBQSU5HID0gewogICAgUXVlc3Rpb25UeXBlcy5ERUZBVUxUOiBRdWVzdGlvbkhhbmRsZXIsCiAgICBRdWVzdGlvblR5cGVzLlBPTEw6IFBvbGxRdWVzdGlvbkhhbmRsZXIsCn0K
  command: ''
  filename: question_answering.py
verbose: false
kind: job
metadata:
  tag: ''
  name: question-answering
  categories:
  - genai
