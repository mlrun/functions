kind: job
metadata:
  name: get-offline-features
  tag: ''
  hash: 22cc15eacc16e61f2fc1a9579fabde9ef7a2fce2
  project: ''
  labels:
    author: yonish
  categories:
  - data-preparation
  - data-analysis
  - feature-store
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKZnJvbSB0eXBpbmcgaW1wb3J0IFVuaW9uLCBMaXN0LCBEaWN0CgppbXBvcnQgbWxydW4KaW1wb3J0IG1scnVuLmZlYXR1cmVfc3RvcmUgYXMgZnMKZnJvbSBtbHJ1bi5kYXRhc3RvcmUuc3RvcmVfcmVzb3VyY2VzIGltcG9ydCBpc19zdG9yZV91cmksIHBhcnNlX3N0b3JlX3VyaQpmcm9tIG1scnVuLmRhdGFzdG9yZS50YXJnZXRzIGltcG9ydCBnZXRfdGFyZ2V0X2RyaXZlciwga2luZF90b19kcml2ZXIKZnJvbSBtbHJ1bi5kYXRhc3RvcmUuYmFzZSBpbXBvcnQgRGF0YUl0ZW0KZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4udXRpbHMgaW1wb3J0IFN0b3JlUHJlZml4CmZyb20gbWxydW4uY29tbW9uLmhlbHBlcnMgaW1wb3J0IHBhcnNlX3ZlcnNpb25lZF9vYmplY3RfdXJpCmZyb20gbWxydW4uZXJyb3JzIGltcG9ydCBNTFJ1bkludmFsaWRBcmd1bWVudEVycm9yCgoKZGVmIGdldF9vZmZsaW5lX2ZlYXR1cmVzKAogICAgY29udGV4dDogTUxDbGllbnRDdHgsCiAgICBmZWF0dXJlX3ZlY3Rvcjogc3RyLAogICAgZmVhdHVyZXM6IFVuaW9uW0xpc3Rbc3RyXSwgTm9uZV0gPSBOb25lLAogICAgbGFiZWxfZmVhdHVyZTogc3RyID0gTm9uZSwKICAgIGRlc2NyaXB0aW9uOiBzdHIgPSBOb25lLAogICAgZW50aXR5X3Jvd3M6IERhdGFJdGVtID0gTm9uZSwKICAgIGVudGl0eV90aW1lc3RhbXBfY29sdW1uOiBzdHIgPSBOb25lLAogICAgdGFyZ2V0OiBVbmlvbltzdHIsIERpY3RdID0gTm9uZSwKICAgIHJ1bl9jb25maWc6IFVuaW9uW3N0ciwgRGljdF0gPSBOb25lLAogICAgZHJvcF9jb2x1bW5zOiBMaXN0W3N0cl0gPSBOb25lLAogICAgc3RhcnRfdGltZTogc3RyID0gTm9uZSwKICAgIGVuZF90aW1lOiBzdHIgPSBOb25lLAogICAgd2l0aF9pbmRleGVzOiBib29sID0gRmFsc2UsCiAgICB1cGRhdGVfc3RhdHM6IGJvb2wgPSBGYWxzZSwKKToKICAgICIiInJldHJpZXZlIG9mZmxpbmUgZmVhdHVyZSB2ZWN0b3IgcmVzdWx0cwoKICAgIHNwZWNpZnkgYSBmZWF0dXJlIHZlY3RvciBvYmplY3QvdXJpIGFuZCByZXRyaWV2ZSB0aGUgZGVzaXJlZCBmZWF0dXJlcywgdGhlaXIgbWV0YWRhdGEKICAgIGFuZCBzdGF0aXN0aWNzLiByZXR1cm5zIDpweTpjbGFzczpgfm1scnVuLmZlYXR1cmVfc3RvcmUuT2ZmbGluZVZlY3RvclJlc3BvbnNlYCwKICAgIHJlc3VsdHMgY2FuIGJlIHJldHVybmVkIGFzIGEgZGF0YWZyYW1lIG9yIHdyaXR0ZW4gdG8gYSB0YXJnZXQuCiAgICBJZiBmZWF0dXJlIHZlY3RvciBkb2VzIG5vdCBleGlzdCwgYSBuZXcgb25lIHdpbGwgYmUgY3JlYXRlZCBhbmQgc2F2ZWQgd2l0aCB0aGUgZ2l2ZW4gZmVhdHVyZXMuCgogICAgVGhlIHN0YXJ0X3RpbWUgYW5kIGVuZF90aW1lIGF0dHJpYnV0ZXMgYWxsb3cgZmlsdGVyaW5nIHRoZSBkYXRhIHRvIGEgZ2l2ZW4gdGltZSByYW5nZSwgdGhleSBhY2NlcHQKICAgIHN0cmluZyB2YWx1ZXMgb3IgcGFuZGFzIGBUaW1lc3RhbXBgIG9iamVjdHMsIHN0cmluZyB2YWx1ZXMgY2FuIGFsc28gYmUgcmVsYXRpdmUsIGZvciBleGFtcGxlOgogICAgIm5vdyIsICJub3cgLSAxZDJoIiwgIm5vdys1bSIsIHdoZXJlIGEgdmFsaWQgcGFuZGFzIFRpbWVkZWx0YSBzdHJpbmcgZm9sbG93cyB0aGUgdmVyYiAibm93IiwKICAgIGZvciB0aW1lIGFsaWdubWVudCB5b3UgY2FuIHVzZSB0aGUgdmVyYiAiZmxvb3IiIGUuZy4gIm5vdyAtMWQgZmxvb3IgMUgiIHdpbGwgYWxpZ24gdGhlIHRpbWUgdG8gdGhlIGxhc3QgaG91cgogICAgKHRoZSBmbG9vciBzdHJpbmcgaXMgcGFzc2VkIHRvIHBhbmRhcy5UaW1lc3RhbXAuZmxvb3IoKSwgY2FuIHVzZSBELCBILCBULCBTIGZvciBkYXksIGhvdXIsIG1pbiwgc2VjIGFsaWdubWVudCkKCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICBNTFJ1biBjb250ZXh0CiAgICA6cGFyYW0gZmVhdHVyZV92ZWN0b3I6IGZlYXR1cmUgdmVjdG9yIHVyaQogICAgOnBhcmFtIGZlYXR1cmVzOiAgICAgICBSZWxldmFudCBvbmx5IGlmIGZlYXR1cmVfdmVjdG9yIG5vdCBleGlzdC4gbGlzdCBvZiBmZWF0dXJlIHRvIGNvbGxlY3QgdG8gdGhpcyB2ZWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0IFs8cHJvamVjdD4vXTxmZWF0dXJlX3NldD4uPGZlYXR1cmVfbmFtZSBvciAqPiBbYXMgPGFsaWFzPl0KICAgIDpwYXJhbSBsYWJlbF9mZWF0dXJlOiAgZmVhdHVyZSBuYW1lIHRvIGJlIHVzZWQgYXMgbGFiZWwgZGF0YQogICAgOnBhcmFtIGRlc2NyaXB0aW9uOiAgICB0ZXh0IGRlc2NyaXB0aW9uIG9mIHRoZSB2ZWN0b3IKICAgIDpwYXJhbSBlbnRpdHlfcm93czogICAgVVJJIG9mIHRoZSBkYXRhIGVudGl0eSByb3dzIHRvIGpvaW4gd2l0aAogICAgOnBhcmFtIHRhcmdldDogICAgICAgICB3aGVyZSB0byB3cml0ZSB0aGUgcmVzdWx0cyB0bwogICAgOnBhcmFtIGRyb3BfY29sdW1uczogICBsaXN0IG9mIGNvbHVtbnMgdG8gZHJvcCBmcm9tIHRoZSBmaW5hbCByZXN1bHQKICAgIDpwYXJhbSBlbnRpdHlfdGltZXN0YW1wX2NvbHVtbjogdGltZXN0YW1wIGNvbHVtbiBuYW1lIGluIHRoZSBlbnRpdHkgcm93cyBkYXRhZnJhbWUKICAgIDpwYXJhbSBydW5fY29uZmlnOiAgICAgZnVuY3Rpb24gYW5kL29yIHJ1biBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZSA6cHk6Y2xhc3M6YH5tbHJ1bi5mZWF0dXJlX3N0b3JlLlJ1bkNvbmZpZ2AKICAgIDpwYXJhbSBzdGFydF90aW1lOiAgICAgIGRhdGV0aW1lLCBsb3cgbGltaXQgb2YgdGltZSBuZWVkZWQgdG8gYmUgZmlsdGVyZWQuIE9wdGlvbmFsCiAgICAgICAgZW50aXR5X3RpbWVzdGFtcF9jb2x1bW4gbXVzdCBiZSBwYXNzZWQgd2hlbiB1c2luZyB0aW1lIGZpbHRlcmluZwogICAgOnBhcmFtIGVuZF90aW1lOiAgICAgICAgZGF0ZXRpbWUsIGhpZ2ggbGltaXQgb2YgdGltZSBuZWVkZWQgdG8gYmUgZmlsdGVyZWQuIE9wdGlvbmFsCiAgICAgICAgZW50aXR5X3RpbWVzdGFtcF9jb2x1bW4gbXVzdCBiZSBwYXNzZWQgd2hlbiB1c2luZyB0aW1lIGZpbHRlcmluZwogICAgOnBhcmFtIHdpdGhfaW5kZXhlczogICAgcmV0dXJuIHZlY3RvciB3aXRoIGluZGV4IGNvbHVtbnMgKGRlZmF1bHQgRmFsc2UpCiAgICA6cGFyYW0gdXBkYXRlX3N0YXRzOiAgICB1cGRhdGUgZmVhdHVyZXMgc3RhdGlzdGljcyBmcm9tIHRoZSByZXF1ZXN0ZWQgZmVhdHVyZSBzZXRzIG9uIHRoZSB2ZWN0b3IuIERlZmF1bHQgaXMgRmFsc2UuCgogICAgOnJldHVybnMgZmVhdHVyZV92ZWN0b3IgaW5wdXQKICAgICIiIgoKICAgIGlmIGZlYXR1cmVzOgogICAgICAgICMgQ3JlYXRpbmcgYSBuZXcgRmVhdHVyZVZlY3RvciBhbmQgc2F2aW5nOgogICAgICAgIGlmIGlzX3N0b3JlX3VyaShmZWF0dXJlX3ZlY3Rvcik6CiAgICAgICAgICAgIHByZWZpeCwgbmV3X3VyaSA9IHBhcnNlX3N0b3JlX3VyaShmZWF0dXJlX3ZlY3RvcikKICAgICAgICAgICAgaWYgcHJlZml4ICE9IFN0b3JlUHJlZml4LkZlYXR1cmVWZWN0b3I6CiAgICAgICAgICAgICAgICByYWlzZSBNTFJ1bkludmFsaWRBcmd1bWVudEVycm9yKAogICAgICAgICAgICAgICAgICAgIGYicHJvdmlkZWQgc3RvcmUgdXJpICh7ZmVhdHVyZV92ZWN0b3J9KSBkb2VzIG5vdCByZXByZXNlbnQgYSBmZWF0dXJlIHZlY3RvciAocHJlZml4PXtwcmVmaXh9KSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZmVhdHVyZV92ZWN0b3IgPSBuZXdfdXJpCgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJDcmVhdGluZyBGZWF0dXJlVmVjdG9yIHtmZWF0dXJlX3ZlY3Rvcn0iKQogICAgICAgIHByb2plY3QsIG5hbWUsIHRhZywgXyA9IHBhcnNlX3ZlcnNpb25lZF9vYmplY3RfdXJpKGZlYXR1cmVfdmVjdG9yLCBtbHJ1bi5tbGNvbmYuZGVmYXVsdF9wcm9qZWN0KQogICAgICAgIHZlY3RvciA9IGZzLkZlYXR1cmVWZWN0b3IobmFtZSwgZmVhdHVyZXMsIGxhYmVsX2ZlYXR1cmU9bGFiZWxfZmVhdHVyZSwgZGVzY3JpcHRpb249ZGVzY3JpcHRpb24pCiAgICAgICAgdmVjdG9yLm1ldGFkYXRhLnByb2plY3QgPSBwcm9qZWN0CiAgICAgICAgdmVjdG9yLm1ldGFkYXRhLnRhZyA9IHRhZwogICAgICAgIHZlY3Rvci5zYXZlKCkKICAgICAgICBmZWF0dXJlX3ZlY3Rvcl91cmkgPSB2ZWN0b3IudXJpCiAgICBlbHNlOgogICAgICAgIGlmIGlzX3N0b3JlX3VyaShmZWF0dXJlX3ZlY3Rvcik6CiAgICAgICAgICAgIGZlYXR1cmVfdmVjdG9yX3VyaSA9IGZlYXR1cmVfdmVjdG9yCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdmVjdG9yID0gZnMuZ2V0X2ZlYXR1cmVfdmVjdG9yKGZlYXR1cmVfdmVjdG9yKQogICAgICAgICAgICBmZWF0dXJlX3ZlY3Rvcl91cmkgPSB2ZWN0b3IudXJpCgogICAgIyBQcmVwYXJpbmcgZW50aXR5X3Jvd3M6CiAgICBpZiBlbnRpdHlfcm93cyBpcyBub3QgTm9uZToKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiQ3JlYXRpbmcgRGF0YUZyYW1lIGZyb20gZW50aXR5X3Jvd3MgPSB7ZW50aXR5X3Jvd3N9IikKICAgICAgICBlbnRpdHlfcm93cyA9IGVudGl0eV9yb3dzLmFzX2RmKCkKCiAgICAjIFByZXBhcmluZyB0YXJnZXQ6CiAgICBpZiB0YXJnZXQ6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh0YXJnZXQsIHN0cik6CiAgICAgICAgICAgIHRhcmdldCA9IGtpbmRfdG9fZHJpdmVyW3RhcmdldF0oKQoKICAgICAgICBuYW1lID0gdGFyZ2V0Lm5hbWUgaWYgaGFzYXR0cih0YXJnZXQsICJuYW1lIikgZWxzZSB0YXJnZXRbIm5hbWUiXQogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJQcmVwYXJpbmcgJ3tuYW1lfScgdGFyZ2V0IikKICAgICAgICB0YXJnZXQgPSBnZXRfdGFyZ2V0X2RyaXZlcih0YXJnZXQpCiAgICBpZiBoYXNhdHRyKHRhcmdldCwgJ3BhdGgnKSBhbmQgdGFyZ2V0LnBhdGg6CiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KCJ0YXJnZXQiLCB0YXJnZXQucGF0aCkKCiAgICAjIFByZXBhcmluZyBydW5fY29uZmlnOgogICAgaWYgcnVuX2NvbmZpZyBhbmQgaXNpbnN0YW5jZShydW5fY29uZmlnLCBkaWN0KToKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJQcmVwYXJpbmcgcnVuIGNvbmZpZ3VyYXRpb24iKQogICAgICAgIHJ1bl9jb25maWcgPSBmcy5SdW5Db25maWcoKipydW5fY29uZmlnKQoKICAgICMgQ2FsbGluZyBnZXRfb2ZmbGluZV9mZWF0dXJlczoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oCiAgICAgICAgZiJnZXR0aW5nIG9mZmxpbmUgZmVhdHVyZXMgZnJvbSB0aGUgRmVhdHVyZVZlY3RvciB7ZmVhdHVyZV92ZWN0b3J9IgogICAgKQogICAgZnMuZ2V0X29mZmxpbmVfZmVhdHVyZXMoCiAgICAgICAgZmVhdHVyZV92ZWN0b3I9ZmVhdHVyZV92ZWN0b3JfdXJpLAogICAgICAgIGVudGl0eV9yb3dzPWVudGl0eV9yb3dzLAogICAgICAgIGVudGl0eV90aW1lc3RhbXBfY29sdW1uPWVudGl0eV90aW1lc3RhbXBfY29sdW1uLAogICAgICAgIHRhcmdldD10YXJnZXQsCiAgICAgICAgcnVuX2NvbmZpZz1ydW5fY29uZmlnLAogICAgICAgIGRyb3BfY29sdW1ucz1kcm9wX2NvbHVtbnMsCiAgICAgICAgc3RhcnRfdGltZT1zdGFydF90aW1lLAogICAgICAgIGVuZF90aW1lPWVuZF90aW1lLAogICAgICAgIHdpdGhfaW5kZXhlcz13aXRoX2luZGV4ZXMsCiAgICAgICAgdXBkYXRlX3N0YXRzPXVwZGF0ZV9zdGF0cywKICAgICkKCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoImZlYXR1cmVfdmVjdG9yIiwgZmVhdHVyZV92ZWN0b3IpCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoImZlYXR1cmVfdmVjdG9yX3VyaSIsIGZlYXR1cmVfdmVjdG9yX3VyaSkK
    commands: []
    code_origin: ''
    origin_filename: ''
    requirements: []
  entry_points:
    get_offline_features:
      name: get_offline_features
      doc: 'retrieve offline feature vector results


        specify a feature vector object/uri and retrieve the desired features, their
        metadata

        and statistics. returns :py:class:`~mlrun.feature_store.OfflineVectorResponse`,

        results can be returned as a dataframe or written to a target.

        If feature vector does not exist, a new one will be created and saved with
        the given features.


        The start_time and end_time attributes allow filtering the data to a given
        time range, they accept

        string values or pandas `Timestamp` objects, string values can also be relative,
        for example:

        "now", "now - 1d2h", "now+5m", where a valid pandas Timedelta string follows
        the verb "now",

        for time alignment you can use the verb "floor" e.g. "now -1d floor 1H" will
        align the time to the last hour

        (the floor string is passed to pandas.Timestamp.floor(), can use D, H, T,
        S for day, hour, min, sec alignment)'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context
      - name: feature_vector
        type: str
        doc: feature vector uri
      - name: features
        type: Union[List[str], ]
        doc: Relevant only if feature_vector not exist. list of feature to collect
          to this vector format [<project>/]<feature_set>.<feature_name or *> [as
          <alias>]
        default: null
      - name: label_feature
        type: str
        doc: feature name to be used as label data
        default: null
      - name: description
        type: str
        doc: text description of the vector
        default: null
      - name: entity_rows
        type: DataItem
        doc: URI of the data entity rows to join with
        default: null
      - name: entity_timestamp_column
        type: str
        doc: timestamp column name in the entity rows dataframe
        default: null
      - name: target
        type: Union[str, Dict]
        doc: where to write the results to
        default: null
      - name: run_config
        type: Union[str, Dict]
        doc: function and/or run configuration see :py:class:`~mlrun.feature_store.RunConfig`
        default: null
      - name: drop_columns
        type: List[str]
        doc: list of columns to drop from the final result
        default: null
      - name: start_time
        type: str
        doc: datetime, low limit of time needed to be filtered. Optional entity_timestamp_column
          must be passed when using time filtering
        default: null
      - name: end_time
        type: str
        doc: datetime, high limit of time needed to be filtered. Optional entity_timestamp_column
          must be passed when using time filtering
        default: null
      - name: with_indexes
        type: bool
        doc: return vector with index columns (default False)
        default: false
      - name: update_stats
        type: bool
        doc: update features statistics from the requested feature sets on the vector.
          Default is False.
        default: false
      outputs: []
      lineno: 28
      has_varargs: false
      has_kwargs: false
  description: retrieve offline feature vector results
  default_handler: get_offline_features
  disable_auto_mount: false
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
