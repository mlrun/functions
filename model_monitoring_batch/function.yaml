kind: job
metadata:
  name: model-monitoring-batch
  tag: ''
  hash: e9c9addb1e007ecbf873f8e471e38aa53a8acfbe
  project: default
  categories: []
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env: []
  default_handler: handler
  entry_points:
    compute:
      name: compute
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: capping
        default: null
      - name: kld_scaling
        default: 0.0001
      outputs:
      - default: ''
        type: float
      lineno: 62
    dict_to_histogram:
      name: dict_to_histogram
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: histogram_dict
        default: ''
      outputs:
      - default: ''
      lineno: 110
    compute_metrics_over_df:
      name: compute_metrics_over_df
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram
        default: ''
      - name: latest_histogram
        default: ''
      outputs:
      - default: ''
      lineno: 127
    compute_drift_from_histograms:
      name: compute_drift_from_histograms
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: feature_stats
        default: ''
      - name: current_stats
        default: ''
      outputs:
      - default: ''
      lineno: 138
    post_init:
      name: post_init
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 261
    run:
      name: run
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 274
    check_for_drift:
      name: check_for_drift
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: drift_result
        default: ''
      - name: endpoint
        default: ''
      outputs:
      - default: ''
      lineno: 380
    get_last_created_dir:
      name: get_last_created_dir
      doc: ''
      parameters:
      - name: fs
        default: ''
      - name: endpoint_dir
        default: ''
      outputs:
      - default: ''
      lineno: 405
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: project
        type: str
        default: ''
      outputs:
      - default: ''
      lineno: 412
  description: ''
  build:
    functionSourceCode: aW1wb3J0IGpzb24KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzCmZyb20gdHlwaW5nIGltcG9ydCBPcHRpb25hbCwgTGlzdCwgRGljdAoKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBtbHJ1biBpbXBvcnQgZ2V0X3J1bl9kYgpmcm9tIG1scnVuIGltcG9ydCBzdG9yZV9tYW5hZ2VyCmZyb20gbWxydW4uZGF0YV90eXBlcy5pbmZlciBpbXBvcnQgREZEYXRhSW5mZXIsIEluZmVyT3B0aW9ucwpmcm9tIG1scnVuLnJ1biBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi51dGlscyBpbXBvcnQgbG9nZ2VyLCBjb25maWcKZnJvbSBtbHJ1bi51dGlscy5tb2RlbF9tb25pdG9yaW5nIGltcG9ydCBwYXJzZV9tb2RlbF9lbmRwb2ludF9zdG9yZV9wcmVmaXgKZnJvbSBtbHJ1bi51dGlscy52M2lvX2NsaWVudHMgaW1wb3J0IGdldF92M2lvX2NsaWVudCwgZ2V0X2ZyYW1lc19jbGllbnQKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IEtCaW5zRGlzY3JldGl6ZXIKClRJTUVfRk9STUFUID0gIiVZLSVtLSVkICVIOiVNOiVTLiVmJXoiCgoKQGRhdGFjbGFzcwpjbGFzcyBUb3RhbFZhcmlhbmNlRGlzdGFuY2U6CiAgICAiIiIKICAgIFByb3ZpZGVzIGEgc3ltbWV0cmljIGRyaWZ0IGRpc3RhbmNlIGJldHdlZW4gdHdvIHBlcmlvZHMgdCBhbmQgdQogICAgWiAtIHZlY3RvciBvZiByYW5kb20gdmFyaWFibGVzCiAgICBQdCAtIFByb2JhYmlsaXR5IGRpc3RyaWJ1dGlvbiBvdmVyIHRpbWUgc3BhbiB0CiAgICAiIiIKCiAgICBkaXN0cmliX3Q6IG5wLm5kYXJyYXkKICAgIGRpc3RyaWJfdTogbnAubmRhcnJheQoKICAgIGRlZiBjb21wdXRlKHNlbGYpIC0+IGZsb2F0OgogICAgICAgIHJldHVybiBucC5zdW0obnAuYWJzKHNlbGYuZGlzdHJpYl90IC0gc2VsZi5kaXN0cmliX3UpKSAvIDIKCgpAZGF0YWNsYXNzCmNsYXNzIEhlbGxpbmdlckRpc3RhbmNlOgogICAgIiIiCiAgICBIZWxsaW5nZXIgZGlzdGFuY2UgaXMgYW4gZiBkaXZlcmdlbmNlIG1lYXN1cmUsIHNpbWlsYXIgdG8gdGhlIEt1bGxiYWNrLUxlaWJsZXIgKEtMKSBkaXZlcmdlbmNlLgogICAgSG93ZXZlciwgdW5saWtlIEtMIERpdmVyZ2VuY2UgdGhlIEhlbGxpbmdlciBkaXZlcmdlbmNlIGlzIHN5bW1ldHJpYyBhbmQgYm91bmRlZCBvdmVyIGEgcHJvYmFiaWxpdHkgc3BhY2UuCiAgICAiIiIKCiAgICBkaXN0cmliX3Q6IG5wLm5kYXJyYXkKICAgIGRpc3RyaWJfdTogbnAubmRhcnJheQoKICAgIGRlZiBjb21wdXRlKHNlbGYpIC0+IGZsb2F0OgogICAgICAgIHJldHVybiBucC5zcXJ0KAogICAgICAgICAgICAwLjUgKiAoKG5wLnNxcnQoc2VsZi5kaXN0cmliX3UpIC0gbnAuc3FydChzZWxmLmRpc3RyaWJfdCkpICoqIDIpLnN1bSgpCiAgICAgICAgKQoKCkBkYXRhY2xhc3MKY2xhc3MgS3VsbGJhY2tMZWlibGVyRGl2ZXJnZW5jZToKICAgICIiIgogICAgS0wgRGl2ZXJnZW5jZSAob3IgcmVsYXRpdmUgZW50cm9weSkgaXMgYSBtZWFzdXJlIG9mIGhvdyBvbmUgcHJvYmFiaWxpdHkgZGlzdHJpYnV0aW9uIGRpZmZlcnMgZnJvbSBhbm90aGVyLgogICAgSXQgaXMgYW4gYXN5bW1ldHJpYyBtZWFzdXJlICh0aHVzIGl0J3Mgbm90IGEgbWV0cmljKSBhbmQgaXQgZG9lc24ndCBzYXRpc2Z5IHRoZSB0cmlhbmdsZSBpbmVxdWFsaXR5LgogICAgS0wgRGl2ZXJnZW5jZSBvZiAwLCBpbmRpY2F0ZXMgdHdvIGlkZW50aWNhbCBkaXN0cmlidXRpb25zLgogICAgIiIiCgogICAgZGlzdHJpYl90OiBucC5uZGFycmF5CiAgICBkaXN0cmliX3U6IG5wLm5kYXJyYXkKCiAgICBkZWYgY29tcHV0ZShzZWxmLCBjYXBwaW5nPU5vbmUsIGtsZF9zY2FsaW5nPTAuMDAwMSkgLT4gZmxvYXQ6CiAgICAgICAgdF91ID0gbnAuc3VtKAogICAgICAgICAgICBucC53aGVyZSgKICAgICAgICAgICAgICAgIHNlbGYuZGlzdHJpYl90ICE9IDAsCiAgICAgICAgICAgICAgICAoc2VsZi5kaXN0cmliX3QpCiAgICAgICAgICAgICAgICAqIG5wLmxvZygKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdAogICAgICAgICAgICAgICAgICAgIC8gbnAud2hlcmUoc2VsZi5kaXN0cmliX3UgIT0gMCwgc2VsZi5kaXN0cmliX3UsIGtsZF9zY2FsaW5nKQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICkKICAgICAgICApCiAgICAgICAgdV90ID0gbnAuc3VtKAogICAgICAgICAgICBucC53aGVyZSgKICAgICAgICAgICAgICAgIHNlbGYuZGlzdHJpYl91ICE9IDAsCiAgICAgICAgICAgICAgICAoc2VsZi5kaXN0cmliX3UpCiAgICAgICAgICAgICAgICAqIG5wLmxvZygKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdQogICAgICAgICAgICAgICAgICAgIC8gbnAud2hlcmUoc2VsZi5kaXN0cmliX3QgIT0gMCwgc2VsZi5kaXN0cmliX3QsIGtsZF9zY2FsaW5nKQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICkKICAgICAgICApCiAgICAgICAgcmVzdWx0ID0gdF91ICsgdV90CiAgICAgICAgaWYgY2FwcGluZzoKICAgICAgICAgICAgcmV0dXJuIGNhcHBpbmcgaWYgcmVzdWx0ID09IGZsb2F0KCJpbmYiKSBlbHNlIHJlc3VsdAogICAgICAgIHJldHVybiByZXN1bHQKCgpjbGFzcyBWaXJ0dWFsRHJpZnQ6CiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBwcmVkaWN0aW9uX2NvbDogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgbGFiZWxfY29sOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICAgICBmZWF0dXJlX3dlaWdodHM6IE9wdGlvbmFsW0xpc3RbZmxvYXRdXSA9IE5vbmUsCiAgICAgICAgaW5mX2NhcHBpbmc6IE9wdGlvbmFsW2Zsb2F0XSA9IDEwLAogICAgKToKICAgICAgICBzZWxmLnByZWRpY3Rpb25fY29sID0gcHJlZGljdGlvbl9jb2wKICAgICAgICBzZWxmLmxhYmVsX2NvbCA9IGxhYmVsX2NvbAogICAgICAgIHNlbGYuZmVhdHVyZV93ZWlnaHRzID0gZmVhdHVyZV93ZWlnaHRzCiAgICAgICAgc2VsZi5jYXBwaW5nID0gaW5mX2NhcHBpbmcKICAgICAgICBzZWxmLmRpc2NyZXRpemVyczogRGljdFtzdHIsIEtCaW5zRGlzY3JldGl6ZXJdID0ge30KICAgICAgICBzZWxmLm1ldHJpY3MgPSB7CiAgICAgICAgICAgICJ0dmQiOiBUb3RhbFZhcmlhbmNlRGlzdGFuY2UsCiAgICAgICAgICAgICJoZWxsaW5nZXIiOiBIZWxsaW5nZXJEaXN0YW5jZSwKICAgICAgICAgICAgImtsZCI6IEt1bGxiYWNrTGVpYmxlckRpdmVyZ2VuY2UsCiAgICAgICAgfQoKICAgIGRlZiBkaWN0X3RvX2hpc3RvZ3JhbShzZWxmLCBoaXN0b2dyYW1fZGljdCk6CiAgICAgICAgaGlzdG9ncmFtcyA9IHt9CiAgICAgICAgZm9yIGZlYXR1cmUsIHN0YXRzIGluIGhpc3RvZ3JhbV9kaWN0Lml0ZW1zKCk6CiAgICAgICAgICAgIGhpc3RvZ3JhbXNbZmVhdHVyZV0gPSBzdGF0c1siaGlzdCJdWzBdCgogICAgICAgICMgR2V0IGZlYXR1cmVzIHZhbHVlIGNvdW50cwogICAgICAgIGhpc3RvZ3JhbXMgPSBwZC5jb25jYXQoCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIHBkLkRhdGFGcmFtZShkYXRhPWhpc3QsIGNvbHVtbnM9W2ZlYXR1cmVdKQogICAgICAgICAgICAgICAgZm9yIGZlYXR1cmUsIGhpc3QgaW4gaGlzdG9ncmFtcy5pdGVtcygpCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIGF4aXM9MSwKICAgICAgICApCiAgICAgICAgIyBUbyBEaXN0cmlidXRpb24KICAgICAgICBoaXN0b2dyYW1zID0gaGlzdG9ncmFtcyAvIGhpc3RvZ3JhbXMuc3VtKCkKICAgICAgICByZXR1cm4gaGlzdG9ncmFtcwoKICAgIGRlZiBjb21wdXRlX21ldHJpY3Nfb3Zlcl9kZihzZWxmLCBiYXNlX2hpc3RvZ3JhbSwgbGF0ZXN0X2hpc3RvZ3JhbSk6CiAgICAgICAgZHJpZnRfbWVhc3VyZXMgPSB7fQogICAgICAgIGZvciBtZXRyaWNfbmFtZSwgbWV0cmljIGluIHNlbGYubWV0cmljcy5pdGVtcygpOgogICAgICAgICAgICBkcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV0gPSB7CiAgICAgICAgICAgICAgICBmZWF0dXJlOiBtZXRyaWMoCiAgICAgICAgICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVdLCBsYXRlc3RfaGlzdG9ncmFtLmxvY1s6LCBmZWF0dXJlXQogICAgICAgICAgICAgICAgKS5jb21wdXRlKCkKICAgICAgICAgICAgICAgIGZvciBmZWF0dXJlIGluIGJhc2VfaGlzdG9ncmFtCiAgICAgICAgICAgIH0KICAgICAgICByZXR1cm4gZHJpZnRfbWVhc3VyZXMKCiAgICBkZWYgY29tcHV0ZV9kcmlmdF9mcm9tX2hpc3RvZ3JhbXMoc2VsZiwgZmVhdHVyZV9zdGF0cywgY3VycmVudF9zdGF0cyk6CiAgICAgICAgIyBQcm9jZXNzIGhpc3RvZ3JhbSBkaWN0aW9uYXJpZXMgdG8gRGF0YWZyYW1lIG9mIHRoZSBoaXN0b2dyYW1zCiAgICAgICAgIyB3aXRoIEZlYXR1cmUgaGlzdG9ncmFtIGFzIGNvbHMKICAgICAgICBiYXNlX2hpc3RvZ3JhbSA9IHNlbGYuZGljdF90b19oaXN0b2dyYW0oZmVhdHVyZV9zdGF0cykKICAgICAgICBsYXRlc3RfaGlzdG9ncmFtID0gc2VsZi5kaWN0X3RvX2hpc3RvZ3JhbShjdXJyZW50X3N0YXRzKQoKICAgICAgICAjIFZlcmlmeSBhbGwgdGhlIGZlYXR1cmVzIGV4aXN0IGJldHdlZW4gZGF0YXNldHMKICAgICAgICBiYXNlX2ZlYXR1cmVzID0gc2V0KGJhc2VfaGlzdG9ncmFtLmNvbHVtbnMpCiAgICAgICAgbGF0ZXN0X2ZlYXR1cmVzID0gc2V0KGxhdGVzdF9oaXN0b2dyYW0uY29sdW1ucykKCiAgICAgICAgZmVhdHVyZXNfY29tbW9uID0gbGlzdChiYXNlX2ZlYXR1cmVzLmludGVyc2VjdGlvbihsYXRlc3RfZmVhdHVyZXMpKQogICAgICAgIGZlYXR1cmVfZGlmZmVyZW5jZSA9IGxpc3QoYmFzZV9mZWF0dXJlcyBeIGxhdGVzdF9mZWF0dXJlcykKCiAgICAgICAgaWYgZmVhdHVyZXNfY29tbW9uOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgZiJObyBjb21tb24gZmVhdHVyZXMgZm91bmQ6IHtiYXNlX2ZlYXR1cmVzfSA8PiB7bGF0ZXN0X2ZlYXR1cmVzfSIKICAgICAgICAgICAgKQoKICAgICAgICBiYXNlX2hpc3RvZ3JhbSA9IGJhc2VfaGlzdG9ncmFtLmRyb3AoCiAgICAgICAgICAgIGZlYXR1cmVfZGlmZmVyZW5jZSwgYXhpcz0xLCBlcnJvcnM9Imlnbm9yZSIKICAgICAgICApCiAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbSA9IGxhdGVzdF9oaXN0b2dyYW0uZHJvcCgKICAgICAgICAgICAgZmVhdHVyZV9kaWZmZXJlbmNlLCBheGlzPTEsIGVycm9ycz0iaWdub3JlIgogICAgICAgICkKCiAgICAgICAgIyBDb21wdXRlIHRoZSBkcmlmdCBwZXIgZmVhdHVyZQogICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVzX2NvbW1vbl0sCiAgICAgICAgICAgIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVzX2NvbW1vbl0sCiAgICAgICAgKQoKICAgICAgICAjIENvbXB1dGUgdG90YWwgZHJpZnQgbWVhc3VyZXMgZm9yIGZlYXR1cmVzCiAgICAgICAgZm9yIG1ldHJpY19uYW1lIGluIHNlbGYubWV0cmljcy5rZXlzKCk6CiAgICAgICAgICAgIGZlYXR1cmVfdmFsdWVzID0gbGlzdChmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV0udmFsdWVzKCkpCiAgICAgICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXVsidG90YWxfc3VtIl0gPSBucC5zdW0oZmVhdHVyZV92YWx1ZXMpCiAgICAgICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXVsidG90YWxfbWVhbiJdID0gbnAubWVhbihmZWF0dXJlX3ZhbHVlcykKCiAgICAgICAgICAgICMgQWRkIHdlaWdodGVkIG1lYW4gYnkgZ2l2ZW4gZmVhdHVyZSB3ZWlnaHRzIGlmIHByb3ZpZGVkCiAgICAgICAgICAgIGlmIHNlbGYuZmVhdHVyZV93ZWlnaHRzOgogICAgICAgICAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdWyJ0b3RhbF93ZWlnaHRlZF9tZWFuIl0gPSBucC5kb3QoCiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZV92YWx1ZXMsIHNlbGYuZmVhdHVyZV93ZWlnaHRzCiAgICAgICAgICAgICAgICApCgogICAgICAgIGRyaWZ0X3Jlc3VsdCA9IGRlZmF1bHRkaWN0KGRpY3QpCgogICAgICAgIGZvciBmZWF0dXJlIGluIGZlYXR1cmVzX2NvbW1vbjoKICAgICAgICAgICAgZm9yIG1ldHJpYywgdmFsdWVzIGluIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZmVhdHVyZV1bbWV0cmljXSA9IHZhbHVlc1tmZWF0dXJlXQogICAgICAgICAgICAgICAgc3VtID0gZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljXVsidG90YWxfc3VtIl0KICAgICAgICAgICAgICAgIG1lYW4gPSBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNdWyJ0b3RhbF9tZWFuIl0KICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtmInttZXRyaWN9X3N1bSJdID0gc3VtCiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZiJ7bWV0cmljfV9tZWFuIl0gPSBtZWFuCiAgICAgICAgICAgICAgICBpZiBzZWxmLmZlYXR1cmVfd2VpZ2h0czoKICAgICAgICAgICAgICAgICAgICBtZXRyaWNfbWVhc3VyZSA9IGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY10KICAgICAgICAgICAgICAgICAgICB3ZWlnaHRlZF9tZWFuID0gbWV0cmljX21lYXN1cmVbInRvdGFsX3dlaWdodGVkX21lYW4iXQogICAgICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdFtmInttZXRyaWN9X3dlaWdodGVkX21lYW4iXSA9IHdlaWdodGVkX21lYW4KCiAgICAgICAgaWYgc2VsZi5sYWJlbF9jb2w6CiAgICAgICAgICAgIGxhYmVsX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLmxhYmVsX2NvbF0sCiAgICAgICAgICAgICAgICBsYXRlc3RfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLmxhYmVsX2NvbF0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgZm9yIG1ldHJpYywgdmFsdWVzIGluIGxhYmVsX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbc2VsZi5sYWJlbF9jb2xdW21ldHJpY10gPSB2YWx1ZXNbbWV0cmljXQoKICAgICAgICBpZiBzZWxmLnByZWRpY3Rpb25fY29sOgogICAgICAgICAgICBwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBzZWxmLnByZWRpY3Rpb25fY29sXSwKICAgICAgICAgICAgICAgIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIHNlbGYucHJlZGljdGlvbl9jb2xdLAogICAgICAgICAgICApCiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbc2VsZi5wcmVkaWN0aW9uX2NvbF1bbWV0cmljXSA9IHZhbHVlc1ttZXRyaWNdCgogICAgICAgIHJldHVybiBkcmlmdF9yZXN1bHQKCgpjbGFzcyBCYXRjaFByb2Nlc3NvcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb250ZXh0OiBNTENsaWVudEN0eCwgcHJvamVjdDogc3RyKToKICAgICAgICBzZWxmLmNvbnRleHQgPSBjb250ZXh0CiAgICAgICAgc2VsZi5wcm9qZWN0ID0gcHJvamVjdAogICAgICAgIHNlbGYudmlydHVhbF9kcmlmdCA9IFZpcnR1YWxEcmlmdChpbmZfY2FwcGluZz0xMCkKCiAgICAgICAgdGVtcGxhdGUgPSBjb25maWcubW9kZWxfZW5kcG9pbnRfbW9uaXRvcmluZy5zdG9yZV9wcmVmaXhlcy5kZWZhdWx0CgogICAgICAgIHNlbGYucGFycXVldF9wYXRoID0gdGVtcGxhdGUuZm9ybWF0KHByb2plY3Q9c2VsZi5wcm9qZWN0LCBraW5kPSJwYXJxdWV0IikKCiAgICAgICAga3ZfcGF0aCA9IHRlbXBsYXRlLmZvcm1hdChwcm9qZWN0PXNlbGYucHJvamVjdCwga2luZD0iZW5kcG9pbnRzIikKICAgICAgICBfLCBzZWxmLmt2X2NvbnRhaW5lciwgc2VsZi5rdl9wYXRoID0gcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4KGt2X3BhdGgpCgogICAgICAgIHRzZGJfcGF0aCA9IHRlbXBsYXRlLmZvcm1hdChwcm9qZWN0PXByb2plY3QsIGtpbmQ9ImV2ZW50cyIpCiAgICAgICAgXywgc2VsZi50c2RiX2NvbnRhaW5lciwgc2VsZi50c2RiX3BhdGggPSBwYXJzZV9tb2RlbF9lbmRwb2ludF9zdG9yZV9wcmVmaXgoCiAgICAgICAgICAgIHRzZGJfcGF0aAogICAgICAgICkKCiAgICAgICAgc3RyZWFtX3BhdGggPSB0ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1zZWxmLnByb2plY3QsIGtpbmQ9ImxvZ19zdHJlYW0iKQogICAgICAgIF8sIHNlbGYuc3RyZWFtX2NvbnRhaW5lciwgc2VsZi5zdHJlYW1fcGF0aCA9IHBhcnNlX21vZGVsX2VuZHBvaW50X3N0b3JlX3ByZWZpeCgKICAgICAgICAgICAgc3RyZWFtX3BhdGgKICAgICAgICApCgogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAiSW5pdGlhbGl6aW5nIEJhdGNoUHJvY2Vzc29yIiwKICAgICAgICAgICAgcGFycXVldF9wYXRoPXNlbGYucGFycXVldF9wYXRoLAogICAgICAgICAgICBrdl9jb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgIGt2X3BhdGg9c2VsZi5rdl9wYXRoLAogICAgICAgICAgICB0c2RiX2NvbnRhaW5lcj1zZWxmLnRzZGJfY29udGFpbmVyLAogICAgICAgICAgICB0c2RiX3BhdGg9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgIHN0cmVhbV9jb250YWluZXI9c2VsZi5zdHJlYW1fY29udGFpbmVyLAogICAgICAgICAgICBzdHJlYW1fcGF0aD1zZWxmLnN0cmVhbV9wYXRoLAogICAgICAgICkKCiAgICAgICAgc2VsZi5kZWZhdWx0X3Bvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZCA9ICgKICAgICAgICAgICAgY29uZmlnLm1vZGVsX2VuZHBvaW50X21vbml0b3JpbmcuZHJpZnRfdGhyZXNob2xkcy5kZWZhdWx0LnBvc3NpYmxlX2RyaWZ0CiAgICAgICAgKQogICAgICAgIHNlbGYuZGVmYXVsdF9kcmlmdF9kZXRlY3RlZF90aHJlc2hvbGQgPSAoCiAgICAgICAgICAgIGNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLmRyaWZ0X3RocmVzaG9sZHMuZGVmYXVsdC5kcmlmdF9kZXRlY3RlZAogICAgICAgICkKCiAgICAgICAgc2VsZi5kYiA9IGdldF9ydW5fZGIoKQogICAgICAgIHNlbGYudjNpbyA9IGdldF92M2lvX2NsaWVudCgpCiAgICAgICAgc2VsZi5mcmFtZXMgPSBnZXRfZnJhbWVzX2NsaWVudCgKICAgICAgICAgICAgYWRkcmVzcz1jb25maWcudjNpb19mcmFtZXNkLCBjb250YWluZXI9c2VsZi50c2RiX2NvbnRhaW5lcgogICAgICAgICkKCiAgICBkZWYgcG9zdF9pbml0KHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi52M2lvLnN0cmVhbS5jcmVhdGUoCiAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi5zdHJlYW1fY29udGFpbmVyLAogICAgICAgICAgICAgICAgc3RyZWFtX3BhdGg9c2VsZi5zdHJlYW1fcGF0aCwKICAgICAgICAgICAgICAgIHNoYXJkX2NvdW50PTEsCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGlmICJSZXNvdXJjZUluVXNlRXhjZXB0aW9uIiBpbiBzdHIoZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIlN0cmVhbSBhbHJlYWR5IGV4c2l0cy4uLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBlCgogICAgZGVmIHJ1bihzZWxmKToKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmRwb2ludHMgPSBzZWxmLmRiLmxpc3RfZW5kcG9pbnRzKHNlbGYucHJvamVjdCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIHRvIGxpc3QgZW5kcG9pbnRzIiwgZXhjPWUpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBhY3RpdmVfZW5kcG9pbnRzID0gc2V0KCkKICAgICAgICBmb3IgZW5kcG9pbnQgaW4gZW5kcG9pbnRzLmVuZHBvaW50czoKICAgICAgICAgICAgaWYgZW5kcG9pbnQuc3BlYy5hY3RpdmU6CiAgICAgICAgICAgICAgICBhY3RpdmVfZW5kcG9pbnRzLmFkZChlbmRwb2ludC5tZXRhZGF0YS51aWQpCgogICAgICAgIHN0b3JlLCBzdWIgPSBzdG9yZV9tYW5hZ2VyLmdldF9vcl9jcmVhdGVfc3RvcmUoc2VsZi5wYXJxdWV0X3BhdGgpCiAgICAgICAgcHJlZml4ID0gc2VsZi5wYXJxdWV0X3BhdGgucmVwbGFjZShzdWIsICIiKQogICAgICAgIGZzID0gc3RvcmUuZ2V0X2ZpbGVzeXN0ZW0oc2lsZW50PUZhbHNlKQoKICAgICAgICBmb3IgZW5kcG9pbnRfZGlyIGluIGZzLmxzKHN1Yik6CiAgICAgICAgICAgIGVuZHBvaW50X2lkID0gZW5kcG9pbnRfZGlyWyJuYW1lIl0uc3BsaXQoIj0iKVstMV0KICAgICAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIGFjdGl2ZV9lbmRwb2ludHM6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGFzdF95ZWFyID0gc2VsZi5nZXRfbGFzdF9jcmVhdGVkX2RpcihmcywgZW5kcG9pbnRfZGlyKQogICAgICAgICAgICAgICAgbGFzdF9tb250aCA9IHNlbGYuZ2V0X2xhc3RfY3JlYXRlZF9kaXIoZnMsIGxhc3RfeWVhcikKICAgICAgICAgICAgICAgIGxhc3RfZGF5ID0gc2VsZi5nZXRfbGFzdF9jcmVhdGVkX2RpcihmcywgbGFzdF9tb250aCkKICAgICAgICAgICAgICAgIGxhc3RfaG91ciA9IHNlbGYuZ2V0X2xhc3RfY3JlYXRlZF9kaXIoZnMsIGxhc3RfZGF5KQoKICAgICAgICAgICAgICAgIHBhcnF1ZXRfZmlsZXMgPSBmcy5scyhsYXN0X2hvdXJbIm5hbWUiXSkKICAgICAgICAgICAgICAgIGxhc3RfcGFycXVldCA9IHNvcnRlZChwYXJxdWV0X2ZpbGVzLCBrZXk9bGFtYmRhIGs6IGtbIm10aW1lIl0pWy0xXQogICAgICAgICAgICAgICAgcGFycXVldF9uYW1lID0gbGFzdF9wYXJxdWV0WyJuYW1lIl0KICAgICAgICAgICAgICAgIGZ1bGxfcGF0aCA9IGYie3ByZWZpeH17cGFycXVldF9uYW1lfSIKCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5vdyBwcm9jZXNzaW5nIHtmdWxsX3BhdGh9IikKCiAgICAgICAgICAgICAgICBlbmRwb2ludCA9IHNlbGYuZGIuZ2V0X2VuZHBvaW50KAogICAgICAgICAgICAgICAgICAgIHByb2plY3Q9c2VsZi5wcm9qZWN0LCBlbmRwb2ludF9pZD1lbmRwb2ludF9pZAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGRmID0gcGQucmVhZF9wYXJxdWV0KGZ1bGxfcGF0aCkKICAgICAgICAgICAgICAgIHRpbWVzdGFtcCA9IGRmWyJ0aW1lc3RhbXAiXS5pbG9jWy0xXQoKICAgICAgICAgICAgICAgIG5hbWVkX2ZlYXR1cmVzX2RmID0gbGlzdChkZlsibmFtZWRfZmVhdHVyZXMiXSkKICAgICAgICAgICAgICAgIG5hbWVkX2ZlYXR1cmVzX2RmID0gcGQuRGF0YUZyYW1lKG5hbWVkX2ZlYXR1cmVzX2RmKQoKICAgICAgICAgICAgICAgIGN1cnJlbnRfc3RhdHMgPSBERkRhdGFJbmZlci5nZXRfc3RhdHMoCiAgICAgICAgICAgICAgICAgICAgZGY9bmFtZWRfZmVhdHVyZXNfZGYsIG9wdGlvbnM9SW5mZXJPcHRpb25zLkhpc3RvZ3JhbQogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdCA9IHNlbGYudmlydHVhbF9kcmlmdC5jb21wdXRlX2RyaWZ0X2Zyb21faGlzdG9ncmFtcygKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX3N0YXRzPWVuZHBvaW50LnN0YXR1cy5mZWF0dXJlX3N0YXRzLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfc3RhdHM9Y3VycmVudF9zdGF0cywKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiRHJpZnQgcmVzdWx0IiwgZHJpZnRfcmVzdWx0PWRyaWZ0X3Jlc3VsdCkKCiAgICAgICAgICAgICAgICBkcmlmdF9zdGF0dXMsIGRyaWZ0X21lYXN1cmUgPSBzZWxmLmNoZWNrX2Zvcl9kcmlmdCgKICAgICAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHQ9ZHJpZnRfcmVzdWx0LCBlbmRwb2ludD1lbmRwb2ludAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgICJEcmlmdCBzdGF0dXMiLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgICAgIGRyaWZ0X3N0YXR1cz1kcmlmdF9zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgZHJpZnRfbWVhc3VyZT1kcmlmdF9tZWFzdXJlLAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGlmIGRyaWZ0X3N0YXR1cyA9PSAiUE9TU0lCTEVfRFJJRlQiIG9yIGRyaWZ0X3N0YXR1cyA9PSAiRFJJRlRfREVURUNURUQiOgogICAgICAgICAgICAgICAgICAgIHNlbGYudjNpby5zdHJlYW0ucHV0X3JlY29yZHMoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLnN0cmVhbV9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbV9wYXRoPXNlbGYuc3RyZWFtX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZHM9W3siZHJpZnRfc3RhdHVzIjogZHJpZnRfc3RhdHVzLCAqKmRyaWZ0X3Jlc3VsdH1dLAogICAgICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBzZWxmLnYzaW8ua3YudXBkYXRlKAogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLmt2X2NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0YWJsZV9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgICAgICAgICBrZXk9ZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlcz17CiAgICAgICAgICAgICAgICAgICAgICAgICJjdXJyZW50X3N0YXRzIjoganNvbi5kdW1wcyhjdXJyZW50X3N0YXRzKSwKICAgICAgICAgICAgICAgICAgICAgICAgImRyaWZ0X21lYXN1cmVzIjoganNvbi5kdW1wcyhkcmlmdF9yZXN1bHQpLAogICAgICAgICAgICAgICAgICAgICAgICAiZHJpZnRfc3RhdHVzIjogZHJpZnRfc3RhdHVzLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgdHNkYl9kcmlmdF9tZWFzdXJlcyA9IHsKICAgICAgICAgICAgICAgICAgICAiZW5kcG9pbnRfaWQiOiBlbmRwb2ludF9pZCwKICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogcGQudG9fZGF0ZXRpbWUodGltZXN0YW1wLCBmb3JtYXQ9VElNRV9GT1JNQVQpLAogICAgICAgICAgICAgICAgICAgICJyZWNvcmRfdHlwZSI6ICJkcmlmdF9tZWFzdXJlcyIsCiAgICAgICAgICAgICAgICAgICAgInR2ZF9tZWFuIjogZHJpZnRfcmVzdWx0WyJ0dmRfbWVhbiJdLAogICAgICAgICAgICAgICAgICAgICJrbGRfbWVhbiI6IGRyaWZ0X3Jlc3VsdFsia2xkX21lYW4iXSwKICAgICAgICAgICAgICAgICAgICAiaGVsbGluZ2VyX21lYW4iOiBkcmlmdF9yZXN1bHRbImhlbGxpbmdlcl9tZWFuIl0sCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2VsZi5mcmFtZXMud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgYmFja2VuZD0idHNkYiIsCiAgICAgICAgICAgICAgICAgICAgdGFibGU9c2VsZi50c2RiX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgZGZzPXBkLkRhdGFGcmFtZS5mcm9tX2RpY3QoW3RzZGJfZHJpZnRfbWVhc3VyZXNdKSwKICAgICAgICAgICAgICAgICAgICBpbmRleF9jb2xzPVsidGltZXN0YW1wIiwgImVuZHBvaW50X2lkIiwgInJlY29yZF90eXBlIl0sCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJEb25lIHVwZGF0aW5nIGRyaWZ0IG1lYXN1cmVzIHtmdWxsX3BhdGh9IikKCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlKQoKICAgIGRlZiBjaGVja19mb3JfZHJpZnQoc2VsZiwgZHJpZnRfcmVzdWx0LCBlbmRwb2ludCk6CiAgICAgICAgdHZkX21lYW4gPSBkcmlmdF9yZXN1bHQuZ2V0KCJ0dmRfbWVhbiIpCiAgICAgICAgaGVsbGluZ2VyX21lYW4gPSBkcmlmdF9yZXN1bHQuZ2V0KCJoZWxsaW5nZXJfbWVhbiIpCgogICAgICAgIGRyaWZ0X21lYW4gPSAwLjAKICAgICAgICBpZiB0dmRfbWVhbiBhbmQgaGVsbGluZ2VyX21lYW46CiAgICAgICAgICAgIGRyaWZ0X21lYW4gPSAodHZkX21lYW4gKyBoZWxsaW5nZXJfbWVhbikgLyAyCgogICAgICAgIG1vbml0b3JfY29uZmlndXJhdGlvbiA9IGVuZHBvaW50LnNwZWMubW9uaXRvcl9jb25maWd1cmF0aW9uIG9yIHt9CgogICAgICAgIHBvc3NpYmxlX2RyaWZ0ID0gbW9uaXRvcl9jb25maWd1cmF0aW9uLmdldCgKICAgICAgICAgICAgInBvc3NpYmxlX2RyaWZ0Iiwgc2VsZi5kZWZhdWx0X3Bvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZAogICAgICAgICkKICAgICAgICBkcmlmdF9kZXRlY3RlZCA9IG1vbml0b3JfY29uZmlndXJhdGlvbi5nZXQoCiAgICAgICAgICAgICJwb3NzaWJsZV9kcmlmdCIsIHNlbGYuZGVmYXVsdF9kcmlmdF9kZXRlY3RlZF90aHJlc2hvbGQKICAgICAgICApCgogICAgICAgIGRyaWZ0X3N0YXR1cyA9ICJOT19EUklGVCIKICAgICAgICBpZiBkcmlmdF9tZWFuID49IGRyaWZ0X2RldGVjdGVkOgogICAgICAgICAgICBkcmlmdF9zdGF0dXMgPSAiRFJJRlRfREVURUNURUQiCiAgICAgICAgZWxpZiBkcmlmdF9tZWFuID49IHBvc3NpYmxlX2RyaWZ0OgogICAgICAgICAgICBkcmlmdF9zdGF0dXMgPSAiUE9TU0lCTEVfRFJJRlQiCgogICAgICAgIHJldHVybiBkcmlmdF9zdGF0dXMsIGRyaWZ0X21lYW4KCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZ2V0X2xhc3RfY3JlYXRlZF9kaXIoZnMsIGVuZHBvaW50X2Rpcik6CiAgICAgICAgZGlycyA9IGZzLmxzKGVuZHBvaW50X2RpclsibmFtZSJdKQogICAgICAgIGxhc3RfZGlyID0gc29ydGVkKGRpcnMsIGtleT1sYW1iZGEgazoga1sibmFtZSJdLnNwbGl0KCI9IilbLTFdKVstMV0KICAgICAgICByZXR1cm4gbGFzdF9kaXIKCgpkZWYgaGFuZGxlcihjb250ZXh0OiBNTENsaWVudEN0eCwgcHJvamVjdDogc3RyKToKICAgIGJhdGNoX3Byb2Nlc3NvciA9IEJhdGNoUHJvY2Vzc29yKGNvbnRleHQsIHByb2plY3QpCiAgICBiYXRjaF9wcm9jZXNzb3IucG9zdF9pbml0KCkKICAgIGJhdGNoX3Byb2Nlc3Nvci5ydW4oKQo=
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#62f6850a580b2a82c6d53655c6e0da240d7b3aab:/home/michaell/projects/functions/model_monitoring_batch/model_monitoring_batch.py
verbose: false
