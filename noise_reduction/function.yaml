metadata:
  categories:
  - data-preparation
  - audio
  name: noise-reduction
  tag: ''
verbose: false
spec:
  entry_points:
    reduce_noise:
      doc: 'Reduce noise from audio file or directory containing audio files.

        The audio files must be in .wav format.

        The cleaned audio files will be saved in the target_directory.

        For information about the noise reduction algorithm see:

        https://github.com/timsainb/noisereduce

        Notice that the saved files are in wav format, even if the original files
        are in other format.'
      lineno: 388
      name: reduce_noise
      parameters:
      - name: audio_source
        type: str
        doc: path to audio file or directory containing audio files
      - name: target_directory
        type: str
        doc: path to directory to save the cleaned audio files.
      - name: sample_rate
        type: int
        doc: Number of samples in one second in the audio file. Pass `None` to keep
          the original sample rate.
        default: 16000
      - name: duration
        type: int
        doc: Duration of the audio file to clean in seconds. Pass `None` to keep the
          original duration.
        default: null
      - name: channel
        type: int
        doc: Channel to clean. Pass the number of the channel to clean. To clean all
          channels pass None.
        default: null
      - name: silence_threshold
        type: float
        doc: The threshold to remove silence from the audio, in dB. If None, no silence
          removal is performed.
        default: null
      - name: use_multiprocessing
        type: int
        doc: Number of processes to use for cleaning the audio files. If 0, no multiprocessing
          is used.
        default: 0
      - name: verbose
        type: bool
        doc: Verbosity level. If True, display progress bar.
        default: true
      has_varargs: false
      has_kwargs: false
    clean_audio:
      doc: ''
      lineno: 276
      name: clean_audio
      outputs:
      - type: torch.Tensor
      parameters:
      - name: self
      - name: data
        type: Tensor
      has_varargs: false
      has_kwargs: false
    save_audio:
      doc: ''
      lineno: 256
      name: save_audio
      parameters:
      - name: self
      - name: audio
        type: ndarray
      - name: target_path
        type: Path
      has_varargs: false
      has_kwargs: false
    load_audio:
      doc: ''
      lineno: 268
      name: load_audio
      outputs:
      - type: torch.Tensor
      parameters:
      - name: self
      - name: file
        type: str
      has_varargs: false
      has_kwargs: false
    update_to_wav_suffix:
      doc: ''
      lineno: 125
      name: update_to_wav_suffix
      parameters:
      - name: self
      - name: audio_file
        type: Path
      has_varargs: false
      has_kwargs: false
    remove_silence:
      doc: Remove silence sections from the audio.
      lineno: 134
      name: remove_silence
      outputs:
      - doc: The audio without silence.
      parameters:
      - name: self
      - name: audio
        type: ndarray
        doc: The audio to remove silence from.
      has_varargs: false
      has_kwargs: false
    reduce_noise_dfn:
      doc: 'Reduce noise from audio files using DeepFilterNet.

        For more information about the noise reduction algorithm see:

        https://github.com/Rikorose/DeepFilterNet

        Notice that the saved files are in wav format, even if the original files
        are in other format.'
      lineno: 322
      name: reduce_noise_dfn
      parameters:
      - name: audio_source
        type: str
        doc: path to audio file or directory of audio files
      - name: target_directory
        type: str
        doc: path to target directory to save cleaned audio files
      - name: pad
        type: bool
        doc: whether to pad the audio file with zeros before cleaning
        default: true
      - name: atten_lim_db
        type: int
        doc: maximum attenuation in dB
        default: null
      - name: silence_threshold
        type: float
        doc: the threshold to remove silence from the audio, in dB. If None, no silence
          removal is performed.
        default: null
      - name: use_multiprocessing
        type: int
        doc: Number of processes to use for cleaning the audio files. If 0, no multiprocessing
          is used.
        default: 0
      - name: verbose
        type: bool
        doc: verbosity level. If True, display progress bar and logs.
        default: true
      has_varargs: false
      has_kwargs: true
  image: ''
  default_handler: reduce_noise
  description: Reduce noise from audio files
  command: ''
  build:
    base_image: mlrun/mlrun
    origin_filename: ''
    code_origin: ''
    functionSourceCode: aW1wb3J0IGxvZ2dpbmcKZnJvbSBhYmMgaW1wb3J0IEFCQ01ldGEsIGFic3RyYWN0bWV0aG9kCmZyb20gbXVsdGlwcm9jZXNzaW5nIGltcG9ydCBQcm9jZXNzLCBRdWV1ZQpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QsIFR1cGxlLCBUeXBlLCBVbmlvbgoKaW1wb3J0IGxpYnJvc2EKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCB0b3JjaApmcm9tIHNjaXB5LmlvIGltcG9ydCB3YXZmaWxlCmZyb20gdHFkbSBpbXBvcnQgdHFkbQoKIzogVGhlIHZhbHVlIHRvIHNlbmQgaW50byBtdWx0aXByb2Nlc3NpbmcgcXVldWVzIHRvIHN0b3AgdGhlIHByb2Nlc3M6Cl9NVUxUSVBST0NFU1NJTkdfU1RPUF9NQVJLID0gIlNUT1AiCgojIEdldCB0aGUgZ2xvYmFsIGxvZ2dlcjoKdHJ5OgogICAgaW1wb3J0IG1scnVuCgogICAgX0xPR0dFUiA9IG1scnVuLmdldF9vcl9jcmVhdGVfY3R4KCJub2lzZV9yZWR1Y2UiKS5sb2dnZXIKZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3I6CiAgICBfTE9HR0VSID0gbG9nZ2luZy5nZXRMb2dnZXIoKQoKCmNsYXNzIFJlZHVjZU5vaXNlQmFzZShtZXRhY2xhc3M9QUJDTWV0YSk6CiAgICAiIiIKICAgIEJhc2UgY2xhc3MgZm9yIG5vaXNlIHJlZHVjdGlvbi4KICAgIFRoaXMgY2xhc3MgaXMgYWltZWQgdG8gYmUgaW5oZXJpdGVkIGJ5IHNwZWNpZmljIG5vaXNlIHJlZHVjdGlvbiBhbGdvcml0aG1zLgogICAgWW91IG11c3QgaW1wbGVtZW50IHRoZSBmb2xsb3dpbmcgbWV0aG9kczoKICAgIC0gY2xlYW5fYXVkaW86ICBUaGUgbWV0aG9kIHRvIGNsZWFuIHRoZSBhdWRpbywgd2hlcmUgdGhlIG5vaXNlIHJlZHVjdGlvbiBhbGdvcml0aG0gaXMgaW1wbGVtZW50ZWQuCiAgICAtIHNhdmVfYXVkaW86ICAgVGhlIG1ldGhvZCB0byBzYXZlIHRoZSBhdWRpbyB0byBhIGZpbGUuCiAgICAtIGxvYWRfYXVkaW86ICAgVGhlIG1ldGhvZCB0byBsb2FkIHRoZSBhdWRpbyBmcm9tIGEgZmlsZS4KCiAgICBBZnRlciBpbXBsZW1lbnRpbmcgdGhlIGFib3ZlIG1ldGhvZHMsIHlvdSBjYW4gdXNlIHRoZSByZWR1Y2Vfbm9pc2UgbWV0aG9kIHRvIHJlZHVjZSBub2lzZSBmcm9tIGF1ZGlvIGZpbGVzLgogICAgIiIiCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICB0YXJnZXRfZGlyZWN0b3J5OiBQYXRoLAogICAgICAgIHZlcmJvc2U6IGJvb2wgPSBUcnVlLAogICAgICAgIHNpbGVuY2VfdGhyZXNob2xkOiBmbG9hdCA9IE5vbmUsCiAgICApOgogICAgICAgIHNlbGYudGFyZ2V0X2RpcmVjdG9yeSA9IFBhdGgodGFyZ2V0X2RpcmVjdG9yeSkKICAgICAgICBzZWxmLnZlcmJvc2UgPSB2ZXJib3NlCiAgICAgICAgc2VsZi5zaWxlbmNlX3RocmVzaG9sZCA9IHNpbGVuY2VfdGhyZXNob2xkCgogICAgZGVmIHJlZHVjZV9ub2lzZShzZWxmLCBhdWRpb19maWxlOiBQYXRoKSAtPiBUdXBsZVtib29sLCBUdXBsZVtzdHIsIHN0cl1dOgogICAgICAgICIiIgogICAgICAgIFJlZHVjZSBub2lzZSBmcm9tIHRoZSBnaXZlbiBhdWRpbyBmaWxlLgoKICAgICAgICA6cGFyYW0gYXVkaW9fZmlsZTogIFRoZSBhdWRpbyBmaWxlIHRvIHJlZHVjZSBub2lzZSBmcm9tLgoKICAgICAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKICAgICAgICAgLSBhIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIGFuIGVycm9yIG9jY3VycmVkCiAgICAgICAgIC0gYSB0dXBsZSBvZjoKICAgICAgICAgICAgLSBhdWRpbyBmaWxlIG5hbWUKICAgICAgICAgICAgLSB0YXJnZXQgcGF0aCBpbiBjYXNlIG9mIHN1Y2Nlc3MgLyBlcnJvciBtZXNzYWdlIGluIGNhc2Ugb2YgZmFpbHVyZS4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIF9MT0dHRVIuaW5mbyhmIlJlZHVjaW5nIG5vaXNlIGZyb20ge2F1ZGlvX2ZpbGUubmFtZX0uIikKCiAgICAgICAgICAgICMgTG9hZCBhdWRpbyBkYXRhOgogICAgICAgICAgICBhdWRpbyA9IHNlbGYubG9hZF9hdWRpbyhmaWxlPXN0cihhdWRpb19maWxlKSkKCiAgICAgICAgICAgICMgUGVyZm9ybSBub2lzZSByZWR1Y3Rpb246CiAgICAgICAgICAgIHJlZHVjZWRfbm9pc2UgPSBzZWxmLmNsZWFuX2F1ZGlvKGRhdGE9YXVkaW8pCgogICAgICAgICAgICAjIFJlbW92ZSBzaWxlbmNlIGZyb20gdGhlIGF1ZGlvIGlmIG5lY2Vzc2FyeToKICAgICAgICAgICAgcmVkdWNlZF9ub2lzZSA9IHNlbGYucmVtb3ZlX3NpbGVuY2UoYXVkaW89cmVkdWNlZF9ub2lzZSkKCiAgICAgICAgICAgICMgUHJlcGFyZSB0YXJnZXQgcGF0aDoKICAgICAgICAgICAgdGFyZ2V0X3BhdGggPSBzZWxmLnVwZGF0ZV90b193YXZfc3VmZml4KGF1ZGlvX2ZpbGU9YXVkaW9fZmlsZSkKCiAgICAgICAgICAgICMgU2F2ZSBmaWxlOgogICAgICAgICAgICBzZWxmLnNhdmVfYXVkaW8oCiAgICAgICAgICAgICAgICBhdWRpbz1yZWR1Y2VkX25vaXNlLAogICAgICAgICAgICAgICAgdGFyZ2V0X3BhdGg9dGFyZ2V0X3BhdGgsCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIF9MT0dHRVIuaW5mbyhmIlNhdmVkIGNsZWFuZWQgYXVkaW8gZmlsZSB0byB7dGFyZ2V0X3BhdGh9LiIpCgogICAgICAgICAgICByZXR1cm4gRmFsc2UsIChhdWRpb19maWxlLm5hbWUsIHN0cih0YXJnZXRfcGF0aCkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGNlcHRpb246CiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIF9MT0dHRVIuZXJyb3IoZiJGYWlsZWQgdG8gcmVkdWNlIG5vaXNlIGZyb20ge2F1ZGlvX2ZpbGUubmFtZX0uIikKICAgICAgICAgICAgICAgIF9MT0dHRVIuZXJyb3IoZiJFcnJvcjoge2V4Y2VwdGlvbn0iKQogICAgICAgICAgICAjIENvbGxlY3QgdGhlIGVycm9yOgogICAgICAgICAgICByZXR1cm4gVHJ1ZSwgKGF1ZGlvX2ZpbGUubmFtZSwgc3RyKGV4Y2VwdGlvbikpCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgY2xlYW5fYXVkaW8oc2VsZiwgZGF0YSkgLT4gVW5pb25bbnAubmRhcnJheSwgdG9yY2guVGVuc29yXToKICAgICAgICAiIiIKICAgICAgICBDbGVhbiB0aGUgYXVkaW8gZnJvbSBub2lzZS4gSGVyZSB5b3Ugc2hvdWxkIGltcGxlbWVudCB0aGUgbm9pc2UgcmVkdWN0aW9uIGFsZ29yaXRobS4KCiAgICAgICAgOnBhcmFtIGRhdGE6ICAgIFRoZSBhdWRpbyBkYXRhIHRvIGNsZWFuLgoKICAgICAgICA6cmV0dXJuczogVGhlIGNsZWFuZWQgYXVkaW8uCiAgICAgICAgIiIiCiAgICAgICAgcGFzcwoKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIHNhdmVfYXVkaW8oc2VsZiwgYXVkaW86IG5wLm5kYXJyYXksIHRhcmdldF9wYXRoOiBQYXRoKToKICAgICAgICAiIiIKICAgICAgICBTYXZlIHRoZSBhdWRpbyB0byBhIGZpbGUuCgogICAgICAgIDpwYXJhbSBhdWRpbzogICAgICAgVGhlIGF1ZGlvIHRvIHNhdmUuCiAgICAgICAgOnBhcmFtIHRhcmdldF9wYXRoOiBUaGUgdGFyZ2V0IHBhdGggdG8gc2F2ZSB0aGUgYXVkaW8gdG8uCiAgICAgICAgIiIiCiAgICAgICAgcGFzcwoKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIGxvYWRfYXVkaW8oc2VsZiwgZmlsZTogc3RyKSAtPiBUdXBsZVtVbmlvbltucC5uZGFycmF5LCB0b3JjaC5UZW5zb3JdLCBpbnRdOgogICAgICAgICIiIgogICAgICAgIExvYWQgdGhlIGF1ZGlvIGZyb20gYSBmaWxlLgoKICAgICAgICA6cGFyYW0gZmlsZTogICAgVGhlIGZpbGUgdG8gbG9hZCB0aGUgYXVkaW8gZnJvbS4KCiAgICAgICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CiAgICAgICAgICAgIC0gdGhlIGF1ZGlvIGRhdGEKICAgICAgICAgICAgLSB0aGUgc2FtcGxlIHJhdGUKICAgICAgICAiIiIKICAgICAgICBwYXNzCgogICAgZGVmIHVwZGF0ZV90b193YXZfc3VmZml4KHNlbGYsIGF1ZGlvX2ZpbGU6IFBhdGgpOgogICAgICAgIHRhcmdldF9wYXRoID0gc2VsZi50YXJnZXRfZGlyZWN0b3J5IC8gYXVkaW9fZmlsZS5uYW1lCiAgICAgICAgaWYgdGFyZ2V0X3BhdGguc3VmZml4ICE9ICIud2F2IjoKICAgICAgICAgICAgb2xkX3N1ZmZpeCA9IHRhcmdldF9wYXRoLnN1ZmZpeFsxOl0KICAgICAgICAgICAgdGFyZ2V0X3BhdGggPSB0YXJnZXRfcGF0aC53aXRoX3N0ZW0odGFyZ2V0X3BhdGguc3RlbSArIGYiX3tvbGRfc3VmZml4fSIpCiAgICAgICAgICAgIHJldHVybiB0YXJnZXRfcGF0aC53aXRoX3N1ZmZpeCgiLndhdiIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHRhcmdldF9wYXRoCgogICAgZGVmIHJlbW92ZV9zaWxlbmNlKAogICAgICAgIHNlbGYsCiAgICAgICAgYXVkaW86IG5wLm5kYXJyYXksCiAgICApOgogICAgICAgICIiIgogICAgICAgIFJlbW92ZSBzaWxlbmNlIHNlY3Rpb25zIGZyb20gdGhlIGF1ZGlvLgoKICAgICAgICA6cGFyYW0gYXVkaW86ICAgVGhlIGF1ZGlvIHRvIHJlbW92ZSBzaWxlbmNlIGZyb20uCgogICAgICAgIDpyZXR1cm5zOiBUaGUgYXVkaW8gd2l0aG91dCBzaWxlbmNlLgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYuc2lsZW5jZV90aHJlc2hvbGQgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGF1ZGlvCgogICAgICAgICMgR2V0IHRoZSBpbmRpY2VzIG9mIHRoZSBub24tc2lsZW50IGZyYW1lczoKICAgICAgICBub25fc2lsZW50X2luZGljZXMgPSBsaWJyb3NhLmVmZmVjdHMuc3BsaXQoCiAgICAgICAgICAgIHk9YXVkaW8sCiAgICAgICAgICAgIHRvcF9kYj1zZWxmLnNpbGVuY2VfdGhyZXNob2xkLAogICAgICAgICAgICBmcmFtZV9sZW5ndGg9MjA0OCwKICAgICAgICAgICAgaG9wX2xlbmd0aD0yNTYsCiAgICAgICAgKQoKICAgICAgICAjIEdldCB0aGUgbm9uLXNpbGVudCBhdWRpbzoKICAgICAgICBub25fc2lsZW50X2F1ZGlvID0gbnAuY29uY2F0ZW5hdGUoCiAgICAgICAgICAgIFthdWRpb1s6LCBzdGFydDplbmRdIGZvciBzdGFydCwgZW5kIGluIG5vbl9zaWxlbnRfaW5kaWNlc10sIGF4aXM9MQogICAgICAgICkKCiAgICAgICAgcmV0dXJuIG5vbl9zaWxlbnRfYXVkaW8KCgpjbGFzcyBSZWR1Y2VOb2lzZShSZWR1Y2VOb2lzZUJhc2UpOgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgdGFyZ2V0X2RpcmVjdG9yeTogUGF0aCwKICAgICAgICB2ZXJib3NlOiBib29sID0gVHJ1ZSwKICAgICAgICBzaWxlbmNlX3RocmVzaG9sZDogZmxvYXQgPSBOb25lLAogICAgICAgIHNhbXBsZV9yYXRlOiBpbnQgPSAxNjAwMCwKICAgICAgICBkdXJhdGlvbjogaW50ID0gTm9uZSwKICAgICAgICBjaGFubmVsOiBpbnQgPSBOb25lLAogICAgKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKHRhcmdldF9kaXJlY3RvcnksIHZlcmJvc2UsIHNpbGVuY2VfdGhyZXNob2xkKQogICAgICAgIHNlbGYuc2FtcGxlX3JhdGUgPSBzYW1wbGVfcmF0ZQogICAgICAgIHNlbGYuZHVyYXRpb24gPSBkdXJhdGlvbgogICAgICAgIHNlbGYuY2hhbm5lbCA9IGNoYW5uZWwKCiAgICBkZWYgc2F2ZV9hdWRpbyhzZWxmLCBhdWRpbzogbnAubmRhcnJheSwgdGFyZ2V0X3BhdGg6IFBhdGgpOgogICAgICAgICMgSWYgdGhlIGF1ZGlvIGhhcyBtb3JlIHRoYW4gb25lIGNoYW5uZWwsIHRyYW5zcG9zZSBpdCBpbiBvcmRlciB0byBzYXZlIGl0OgogICAgICAgIGlmIGxlbihhdWRpbykgPiAxOgogICAgICAgICAgICBhdWRpbyA9IGF1ZGlvLlQKCiAgICAgICAgd2F2ZmlsZS53cml0ZSgKICAgICAgICAgICAgZmlsZW5hbWU9dGFyZ2V0X3BhdGgsCiAgICAgICAgICAgIHJhdGU9c2VsZi5zYW1wbGVfcmF0ZSwKICAgICAgICAgICAgZGF0YT1hdWRpbywKICAgICAgICApCgogICAgZGVmIGxvYWRfYXVkaW8oc2VsZiwgZmlsZTogc3RyKSAtPiBucC5uZGFycmF5OgogICAgICAgIGRhdGEsIHNyID0gbGlicm9zYS5sb2FkKAogICAgICAgICAgICBwYXRoPWZpbGUsCiAgICAgICAgICAgIHNyPXNlbGYuc2FtcGxlX3JhdGUsCiAgICAgICAgICAgIG1vbm89RmFsc2UsICAjIGtlZXAgY2hhbm5lbHMgc2VwYXJhdGUKICAgICAgICAgICAgZHVyYXRpb249c2VsZi5kdXJhdGlvbiwKICAgICAgICApCiAgICAgICAgIyBzZXQgc2FtcGxlIHJhdGU6CiAgICAgICAgc2VsZi5zYW1wbGVfcmF0ZSA9IGludChzcikKCiAgICAgICAgIyBjb252ZXJ0IHRvIGludCB3aXRoIHNjYWxpbmcgZm9yIDE2LWJpdCBpbnRlZ2VyCiAgICAgICAgZGF0YSAqPSAzMjc2NyAvIG5wLm1heChucC5hYnMoZGF0YSkpICAjIHJlLXNjYWxpbmcKICAgICAgICBkYXRhID0gZGF0YS5hc3R5cGUobnAuaW50MTYpICAjIGNoYW5nZSBkYXRhIHR5cGUKCiAgICAgICAgIyBzZWxlY3QgY2hhbm5lbAogICAgICAgIGRhdGFfdG9fcmVkdWNlID0gZGF0YVtzZWxmLmNoYW5uZWxdIGlmIHNlbGYuY2hhbm5lbCBpcyBub3QgTm9uZSBlbHNlIGRhdGEKICAgICAgICByZXR1cm4gZGF0YV90b19yZWR1Y2UKCiAgICBkZWYgY2xlYW5fYXVkaW8oc2VsZiwgZGF0YTogbnAubmRhcnJheSkgLT4gbnAubmRhcnJheToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBub2lzZXJlZHVjZQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiUGxlYXNlIGluc3RhbGwgbm9pc2VyZWR1Y2UgcGFja2FnZSIpIGZyb20gZQoKICAgICAgICByZWR1Y2VkX25vaXNlID0gbm9pc2VyZWR1Y2UucmVkdWNlX25vaXNlKHk9ZGF0YSwgc3I9c2VsZi5zYW1wbGVfcmF0ZSkKCiAgICAgICAgIyBhZGQgY2hhbm5lbCBiYWNrIGFmdGVyIG5vaXNlIHJlZHVjdGlvbgogICAgICAgIGlmIHNlbGYuY2hhbm5lbCBpcyBub3QgTm9uZToKICAgICAgICAgICAgIyBwdXR0aW5nIHRoZSBjaGFubmVsIGJhY2sgaW4gdGhlIGRhdGEKICAgICAgICAgICAgZGF0YVtzZWxmLmNoYW5uZWxdID0gcmVkdWNlZF9ub2lzZQogICAgICAgICAgICAjIHVwZGF0aW5nIHRoZSBkYXRhIHRvIHNhdmUKICAgICAgICAgICAgcmVkdWNlZF9ub2lzZSA9IGRhdGEKCiAgICAgICAgcmV0dXJuIHJlZHVjZWRfbm9pc2UKCgpjbGFzcyBERk4oUmVkdWNlTm9pc2VCYXNlKToKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHRhcmdldF9kaXJlY3Rvcnk6IFBhdGgsCiAgICAgICAgdmVyYm9zZTogYm9vbCA9IFRydWUsCiAgICAgICAgc2lsZW5jZV90aHJlc2hvbGQ6IGZsb2F0ID0gTm9uZSwKICAgICAgICBwYWQ6IGJvb2wgPSBUcnVlLAogICAgICAgIGF0dGVuX2xpbV9kYjogaW50ID0gTm9uZSwKICAgICAgICAqKmt3YXJncywKICAgICk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyh0YXJnZXRfZGlyZWN0b3J5LCB2ZXJib3NlLCBzaWxlbmNlX3RocmVzaG9sZCkKICAgICAgICBzZWxmLnBhZCA9IHBhZAogICAgICAgIHNlbGYuYXR0ZW5fbGltX2RiID0gYXR0ZW5fbGltX2RiCiAgICAgICAgc2VsZi5rd2FyZ3MgPSBrd2FyZ3MKCiAgICAgICAgIyBpbXBvcnQgcmVxdWlyZWQgcGFja2FnZXMKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gZGYuZW5oYW5jZSBpbXBvcnQgaW5pdF9kZgogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiUGxlYXNlIGluc3RhbGwgZGVlcGZpbHRlcm5ldCBwYWNrYWdlcyIpIGZyb20gZQoKICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgIF9MT0dHRVIuaW5mbygiTG9hZGluZyBEZWVwRmlsdGVyTmV0MiBtb2RlbC4iKQoKICAgICAgICAjIExvYWQgdGhlIG1vZGVsOgogICAgICAgIG1vZGVsLCBkZl9zdGF0ZSwgXyA9IGluaXRfZGYoKQogICAgICAgIHNlbGYubW9kZWwgPSBtb2RlbAogICAgICAgIHNlbGYuZGZfc3RhdGUgPSBkZl9zdGF0ZQogICAgICAgIHNlbGYuc2FtcGxlX3JhdGUgPSBzZWxmLmRmX3N0YXRlLnNyKCkKCiAgICBkZWYgc2F2ZV9hdWRpbyhzZWxmLCBhdWRpbzogbnAubmRhcnJheSwgdGFyZ2V0X3BhdGg6IFBhdGgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBkZi5lbmhhbmNlIGltcG9ydCBzYXZlX2F1ZGlvCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJQbGVhc2UgaW5zdGFsbCBkZWVwZmlsdGVybmV0IHBhY2thZ2UiKSBmcm9tIGUKICAgICAgICBzYXZlX2F1ZGlvKAogICAgICAgICAgICBmaWxlPXRhcmdldF9wYXRoLm5hbWUsCiAgICAgICAgICAgIGF1ZGlvPWF1ZGlvLAogICAgICAgICAgICBzcj1zZWxmLnNhbXBsZV9yYXRlLAogICAgICAgICAgICBvdXRwdXRfZGlyPXN0cihzZWxmLnRhcmdldF9kaXJlY3RvcnkpLAogICAgICAgICkKCiAgICBkZWYgbG9hZF9hdWRpbyhzZWxmLCBmaWxlOiBzdHIpIC0+IHRvcmNoLlRlbnNvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gZGYuZW5oYW5jZSBpbXBvcnQgbG9hZF9hdWRpbwogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiUGxlYXNlIGluc3RhbGwgZGVlcGZpbHRlcm5ldCBwYWNrYWdlIikgZnJvbSBlCiAgICAgICAgYXVkaW8sIF8gPSBsb2FkX2F1ZGlvKGZpbGU9ZmlsZSwgc3I9c2VsZi5zYW1wbGVfcmF0ZSwgKipzZWxmLmt3YXJncykKICAgICAgICByZXR1cm4gYXVkaW8KCiAgICBkZWYgY2xlYW5fYXVkaW8oc2VsZiwgZGF0YTogdG9yY2guVGVuc29yKSAtPiB0b3JjaC5UZW5zb3I6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIGRmLmVuaGFuY2UgaW1wb3J0IGVuaGFuY2UKICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3IgYXMgZToKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIlBsZWFzZSBpbnN0YWxsIGRlZXBmaWx0ZXJuZXQgcGFja2FnZSIpIGZyb20gZQogICAgICAgIHJldHVybiBlbmhhbmNlKAogICAgICAgICAgICBtb2RlbD1zZWxmLm1vZGVsLAogICAgICAgICAgICBkZl9zdGF0ZT1zZWxmLmRmX3N0YXRlLAogICAgICAgICAgICBhdWRpbz1kYXRhLAogICAgICAgICAgICBwYWQ9c2VsZi5wYWQsCiAgICAgICAgICAgIGF0dGVuX2xpbV9kYj1zZWxmLmF0dGVuX2xpbV9kYiwKICAgICAgICApCgoKZGVmIF9tdWx0aXByb2Nlc3NpbmdfY29tcGxldGVfdGFza3MoCiAgICBub2lzZV9yZWR1Y2VfdHlwZTogVHlwZVtSZWR1Y2VOb2lzZUJhc2VdLAogICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50czogZGljdCwKICAgIHRhc2tzX3F1ZXVlOiBRdWV1ZSwKICAgIHJlc3VsdHNfcXVldWU6IFF1ZXVlLAopOgogICAgIiIiCiAgICBDb21wbGV0ZSB0aGUgdGFza3MgaW4gdGhlIGdpdmVuIHF1ZXVlIGFuZCBwdXQgdGhlIHJlc3VsdHMgaW4gdGhlIGdpdmVuIHJlc3VsdHMgcXVldWUuIFRoZSBmdW5jdGlvbiB3aWxsIHN0b3Agd2hlbgogICAgdGhlIGdpdmVuIHRhc2tzIHF1ZXVlIHdpbGwgcmVjZWl2ZSB0aGUgc3RvcCBtYXJrLiBJdCBpcyBhaW1lZCB0byBiZSB1c2VkIHdpdGggbXVsdGlwcm9jZXNzaW5nIGFzIGEgcHJvY2Vzcy4KCiAgICA6cGFyYW0gbm9pc2VfcmVkdWNlX3R5cGU6ICAgICAgIFRoZSBub2lzZSByZWR1Y2UgdHlwZSB0byB1c2UuCiAgICA6cGFyYW0gbm9pc2VfcmVkdWNlX2FyZ3VtZW50czogIFRoZSBub2lzZXJlZHVjZSBpbml0aWFsaXphdGlvbiBrd2FyZ3MuCiAgICA6cGFyYW0gdGFza3NfcXVldWU6ICAgICAgICAgICAgIEEgcXVldWUgdG8gZ2V0IHRoZSB0YXNrcyBmcm9tLgogICAgOnBhcmFtIHJlc3VsdHNfcXVldWU6ICAgICAgICAgICBBIHF1ZXVlIHRvIHB1dCB0aGUgcmVzdWx0cyBpbi4KICAgICIiIgogICAgIyBJbml0aWFsaXplIHRoZSByZWR1Y2Ugbm9pc2Ugb2JqZWN0CiAgICBub2lzZV9yZWR1Y2VyID0gbm9pc2VfcmVkdWNlX3R5cGUoKipub2lzZV9yZWR1Y2VfYXJndW1lbnRzKQoKICAgICMgU3RhcnQgbGlzdGVuaW5nIHRvIHRoZSB0YXNrcyBxdWV1ZToKICAgIHdoaWxlIFRydWU6CiAgICAgICAgIyBHZXQgdGhlIGF1ZGlvX2ZpbGU6CiAgICAgICAgYXVkaW9fZmlsZSA9IHRhc2tzX3F1ZXVlLmdldCgpCiAgICAgICAgaWYgYXVkaW9fZmlsZSA9PSBfTVVMVElQUk9DRVNTSU5HX1NUT1BfTUFSSzoKICAgICAgICAgICAgYnJlYWsKICAgICAgICBhdWRpb19maWxlID0gUGF0aChhdWRpb19maWxlKQogICAgICAgICMgQXBwbHkgbm9pc2UgcmVkdWN0aW9uIGFuZCBjb2xsZWN0IHRoZSByZXN1bHQ6CiAgICAgICAgcmVzdWx0c19xdWV1ZS5wdXQobm9pc2VfcmVkdWNlci5yZWR1Y2Vfbm9pc2UoYXVkaW9fZmlsZT1hdWRpb19maWxlKSkKCiAgICAjIE1hcmsgdGhlIGVuZCBvZiB0aGUgdGFza3M6CiAgICByZXN1bHRzX3F1ZXVlLnB1dChfTVVMVElQUk9DRVNTSU5HX1NUT1BfTUFSSykKCgpkZWYgcmVkdWNlX25vaXNlX2RmbigKICAgIGF1ZGlvX3NvdXJjZTogc3RyLAogICAgdGFyZ2V0X2RpcmVjdG9yeTogc3RyLAogICAgcGFkOiBib29sID0gVHJ1ZSwKICAgIGF0dGVuX2xpbV9kYjogaW50ID0gTm9uZSwKICAgIHNpbGVuY2VfdGhyZXNob2xkOiBmbG9hdCA9IE5vbmUsCiAgICB1c2VfbXVsdGlwcm9jZXNzaW5nOiBpbnQgPSAwLAogICAgdmVyYm9zZTogYm9vbCA9IFRydWUsCiAgICAqKmt3YXJncywKKToKICAgICIiIgogICAgUmVkdWNlIG5vaXNlIGZyb20gYXVkaW8gZmlsZXMgdXNpbmcgRGVlcEZpbHRlck5ldC4KICAgIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZSBub2lzZSByZWR1Y3Rpb24gYWxnb3JpdGhtIHNlZToKICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9SaWtvcm9zZS9EZWVwRmlsdGVyTmV0CiAgICBOb3RpY2UgdGhhdCB0aGUgc2F2ZWQgZmlsZXMgYXJlIGluIHdhdiBmb3JtYXQsIGV2ZW4gaWYgdGhlIG9yaWdpbmFsIGZpbGVzIGFyZSBpbiBvdGhlciBmb3JtYXQuCgogICAgOnBhcmFtIGF1ZGlvX3NvdXJjZTogICAgICAgIHBhdGggdG8gYXVkaW8gZmlsZSBvciBkaXJlY3Rvcnkgb2YgYXVkaW8gZmlsZXMKICAgIDpwYXJhbSB0YXJnZXRfZGlyZWN0b3J5OiAgICBwYXRoIHRvIHRhcmdldCBkaXJlY3RvcnkgdG8gc2F2ZSBjbGVhbmVkIGF1ZGlvIGZpbGVzCiAgICA6cGFyYW0gcGFkOiAgICAgICAgICAgICAgICAgd2hldGhlciB0byBwYWQgdGhlIGF1ZGlvIGZpbGUgd2l0aCB6ZXJvcyBiZWZvcmUgY2xlYW5pbmcKICAgIDpwYXJhbSBhdHRlbl9saW1fZGI6ICAgICAgICBtYXhpbXVtIGF0dGVudWF0aW9uIGluIGRCCiAgICA6cGFyYW0gc2lsZW5jZV90aHJlc2hvbGQ6ICAgdGhlIHRocmVzaG9sZCB0byByZW1vdmUgc2lsZW5jZSBmcm9tIHRoZSBhdWRpbywgaW4gZEIuIElmIE5vbmUsIG5vIHNpbGVuY2UgcmVtb3ZhbCBpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcmZvcm1lZC4KICAgIDpwYXJhbSB1c2VfbXVsdGlwcm9jZXNzaW5nOiBOdW1iZXIgb2YgcHJvY2Vzc2VzIHRvIHVzZSBmb3IgY2xlYW5pbmcgdGhlIGF1ZGlvIGZpbGVzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElmIDAsIG5vIG11bHRpcHJvY2Vzc2luZyBpcyB1c2VkLgogICAgOnBhcmFtIHZlcmJvc2U6ICAgICAgICAgICAgIHZlcmJvc2l0eSBsZXZlbC4gSWYgVHJ1ZSwgZGlzcGxheSBwcm9ncmVzcyBiYXIgYW5kIGxvZ3MuCiAgICA6cGFyYW0ga3dhcmdzOiAgICAgICAgICAgICAgYWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0b3JjaGF1ZGlvLmxvYWQoKS4gRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBzOi8vcHl0b3JjaC5vcmcvYXVkaW8vc3RhYmxlL2dlbmVyYXRlZC90b3JjaGF1ZGlvLmxvYWQuaHRtbAogICAgIiIiCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbygiUmVkdWNpbmcgbm9pc2UgZnJvbSBhdWRpbyBmaWxlcy4iKQoKICAgICMgY3JlYXRlIHRhcmdldCBkaXJlY3Rvcnk6CiAgICB0YXJnZXRfZGlyZWN0b3J5ID0gX2NyZWF0ZV90YXJnZXRfZGlyZWN0b3J5KHRhcmdldF9kaXJlY3RvcnkpCgogICAgIyBnZXQgYXVkaW8gZmlsZXM6CiAgICBhdWRpb19maWxlcyA9IF9nZXRfYXVkaW9fZmlsZXMoYXVkaW9fc291cmNlKQoKICAgIG5vaXNlX3JlZHVjZV9hcmd1bWVudHMgPSB7CiAgICAgICAgInRhcmdldF9kaXJlY3RvcnkiOiB0YXJnZXRfZGlyZWN0b3J5LAogICAgICAgICJwYWQiOiBwYWQsCiAgICAgICAgImF0dGVuX2xpbV9kYiI6IGF0dGVuX2xpbV9kYiwKICAgICAgICAic2lsZW5jZV90aHJlc2hvbGQiOiBzaWxlbmNlX3RocmVzaG9sZCwKICAgICAgICAqKmt3YXJncywKICAgIH0KCiAgICBpZiB1c2VfbXVsdGlwcm9jZXNzaW5nOgogICAgICAgIHJlc3VsdHMgPSBfcGFyYWxsZWxfcnVuKAogICAgICAgICAgICBub2lzZV9yZWR1Y2VfdHlwZT1ERk4sCiAgICAgICAgICAgIG5vaXNlX3JlZHVjZV9hcmd1bWVudHM9bm9pc2VfcmVkdWNlX2FyZ3VtZW50cywKICAgICAgICAgICAgbl93b3JrZXJzPXVzZV9tdWx0aXByb2Nlc3NpbmcsCiAgICAgICAgICAgIGF1ZGlvX2ZpbGVzPWF1ZGlvX2ZpbGVzLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iTm9pc2UtcmVkdWN0aW9uIiwKICAgICAgICAgICAgdmVyYm9zZT12ZXJib3NlLAogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgcmVzdWx0cyA9IF9ydW4oCiAgICAgICAgICAgIG5vaXNlX3JlZHVjZV90eXBlPURGTiwKICAgICAgICAgICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50cz1ub2lzZV9yZWR1Y2VfYXJndW1lbnRzLAogICAgICAgICAgICBhdWRpb19maWxlcz1hdWRpb19maWxlcywKICAgICAgICAgICAgZGVzY3JpcHRpb249Ik5vaXNlLXJlZHVjdGlvbiIsCiAgICAgICAgICAgIHZlcmJvc2U9dmVyYm9zZSwKICAgICAgICApCgogICAgcmV0dXJuIF9wcm9jZXNzX3Jlc3VsdHMocmVzdWx0cywgdmVyYm9zZSkKCgpkZWYgcmVkdWNlX25vaXNlKAogICAgYXVkaW9fc291cmNlOiBzdHIsCiAgICB0YXJnZXRfZGlyZWN0b3J5OiBzdHIsCiAgICBzYW1wbGVfcmF0ZTogaW50ID0gMTYwMDAsCiAgICBkdXJhdGlvbjogaW50ID0gTm9uZSwKICAgIGNoYW5uZWw6IGludCA9IE5vbmUsCiAgICBzaWxlbmNlX3RocmVzaG9sZDogZmxvYXQgPSBOb25lLAogICAgdXNlX211bHRpcHJvY2Vzc2luZzogaW50ID0gMCwKICAgIHZlcmJvc2U6IGJvb2wgPSBUcnVlLAopOgogICAgIiIiCiAgICBSZWR1Y2Ugbm9pc2UgZnJvbSBhdWRpbyBmaWxlIG9yIGRpcmVjdG9yeSBjb250YWluaW5nIGF1ZGlvIGZpbGVzLgogICAgVGhlIGF1ZGlvIGZpbGVzIG11c3QgYmUgaW4gLndhdiBmb3JtYXQuCiAgICBUaGUgY2xlYW5lZCBhdWRpbyBmaWxlcyB3aWxsIGJlIHNhdmVkIGluIHRoZSB0YXJnZXRfZGlyZWN0b3J5LgogICAgRm9yIGluZm9ybWF0aW9uIGFib3V0IHRoZSBub2lzZSByZWR1Y3Rpb24gYWxnb3JpdGhtIHNlZToKICAgIGh0dHBzOi8vZ2l0aHViLmNvbS90aW1zYWluYi9ub2lzZXJlZHVjZQogICAgTm90aWNlIHRoYXQgdGhlIHNhdmVkIGZpbGVzIGFyZSBpbiB3YXYgZm9ybWF0LCBldmVuIGlmIHRoZSBvcmlnaW5hbCBmaWxlcyBhcmUgaW4gb3RoZXIgZm9ybWF0LgoKICAgIDpwYXJhbSBhdWRpb19zb3VyY2U6ICAgICAgICBwYXRoIHRvIGF1ZGlvIGZpbGUgb3IgZGlyZWN0b3J5IGNvbnRhaW5pbmcgYXVkaW8gZmlsZXMKICAgIDpwYXJhbSB0YXJnZXRfZGlyZWN0b3J5OiAgICBwYXRoIHRvIGRpcmVjdG9yeSB0byBzYXZlIHRoZSBjbGVhbmVkIGF1ZGlvIGZpbGVzLgogICAgOnBhcmFtIHNhbXBsZV9yYXRlOiAgICAgICAgIE51bWJlciBvZiBzYW1wbGVzIGluIG9uZSBzZWNvbmQgaW4gdGhlIGF1ZGlvIGZpbGUuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGFzcyBgTm9uZWAgdG8ga2VlcCB0aGUgb3JpZ2luYWwgc2FtcGxlIHJhdGUuCiAgICA6cGFyYW0gZHVyYXRpb246ICAgICAgICAgICAgRHVyYXRpb24gb2YgdGhlIGF1ZGlvIGZpbGUgdG8gY2xlYW4gaW4gc2Vjb25kcy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYXNzIGBOb25lYCB0byBrZWVwIHRoZSBvcmlnaW5hbCBkdXJhdGlvbi4KICAgIDpwYXJhbSBjaGFubmVsOiAgICAgICAgICAgICBDaGFubmVsIHRvIGNsZWFuLiBQYXNzIHRoZSBudW1iZXIgb2YgdGhlIGNoYW5uZWwgdG8gY2xlYW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVG8gY2xlYW4gYWxsIGNoYW5uZWxzIHBhc3MgTm9uZS4KICAgIDpwYXJhbSBzaWxlbmNlX3RocmVzaG9sZDogICBUaGUgdGhyZXNob2xkIHRvIHJlbW92ZSBzaWxlbmNlIGZyb20gdGhlIGF1ZGlvLCBpbiBkQi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiBOb25lLCBubyBzaWxlbmNlIHJlbW92YWwgaXMgcGVyZm9ybWVkLgogICAgOnBhcmFtIHVzZV9tdWx0aXByb2Nlc3Npbmc6IE51bWJlciBvZiBwcm9jZXNzZXMgdG8gdXNlIGZvciBjbGVhbmluZyB0aGUgYXVkaW8gZmlsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgMCwgbm8gbXVsdGlwcm9jZXNzaW5nIGlzIHVzZWQuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgVmVyYm9zaXR5IGxldmVsLiBJZiBUcnVlLCBkaXNwbGF5IHByb2dyZXNzIGJhci4KICAgICIiIgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIlJlZHVjaW5nIG5vaXNlIGZyb20gYXVkaW8gZmlsZXMuIikKCiAgICAjIGNyZWF0ZSB0YXJnZXQgZGlyZWN0b3J5OgogICAgdGFyZ2V0X2RpcmVjdG9yeSA9IF9jcmVhdGVfdGFyZ2V0X2RpcmVjdG9yeSh0YXJnZXRfZGlyZWN0b3J5KQoKICAgICMgZ2V0IGF1ZGlvIGZpbGVzOgogICAgYXVkaW9fZmlsZXMgPSBfZ2V0X2F1ZGlvX2ZpbGVzKGF1ZGlvX3NvdXJjZSkKCiAgICAjIENyZWF0ZSB0aGUgcmVkdWNlIG5vaXNlIG9iamVjdDoKICAgIG5vaXNlX3JlZHVjZV9hcmd1bWVudHMgPSB7CiAgICAgICAgInRhcmdldF9kaXJlY3RvcnkiOiB0YXJnZXRfZGlyZWN0b3J5LAogICAgICAgICJzYW1wbGVfcmF0ZSI6IHNhbXBsZV9yYXRlLAogICAgICAgICJkdXJhdGlvbiI6IGR1cmF0aW9uLAogICAgICAgICJjaGFubmVsIjogY2hhbm5lbCwKICAgICAgICAic2lsZW5jZV90aHJlc2hvbGQiOiBzaWxlbmNlX3RocmVzaG9sZCwKICAgIH0KCiAgICBpZiB1c2VfbXVsdGlwcm9jZXNzaW5nOgogICAgICAgIHJlc3VsdHMgPSBfcGFyYWxsZWxfcnVuKAogICAgICAgICAgICBub2lzZV9yZWR1Y2VfdHlwZT1SZWR1Y2VOb2lzZSwKICAgICAgICAgICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50cz1ub2lzZV9yZWR1Y2VfYXJndW1lbnRzLAogICAgICAgICAgICBuX3dvcmtlcnM9dXNlX211bHRpcHJvY2Vzc2luZywKICAgICAgICAgICAgYXVkaW9fZmlsZXM9YXVkaW9fZmlsZXMsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJOb2lzZS1yZWR1Y3Rpb24iLAogICAgICAgICAgICB2ZXJib3NlPXZlcmJvc2UsCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICByZXN1bHRzID0gX3J1bigKICAgICAgICAgICAgbm9pc2VfcmVkdWNlX3R5cGU9UmVkdWNlTm9pc2UsCiAgICAgICAgICAgIG5vaXNlX3JlZHVjZV9hcmd1bWVudHM9bm9pc2VfcmVkdWNlX2FyZ3VtZW50cywKICAgICAgICAgICAgYXVkaW9fZmlsZXM9YXVkaW9fZmlsZXMsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJOb2lzZS1yZWR1Y3Rpb24iLAogICAgICAgICAgICB2ZXJib3NlPXZlcmJvc2UsCiAgICAgICAgKQoKICAgIHJldHVybiBfcHJvY2Vzc19yZXN1bHRzKHJlc3VsdHMsIHZlcmJvc2UpCgoKZGVmIF9jcmVhdGVfdGFyZ2V0X2RpcmVjdG9yeSh0YXJnZXRfZGlyZWN0b3J5OiBzdHIpIC0+IHN0cjoKICAgIHRhcmdldF9kaXJlY3RvcnkgPSBQYXRoKHRhcmdldF9kaXJlY3RvcnkpCiAgICBpZiBub3QgdGFyZ2V0X2RpcmVjdG9yeS5leGlzdHMoKToKICAgICAgICB0YXJnZXRfZGlyZWN0b3J5Lm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKICAgIHJldHVybiBzdHIodGFyZ2V0X2RpcmVjdG9yeSkKCgpkZWYgX2dldF9hdWRpb19maWxlcyhhdWRpb19zb3VyY2U6IHN0cik6CiAgICBhdWRpb19zb3VyY2UgPSBQYXRoKGF1ZGlvX3NvdXJjZSkKICAgIGF1ZGlvX2ZpbGVzID0gW10KICAgIGlmIGF1ZGlvX3NvdXJjZS5pc19kaXIoKToKICAgICAgICBhdWRpb19maWxlcyA9IGxpc3QoYXVkaW9fc291cmNlLmdsb2IoIiouKiIpKQogICAgZWxpZiBhdWRpb19zb3VyY2UuaXNfZmlsZSgpOgogICAgICAgIGF1ZGlvX2ZpbGVzLmFwcGVuZChhdWRpb19zb3VyY2UpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiYXVkaW9fc291cmNlIG11c3QgYmUgYSBmaWxlIG9yIGEgZGlyZWN0b3J5LCBnb3Qge2F1ZGlvX3NvdXJjZX0iCiAgICAgICAgKQogICAgcmV0dXJuIGF1ZGlvX2ZpbGVzCgoKZGVmIF9wYXJhbGxlbF9ydW4oCiAgICBub2lzZV9yZWR1Y2VfdHlwZTogVHlwZVtSZWR1Y2VOb2lzZUJhc2VdLAogICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50czogZGljdCwKICAgIG5fd29ya2VyczogaW50LAogICAgYXVkaW9fZmlsZXM6IExpc3RbUGF0aF0sCiAgICBkZXNjcmlwdGlvbjogc3RyLAogICAgdmVyYm9zZTogYm9vbCwKKSAtPiBMaXN0W1R1cGxlW2Jvb2wsIFR1cGxlW3N0ciwgc3RyXV1dOgogICAgIiIiCiAgICBSdW4gbXVsdGlwbGUgbm9pc2UgcmVkdWNlIHdvcmtlcnMgd2l0aCBtdWx0aXByb2Nlc3NpbmcgdG8gY29tcGxldGUgdGhlIHRhc2tzIHRoYXQgd2lsbCBiZSBjcmVhdGVkIG9uIHRoZSBwcm92aWRlZAogICAgZmlsZXMgdXNpbmcgdGhlIGdpdmVuIHRhc2sgY3JlYXRvci4KCiAgICA6cGFyYW0gbm9pc2VfcmVkdWNlX3R5cGU6ICAgVGhlIG5vaXNlIHJlZHVjZSB0eXBlIHRvIHVzZS4KICAgIDpwYXJhbSBuX3dvcmtlcnM6ICAgICAgICAgICBUaGUgbnVtYmVyIG9mIHdvcmtlcnMgdG8gdXNlLgogICAgOnBhcmFtIGF1ZGlvX2ZpbGVzOiAgICAgICAgIFRoZSBhdWRpbyBmaWxlcyB0byB1c2UuCiAgICA6cGFyYW0gZGVzY3JpcHRpb246ICAgICAgICAgVGhlIGRlc2NyaXB0aW9uIHRvIHVzZSBmb3IgdGhlIHByb2dyZXNzIGJhci4KICAgIDpwYXJhbSB2ZXJib3NlOiAgICAgICAgICAgICBWZXJib3NpdHkuCgogICAgOnJldHVybnM6IFRoZSBjb2xsZWN0ZWQgcmVzdWx0cy4KICAgICIiIgogICAgIyBDaGVjayB0aGUgbnVtYmVyIG9mIHdvcmtlcnM6CiAgICBpZiBuX3dvcmtlcnMgPiBsZW4oYXVkaW9fZmlsZXMpOgogICAgICAgIF9MT0dHRVIud2FybmluZygKICAgICAgICAgICAgZiJUaGUgbnVtYmVyIG9mIHdvcmtlcnMgKHtuX3dvcmtlcnN9KSBpcyBsYXJnZXIgdGhhbiB0aGUgbnVtYmVyIG9mIGF1ZGlvIGZpbGVzICh7bGVuKGF1ZGlvX2ZpbGVzKX0pLiAiCiAgICAgICAgICAgIGYiU2V0dGluZyB0aGUgbnVtYmVyIG9mIHdvcmtlcnMgdG8ge2xlbihhdWRpb19maWxlcyl9LiIKICAgICAgICApCiAgICAgICAgbl93b3JrZXJzID0gbGVuKGF1ZGlvX2ZpbGVzKQoKICAgICMgSW5pdGlhbGl6ZSB0aGUgbXVsdGlwcm9jZXNzaW5nIHF1ZXVlczoKICAgIHRhc2tzX3F1ZXVlID0gUXVldWUoKQogICAgcmVzdWx0c19xdWV1ZSA9IFF1ZXVlKCkKCiAgICAjIEluaXRpYWxpemUgdGhlIG11bHRpcHJvY2Vzc2luZyBwcm9jZXNzZXM6CiAgICB0YXNrX2NvbXBsZXRpb25fcHJvY2Vzc2VzID0gWwogICAgICAgIFByb2Nlc3MoCiAgICAgICAgICAgIHRhcmdldD1fbXVsdGlwcm9jZXNzaW5nX2NvbXBsZXRlX3Rhc2tzLAogICAgICAgICAgICBrd2FyZ3M9ewogICAgICAgICAgICAgICAgIm5vaXNlX3JlZHVjZV90eXBlIjogbm9pc2VfcmVkdWNlX3R5cGUsCiAgICAgICAgICAgICAgICAibm9pc2VfcmVkdWNlX2FyZ3VtZW50cyI6IG5vaXNlX3JlZHVjZV9hcmd1bWVudHMsCiAgICAgICAgICAgICAgICAidGFza3NfcXVldWUiOiB0YXNrc19xdWV1ZSwKICAgICAgICAgICAgICAgICJyZXN1bHRzX3F1ZXVlIjogcmVzdWx0c19xdWV1ZSwKICAgICAgICAgICAgfSwKICAgICAgICApCiAgICAgICAgZm9yIF8gaW4gcmFuZ2Uobl93b3JrZXJzKQogICAgXQoKICAgICMgU3RhcnQgdGhlIG11bHRpcHJvY2Vzc2luZyBwcm9jZXNzZXM6CiAgICBmb3IgcCBpbiB0YXNrX2NvbXBsZXRpb25fcHJvY2Vzc2VzOgogICAgICAgIHAuc3RhcnQoKQoKICAgICMgUHV0IHRoZSB0YXNrcyBpbiB0aGUgcXVldWU6CiAgICBmb3IgYXVkaW9fZmlsZSBpbiBhdWRpb19maWxlczoKICAgICAgICAjIHRhc2tzX3F1ZXVlLnB1dCh0YXNrX2NyZWF0b3IuY3JlYXRlX3Rhc2soYXVkaW9fZmlsZT1hdWRpb19maWxlKS50b190dXBsZSgpKQogICAgICAgIHRhc2tzX3F1ZXVlLnB1dChhdWRpb19maWxlKQoKICAgICMgUHV0IHRoZSBzdG9wIG1hcmtzIGluIHRoZSBxdWV1ZToKICAgIGZvciBfIGluIHJhbmdlKG5fd29ya2Vycyk6CiAgICAgICAgdGFza3NfcXVldWUucHV0KF9NVUxUSVBST0NFU1NJTkdfU1RPUF9NQVJLKQoKICAgICMgQ29sbGVjdCB0aGUgcmVzdWx0czoKICAgIHJlc3VsdHMgPSBbXQogICAgc3RvcF9tYXJrc19jb3VudGVyID0gMAogICAgd2l0aCB0cWRtKAogICAgICAgIGRlc2M9ZGVzY3JpcHRpb24sCiAgICAgICAgdW5pdD0iZmlsZSIsCiAgICAgICAgdG90YWw9bGVuKGF1ZGlvX2ZpbGVzKSwKICAgICAgICBkaXNhYmxlPW5vdCB2ZXJib3NlLAogICAgKSBhcyBwcm9ncmVzc2JhcjoKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAjIEdldCBhIHJlc3VsdCBmcm9tIHRoZSBxdWV1ZToKICAgICAgICAgICAgcmVzdWx0OiBUdXBsZVtib29sLCBUdXBsZVtzdHIsIHN0cl1dID0gcmVzdWx0c19xdWV1ZS5nZXQoKQogICAgICAgICAgICBpZiByZXN1bHQgPT0gX01VTFRJUFJPQ0VTU0lOR19TVE9QX01BUks6CiAgICAgICAgICAgICAgICBzdG9wX21hcmtzX2NvdW50ZXIgKz0gMQogICAgICAgICAgICAgICAgaWYgc3RvcF9tYXJrc19jb3VudGVyID09IG5fd29ya2VyczoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBDb2xsZWN0IHRoZSByZXN1bHQ6CiAgICAgICAgICAgICAgICByZXN1bHRzLmFwcGVuZChyZXN1bHQpCiAgICAgICAgICAgICAgICBwcm9ncmVzc2Jhci51cGRhdGUoMSkKCiAgICAjIFdhaXQgZm9yIHRoZSBwcm9jZXNzZXMgdG8gZmluaXNoOgogICAgZm9yIHAgaW4gdGFza19jb21wbGV0aW9uX3Byb2Nlc3NlczoKICAgICAgICBwLmpvaW4oKQoKICAgIHJldHVybiByZXN1bHRzCgoKZGVmIF9ydW4oCiAgICBub2lzZV9yZWR1Y2VfdHlwZTogVHlwZVtSZWR1Y2VOb2lzZUJhc2VdLAogICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50czogZGljdCwKICAgIGF1ZGlvX2ZpbGVzOiBMaXN0W1BhdGhdLAogICAgZGVzY3JpcHRpb246IHN0ciwKICAgIHZlcmJvc2U6IGJvb2wsCikgLT4gTGlzdFtUdXBsZVtib29sLCBUdXBsZVtzdHIsIHN0cl1dXToKICAgICIiIgogICAgUnVuIHRoZSBub2lzZSByZWR1Y2UgYWxnb3JpdGhtIG9uIHRoZSBnaXZlbiBhdWRpbyBmaWxlcyBhbmQgY29sbGVjdCB0aGUgcmVzdWx0cy4KCiAgICA6cGFyYW0gbm9pc2VfcmVkdWNlX3R5cGU6ICAgICAgIFRoZSBub2lzZSByZWR1Y2UgdHlwZSB0byB1c2UuCiAgICA6cGFyYW0gbm9pc2VfcmVkdWNlX2FyZ3VtZW50czogIFRoZSBub2lzZXJlZHVjZSBpbml0aWFsaXphdGlvbiBrd2FyZ3MuCiAgICA6cGFyYW0gYXVkaW9fZmlsZXM6ICAgICAgICAgICAgIFRoZSBhdWRpbyBmaWxlcyB0byB1c2UuCiAgICA6cGFyYW0gZGVzY3JpcHRpb246ICAgICAgICAgICAgIFRoZSBkZXNjcmlwdGlvbiB0byB1c2UgZm9yIHRoZSBwcm9ncmVzcyBiYXIuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgICAgIFZlcmJvc2l0eS4KCiAgICA6cmV0dXJuczogVGhlIGNvbGxlY3RlZCByZXN1bHRzLgogICAgIiIiCiAgICAjIENyZWF0ZSB0aGUgcmVkdWNlIG5vaXNlIG9iamVjdDoKICAgIG5vaXNlX3JlZHVjZXIgPSBub2lzZV9yZWR1Y2VfdHlwZSgqKm5vaXNlX3JlZHVjZV9hcmd1bWVudHMpCgogICAgIyBSdW4gdGhlIG5vaXNlIHJlZHVjZSBhbGdvcml0aG0gb24gdGhlIGF1ZGlvIGZpbGVzIGFuZCBjb2xsZWN0IHRoZSByZXN1bHRzOgogICAgcmVzdWx0cyA9IFtdCiAgICBmb3IgYXVkaW9fZmlsZSBpbiB0cWRtKAogICAgICAgIGF1ZGlvX2ZpbGVzLAogICAgICAgIGRlc2M9ZGVzY3JpcHRpb24sCiAgICAgICAgdW5pdD0iZmlsZSIsCiAgICAgICAgdG90YWw9bGVuKGF1ZGlvX2ZpbGVzKSwKICAgICAgICBkaXNhYmxlPW5vdCB2ZXJib3NlLAogICAgKToKICAgICAgICByZXN1bHRzLmFwcGVuZChub2lzZV9yZWR1Y2VyLnJlZHVjZV9ub2lzZShhdWRpb19maWxlPWF1ZGlvX2ZpbGUpKQoKICAgIHJldHVybiByZXN1bHRzCgoKZGVmIF9wcm9jZXNzX3Jlc3VsdHMoCiAgICByZXN1bHRzOiBMaXN0W1R1cGxlW2Jvb2wsIFR1cGxlW3N0ciwgc3RyXV1dLCB2ZXJib3NlOiBib29sCikgLT4gVHVwbGVbZGljdCwgZGljdF06CiAgICAiIiIKICAgIFByb2Nlc3MgdGhlIHJlc3VsdHMgb2YgdGhlIHRhc2tzLgoKICAgIDpwYXJhbSByZXN1bHRzOiBUaGUgcmVzdWx0cyB0byBwcm9jZXNzLgogICAgOnBhcmFtIHZlcmJvc2U6IFZlcmJvc2l0eS4KCiAgICA6cmV0dXJuczogVGhlIHByb2Nlc3NlZCByZXN1bHRzIGFzIGEgdHVwbGUgb2Ygc3VjY2Vzc2VzIGFuZCBlcnJvcnMuCiAgICAiIiIKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJTdW1tYXJpemluZyB0aGUgcmVzdWx0cy4iKQogICAgc3VjY2Vzc2VzID0ge30KICAgIGVycm9ycyA9IHt9CiAgICBmb3IgaXNfZXJyb3IsIHJlc3VsdCBpbiByZXN1bHRzOgogICAgICAgIGlmIGlzX2Vycm9yOgogICAgICAgICAgICBlcnJvcnNbcmVzdWx0WzBdXSA9IHJlc3VsdFsxXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHN1Y2Nlc3Nlc1tyZXN1bHRbMF1dID0gcmVzdWx0WzFdCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIkRvbmUgKHtsZW4oc3VjY2Vzc2VzKX0ve2xlbihzdWNjZXNzZXMpICsgbGVuKGVycm9ycyl9KVxuIikKCiAgICByZXR1cm4gc3VjY2Vzc2VzLCBlcnJvcnMK
    requirements:
    - librosa
    - noisereduce
    - deepfilternet
    - torchaudio>=2.1.2
  disable_auto_mount: false
kind: job
