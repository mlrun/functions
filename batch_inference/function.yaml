kind: job
metadata:
  name: batch-inference
  tag: ''
  hash: 2522525a899857d70582067647828dfaeffd03f2
  project: ''
  labels:
    author: guyl
  categories:
  - utils
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IGhhc2hsaWIKaW1wb3J0IGpzb24KZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSB0eXBpbmcgaW1wb3J0IEFueSwgRGljdCwgTGlzdCwgVHVwbGUsIFVuaW9uCgppbXBvcnQgbWxydW4KaW1wb3J0IG1scnVuLmRhdGFzdG9yZQppbXBvcnQgbWxydW4udXRpbHMKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBtbHJ1biBpbXBvcnQgZmVhdHVyZV9zdG9yZSBhcyBmcwpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgQXJ0aWZhY3QKZnJvbSBtbHJ1bi5kYXRhX3R5cGVzLmluZmVyIGltcG9ydCBJbmZlck9wdGlvbnMsIGdldF9kZl9zdGF0cwpmcm9tIG1scnVuLmZyYW1ld29ya3MuYXV0b19tbHJ1biBpbXBvcnQgQXV0b01MUnVuCmZyb20gbWxydW4ubW9kZWxfbW9uaXRvcmluZy5mZWF0dXJlc19kcmlmdF90YWJsZSBpbXBvcnQgRmVhdHVyZXNEcmlmdFRhYmxlUGxvdApmcm9tIG1scnVuLm1vZGVsX21vbml0b3JpbmcubW9kZWxfbW9uaXRvcmluZ19iYXRjaCBpbXBvcnQgKAogICAgVmlydHVhbERyaWZ0LAogICAgY2FsY3VsYXRlX2lucHV0c19zdGF0aXN0aWNzLAopCgojIEEgdW5pb24gb2YgYWxsIHN1cHBvcnRlZCBkYXRhc2V0IHR5cGVzOgpEYXRhc2V0VHlwZSA9IFVuaW9uW21scnVuLkRhdGFJdGVtLCBsaXN0LCBkaWN0LCBwZC5EYXRhRnJhbWUsIHBkLlNlcmllcywgbnAubmRhcnJheV0KCgpkZWYgX3JlYWRfZGF0YXNldF9hc19kYXRhZnJhbWUoCiAgICBkYXRhc2V0OiBEYXRhc2V0VHlwZSwKICAgIGxhYmVsX2NvbHVtbnM6IFVuaW9uW3N0ciwgTGlzdFtzdHJdXSA9IE5vbmUsCiAgICBkcm9wX2NvbHVtbnM6IFVuaW9uW3N0ciwgTGlzdFtzdHJdLCBpbnQsIExpc3RbaW50XV0gPSBOb25lLAopIC0+IFR1cGxlW3BkLkRhdGFGcmFtZSwgTGlzdFtzdHJdXToKICAgICIiIgogICAgUGFyc2UgdGhlIGdpdmVuIGRhdGFzZXQgaW50byBhIERhdGFGcmFtZSBhbmQgZHJvcCB0aGUgY29sdW1ucyBhY2NvcmRpbmdseS4gSW4gYWRkaXRpb24sIHRoZSBsYWJlbCBjb2x1bW5zIHdpbGwgYmUKICAgIHBhcnNlZCBhbmQgdmFsaWRhdGVkIGFzIHdlbGwuCgogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgIFRoZSBkYXRhc2V0IHRvIHRyYWluIHRoZSBtb2RlbCBvbi4KICAgICAgICAgICAgICAgICAgICAgICAgICBDYW4gYmUgZWl0aGVyIGEgbGlzdCBvZiBsaXN0cywgZGljdCwgVVJJIG9yIGEgRmVhdHVyZVZlY3Rvci4KICAgIDpwYXJhbSBsYWJlbF9jb2x1bW5zOiBUaGUgdGFyZ2V0IGxhYmVsKHMpIG9mIHRoZSBjb2x1bW4ocykgaW4gdGhlIGRhdGFzZXQuIGZvciBSZWdyZXNzaW9uIG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgQ2xhc3NpZmljYXRpb24gdGFza3MuCiAgICA6cGFyYW0gZHJvcF9jb2x1bW5zOiAgYGBzdHJgYCAvIGBgaW50YGAgb3IgYSBsaXN0IG9mIGBgc3RyYGAgLyBgYGludGBgIHRoYXQgcmVwcmVzZW50IHRoZSBjb2x1bW4gbmFtZXMgLyBpbmRpY2VzIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgZHJvcC4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKICAgICAgICAgICAgICBbMF0gPSBUaGUgcGFyc2VkIGRhdGFzZXQgYXMgYSBEYXRhRnJhbWUKICAgICAgICAgICAgICBbMV0gPSBMYWJlbCBjb2x1bW5zLgoKICAgIHJhaXNlcyBNTFJ1bkludmFsaWRBcmd1bWVudEVycm9yOiBJZiB0aGUgYGRyb3BfY29sdW1uc2AgYXJlIG5vdCBtYXRjaGluZyB0aGUgZGF0YXNldCBvciB1bnN1cHBvcnRlZCBkYXRhc2V0IHR5cGUuCiAgICAiIiIKICAgICMgVHVybiB0aGUgYGRyb3AgbGFiZWxzYCBpbnRvIGEgbGlzdCBpZiBnaXZlbjoKICAgIGlmIGRyb3BfY29sdW1ucyBpcyBub3QgTm9uZToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShkcm9wX2NvbHVtbnMsIGxpc3QpOgogICAgICAgICAgICBkcm9wX2NvbHVtbnMgPSBbZHJvcF9jb2x1bW5zXQoKICAgICMgQ2hlY2sgaWYgdGhlIGRhdGFzZXQgaXMgaW4gZmFjdCBhIEZlYXR1cmUgVmVjdG9yOgogICAgc3RvcmVfdXJpX3ByZWZpeCwgXyA9IG1scnVuLmRhdGFzdG9yZS5wYXJzZV9zdG9yZV91cmkoZGF0YXNldC5hcnRpZmFjdF91cmwpCiAgICBpZiBtbHJ1bi51dGlscy5TdG9yZVByZWZpeC5GZWF0dXJlVmVjdG9yID09IHN0b3JlX3VyaV9wcmVmaXg6CiAgICAgICAgIyBUcnkgdG8gZ2V0IHRoZSBsYWJlbCBjb2x1bW5zIGlmIG5vdCBwcm92aWRlZDoKICAgICAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBkYXRhc2V0Lm1ldGEuc3RhdHVzLmxhYmVsX2NvbHVtbgogICAgICAgICMgR2V0IHRoZSBmZWF0dXJlcyBhbmQgcGFyc2UgdG8gRGF0YUZyYW1lOgogICAgICAgIGRhdGFzZXQgPSBmcy5nZXRfb2ZmbGluZV9mZWF0dXJlcygKICAgICAgICAgICAgZGF0YXNldC5tZXRhLnVyaSwgZHJvcF9jb2x1bW5zPWRyb3BfY29sdW1ucwogICAgICAgICkudG9fZGF0YWZyYW1lKCkKICAgIGVsc2U6CiAgICAgICAgIyBQYXJzZSB0byBEYXRhRnJhbWUgYWNjb3JkaW5nIHRvIHRoZSBkYXRhc2V0J3MgdHlwZToKICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGFzZXQsIChsaXN0LCBucC5uZGFycmF5KSk6CiAgICAgICAgICAgICMgUGFyc2UgdGhlIGxpc3QgLyBudW1weSBhcnJheSBpbnRvIGEgRGF0YUZyYW1lOgogICAgICAgICAgICBkYXRhc2V0ID0gcGQuRGF0YUZyYW1lKGRhdGFzZXQpCiAgICAgICAgICAgICMgVmFsaWRhdGUgdGhlIGBkcm9wX2NvbHVtbnNgIGlzIGdpdmVuIGFzIGludGVnZXJzOgogICAgICAgICAgICBpZiBkcm9wX2NvbHVtbnMgYW5kIG5vdCBhbGwoaXNpbnN0YW5jZShjb2wsIGludCkgZm9yIGNvbCBpbiBkcm9wX2NvbHVtbnMpOgogICAgICAgICAgICAgICAgcmFpc2UgbWxydW4uZXJyb3JzLk1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3IoCiAgICAgICAgICAgICAgICAgICAgImBkcm9wX2NvbHVtbnNgIG11c3QgYmUgYW4gaW50ZWdlciAvIGxpc3Qgb2YgaW50ZWdlcnMgaWYgcHJvdmlkZWQgYXMgYSBsaXN0LiIKICAgICAgICAgICAgICAgICkKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGF0YXNldCwgbWxydW4uRGF0YUl0ZW0pOgogICAgICAgICAgICAjIFR1cm4gdGhlIERhdGFJVGVtIHRvIERhdGFGcmFtZToKICAgICAgICAgICAgZGF0YXNldCA9IGRhdGFzZXQuYXNfZGYoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgUGFyc2UgdGhlIG9iamVjdCAoc2hvdWxkIGJlIGEgcGQuRGF0YUZyYW1lIC8gcGQuU2VyaWVzLCBkaWN0aW9uYXJ5KSBpbnRvIGEgRGF0YUZyYW1lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkYXRhc2V0ID0gcGQuRGF0YUZyYW1lKGRhdGFzZXQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgICAgICAgICBmIkNvdWxkIG5vdCBwYXJzZSB0aGUgZ2l2ZW4gZGF0YXNldCBvZiB0eXBlIHt0eXBlKGRhdGFzZXQpfSBpbnRvIGEgcGFuZGFzIERhdGFGcmFtZS4gIgogICAgICAgICAgICAgICAgICAgIGYiUmVjZWl2ZWQgdGhlIGZvbGxvd2luZyBlcnJvcjoge2V9IgogICAgICAgICAgICAgICAgKQogICAgICAgICMgRHJvcCBjb2x1bW5zIGlmIG5lZWRlZDoKICAgICAgICBpZiBkcm9wX2NvbHVtbnM6CiAgICAgICAgICAgIGRhdGFzZXQuZHJvcChkcm9wX2NvbHVtbnMsIGF4aXM9MSwgaW5wbGFjZT1UcnVlKQoKICAgICMgVHVybiB0aGUgYGxhYmVsX2NvbHVtbnNgIGludG8gYSBsaXN0IGJ5IGRlZmF1bHQ6CiAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtdCiAgICBlbGlmIGlzaW5zdGFuY2UobGFiZWxfY29sdW1ucywgKHN0ciwgaW50KSk6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtsYWJlbF9jb2x1bW5zXQoKICAgIHJldHVybiBkYXRhc2V0LCBsYWJlbF9jb2x1bW5zCgoKZGVmIF9wcmVwYXJlX3Jlc3VsdF9zZXQoCiAgICB4OiBwZC5EYXRhRnJhbWUsIGxhYmVsX2NvbHVtbnM6IExpc3Rbc3RyXSwgeV9wcmVkOiBucC5uZGFycmF5CikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBTZXQgZGVmYXVsdCBsYWJlbCBjb2x1bW4gbmFtZXMgYW5kIHZhbGlkYXRlIGdpdmVuIG5hbWVzIHRvIHByZXBhcmUgdGhlIHJlc3VsdCBzZXQgLSBhIGNvbmNhdGVuYXRpb24gb2YgdGhlIGlucHV0cwogICAgKHgpIGFuZCB0aGUgbW9kZWwgcHJlZGljdGlvbnMgKHlfcHJlZCkuCgogICAgOnBhcmFtIHg6ICAgICAgICAgICAgIFRoZSBpbnB1dHMuCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uczogQSBsaXN0IG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgY29sdW1uIG5hbWVzIHRvIGFkZCB0byB0aGUgcHJlZGljdGlvbnMuIERlZmF1bHQgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgdXNlZCBpbiBjYXNlIHRoZSBsaXN0IGlzIGVtcHR5IChwcmVkaWN0ZWRfbGFiZWxfe2l9KS4KICAgIDpwYXJhbSB5X3ByZWQ6ICAgICAgICBUaGUgbW9kZWwgcHJlZGljdGlvbnMgb24gdGhlIGlucHV0cy4KCiAgICA6cmV0dXJuczogVGhlIHJlc3VsdCBzZXQuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IElmIHRoZSBsYWJlbHMgY29sdW1ucyBhbW91bnQgZG8gbm90IG1hdGNoIHRoZSBvdXRwdXRzIG9yIGlmIG9uZSBvZiB0aGUgbGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uIGFscmVhZHkgZXhpc3RzIGluIHRoZSBkYXRhc2V0LgogICAgIiIiCiAgICAjIFByZXBhcmUgZGVmYXVsdCB0YXJnZXQgY29sdW1ucyBuYW1lcyBpZiBub3QgcHJvdmlkZWQ6CiAgICBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID0gMSBpZiBsZW4oeV9wcmVkLnNoYXBlKSA9PSAxIGVsc2UgeV9wcmVkLnNoYXBlWzFdCiAgICBpZiBsZW4obGFiZWxfY29sdW1ucykgPT0gMDoKICAgICAgICAjIEFkZCBkZWZhdWx0IGxhYmVsIGNvbHVtbiBuYW1lczoKICAgICAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID09IDE6CiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBbInByZWRpY3RlZF9sYWJlbCJdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsKICAgICAgICAgICAgICAgIGYicHJlZGljdGVkX2xhYmVsX3tpfSIgZm9yIGkgaW4gcmFuZ2UocHJlZGljdGlvbl9jb2x1bW5zX2Ftb3VudCkKICAgICAgICAgICAgXQoKICAgICMgVmFsaWRhdGUgdGhlIGxhYmVsIGNvbHVtbnM6CiAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ICE9IGxlbihsYWJlbF9jb2x1bW5zKToKICAgICAgICAjIE5vIGVxdWFsaXR5IGJldHdlZW4gcHJvdmlkZWQgbGFiZWwgY29sdW1uIG5hbWVzIGFuZCBvdXRwdXRzIGFtb3VudDoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbnVtYmVyIG9mIHByZWRpY3RlZCBsYWJlbHM6IHtwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50fSAiCiAgICAgICAgICAgIGYiaXMgbm90IGVxdWFsIHRvIHRoZSBnaXZlbiBsYWJlbCBjb2x1bW5zOiB7bGVuKGxhYmVsX2NvbHVtbnMpfSIKICAgICAgICApCiAgICBjb21tb25fbGFiZWxzID0gc2V0KGxhYmVsX2NvbHVtbnMpICYgc2V0KHguY29sdW1ucy50b2xpc3QoKSkKICAgIGlmIGNvbW1vbl9sYWJlbHM6CiAgICAgICAgIyBMYWJlbCBjb2x1bW4gZXhpc3QgaW4gdGhlIG9yaWdpbmFsIGlucHV0czoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbGFiZWxzOiB7Y29tbW9uX2xhYmVsc30gYXJlIGFscmVhZHkgZXhpc3RlZCBpbiB0aGUgZ2l2ZW4gZGF0YXNldC4iCiAgICAgICAgKQoKICAgIHJldHVybiBwZC5jb25jYXQoCiAgICAgICAgW3gsIHBkLkRhdGFGcmFtZSh5X3ByZWQsIGNvbHVtbnM9bGFiZWxfY29sdW1ucywgaW5kZXg9eC5pbmRleCldLCBheGlzPTEKICAgICkKCgpkZWYgX2dldF9zYW1wbGVfc2V0X3N0YXRpc3RpY3MoCiAgICBzYW1wbGVfc2V0OiBEYXRhc2V0VHlwZSA9IE5vbmUsIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHM6IGRpY3QgPSBOb25lCikgLT4gZGljdDoKICAgICIiIgogICAgR2V0IHRoZSBzYW1wbGUgc2V0IHN0YXRpc3RpY3MgZWl0aGVyIGZyb20gdGhlIGdpdmVuIHNhbXBsZSBzZXQgb3IgdGhlIHN0YXRpc3RpY3MgbG9nZ2VkIHdpdGggdGhlIG1vZGVsIHdoaWxlCiAgICBmYXZvcmluZyB0aGUgZ2l2ZW4gc2FtcGxlIHNldC4KCiAgICA6cGFyYW0gc2FtcGxlX3NldDogICAgICAgICAgICAgICAgICAgQSBzYW1wbGUgZGF0YXNldCB0byBnaXZlIHRvIGNvbXBhcmUgdGhlIGlucHV0cyBpbiB0aGUgZHJpZnQgYW5hbHlzaXMuCiAgICA6cGFyYW0gbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0czogVGhlIGBmZWF0dXJlX3N0YXRzYCBhdHRyaWJ1dGUgaW4gdGhlIHNwZWMgb2YgdGhlIG1vZGVsIGFydGlmYWN0LCB3aGVyZSB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbCBzYW1wbGUgc2V0IHN0YXRpc3RpY3Mgb2YgdGhlIG1vZGVsIHdhcyB1c2VkLgoKICAgIDpyZXR1cm5zOiBUaGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzLgoKICAgIHJhaXNlcyBNTFJ1bkludmFsaWRBcmd1bWVudEVycm9yOiBJZiBubyBzYW1wbGUgc2V0IG9yIHN0YXRpc3RpY3Mgd2VyZSBnaXZlbi4KICAgICIiIgogICAgIyBDaGVjayBpZiBhIHNhbXBsZSBzZXQgd2FzIHByb3ZpZGVkOgogICAgaWYgc2FtcGxlX3NldCBpcyBOb25lOgogICAgICAgICMgQ2hlY2sgaWYgdGhlIG1vZGVsIHdhcyBsb2dnZWQgd2l0aCBhIHNhbXBsZSBzZXQ6CiAgICAgICAgaWYgbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0cyBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgICAgICJDYW5ub3QgcGVyZm9ybSBkcmlmdCBhbmFseXNpcyBhcyB0aGVyZSBpcyBubyBzYW1wbGUgc2V0IHRvIGNvbXBhcmUgdG8uIFRoZSBtb2RlbCBhcnRpZmFjdCB3YXMgbm90ICIKICAgICAgICAgICAgICAgICJsb2dnZWQgd2l0aCBhIHNhbXBsZSBzZXQgYW5kIGBzYW1wbGVfc2V0YCB3YXMgbm90IHByb3ZpZGVkIHRvIHRoZSBmdW5jdGlvbi4iCiAgICAgICAgICAgICkKICAgICAgICAjIFJldHVybiB0aGUgc3RhdGlzdGljcyBsb2dnZWQgd2l0aCB0aGUgbW9kZWw6CiAgICAgICAgcmV0dXJuIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHMKCiAgICAjIFR1cm4gdGhlIERhdGFJdGVtIHRvIERhdGFGcmFtZToKICAgIGlmIGlzaW5zdGFuY2Uoc2FtcGxlX3NldCwgbWxydW4uRGF0YUl0ZW0pOgogICAgICAgIHNhbXBsZV9zZXQsIF8gPSBfcmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZShkYXRhc2V0PXNhbXBsZV9zZXQpCgogICAgIyBSZXR1cm4gdGhlIHNhbXBsZSBzZXQgc3RhdGlzdGljczoKICAgIHJldHVybiBnZXRfZGZfc3RhdHMoZGY9c2FtcGxlX3NldCwgb3B0aW9ucz1JbmZlck9wdGlvbnMuSGlzdG9ncmFtKQoKCmRlZiBfZ2V0X2RyaWZ0X3Jlc3VsdCgKICAgIHR2ZDogZmxvYXQsCiAgICBoZWxsaW5nZXI6IGZsb2F0LAogICAgdGhyZXNob2xkOiBmbG9hdCwKKSAtPiBUdXBsZVtib29sLCBmbG9hdF06CiAgICAiIiIKICAgIENhbGN1bGF0ZSB0aGUgZHJpZnQgcmVzdWx0IGJ5IHRoZSBmb2xsb3dpbmcgZXF1YXRpb246ICh0dmQgKyBoZWxsaW5nZXIpIC8gMgoKICAgIDpwYXJhbSB0dmQ6ICAgICAgIFRoZSBmZWF0dXJlJ3MgVFZEIHZhbHVlLgogICAgOnBhcmFtIGhlbGxpbmdlcjogVGhlIGZlYXR1cmUncyBIZWxsaW5nZXIgdmFsdWUuCiAgICA6cGFyYW0gdGhyZXNob2xkOiBUaGUgdGhyZXNob2xkIGZyb20gd2hpY2ggdGhlIHZhbHVlIGlzIGNvbnNpZGVyZWQgYSBkcmlmdC4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKICAgICAgICAgICAgICBbMF0gPSBCb29sZWFuIHZhbHVlIGFzIHRoZSBkcmlmdCBzdGF0dXMuCiAgICAgICAgICAgICAgWzFdID0gVGhlIHJlc3VsdC4KICAgICIiIgogICAgcmVzdWx0ID0gKHR2ZCArIGhlbGxpbmdlcikgLyAyCiAgICBpZiByZXN1bHQgPj0gdGhyZXNob2xkOgogICAgICAgIHJldHVybiBUcnVlLCByZXN1bHQKICAgIHJldHVybiBGYWxzZSwgcmVzdWx0CgoKZGVmIF9wZXJmb3JtX2RyaWZ0X2FuYWx5c2lzKAogICAgc2FtcGxlX3NldF9zdGF0aXN0aWNzOiBkaWN0LAogICAgaW5wdXRzOiBwZC5EYXRhRnJhbWUsCiAgICBkcmlmdF90aHJlc2hvbGQ6IGZsb2F0LAogICAgcG9zc2libGVfZHJpZnRfdGhyZXNob2xkOiBmbG9hdCwKICAgIGluZl9jYXBwaW5nOiBmbG9hdCwKKSAtPiBUdXBsZVtBcnRpZmFjdCwgQXJ0aWZhY3QsIGRpY3RdOgogICAgIiIiCiAgICBQZXJmb3JtIGRyaWZ0IGFuYWx5c2lzLCBwcm9kdWNpbmcgdGhlIGRyaWZ0IHRhYmxlIGFydGlmYWN0IGZvciBsb2dnaW5nIHBvc3QgcHJlZGljdGlvbi4KCiAgICA6cGFyYW0gc2FtcGxlX3NldF9zdGF0aXN0aWNzOiAgICBUaGUgc3RhdGlzdGljcyBvZiB0aGUgc2FtcGxlIHNldCBsb2dnZWQgYWxvbmcgYSBtb2RlbC4KICAgIDpwYXJhbSBpbnB1dHM6ICAgICAgICAgICAgICAgICAgIElucHV0IGRhdGFzZXQgdG8gcGVyZm9ybSB0aGUgZHJpZnQgY2FsY3VsYXRpb24gb24uCiAgICA6cGFyYW0gZHJpZnRfdGhyZXNob2xkOiAgICAgICAgICBUaGUgdGhyZXNob2xkIG9mIHdoaWNoIHRvIG1hcmsgZHJpZnRzLgogICAgOnBhcmFtIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIHBvc3NpYmxlIGRyaWZ0cy4KICAgIDpwYXJhbSBpbmZfY2FwcGluZzogICAgICAgICAgICAgIFRoZSB2YWx1ZSB0byBzZXQgZm9yIHdoZW4gaXQgcmVhY2hlZCBpbmZpbml0eS4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZgogICAgICAgICAgICAgIFswXSA9IEFuIE1MUnVuIGFydGlmYWN0IGhvbGRpbmcgdGhlIEhUTUwgY29kZSBvZiB0aGUgZHJpZnQgdGFibGUgcGxvdC4KICAgICAgICAgICAgICBbMV0gPSBBbiBNTFJ1biBhcnRpZmFjdCBob2xkaW5nIHRoZSBtZXRyaWMgcGVyIGZlYXR1cmUgZGljdGlvbmFyeS4KICAgICAgICAgICAgICBbMl0gPSBSZXN1bHRzIHRvIGxvZyB0aGUgZmluYWwgYW5hbHlzaXMgb3V0Y29tZS4KICAgICIiIgogICAgIyBDYWxjdWxhdGUgdGhlIGlucHV0J3Mgc3RhdGlzdGljczoKICAgIGlucHV0c19zdGF0aXN0aWNzID0gY2FsY3VsYXRlX2lucHV0c19zdGF0aXN0aWNzKAogICAgICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljcz1zYW1wbGVfc2V0X3N0YXRpc3RpY3MsCiAgICAgICAgaW5wdXRzPWlucHV0cywKICAgICkKCiAgICAjIENhbGN1bGF0ZSBkcmlmdDoKICAgIHZpcnR1YWxfZHJpZnQgPSBWaXJ0dWFsRHJpZnQoaW5mX2NhcHBpbmc9aW5mX2NhcHBpbmcpCiAgICBtZXRyaWNzID0gdmlydHVhbF9kcmlmdC5jb21wdXRlX2RyaWZ0X2Zyb21faGlzdG9ncmFtcygKICAgICAgICBmZWF0dXJlX3N0YXRzPXNhbXBsZV9zZXRfc3RhdGlzdGljcywKICAgICAgICBjdXJyZW50X3N0YXRzPWlucHV0c19zdGF0aXN0aWNzLAogICAgKQogICAgZHJpZnRfcmVzdWx0cyA9IHZpcnR1YWxfZHJpZnQuY2hlY2tfZm9yX2RyaWZ0X3Blcl9mZWF0dXJlKAogICAgICAgIG1ldHJpY3NfcmVzdWx0c19kaWN0aW9uYXJ5PW1ldHJpY3MsCiAgICAgICAgcG9zc2libGVfZHJpZnRfdGhyZXNob2xkPXBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZCwKICAgICAgICBkcmlmdF9kZXRlY3RlZF90aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgKQoKICAgICMgVmFsaWRhdGUgYWxsIGZlYXR1cmUgY29sdW1ucyBuYW1lZCB0aGUgc2FtZSBiZXR3ZWVuIHRoZSBpbnB1dHMgYW5kIHNhbXBsZSBzZXRzOgogICAgc2FtcGxlX2ZlYXR1cmVzID0gc2V0KAogICAgICAgIFsKICAgICAgICAgICAgZmVhdHVyZV9uYW1lCiAgICAgICAgICAgIGZvciBmZWF0dXJlX25hbWUsIGZlYXR1cmVfc3RhdGlzdGljcyBpbiBzYW1wbGVfc2V0X3N0YXRpc3RpY3MuaXRlbXMoKQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGZlYXR1cmVfc3RhdGlzdGljcywgZGljdCkKICAgICAgICBdCiAgICApCiAgICBpbnB1dF9mZWF0dXJlcyA9IHNldChpbnB1dHMuY29sdW1ucykKICAgIGlmIGxlbihzYW1wbGVfZmVhdHVyZXMgJiBpbnB1dF9mZWF0dXJlcykgIT0gbGVuKGlucHV0X2ZlYXR1cmVzKToKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJOb3QgYWxsIGZlYXR1cmUgbmFtZXMgd2VyZSBtYXRjaGluZyBiZXR3ZWVuIHRoZSBpbnB1dHMgYW5kIHRoZSBzYW1wbGUgc2V0IHByb3ZpZGVkOiAiCiAgICAgICAgICAgIGYie2lucHV0X2ZlYXR1cmVzIC0gc2FtcGxlX2ZlYXR1cmVzIHwgc2FtcGxlX2ZlYXR1cmVzIC0gaW5wdXRfZmVhdHVyZXN9IgogICAgICAgICkKCiAgICAjIFBsb3Q6CiAgICBodG1sX3Bsb3QgPSBGZWF0dXJlc0RyaWZ0VGFibGVQbG90KCkucHJvZHVjZSgKICAgICAgICBmZWF0dXJlcz1saXN0KGlucHV0X2ZlYXR1cmVzKSwKICAgICAgICBzYW1wbGVfc2V0X3N0YXRpc3RpY3M9c2FtcGxlX3NldF9zdGF0aXN0aWNzLAogICAgICAgIGlucHV0c19zdGF0aXN0aWNzPWlucHV0c19zdGF0aXN0aWNzLAogICAgICAgIG1ldHJpY3M9bWV0cmljcywKICAgICAgICBkcmlmdF9yZXN1bHRzPWRyaWZ0X3Jlc3VsdHMsCiAgICApCgogICAgIyBQcmVwYXJlIG1ldHJpY3MgcGVyIGZlYXR1cmUgZGljdGlvbmFyeToKICAgIG1ldHJpY3NfcGVyX2ZlYXR1cmUgPSB7CiAgICAgICAgZmVhdHVyZTogX2dldF9kcmlmdF9yZXN1bHQoCiAgICAgICAgICAgIHR2ZD1tZXRyaWNfZGljdGlvbmFyeVsidHZkIl0sCiAgICAgICAgICAgIGhlbGxpbmdlcj1tZXRyaWNfZGljdGlvbmFyeVsiaGVsbGluZ2VyIl0sCiAgICAgICAgICAgIHRocmVzaG9sZD1kcmlmdF90aHJlc2hvbGQsCiAgICAgICAgKVsxXQogICAgICAgIGZvciBmZWF0dXJlLCBtZXRyaWNfZGljdGlvbmFyeSBpbiBtZXRyaWNzLml0ZW1zKCkKICAgICAgICBpZiBpc2luc3RhbmNlKG1ldHJpY19kaWN0aW9uYXJ5LCBkaWN0KQogICAgfQoKICAgICMgQ2FsY3VsYXRlIHRoZSBmaW5hbCBhbmFseXNpcyByZXN1bHQ6CiAgICBkcmlmdF9zdGF0dXMsIGRyaWZ0X21ldHJpYyA9IF9nZXRfZHJpZnRfcmVzdWx0KAogICAgICAgIHR2ZD1tZXRyaWNzWyJ0dmRfbWVhbiJdLAogICAgICAgIGhlbGxpbmdlcj1tZXRyaWNzWyJoZWxsaW5nZXJfbWVhbiJdLAogICAgICAgIHRocmVzaG9sZD1kcmlmdF90aHJlc2hvbGQsCiAgICApCgogICAgcmV0dXJuICgKICAgICAgICBBcnRpZmFjdChib2R5PWh0bWxfcGxvdCwgZm9ybWF0PSJodG1sIiwga2V5PSJkcmlmdF90YWJsZV9wbG90IiksCiAgICAgICAgQXJ0aWZhY3QoCiAgICAgICAgICAgIGJvZHk9anNvbi5kdW1wcyhtZXRyaWNzX3Blcl9mZWF0dXJlKSwKICAgICAgICAgICAgZm9ybWF0PSJqc29uIiwKICAgICAgICAgICAga2V5PSJmZWF0dXJlc19kcmlmdF9yZXN1bHRzIiwKICAgICAgICApLAogICAgICAgIHsiZHJpZnRfc3RhdHVzIjogZHJpZnRfc3RhdHVzLCAiZHJpZnRfbWV0cmljIjogZHJpZnRfbWV0cmljfSwKICAgICkKCgpkZWYgaW5mZXIoCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgIG1vZGVsOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhc2V0VHlwZSwKICAgIGRyb3BfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl0sIGludCwgTGlzdFtpbnRdXSA9IE5vbmUsCiAgICBsYWJlbF9jb2x1bW5zOiBVbmlvbltzdHIsIExpc3Rbc3RyXV0gPSBOb25lLAogICAgbG9nX3Jlc3VsdF9zZXQ6IGJvb2wgPSBUcnVlLAogICAgcmVzdWx0X3NldF9uYW1lOiBzdHIgPSAicHJlZGljdGlvbiIsCiAgICBiYXRjaF9pZDogc3RyID0gTm9uZSwKICAgIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXM6IGJvb2wgPSBOb25lLAogICAgc2FtcGxlX3NldDogRGF0YXNldFR5cGUgPSBOb25lLAogICAgZHJpZnRfdGhyZXNob2xkOiBmbG9hdCA9IDAuNywKICAgIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogZmxvYXQgPSAwLjUsCiAgICBpbmZfY2FwcGluZzogZmxvYXQgPSAxMC4wLAogICAgYXJ0aWZhY3RzX3RhZzogc3RyID0gIiIsCiAgICAqKnByZWRpY3Rfa3dhcmdzOiBEaWN0W3N0ciwgQW55XSwKKToKICAgICIiIgogICAgUGVyZm9ybSBhIHByZWRpY3Rpb24gb24gYSBnaXZlbiBkYXRhc2V0IHdpdGggdGhlIGdpdmVuIG1vZGVsLiBDYW4gcGVyZm9ybSBkcmlmdCBhbmFseXNpcyBiZXR3ZWVuIHRoZSBzYW1wbGUgc2V0CiAgICBzdGF0aXN0aWNzIHN0b3JlZCBpbiB0aGUgbW9kZWwgdG8gdGhlIGN1cnJlbnQgaW5wdXQgZGF0YS4gVGhlIGRyaWZ0IHJ1bGUgaXMgdGhlIHZhbHVlIHBlci1mZWF0dXJlIG1lYW4gb2YgdGhlIFRWRAogICAgYW5kIEhlbGxpbmdlciBzY29yZXMgYWNjb3JkaW5nIHRvIHRoZSB0aHJlc2hvbGRzIGNvbmZpZ3VyZXMgaGVyZS4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgICAgICBNTFJ1biBjb250ZXh0LgogICAgOnBhcmFtIG1vZGVsOiAgICAgICAgICAgICAgICAgICAgVGhlIG1vZGVsIFN0b3JlIHBhdGguCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICAgICAgICBUaGUgZGF0YXNldCB0byBpbmZlciB0aHJvdWdoIHRoZSBtb2RlbC4gQ2FuIGJlIHBhc3NlZCBpbiBgaW5wdXRzYCBhcyBlaXRoZXIgYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGF0YXNldCBhcnRpZmFjdCAvIEZlYXR1cmUgdmVjdG9yIFVSSS4gT3IsIGluIGBwYXJhbWV0ZXJzYCBhcyBhIGxpc3QsIGRpY3Rpb25hcnkgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bXB5IGFycmF5LgogICAgOnBhcmFtIGRyb3BfY29sdW1uczogICAgICAgICAgICAgQSBzdHJpbmcgLyBpbnRlZ2VyIG9yIGEgbGlzdCBvZiBzdHJpbmdzIC8gaW50ZWdlcnMgdGhhdCByZXByZXNlbnQgdGhlIGNvbHVtbiBuYW1lcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyBpbmRpY2VzIHRvIGRyb3AuIFdoZW4gdGhlIGRhdGFzZXQgaXMgYSBsaXN0IG9yIGEgbnVtcHkgYXJyYXkgdGhpcyBwYXJhbWV0ZXIgbXVzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmUgcmVwcmVzZW50ZWQgYnkgaW50ZWdlcnMuCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uczogICAgICAgICAgICBUaGUgdGFyZ2V0IGxhYmVsKHMpIG9mIHRoZSBjb2x1bW4ocykgaW4gdGhlIGRhdGFzZXQgZm9yIFJlZ3Jlc3Npb24gb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENsYXNzaWZpY2F0aW9uIHRhc2tzLiBUaGUgbGFiZWwgY29sdW1uIGNhbiBiZSBhY2Nlc3NlZCBmcm9tIHRoZSBtb2RlbCBvYmplY3QsIG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgZmVhdHVyZSB2ZWN0b3IgcHJvdmlkZWQgaWYgYXZhaWxhYmxlLgogICAgOnBhcmFtIGxvZ19yZXN1bHRfc2V0OiAgICAgICAgICAgV2hldGhlciB0byBsb2cgdGhlIHJlc3VsdCBzZXQgLSBhIERhdGFGcmFtZSBvZiB0aGUgZ2l2ZW4gaW5wdXRzIGNvbmNhdGVuYXRlZCB3aXRoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgcHJlZGljdGlvbnMuIERlZmF1bHRlZCB0byBUcnVlLgogICAgOnBhcmFtIHJlc3VsdF9zZXRfbmFtZTogICAgICAgICAgVGhlIGRiIGtleSB0byBzZXQgbmFtZSBvZiB0aGUgcHJlZGljdGlvbiByZXN1bHQgYW5kIHRoZSBmaWxlbmFtZS4gRGVmYXVsdGVkIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncHJlZGljdGlvbicuCiAgICA6cGFyYW0gYmF0Y2hfaWQ6ICAgICAgICAgICAgICAgICBUaGUgSUQgb2YgdGhlIGdpdmVuIGJhdGNoIChpbmZlcmVuY2UgZGF0YXNldCkuIElmIGBOb25lYCwgaXQgd2lsbCBiZSBnZW5lcmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBXaWxsIGJlIGxvZ2dlZCBhcyBhIHJlc3VsdCBvZiB0aGUgcnVuLgogICAgOnBhcmFtIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXM6ICAgV2hldGhlciB0byBwZXJmb3JtIGRyaWZ0IGFuYWx5c2lzIGJldHdlZW4gdGhlIHNhbXBsZSBzZXQgb2YgdGhlIG1vZGVsIG9iamVjdCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXQgZ2l2ZW4uIEJ5IGRlZmF1bHQsIE5vbmUsIHdoaWNoIG1lYW5zIGl0IHdpbGwgcGVyZm9ybSBkcmlmdCBhbmFseXNpcyBpZiB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsIGhhcyBhIHNhbXBsZSBzZXQgc3RhdGlzdGljcy4gUGVyZm9ybSBkcmlmdCBhbmFseXNpcyB3aWxsIHByb2R1Y2UgYSBkYXRhIGRyaWZ0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJsZSBhcnRpZmFjdC4KICAgIDpwYXJhbSBzYW1wbGVfc2V0OiAgICAgICAgICAgICAgIEEgc2FtcGxlIGRhdGFzZXQgdG8gZ2l2ZSB0byBjb21wYXJlIHRoZSBpbnB1dHMgaW4gdGhlIGRyaWZ0IGFuYWx5c2lzLiBUaGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvc2VuIHNhbXBsZSBzZXQgd2lsbCBhbHdheXMgYmUgdGhlIG9uZSB3aG8gaXMgc2V0IGluIHRoZSBtb2RlbCBhcnRpZmFjdCBpdHNlbGYuCiAgICA6cGFyYW0gZHJpZnRfdGhyZXNob2xkOiAgICAgICAgICBUaGUgdGhyZXNob2xkIG9mIHdoaWNoIHRvIG1hcmsgZHJpZnRzLiBEZWZhdWx0ZWQgdG8gMC43LgogICAgOnBhcmFtIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIHBvc3NpYmxlIGRyaWZ0cy4gRGVmYXVsdGVkIHRvIDAuNS4KICAgIDpwYXJhbSBpbmZfY2FwcGluZzogICAgICAgICAgICAgIFRoZSB2YWx1ZSB0byBzZXQgZm9yIHdoZW4gaXQgcmVhY2hlZCBpbmZpbml0eS4gRGVmYXVsdGVkIHRvIDEwLjAuCiAgICA6cGFyYW0gYXJ0aWZhY3RzX3RhZzogICAgICAgICAgICBUYWcgdG8gdXNlIGZvciBhbGwgdGhlIGFydGlmYWN0cyByZXN1bHRlZCBmcm9tIHRoZSBmdW5jdGlvbi4KICAgICIiIgogICAgIyBMb2FkaW5nIHRoZSBtb2RlbDoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJMb2FkaW5nIG1vZGVsLi4uIikKICAgIG1vZGVsX2hhbmRsZXIgPSBBdXRvTUxSdW4ubG9hZF9tb2RlbChtb2RlbF9wYXRoPW1vZGVsLCBjb250ZXh0PWNvbnRleHQpCiAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsKICAgICAgICAgICAgb3V0cHV0Lm5hbWUgZm9yIG91dHB1dCBpbiBtb2RlbF9oYW5kbGVyLl9tb2RlbF9hcnRpZmFjdC5zcGVjLm91dHB1dHMKICAgICAgICBdCgogICAgIyBHZXQgZGF0YXNldCBieSBvYmplY3QsIFVSTCBvciBieSBGZWF0dXJlVmVjdG9yOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkxvYWRpbmcgZGF0YS4uLiIpCiAgICB4LCBsYWJlbF9jb2x1bW5zID0gX3JlYWRfZGF0YXNldF9hc19kYXRhZnJhbWUoCiAgICAgICAgZGF0YXNldD1kYXRhc2V0LAogICAgICAgIGxhYmVsX2NvbHVtbnM9bGFiZWxfY29sdW1ucywKICAgICAgICBkcm9wX2NvbHVtbnM9ZHJvcF9jb2x1bW5zLAogICAgKQoKICAgICMgUHJlZGljdDoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJDYWxjdWxhdGluZyBwcmVkaWN0aW9uLi4uIikKICAgIHlfcHJlZCA9IG1vZGVsX2hhbmRsZXIubW9kZWwucHJlZGljdCh4LCAqKnByZWRpY3Rfa3dhcmdzKQoKICAgICMgUHJlcGFyZSB0aGUgcmVzdWx0IHNldDoKICAgIHJlc3VsdF9zZXQgPSBfcHJlcGFyZV9yZXN1bHRfc2V0KHg9eCwgbGFiZWxfY29sdW1ucz1sYWJlbF9jb2x1bW5zLCB5X3ByZWQ9eV9wcmVkKQoKICAgICMgQ2hlY2sgZm9yIGxvZ2dpbmcgdGhlIHJlc3VsdCBzZXQ6CiAgICBpZiBsb2dfcmVzdWx0X3NldDoKICAgICAgICAjIExvZyB0aGUgcmVzdWx0IHNldDoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9nZ2luZyByZXN1bHQgc2V0ICh4IHwgcHJlZGljdGlvbikuLi4iKQogICAgICAgIGNvbnRleHQubG9nX2RhdGFzZXQoCiAgICAgICAgICAgIGtleT1yZXN1bHRfc2V0X25hbWUsCiAgICAgICAgICAgIGRmPXJlc3VsdF9zZXQsCiAgICAgICAgICAgIGRiX2tleT1yZXN1bHRfc2V0X25hbWUsCiAgICAgICAgICAgIHRhZz1hcnRpZmFjdHNfdGFnLAogICAgICAgICkKICAgICAgICAjIExvZyB0aGUgYmF0Y2ggSUQ6CiAgICAgICAgaWYgYmF0Y2hfaWQgaXMgTm9uZToKICAgICAgICAgICAgYmF0Y2hfaWQgPSBoYXNobGliLnNoYTIyNChzdHIoZGF0ZXRpbWUubm93KCkpLmVuY29kZSgpKS5oZXhkaWdlc3QoKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdCgKICAgICAgICAgICAga2V5PSJiYXRjaF9pZCIsCiAgICAgICAgICAgIHZhbHVlPWJhdGNoX2lkLAogICAgICAgICkKCiAgICAjIENoZWNrIGZvciBwZXJmb3JtaW5nIGRyaWZ0IGFuYWx5c2lzOgogICAgaWYgKAogICAgICAgIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXMgaXMgTm9uZQogICAgICAgIGFuZCBtb2RlbF9oYW5kbGVyLl9tb2RlbF9hcnRpZmFjdC5zcGVjLmZlYXR1cmVfc3RhdHMgaXMgbm90IE5vbmUKICAgICk6CiAgICAgICAgcGVyZm9ybV9kcmlmdF9hbmFseXNpcyA9IFRydWUKICAgIGlmIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXM6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiUGVyZm9ybWluZyBkcmlmdCBhbmFseXNpcy4uLiIpCiAgICAgICAgIyBHZXQgdGhlIHNhbXBsZSBzZXQgc3RhdGlzdGljcyAoZWl0aGVyIGZyb20gdGhlIHNhbXBsZSBzZXQgb3IgZnJvbSB0aGUgc3RhdGlzdGljcyBsb2dnZWQgd2l0aCB0aGUgbW9kZWwpOgogICAgICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljcyA9IF9nZXRfc2FtcGxlX3NldF9zdGF0aXN0aWNzKAogICAgICAgICAgICBzYW1wbGVfc2V0PXNhbXBsZV9zZXQsCiAgICAgICAgICAgIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHM9bW9kZWxfaGFuZGxlci5fbW9kZWxfYXJ0aWZhY3Quc3BlYy5mZWF0dXJlX3N0YXRzLAogICAgICAgICkKICAgICAgICAjIFByb2R1Y2UgdGhlIGFydGlmYWN0OgogICAgICAgICgKICAgICAgICAgICAgZHJpZnRfdGFibGVfcGxvdCwKICAgICAgICAgICAgbWV0cmljX3Blcl9mZWF0dXJlX2RpY3QsCiAgICAgICAgICAgIGFuYWx5c2lzX3Jlc3VsdHMsCiAgICAgICAgKSA9IF9wZXJmb3JtX2RyaWZ0X2FuYWx5c2lzKAogICAgICAgICAgICBzYW1wbGVfc2V0X3N0YXRpc3RpY3M9c2FtcGxlX3NldF9zdGF0aXN0aWNzLAogICAgICAgICAgICBpbnB1dHM9cmVzdWx0X3NldCwKICAgICAgICAgICAgZHJpZnRfdGhyZXNob2xkPWRyaWZ0X3RocmVzaG9sZCwKICAgICAgICAgICAgcG9zc2libGVfZHJpZnRfdGhyZXNob2xkPXBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZCwKICAgICAgICAgICAgaW5mX2NhcHBpbmc9aW5mX2NhcHBpbmcsCiAgICAgICAgKQogICAgICAgICMgTG9nIHRoZSBhcnRpZmFjdCBhbmQgcmVzdWx0czoKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChkcmlmdF90YWJsZV9wbG90LCB0YWc9YXJ0aWZhY3RzX3RhZykKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChtZXRyaWNfcGVyX2ZlYXR1cmVfZGljdCwgdGFnPWFydGlmYWN0c190YWcpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0cyhyZXN1bHRzPWFuYWx5c2lzX3Jlc3VsdHMpCg==
    commands: []
    code_origin: https://github.com/yonishelach/functions.git#1f6afed6bbe17186995c39b6e40067cfd8dc6e64:/Users/Yonatan_Shelach/projects/functions/batch_inference/batch_inference.py
    origin_filename: /Users/Yonatan_Shelach/projects/functions/batch_inference/batch_inference.py
    with_mlrun: false
    auto_build: false
  entry_points:
    infer:
      name: infer
      doc: 'Perform a prediction on a given dataset with the given model. Can perform
        drift analysis between the sample set

        statistics stored in the model to the current input data. The drift rule is
        the value per-feature mean of the TVD

        and Hellinger scores according to the thresholds configures here.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
        default: ''
      - name: model
        type: str
        doc: The model Store path.
        default: ''
      - name: dataset
        type: DatasetType
        doc: The dataset to infer through the model. Can be passed in `inputs` as
          either a Dataset artifact / Feature vector URI. Or, in `parameters` as a
          list, dictionary or numpy array.
        default: ''
      - name: drop_columns
        type: Union[str, List[str], int, List[int]]
        doc: A string / integer or a list of strings / integers that represent the
          column names / indices to drop. When the dataset is a list or a numpy array
          this parameter must be represented by integers.
        default: null
      - name: label_columns
        type: Union[str, List[str]]
        doc: The target label(s) of the column(s) in the dataset for Regression or
          Classification tasks. The label column can be accessed from the model object,
          or the feature vector provided if available.
        default: null
      - name: log_result_set
        type: bool
        doc: Whether to log the result set - a DataFrame of the given inputs concatenated
          with the predictions. Defaulted to True.
        default: true
      - name: result_set_name
        type: str
        doc: The db key to set name of the prediction result and the filename. Defaulted
          to 'prediction'.
        default: prediction
      - name: batch_id
        type: str
        doc: The ID of the given batch (inference dataset). If `None`, it will be
          generated. Will be logged as a result of the run.
        default: null
      - name: perform_drift_analysis
        type: bool
        doc: Whether to perform drift analysis between the sample set of the model
          object to the dataset given. By default, None, which means it will perform
          drift analysis if the model has a sample set statistics. Perform drift analysis
          will produce a data drift table artifact.
        default: null
      - name: sample_set
        type: DatasetType
        doc: A sample dataset to give to compare the inputs in the drift analysis.
          The default chosen sample set will always be the one who is set in the model
          artifact itself.
        default: null
      - name: drift_threshold
        type: float
        doc: The threshold of which to mark drifts. Defaulted to 0.7.
        default: 0.7
      - name: possible_drift_threshold
        type: float
        doc: The threshold of which to mark possible drifts. Defaulted to 0.5.
        default: 0.5
      - name: inf_capping
        type: float
        doc: The value to set for when it reached infinity. Defaulted to 10.0.
        default: 10.0
      - name: artifacts_tag
        type: str
        doc: Tag to use for all the artifacts resulted from the function.
        default: ''
      outputs:
      - default: ''
      lineno: 306
  description: Batch inference (also knows as prediction) for the common ML frameworks
    (SciKit-Learn, XGBoost and LightGBM) while performing data drift analysis.
  default_handler: infer
  disable_auto_mount: false
  allow_empty_resources: true
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
