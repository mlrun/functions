kind: job
metadata:
  name: sklearn-classifier-dask
  tag: ''
  hash: 9eda6a55463782ab74a8661bf0cd0fa8042c0069
  project: ''
  labels:
    author: yjb
    framework: sklearn
  categories:
  - machine-learning
  - model-training
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: Train a sklearn classifier with Dask
      parameters:
      - name: context
        doc: Function context.
        default: ''
      - name: dataset
        type: DataItem
        doc: Raw data file.
        default: ''
      - name: model_pkg_class
        type: str
        doc: Model to train, e.g, "sklearn.ensemble.RandomForestClassifier",  or json
          model config.
        default: ''
      - name: label_column
        type: str
        doc: (label) Ground-truth y labels.
        default: label
      - name: train_validation_size
        type: float
        doc: (0.75) Train validation set proportion out of the full dataset.
        default: 0.75
      - name: sample
        type: float
        doc: (1.0) Select sample from dataset (n-rows/% of total), randomzie rows
          as default.
        default: 1.0
      - name: models_dest
        type: str
        doc: (models) Models subfolder on artifact path.
        default: models
      - name: test_set_key
        type: str
        doc: (test_set) Mlrun db key of held out data in artifact store.
        default: test_set
      - name: plots_dest
        type: str
        doc: (plots) Plot subfolder on artifact path.
        default: plots
      - name: dask_function
        type: str
        doc: dask function url (db://..)
        default: null
      - name: dask_client
        doc: dask client object
        default: null
      - name: file_ext
        type: str
        doc: (parquet) format for test_set_key hold out data
        default: parquet
      - name: random_state
        type: int
        doc: (42) sklearn seed
        default: 42
      outputs:
      - default: ''
      lineno: 29
  description: train any classifier using scikit-learn's API over Dask
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG1scnVuCgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoJ2lnbm9yZScpCgppbXBvcnQgb3MKaW1wb3J0IGpvYmxpYgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcywgbG9hZCwgZHVtcAoKZnJvbSBkYXNrIGltcG9ydCBkYXRhZnJhbWUgYXMgZGQKZnJvbSBkYXNrIGltcG9ydCBhcnJheSBhcyBkYQpmcm9tIGRhc2suZGVsYXllZCBpbXBvcnQgZGVsYXllZApmcm9tIGRhc2tfbWwgaW1wb3J0IG1vZGVsX3NlbGVjdGlvbgpmcm9tIGRhc2tfbWwgaW1wb3J0IG1ldHJpY3MKZnJvbSBkYXNrX21sLnByZXByb2Nlc3NpbmcgaW1wb3J0IFN0YW5kYXJkU2NhbGVyLCBMYWJlbEVuY29kZXIKCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QKZnJvbSBtbHJ1bi5tbHV0aWxzLm1vZGVscyBpbXBvcnQgZ2VuX3NrbGVhcm5fbW9kZWwKZnJvbSBtbHJ1bi51dGlscy5oZWxwZXJzIGltcG9ydCBjcmVhdGVfY2xhc3MKCmltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKZnJvbSB5ZWxsb3dicmljay5jbGFzc2lmaWVyIGltcG9ydCBST0NBVUMsIENsYXNzaWZpY2F0aW9uUmVwb3J0LCBDb25mdXNpb25NYXRyaXgKZnJvbSB5ZWxsb3dicmljay5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IEZlYXR1cmVJbXBvcnRhbmNlcwoKZGVmIHRyYWluX21vZGVsKGNvbnRleHQsCiAgICAgICAgICAgICAgICBkYXRhc2V0OiBtbHJ1bi5EYXRhSXRlbSwKICAgICAgICAgICAgICAgIG1vZGVsX3BrZ19jbGFzczogc3RyLAogICAgICAgICAgICAgICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWwiLAogICAgICAgICAgICAgICAgdHJhaW5fdmFsaWRhdGlvbl9zaXplOiBmbG9hdCA9IDAuNzUsCiAgICAgICAgICAgICAgICBzYW1wbGU6IGZsb2F0ID0gMS4wLAogICAgICAgICAgICAgICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICJtb2RlbHMiLAogICAgICAgICAgICAgICAgdGVzdF9zZXRfa2V5OiBzdHIgPSAidGVzdF9zZXQiLAogICAgICAgICAgICAgICAgcGxvdHNfZGVzdDogc3RyID0gInBsb3RzIiwKICAgICAgICAgICAgICAgIGRhc2tfZnVuY3Rpb246IHN0ciA9IE5vbmUsCiAgICAgICAgICAgICAgICBkYXNrX2NsaWVudD1Ob25lLAogICAgICAgICAgICAgICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IiwKICAgICAgICAgICAgICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gNDIpIC0+IE5vbmU6CiAgICAKICAgICIiIgogICAgVHJhaW4gYSBza2xlYXJuIGNsYXNzaWZpZXIgd2l0aCBEYXNrCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgICAgICAgRnVuY3Rpb24gY29udGV4dC4KICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgICAgICAgUmF3IGRhdGEgZmlsZS4KICAgIDpwYXJhbSBtb2RlbF9wa2dfY2xhc3M6ICAgICAgICAgTW9kZWwgdG8gdHJhaW4sIGUuZywgInNrbGVhcm4uZW5zZW1ibGUuUmFuZG9tRm9yZXN0Q2xhc3NpZmllciIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBqc29uIG1vZGVsIGNvbmZpZy4KICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgICAgICAgKGxhYmVsKSBHcm91bmQtdHJ1dGggeSBsYWJlbHMuCiAgICA6cGFyYW0gdHJhaW5fdmFsaWRhdGlvbl9zaXplOiAgICgwLjc1KSBUcmFpbiB2YWxpZGF0aW9uIHNldCBwcm9wb3J0aW9uIG91dCBvZiB0aGUgZnVsbCBkYXRhc2V0LgogICAgOnBhcmFtIHNhbXBsZTogICAgICAgICAgICAgICAgICAoMS4wKSBTZWxlY3Qgc2FtcGxlIGZyb20gZGF0YXNldCAobi1yb3dzLyUgb2YgdG90YWwpLCByYW5kb216aWUgcm93cyBhcyBkZWZhdWx0LgogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICAgICAgICAobW9kZWxzKSBNb2RlbHMgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGguCiAgICA6cGFyYW0gdGVzdF9zZXRfa2V5OiAgICAgICAgICAgICh0ZXN0X3NldCkgTWxydW4gZGIga2V5IG9mIGhlbGQgb3V0IGRhdGEgaW4gYXJ0aWZhY3Qgc3RvcmUuCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgICAgICAgIChwbG90cykgUGxvdCBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aC4KICAgIDpwYXJhbSBkYXNrX2Z1bmN0aW9uOiAgICAgICAgICAgZGFzayBmdW5jdGlvbiB1cmwgKGRiOi8vLi4pCiAgICA6cGFyYW0gZGFza19jbGllbnQ6ICAgICAgICAgICAgIGRhc2sgY2xpZW50IG9iamVjdAogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICAgICAgICAocGFycXVldCkgZm9ybWF0IGZvciB0ZXN0X3NldF9rZXkgaG9sZCBvdXQgZGF0YQogICAgOnBhcmFtIHJhbmRvbV9zdGF0ZTogICAgICAgICAgICAoNDIpIHNrbGVhcm4gc2VlZAogICAgIiIiCiAgICAKICAgIGlmIGRhc2tfZnVuY3Rpb246CiAgICAgICAgY2xpZW50ID0gbWxydW4uaW1wb3J0X2Z1bmN0aW9uKGRhc2tfZnVuY3Rpb24pLmNsaWVudAogICAgZWxpZiBkYXNrX2NsaWVudDoKICAgICAgICBjbGllbnQgPSBkYXNrX2NsaWVudAogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdkYXNrIGNsaWVudCB3YXMgbm90IHByb3ZpZGVkJykKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJSZWFkIERhdGEiKQogICAgZGYgPSBkYXRhc2V0LmFzX2RmKGRmX21vZHVsZT1kZCkgCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiUHJlcCBEYXRhIikKICAgIG51bWVyaWNzID0gWydpbnQxNicsICdpbnQzMicsICdpbnQ2NCcsICdmbG9hdDE2JywgJ2Zsb2F0MzInLCAnZmxvYXQ2NCddCiAgICBkZiA9IGRmLnNlbGVjdF9kdHlwZXMoaW5jbHVkZT1udW1lcmljcykKICAgIAogICAgaWYgZGYuaXNuYSgpLmFueSgpLmFueSgpLmNvbXB1dGUoKSA9PSBUcnVlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbignTkFzIHZhbHVzIGZvdW5kJykKICAgIAogICAgZGZfaGVhZGVyID0gZGYuY29sdW1ucwogICAgCiAgICBkZiA9IGRmLnNhbXBsZShmcmFjPXNhbXBsZSkucmVzZXRfaW5kZXgoZHJvcD1UcnVlKQogICAgZW5jb2RlciA9IExhYmVsRW5jb2RlcigpCiAgICBlbmNvZGVyID0gZW5jb2Rlci5maXQoZGZbbGFiZWxfY29sdW1uXSkKICAgIFggPSBkZi5kcm9wKGxhYmVsX2NvbHVtbiwgYXhpcz0xKS50b19kYXNrX2FycmF5KGxlbmd0aHM9VHJ1ZSkKICAgIHkgPSBlbmNvZGVyLnRyYW5zZm9ybShkZltsYWJlbF9jb2x1bW5dKQoKICAgIGNsYXNzZXMgPSBkZltsYWJlbF9jb2x1bW5dLmRyb3BfZHVwbGljYXRlcygpICMgbm8gdW5pcXVlIHZhbHVlcyBpbiBkYXNrCiAgICBjbGFzc2VzID0gW3N0cihpKSBmb3IgaSBpbiBjbGFzc2VzXQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIlNwbGl0IGFuZCBUcmFpbiIpCiAgICBYX3RyYWluLCBYX3Rlc3QsIHlfdHJhaW4sIHlfdGVzdCA9IG1vZGVsX3NlbGVjdGlvbi50cmFpbl90ZXN0X3NwbGl0KFgsIHksIHRyYWluX3NpemU9dHJhaW5fdmFsaWRhdGlvbl9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb21fc3RhdGU9cmFuZG9tX3N0YXRlKQogICAgCiAgICBzY2FsZXIgPSBTdGFuZGFyZFNjYWxlcigpCiAgICBzY2FsZXIgPSBzY2FsZXIuZml0KFhfdHJhaW4pCiAgICBYX3RyYWluX3RyYW5zZm9ybWVkID0gc2NhbGVyLnRyYW5zZm9ybShYX3RyYWluKQogICAgWF90ZXN0X3RyYW5zZm9ybWVkID0gc2NhbGVyLnRyYW5zZm9ybShYX3Rlc3QpCiAgICAKICAgIG1vZGVsX2NvbmZpZyA9IGdlbl9za2xlYXJuX21vZGVsKG1vZGVsX3BrZ19jbGFzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpKQoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IFhfdHJhaW5fdHJhbnNmb3JtZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInkiOiB5X3RyYWlufSkKICAgIAogICAgQ2xhc3NpZmllckNsYXNzID0gY3JlYXRlX2NsYXNzKG1vZGVsX2NvbmZpZ1siTUVUQSJdWyJjbGFzcyJdKQogICAgCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKICAgIAogICAgd2l0aCBqb2JsaWIucGFyYWxsZWxfYmFja2VuZCgiZGFzayIpOgogICAgICAgIAogICAgICAgIG1vZGVsID0gbW9kZWwuZml0KCoqbW9kZWxfY29uZmlnWyJGSVQiXSkKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJFdmFsdWF0ZSIpCiAgICBleHRyYV9kYXRhX2RpY3QgPSB7fQogICAgZm9yIHJlcG9ydCBpbiAoUk9DQVVDLCBDbGFzc2lmaWNhdGlvblJlcG9ydCwgQ29uZnVzaW9uTWF0cml4KToKICAgICAgICAKICAgICAgICByZXBvcnRfbmFtZSA9IHN0cihyZXBvcnQuX19uYW1lX18pCiAgICAgICAgcGx0LmNsYSgpCiAgICAgICAgcGx0LmNsZigpCiAgICAgICAgcGx0LmNsb3NlKCkKICAgICAgICAKICAgICAgICB2aXogPSByZXBvcnQobW9kZWwsIGNsYXNzZXM9Y2xhc3NlcywgcGVyX2NsYXNzPVRydWUsIGlzX2ZpdHRlZD1UcnVlKQogICAgICAgIHZpei5maXQoWF90cmFpbl90cmFuc2Zvcm1lZCwgeV90cmFpbikgICAgICAgICAgICAgICAjIEZpdCB0aGUgdHJhaW5pbmcgZGF0YSB0byB0aGUgdmlzdWFsaXplcgogICAgICAgIHZpei5zY29yZShYX3Rlc3RfdHJhbnNmb3JtZWQsIHlfdGVzdC5jb21wdXRlKCkpICAgICAjIEV2YWx1YXRlIHRoZSBtb2RlbCBvbiB0aGUgdGVzdCBkYXRhCiAgICAgICAgCiAgICAgICAgcGxvdCA9IGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdChyZXBvcnRfbmFtZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5PXZpei5maWcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT1yZXBvcnRfbmFtZSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGJfa2V5PUZhbHNlKQogICAgICAgIGV4dHJhX2RhdGFfZGljdFtzdHIocmVwb3J0KV0gPSBwbG90CiAgICAgICAgCiAgICAgICAgaWYgcmVwb3J0X25hbWUgPT0gJ1JPQ0FVQyc6CiAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoeyJtaWNybyI6IHZpei5yb2NfYXVjLmdldCgibWljcm8iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWFjcm8iOiB2aXoucm9jX2F1Yy5nZXQoIm1hY3JvIil9KQogICAgICAgICAgICAKICAgICAgICBlbGlmIHJlcG9ydF9uYW1lID09ICdDbGFzc2lmaWNhdGlvblJlcG9ydCc6CiAgICAgICAgICAgIGZvciBzY29yZV9uYW1lIGluIHZpei5zY29yZXNfOgogICAgICAgICAgICAgICAgZm9yIHNjb3JlX2NsYXNzIGluIHZpei5zY29yZXNfW3Njb3JlX25hbWVdOgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoe3Njb3JlX25hbWUgKyAiLSIgKyBzY29yZV9jbGFzcyA6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpei5zY29yZXNfW3Njb3JlX25hbWVdLmdldChzY29yZV9jbGFzcyl9KQogICAgICAgIAogICAgCiAgICB2aXogPSBGZWF0dXJlSW1wb3J0YW5jZXMobW9kZWwsIGNsYXNzZXM9Y2xhc3NlcywgcGVyX2NsYXNzPVRydWUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX2ZpdHRlZD1UcnVlLCBsYWJlbHM9ZGZfaGVhZGVyLmRlbGV0ZShkZl9oZWFkZXIuZ2V0X2xvYyhsYWJlbF9jb2x1bW4pKSkKICAgIHZpei5maXQoWF90cmFpbl90cmFuc2Zvcm1lZCwgeV90cmFpbikgCiAgICB2aXouc2NvcmUoWF90ZXN0X3RyYW5zZm9ybWVkLCB5X3Rlc3QpCiAgICAKICAgIHBsb3QgPSBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QoIkZlYXR1cmVJbXBvcnRhbmNlcyIsIGJvZHk9dml6LmZpZywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlPSJGZWF0dXJlSW1wb3J0YW5jZXMiKSwgZGJfa2V5PUZhbHNlKQogICAgZXh0cmFfZGF0YV9kaWN0W3N0cigiRmVhdHVyZUltcG9ydGFuY2VzIildID0gcGxvdAogICAgCiAgICBwbHQuY2xhKCkKICAgIHBsdC5jbGYoKQogICAgcGx0LmNsb3NlKCkKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJMb2cgYXJ0aWZhY3RzIikKICAgIGFydGlmYWN0X3BhdGggPSBjb250ZXh0LmFydGlmYWN0X3N1YnBhdGgobW9kZWxzX2Rlc3QpCiAgICAKICAgIGNvbnRleHQuc2V0X2xhYmVsKCdjbGFzcycsIG1vZGVsX3BrZ19jbGFzcykKICAgIAogICAgY29udGV4dC5sb2dfbW9kZWwoIm1vZGVsIiwgYm9keT1kdW1wcyhtb2RlbCksCiAgICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdF9wYXRoPWFydGlmYWN0X3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9maWxlPSJtb2RlbC5wa2wiLAogICAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YT1leHRyYV9kYXRhX2RpY3QsCiAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNzPWNvbnRleHQucmVzdWx0cywKICAgICAgICAgICAgICAgICAgICAgIGxhYmVscz17ImNsYXNzIjogbW9kZWxfcGtnX2NsYXNzfSkKICAgIAogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoInN0YW5kYXJkX3NjYWxlciIsIGJvZHk9ZHVtcHMoc2NhbGVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgIGFydGlmYWN0X3BhdGg9YXJ0aWZhY3RfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsX2ZpbGU9InNjYWxlci5neiIsCiAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD0ic3RhbmRhcmRfc2NhbGVyIikKICAgIAogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoImxhYmVsX2VuY29kZXIiLCBib2R5PWR1bXBzKGVuY29kZXIpLAogICAgICAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RfcGF0aD1hcnRpZmFjdF9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxfZmlsZT0iZW5jb2Rlci5neiIsCiAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD0ibGFiZWxfZW5jb2RlciIpCiAgICAKICAgIGRmX3RvX3NhdmUgPSBkZWxheWVkKG5wLmNvbHVtbl9zdGFjaykoKFhfdGVzdCwgeV90ZXN0KSkuY29tcHV0ZSgpCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KHRlc3Rfc2V0X2tleSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGRmPXBkLkRhdGFGcmFtZShkZl90b19zYXZlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnM9ZGZfaGVhZGVyKSwgIyBpbXByb3ZlIGxvZyBkYXRhc2V0IGFiaWxpdHkKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVscz17ImRhdGEtdHlwZSI6ICJoZWxkLW91dCJ9LAogICAgICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdF9wYXRoPWNvbnRleHQuYXJ0aWZhY3Rfc3VicGF0aCgnZGF0YScpKQogICAgCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJEb25lISIpCgo=
    commands: []
    code_origin: https://github.com/daniels290813/functions.git#55a79c32be5d233cc11efcf40cd3edbe309bfdef:/home/kali/functions/sklearn_classifier_dask/sklearn-classifier-dask.py
  affinity: null
verbose: false
