kind: job
metadata:
  name: sklearn-classifier
  tag: latest
  hash: 7c2e8c9516943c3bc2d26c6bbe46813b7eb97bf7
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f97e9342e48>
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
        doc: json model config file
      outputs: []
      lineno: 28
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTI4IDExOjU4CgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmltcG9ydCBqc29uCmltcG9ydCBvcwoKZnJvbSBjbG91ZHBpY2tsZSBpbXBvcnQgZHVtcHMsIGxvYWQKCmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0Cgpmcm9tIHNrbGVhcm4ucHJlcHJvY2Vzc2luZyBpbXBvcnQgbGFiZWxfYmluYXJpemUKZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgdHJhaW5fdGVzdF9zcGxpdApmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKCmZyb20gdHlwaW5nIGltcG9ydCBMaXN0CmZyb20gbWxydW4uZXhlY3V0aW9uIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IFBsb3RBcnRpZmFjdApmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IChnZXRfY2xhc3NfZml0LCBjcmVhdGVfY2xhc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsb3Rfcm9jLCBwbG90X2ltcG9ydGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGdjZl9jbGVhcikKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhSXRlbSwKICAgIGxhYmVsX2NvbHVtbjogc3RyID0gImxhYmVscyIsCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgdGVzdF9zaXplOiBmbG9hdCA9IDAuMDUsCiAgICB0cmFpbl92YWxfc3BsaXQ6IGZsb2F0ID0gMC43NSwKICAgIHJuZzogaW50ID0gMSwKICAgIG1vZGVsX2ZpbGVuYW1lOiBzdHIgPSAibW9kZWwiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICIiLAogICAgcGxvdHNfZGVzdDogc3RyID0gIiIsCiAgICBzY29yZV9tZXRob2Q6IHN0ciA9ICJtaWNybyIsCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLCAgICAKKSAtPiBOb25lOgogICAgIiIidHJhaW4gYSBjbGFzc2lmaWVyLgoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbF9wa2dfY2xhc3M6ICAgdGhlIG1vZGVsIHRvIHRyYWluLCBlLmcsICJza2xlYXJuLm5ldXJhbF9uZXR3b3Jrcy5NTFBDbGFzc2lmaWVyIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yIGpzb24gbW9kZWwgY29uZmlnCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICgiZGF0YSIpIG5hbWUgb2YgcmF3IGRhdGEgZmlsZQogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgICBncm91bmQtdHJ1dGggKHkpIGxhYmVscwogICAgOnBhcmFtIHNhbXBsZTogICAgICAgICAgICBTZWxlY3RzIHRoZSBmaXJzdCBuIHJvd3MsIG9yIHNlbGVjdCBhIHNhbXBsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydGluZyBmcm9tIHRoZSBmaXJzdC4gSWYgbmVnYXRpdmUgPC0xLCBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYSByYW5kb20gc2FtcGxlCiAgICA6cGFyYW0gbW9kZWxfZmlsZW5hbWU6ICAgIG1vZGVsIGZpbGUgZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cyB0byBhIGRpcmVjdG9yeQogICAgOnBhcmFtIHRlc3Rfc2l6ZTogICAgICAgICAoMC4wNSkgdGVzdCBzZXQgc2l6ZQogICAgOnBhcmFtIHRyYWluX3ZhbF9zcGxpdDogICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHJuZzogICAgICAgICAgICAgICAoMSkgc2tsZWFybiBybmcgc2VlZAogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICBtb2RlbHMgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICAgcGxvdCBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aAogICAgOnBhcmFtIHNjb3JlX21ldGhvZDogICAgICBmb3IgbXVsdGljbGFzcyBjbGFzc2lmaWNhdGlvbgogICAgCiAgICA6cGFyYW0gZmlsZV9leHQ6ICAgICAgICAgIGZvcm1hdCBmb3IgdGVzdF9zZXRfa2V5IGhvbGQgb3V0IGRhdGEKICAgIDpwYXJhbSBtb2RlbF9wa2dfZmlsZTogICAganNvbiBtb2RlbCBjb25maWcgZmlsZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICIiIgogICAgc3JjZmlsZXBhdGggPSBzdHIoZGF0YXNldCkKICAgIAogICAgbW9kZWxzX2Rlc3QgPSBtb2RlbHNfZGVzdCBvciAnbW9kZWxzJwogICAgcGxvdHNfZGVzdCA9IHBsb3RzX2Rlc3Qgb3IgZidwbG90cy97Y29udGV4dC5uYW1lfScKICAgIAogICAgaWYgc3JjZmlsZXBhdGguZW5kc3dpdGgoImNzdiIpOgogICAgICAgIHJlYWRlciA9IHBkLnJlYWRfY3N2CiAgICBlbGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCJwYXJxdWV0Iikgb3Igc3JjZmlsZXBhdGguZW5kc3dpdGgoInBxIik6CiAgICAgICAgcmVhZGVyID0gcGQucmVhZF9wYXJxdWV0CiAgICBlbHNlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmImZpbGUgdHlwZSB1bmhhbmRsZWQge3NyY2ZpbGVwYXRofSIpCgogICAgaWYgKHNhbXBsZSA9PSAtMSkgb3IgKHNhbXBsZSA+PSAxKToKICAgICAgICByYXcgPSByZWFkZXIoc3JjZmlsZXBhdGgpLmRyb3BuYSgpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCiAgICAgICAgcmF3ID0gcmF3Lmlsb2NbOnNhbXBsZSwgOl0KICAgICAgICBsYWJlbHMgPSBsYWJlbHMuaWxvY1s6c2FtcGxlXQogICAgZWxzZToKICAgICAgICByYXcgPSByZWFkZXIoc3JjZmlsZXBhdGgpLmRyb3BuYSgpLnNhbXBsZShzYW1wbGUgKiAtMSkKICAgICAgICBsYWJlbHMgPSByYXcucG9wKGxhYmVsX2NvbHVtbikKCiAgICBjb250ZXh0LmhlYWRlciA9IHJhdy5jb2x1bW5zLnZhbHVlcwogICAgCiAgICB5YiA9IGxhYmVsX2JpbmFyaXplKGxhYmVscywgY2xhc3Nlcz1sYWJlbHMudW5pcXVlKCkpCiAgICAKICAgIHgsIHh0ZXN0LCB5LCB5dGVzdCA9IHRyYWluX3Rlc3Rfc3BsaXQobnAuY29uY2F0ZW5hdGUoW3JhdywgeWJdLCBheGlzPTEpLCBsYWJlbHMsIHRlc3Rfc2l6ZT10ZXN0X3NpemUsIHJhbmRvbV9zdGF0ZT1ybmcpCiAgICB4dHJhaW4sIHh2YWxpZCwgeXRyYWluLCB5dmFsaWQgPSB0cmFpbl90ZXN0X3NwbGl0KHgsIHksIHRyYWluX3NpemU9dHJhaW5fdmFsX3NwbGl0LCByYW5kb21fc3RhdGU9cm5nKQogICAgeXRyYWluYiA9IHh0cmFpbls6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh0cmFpbiA9IHh0cmFpbls6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkKICAgIHl2YWxpZGIgPSB4dmFsaWRbOiwgLXliLnNoYXBlWzFdOl0uY29weSgpCiAgICB4dmFsaWQgPSB4dmFsaWRbOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpCiAgICB5dGVzdGIgPSB4dGVzdFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh0ZXN0ID0geHRlc3RbOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgIAogICAgdGVzdF9zZXQgPSBwZC5jb25jYXQoCiAgICAgICAgW3BkLkRhdGFGcmFtZShkYXRhPXh0ZXN0LCBjb2x1bW5zPWNvbnRleHQuaGVhZGVyKSwKICAgICAgICAgcGQuRGF0YUZyYW1lKGRhdGE9eXRlc3QudmFsdWVzLCBjb2x1bW5zPVtsYWJlbF9jb2x1bW5dKV0sCiAgICAgICAgYXhpcz0xLCkKICAgIGNvbnRleHQubG9nX2RhdGFzZXQoJ3Rlc3Rfc2V0JywgZGY9dGVzdF9zZXQsIGZvcm1hdD1maWxlX2V4dCwgaW5kZXg9RmFsc2UpCgogICAgaWYgbW9kZWxfcGtnX2ZpbGU6CiAgICAgICAgbW9kZWxfY29uZmlnID0ganNvbi5sb2FkKG9wZW4obW9kZWxfcGtnX2ZpbGUsICJyIikpCiAgICBlbGlmIG1vZGVsX3BrZ19jbGFzczoKICAgICAgICBtb2RlbF9jb25maWcgPSBnZXRfY2xhc3NfZml0KG1vZGVsX3BrZ19jbGFzcykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignbW9kZWxfcGtnX2ZpbGUgb3IgbW9kZWxfcGtnX2NsYXNzIG11c3QgYmUgcHJvdmlkZWQnKQogICAgCiAgICBmb3IgaywgdiBpbiBjb250ZXh0LnBhcmFtZXRlcnMuaXRlbXMoKToKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoJ0NMQVNTXycpOgogICAgICAgICAgICBtb2RlbF9jb25maWdbJ0NMQVNTJ11ba1s2Ol1dID0gdgogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnRklUXycpOgogICAgICAgICAgICBtb2RlbF9jb25maWdbJ0ZJVCddW2tbNDpdXSA9IHYKCiAgICBtb2RlbF9jb25maWdbIkZJVCJdLnVwZGF0ZSh7IlgiOiB4dHJhaW4sInkiOiB5dHJhaW4udmFsdWVzfSkKICAgIAogICAgQ2xhc3NpZmllckNsYXNzID0gY3JlYXRlX2NsYXNzKG1vZGVsX2NvbmZpZ1siTUVUQSJdWyJjbGFzcyJdKQogICAgbW9kZWwgPSBDbGFzc2lmaWVyQ2xhc3MoKiptb2RlbF9jb25maWdbIkNMQVNTIl0pCiAgICBtb2RlbC5maXQoKiptb2RlbF9jb25maWdbIkZJVCJdKQoKICAgIHRyeToKICAgICAgICBkYXRhID0gZHVtcHMobW9kZWwpCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoJ21vZGVsJywgYm9keT1kYXRhLCBsb2NhbF9wYXRoPWYie21vZGVsc19kZXN0fS97bW9kZWxfZmlsZW5hbWV9LnBrbCIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIlNFUklBTElaRSBNT0RFTCBFUlJPUjoiLCBzdHIoZSkpCgogICAgeXByZWQgPSBtb2RlbC5wcmVkaWN0KHh2YWxpZCkKICAgIHlfc2NvcmUgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKHh2YWxpZCkKICAgIAogICAgdHJ5OgogICAgICAgIGlmIHl2YWxpZGIuc2hhcGVbMV0gPiAxOgogICAgICAgICAgICBhdmVyYWdlX3ByZWNpc2lvbiA9IG1ldHJpY3MuYXZlcmFnZV9wcmVjaXNpb25fc2NvcmUoeXZhbGlkYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl2YWxpZGIsIHlfc2NvcmUpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dmFsaWRiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZVs6LCAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXZhbGlkYiwgeV9zY29yZVs6LCAxXSkpCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY2FsY3VsYXRpbmcgcHJlY2lzaW9uJykKICAgICAgICAKICAgIHRyeToKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhY2N1cmFjeSIsIGZsb2F0KG1vZGVsLnNjb3JlKHh2YWxpZCwgeXZhbGlkKSkpCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY2FsY3VsYXRpbmcgYWNjdXJhY3knKQogICAgdHJ5OgogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZSh5dmFsaWQsIHlwcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkpCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY2FsY3VsYXRpbmcgZjFfc2NvcmUnKQoKICAgIAogICAgcGxvdF9yb2MoY29udGV4dCwgeXZhbGlkYiwgeV9zY29yZSwga2V5PSJyb2MiLCBwbG90c19kaXI9cGxvdHNfZGVzdCkKICAgIGdjZl9jbGVhcihwbHQpCiAgICBtZXRyaWNzLnBsb3RfY29uZnVzaW9uX21hdHJpeChtb2RlbCwgeHZhbGlkLCB5dmFsaWQsIGxhYmVscz1sYWJlbHMudW5pcXVlKCksIG5vcm1hbGl6ZT0ndHJ1ZScpIAogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoUGxvdEFydGlmYWN0KCJjb25mdXNpb24iLCBib2R5PXBsdC5nY2YoKSksIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0vY29uZnVzaW9uLmh0bWwiKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#733059af34bbe63a7b2ce43ee1021289bd161565:sklearn_classifier.ipynb
