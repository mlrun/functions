kind: job
metadata:
  name: sklearn-classifier
  tag: ''
  hash: e5cf57d81eca63ae5d7bad35cd90500caeac003d
  project: ''
  labels:
    author: yjb
    stage: development
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: train_model
  entry_points:
    _gcf_clear:
      name: _gcf_clear
      doc: 'Utility to clear matplotlib figure


        Run this inside every plot method before calling any matplotlib

        methods'
      parameters:
      - name: plt
      outputs: []
      lineno: 35
    _create_class:
      name: _create_class
      doc: Create a class from a package.module.class string
      parameters:
      - name: pkg_class
        type: str
        doc: full class location, e.g. "sklearn.model_selection.GroupKFold"
      outputs: []
      lineno: 48
    _create_function:
      name: _create_function
      doc: Create a function from a package.module.function string
      parameters:
      - name: pkg_func
        type: list
        doc: full function location, e.g. "sklearn.feature_selection.f_classif"
      outputs: []
      lineno: 60
    get_model_configs:
      name: get_model_configs
      doc: "build sklearn model configuration parameters\n\nTake (full) class name\
        \ of an scikit-learn model \nand retrieve its `class` and `fit` parameters\
        \ and\ntheir default values.\n\nAlso returns some useful metadata values for\
        \ the class"
      parameters:
      - name: my_models
        type: Union[str, List[str]]
      - name: class_key
        default: CLASS
      - name: fit_key
        default: FIT
      - name: meta_key
        default: META
      outputs: []
      lineno: 73
    _get_estimator:
      name: _get_estimator
      doc: find a specific class in a list of sklearn estimators
      parameters:
      - name: pkg_class
      outputs: []
      lineno: 89
    update_model_config:
      name: update_model_config
      doc: "Update model config json\n\nNot used until we refactor as per the TODO\n\
        \    \nThis function is essential since there are modifications in class\n\
        and fit params that must be made (callbacks are a good example, without\n\
        which there is no training history available)\n\nTODO:  currently a model\
        \ config contains 2 keys, but this will likely\nexpand to include other functions\
        \ beyond class and fit. So need to expand \nthis to a list of Tuple(str, dict),\
        \ where `str` corresponds to a key\nin the model config and `dict` contains\
        \ the params and their new values."
      parameters:
      - name: config
        type: dict
        doc: original model definition containing 2 keys, CLASS and FIT
      - name: new_class
        type: dict
        doc: new class key-values
      - name: new_fit
        type: dict
        doc: new fit key-values
      - name: class_key
        type: str
        default: CLASS
      - name: fit_key
        type: str
        default: FIT
      outputs: []
      lineno: 159
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: data_key
        type: Union[DataItem, str]
        doc: ("raw") name of raw data file
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
      - name: label_column
        type: str
        doc: ground-truth (y) labels
      - name: model_key
        type: str
        doc: ("model") name of model in artifact store, points to a directory
        default: model
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: test_set_key
        type: str
        doc: store the test data set under this key in the artifact store
        default: test_set
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dir
        type: str
        doc: models subfolder on artifact path
        default: models
      - name: plots_dir
        type: str
        doc: plot subfolder on artifact path
        default: plots
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: class_params_updates
        type: Union[DataItem, dict]
      - name: fit_params_updates
        type: Union[DataItem, dict]
      outputs: []
      lineno: 188
    plot_roc:
      name: plot_roc
      doc: "plot roc curves\n\nTODO:  add averaging method (as string) that was used\
        \ to create probs, \ndisplay in legend"
      parameters:
      - name: context
        doc: the function context
      - name: y_labels
        doc: 'ground truth labels, hot encoded for multiclass  '
      - name: y_probs
        doc: model prediction probabilities
      - name: key
        doc: ("roc") key of plot in artifact store
        default: roc
      - name: plots_dir
        type: str
        doc: ("plots") destination folder relative path to artifact path
        default: plots
      - name: fmt
        doc: ("png") plot format
        default: png
      - name: x_label
        type: str
        doc: ("false positive rate") x-axis labels
        default: false positive rate
      - name: y_label
        type: str
        doc: ("true positive rate") y-axis labels
        default: true positive rate
      - name: title
        type: str
        doc: ("roc curve") title of plot
        default: roc curve
      - name: legend_loc
        type: str
        doc: ("best") location of plot legend
        default: best
      outputs: []
      lineno: 342
    plot_confusion_matrix:
      name: plot_confusion_matrix
      doc: 'Create a confusion matrix.

        Plot and save a confusion matrix using test data from a

        modelline step.


        See https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html


        TODO: fix label alignment

        TODO: consider using another packaged version

        TODO: refactor to take params dict for plot options'
      parameters:
      - name: context
        type: MLClientCtx
        doc: function context
      - name: labels
        doc: validation data ground-truth labels
      - name: predictions
        doc: validation data predictions
      - name: key
        type: str
        doc: str
        default: confusion_matrix
      - name: plots_dir
        type: str
        doc: relative path of plots in artifact store
        default: plots
      - name: colormap
        type: str
        doc: colourmap for confusion matrix
        default: Blues
      - name: fmt
        type: str
        doc: plot format
        default: png
      - name: sample_weight
        doc: sample weights
      outputs: []
      lineno: 401
  description: ''
  image_pull_policy: Always
  build:
    functionSourceCode: aW1wb3J0IGpzb24KaW1wb3J0IG9zCmZyb20gaW1wb3J0bGliIGltcG9ydCBpbXBvcnRfbW9kdWxlCmZyb20gaW5zcGVjdCBpbXBvcnQgZ2V0ZnVsbGFyZ3NwZWMsIEZ1bGxBcmdTcGVjCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXAsIGxvYWQKaW1wb3J0IGl0ZXJ0b29scwoKaW1wb3J0IHNrbGVhcm4KZnJvbSBza2xlYXJuIGltcG9ydCBtZXRyaWNzCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHB5YXJyb3cgYXMgcGEKaW1wb3J0IHB5YXJyb3cucGFycXVldCBhcyBwcQppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAppbXBvcnQgc2VhYm9ybiBhcyBzbnMKCmZyb20gc2tsZWFybi51dGlscy50ZXN0aW5nIGltcG9ydCBhbGxfZXN0aW1hdG9ycwpmcm9tIHNrbGVhcm4uZGF0YXNldHMgaW1wb3J0IG1ha2VfY2xhc3NpZmljYXRpb24KZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IGxhYmVsX2JpbmFyaXplCmZyb20gc2tsZWFybi5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IHRyYWluX3Rlc3Rfc3BsaXQKZnJvbSBza2xlYXJuIGltcG9ydCBtZXRyaWNzCgpmcm9tIHR5cGluZyBpbXBvcnQgVW5pb24sIExpc3QsIEFueSwgT3B0aW9uYWwKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0Cgpza3ZlcnNpb24gPSBza2xlYXJuLl9fdmVyc2lvbl9fCgppbXBvcnQgd2FybmluZ3MKCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgoKZGVmIF9nY2ZfY2xlYXIocGx0KToKICAgICIiIlV0aWxpdHkgdG8gY2xlYXIgbWF0cGxvdGxpYiBmaWd1cmUKCiAgICBSdW4gdGhpcyBpbnNpZGUgZXZlcnkgcGxvdCBtZXRob2QgYmVmb3JlIGNhbGxpbmcgYW55IG1hdHBsb3RsaWIKICAgIG1ldGhvZHMKCiAgICA6cGFyYW0gcGxvdDogICAgbWF0bG9ibGliIGZpZ3VyZSBvYmplY3QKICAgICIiIgogICAgcGx0LmNsYSgpCiAgICBwbHQuY2xmKCkKICAgIHBsdC5jbG9zZSgpCgoKZGVmIF9jcmVhdGVfY2xhc3MocGtnX2NsYXNzOiBzdHIpOgogICAgIiIiQ3JlYXRlIGEgY2xhc3MgZnJvbSBhIHBhY2thZ2UubW9kdWxlLmNsYXNzIHN0cmluZwoKICAgIDpwYXJhbSBwa2dfY2xhc3M6ICBmdWxsIGNsYXNzIGxvY2F0aW9uLAogICAgICAgICAgICAgICAgICAgICAgIGUuZy4gInNrbGVhcm4ubW9kZWxfc2VsZWN0aW9uLkdyb3VwS0ZvbGQiCiAgICAiIiIKICAgIHNwbGl0cyA9IHBrZ19jbGFzcy5zcGxpdCgiLiIpCiAgICBjbGZjbGFzcyA9IHNwbGl0c1stMV0KICAgIHBrZ19tb2R1bGUgPSBzcGxpdHNbOi0xXQogICAgY2xhc3NfID0gZ2V0YXR0cihpbXBvcnRfbW9kdWxlKCIuIi5qb2luKHBrZ19tb2R1bGUpKSwgY2xmY2xhc3MpCiAgICByZXR1cm4gY2xhc3NfCgpkZWYgX2NyZWF0ZV9mdW5jdGlvbihwa2dfZnVuYzogbGlzdCk6CiAgICAiIiJDcmVhdGUgYSBmdW5jdGlvbiBmcm9tIGEgcGFja2FnZS5tb2R1bGUuZnVuY3Rpb24gc3RyaW5nCgogICAgOnBhcmFtIHBrZ19mdW5jOiAgZnVsbCBmdW5jdGlvbiBsb2NhdGlvbiwKICAgICAgICAgICAgICAgICAgICAgIGUuZy4gInNrbGVhcm4uZmVhdHVyZV9zZWxlY3Rpb24uZl9jbGFzc2lmIgogICAgIiIiCiAgICBzcGxpdHMgPSBwa2dfZnVuYy5zcGxpdCgiLiIpCiAgICBwa2dfbW9kdWxlID0gIi4iLmpvaW4oc3BsaXRzWzotMV0pCiAgICBjYl9mbmFtZSA9IHNwbGl0c1stMV0KICAgIHBrZ19tb2R1bGUgPSBfX2ltcG9ydF9fKHBrZ19tb2R1bGUsIGZyb21saXN0PVtjYl9mbmFtZV0pCiAgICBmdW5jdGlvbl8gPSBnZXRhdHRyKHBrZ19tb2R1bGUsIGNiX2ZuYW1lKQogICAgcmV0dXJuIGZ1bmN0aW9uXwoKZGVmIGdldF9tb2RlbF9jb25maWdzKAogICAgbXlfbW9kZWxzOiBVbmlvbltzdHIsIExpc3Rbc3RyXV0sCiAgICBjbGFzc19rZXkgPSAiQ0xBU1MiLAogICAgZml0X2tleSA9ICJGSVQiLAogICAgbWV0YV9rZXkgPSAiTUVUQSIsCikgLT4gVW5pb25bZGljdCwgTGlzdFtkaWN0XV06CiAgICAiIiJidWlsZCBza2xlYXJuIG1vZGVsIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycwogICAgCiAgICBUYWtlIChmdWxsKSBjbGFzcyBuYW1lIG9mIGFuIHNjaWtpdC1sZWFybiBtb2RlbCAKICAgIGFuZCByZXRyaWV2ZSBpdHMgYGNsYXNzYCBhbmQgYGZpdGAgcGFyYW1ldGVycyBhbmQKICAgIHRoZWlyIGRlZmF1bHQgdmFsdWVzLgogICAgCiAgICBBbHNvIHJldHVybnMgc29tZSB1c2VmdWwgbWV0YWRhdGEgdmFsdWVzIGZvciB0aGUgY2xhc3MKICAgICIiIgogICAgIyBnZXQgYSBsaXN0IG9mIGFsbCBza2xlYXJuIGVzdGltYXRvcnMKICAgIGVzdGltYXRvcnMgPSBhbGxfZXN0aW1hdG9ycygpCiAgICBkZWYgX2dldF9lc3RpbWF0b3IocGtnX2NsYXNzKToKICAgICAgICAiIiJmaW5kIGEgc3BlY2lmaWMgY2xhc3MgaW4gYSBsaXN0IG9mIHNrbGVhcm4gZXN0aW1hdG9ycyIiIgogICAgICAgIG15X2NsYXNzID0gcGtnX2NsYXNzLnNwbGl0KCIuIilbLTFdCiAgICAgICAgcmV0dXJuIGxpc3QoZmlsdGVyKGxhbWJkYSB4OiB4WzBdID09IG15X2NsYXNzLCBlc3RpbWF0b3JzKSlbMF0KCiAgICAjIGZpbmQgZXN0aW1hdG9ycyBjb3JyZXNwb25kaW5nIHRvIG15X21vZGVscyBsaXN0CiAgICBteV9lc3RpbWF0b3JzID0gW10KICAgIG15X21vZGVscyA9IFtteV9tb2RlbHNdIGlmIGlzaW5zdGFuY2UobXlfbW9kZWxzLCBzdHIpIGVsc2UgbXlfbW9kZWxzCiAgICBmb3IgbW9kZWwgaW4gbXlfbW9kZWxzOgogICAgICAgIGVzdGltYXRvcl9uYW1lLCBlc3RpbWF0b3JfY2xhc3MgPSBfZ2V0X2VzdGltYXRvcihtb2RlbCkKICAgICAgICBteV9lc3RpbWF0b3JzLmFwcGVuZCgoZXN0aW1hdG9yX25hbWUsIGVzdGltYXRvcl9jbGFzcykpCgogICAgIyBnZXQgY2xhc3MgYW5kIGZpdCBzcGVjcwogICAgZXN0aW1hdG9yX3NwZWNzID0gW10KICAgIGZvciBhbl9lc3RpbWF0b3IgaW4gbXlfZXN0aW1hdG9yczoKICAgICAgICBlc3RpbWF0b3Jfc3BlY3MuYXBwZW5kKChhbl9lc3RpbWF0b3JbMF0sICMgbW9kZWwgb25seSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0ZnVsbGFyZ3NwZWMoYW5fZXN0aW1hdG9yWzFdKSwgIyBjbGFzcyBwYXJhbXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRmdWxsYXJnc3BlYyhhbl9lc3RpbWF0b3JbMV0uZml0KSwgIyBmaXQgcGFyYW1zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5fZXN0aW1hdG9yWzFdKSkgIyBwYWNrYWdlLm1vZHVsZS5tb2RlbAoKICAgIG1vZGVsX2NvbmZpZ3MgPSBbXQoKICAgIGZvciBlc3RpbWF0b3IgaW4gZXN0aW1hdG9yX3NwZWNzOgogICAgICAgIG1vZGVsX2pzb24gPSB7Y2xhc3Nfa2V5OiB7fSwgZml0X2tleToge319CiAgICAgICAgZml0X3BhcmFtcyA9IHt9CgogICAgICAgIGZvciBpLCBrZXkgaW4gZW51bWVyYXRlKG1vZGVsX2pzb24ua2V5cygpKToKICAgICAgICAgICAgZiA9IGVzdGltYXRvcltpKzFdCiAgICAgICAgICAgIGFyZ3NfcGFpcmVkID0gW10KICAgICAgICAgICAgZGVmc19wYWlyZWQgPSBbXQoKICAgICAgICAgICAgIyByZXZlcnNlIHRoZSBhcmdzIHNpbmNlIHRoZXJlIGFyZSBmZXdlciBkZWZhdWx0cyB0aGFuIGFyZ3MKICAgICAgICAgICAgYXJncyA9IGYuYXJncwogICAgICAgICAgICBhcmdzLnJldmVyc2UoKQogICAgICAgICAgICBuX2FyZ3MgPSBsZW4oYXJncykKCiAgICAgICAgICAgIGRlZnMgPSBmLmRlZmF1bHRzCiAgICAgICAgICAgIGlmIGRlZnMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGRlZnMgPSBbZGVmc10KICAgICAgICAgICAgZGVmcyA9IGxpc3QoZGVmcykKICAgICAgICAgICAgZGVmcy5yZXZlcnNlKCkKICAgICAgICAgICAgbl9kZWZzID0gbGVuKGRlZnMpCgogICAgICAgICAgICBuX3NtYWxsZXN0ID0gbWluKG5fYXJncywgbl9kZWZzKQogICAgICAgICAgICBuX2xhcmdlc3QgPSBtYXgobl9hcmdzLCBuX2RlZnMpCgogICAgICAgICAgICAjIGJ1aWxkIDIgbGlzdHMgdGhhdCBjYW4gYmUgY29uY2F0ZW5hdGVkCiAgICAgICAgICAgIGZvciBpeCBpbiByYW5nZShuX3NtYWxsZXN0KToKICAgICAgICAgICAgICAgIGlmIGFyZ3NbaXhdIGlzIG5vdCAic2VsZiI6CiAgICAgICAgICAgICAgICAgICAgYXJnc19wYWlyZWQuYXBwZW5kKGFyZ3NbaXhdKQogICAgICAgICAgICAgICAgICAgIGRlZnNfcGFpcmVkLmFwcGVuZChkZWZzW2l4XSkKCiAgICAgICAgICAgIGZvciBpeCBpbiByYW5nZShuX3NtYWxsZXN0LCBuX2xhcmdlc3QpOgogICAgICAgICAgICAgICAgaWYgaXggaXMgbm90IDAgYW5kIGFyZ3NbaXhdIGlzIG5vdCAic2VsZiI6CiAgICAgICAgICAgICAgICAgICAgYXJnc19wYWlyZWQuYXBwZW5kKGFyZ3NbaXhdKQogICAgICAgICAgICAgICAgICAgIGRlZnNfcGFpcmVkLmFwcGVuZChOb25lKQogICAgICAgICAgICAgICAjIGNvbmNhdGVuYXRlIGxpc3RzIGludG8gYXBwcm9wcmlhdGUgc3RydWN0dXJlCiAgICAgICAgICAgIG1vZGVsX2pzb25ba2V5XSA9IGRpY3QoemlwKHJldmVyc2VkKGFyZ3NfcGFpcmVkKSwgcmV2ZXJzZWQoZGVmc19wYWlyZWQpKSkKCiAgICAgICAgbW9kZWxfanNvblttZXRhX2tleV0gPSB7fQogICAgICAgIG1vZGVsX2pzb25bbWV0YV9rZXldWyJza2xlYXJuX3ZlcnNpb24iXSA9IHNrdmVyc2lvbgogICAgICAgIG1vZGVsX2pzb25bbWV0YV9rZXldWyJjbGFzcyJdID0gIi4iLmpvaW4oW2VzdGltYXRvclszXS5fX21vZHVsZV9fLCBlc3RpbWF0b3JbMF1dKQogICAgICAgIG1vZGVsX2NvbmZpZ3MuYXBwZW5kKG1vZGVsX2pzb24pCiAgICBpZiBsZW4obW9kZWxfY29uZmlncykgPT0gMToKICAgICAgICAjIGRvIHdlIHdhbnQgdG8gbG9nIHRoaXMgbW9kaWZpZWQgbW9kZWwgYXMgYW4gYXJ0aWZhY3Q/CiAgICAgICAgcmV0dXJuIG1vZGVsX2NvbmZpZ3NbMF0KICAgIGVsc2U6CiAgICAgICAgIyBkbyB3ZSB3YW50IHRvIGxvZyB0aGlzIG1vZGlmaWVkIG1vZGVsIGFzIGFuIGFydGlmYWN0PwogICAgICAgIHJldHVybiBtb2RlbF9jb25maWdzCgpkZWYgdXBkYXRlX21vZGVsX2NvbmZpZygKICAgIGNvbmZpZzogZGljdCwKICAgIG5ld19jbGFzczogZGljdCwKICAgIG5ld19maXQ6IGRpY3QsCiAgICBjbGFzc19rZXk6IHN0ciA9ICJDTEFTUyIsCiAgICBmaXRfa2V5OiBzdHIgPSAiRklUIgopOgogICAgIiIiVXBkYXRlIG1vZGVsIGNvbmZpZyBqc29uCiAgICAKICAgIE5vdCB1c2VkIHVudGlsIHdlIHJlZmFjdG9yIGFzIHBlciB0aGUgVE9ETwogICAgICAgIAogICAgVGhpcyBmdW5jdGlvbiBpcyBlc3NlbnRpYWwgc2luY2UgdGhlcmUgYXJlIG1vZGlmaWNhdGlvbnMgaW4gY2xhc3MKICAgIGFuZCBmaXQgcGFyYW1zIHRoYXQgbXVzdCBiZSBtYWRlIChjYWxsYmFja3MgYXJlIGEgZ29vZCBleGFtcGxlLCB3aXRob3V0CiAgICB3aGljaCB0aGVyZSBpcyBubyB0cmFpbmluZyBoaXN0b3J5IGF2YWlsYWJsZSkKICAgIAogICAgVE9ETzogIGN1cnJlbnRseSBhIG1vZGVsIGNvbmZpZyBjb250YWlucyAyIGtleXMsIGJ1dCB0aGlzIHdpbGwgbGlrZWx5CiAgICBleHBhbmQgdG8gaW5jbHVkZSBvdGhlciBmdW5jdGlvbnMgYmV5b25kIGNsYXNzIGFuZCBmaXQuIFNvIG5lZWQgdG8gZXhwYW5kIAogICAgdGhpcyB0byBhIGxpc3Qgb2YgVHVwbGUoc3RyLCBkaWN0KSwgd2hlcmUgYHN0cmAgY29ycmVzcG9uZHMgdG8gYSBrZXkKICAgIGluIHRoZSBtb2RlbCBjb25maWcgYW5kIGBkaWN0YCBjb250YWlucyB0aGUgcGFyYW1zIGFuZCB0aGVpciBuZXcgdmFsdWVzLgogICAgCiAgICA6cGFyYW0gY29uZmlnOiAgICAgIG9yaWdpbmFsIG1vZGVsIGRlZmluaXRpb24gY29udGFpbmluZyAyIGtleXMsIENMQVNTIGFuZCBGSVQKICAgIDpwYXJhbSBuZXdfY2xhc3M6ICAgbmV3IGNsYXNzIGtleS12YWx1ZXMKICAgIDpwYXJhbSBuZXdfZml0OiAgICAgbmV3IGZpdCBrZXktdmFsdWVzCiAgICAiIiIKICAgIGNvbmZpZ1tjbGFzc19rZXldLnVwZGF0ZShuZXdfY2xhc3MpCiAgICBjb25maWdbZml0X2tleV0udXBkYXRlKG5ld19maXQpCiAgICAKICAgIHJldHVybiBjb25maWcKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIsCiAgICBkYXRhX2tleTogVW5pb25bRGF0YUl0ZW0sIHN0cl0sCiAgICBzYW1wbGU6IGludCwKICAgIGxhYmVsX2NvbHVtbjogc3RyLAogICAgbW9kZWxfa2V5OiBzdHIgPSAibW9kZWwiLAogICAgdGVzdF9zaXplOiBmbG9hdCA9IDAuMDUsCiAgICB0cmFpbl92YWxfc3BsaXQ6IGZsb2F0ID0gMC43NSwKICAgIHRlc3Rfc2V0X2tleTogc3RyID0gInRlc3Rfc2V0IiwKICAgIHJuZzogaW50ID0gMSwKICAgIG1vZGVsc19kaXI6IHN0ciA9ICJtb2RlbHMiLAogICAgcGxvdHNfZGlyOiBzdHIgPSAicGxvdHMiLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAibWljcm8iLAogICAgY2xhc3NfcGFyYW1zX3VwZGF0ZXM6IFVuaW9uW0RhdGFJdGVtLCBkaWN0XSA9IHt9LAogICAgZml0X3BhcmFtc191cGRhdGVzOiBVbmlvbltEYXRhSXRlbSwgZGljdF0gPSB7fSwKKSAtPiBOb25lOgogICAgIiIidHJhaW4gYSBjbGFzc2lmaWVyLgoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbF9wa2dfY2xhc3M6ICAgdGhlIG1vZGVsIHRvIHRyYWluLCBlLmcsICJza2xlYXJuLm5ldXJhbF9uZXR3b3Jrcy5NTFBDbGFzc2lmaWVyIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yIGpzb24gbW9kZWwgY29uZmlnCiAgICA6cGFyYW0gZGF0YV9rZXk6ICAgICAgICAgICgicmF3IikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBtb2RlbF9rZXk6ICAgICAgICAgKCJtb2RlbCIpIG5hbWUgb2YgbW9kZWwgaW4gYXJ0aWZhY3Qgc3RvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cyB0byBhIGRpcmVjdG9yeQogICAgOnBhcmFtIHRlc3Rfc2l6ZTogICAgICAgICAoMC4wNSkgdGVzdCBzZXQgc2l6ZQogICAgOnBhcmFtIHRyYWluX3ZhbF9zcGxpdDogICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHRlc3Rfc2V0X2tleTogICAgICBzdG9yZSB0aGUgdGVzdCBkYXRhIHNldCB1bmRlciB0aGlzIGtleSBpbiB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBybmc6ICAgICAgICAgICAgICAgKDEpIHNrbGVhcm4gcm5nIHNlZWQKICAgIDpwYXJhbSBtb2RlbHNfZGlyOiAgICAgICAgbW9kZWxzIHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gcGxvdHNfZGlyOiAgICAgICAgIHBsb3Qgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgICAgZm9yIG11bHRpY2xhc3MgY2xhc3NpZmljYXRpb24KICAgIDpwYXJhbSBjbGFzc191cGRhdGVzOiAgICAgdXBkYXRlIHRoZXNlIHNjaWtpdC1sZWFybiBjbGFzc2lmaWVyIHBhcmFtcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQgYXMgYSBkaWN0CiAgICA6cGFyYW0gZml0X3VwZGF0ZXM6ICAgICAgIHVwZGF0ZSBzY2lraXQtbGVhcm4gZml0IHBhcmFtZXRlcnMsIGlucHV0IGFzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEgZGljdC4KICAgICIiIgogICAgYmFzZV9wYXRoID0gY29udGV4dC5hcnRpZmFjdF9wYXRoCiAgICBvcy5tYWtlZGlycyhiYXNlX3BhdGgsIGV4aXN0X29rPVRydWUpCiAgICBvcy5tYWtlZGlycyhvcy5wYXRoLmpvaW4oYmFzZV9wYXRoLCBwbG90c19kaXIpLCBleGlzdF9vaz1UcnVlKQogICAgb3MubWFrZWRpcnMob3MucGF0aC5qb2luKGJhc2VfcGF0aCwgbW9kZWxzX2RpciksIGV4aXN0X29rPVRydWUpCiAgICAKICAgICMgZXh0cmFjdCBmaWxlIG5hbWUgZnJvbSBEYXRhSXRlbQogICAgc3JjZmlsZXBhdGggPSBzdHIoZGF0YV9rZXkpCiAgICAKICAgICMgVE9ETzogdGhpcyBzaG91bGQgYmUgcGFydCBvZiBkYXRhInMgbWV0YWRhdGEgZGVhbHQgd2l0aCBpbiBhbm90aGVyIHN0ZXAgZ2V0IGEgZGF0YSBzZXQsIHNhbXBsZSwgZXRjLi4uCiAgICAjIGdldCBhbGwgZGF0YSBvciBhIHNhbXBsZQogICAgaWYgKHNhbXBsZSA9PSAtMSkgb3IgKHNhbXBsZSA+PSAxKToKICAgICAgICAjIGdldCBhbGwgcm93cywgb3IgY29udGlndW91cyBzYW1wbGUgc3RhcnRpbmcgYXQgcm93IDEuCiAgICAgICAgcmF3ID0gcHEucmVhZF90YWJsZShzcmNmaWxlcGF0aCkudG9fcGFuZGFzKCkuZHJvcG5hKCkKICAgICAgICBsYWJlbHMgPSByYXcucG9wKGxhYmVsX2NvbHVtbikKICAgICAgICByYXcgPSByYXcuaWxvY1s6c2FtcGxlLCA6XQogICAgICAgIGxhYmVscyA9IGxhYmVscy5pbG9jWzpzYW1wbGVdCiAgICBlbHNlOgogICAgICAgICMgZ3JhYiBhIHJhbmRvbSBzYW1wbGUKICAgICAgICByYXcgPSBwcS5yZWFkX3RhYmxlKHNyY2ZpbGVwYXRoKS50b19wYW5kYXMoKS5kcm9wbmEoKS5zYW1wbGUoc2FtcGxlICogLTEpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCgogICAgIyBUT0RPOiB0aGlzIHNob3VsZCBiZSBwYXJ0IG9mIGRhdGEicyBtZXRhZGF0YSBkZWFsdCB3aXRoIGluIGFub3RoZXIgc3RlcAogICAgY29udGV4dC5oZWFkZXIgPSByYXcuY29sdW1ucy52YWx1ZXMKICAgIAogICAgIyBUT0RPOiBhbGwgb2YgdGhpcyBzaG91bGQgYmUgcGFydCBvZiBhIHNwaXR0ZXIgY29tcG9uZW50IHRoYXQgZG9lcyBjdiB0b28sIGRlYWx0IHdpdGggaW4gYW5vdGhlciBzdGVwCiAgICAjIG1ha2UgYSBob3QgZW5jb2RlIGNvcHkgb2YgbGFiZWxzIGJlZm9yZSB0aGUgc3BsaXQKICAgIHliID0gbGFiZWxfYmluYXJpemUobGFiZWxzLCBjbGFzc2VzPWxhYmVscy51bmlxdWUoKSkgIyBpZiBiaW5hcnkgMC8xIGxhYmVscywgd2lsbCByZXR1cm4gbGFiZWxzIGFzIGlzCiAgICAKICAgICMgZG91YmxlIHNwbGl0IHRvIGdlbmVyYXRlIDMgZGF0YSBzZXRzOiB0cmFpbiwgdmFsaWRhdGlvbiBhbmQgdGVzdAogICAgIyB3aXRoIHh0ZXN0LHl0ZXN0IHNldCBhc2lkZQogICAgIyBoZXJlIHdlIGhpZGUgdGhlIGJpbmFyeSBlbmNvZGVkIGxhYmVscyBpbnNpZGUgdGhlIFggbWF0cml4IHNvIHRoYXQgd2hlbiBzcGxpdHRpbmcgd2UgcHJlc2VydmUgb3JkZXIgaW4gYm90aCB0aGUgZW5jb2RlZAogICAgIyBhbmQgbm9uLWVuY29kZWQgbGFiZWxzOgogICAgeCwgeHRlc3QsIHksIHl0ZXN0ID0gdHJhaW5fdGVzdF9zcGxpdChucC5jb25jYXRlbmF0ZShbcmF3LCB5Yl0sIGF4aXM9MSksIGxhYmVscywgdGVzdF9zaXplPXRlc3Rfc2l6ZSwgcmFuZG9tX3N0YXRlPXJuZykKICAgIHh0cmFpbiwgeHZhbGlkLCB5dHJhaW4sIHl2YWxpZCA9IHRyYWluX3Rlc3Rfc3BsaXQoeCwgeSwgdHJhaW5fc2l6ZT10cmFpbl92YWxfc3BsaXQsIHJhbmRvbV9zdGF0ZT1ybmcpCiAgICAjIG5vdyBleHRyYWN0IHRoZSBob3RfZW5jb2RlZCBsYWJlbHMKICAgIHl0cmFpbmIgPSB4dHJhaW5bOiwgLXliLnNoYXBlWzFdOl0uY29weSgpCiAgICB4dHJhaW4gPSB4dHJhaW5bOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpCiAgICAjIGV4dHJhY3QgdGhlIGhvdF9lbmNvZGVkIGxhYmVscwogICAgeXZhbGlkYiA9IHh2YWxpZFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh2YWxpZCA9IHh2YWxpZFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkKICAgICMgZXh0cmFjdCB0aGUgaG90X2VuY29kZWQgbGFiZWxzCiAgICB5dGVzdGIgPSB4dGVzdFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh0ZXN0ID0geHRlc3RbOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgIAogICAgIyBzZXQtYXNpZGUgdGVzdF9zZXQKICAgIHRlc3Rfc2V0ID0gcGQuY29uY2F0KAogICAgICAgIFtwZC5EYXRhRnJhbWUoZGF0YT14dGVzdCwgY29sdW1ucz1jb250ZXh0LmhlYWRlciksCiAgICAgICAgIHBkLkRhdGFGcmFtZShkYXRhPXl0ZXN0LnZhbHVlcywgY29sdW1ucz1bbGFiZWxfY29sdW1uXSldLAogICAgICAgIGF4aXM9MSwpCiAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihiYXNlX3BhdGgsIHRlc3Rfc2V0X2tleSArICIucGFycXVldCIpCiAgICB0ZXN0X3NldC50b19wYXJxdWV0KGZpbGVwYXRoLCBpbmRleD1GYWxzZSkKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KHRlc3Rfc2V0X2tleSwgbG9jYWxfcGF0aD10ZXN0X3NldF9rZXkgKyAiLnBhcnF1ZXQiKQoKICAgIGlmIG1vZGVsX3BrZ19jbGFzcy5lbmRzd2l0aCgiLmpzb24iKToKICAgICAgICBtb2RlbF9jb25maWcgPSBqc29uLmxvYWQob3Blbihtb2RlbF9wa2dfY2xhc3MsICJyIikpCiAgICBlbHNlOgogICAgICAgICMgbG9hZCB0aGUgbW9kZWwgY29uZmlnCiAgICAgICAgbW9kZWxfY29uZmlnID0gZ2V0X21vZGVsX2NvbmZpZ3MobW9kZWxfcGtnX2NsYXNzKQoKICAgICMgZ2V0IHVwZGF0ZSBwYXJhbXMgaWYgYW55CiAgICBpZiBpc2luc3RhbmNlKGNsYXNzX3BhcmFtc191cGRhdGVzLCBEYXRhSXRlbSk6CiAgICAgICAgY2xhc3NfcGFyYW1zX3VwZGF0ZXMgPSBqc29uLmxvYWRzKGNsYXNzX3BhcmFtc191cGRhdGVzLmdldCgpKQogICAgaWYgaXNpbnN0YW5jZShmaXRfcGFyYW1zX3VwZGF0ZXMsIERhdGFJdGVtKToKICAgICAgICBmaXRfcGFyYW1zX3VwZGF0ZXMgPSBqc29uLmxvYWRzKGZpdF9wYXJhbXNfdXBkYXRlcy5nZXQoKSkKICAgICMgdXBkYXRlIHRoZSBwYXJhbWV0ZXJzICAgICAgICAgICAgCiAgICAjIGFkZCBkYXRhIHRvIGZpdCBwYXJhbXMKICAgIGZpdF9wYXJhbXNfdXBkYXRlcy51cGRhdGUoeyJYIjogeHRyYWluLCJ5IjogeXRyYWluLnZhbHVlc30pCiAgICAKICAgIG1vZGVsX2NvbmZpZ1siQ0xBU1MiXS51cGRhdGUoY2xhc3NfcGFyYW1zX3VwZGF0ZXMpCiAgICBtb2RlbF9jb25maWdbIkZJVCJdLnVwZGF0ZShmaXRfcGFyYW1zX3VwZGF0ZXMpCiAgICAKICAgICMgY3JlYXRlIGNsYXNzIGFuZCBmaXQKICAgIENsYXNzaWZpZXJDbGFzcyA9IF9jcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKICAgIG1vZGVsLmZpdCgqKm1vZGVsX2NvbmZpZ1siRklUIl0pCgogICAgIyBzYXZlIG1vZGVsCiAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihiYXNlX3BhdGgsIGYie21vZGVsc19kaXJ9L3ttb2RlbF9rZXl9LnBrbCIpCiAgICB0cnk6CiAgICAgICAgZHVtcChtb2RlbCwgb3BlbihmaWxlcGF0aCwgIndiIikpCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QobW9kZWxfa2V5LCBsb2NhbF9wYXRoPW1vZGVsc19kaXIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIlNFUklBTElaRSBNT0RFTCBFUlJPUjoiLCBzdHIoZSkpCgogICAgIyBjb21wdXRlIHZhbGlkYXRpb24gbWV0cmljcwogICAgeXByZWQgPSBtb2RlbC5wcmVkaWN0KHh2YWxpZCkKICAgIHlfc2NvcmUgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKHh2YWxpZCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5X3Njb3JlLnNoYXBlIHt5X3Njb3JlLnNoYXBlfSIpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieXZhbGlkYi5zaGFwZSB7eXZhbGlkYi5zaGFwZX0iKQogICAgaWYgeXZhbGlkYi5zaGFwZVsxXSA+IDE6CiAgICAgICAgIyBsYWJlbCBlbmNvZGluZyB3YXMgYXBwbGllZDoKICAgICAgICBhdmVyYWdlX3ByZWNpc2lvbiA9IG1ldHJpY3MuYXZlcmFnZV9wcmVjaXNpb25fc2NvcmUoeXZhbGlkYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl2YWxpZGIsIHlfc2NvcmUpKQogICAgZWxzZToKICAgICAgICBhdmVyYWdlX3ByZWNpc2lvbiA9IG1ldHJpY3MuYXZlcmFnZV9wcmVjaXNpb25fc2NvcmUoeXZhbGlkYiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZVs6LCAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl2YWxpZGIsIHlfc2NvcmVbOiwgMV0pKQogICAgICAgIAogICAgY29udGV4dC5sb2dfcmVzdWx0KGYiYXZnX3ByZWNzY29yZSIsIGF2ZXJhZ2VfcHJlY2lzaW9uKQogICAgY29udGV4dC5sb2dfcmVzdWx0KGYiYWNjdXJhY3kiLCBmbG9hdChtb2RlbC5zY29yZSh4dmFsaWQsIHl2YWxpZCkpKQogICAgY29udGV4dC5sb2dfcmVzdWx0KGYiZjFfc2NvcmUiLCBtZXRyaWNzLmYxX3Njb3JlKHl2YWxpZCwgeXByZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKCiAgICAjIFRPRE86IG1pc3NpbmcgdmFsaWRhdGlvbiBwbG90cywgY2FsbGJhY2tzIG5lZWQgdG8gcmVpbnRyb2R1Y2VkCiAgICAKICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl2YWxpZGIsIHlfc2NvcmUpCiAgICBwbG90X2NvbmZ1c2lvbl9tYXRyaXgoY29udGV4dCwgeXZhbGlkLCB5cHJlZCwga2V5PSJjb25mdXNpb24iLCBmbXQ9InBuZyIpCgpkZWYgcGxvdF9yb2MoCiAgICBjb250ZXh0LAogICAgeV9sYWJlbHMsCiAgICB5X3Byb2JzLAogICAga2V5PSJyb2MiLAogICAgcGxvdHNfZGlyOiBzdHIgPSAicGxvdHMiLAogICAgZm10PSJwbmciLAogICAgeF9sYWJlbDogc3RyID0gImZhbHNlIHBvc2l0aXZlIHJhdGUiLAogICAgeV9sYWJlbDogc3RyID0gICJ0cnVlIHBvc2l0aXZlIHJhdGUiLAogICAgdGl0bGU6IHN0ciA9ICJyb2MgY3VydmUiLAogICAgbGVnZW5kX2xvYzogc3RyID0gImJlc3QiCik6CiAgICAiIiJwbG90IHJvYyBjdXJ2ZXMKICAgIAogICAgVE9ETzogIGFkZCBhdmVyYWdpbmcgbWV0aG9kIChhcyBzdHJpbmcpIHRoYXQgd2FzIHVzZWQgdG8gY3JlYXRlIHByb2JzLCAKICAgIGRpc3BsYXkgaW4gbGVnZW5kCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0geV9sYWJlbHM6ICAgICBncm91bmQgdHJ1dGggbGFiZWxzLCBob3QgZW5jb2RlZCBmb3IgbXVsdGljbGFzcyAgCiAgICA6cGFyYW0geV9wcm9iczogICAgICBtb2RlbCBwcmVkaWN0aW9uIHByb2JhYmlsaXRpZXMKICAgIDpwYXJhbSBrZXk6ICAgICAgICAgICgicm9jIikga2V5IG9mIHBsb3QgaW4gYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBwbG90c19kaXI6ICAgICgicGxvdHMiKSBkZXN0aW5hdGlvbiBmb2xkZXIgcmVsYXRpdmUgcGF0aCB0byBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gZm10OiAgICAgICAgICAoInBuZyIpIHBsb3QgZm9ybWF0CiAgICA6cGFyYW0geF9sYWJlbDogICAgICAoImZhbHNlIHBvc2l0aXZlIHJhdGUiKSB4LWF4aXMgbGFiZWxzCiAgICA6cGFyYW0geV9sYWJlbDogICAgICAoInRydWUgcG9zaXRpdmUgcmF0ZSIpIHktYXhpcyBsYWJlbHMKICAgIDpwYXJhbSB0aXRsZTogICAgICAgICgicm9jIGN1cnZlIikgdGl0bGUgb2YgcGxvdAogICAgOnBhcmFtIGxlZ2VuZF9sb2M6ICAgKCJiZXN0IikgbG9jYXRpb24gb2YgcGxvdCBsZWdlbmQKICAgICIiIgogICAgIyBjbGVhciBtYXRwbG90bGliIGN1cnJlbnQgZmlndXJlCiAgICBfZ2NmX2NsZWFyKHBsdCkKICAgIAogICAgIyBkcmF3IDQ1IGRlZ3JlZSBsaW5lCiAgICBwbHQucGxvdChbMCwgMV0sIFswLCAxXSwgImstLSIpCiAgICAKICAgICMgbGFiZWxsaW5nCiAgICBwbHQueGxhYmVsKHhfbGFiZWwpCiAgICBwbHQueWxhYmVsKHlfbGFiZWwpCiAgICBwbHQudGl0bGUodGl0bGUpCiAgICBwbHQubGVnZW5kKGxvYz1sZWdlbmRfbG9jKQogICAgCiAgICAjIHNpbmdsZSBST0Mgb3IgbXV0bGlwbGUKICAgIGlmIHlfbGFiZWxzLnNoYXBlWzFdID4gMToKICAgICAgICAjIGRhdGEgYWNjdW1tdWxhdG9ycyBieSBjbGFzcwogICAgICAgIGZwciA9IGRpY3QoKQogICAgICAgIHRwciA9IGRpY3QoKQogICAgICAgIHJvY19hdWMgPSBkaWN0KCkKICAgICAgICBmb3IgaSBpbiByYW5nZSh5X2xhYmVsc1s6LDotMV0uc2hhcGVbMV0pOgogICAgICAgICAgICBmcHJbaV0sIHRwcltpXSwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzWzosIGldLCB5X3Byb2JzWzosIGldLCBwb3NfbGFiZWw9MSkKICAgICAgICAgICAgcm9jX2F1Y1tpXSA9IG1ldHJpY3MuYXVjKGZwcltpXSwgdHByW2ldKQogICAgICAgICAgICBwbHQucGxvdChmcHJbaV0sIHRwcltpXSwgbGFiZWw9ZiJjbGFzcyB7aX0iKQogICAgZWxzZToKICAgICAgICBmcHIsIHRwciwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzLCB5X3Byb2JzWzosIDFdLCBwb3NfbGFiZWw9MSkKICAgICAgICBwbHQucGxvdChmcHIsIHRwciwgbGFiZWw9ZiJwb3NpdGl2ZSBjbGFzcyIpCiAgICAgICAgCiAgICBmbmFtZSA9IGYie3Bsb3RzX2Rpcn0ve2tleX0ue2ZtdH0iCiAgICBwbHQuc2F2ZWZpZyhvcy5wYXRoLmpvaW4oY29udGV4dC5hcnRpZmFjdF9wYXRoLCBmbmFtZSkpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3Qoa2V5LCBib2R5PXBsdC5nY2YoKSksIGxvY2FsX3BhdGg9Zm5hbWUpCiAgICAKCmRlZiBwbG90X2NvbmZ1c2lvbl9tYXRyaXgoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGxhYmVscywKICAgIHByZWRpY3Rpb25zLAogICAga2V5OiBzdHIgPSAiY29uZnVzaW9uX21hdHJpeCIsCiAgICBwbG90c19kaXI6IHN0ciA9ICJwbG90cyIsCiAgICBjb2xvcm1hcDogc3RyID0gIkJsdWVzIiwKICAgIGZtdDogc3RyID0gInBuZyIsCiAgICBzYW1wbGVfd2VpZ2h0PU5vbmUKKToKICAgICIiIkNyZWF0ZSBhIGNvbmZ1c2lvbiBtYXRyaXguCiAgICBQbG90IGFuZCBzYXZlIGEgY29uZnVzaW9uIG1hdHJpeCB1c2luZyB0ZXN0IGRhdGEgZnJvbSBhCiAgICBtb2RlbGxpbmUgc3RlcC4KICAgIAogICAgU2VlIGh0dHBzOi8vc2Npa2l0LWxlYXJuLm9yZy9zdGFibGUvbW9kdWxlcy9nZW5lcmF0ZWQvc2tsZWFybi5tZXRyaWNzLmNvbmZ1c2lvbl9tYXRyaXguaHRtbAogICAgCiAgICBUT0RPOiBmaXggbGFiZWwgYWxpZ25tZW50CiAgICBUT0RPOiBjb25zaWRlciB1c2luZyBhbm90aGVyIHBhY2thZ2VkIHZlcnNpb24KICAgIFRPRE86IHJlZmFjdG9yIHRvIHRha2UgcGFyYW1zIGRpY3QgZm9yIHBsb3Qgb3B0aW9ucwoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBsYWJlbHM6ICAgICAgICAgIHZhbGlkYXRpb24gZGF0YSBncm91bmQtdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gcHJlZGljdGlvbnM6ICAgICB2YWxpZGF0aW9uIGRhdGEgcHJlZGljdGlvbnMKICAgIDpwYXJhbSBrZXk6ICAgICAgICAgICAgIHN0cgogICAgOnBhcmFtIHBsb3RzX2RpcjogICAgICAgcmVsYXRpdmUgcGF0aCBvZiBwbG90cyBpbiBhcnRpZmFjdCBzdG9yZQogICAgOnBhcmFtIGNvbG9ybWFwOiAgICAgICAgY29sb3VybWFwIGZvciBjb25mdXNpb24gbWF0cml4CiAgICA6cGFyYW0gZm10OiAgICAgICAgICAgICBwbG90IGZvcm1hdAogICAgOnBhcmFtIHNhbXBsZV93ZWlnaHQ6ICAgc2FtcGxlIHdlaWdodHMKICAgICIiIgogICAgX2djZl9jbGVhcihwbHQpCiAgICAKICAgIGNtID0gbWV0cmljcy5jb25mdXNpb25fbWF0cml4KGxhYmVscywgcHJlZGljdGlvbnMsIHNhbXBsZV93ZWlnaHQ9Tm9uZSkKICAgIHNucy5oZWF0bWFwKGNtLCBhbm5vdD1UcnVlLCBjbWFwPWNvbG9ybWFwLCBzcXVhcmU9VHJ1ZSkKCiAgICBmaWcgPSBwbHQuZ2NmKCkKICAgIGZuYW1lID0gZiJ7cGxvdHNfZGlyfS97a2V5fS57Zm10fSIKICAgIGZpZy5zYXZlZmlnKG9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIGZuYW1lKSkKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdChrZXksIGJvZHk9ZmlnKSwgbG9jYWxfcGF0aD1mbmFtZSkK
    commands: []
    code_origin: /User/functions/sklearn_classifier/function.yaml
