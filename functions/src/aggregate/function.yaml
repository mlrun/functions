metadata:
  tag: ''
  name: aggregate
  categories:
  - data-preparation
verbose: false
kind: job
spec:
  image: mlrun/mlrun
  disable_auto_mount: false
  build:
    origin_filename: ''
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKIyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCgppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQoKCmRlZiBhZ2dyZWdhdGUoCiAgICBjb250ZXh0LAogICAgZGZfYXJ0aWZhY3Q6IERhdGFJdGVtIHwgcGQuY29yZS5mcmFtZS5EYXRhRnJhbWUsCiAgICBzYXZlX3RvOiBzdHIgPSAiYWdncmVnYXRlZC1kZi5wcSIsCiAgICBrZXlzOiBsaXN0ID0gTm9uZSwKICAgIG1ldHJpY3M6IGxpc3QgPSBOb25lLAogICAgbGFiZWxzOiBsaXN0ID0gTm9uZSwKICAgIG1ldHJpY19hZ2dyZWdhdGlvbnM6IGxpc3QgPSBbIm1lYW4iXSwKICAgIGxhYmVsX2FnZ3JlZ2F0aW9uczogbGlzdCA9IFsibWF4Il0sCiAgICBzdWZmaXg6IHN0ciA9ICIiLAogICAgd2luZG93OiBpbnQgPSAzLAogICAgY2VudGVyOiBib29sID0gRmFsc2UsCiAgICBpbnBsYWNlOiBib29sID0gRmFsc2UsCiAgICBkcm9wX25hOiBib29sID0gVHJ1ZSwKICAgIGZpbGVzX3RvX3NlbGVjdDogaW50ID0gMSwKKToKICAgICIiIlRpbWUtc2VyaWVzIGFnZ3JlZ2F0aW9uIGZ1bmN0aW9uCgogICAgV2lsbCBwZXJmb3JtIGEgcm9sbGluZyBhZ2dyZWdhdGlvbiBvbiB7ZGZfYXJ0aWZhY3R9LCBvdmVyIHt3aW5kb3d9IGJ5IHRoZSBzZWxlY3RlZCB7a2V5c30KICAgIGFwcGx5aW5nIHttZXRyaWNfYWdncmVnYXRpb25zfSBvbiB7bWV0cmljc30gYW5kIHtsYWJlbF9hZ2dyZWdhdGlvbnN9IG9uIHtsYWJlbHN9LiBhZGRpbmcge3N1ZmZpeH0gdG8gdGhlCiAgICBmZWF0dXJlIG5hbWVzLgoKICAgIGlmIG5vdCB7aW5wbGFjZX0sIHdpbGwgcmV0dXJuIHRoZSBvcmlnaW5hbCB7ZGZfYXJ0aWZhY3R9LCBqb2luZWQgYnkgdGhlIGFnZ3JlZ2F0ZWQgcmVzdWx0LgoKICAgIDpwYXJhbSBjb250ZXh0OiBBZnRlciBydW5uaW5nIGEgam9iLCB5b3UgbmVlZCB0byBiZSBhYmxlIHRvIHRyYWNrIGl0LiBUbyBnYWluIHRoZSBtYXhpbXVtIHZhbHVlLCBNTFJ1biB1c2VzIHRoZQogICAgICAgICAgICAgICAgICAgIGpvYiBjb250ZXh0IG9iamVjdCBpbnNpZGUgdGhlIGNvZGUuIFRoaXMgcHJvdmlkZXMgYWNjZXNzIHRvIGpvYiBtZXRhZGF0YSwgcGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICBpbnB1dHMsIHNlY3JldHMsIGFuZCBBUEkgZm9yIGxvZ2dpbmcgYW5kIG1vbml0b3JpbmcgdGhlIHJlc3VsdHMsIGFzIHdlbGwgYXMgbG9nIHRleHQsIGZpbGVzLAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0cywgYW5kIGxhYmVscy4KCiAgICA6cGFyYW0gZGZfYXJ0aWZhY3Q6IE1MUnVuIGlucHV0IHBvaW50aW5nIHRvIHBhbmRhcyBkYXRhZnJhbWUgKGNzdi9wYXJxdWV0IGZpbGUgcGF0aCkgb3IgYQogICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3RvcnkgY29udGFpbmluZyBwYXJxdWV0IGZpbGVzLgogICAgICAgICAgICAgICAgICAgICAgICAqIFdoZW4gZ2l2ZW4gYSBkaXJlY3RvcnkgdGhlIGxhdGVzdCB7ZmlsZXNfdG9fc2VsZWN0fSB3aWxsIGJlIHNlbGVjdGVkCiAgICA6cGFyYW0gc2F2ZV90bzogICAgIFdoZXJlIHRvIHNhdmUgdGhlIHJlc3VsdCBkYXRhZnJhbWUuCiAgICAgICAgICAgICAgICAgICAgICAgICogSWYgcmVsYXRpdmUgd2lsbCBhZGQgdG8gdGhlIHthcnRpZmFjdF9wYXRofQogICAgOnBhcmFtIGtleXM6ICAgICAgICBTdWJzZXQgb2YgaW5kZXhlcyBmcm9tIHRoZSBzb3VyY2UgZGF0YWZyYW1lIHRvIGFnZ3JlZ2F0ZSBieSAoZGVmYXVsdD1hbGwpCiAgICA6cGFyYW0gbWV0cmljczogICAgIEFycmF5IGNvbnRhaW5pbmcgYSBsaXN0IG9mIG1ldHJpY3MgdG8gcnVuIHRoZSBhZ2dyZWdhdGlvbnMgb24uIChkZWZhdWx0PU5vbmUpCiAgICA6cGFyYW0gbGFiZWxzOiAgICAgIEFycmF5IGNvbnRhaW5pbmcgYSBsaXN0IG9mIGxhYmVscyB0byBydW4gdGhlIGFnZ3JlZ2F0aW9ucyBvbi4gKGRlZmF1bHQ9Tm9uZSkKICAgIDpwYXJhbSBtZXRyaWNfYWdncmVnYXRpb25zOiBBcnJheSBjb250YWluaW5nIGEgbGlzdCBvZiBhZ2dyZWdhdGlvbiBmdW5jdGlvbiBuYW1lcyB0byBydW4gb24ge21ldHJpY3N9LgogICAgICAgICAgICAgICAgICAgICAgICAoRXg6ICdtZWFuJywgJ3N0ZCcpIChkZWZhdWx0PSdtZWFuJykKICAgIDpwYXJhbSBsYWJlbF9hZ2dyZWdhdGlvbnM6ICBBcnJheSBjb250YWluaW5nIGEgbGlzdCBvZiBhZ2dyZWdhdGlvbiBmdW5jdGlvbiBuYW1lcyB0byBydW4gb24ge21ldHJpY3N9LgogICAgICAgICAgICAgICAgICAgICAgICAoRXg6ICdtYXgnLCAnbWluJykgKGRlZmF1bHQ9J21heCcpCiAgICA6cGFyYW0gc3VmZml4OiAgICAgIFN1ZmZpeCB0byBhZGQgdG8gdGhlIGZlYXR1cmUgbmFtZSwgRS5nOiA8RmVhdHVyZV9OYW1lPl88QWdnX0Z1bmN0aW9uPl88U3VmZml4PgogICAgICAgICAgICAgICAgICAgICAgICAoRXg6ICdsYXN0XzYwX21pbnV0ZXMnKSAoZGVmYXVsdD0nJykKICAgIDpwYXJhbSB3aW5kb3c6ICAgICAgV2luZG93IHNpemUgdG8gcGVyZm9ybSB0aGUgcm9sbGluZyBhZ2dyZWdhdGUgb24uIChkZWZhdWx0PTMpCiAgICA6cGFyYW0gY2VudGVyOiAgICAgIElmIFRydWUsIFNldHMgdGhlIHZhbHVlIGZvciB0aGUgY2VudHJhbCBzYW1wbGUgaW4gdGhlIHdpbmRvdywKICAgICAgICAgICAgICAgICAgICAgICAgSWYgRmFsc2UsIHdpbGwgc2V0IHRoZSB2YWx1ZSB0byB0aGUgbGFzdCBzYW1wbGUuIChkZWZhdWx0PUZhbHNlKQogICAgOnBhcmFtIGlucGxhY2U6ICAgICBJZiBUcnVlLCB3aWxsIHJldHVybiBvbmx5IHRoZSBhZ2dyZWdhdGVkIHJlc3VsdHMuCiAgICAgICAgICAgICAgICAgICAgICAgIElmIEZhbHNlLCB3aWxsIGpvaW4gdGhlIGFnZ3JlZ2F0ZWQgcmVzdWx0cyB3aXRoIHRoZSBvcmlnaW5hbCBkYXRhZnJhbWUKICAgIDpwYXJhbSBkcm9wX25hOiAgICAgV2lsbCBkcm9wIG5hIGxpbmVzIGR1ZSB0byB0aGUgUm9sbGluZy4KICAgIDpwYXJhbSBmaWxlc190b19zZWxlY3Q6IFNwZWNpZmllcyB0aGUgbnVtYmVyIG9mICpsYXRlc3QqIGZpbGVzIHRvIHNlbGVjdCAoYW5kIGNvbmNhdCkgZm9yIGFnZ3JlZ2F0aW9uLgogICAgIiIiCgogICAgZnJvbV9tb2RlbCA9IHR5cGUoZGZfYXJ0aWZhY3QpID09IHBkLkRhdGFGcmFtZQogICAgaWYgZnJvbV9tb2RlbDoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJBZ2dyZWdhdGluZyBmcm9tIEJ1ZmZlciIpCiAgICAgICAgaW5wdXRfZGYgPSBkZl9hcnRpZmFjdAogICAgZWxzZToKICAgICAgICBpZiBkZl9hcnRpZmFjdC51cmwuZW5kc3dpdGgoIi8iKTogICMgaXMgYSBkaXJlY3Rvcnk/CiAgICAgICAgICAgIG1wYXRoID0gWwogICAgICAgICAgICAgICAgb3MucGF0aC5qb2luKGRmX2FydGlmYWN0LnVybCwgZmlsZSkKICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGRmX2FydGlmYWN0Lmxpc3RkaXIoKQogICAgICAgICAgICAgICAgaWYgZmlsZS5lbmRzd2l0aCgoInBhcnF1ZXQiLCAicHEiKSkKICAgICAgICAgICAgXQogICAgICAgICAgICBmaWxlc19ieV91cGRhdGVkID0gc29ydGVkKG1wYXRoLCBrZXk9b3MucGF0aC5nZXRtdGltZSwgcmV2ZXJzZT1UcnVlKQogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGZpbGVzX2J5X3VwZGF0ZWQpCiAgICAgICAgICAgIGxhdGVzdCA9IGZpbGVzX2J5X3VwZGF0ZWRbOmZpbGVzX3RvX3NlbGVjdF0KICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkFnZ3JlZ2F0aW5nIHtsYXRlc3R9IikKICAgICAgICAgICAgaW5wdXRfZGYgPSBwZC5jb25jYXQoW2NvbnRleHQuZ2V0X2RhdGFpdGVtKGRmKS5hc19kZigpIGZvciBkZiBpbiBsYXRlc3RdKQogICAgICAgIGVsc2U6ICAjIEEgcmVndWxhciBhcnRpZmFjdAogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiQWdncmVnYXRpbmcge2RmX2FydGlmYWN0LnVybH0iKQogICAgICAgICAgICBpbnB1dF9kZiA9IGRmX2FydGlmYWN0LmFzX2RmKCkKCiAgICBpZiBub3QgKG1ldHJpY3Mgb3IgbGFiZWxzKToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJwbGVhc2Ugc3BlY2lmeSBtZXRyaWNzIG9yIGxhYmVscyBwYXJhbSIpCgogICAgaWYga2V5czoKICAgICAgICBjdXJyZW50X2luZGV4ID0gaW5wdXRfZGYuaW5kZXgubmFtZXMKICAgICAgICBpbmRleGVzX3RvX2Ryb3AgPSBbY29sIGZvciBjb2wgaW4gaW5wdXRfZGYuaW5kZXgubmFtZXMgaWYgY29sIG5vdCBpbiBrZXlzXQogICAgICAgIGRmID0gaW5wdXRfZGYucmVzZXRfaW5kZXgobGV2ZWw9aW5kZXhlc190b19kcm9wKQogICAgZWxzZToKICAgICAgICBkZiA9IGlucHV0X2RmCgogICAgaWYgbWV0cmljczoKICAgICAgICBtZXRyaWNzX2RmID0gKAogICAgICAgICAgICBkZi5sb2NbOiwgbWV0cmljc10KICAgICAgICAgICAgLnJvbGxpbmcod2luZG93PXdpbmRvdywgY2VudGVyPWNlbnRlcikKICAgICAgICAgICAgLmFnZ3JlZ2F0ZShtZXRyaWNfYWdncmVnYXRpb25zKQogICAgICAgICkKICAgICAgICBtZXRyaWNzX2RmLmNvbHVtbnMgPSBbCiAgICAgICAgICAgICJfIi5qb2luKGNvbCkuc3RyaXAoKSBmb3IgY29sIGluIG1ldHJpY3NfZGYuY29sdW1ucy52YWx1ZXMKICAgICAgICBdCgogICAgICAgIGlmIHN1ZmZpeDoKICAgICAgICAgICAgbWV0cmljc19kZi5jb2x1bW5zID0gW2Yie21ldHJpY31fe3N1ZmZpeH0iIGZvciBtZXRyaWMgaW4gbWV0cmljc19kZi5jb2x1bW5zXQoKICAgICAgICBpZiBub3QgaW5wbGFjZToKICAgICAgICAgICAgZmluYWxfZGYgPSBwZC5tZXJnZSgKICAgICAgICAgICAgICAgIGlucHV0X2RmLAogICAgICAgICAgICAgICAgbWV0cmljc19kZiwKICAgICAgICAgICAgICAgIHN1ZmZpeGVzPSgiIiwgc3VmZml4KSwKICAgICAgICAgICAgICAgIGxlZnRfaW5kZXg9VHJ1ZSwKICAgICAgICAgICAgICAgIHJpZ2h0X2luZGV4PVRydWUsCiAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICBmaW5hbF9kZiA9IG1ldHJpY3NfZGYKCiAgICBpZiBsYWJlbHM6CiAgICAgICAgbGFiZWxzX2RmID0gKAogICAgICAgICAgICBkZi5sb2NbOiwgbGFiZWxzXQogICAgICAgICAgICAucm9sbGluZyh3aW5kb3c9d2luZG93LCBjZW50ZXI9Y2VudGVyKQogICAgICAgICAgICAuYWdncmVnYXRlKGxhYmVsX2FnZ3JlZ2F0aW9ucykKICAgICAgICApCiAgICAgICAgbGFiZWxzX2RmLmNvbHVtbnMgPSBbIl8iLmpvaW4oY29sKS5zdHJpcCgpIGZvciBjb2wgaW4gbGFiZWxzX2RmLmNvbHVtbnMudmFsdWVzXQoKICAgICAgICBpZiBzdWZmaXg6CiAgICAgICAgICAgIGxhYmVsc19kZi5jb2x1bW5zID0gW2Yie2xhYmVsfV97c3VmZml4fSIgZm9yIGxhYmVsIGluIGxhYmVsc19kZi5jb2x1bW5zXQoKICAgICAgICBpZiBtZXRyaWNzOgogICAgICAgICAgICBmaW5hbF9kZiA9IHBkLm1lcmdlKAogICAgICAgICAgICAgICAgZmluYWxfZGYsCiAgICAgICAgICAgICAgICBsYWJlbHNfZGYsCiAgICAgICAgICAgICAgICBzdWZmaXhlcz0oIiIsIHN1ZmZpeCksCiAgICAgICAgICAgICAgICBsZWZ0X2luZGV4PVRydWUsCiAgICAgICAgICAgICAgICByaWdodF9pbmRleD1UcnVlLAogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgbm90IGlucGxhY2U6CiAgICAgICAgICAgICAgICBmaW5hbF9kZiA9IHBkLm1lcmdlKAogICAgICAgICAgICAgICAgICAgIGlucHV0X2RmLAogICAgICAgICAgICAgICAgICAgIGxhYmVsc19kZiwKICAgICAgICAgICAgICAgICAgICBzdWZmaXhlcz0oIiIsIHN1ZmZpeCksCiAgICAgICAgICAgICAgICAgICAgbGVmdF9pbmRleD1UcnVlLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0X2luZGV4PVRydWUsCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBmaW5hbF9kZiA9IGxhYmVsc19kZgoKICAgIGlmIGRyb3BfbmE6CiAgICAgICAgZmluYWxfZGYgPSBmaW5hbF9kZi5kcm9wbmEoKQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkxvZ2dpbmcgYXJ0aWZhY3QiKQogICAgaWYgbm90IGZyb21fbW9kZWw6CiAgICAgICAgY29udGV4dC5sb2dfZGF0YXNldCgKICAgICAgICAgICAga2V5PSJhZ2dyZWdhdGUiLCBkZj1maW5hbF9kZiwgZm9ybWF0PSJwYXJxdWV0IiwgbG9jYWxfcGF0aD1zYXZlX3RvCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZmluYWxfZGYK
    code_origin: ''
  filename: aggregate.py
  entry_points:
    aggregate:
      parameters:
      - name: context
        doc: After running a job, you need to be able to track it. To gain the maximum
          value, MLRun uses the job context object inside the code. This provides
          access to job metadata, parameters, inputs, secrets, and API for logging
          and monitoring the results, as well as log text, files, artifacts, and labels.
      - name: df_artifact
        doc: MLRun input pointing to pandas dataframe (csv/parquet file path) or a
          directory containing parquet files. * When given a directory the latest
          {files_to_select} will be selected
      - name: save_to
        type: str
        doc: Where to save the result dataframe. * If relative will add to the {artifact_path}
        default: aggregated-df.pq
      - name: keys
        type: list
        doc: Subset of indexes from the source dataframe to aggregate by (default=all)
        default: null
      - name: metrics
        type: list
        doc: Array containing a list of metrics to run the aggregations on. (default=None)
        default: null
      - name: labels
        type: list
        doc: Array containing a list of labels to run the aggregations on. (default=None)
        default: null
      - name: metric_aggregations
        type: list
        doc: 'Array containing a list of aggregation function names to run on {metrics}.
          (Ex: ''mean'', ''std'') (default=''mean'')'
        default:
        - mean
      - name: label_aggregations
        type: list
        doc: 'Array containing a list of aggregation function names to run on {metrics}.
          (Ex: ''max'', ''min'') (default=''max'')'
        default:
        - max
      - name: suffix
        type: str
        doc: 'Suffix to add to the feature name, E.g: <Feature_Name>_<Agg_Function>_<Suffix>
          (Ex: ''last_60_minutes'') (default='''')'
        default: ''
      - name: window
        type: int
        doc: Window size to perform the rolling aggregate on. (default=3)
        default: 3
      - name: center
        type: bool
        doc: If True, Sets the value for the central sample in the window, If False,
          will set the value to the last sample. (default=False)
        default: false
      - name: inplace
        type: bool
        doc: If True, will return only the aggregated results. If False, will join
          the aggregated results with the original dataframe
        default: false
      - name: drop_na
        type: bool
        doc: Will drop na lines due to the Rolling.
        default: true
      - name: files_to_select
        type: int
        doc: Specifies the number of *latest* files to select (and concat) for aggregation.
        default: 1
      name: aggregate
      doc: 'Time-series aggregation function


        Will perform a rolling aggregation on {df_artifact}, over {window} by the
        selected {keys}

        applying {metric_aggregations} on {metrics} and {label_aggregations} on {labels}.
        adding {suffix} to the

        feature names.


        if not {inplace}, will return the original {df_artifact}, joined by the aggregated
        result.'
      has_kwargs: false
      has_varargs: false
      lineno: 23
  command: ''
  description: Rolling aggregation over Metrics and Lables according to specifications
  default_handler: aggregate
