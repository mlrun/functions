kind: job
metadata:
  name: transcribe
  tag: ''
  hash: 1b909c770d84cd55b315d276f9b1380d96c51445
  project: ''
  labels:
    author: yonatans
  categories:
  - data-preparation
  - machine-learning
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IG9zCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IENvdW50ZXIKaW1wb3J0IHBhdGhsaWIKaW1wb3J0IHRlbXBmaWxlCmZyb20gdHlwaW5nIGltcG9ydCBMaXRlcmFsLCBUdXBsZSwgTGlzdAoKaW1wb3J0IGxpYnJvc2EKaW1wb3J0IG1scnVuCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHdoaXNwZXIKZnJvbSB0cWRtLmF1dG8gaW1wb3J0IHRxZG0KCmZyb20gcHlhbm5vdGUuY29yZSBpbXBvcnQgU2VnbWVudCwgQW5ub3RhdGlvbgppbXBvcnQgcHlkdWIKCgpkZWYgdHJhbnNjcmliZSgKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgaW5wdXRfcGF0aDogc3RyLAogICAgbW9kZWxfbmFtZTogc3RyID0gImJhc2UiLAogICAgZGV2aWNlOiBMaXRlcmFsWyJjdWRhIiwgImNwdSJdID0gTm9uZSwKICAgIGRlY29kaW5nX29wdGlvbnM6IGRpY3QgPSBOb25lLAogICAgb3V0cHV0X2RpcmVjdG9yeTogc3RyID0gTm9uZSwKICAgIHVybF9wYXRoOiBzdHIgPSBOb25lLCAgIyBwYXRoIHRvIHRoZSBkYXRhZnJhbWUgdGhhdCBjb250YWlucyB0aGUgcmVzdWx0IG9mIHRoZSBzcGVha2VyIGRpYXJpemF0aW9uCikgLT4gVHVwbGVbcGF0aGxpYi5QYXRoLCBwZC5EYXRhRnJhbWUsIGRpY3QsIGxpc3RdOgogICAgIiIiCiAgICBUcmFuc2NyaWJlIGF1ZGlvIGZpbGVzIGludG8gdGV4dCBmaWxlcyBhbmQgY29sbGVjdCBhZGRpdGlvbmFsIGRhdGEuCiAgICBUaGUgZW5kIHJlc3VsdCBpcyBhIGRpcmVjdG9yeSBvZiB0cmFuc2NyaWJlZCB0ZXh0IGZpbGVzCiAgICAgYW5kIGEgZGF0YWZyYW1lIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBjb2x1bW5zOgoKICAgICogYXVkaW9fZmlsZSAtIFRoZSBvcmlnaW5hbCBhdWRpbyBmaWxlIG5hbWUuCiAgICAqIHRyYW5zY3JpcHRpb25fZmlsZSAtIFRoZSB0cmFuc2NyaWJlZCB0ZXh0IGZpbGUgbmFtZSBpbiB0aGUgb3V0cHV0IGRpcmVjdG9yeS4KICAgICogbGFuZ3VhZ2UgLSBUaGUgZGV0ZWN0ZWQgbGFuZ3VhZ2UgaW4gdGhlIGF1ZGlvIGZpbGUuCiAgICAqIGxlbmd0aCAtIFRoZSBsZW5ndGggb2YgdGhlIGF1ZGlvIGZpbGUuCiAgICAqIHJhdGVfb2Zfc3BlZWNoIC0gVGhlIG51bWJlciBvZiB3b3JkcyBkaXZpZGVkIGJ5IHRoZSBhdWRpbyBmaWxlIGxlbmd0aC4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgICBNTFJ1biBjb250ZXh0LgogICAgOnBhcmFtIGlucHV0X3BhdGg6ICAgICAgICAgICAgQSBkaXJlY3Rvcnkgb2YgdGhlIGF1ZGlvIGZpbGVzIG9yIGEgc2luZ2xlIGZpbGUgdG8gdHJhbnNjcmliZS4KICAgIDpwYXJhbSBvdXRwdXRfZGlyZWN0b3J5OiAgICAgIFBhdGggdG8gYSBkaXJlY3RvcnkgdG8gc2F2ZSBhbGwgdHJhbnNjcmliZWQgYXVkaW8gZmlsZXMuCiAgICA6cGFyYW0gbW9kZWxfbmFtZTogICAgICAgICAgICBPbmUgb2YgdGhlIG9mZmljaWFsIG1vZGVsIG5hbWVzIGxpc3RlZCBieSBgd2hpc3Blci5hdmFpbGFibGVfbW9kZWxzKClgLgogICAgOnBhcmFtIGRldmljZTogICAgICAgICAgICAgICAgRGV2aWNlIHRvIGxvYWQgdGhlIG1vZGVsLiBDYW4gYmUgb25lIG9mIHsiY3VkYSIsICJjcHUifS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgd2lsbCBwcmVmZXIgImN1ZGEiIGlmIGF2YWlsYWJsZS4KICAgIDpwYXJhbSBkZWNvZGluZ19vcHRpb25zOiAgICAgIEEgZGljdGlvbmFyeSBvZiBvcHRpb25zIHRvIGNvbnN0cnVjdCBhIGB3aGlzcGVyLkRlY29kaW5nT3B0aW9uc2AuCiAgICA6cGFyYW0gdXJsX3BhdGg6ICAgICAgICAgICAgICBQYXRoIHRvIHRoZSBkYXRhZnJhbWUgdGhhdCBjb250YWlucyB0aGUgcmVzdWx0IG9mIHRoZSBzcGVha2VyIGRpYXJpemF0aW9uLgoKCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKCiAgICAgICAgICAgICAgKiBQYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5LgogICAgICAgICAgICAgICogQSBkYXRhZnJhbWUgZGF0YXNldCBvZiB0aGUgdHJhbnNjcmliZWQgZmlsZSBuYW1lcy4KICAgICAgICAgICAgICAqIEEgZGljdGlvbmFyeSBvZiBlcnJvcmVkIGZpbGVzIHRoYXQgd2VyZSBub3QgdHJhbnNjcmliZWQuCiAgICAiIiIKICAgICMgU2V0IG91dHB1dCBkaXJlY3Rvcnk6CiAgICBpZiBvdXRwdXRfZGlyZWN0b3J5IGlzIE5vbmU6CiAgICAgICAgb3V0cHV0X2RpcmVjdG9yeSA9IHRlbXBmaWxlLm1rZHRlbXAoKQoKICAgICMgTG9hZCB0aGUgbW9kZWw6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9hZGluZyB3aGlzcGVyIG1vZGVsOiAne21vZGVsX25hbWV9JyIpCiAgICBtb2RlbCA9IHdoaXNwZXIubG9hZF9tb2RlbChtb2RlbF9uYW1lLCBkZXZpY2U9ZGV2aWNlKQogICAgY29udGV4dC5sb2dnZXIuaW5mbygiTW9kZWwgbG9hZGVkLiIpCgogICAgIyBQcmVwYXJlIHRoZSBkYXRhZnJhbWUgYW5kIGVycm9ycyB0byBiZSByZXR1cm5lZDoKICAgIGRmID0gcGQuRGF0YUZyYW1lKAogICAgICAgIGNvbHVtbnM9WwogICAgICAgICAgICAiYXVkaW9fZmlsZSIsCiAgICAgICAgICAgICJ0cmFuc2NyaXB0aW9uX2ZpbGUiLAogICAgICAgICAgICAibGFuZ3VhZ2UiLAogICAgICAgICAgICAibGVuZ3RoIiwKICAgICAgICAgICAgInJhdGVfb2Zfc3BlZWNoIiwKICAgICAgICBdCiAgICApCgogICAgZXJyb3JzID0ge30KCiAgICAjIENyZWF0ZSB0aGUgb3V0cHV0IGRpcmVjdG9yeToKICAgIG91dHB1dF9kaXJlY3RvcnkgPSBwYXRobGliLlBhdGgob3V0cHV0X2RpcmVjdG9yeSkKICAgIGlmIG5vdCBvdXRwdXRfZGlyZWN0b3J5LmV4aXN0cygpOgogICAgICAgIG91dHB1dF9kaXJlY3RvcnkubWtkaXIoKQoKICAgICMgR28gb3ZlciB0aGUgYXVkaW8gZmlsZXMgYW5kIHRyYW5zY3JpYmU6CiAgICBhdWRpb19maWxlc19wYXRoID0gcGF0aGxpYi5QYXRoKGlucHV0X3BhdGgpLmFic29sdXRlKCkKICAgIGlzX2RpciA9IFRydWUKICAgIGlmIGF1ZGlvX2ZpbGVzX3BhdGguaXNfZGlyKCk6CiAgICAgICAgYXVkaW9fZmlsZXMgPSBsaXN0KGF1ZGlvX2ZpbGVzX3BhdGgucmdsb2IoIiouKiIpKQogICAgZWxpZiBhdWRpb19maWxlc19wYXRoLmlzX2ZpbGUoKToKICAgICAgICBpc19kaXIgPSBGYWxzZQogICAgICAgIGF1ZGlvX2ZpbGVzID0gW2F1ZGlvX2ZpbGVzX3BhdGhdCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiYXVkaW9fZmlsZXMge3N0cihhdWRpb19maWxlc19wYXRoKX0gbXVzdCBiZSBlaXRoZXIgYSBkaXJlY3RvcnkgcGF0aCBvciBhIGZpbGUgcGF0aCIKICAgICAgICApCiAgICAjIGNoZWNrIGlmIHRoZSB1c2VyIHdhbnRzIHRvIGFkZCB0aGUgc3BlYWtlciBkaWFyaXphdGlvbiByZXN1bHQgdG8gdGhlIHRyYW5zY3JpcHRpb24KICAgIGlmIHVybF9wYXRoIGlzIG5vdCBOb25lOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGlhcml6YXRpb25fcmVzID0gbWxydW4uZ2V0X2RhdGFpdGVtKHVybF9wYXRoKS5hc19kZigpCiAgICAgICAgICAgIGRpYXJpemF0aW9uX3JlcyA9IGRpYXJpemF0aW9uX3Jlcy5zZXRfaW5kZXgoImF1ZGlvX2ZpbGUiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgICAgIGYiQ291bGQgbm90IGxvYWQgc3BlYWtlciBkaWFyaXphdGlvbiByZXN1bHQgZnJvbSB7dXJsX3BhdGh9LCB7ZX0iCiAgICAgICAgICAgICkKCiAgICBmb3IgaSwgYXVkaW9fZmlsZSBpbiBlbnVtZXJhdGUodHFkbShhdWRpb19maWxlcywgZGVzYz0iVHJhbnNjcmliaW5nIiwgdW5pdD0iZmlsZSIpKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgR2V0IHRoZSByZXN1bHRzIG9mIHNwZWFrZXIgZGlhcml6YXRpb24KICAgICAgICAgICAgaWYgdXJsX3BhdGggaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkaXJlY3RvcnkgPSBwYXRobGliLlBhdGgodXJsX3BhdGgpLnBhcmVudAogICAgICAgICAgICAgICAgXywgY29udmVydGVkX3dhdiwgc3BlYWtlcl9zZWdtZW50cyA9IGRpYXJpemF0aW9uX3Jlcy5sb2NbCiAgICAgICAgICAgICAgICAgICAgc3RyKGF1ZGlvX2ZpbGUpCiAgICAgICAgICAgICAgICBdLnRvX2xpc3QoKQogICAgICAgICAgICAgICAgcmVzID0gbWxydW4uZ2V0X2RhdGFpdGVtKAogICAgICAgICAgICAgICAgICAgIHN0cihkaXJlY3RvcnkgLyBmIntzcGVha2VyX3NlZ21lbnRzfS5jc3YiKQogICAgICAgICAgICAgICAgKS5hc19kZigpCiAgICAgICAgICAgICAgICBhbm5vdGF0aW9uID0gQW5ub3RhdGlvbigpCiAgICAgICAgICAgICAgICBmb3IgaSwgcm93IGluIHJlcy5pdGVycm93cygpOgogICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25bU2VnbWVudChyb3dbInN0YXJ0Il0sIHJvd1siZW5kIl0pXSA9IHJvd1sic3BlYWtlciJdCgogICAgICAgICAgICAgICAgc2VnbWVudHMgPSBfc3BsaXRfYXVkaW8oY29udmVydGVkX3dhdiwgYW5ub3RhdGlvbikKCiAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgdHJhbnNjcmlwdGlvbiwKICAgICAgICAgICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgcmF0ZV9vZl9zcGVlY2gsCiAgICAgICAgICAgICAgICAgICAgbGFuZ3VhZ2UsCiAgICAgICAgICAgICAgICAgICAgc2luZ2xlX2RmLAogICAgICAgICAgICAgICAgKSA9IF9zaW5nbGVfdHJhbnNjcmliZSgKICAgICAgICAgICAgICAgICAgICBhdWRpb19maWxlPWNvbnZlcnRlZF93YXYsCiAgICAgICAgICAgICAgICAgICAgc2VnbWVudHM9c2VnbWVudHMsCiAgICAgICAgICAgICAgICAgICAgbW9kZWw9bW9kZWwsCiAgICAgICAgICAgICAgICAgICAgZGVjb2Rpbmdfb3B0aW9ucz1kZWNvZGluZ19vcHRpb25zLAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dfZGF0YXNldCgKICAgICAgICAgICAgICAgICAgICBmIntzcGVha2VyX3NlZ21lbnRzfSIsIGRmPXNpbmdsZV9kZiwgaW5kZXg9RmFsc2UsIGZvcm1hdD0iY3N2IgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdHJhbnNjcmlwdGlvbiwgbGVuZ3RoLCByYXRlX29mX3NwZWVjaCwgbGFuZ3VhZ2UgPSBfc2luZ2xlX3RyYW5zY3JpYmUoCiAgICAgICAgICAgICAgICAgICAgYXVkaW9fZmlsZT1hdWRpb19maWxlLAogICAgICAgICAgICAgICAgICAgIG1vZGVsPW1vZGVsLAogICAgICAgICAgICAgICAgICAgIGRlY29kaW5nX29wdGlvbnM9ZGVjb2Rpbmdfb3B0aW9ucywKICAgICAgICAgICAgICAgICkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGNlcHRpb246CiAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgZXhjZXB0aW9uOgogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci53YXJuKGYiRXJyb3IgaW4gZmlsZTogJ3thdWRpb19maWxlfSciKQogICAgICAgICAgICBlcnJvcnNbc3RyKGF1ZGlvX2ZpbGUpXSA9IHN0cihleGNlcHRpb24pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBXcml0ZSB0aGUgdHJhbnNjcmlwdGlvbiB0byBmaWxlOgogICAgICAgICAgICBzYXZlZF9maWxlbmFtZSA9ICgKICAgICAgICAgICAgICAgIHN0cihhdWRpb19maWxlLnJlbGF0aXZlX3RvKGF1ZGlvX2ZpbGVzX3BhdGgpKS5zcGxpdCgiLiIpWzBdCiAgICAgICAgICAgICAgICBpZiBpc19kaXIKICAgICAgICAgICAgICAgIGVsc2UgYXVkaW9fZmlsZS5zdGVtCiAgICAgICAgICAgICkKICAgICAgICAgICAgdHJhbnNjcmlwdGlvbl9maWxlID0gb3V0cHV0X2RpcmVjdG9yeSAvIGYie3NhdmVkX2ZpbGVuYW1lfS50eHQiCiAgICAgICAgICAgIHRyYW5zY3JpcHRpb25fZmlsZS5wYXJlbnQubWtkaXIoZXhpc3Rfb2s9VHJ1ZSwgcGFyZW50cz1UcnVlKQogICAgICAgICAgICB3aXRoIG9wZW4odHJhbnNjcmlwdGlvbl9maWxlLCAidyIpIGFzIGZwOgogICAgICAgICAgICAgICAgZnAud3JpdGUodHJhbnNjcmlwdGlvbikKCiAgICAgICAgICAgICMgTm90ZSBpbiB0aGUgZGF0YWZyYW1lOgogICAgICAgICAgICBkZi5sb2NbaSAtIGxlbihlcnJvcnMpXSA9IFsKICAgICAgICAgICAgICAgIHN0cihhdWRpb19maWxlLnJlbGF0aXZlX3RvKGF1ZGlvX2ZpbGVzX3BhdGgpKSwKICAgICAgICAgICAgICAgIHN0cih0cmFuc2NyaXB0aW9uX2ZpbGUucmVsYXRpdmVfdG8ob3V0cHV0X2RpcmVjdG9yeSkpLAogICAgICAgICAgICAgICAgbGFuZ3VhZ2UsCiAgICAgICAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICAgICAgICByYXRlX29mX3NwZWVjaCwKICAgICAgICAgICAgXQoKICAgICMgUmV0dXJuIHRoZSBkYXRhZnJhbWU6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiRG9uZTpcbntkZi5oZWFkKCl9IikKCiAgICByZXR1cm4gb3V0cHV0X2RpcmVjdG9yeSwgZGYsIGVycm9ycwoKCmRlZiBfc2luZ2xlX3RyYW5zY3JpYmUoCiAgICBhdWRpb19maWxlOiBwYXRobGliLlBhdGgsCiAgICBtb2RlbDogd2hpc3Blci5XaGlzcGVyLAogICAgZGVjb2Rpbmdfb3B0aW9uczogZGljdCA9IE5vbmUsCiAgICBzZWdtZW50czogVHVwbGVbaW50LCBzdHIsIGZsb2F0LCBmbG9hdCwgc3RyXSA9IE5vbmUsCikgLT4gVHVwbGVbc3RyLCBpbnQsIGZsb2F0LCBzdHJdOgogICAgIiIiCiAgICBUcmFuc2NyaWJlIGEgc2luZ2xlIGF1ZGlvIGZpbGUgd2l0aCB0aGUgc3BlYWtlciBzZWdtZW50YXRpb24KICAgIGFuZCByZXR1cm4gdGhlIHRyYW5zY3JpcHRpb24sIGxlbmd0aCwgcmF0ZSBvZiBzcGVlY2ggYW5kIGxhbmd1YWdlLgoKICAgIDpwYXJhbSBhdWRpb19maWxlOiAgICAgICBQYXRoIHRvIHRoZSBhdWRpbyBmaWxlLgogICAgOnBhcmFtIHNlZ21lbnRzOiAgICAgICAgIEEgbGlzdCBvZiB0dXBsZXMgb2YgKGlkeCwgbGFiZWwsIHN0YXJ0X3RpbWUsIGVuZF90aW1lLCBmaWxlKS4KICAgIDpwYXJhbSBtb2RlbDogICAgICAgICAgICBBIHdoaXNwZXIgbW9kZWwuCiAgICA6cGFyYW0gZGVjb2Rpbmdfb3B0aW9uczogQSBkaWN0aW9uYXJ5IG9mIG9wdGlvbnMgdG8gY29uc3RydWN0IGEgYHdoaXNwZXIuRGVjb2RpbmdPcHRpb25zYC4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKICAgICAgICAgICAgKiBUaGUgdHJhbnNjcmlwdGlvbi4KICAgICAgICAgICAgKiBUaGUgbGVuZ3RoIG9mIHRoZSBhdWRpbyBmaWxlLgogICAgICAgICAgICAqIFRoZSByYXRlIG9mIHNwZWVjaC4KICAgICAgICAgICAgKiBUaGUgZGV0ZWN0ZWQgbGFuZ3VhZ2UuCiAgICAgICAgICAgICogRGF0YWZyYW1lIG9mIHRoZSBzcGVha2VyIHNlZ21lbnRhdGlvbiBhbmQgdGhlIHRyYW5zY3JpcHRpb24uCiAgICAiIiIKICAgIGRlY29kaW5nX29wdGlvbnMgPSBkZWNvZGluZ19vcHRpb25zIG9yIGRpY3QoKQoKICAgICMgaWYgZG9uJ3QgaGF2ZSB0aGUgc3BlYWtlciBzZWdtZW50YXRpb24sIHRyYW5zY3JpYmUgdGhlIHdob2xlIGF1ZGlvIGZpbGUKICAgIGlmIG5vdCBzZWdtZW50czoKICAgICAgICAjIExvYWQgdGhlIGF1ZGlvOgogICAgICAgIGF1ZGlvID0gd2hpc3Blci5hdWRpby5sb2FkX2F1ZGlvKGZpbGU9c3RyKGF1ZGlvX2ZpbGUpKQogICAgICAgICMgR2V0IGF1ZGlvIGxlbmd0aDoKICAgICAgICBsZW5ndGggPSBsaWJyb3NhLmdldF9kdXJhdGlvbihwYXRoPWF1ZGlvX2ZpbGUpCiAgICAgICAgIyBUcmFuc2NyaWJlOgogICAgICAgIHJlc3VsdCA9IG1vZGVsLnRyYW5zY3JpYmUoYXVkaW89YXVkaW8sICoqZGVjb2Rpbmdfb3B0aW9ucykKICAgICAgICAjIFVucGFjayB0aGUgbW9kZWwncyByZXN1bHQ6CiAgICAgICAgdHJhbnNjcmlwdGlvbiA9IHJlc3VsdFsidGV4dCJdCiAgICAgICAgbGFuZ3VhZ2UgPSByZXN1bHQuZ2V0KCJsYW5ndWFnZSIpIG9yIGRlY29kaW5nX29wdGlvbnMuZ2V0KCJsYW5ndWFnZSIsICIiKQoKICAgICAgICAjIENhbGN1bGF0ZSByYXRlIG9mIHNwZWVjaCAobnVtYmVyIG9mIHdvcmRzIC8gYXVkaW8gbGVuZ3RoKToKICAgICAgICByYXRlX29mX3NwZWVjaCA9IGxlbih0cmFuc2NyaXB0aW9uLnNwbGl0KCkpIC8gbGVuZ3RoCiAgICAgICAgcmV0dXJuIHRyYW5zY3JpcHRpb24sIGxlbmd0aCwgcmF0ZV9vZl9zcGVlY2gsIGxhbmd1YWdlCgogICAgIyBpZiBoYXZlIHRoZSBzcGVha2VyIHNlZ21lbnRhdGlvbiwgdHJhbnNjcmliZSBlYWNoIHNlZ21lbnQgc2VwYXJhdGVseQoKICAgICMgUHJlcGFyZSB0aGUgZGF0YWZyYW1lOgogICAgZGYgPSBwZC5EYXRhRnJhbWUoCiAgICAgICAgY29sdW1ucz1bCiAgICAgICAgICAgICJzcGVha2VyIiwKICAgICAgICAgICAgInN0YXJ0X3RpbWUiLAogICAgICAgICAgICAiZW5kX3RpbWUiLAogICAgICAgICAgICAidHJhbnNjcmlwdGlvbiIsCiAgICAgICAgXQogICAgKQogICAgcmVzID0gW10KICAgIGxhbmdzID0gW10KICAgIGZvciBpZHgsIGxhYmVsLCBzdGFydF90aW1lLCBlbmRfdGltZSwgZmlsZSBpbiBzb3J0ZWQoc2VnbWVudHMsIGtleT1sYW1iZGEgeDogeFswXSk6CiAgICAgICAgIyBMb2FkIHRoZSBhdWRpbzoKICAgICAgICBhdWRpbyA9IHdoaXNwZXIuYXVkaW8ubG9hZF9hdWRpbyhmaWxlPXN0cihmaWxlKSkKICAgICAgICAjIFRoZSBpbml0YWlsX3Byb21wdCBpcyB0aGUgYWxsIHRoZSBwcmV2aW91cyB0cmFuc2NyaXB0aW9ucy4KICAgICAgICByZXN1bHQgPSBtb2RlbC50cmFuc2NyaWJlKAogICAgICAgICAgICBhdWRpbz1hdWRpbywgKipkZWNvZGluZ19vcHRpb25zLCBpbml0aWFsX3Byb21wdD0iXG4iLmpvaW4ocmVzWzogaWR4ICsgMV0pCiAgICAgICAgKQogICAgICAgIGRmLmxvY1tpZHhdID0gW2xhYmVsLCBzdGFydF90aW1lLCBlbmRfdGltZSwgcmVzdWx0WyJ0ZXh0Il1dCiAgICAgICAgdHJhbnNjcmlwdGlvbiA9IGYie2xhYmVsfSAge3N0YXJ0X3RpbWV9ICB7ZW5kX3RpbWV9OiBcbiB7cmVzdWx0Wyd0ZXh0J119IgogICAgICAgIGxhbmdzLmFwcGVuZChyZXN1bHQuZ2V0KCJsYW5ndWFnZSIpIG9yIGRlY29kaW5nX29wdGlvbnMuZ2V0KCJsYW5ndWFnZSIsICIiKSkKICAgICAgICByZXMuYXBwZW5kKHRyYW5zY3JpcHRpb24pCiAgICAgICAgIyBjbGVhbiB1cCB0aGUgdGVtcG9yYXJ5IGZpbGVzCiAgICAgICAgb3MucmVtb3ZlKGZpbGUpCgogICAgIyBHZXQgYXVkaW8gbGVuZ3RoOgogICAgbGVuZ3RoID0gbGlicm9zYS5nZXRfZHVyYXRpb24ocGF0aD1hdWRpb19maWxlKQogICAgdHJhbnNjcmlwdGlvbiA9ICJcbiIuam9pbihyZXMpCiAgICAjIENhbGN1bGF0ZSByYXRlIG9mIHNwZWVjaCAobnVtYmVyIG9mIHdvcmRzIC8gYXVkaW8gbGVuZ3RoKToKICAgIHJhdGVfb2Zfc3BlZWNoID0gbGVuKHRyYW5zY3JpcHRpb24uc3BsaXQoKSkgLyBsZW5ndGgKICAgICMgR2V0IHRoZSBsYW5ndWFnZToKICAgIGxhbmd1YWdlID0gQ291bnRlcihsYW5ncykubW9zdF9jb21tb24oMSlbMF1bMF0KCiAgICByZXR1cm4gdHJhbnNjcmlwdGlvbiwgbGVuZ3RoLCByYXRlX29mX3NwZWVjaCwgbGFuZ3VhZ2UsIGRmCgoKZGVmIF9zcGxpdF9hdWRpbygKICAgIGF1ZGlvX2ZpbGVfcGF0aDogc3RyLCBhbm5vdGF0aW9uOiBBbm5vdGF0aW9uCikgLT4gTGlzdFtUdXBsZVtpbnQsIHN0ciwgZmxvYXQsIGZsb2F0LCBzdHJdXToKICAgICIiIgogICAgU3BsaXQgYW4gYXVkaW8gZmlsZSBiYXNlZCBvbiBhIHB5YW5ub3RlLmNvcmUuQW5ub3RhdGlvbiBvYmplY3QuCgogICAgOnBhcmFtIGF1ZGlvX2ZpbGVfcGF0aDogcGF0aCB0byB0aGUgYXVkaW8gZmlsZSB0byBzcGxpdC4KICAgIDpwYXJhbSBhbm5vdGF0aW9uOiBweWFubm90ZS5jb3JlLkFubm90YXRpb24gb2JqZWN0IHdpdGggZGlhcml6YXRpb24gcmVzdWx0cy4KCiAgICA6cmV0dXJuczogQSBsaXN0IG9mIHR1cGxlcyB3aXRoIHRoZSBmb2xsb3dpbmcgaXRlbXM6CiAgICAgICAgICAgICAgICAqIFRoZSBpbmRleCBvZiB0aGUgc2VnbWVudC4KICAgICAgICAgICAgICAgICogVGhlIGxhYmVsIG9mIHRoZSBzcGVha2VyLgogICAgICAgICAgICAgICAgKiBUaGUgc3RhcnQgdGltZSBvZiB0aGUgc2VnbWVudC4KICAgICAgICAgICAgICAgICogVGhlIGVuZCB0aW1lIG9mIHRoZSBzZWdtZW50LgogICAgICAgICAgICAgICAgKiBUaGUgcGF0aCB0byB0aGUgdGVtcG9yYXJ5IGF1ZGlvIGZpbGUuCiAgICAiIiIKICAgIGF1ZGlvID0gcHlkdWIuQXVkaW9TZWdtZW50LmZyb21fd2F2KGF1ZGlvX2ZpbGVfcGF0aCkKICAgIHNlZ21lbnRzID0gW10KICAgIGlkeCA9IDAKICAgIGZvciBzZWdtZW50LCBfLCBsYWJlbCBpbiBhbm5vdGF0aW9uLml0ZXJ0cmFja3MoeWllbGRfbGFiZWw9VHJ1ZSk6CiAgICAgICAgIyBDb252ZXJ0IHRvIG1pbGxpc2Vjb25kczoKICAgICAgICBzdGFydF90aW1lID0gc2VnbWVudC5zdGFydCAqIDEwMDAKICAgICAgICBlbmRfdGltZSA9IHNlZ21lbnQuZW5kICogMTAwMAoKICAgICAgICAjIEV4dHJhY3QgdGhlIHNlZ21lbnQ6CiAgICAgICAgc2VnbWVudF9hdWRpbyA9IGF1ZGlvW3N0YXJ0X3RpbWU6ZW5kX3RpbWVdCiAgICAgICAgIyBTYXZlIHRoZSBzZWdtZW50IHRvIGEgdGVtcG9yYXJ5IGZpbGU6CiAgICAgICAgd2l0aCB0ZW1wZmlsZS5OYW1lZFRlbXBvcmFyeUZpbGUoCiAgICAgICAgICAgIHN1ZmZpeD0iLndhdiIsIHByZWZpeD0idG1wXyIsIGRlbGV0ZT1GYWxzZQogICAgICAgICkgYXMgdGVtcF9maWxlOgogICAgICAgICAgICBzZWdtZW50X2F1ZGlvLmV4cG9ydChmInt0ZW1wX2ZpbGUubmFtZX0iLCBmb3JtYXQ9IndhdiIpCiAgICAgICAgc2VnbWVudHMuYXBwZW5kKChpZHgsIGxhYmVsLCBzdGFydF90aW1lLCBlbmRfdGltZSwgdGVtcF9maWxlLm5hbWUpKQogICAgICAgIGlkeCArPSAxCgogICAgcmV0dXJuIHNlZ21lbnRzCg==
    base_image: mlrun/mlrun
    commands: []
    code_origin: git@github.com:pengwei715/functions.git#3931185061f7057f9b0e585dc7aca5355812da64:/User/functions/transcribe/transcribe.py
    origin_filename: /User/functions/transcribe/transcribe.py
    requirements:
    - openai-whisper
    - tqdm
    - ffmpeg
    - ffprobe
    - librosa
    - pyannote.core
    - torch
    - torchaudio
    - pydub
  entry_points:
    transcribe:
      name: transcribe
      doc: "Transcribe audio files into text files and collect additional data.\n\
        The end result is a directory of transcribed text files\n and a dataframe\
        \ containing the following columns:\n\n* audio_file - The original audio file\
        \ name.\n* transcription_file - The transcribed text file name in the output\
        \ directory.\n* language - The detected language in the audio file.\n* length\
        \ - The length of the audio file.\n* rate_of_speech - The number of words\
        \ divided by the audio file length."
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
        default: ''
      - name: input_path
        type: str
        doc: A directory of the audio files or a single file to transcribe.
        default: ''
      - name: model_name
        type: str
        doc: One of the official model names listed by `whisper.available_models()`.
        default: base
      - name: device
        type: Literal[, ]
        doc: Device to load the model. Can be one of {"cuda", "cpu"}. Default will
          prefer "cuda" if available.
        default: null
      - name: decoding_options
        type: dict
        doc: A dictionary of options to construct a `whisper.DecodingOptions`.
        default: null
      - name: output_directory
        type: str
        doc: Path to a directory to save all transcribed audio files.
        default: null
      - name: url_path
        type: str
        doc: Path to the dataframe that contains the result of the speaker diarization.
        default: null
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 31
  description: Transcribe audio files into text files
  default_handler: transcribe
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  resources:
    requests:
      memory: 1Mi
      cpu: 25m
    limits:
      memory: 20Gi
      cpu: '2'
  priority_class_name: igz-workload-medium
  preemption_mode: prevent
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: app.iguazio.com/lifecycle
            operator: NotIn
            values:
            - preemptible
          - key: eks.amazonaws.com/capacityType
            operator: NotIn
            values:
            - SPOT
          - key: node-lifecycle
            operator: NotIn
            values:
            - spot
  tolerations: null
  security_context: {}
verbose: false
