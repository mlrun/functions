metadata:
  tag: ''
  name: hugging-face-serving
  categories:
  - genai
  - model-serving
verbose: false
kind: serving
spec:
  image: mlrun/ml-models
  disable_auto_mount: false
  build:
    origin_filename: ''
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCmZyb20gYWJjIGltcG9ydCBBQkMKZnJvbSBpbXBvcnRsaWIgaW1wb3J0IGltcG9ydF9tb2R1bGUKCmltcG9ydCBtbHJ1bi5zZXJ2aW5nCmZyb20gdHJhbnNmb3JtZXJzIGltcG9ydCBwaXBlbGluZQoKUEFDS0FHRV9NT0RVTEUgPSAidHJhbnNmb3JtZXJzIgpTRVJJQUxJWkFCTEVfVFlQRVMgPSBbZGljdCwgbGlzdCwgdHVwbGUsIHN0ciwgaW50LCBmbG9hdF0KCgpjbGFzcyBIdWdnaW5nRmFjZU1vZGVsU2VydmVyKG1scnVuLnNlcnZpbmcuVjJNb2RlbFNlcnZlciwgQUJDKToKICAgICIiIgogICAgSHVnZ2luZyBGYWNlIE1vZGVsIHNlcnZpbmcgY2xhc3MsIGluaGVyaXRpbmcgdGhlIFYyTW9kZWxTZXJ2ZXIgY2xhc3MgZm9yIGJlaW5nIGluaXRpYWxpemVkIGF1dG9tYXRpY2FsbHkgYnkgdGhlCiAgICBtb2RlbCBzZXJ2ZXIgYW5kIGJlIGFibGUgdG8gcnVuIGxvY2FsbHkgYXMgcGFydCBvZiBhIG51Y2xpbyBzZXJ2ZXJsZXNzIGZ1bmN0aW9uLCBvciBhcyBwYXJ0IG9mIGEgcmVhbC10aW1lIHBpcGVsaW5lLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgY29udGV4dDogbWxydW4uTUxDbGllbnRDdHgsCiAgICAgICAgbmFtZTogc3RyLAogICAgICAgIHRhc2s6IHN0ciwKICAgICAgICBtb2RlbF9wYXRoOiBzdHIgPSBOb25lLAogICAgICAgIG1vZGVsX25hbWU6IHN0ciA9IE5vbmUsCiAgICAgICAgbW9kZWxfY2xhc3M6IHN0ciA9IE5vbmUsCiAgICAgICAgdG9rZW5pemVyX25hbWU6IHN0ciA9IE5vbmUsCiAgICAgICAgdG9rZW5pemVyX2NsYXNzOiBzdHIgPSBOb25lLAogICAgICAgIGZyYW1ld29yazogc3RyID0gTm9uZSwKICAgICAgICAqKmNsYXNzX2FyZ3MsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXRpYWxpemUgYSBzZXJ2aW5nIGNsYXNzIGZvciBhIEh1Z2dpbmcgZmFjZSBtb2RlbC4KCiAgICAgICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgVGhlIG1scnVuIGNvbnRleHQgdG8gd29yayB3aXRoCiAgICAgICAgOnBhcmFtIG5hbWU6ICAgICAgICAgICAgVGhlIG5hbWUgb2YgdGhpcyBzZXJ2ZXIgdG8gYmUgaW5pdGlhbGl6ZWQKICAgICAgICA6cGFyYW0gbW9kZWxfcGF0aDogICAgICBOb3QgaW4gdXNlLiBXaGVuIGFkZGluZyBhIG1vZGVsIHBhc3MgYW55IHN0cmluZyB2YWx1ZQogICAgICAgIDpwYXJhbSBtb2RlbF9uYW1lOiAgICAgIFRoZSBtb2RlbCdzIG5hbWUgaW4gdGhlIEh1Z2dpbmcgRmFjZSBodWIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmcuLCBgbmxwdG93bi9iZXJ0LWJhc2UtbXVsdGlsaW5ndWFsLXVuY2FzZWQtc2VudGltZW50YAogICAgICAgIDpwYXJhbSBtb2RlbF9jbGFzczogICAgIFRoZSBtb2RlbCdzIGNsYXNzIHR5cGUgb2JqZWN0IHdoaWNoIGNhbiBiZSBwYXNzZWQgYXMgdGhlIGNsYXNzJ3MgbmFtZSAoc3RyaW5nKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNdXN0IGJlIHByb3ZpZGVkIGFuZCB0byBiZSBtYXRjaGVkIHdpdGggYG1vZGVsX25hbWVgLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZy4sIGBBdXRvTW9kZWxGb3JTZXF1ZW5jZUNsYXNzaWZpY2F0aW9uYAogICAgICAgIDpwYXJhbSB0b2tlbml6ZXJfbmFtZTogIFRoZSB0b2tlbml6ZXIncyBuYW1lIGluIHRoZSBIdWdnaW5nIEZhY2UgaHViCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5nLiwgYG5scHRvd24vYmVydC1iYXNlLW11bHRpbGluZ3VhbC11bmNhc2VkLXNlbnRpbWVudGAKICAgICAgICA6cGFyYW0gdG9rZW5pemVyX2NsYXNzOiBUaGUgbW9kZWwncyBjbGFzcyB0eXBlIG9iamVjdCB3aGljaCBjYW4gYmUgcGFzc2VkIGFzIHRoZSBjbGFzcydzIG5hbWUgKHN0cmluZykuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTXVzdCBiZSBwcm92aWRlZCBhbmQgdG8gYmUgbWF0Y2hlZCB3aXRoIGBtb2RlbF9uYW1lYC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmcuLCBgQXV0b1Rva2VuaXplcmAKICAgICAgICA6cGFyYW0gZnJhbWV3b3JrOiAgICAgICBUaGUgZnJhbWV3b3JrIHRvIHVzZSwgZWl0aGVyIGAicHQiYCBmb3IgUHlUb3JjaCBvciBgInRmImAgZm9yIFRlbnNvckZsb3cuIFRoZSBzcGVjaWZpZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZXdvcmsgbXVzdCBiZSBpbnN0YWxsZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgbm8gZnJhbWV3b3JrIGlzIHNwZWNpZmllZCwgd2lsbCBkZWZhdWx0IHRvIHRoZSBvbmUgY3VycmVudGx5IGluc3RhbGxlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiBubyBmcmFtZXdvcmsgaXMgc3BlY2lmaWVkIGFuZCBib3RoIGZyYW1ld29ya3MgYXJlIGluc3RhbGxlZCwgd2lsbCBkZWZhdWx0IHRvIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1ld29yayBvZiB0aGUgYG1vZGVsYCwgb3IgdG8gUHlUb3JjaCBpZiBubyBtb2RlbCBpcyBwcm92aWRlZC4KICAgICAgICA6cGFyYW0gY2xhc3NfYXJnczogICAgICAtCiAgICAgICAgIiIiCiAgICAgICAgc3VwZXIoSHVnZ2luZ0ZhY2VNb2RlbFNlcnZlciwgc2VsZikuX19pbml0X18oCiAgICAgICAgICAgIGNvbnRleHQ9Y29udGV4dCwKICAgICAgICAgICAgbmFtZT1uYW1lLAogICAgICAgICAgICBtb2RlbF9wYXRoPW1vZGVsX3BhdGgsCiAgICAgICAgICAgICoqY2xhc3NfYXJncywKICAgICAgICApCiAgICAgICAgc2VsZi50YXNrID0gdGFzawogICAgICAgIHNlbGYubW9kZWwgPSBOb25lCiAgICAgICAgc2VsZi50b2tlbml6ZXIgPSBOb25lCiAgICAgICAgc2VsZi5tb2RlbF9uYW1lID0gbW9kZWxfbmFtZQogICAgICAgIHNlbGYudG9rZW5pemVyX25hbWUgPSB0b2tlbml6ZXJfbmFtZQogICAgICAgIHNlbGYubW9kZWxfY2xhc3MgPSBtb2RlbF9jbGFzcwogICAgICAgIHNlbGYudG9rZW5pemVyX2NsYXNzID0gdG9rZW5pemVyX2NsYXNzCiAgICAgICAgc2VsZi5mcmFtZXdvcmsgPSBmcmFtZXdvcmsKICAgICAgICBzZWxmLnBpcGUgPSBOb25lCgogICAgZGVmIGxvYWQoc2VsZik6CiAgICAgICAgIiIibG9hZCBhbmQgaW5pdGlhbGl6ZSB0aGUgbW9kZWwgYW5kL29yIG90aGVyIGVsZW1lbnRzIiIiCiAgICAgICAgaWYgc2VsZi5tb2RlbF9jbGFzczoKICAgICAgICAgICAgbW9kZWxfb2JqZWN0ID0gZ2V0YXR0cihpbXBvcnRfbW9kdWxlKFBBQ0tBR0VfTU9EVUxFKSwgc2VsZi5tb2RlbF9jbGFzcykKICAgICAgICAgICAgc2VsZi5tb2RlbCA9IG1vZGVsX29iamVjdC5mcm9tX3ByZXRyYWluZWQoc2VsZi5tb2RlbF9uYW1lKQogICAgICAgIGlmIHNlbGYudG9rZW5pemVyX2NsYXNzOgogICAgICAgICAgICB0b2tlbml6ZXJfb2JqZWN0ID0gZ2V0YXR0cigKICAgICAgICAgICAgICAgIGltcG9ydF9tb2R1bGUoUEFDS0FHRV9NT0RVTEUpLCBzZWxmLnRva2VuaXplcl9jbGFzcwogICAgICAgICAgICApCiAgICAgICAgICAgIHNlbGYudG9rZW5pemVyID0gdG9rZW5pemVyX29iamVjdC5mcm9tX3ByZXRyYWluZWQoc2VsZi50b2tlbml6ZXJfbmFtZSkKICAgICAgICBzZWxmLnBpcGUgPSBwaXBlbGluZSgKICAgICAgICAgICAgdGFzaz1zZWxmLnRhc2ssCiAgICAgICAgICAgIG1vZGVsPXNlbGYubW9kZWwgb3Igc2VsZi5tb2RlbF9uYW1lLAogICAgICAgICAgICB0b2tlbml6ZXI9c2VsZi50b2tlbml6ZXIsCiAgICAgICAgICAgIGZyYW1ld29yaz1zZWxmLmZyYW1ld29yaywKICAgICAgICApCgogICAgZGVmIHByZWRpY3Qoc2VsZiwgYm9keTogZGljdCkgLT4gbGlzdDoKICAgICAgICAiIiJHZW5lcmF0ZSBtb2RlbCBwcmVkaWN0aW9ucyBmcm9tIHNhbXBsZS4iIiIKICAgICAgICBpZiBzZWxmLnBpcGUgaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiUGxlYXNlIHVzZSBgLmxvYWQoKWAiKQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShib2R5WyJpbnB1dHMiXVswXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXN1bHQgPSBbc2VsZi5waXBlKCoqX2lucHV0KSBmb3IgX2lucHV0IGluIGJvZHlbImlucHV0cyJdXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5waXBlKGJvZHlbImlucHV0cyJdKQogICAgICAgICAgICAjIHJlcGxhY2UgbGlzdCBvZiBsaXN0cyBvZiBkaWN0cyBpbnRvIGEgbGlzdCBvZiBkaWN0czoKICAgICAgICAgICAgaWYgYWxsKGlzaW5zdGFuY2UocmVzLCBsaXN0KSBmb3IgcmVzIGluIHJlc3VsdCk6CiAgICAgICAgICAgICAgICBuZXdfcmVzdWx0ID0gW3Jlc1swXSBmb3IgcmVzIGluIHJlc3VsdF0KICAgICAgICAgICAgICAgIHJlc3VsdCA9IG5ld19yZXN1bHQKCiAgICAgICAgICAgIG5vbl9zZXJpYWxpemFibGVfdHlwZXMgPSBbXQogICAgICAgICAgICBmb3IgcmVzIGluIHJlc3VsdDoKICAgICAgICAgICAgICAgIGZvciBrZXksIHZhbCBpbiByZXMuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICBpZiB0eXBlKHZhbCkgbm90IGluIFNFUklBTElaQUJMRV9UWVBFUzoKICAgICAgICAgICAgICAgICAgICAgICAgbm9uX3NlcmlhbGl6YWJsZV90eXBlcy5hcHBlbmQoc3RyKHR5cGUodmFsKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc1trZXldID0gc3RyKHZhbCkKICAgICAgICAgICAgaWYgbm9uX3NlcmlhbGl6YWJsZV90eXBlczoKICAgICAgICAgICAgICAgIHNlbGYuY29udGV4dC5sb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICAgICBmIk5vbi1zZXJpYWxpemFibGUgdHlwZXM6IHtub25fc2VyaWFsaXphYmxlX3R5cGVzfSB3ZXJlIGNhc3RlZCB0byBzdHJpbmdzIgogICAgICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJGYWlsZWQgdG8gcHJlZGljdCAlcyIgJSBlKQogICAgICAgIHJldHVybiByZXN1bHQKCmZyb20gbWxydW4ucnVudGltZXMgaW1wb3J0IG51Y2xpb19pbml0X2hvb2sKZGVmIGluaXRfY29udGV4dChjb250ZXh0KToKICAgIG51Y2xpb19pbml0X2hvb2soY29udGV4dCwgZ2xvYmFscygpLCAnc2VydmluZ192MicpCgpkZWYgaGFuZGxlcihjb250ZXh0LCBldmVudCk6CiAgICByZXR1cm4gY29udGV4dC5tbHJ1bl9oYW5kbGVyKGNvbnRleHQsIGV2ZW50KQo=
    requirements:
    - transformers==4.21.3
    - tensorflow==2.9.2
    code_origin: ''
  filename: hugging_face_serving.py
  default_class: HuggingFaceModelServer
  min_replicas: 1
  command: ''
  default_handler: ''
  source: ''
  max_replicas: 4
  base_image_pull: false
  description: Generic Hugging Face model server.
  function_kind: serving_v2
  function_handler: hugging-face-serving-nuclio:handler
  env:
  - name: MLRUN_HTTPDB__NUCLIO__EXPLICIT_ACK
    value: enabled
