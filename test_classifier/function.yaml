kind: job
metadata:
  name: test-classifier
  tag: ''
  hash: d25d9acfe6e10bbf4a3b9cb62330d9a691dc4f21
  project: ''
  labels:
    author: yjb
    stage: development
  categories:
  - models
  - test
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: test_classifier
  entry_points:
    _gcf_clear:
      name: _gcf_clear
      doc: ''
      parameters:
      - name: plt
      outputs: []
      lineno: 27
    test_classifier:
      name: test_classifier
      doc: "Test one or more classifier models against held-out dataset\n\nUsing held-out\
        \ test features, evaluates the peformance of the estimated model\n\nCan be\
        \ part of a kubeflow pipeline as a test step that is run post EDA and \ntraining/validation\
        \ cycles"
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: models_dir
        type: Union[DataItem, str]
        doc: artifact models representing a folder or a folder
      - name: test_set
        type: DataItem
        doc: test features and labels
      - name: label_column
        type: str
        doc: column name for ground truth labels
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: key
        type: str
        doc: key for results artifact (maybe just a dir of artifacts for test like
          plots_dir)
      - name: plots_dir
        type: str
        doc: dir for test plots
        default: plots
      outputs: []
      lineno: 32
    _eval_model:
      name: _eval_model
      doc: ''
      parameters:
      - name: model
      outputs: []
      lineno: 63
    plot_roc:
      name: plot_roc
      doc: "plot roc curves\n\nTODO:  add averaging method (as string) that was used\
        \ to create probs, \ndisplay in legend"
      parameters:
      - name: context
        doc: the function context
      - name: y_labels
        doc: 'ground truth labels, hot encoded for multiclass  '
      - name: y_probs
        doc: model prediction probabilities
      - name: key
        doc: ("roc") key of plot in artifact store
        default: roc
      - name: plots_dir
        type: str
        doc: ("plots") destination folder relative path to artifact path
        default: plots
      - name: fmt
        doc: ("png") plot format
        default: png
      - name: fpr_label
        type: str
        doc: ("false positive rate") x-axis labels
        default: false positive rate
      - name: tpr_label
        type: str
        doc: ("true positive rate") y-axis labels
        default: true positive rate
      - name: title
        type: str
        doc: ("roc curve") title of plot
        default: roc curve
      - name: legend_loc
        type: str
        doc: ("best") location of plot legend
        default: best
      outputs: []
      lineno: 97
    plot_confusion_matrix:
      name: plot_confusion_matrix
      doc: 'Create a confusion matrix.

        Plot and save a confusion matrix using test data from a

        modelline step.


        See https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html


        TODO: fix label alignment

        TODO: consider using another packaged version

        TODO: refactor to take params dict for plot options'
      parameters:
      - name: context
        type: MLClientCtx
        doc: function context
      - name: labels
        doc: validation data ground-truth labels
      - name: predictions
        doc: validation data predictions
      - name: key
        type: str
        doc: str
        default: confusion_matrix
      - name: plots_dir
        type: str
        doc: relative path of plots in artifact store
        default: plots
      - name: colormap
        type: str
        doc: colourmap for confusion matrix
        default: Blues
      - name: fmt
        type: str
        doc: plot format
        default: png
      - name: sample_weight
        doc: sample weights
      outputs: []
      lineno: 156
    plot_importance:
      name: plot_importance
      doc: Display estimated feature importances.
      parameters:
      - name: context
        doc: function context
      - name: model
        doc: fitted lightgbm model
      - name: key
        type: str
        default: feature-importances
      - name: fmt
        default: png
      outputs: []
      lineno: 195
    _plot_confusion_matrix:
      name: _plot_confusion_matrix
      doc: 'This can be deprecated once intel python upgrades scikit-learn to >0.22


        This function prints and plots the confusion matrix.

        Normalization can be applied by setting `normalize=True`.


        https://scikit-learn.org/0.21/auto_examples/model_selection/plot_confusion_matrix.html#sphx-glr-auto-examples-model-selection-plot-confusion-matrix-py'
      parameters:
      - name: y_true
      - name: y_pred
      - name: classes
        default:
        - neg
        - pos
      - name: normalize
        default: true
      - name: title
      - name: cmap
        default: <_ast.Attribute object at 0x7f48ceb94510>
      outputs: []
      lineno: 229
  description: ''
  image_pull_policy: Always
  build:
    functionSourceCode: aW1wb3J0IG9zCmltcG9ydCBqc29uCmltcG9ydCBpbXBvcnRsaWIKZnJvbSBjbG91ZHBpY2tsZSBpbXBvcnQgbG9hZAoKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKCmltcG9ydCBza2xlYXJuCmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwpmcm9tIHNrbGVhcm4ucHJlcHJvY2Vzc2luZyBpbXBvcnQgbGFiZWxfYmluYXJpemUKZnJvbSBza2xlYXJuLnV0aWxzLm11bHRpY2xhc3MgaW1wb3J0IHVuaXF1ZV9sYWJlbHMKCmltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKZnJvbSBtYXRwbG90bGliLmZpZ3VyZSBpbXBvcnQgRmlndXJlCmltcG9ydCBzZWFib3JuIGFzIHNucwoKZnJvbSB0eXBpbmcgaW1wb3J0IE9wdGlvbmFsLCBVbmlvbiwgTGlzdCwgVHVwbGUKCmZyb20gbWxydW4uZXhlY3V0aW9uIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IFRhYmxlQXJ0aWZhY3QsIFBsb3RBcnRpZmFjdAoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpkZWYgX2djZl9jbGVhcihwbHQpOgogICAgcGx0LmNsYSgpCiAgICBwbHQuY2xmKCkKICAgIHBsdC5jbG9zZSgpICAgICAgICAKCmRlZiB0ZXN0X2NsYXNzaWZpZXIoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIG1vZGVsc19kaXI6IFVuaW9uW0RhdGFJdGVtLCBzdHJdLCAKICAgIHRlc3Rfc2V0OiBEYXRhSXRlbSwKICAgIGxhYmVsX2NvbHVtbjogc3RyLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAnbWljcm8nLAogICAga2V5OiBzdHIgPSAiIiwKICAgIHBsb3RzX2Rpcjogc3RyID0gInBsb3RzIgopIC0+IE5vbmU6CiAgICAiIiJUZXN0IG9uZSBvciBtb3JlIGNsYXNzaWZpZXIgbW9kZWxzIGFnYWluc3QgaGVsZC1vdXQgZGF0YXNldAogICAgCiAgICBVc2luZyBoZWxkLW91dCB0ZXN0IGZlYXR1cmVzLCBldmFsdWF0ZXMgdGhlIHBlZm9ybWFuY2Ugb2YgdGhlIGVzdGltYXRlZCBtb2RlbAogICAgCiAgICBDYW4gYmUgcGFydCBvZiBhIGt1YmVmbG93IHBpcGVsaW5lIGFzIGEgdGVzdCBzdGVwIHRoYXQgaXMgcnVuIHBvc3QgRURBIGFuZCAKICAgIHRyYWluaW5nL3ZhbGlkYXRpb24gY3ljbGVzCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxzX2RpcjogICAgICBhcnRpZmFjdCBtb2RlbHMgcmVwcmVzZW50aW5nIGEgZm9sZGVyIG9yIGEgZm9sZGVyCiAgICA6cGFyYW0gdGVzdF9zZXQ6ICAgICAgICB0ZXN0IGZlYXR1cmVzIGFuZCBsYWJlbHMKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgIGNvbHVtbiBuYW1lIGZvciBncm91bmQgdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gc2NvcmVfbWV0aG9kOiAgICBmb3IgbXVsdGljbGFzcyBjbGFzc2lmaWNhdGlvbgogICAgOnBhcmFtIGtleTogICAgICAgICAgICAga2V5IGZvciByZXN1bHRzIGFydGlmYWN0IChtYXliZSBqdXN0IGEgZGlyIG9mIGFydGlmYWN0cyBmb3IgdGVzdCBsaWtlIHBsb3RzX2RpcikKICAgIDpwYXJhbSBwbG90c19kaXI6ICAgICAgIGRpciBmb3IgdGVzdCBwbG90cwogICAgIiIiCiAgICBvcy5tYWtlZGlycyhvcy5wYXRoLmpvaW4oY29udGV4dC5hcnRpZmFjdF9wYXRoLCBwbG90c19kaXIpLCBleGlzdF9vaz1UcnVlKQogICAgCiAgICB4dGVzdCA9IHBkLnJlYWRfcGFycXVldChzdHIodGVzdF9zZXQpKQogICAgeXRlc3QgPSB4dGVzdC5wb3AobGFiZWxfY29sdW1uKQogICAgCiAgICBjb250ZXh0LmhlYWRlciA9IGxpc3QoeHRlc3QuY29sdW1ucy52YWx1ZXMpCiAgICAKICAgIGRlZiBfZXZhbF9tb2RlbChtb2RlbCk6CiAgICAgICAgIyBlbmNsb3NlIGFsbCBleGNlcHQgbW9kZWwKICAgICAgICB5dGVzdGIgPSBsYWJlbF9iaW5hcml6ZSh5dGVzdCwgY2xhc3Nlcz1saXN0KHJhbmdlKHh0ZXN0LnNoYXBlWzFdKSkpCiAgICAgICAgY2xmID0gbG9hZChvcGVuKG9zLnBhdGguam9pbihzdHIobW9kZWxzX2RpciksIG1vZGVsKSwgInJiIikpCiAgICAgICAgaWYgY2FsbGFibGUoZ2V0YXR0cihjbGYsICJwcmVkaWN0X3Byb2JhIikpOgogICAgICAgICAgICB5X3Njb3JlID0gY2xmLnByZWRpY3RfcHJvYmEoeHRlc3QudmFsdWVzKQogICAgICAgICAgICB5cHJlZCA9IGNsZi5wcmVkaWN0KHh0ZXN0LnZhbHVlcykKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInlfc2NvcmUuc2hhcGUge3lfc2NvcmUuc2hhcGV9IikKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInl0ZXN0Yi5zaGFwZSB7eXRlc3RiLnNoYXBlfSIpCiAgICAgICAgICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl0ZXN0YiwgeV9zY29yZSwga2V5PWYicm9jIiwgcGxvdHNfZGlyPXBsb3RzX2RpcikKICAgICAgICBlbHNlOgogICAgICAgICAgICB5cHJlZCA9IGNsZi5wcmVkaWN0KHh0ZXN0LnZhbHVlcykgIyByZWZhY3RvcgogICAgICAgICAgICB5X3Njb3JlID0gTm9uZQogICAgICAgIHBsb3RfY29uZnVzaW9uX21hdHJpeChjb250ZXh0LCB5dGVzdCwgeXByZWQsIGtleT0iY29uZnVzaW9uIiwgZm10PSJwbmciKQogICAgICAgIGlmIGhhc2F0dHIoY2xmLCAiZmVhdHVyZV9pbXBvcnRhbmNlc18iKToKICAgICAgICAgICAgcGxvdF9pbXBvcnRhbmNlKGNvbnRleHQsIGNsZiwga2V5PWYiZmVhdGltcCIpCiAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl0ZXN0Yls6LDotMV0sIHlfc2NvcmUsIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImFjY3VyYWN5IiwgZmxvYXQoY2xmLnNjb3JlKHh0ZXN0LnZhbHVlcywgeXRlc3QudmFsdWVzKSkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl0ZXN0YiwgeV9zY29yZSkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiZjFfc2NvcmUiLCBtZXRyaWNzLmYxX3Njb3JlKHl0ZXN0LnZhbHVlcywgeXByZWQsIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhdmdfcHJlY3Njb3JlIiwgYXZlcmFnZV9wcmVjaXNpb24pCgogICAgCiAgICBiZXN0X21vZGVsID0gTm9uZQogICAgZm9yIG1vZGVsIGluIG9zLmxpc3RkaXIoc3RyKG1vZGVsc19kaXIpKToKICAgICAgICBpZiBtb2RlbC5lbmRzd2l0aCgnLnBrbCcpOgogICAgICAgICAgICBfZXZhbF9tb2RlbChtb2RlbCkKICAgICAgICAgICAgIyBIQUNLOiB0aGVyZSBpcyBvbmx5IG9uZSBtb2RlbCBoZXJlCiAgICAgICAgICAgIGJlc3RfbW9kZWwgPSBtb2RlbAoKICAgICMgbG9nICdiZXN0IG1vZGVsJyBhcyBhcnRpZmFjdAogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoJ1RPREFZUy1NT0RFTFMtVEVTVC1SRVBPUlQnLCBsb2NhbF9wYXRoPWJlc3RfbW9kZWwpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgnREVQTE9ZJywgYm9keT1iJ3RydWUnLCBsb2NhbF9wYXRoPSdERVBMT1knKQogICAgCmRlZiBwbG90X3JvYygKICAgIGNvbnRleHQsCiAgICB5X2xhYmVscywKICAgIHlfcHJvYnMsCiAgICBrZXk9InJvYyIsCiAgICBwbG90c19kaXI6IHN0ciA9ICJwbG90cyIsCiAgICBmbXQ9InBuZyIsCiAgICBmcHJfbGFiZWw6IHN0ciA9ICJmYWxzZSBwb3NpdGl2ZSByYXRlIiwKICAgIHRwcl9sYWJlbDogc3RyID0gICJ0cnVlIHBvc2l0aXZlIHJhdGUiLAogICAgdGl0bGU6IHN0ciA9ICJyb2MgY3VydmUiLAogICAgbGVnZW5kX2xvYzogc3RyID0gImJlc3QiCik6CiAgICAiIiJwbG90IHJvYyBjdXJ2ZXMKICAgIAogICAgVE9ETzogIGFkZCBhdmVyYWdpbmcgbWV0aG9kIChhcyBzdHJpbmcpIHRoYXQgd2FzIHVzZWQgdG8gY3JlYXRlIHByb2JzLCAKICAgIGRpc3BsYXkgaW4gbGVnZW5kCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0geV9sYWJlbHM6ICAgICBncm91bmQgdHJ1dGggbGFiZWxzLCBob3QgZW5jb2RlZCBmb3IgbXVsdGljbGFzcyAgCiAgICA6cGFyYW0geV9wcm9iczogICAgICBtb2RlbCBwcmVkaWN0aW9uIHByb2JhYmlsaXRpZXMKICAgIDpwYXJhbSBrZXk6ICAgICAgICAgICgicm9jIikga2V5IG9mIHBsb3QgaW4gYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBwbG90c19kaXI6ICAgICgicGxvdHMiKSBkZXN0aW5hdGlvbiBmb2xkZXIgcmVsYXRpdmUgcGF0aCB0byBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gZm10OiAgICAgICAgICAoInBuZyIpIHBsb3QgZm9ybWF0CiAgICA6cGFyYW0gZnByX2xhYmVsOiAgICAoImZhbHNlIHBvc2l0aXZlIHJhdGUiKSB4LWF4aXMgbGFiZWxzCiAgICA6cGFyYW0gdHByX2xhYmVsOiAgICAoInRydWUgcG9zaXRpdmUgcmF0ZSIpIHktYXhpcyBsYWJlbHMKICAgIDpwYXJhbSB0aXRsZTogICAgICAgICgicm9jIGN1cnZlIikgdGl0bGUgb2YgcGxvdAogICAgOnBhcmFtIGxlZ2VuZF9sb2M6ICAgKCJiZXN0IikgbG9jYXRpb24gb2YgcGxvdCBsZWdlbmQKICAgICIiIgogICAgICAgIyBjbGVhciBtYXRwbG90bGliIGN1cnJlbnQgZmlndXJlCiAgICBfZ2NmX2NsZWFyKHBsdCkKICAgIAogICAgIyBkcmF3IDQ1IGRlZ3JlZSBsaW5lCiAgICBwbHQucGxvdChbMCwgMV0sIFswLCAxXSwgImstLSIpCiAgICAKICAgICMgbGFiZWxsaW5nCiAgICBwbHQueGxhYmVsKHhfbGFiZWwpCiAgICBwbHQueWxhYmVsKHlfbGFiZWwpCiAgICBwbHQudGl0bGUodGl0bGUpCiAgICBwbHQubGVnZW5kKGxvYz1sZWdlbmRfbG9jKQogICAgCiAgICAjIHNpbmdsZSBST0Mgb3IgbXV0bGlwbGUKICAgIGlmIHlfbGFiZWxzLnNoYXBlWzFdID4gMToKICAgICAgICAjIGRhdGEgYWNjdW1tdWxhdG9ycyBieSBjbGFzcwogICAgICAgIGZwciA9IGRpY3QoKQogICAgICAgIHRwciA9IGRpY3QoKQogICAgICAgIHJvY19hdWMgPSBkaWN0KCkKICAgICAgICBmb3IgaSBpbiByYW5nZSh5X2xhYmVsc1s6LDotMV0uc2hhcGVbMV0pOgogICAgICAgICAgICBmcHJbaV0sIHRwcltpXSwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzWzosIGldLCB5X3Byb2JzWzosIGldLCBwb3NfbGFiZWw9MSkKICAgICAgICAgICAgcm9jX2F1Y1tpXSA9IG1ldHJpY3MuYXVjKGZwcltpXSwgdHByW2ldKQogICAgICAgICAgICBwbHQucGxvdChmcHJbaV0sIHRwcltpXSwgbGFiZWw9ZiJjbGFzcyB7aX0iKQogICAgZWxzZToKICAgICAgICBmcHIsIHRwciwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzLCB5X3Byb2JzWzosIDFdLCBwb3NfbGFiZWw9MSkKICAgICAgICBwbHQucGxvdChmcHIsIHRwciwgbGFiZWw9ZiJwb3NpdGl2ZSBjbGFzcyIpCiAgICAgICAgCiAgICBmbmFtZSA9IGYie3Bsb3RzX2Rpcn0ve2tleX0ue2ZtdH0iCiAgICBwbHQuc2F2ZWZpZyhvcy5wYXRoLmpvaW4oY29udGV4dC5hcnRpZmFjdF9wYXRoLCBmbmFtZSkpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3Qoa2V5LCBib2R5PXBsdC5nY2YoKSksIGxvY2FsX3BhdGg9Zm5hbWUpCiAgICAKCmRlZiBwbG90X2NvbmZ1c2lvbl9tYXRyaXgoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGxhYmVscywKICAgIHByZWRpY3Rpb25zLAogICAga2V5OiBzdHIgPSAiY29uZnVzaW9uX21hdHJpeCIsCiAgICBwbG90c19kaXI6IHN0ciA9ICJwbG90cyIsCiAgICBjb2xvcm1hcDogc3RyID0gIkJsdWVzIiwKICAgIGZtdDogc3RyID0gInBuZyIsCiAgICBzYW1wbGVfd2VpZ2h0PU5vbmUKKToKICAgICIiIkNyZWF0ZSBhIGNvbmZ1c2lvbiBtYXRyaXguCiAgICBQbG90IGFuZCBzYXZlIGEgY29uZnVzaW9uIG1hdHJpeCB1c2luZyB0ZXN0IGRhdGEgZnJvbSBhCiAgICBtb2RlbGxpbmUgc3RlcC4KICAgIAogICAgU2VlIGh0dHBzOi8vc2Npa2l0LWxlYXJuLm9yZy9zdGFibGUvbW9kdWxlcy9nZW5lcmF0ZWQvc2tsZWFybi5tZXRyaWNzLmNvbmZ1c2lvbl9tYXRyaXguaHRtbAogICAgCiAgICBUT0RPOiBmaXggbGFiZWwgYWxpZ25tZW50CiAgICBUT0RPOiBjb25zaWRlciB1c2luZyBhbm90aGVyIHBhY2thZ2VkIHZlcnNpb24KICAgIFRPRE86IHJlZmFjdG9yIHRvIHRha2UgcGFyYW1zIGRpY3QgZm9yIHBsb3Qgb3B0aW9ucwoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBsYWJlbHM6ICAgICAgICAgIHZhbGlkYXRpb24gZGF0YSBncm91bmQtdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gcHJlZGljdGlvbnM6ICAgICB2YWxpZGF0aW9uIGRhdGEgcHJlZGljdGlvbnMKICAgIDpwYXJhbSBrZXk6ICAgICAgICAgICAgIHN0cgogICAgOnBhcmFtIHBsb3RzX2RpcjogICAgICAgcmVsYXRpdmUgcGF0aCBvZiBwbG90cyBpbiBhcnRpZmFjdCBzdG9yZQogICAgOnBhcmFtIGNvbG9ybWFwOiAgICAgICAgY29sb3VybWFwIGZvciBjb25mdXNpb24gbWF0cml4CiAgICA6cGFyYW0gZm10OiAgICAgICAgICAgICBwbG90IGZvcm1hdAogICAgOnBhcmFtIHNhbXBsZV93ZWlnaHQ6ICAgc2FtcGxlIHdlaWdodHMKICAgICIiIgogICAgX2djZl9jbGVhcihwbHQpCiAgICAKICAgIGNtID0gbWV0cmljcy5jb25mdXNpb25fbWF0cml4KGxhYmVscywgcHJlZGljdGlvbnMsIHNhbXBsZV93ZWlnaHQ9Tm9uZSkKICAgIHNucy5oZWF0bWFwKGNtLCBhbm5vdD1UcnVlLCBjbWFwPWNvbG9ybWFwLCBzcXVhcmU9VHJ1ZSkKCiAgICBmaWcgPSBwbHQuZ2NmKCkKICAgIGZuYW1lID0gZiJ7cGxvdHNfZGlyfS97a2V5fS57Zm10fSIKICAgIGZpZy5zYXZlZmlnKG9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIGZuYW1lKSkKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdChrZXksIGJvZHk9ZmlnKSwgbG9jYWxfcGF0aD1mbmFtZSkKCmRlZiBwbG90X2ltcG9ydGFuY2UoCiAgICBjb250ZXh0LAogICAgbW9kZWwsCiAgICBrZXk6IHN0ciA9ICJmZWF0dXJlLWltcG9ydGFuY2VzIiwKICAgIGZtdCA9ICJwbmciCik6CiAgICAiIiJEaXNwbGF5IGVzdGltYXRlZCBmZWF0dXJlIGltcG9ydGFuY2VzLgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWw6ICAgICAgIGZpdHRlZCBsaWdodGdibSBtb2RlbAogICAgIiIiCiAgICBfZ2NmX2NsZWFyKHBsdCkKICAgIAogICAgIyBjcmVhdGUgYSBmZWF0dXJlIGltcG9ydGFuY2UgdGFibGUgd2l0aCBkZXNpcmVkIGxhYmVscwogICAgemlwcGVkID0gemlwKG1vZGVsLmZlYXR1cmVfaW1wb3J0YW5jZXNfLCBjb250ZXh0LmhlYWRlcikKCiAgICBmZWF0dXJlX2ltcCA9IHBkLkRhdGFGcmFtZShzb3J0ZWQoemlwcGVkKSwgY29sdW1ucz1bImZyZXEiLCJmZWF0dXJlIl0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnNvcnRfdmFsdWVzKGJ5PSJmcmVxIiwgYXNjZW5kaW5nPUZhbHNlKQoKICAgIHBsdC5maWd1cmUoZmlnc2l6ZT0oMjAsIDEwKSkKICAgIHNucy5iYXJwbG90KHg9ImZyZXEiLCB5PSJmZWF0dXJlIiwgZGF0YT1mZWF0dXJlX2ltcCkKICAgIHBsdC50aXRsZSgiZmVhdHVyZXMiKQogICAgcGx0LnRpZ2h0X2xheW91dCgpCgogICAgZmlnID0gcGx0LmdjZigpCiAgICBvcy5tYWtlZGlycyhvcy5wYXRoLmpvaW4oY29udGV4dC5hcnRpZmFjdF9wYXRoLCAicGxvdHMiKSwgZXhpc3Rfb2s9VHJ1ZSkKICAgIGZpZy5zYXZlZmlnKG9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIGYicGxvdHMve2tleX0ue2ZtdH0iKSkKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdChmIntrZXl9LntmbXR9IiwgYm9keT1maWcpLCBsb2NhbF9wYXRoPWYicGxvdHMve2tleX0ue2ZtdH0iKQoKICAgICMgZmVhdHVyZSBpbXBvcnRhbmNlcyBhcmUgYWxzbyBzYXZlZCBhcyBhIHRhYmxlOgogICAgZmVhdHVyZV9pbXAudG9fY3N2KG9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIGtleSsiLmNzdiIpKQogICAgY29udGV4dC5sb2dfYXJ0aWZhY3Qoa2V5KyIuY3N2IiwgbG9jYWxfcGF0aD1rZXkrIi5jc3YiKQoKICAgIF9nY2ZfY2xlYXIocGx0KQoKZGVmIF9wbG90X2NvbmZ1c2lvbl9tYXRyaXgoeV90cnVlLCB5X3ByZWQsIGNsYXNzZXM9WyJuZWciLCAicG9zIl0sIAogICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY21hcD1wbHQuY20uQmx1ZXMpOgogICAgIiIiVGhpcyBjYW4gYmUgZGVwcmVjYXRlZCBvbmNlIGludGVsIHB5dGhvbiB1cGdyYWRlcyBzY2lraXQtbGVhcm4gdG8gPjAuMjIKICAgIAogICAgVGhpcyBmdW5jdGlvbiBwcmludHMgYW5kIHBsb3RzIHRoZSBjb25mdXNpb24gbWF0cml4LgogICAgTm9ybWFsaXphdGlvbiBjYW4gYmUgYXBwbGllZCBieSBzZXR0aW5nIGBub3JtYWxpemU9VHJ1ZWAuCiAgICAKICAgIGh0dHBzOi8vc2Npa2l0LWxlYXJuLm9yZy8wLjIxL2F1dG9fZXhhbXBsZXMvbW9kZWxfc2VsZWN0aW9uL3Bsb3RfY29uZnVzaW9uX21hdHJpeC5odG1sI3NwaHgtZ2xyLWF1dG8tZXhhbXBsZXMtbW9kZWwtc2VsZWN0aW9uLXBsb3QtY29uZnVzaW9uLW1hdHJpeC1weQogICAgIiIiCiAgICBpZiBub3QgdGl0bGU6CiAgICAgICAgaWYgbm9ybWFsaXplOgogICAgICAgICAgICB0aXRsZSA9ICJOb3JtYWxpemVkIGNvbmZ1c2lvbiBtYXRyaXgiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdGl0bGUgPSAiQ29uZnVzaW9uIG1hdHJpeCwgd2l0aG91dCBub3JtYWxpemF0aW9uIgoKICAgICMgQ29tcHV0ZSBjb25mdXNpb24gbWF0cml4CiAgICBjbSA9IGNvbmZ1c2lvbl9tYXRyaXgoeV90cnVlLCB5X3ByZWQpCiAgICAjIE9ubHkgdXNlIHRoZSBsYWJlbHMgdGhhdCBhcHBlYXIgaW4gdGhlIGRhdGEKICAgICNjbGFzc2VzID0gY2xhc3Nlc1t1bmlxdWVfbGFiZWxzKHlfdHJ1ZSwgeV9wcmVkKV0KICAgIGlmIG5vcm1hbGl6ZToKICAgICAgICBjbSA9IGNtLmFzdHlwZSgiZmxvYXQiKSAvIGNtLnN1bShheGlzPTEpWzosIG5wLm5ld2F4aXNdCgogICAgZmlnLCBheCA9IHBsdC5zdWJwbG90cygpCiAgICBpbSA9IGF4Lmltc2hvdyhjbSwgaW50ZXJwb2xhdGlvbj0ibmVhcmVzdCIsIGNtYXA9Y21hcCkKICAgIGF4LmZpZ3VyZS5jb2xvcmJhcihpbSwgYXg9YXgpCiAgICAjIFdlIHdhbnQgdG8gc2hvdyBhbGwgdGlja3MuLi4KICAgIGF4LnNldCh4dGlja3M9bnAuYXJhbmdlKGNtLnNoYXBlWzFdKSwKICAgICAgICAgICB5dGlja3M9bnAuYXJhbmdlKGNtLnNoYXBlWzBdKSwKICAgICAgICAgICAjIC4uLiBhbmQgbGFiZWwgdGhlbSB3aXRoIHRoZSByZXNwZWN0aXZlIGxpc3QgZW50cmllcwogICAgICAgICAgIHh0aWNrbGFiZWxzPWNsYXNzZXMsIHl0aWNrbGFiZWxzPWNsYXNzZXMsCiAgICAgICAgICAgdGl0bGU9dGl0bGUsCiAgICAgICAgICAgeWxhYmVsPSJUcnVlIGxhYmVsIiwKICAgICAgICAgICB4bGFiZWw9IlByZWRpY3RlZCBsYWJlbCIpCgogICAgIyBSb3RhdGUgdGhlIHRpY2sgbGFiZWxzIGFuZCBzZXQgdGhlaXIgYWxpZ25tZW50LgogICAgcGx0LnNldHAoYXguZ2V0X3h0aWNrbGFiZWxzKCksIHJvdGF0aW9uPTQ1LCBoYT0icmlnaHQiLAogICAgICAgICAgICAgcm90YXRpb25fbW9kZT0iYW5jaG9yIikKCiAgICAjIExvb3Agb3ZlciBkYXRhIGRpbWVuc2lvbnMgYW5kIGNyZWF0ZSB0ZXh0IGFubm90YXRpb25zLgogICAgZm10ID0gIi4yZiIgaWYgbm9ybWFsaXplIGVsc2UgImQiCiAgICB0aHJlc2ggPSBjbS5tYXgoKSAvIDIuCiAgICBmb3IgaSBpbiByYW5nZShjbS5zaGFwZVswXSk6CiAgICAgICAgZm9yIGogaW4gcmFuZ2UoY20uc2hhcGVbMV0pOgogICAgICAgICAgICBheC50ZXh0KGosIGksIGZvcm1hdChjbVtpLCBqXSwgZm10KSwKICAgICAgICAgICAgICAgICAgICBob3Jpem9udGFsYWxpZ25tZW50PSJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPSJ3aGl0ZSIgaWYgY21baSwgal0gPiB0aHJlc2ggZWxzZSAiYmxhY2siKQogICAgZmlnLnRpZ2h0X2xheW91dCgpCiAgICByZXR1cm4gYXggICAg
    commands: []
    code_origin: /User/functions/test_classifier/function.yaml
