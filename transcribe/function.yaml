kind: job
metadata:
  name: transcribe
  tag: ''
  hash: e7f85ec6e204a54069b4e264003cf59d0cb27bfe
  project: ''
  labels:
    author: yonatans
  categories:
  - data-preparation
  - machine-learning
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAojCiMgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQojIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiMgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiMgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAojIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgoKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG9wZXJhdG9yCmltcG9ydCBwYXRobGliCmZyb20gZnVuY3Rvb2xzIGltcG9ydCByZWR1Y2UsIHdyYXBzCmZyb20gdHlwaW5nIGltcG9ydCBBbnksIERpY3QsIExpc3QsIExpdGVyYWwsIE5hbWVkVHVwbGUsIFR1cGxlLCBVbmlvbgoKaW1wb3J0IGZhc3Rlcl93aGlzcGVyCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSB0cWRtIGltcG9ydCB0cWRtCgojIEdldCB0aGUgZ2xvYmFsIGxvZ2dlcjoKX0xPR0dFUiA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCkKCgpkZWYgb3Blbl9tcGlfaGFuZGxlcigKICAgIHdvcmtlcl9pbnB1dHM6IExpc3Rbc3RyXSwgcm9vdF93b3JrZXJfaW5wdXRzOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKToKICAgIGdsb2JhbCBfTE9HR0VSCgogICAgIyBDaGVjayBmb3IgTUxSdW4gYW5kIE9wZW5NUEkgYXZhaWxhYmlsaXR5OgogICAgY29udGV4dCwgY29tbSA9IF9jaGVja19tbHJ1bl9hbmRfb3Blbl9tcGkoKQoKICAgICMgQ2hlY2sgaWYgTUxSdW4gaXMgYXZhaWxhYmxlLCBzZXQgdGhlIGdsb2JhbCBsb2dnZXIgdG8gTUxSdW4nczoKICAgIGlmIGNvbnRleHQ6CiAgICAgICAgX0xPR0dFUiA9IGNvbnRleHQubG9nZ2VyCgogICAgZGVmIGRlY29yYXRvcihoYW5kbGVyKToKICAgICAgICBpZiBjb21tIGlzIE5vbmUgb3IgY29tbS5HZXRfc2l6ZSgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVyCgogICAgICAgIEB3cmFwcyhoYW5kbGVyKQogICAgICAgIGRlZiB3cmFwcGVyKCoqa3dhcmdzKToKICAgICAgICAgICAgIyBHZXQgdGhlIG9wZW4gbXBpIGVudmlyb25tZW50IHByb3BlcnRpZXM6CiAgICAgICAgICAgIHNpemUgPSBjb21tLkdldF9zaXplKCkKICAgICAgICAgICAgcmFuayA9IGNvbW0uR2V0X3JhbmsoKQoKICAgICAgICAgICAgIyBHaXZlIHRoZSBjb3JyZWN0IGNodW5rIG9mIHRoZSB3b3JrZXJzIGlucHV0czoKICAgICAgICAgICAgZm9yIHdvcmtlcl9pbnB1dCBpbiB3b3JrZXJfaW5wdXRzOgogICAgICAgICAgICAgICAgaW5wdXRfYXJndW1lbnQgPSBrd2FyZ3Nbd29ya2VyX2lucHV0XQogICAgICAgICAgICAgICAgaWYgaW5wdXRfYXJndW1lbnQgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpbnB1dF9hcmd1bWVudCwgc3RyKToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IF9nZXRfYXVkaW9fZmlsZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFfcGF0aD1wYXRobGliLlBhdGgoaW5wdXRfYXJndW1lbnQpLmFic29sdXRlKCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBsZW4oaW5wdXRfYXJndW1lbnQpIDwgc2l6ZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICBmIkNhbm5vdCBzcGxpdCB0aGUgaW5wdXQgJ3t3b3JrZXJfaW5wdXR9JyBvZiBsZW5ndGgge2xlbihpbnB1dF9hcmd1bWVudCl9IHRvIHtzaXplfSB3b3JrZXJzLiAiCiAgICAgICAgICAgICAgICAgICAgICAgIGYiUGxlYXNlIHJlZHVjZSB0aGUgYW1vdW50IG9mIHdvcmtlcnMgZm9yIHRoaXMgaW5wdXQuIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGV2ZW5fY2h1bmtfc2l6ZSA9IGxlbihpbnB1dF9hcmd1bWVudCkgLy8gc2l6ZQogICAgICAgICAgICAgICAgY2h1bmtfc3RhcnQgPSByYW5rICogZXZlbl9jaHVua19zaXplCiAgICAgICAgICAgICAgICBjaHVua19lbmQgPSAoCiAgICAgICAgICAgICAgICAgICAgKHJhbmsgKyAxKSAqIGV2ZW5fY2h1bmtfc2l6ZQogICAgICAgICAgICAgICAgICAgIGlmIHJhbmsgKyAxIDwgc2l6ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgbGVuKGlucHV0X2FyZ3VtZW50KQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICAgICBmIlJhbmsgI3tyYW5rfTogUHJvY2Vzc2luZyBpbnB1dCBjaHVuayBvZiAne3dvcmtlcl9pbnB1dH0nICIKICAgICAgICAgICAgICAgICAgICBmImZyb20gaW5kZXgge2NodW5rX3N0YXJ0fSB0byB7Y2h1bmtfZW5kfS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGlucHV0X2FyZ3VtZW50LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IGlucHV0X2FyZ3VtZW50W2NodW5rX3N0YXJ0OmNodW5rX2VuZF0KICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShpbnB1dF9hcmd1bWVudCwgcGQuRGF0YUZyYW1lKToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IGlucHV0X2FyZ3VtZW50Lmlsb2NbY2h1bmtfc3RhcnQ6Y2h1bmtfZW5kOiwgOl0KICAgICAgICAgICAgICAgIGt3YXJnc1t3b3JrZXJfaW5wdXRdID0gaW5wdXRfYXJndW1lbnQKCiAgICAgICAgICAgICMgU2V0IHRoZSByb290IHdvcmtlciBvbmx5IGFyZ3VtZW50czoKICAgICAgICAgICAgaWYgcmFuayA9PSAwIGFuZCByb290X3dvcmtlcl9pbnB1dHM6CiAgICAgICAgICAgICAgICBrd2FyZ3MudXBkYXRlKHJvb3Rfd29ya2VyX2lucHV0cykKCiAgICAgICAgICAgICMgUnVuIHRoZSB3b3JrZXI6CiAgICAgICAgICAgIG91dHB1dCA9IGhhbmRsZXIoKiprd2FyZ3MpCgogICAgICAgICAgICAjIFNlbmQgdGhlIG91dHB1dCB0byB0aGUgcm9vdCByYW5rIChyYW5rICMwKToKICAgICAgICAgICAgb3V0cHV0ID0gY29tbS5nYXRoZXIob3V0cHV0LCByb290PTApCiAgICAgICAgICAgIGlmIHJhbmsgPT0gMDoKICAgICAgICAgICAgICAgICMgSm9pbiB0aGUgb3V0cHV0czoKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkNvbGxlY3RpbmcgZGF0YSBmcm9tIHdvcmtlcnMgdG8gcm9vdCB3b3JrZXIuIikKICAgICAgICAgICAgICAgIG91dHB1dF9kaXJlY3RvcnkgPSBvdXRwdXRbMF1bMF0KICAgICAgICAgICAgICAgIGRhdGFmcmFtZSA9IHBkLmNvbmNhdChvYmpzPVtkZiBmb3IgXywgZGYsIF8gaW4gb3V0cHV0XSwgYXhpcz0wKQogICAgICAgICAgICAgICAgZXJyb3JzX2RpY3Rpb25hcnkgPSByZWR1Y2UoCiAgICAgICAgICAgICAgICAgICAgb3BlcmF0b3IuaW9yLCBbZXJyIGZvciBfLCBfLCBlcnIgaW4gb3V0cHV0XSwge30KICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXRfZGlyZWN0b3J5LCBkYXRhZnJhbWUsIGVycm9yc19kaWN0aW9uYXJ5CiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHJldHVybiB3cmFwcGVyCgogICAgcmV0dXJuIGRlY29yYXRvcgoKCmRlZiBfY2hlY2tfbWxydW5fYW5kX29wZW5fbXBpKCkgLT4gVHVwbGVbIm1scnVuLk1MQ2xpZW50Q3R4IiwgIm1waTRweS5NUEkuSW50cmFjb21tIl06CiAgICBpc19tcGkgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIGltcG9ydCBtbHJ1bgoKICAgICAgICBjb250ZXh0ID0gbWxydW4uZ2V0X29yX2NyZWF0ZV9jdHgobmFtZT0ibWxydW4iKQogICAgICAgIGlzX21waSA9IGNvbnRleHQubGFiZWxzLmdldCgia2luZCIsICJqb2IiKSA9PSAibXBpam9iIgoKICAgICAgICBpZiBpc19tcGk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZyb20gbXBpNHB5IGltcG9ydCBNUEkKCiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dCwgTVBJLkNPTU1fV09STEQKICAgICAgICAgICAgZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3IgYXMgbXBpNHB5X25vdF9mb3VuZDoKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmVycm9yKAogICAgICAgICAgICAgICAgICAgICJUbyBkaXN0cmlidXRlIHRoZSBmdW5jdGlvbiB1c2luZyBNTFJ1bidzICdtcGlqb2InIHlvdSBuZWVkIHRvIGhhdmUgYG1waTRweWAgcGFja2FnZSBpbiB5b3VyICIKICAgICAgICAgICAgICAgICAgICAiaW50ZXJwcmV0ZXIuIFBsZWFzZSBydW4gYHBpcCBpbnN0YWxsIG1waTRweWAgYW5kIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvcGVuLW1waS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByYWlzZSBtcGk0cHlfbm90X2ZvdW5kCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQsIE5vbmUKICAgIGV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yIGFzIG1vZHVsZV9ub3RfZm91bmQ6CiAgICAgICAgaWYgaXNfbXBpOgogICAgICAgICAgICByYWlzZSBtb2R1bGVfbm90X2ZvdW5kCiAgICByZXR1cm4gTm9uZSwgTm9uZQoKCkBvcGVuX21waV9oYW5kbGVyKHdvcmtlcl9pbnB1dHM9WyJkYXRhX3BhdGgiXSwgcm9vdF93b3JrZXJfaW5wdXRzPXsidmVyYm9zZSI6IFRydWV9KQpkZWYgdHJhbnNjcmliZSgKICAgIGRhdGFfcGF0aDogVW5pb25bc3RyLCBMaXN0W3N0cl1dLAogICAgb3V0cHV0X2RpcmVjdG9yeTogc3RyLAogICAgbW9kZWxfbmFtZTogc3RyID0gImJhc2UiLAogICAgZGV2aWNlOiBMaXRlcmFsWyJjdWRhIiwgImNwdSIsICJhdXRvIl0gPSAiYXV0byIsCiAgICBjb21wdXRlX3R5cGU6IHN0ciA9ICJkZWZhdWx0IiwKICAgIGxhbmd1YWdlOiBzdHIgPSBOb25lLAogICAgdHJhbnNsYXRlX3RvX2VuZ2xpc2g6IGJvb2wgPSBGYWxzZSwKICAgIHNwZWVjaF9kaWFyaXphdGlvbjogRGljdFtzdHIsIExpc3RbVHVwbGVbZmxvYXQsIGZsb2F0LCBzdHJdXV0gPSBOb25lLAogICAgYXVkaW9fZHVyYXRpb246IGJvb2wgPSBGYWxzZSwKICAgIGluaXRfa3dhcmdzOiBkaWN0ID0gTm9uZSwKICAgIHRyYW5zY3JpYmVfa3dhcmdzOiBkaWN0ID0gTm9uZSwKICAgIHZlcmJvc2U6IGJvb2wgPSBGYWxzZSwKKSAtPiBUdXBsZVtzdHIsIHBkLkRhdGFGcmFtZSwgZGljdF06CiAgICAiIiIKICAgIFRyYW5zY3JpYmUgYXVkaW8gZmlsZXMgaW50byB0ZXh0IGZpbGVzIGFuZCBjb2xsZWN0IGFkZGl0aW9uYWwgZGF0YS4gVGhlIGVuZCByZXN1bHQgaXMgYSBkaXJlY3Rvcnkgb2YgdHJhbnNjcmliZWQKICAgIHRleHQgZmlsZXMgYW5kIGEgZGF0YWZyYW1lIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBjb2x1bW5zOgoKICAgICogYXVkaW9fZmlsZSAtIFRoZSBhdWRpbyBmaWxlIHBhdGguCiAgICAqIHRyYW5zY3JpcHRpb25fZmlsZSAtIFRoZSB0cmFuc2NyaWJlZCB0ZXh0IGZpbGUgbmFtZSBpbiB0aGUgb3V0cHV0IGRpcmVjdG9yeS4KICAgICogbGFuZ3VhZ2UgLSBUaGUgZGV0ZWN0ZWQgbGFuZ3VhZ2UgaW4gdGhlIGF1ZGlvIGZpbGUuCiAgICAqIGxhbmd1YWdlX3Byb2JhYmlsaXR5IC0gVGhlIGRldGVjdGVkIGxhbmd1YWdlIHByb2JhYmlsaXR5LgogICAgKiBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbiAoaW4gc2Vjb25kcykgb2YgdGhlIGF1ZGlvIGZpbGUgKG9ubHkgaWYgYGF1ZGlvX2R1cmF0aW9uYCBpcyBzZXQgdG8gVHJ1ZSkuCgogICAgOnBhcmFtIGRhdGFfcGF0aDogICAgICAgICAgICAgICBBIGRpcmVjdG9yeSBvZiBhdWRpbyBmaWxlcyBvciBhIHNpbmdsZSBmaWxlIG9yIGEgbGlzdCBvZiBmaWxlcyB0byB0cmFuc2NyaWJlLgogICAgOnBhcmFtIG91dHB1dF9kaXJlY3Rvcnk6ICAgICAgICBQYXRoIHRvIGEgZGlyZWN0b3J5IHRvIHNhdmUgYWxsIHRyYW5zY3JpYmVkIGF1ZGlvIGZpbGVzLgogICAgOnBhcmFtIG1vZGVsX25hbWU6ICAgICAgICAgICAgICBPbmUgb2YgdGhlIG9mZmljaWFsIG1vZGVsIG5hbWVzIG9mIFdoaXNwZXI6IHsndGlueS5lbicsICd0aW55JywgJ2Jhc2UuZW4nLCAnYmFzZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzbWFsbC5lbicsICdzbWFsbCcsICdtZWRpdW0uZW4nLCAnbWVkaXVtJywgJ2xhcmdlLXYxJywgJ2xhcmdlLXYyJywgJ2xhcmdlJ30gb3IgYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsIG5hbWUgb2YgYSBmaW5lLXR1bmVkIHdoaXNwZXIgbW9kZWwgZnJvbSB0aGUgaHVnZ2luZ2ZhY2UgaHViLgogICAgOnBhcmFtIGRldmljZTogICAgICAgICAgICAgICAgICBEZXZpY2UgdG8gbG9hZCB0aGUgbW9kZWwuIENhbiBiZSBvbmUgb2YgeyJjdWRhIiwgImNwdSJ9LiBEZWZhdWx0IHdpbGwgcHJlZmVyICJjdWRhIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBhdmFpbGFibGUuIFRvIHVzZSBhIHNwZWNpZmljIEdQVSBvciBtb3JlIHRoYW4gb25lIEdQVSwgcGFzcyB0aGUgYGRldmljZV9pbmRleGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJndW1lbnQgdmlhIHRoZSBgaW5pdF9rd2FyZ3NgLgogICAgOnBhcmFtIGNvbXB1dGVfdHlwZTogICAgICAgICAgICBUaGUgZGF0YSB0eXBlIHRvIHVzZSBmb3IgY29tcHV0YXRpb24uIEZvciBtb3JlIGluZm9ybWF0aW9uLCBjaGVjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwczovL29wZW5ubXQubmV0L0NUcmFuc2xhdGUyL3F1YW50aXphdGlvbi5odG1sLiBEZWZhdWx0OiAiZGVmYXVsdCIgLSB3aWxsIHVzZSB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCB0eXBlIGRlcGVuZGluZyBvbiB0aGUgZGV2aWNlIHVzZWQuCiAgICA6cGFyYW0gbGFuZ3VhZ2U6ICAgICAgICAgICAgICAgIFRoZSBzcG9rZW4gbGFuZ3VhZ2UgdG8gZm9yY2UgV2hpc3BlciB0aGUgb3V0cHV0IGxhbmd1YWdlLiBJZiBOb25lLCB0aGUgV2hpc3BlciBtb2RlbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGF1dG9tYXRpY2FsbHkgcHJlZGljdCB0aGUgb3V0cHV0IGxhbmdhdWdlLiBEZWZhdWx0OiBOb25lLgogICAgOnBhcmFtIHRyYW5zbGF0ZV90b19lbmdsaXNoOiAgICBXaGV0aGVyIHRvIHRyYW5zbGF0ZSB0aGUgRW5nbGlzaCBwb3N0IHRyYW5zY3JpcHRpb24uIERlZmF1bHQ6IEZhbHNlLgogICAgOnBhcmFtIHNwZWVjaF9kaWFyaXphdGlvbjogICAgICBBIHNwZWVjaCBkaWFyaXphdGlvbiBkaWN0aW9uYXJ5IHdpdGggdGhlIGZpbGUgbmFtZXMgdG8gdHJhbnNjcmliZSBhcyBrZXlzIGFuZCB0aGVpcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFyaXphdGlvbiBhcyB2YWx1ZS4gVGhlIGRpYXJpemF0aW9uIGlzIGEgbGlzdCBvZiB0dXBsZXM6IChzdGFydCwgZW5kLCBzcGVha2VyKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHRyYW5zY3JpcHRpb24gcmVzdWx0IHdpbGwgYmUgaW4gdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ7c3BlYWtlcn06IHRleHQgdGV4dCB0ZXh0LiIuIEZpbGVzIHdpdGggbWlzc2luZyBkaWFyaXphdGlvbnMgd2lsbCBwcmludCBhIHdhcm5pbmcuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBheSBhdHRlbnRpb24gdGhlIGRpYXJpemF0aW9uIG11c3QgYmUgZm9yIHRoZSBlbnRpcmUgZHVyYXRpb24gb2YgdGhlIGF1ZGlvIGZpbGUgKGFzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvbmcgYXMgV2hpc3BlciBpcyBwcmVkaWN0aW5nIHdvcmRzIHVwIHVudGlsIHRoZW4pLgogICAgOnBhcmFtIGF1ZGlvX2R1cmF0aW9uOiAgICAgICAgICBXaGV0aGVyIHRvIGluY2x1ZGUgdGhlIGF1ZGlvIGZpbGVzIGR1cmF0aW9uIChpbiBzZWNvbmRzKS4gVGhlIGVzdGltYXRlZCBkdXJhdGlvbiBpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tIGJpdHJhdGUgYW5kIG1heSBiZSBpbmFjY3VyYXRlLiBEZWZhdWx0OiBGYWxzZS4KICAgIDpwYXJhbSBpbml0X2t3YXJnczogICAgICAgICAgICAgQWRkaXRpb25hbCBgV2hpc3Blck1vZGVsLl9faW5pdF9fYCBrZXl3b3JkIGFyZ3VtZW50cyB0byB1c2UuCiAgICA6cGFyYW0gdHJhbnNjcmliZV9rd2FyZ3M6ICAgICAgIEFkZGl0aW9uYWwgYFdoaXNwZXJNb2RlbC50cmFuc2NyaWJlYCBrZXl3b3JkIGFyZ3VtZW50cyB0byB1c2UuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgICAgIFdoZXRoZXIgdG8gcHJlc2VudCBsb2dzIG9mIGEgcHJvZ3Jlc3MgYmFyIGFuZCBlcnJvcnMuIERlZmF1bHQ6IEZhbHNlLgoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgoKICAgICAgICAgICAgICAqIFBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkuCiAgICAgICAgICAgICAgKiBBIGRhdGFmcmFtZSBkYXRhc2V0IG9mIHRoZSB0cmFuc2NyaWJlZCBmaWxlIG5hbWVzLgogICAgICAgICAgICAgICogQSBkaWN0aW9uYXJ5IG9mIGVycm9yZWQgZmlsZXMgdGhhdCB3ZXJlIG5vdCB0cmFuc2NyaWJlZC4KICAgICIiIgogICAgZ2xvYmFsIF9MT0dHRVIKCiAgICAjIEdldCB0aGUgaW5wdXQgYXVkaW8gZmlsZXMgdG8gdHJhbnNjcmliZToKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJDb2xsZWN0aW5nIGF1ZGlvIGZpbGVzLiIpCiAgICBpZiBpc2luc3RhbmNlKGRhdGFfcGF0aCwgc3RyKToKICAgICAgICBkYXRhX3BhdGggPSBwYXRobGliLlBhdGgoZGF0YV9wYXRoKS5hYnNvbHV0ZSgpCiAgICAgICAgYXVkaW9fZmlsZXMgPSBfZ2V0X2F1ZGlvX2ZpbGVzKGRhdGFfcGF0aD1kYXRhX3BhdGgpCiAgICBlbHNlOgogICAgICAgIGF1ZGlvX2ZpbGVzID0gZGF0YV9wYXRoCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIkNvbGxlY3RlZCB7bGVuKGF1ZGlvX2ZpbGVzKX0gYXVkaW8gZmlsZXMuIikKCiAgICAjIExvYWQgdGhlIHdoaXNwZXIgbW9kZWw6CiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIkxvYWRpbmcgbW9kZWwgJ3ttb2RlbF9uYW1lfScgLSB1c2luZyBkZXZpY2UgJ3tkZXZpY2V9Jy4iKQogICAgaW5pdF9rd2FyZ3MgPSBpbml0X2t3YXJncyBvciB7fQogICAgbW9kZWwgPSBmYXN0ZXJfd2hpc3Blci5XaGlzcGVyTW9kZWwoCiAgICAgICAgbW9kZWxfc2l6ZV9vcl9wYXRoPW1vZGVsX25hbWUsCiAgICAgICAgZGV2aWNlPWRldmljZSwKICAgICAgICBjb21wdXRlX3R5cGU9Y29tcHV0ZV90eXBlLAogICAgICAgICoqaW5pdF9rd2FyZ3MsCiAgICApCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIk1vZGVsIGxvYWRlZCBzdWNjZXNzZnVsbHkuIikKCiAgICAjIFByZXBhcmUgdGhlIHN1Y2Nlc3NlcyBkYXRhZnJhbWUgYW5kIGVycm9ycyBkaWN0aW9uYXJ5IHRvIGJlIHJldHVybmVkOgogICAgc3VjY2Vzc2VzID0gW10KICAgIGVycm9ycyA9IHt9CgogICAgIyBDcmVhdGUgdGhlIG91dHB1dCBkaXJlY3Rvcnk6CiAgICBvdXRwdXRfZGlyZWN0b3J5ID0gcGF0aGxpYi5QYXRoKG91dHB1dF9kaXJlY3RvcnkpCiAgICBvdXRwdXRfZGlyZWN0b3J5Lm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKCiAgICAjIFByZXBhcmUgdGhlIHRyYW5zY3JpYmUga2V5d29yZCBhcmd1bWVudHM6CiAgICB0cmFuc2NyaWJlX2t3YXJncyA9IHRyYW5zY3JpYmVfa3dhcmdzIG9yIHt9CiAgICB0cmFuc2NyaWJlX2t3YXJnc1sibGFuZ3VhZ2UiXSA9IGxhbmd1YWdlCiAgICB0cmFuc2NyaWJlX2t3YXJnc1sidGFzayJdID0gInRyYW5zbGF0ZSIgaWYgdHJhbnNsYXRlX3RvX2VuZ2xpc2ggZWxzZSAidHJhbnNjcmliZSIKCiAgICAjIEdvIG92ZXIgdGhlIGF1ZGlvIGZpbGVzIGFuZCB0cmFuc2NyaWJlOgogICAgZm9yIGF1ZGlvX2ZpbGUgaW4gdHFkbSgKICAgICAgICBhdWRpb19maWxlcywgZGVzYz0iVHJhbnNjcmliaW5nIiwgdW5pdD0iZmlsZSIsIGRpc2FibGU9bm90IHZlcmJvc2UKICAgICk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRyYW5zY3JpYmU6CiAgICAgICAgICAgIHRyYW5zY3JpcHRpb25fYW5kX2luZm8gPSBfdHJhbnNjcmliZSgKICAgICAgICAgICAgICAgIGF1ZGlvX2ZpbGU9YXVkaW9fZmlsZSwKICAgICAgICAgICAgICAgIG1vZGVsPW1vZGVsLAogICAgICAgICAgICAgICAgdHJhbnNjcmliZV9rd2FyZ3M9dHJhbnNjcmliZV9rd2FyZ3MsCiAgICAgICAgICAgICAgICBzcGVlY2hfZGlhcml6YXRpb249X2dldF9kaWFyaXphdGlvbiggICMgR2V0IHRoZSBkaWFyaXphdGlvbiAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgICAgICAgIHNwZWVjaF9kaWFyaXphdGlvbj1zcGVlY2hfZGlhcml6YXRpb24sCiAgICAgICAgICAgICAgICAgICAgZmlsZV9uYW1lPWF1ZGlvX2ZpbGUubmFtZSwKICAgICAgICAgICAgICAgICAgICB2ZXJib3NlPXZlcmJvc2UsCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgYXVkaW9fZHVyYXRpb249YXVkaW9fZHVyYXRpb24sCiAgICAgICAgICAgICkKICAgICAgICAgICAgIyBXcml0ZSB0aGUgdHJhbnNjcmlwdGlvbiB0byBmaWxlOgogICAgICAgICAgICB0cmFuc2NyaXB0aW9uX2ZpbGUgPSBfc2F2ZV90b19maWxlKAogICAgICAgICAgICAgICAgdHJhbnNjcmlwdGlvbj10cmFuc2NyaXB0aW9uX2FuZF9pbmZvWzBdLAogICAgICAgICAgICAgICAgZmlsZV9uYW1lPWF1ZGlvX2ZpbGUuc3RlbSwKICAgICAgICAgICAgICAgIG91dHB1dF9kaXJlY3Rvcnk9b3V0cHV0X2RpcmVjdG9yeSwKICAgICAgICAgICAgKQogICAgICAgICAgICAjIE5vdGUgYXMgYSBzdWNjZXNzIGluIHRoZSBsaXN0OgogICAgICAgICAgICBzdWNjZXNzZXMuYXBwZW5kKAogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIGF1ZGlvX2ZpbGUubmFtZSwKICAgICAgICAgICAgICAgICAgICB0cmFuc2NyaXB0aW9uX2ZpbGUubmFtZSwKICAgICAgICAgICAgICAgICAgICAqdHJhbnNjcmlwdGlvbl9hbmRfaW5mb1sxOl0sCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBOb3RlIHRoZSBleGNlcHRpb24gYXMgZXJyb3IgaW4gdGhlIGRpY3Rpb25hcnk6CiAgICAgICAgICAgIGlmIHZlcmJvc2U6CiAgICAgICAgICAgICAgICBfTE9HR0VSLndhcm5pbmcoZiJFcnJvciBpbiBmaWxlOiAne2F1ZGlvX2ZpbGUubmFtZX0nIikKICAgICAgICAgICAgZXJyb3JzW3N0cihhdWRpb19maWxlLm5hbWUpXSA9IHN0cihleGNlcHRpb24pCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgIyBDb25zdHJ1Y3QgdGhlIHRyYW5zY3JpcHRpb25zIGRhdGFmcmFtZToKICAgIGNvbHVtbnMgPSBbCiAgICAgICAgImF1ZGlvX2ZpbGUiLAogICAgICAgICJ0cmFuc2NyaXB0aW9uX2ZpbGUiLAogICAgICAgICJsYW5ndWFnZSIsCiAgICAgICAgImxhbmd1YWdlX3Byb2JhYmlsaXR5IiwKICAgIF0KICAgIGlmIGF1ZGlvX2R1cmF0aW9uOgogICAgICAgIGNvbHVtbnMuYXBwZW5kKCJkdXJhdGlvbiIpCiAgICBzdWNjZXNzZXMgPSBwZC5EYXRhRnJhbWUoCiAgICAgICAgc3VjY2Vzc2VzLAogICAgICAgIGNvbHVtbnM9Y29sdW1ucywKICAgICkKCiAgICAjIFByaW50IHRoZSBoZWFkIG9mIHRoZSBwcm9kdWNlZCBkYXRhZnJhbWUgYW5kIHJldHVybjoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKAogICAgICAgICAgICBmIkRvbmUgKHtzdWNjZXNzZXMuc2hhcGVbMF19L3tsZW4oYXVkaW9fZmlsZXMpfSlcbiIKICAgICAgICAgICAgZiJUcmFuc2NyaXB0aW9ucyBzdW1tYXJ5OlxuIgogICAgICAgICAgICBmIntzdWNjZXNzZXMuaGVhZCgpfSIKICAgICAgICApCiAgICByZXR1cm4gc3RyKG91dHB1dF9kaXJlY3RvcnkpLCBzdWNjZXNzZXMsIGVycm9ycwoKCmRlZiBfZ2V0X2F1ZGlvX2ZpbGVzKAogICAgZGF0YV9wYXRoOiBwYXRobGliLlBhdGgsCikgLT4gTGlzdFtwYXRobGliLlBhdGhdOgogICAgIyBDaGVjayBpZiB0aGUgcGF0aCBpcyBvZiBhIGRpcmVjdG9yeSBvciBhIGZpbGU6CiAgICBpZiBkYXRhX3BhdGguaXNfZGlyKCk6CiAgICAgICAgIyBHZXQgYWxsIGZpbGVzIGluc2lkZSB0aGUgZGlyZWN0b3J5OgogICAgICAgIGF1ZGlvX2ZpbGVzID0gbGlzdChkYXRhX3BhdGguZ2xvYigiKi4qIikpCiAgICBlbGlmIGRhdGFfcGF0aC5pc19maWxlKCk6CiAgICAgICAgYXVkaW9fZmlsZXMgPSBbZGF0YV9wYXRoXQogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICBmIlVucmVjb2duaXplZCBkYXRhIHBhdGguIFRoZSBwYXJhbWV0ZXIgYGRhdGFfcGF0aGAgbXVzdCBiZSBlaXRoZXIgYSBkaXJlY3RvcnkgcGF0aCBvciBhIGZpbGUgcGF0aC4gIgogICAgICAgICAgICBmIkdpdmVuOiB7c3RyKGRhdGFfcGF0aCl9ICIKICAgICAgICApCgogICAgcmV0dXJuIGF1ZGlvX2ZpbGVzCgoKY2xhc3MgX0RpYXJpemF0aW9uU2VnbWVudChOYW1lZFR1cGxlKToKICAgIHN0YXJ0OiBmbG9hdAogICAgZW5kOiBmbG9hdAogICAgc3BlYWtlcjogc3RyCgoKZGVmIF9nZXRfZGlhcml6YXRpb24oCiAgICBzcGVlY2hfZGlhcml6YXRpb246IERpY3Rbc3RyLCBMaXN0W1R1cGxlW2Zsb2F0LCBmbG9hdCwgc3RyXV1dLAogICAgZmlsZV9uYW1lOiBzdHIsCiAgICB2ZXJib3NlOiBib29sLAopIC0+IFVuaW9uW0xpc3RbX0RpYXJpemF0aW9uU2VnbWVudF0sIE5vbmVdOgogICAgZGlhcml6YXRpb24gPSBOb25lCiAgICBpZiBzcGVlY2hfZGlhcml6YXRpb24gaXMgbm90IE5vbmU6CiAgICAgICAgZGlhcml6YXRpb24gPSBzcGVlY2hfZGlhcml6YXRpb24uZ2V0KGZpbGVfbmFtZSkKICAgICAgICBpZiBkaWFyaXphdGlvbiBpcyBOb25lOgogICAgICAgICAgICBpZiB2ZXJib3NlOgogICAgICAgICAgICAgICAgX0xPR0dFUi53YXJuaW5nKAogICAgICAgICAgICAgICAgICAgIGYiTWlzc2luZyBzcGVlY2ggZGlhcml6YXRpb24gZm9yIHRoZSBhdWRpbyBmaWxlICd7ZmlsZV9uYW1lfScuIENvbnRpbnVpbmcgdHJhbnNjcmliaW5nIHdpdGhvdXQgIgogICAgICAgICAgICAgICAgICAgIGYiZGlhcml6YXRpb24uIgogICAgICAgICAgICAgICAgKQogICAgICAgIGRpYXJpemF0aW9uID0gW19EaWFyaXphdGlvblNlZ21lbnQoKnNlZ21lbnQpIGZvciBzZWdtZW50IGluIGRpYXJpemF0aW9uXQogICAgcmV0dXJuIGRpYXJpemF0aW9uCgoKZGVmIF9nZXRfbmV4dF9kaWFyaXphdGlvbl9zZWdtZW50KAogICAgd29yZDogZmFzdGVyX3doaXNwZXIudHJhbnNjcmliZS5Xb3JkLAogICAgc3BlZWNoX2RpYXJpemF0aW9uOiBMaXN0W19EaWFyaXphdGlvblNlZ21lbnRdLAogICAgbGFzdF9jaG9zZW5faW5kZXg6IGludCwKKSAtPiBpbnQ6CiAgICAjIEdldCB0aGUgbGFzdCBjaG9zZW4gZGlhcml6YXRpb24gc2VnbWVudDoKICAgIGxhc3RfY2hvc2VuID0gc3BlZWNoX2RpYXJpemF0aW9uW2xhc3RfY2hvc2VuX2luZGV4XQoKICAgICMgSWYgdGhlIGxhc3QgY2hvc2VuIHNlZ21lbnQgaXMgdGhlIGxhc3Qgc2VnbWVudCwgcmV0dXJuIGl0OgogICAgaWYgbGFzdF9jaG9zZW5faW5kZXggPT0gbGVuKHNwZWVjaF9kaWFyaXphdGlvbikgLSAxOgogICAgICAgIHJldHVybiBsYXN0X2Nob3Nlbl9pbmRleAoKICAgICMgSWYgdGhlIHdvcmQgZW5kcyBiZWZvcmUgdGhlIGxhc3QgY2hvc2VuIHNlZ21lbnQ6CiAgICBpZiB3b3JkLmVuZCA8PSBsYXN0X2Nob3Nlbi5zdGFydDoKICAgICAgICAjIFRoZW4gaXQgaXMgc3RpbGwgdGhlIGNsb3Nlc3Qgc2VnbWVudAogICAgICAgIHJldHVybiBsYXN0X2Nob3Nlbl9pbmRleAoKICAgICMgV2UgY2hlY2sgaWYgaXQgZW5kcyBpbnNpZGUgdGhlIGxhc3QgY2hvc2VuIHNlZ21lbnQ6CiAgICBpZiB3b3JkLmVuZCA8IGxhc3RfY2hvc2VuLmVuZDoKICAgICAgICAjIFRoZW4gaXQgc3RpbGwgaXMgdGhlIGNsb3Nlc3Qgc2VnbWVudAogICAgICAgIHJldHVybiBsYXN0X2Nob3Nlbl9pbmRleAoKICAgICMgVGhlIHdvcmQgZW5kcyBhZnRlciB0aGUgc2VnbWVudCwgd2UgbmVlZCB0byBjb2xsZWN0IGFsbCBuZXh0IHNlZ21lbnRzIHVwIHVudGlsIHRoZSB3b3JkIGVuZHMgYmVmb3JlIHRoZW06CiAgICBwb3NzaWJsZV9zZWdtZW50cyA9IFtsYXN0X2Nob3Nlbl9pbmRleF0KICAgIGZvciBpIGluIHJhbmdlKGxhc3RfY2hvc2VuX2luZGV4ICsgMSwgbGVuKHNwZWVjaF9kaWFyaXphdGlvbikpOgogICAgICAgIGlmIHdvcmQuZW5kID4gc3BlZWNoX2RpYXJpemF0aW9uW2ldLmVuZDoKICAgICAgICAgICAgcG9zc2libGVfc2VnbWVudHMuYXBwZW5kKGkpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgcG9zc2libGVfc2VnbWVudHMuYXBwZW5kKGkpCiAgICAgICAgYnJlYWsKCiAgICAjIENoZWNrIGZvciB0aGUgbW9zdCBvdmVybGFwcGluZyBvcHRpb246CiAgICBiZXN0X292ZXJsYXAgPSAwCiAgICBvdmVybGFwcGluZ19zZWdtZW50ID0gTm9uZQogICAgZm9yIGkgaW4gcG9zc2libGVfc2VnbWVudHM6CiAgICAgICAgb3ZlcmxhcCA9IDAKICAgICAgICAjIElmIHRoZSB3b3JkIHN0YXJ0cyBiZWZvcmUgc2VnbWVudDoKICAgICAgICBpZiB3b3JkLnN0YXJ0IDw9IHNwZWVjaF9kaWFyaXphdGlvbltpXS5zdGFydDoKICAgICAgICAgICAgIyBJZiBpdCBlbmRzIGJlZm9yZSB0aGUgc2VnbWVudCwgdGhlcmUgaXMgYW4gb3ZlcmxhcCBmcm9tIHRoZSBzdGFydCBvZiB0aGUgc2VnbWVudCB0byB0aGUgZW5kIG9mIHRoZSB3b3JkOgogICAgICAgICAgICBpZiB3b3JkLmVuZCA8IHNwZWVjaF9kaWFyaXphdGlvbltpXS5lbmQ6CiAgICAgICAgICAgICAgICBvdmVybGFwID0gd29yZC5lbmQgLSBzcGVlY2hfZGlhcml6YXRpb25baV0uc3RhcnQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGhlIHdvcmQgaXMgd3JhcHBpbmcgdGhlIHNlZ21lbnQsIHRoZSBvdmVybGFwIGlzIHRoZSBzZWdtZW50J3MgbGVuZ3RoOgogICAgICAgICAgICAgICAgb3ZlcmxhcCA9IHNwZWVjaF9kaWFyaXphdGlvbltpXS5lbmQgLSBzcGVlY2hfZGlhcml6YXRpb25baV0uc3RhcnQKICAgICAgICAjIFRoZSB3b3JkIHN0YXJ0cyBpbiBzZWdtZW50LCBjaGVjayBpZiB0aGUgd29yZCBlbmRzIGluIGl0OgogICAgICAgIGVsaWYgd29yZC5lbmQgPCBzcGVlY2hfZGlhcml6YXRpb25baV0uZW5kOgogICAgICAgICAgICAjIFRoZSBvdmVybGFwIGlzIHRoZSB3b3JkJ3MgbGVuZ3RoOgogICAgICAgICAgICBvdmVybGFwID0gd29yZC5lbmQgLSB3b3JkLnN0YXJ0CiAgICAgICAgIyBUaGUgd29yZCBzdGFydCBpbiBzZWdtZW50IGJ1dCBlbmRzIGFmdGVyIGl0LCB0aGUgb3ZlcmxhcCBpcyBmcm9tIHRoZSB3b3JkJ3Mgc3RhcnQgdG8gdGhlIHNlZ21lbnQncyBlbmQ6CiAgICAgICAgZWxzZToKICAgICAgICAgICAgb3ZlcmxhcCA9IHNwZWVjaF9kaWFyaXphdGlvbltpXS5lbmQgLSB3b3JkLnN0YXJ0CiAgICAgICAgIyBDaGVjayBmb3IgbmV3IGJlc3Qgb3ZlcmxhcDoKICAgICAgICBpZiBvdmVybGFwID4gYmVzdF9vdmVybGFwOgogICAgICAgICAgICBiZXN0X292ZXJsYXAgPSBvdmVybGFwCiAgICAgICAgICAgIG92ZXJsYXBwaW5nX3NlZ21lbnQgPSBpCiAgICBpZiBvdmVybGFwcGluZ19zZWdtZW50IGlzIG5vdCBOb25lOgogICAgICAgIHJldHVybiBvdmVybGFwcGluZ19zZWdtZW50CgogICAgIyBJZiB0aGVyZSBpcyBubyBvdmVybGFwcGluZyBzZWdtZW50LCByZXR1cm4gdGhlIGNsb3Nlc3Qgc2VnbWVudDoKICAgIGJlc3RfZGlzdGFuY2UgPSBOb25lCiAgICBjbG9zZXN0X3NlZ21lbnQgPSBOb25lCiAgICBmb3IgaSBpbiBwb3NzaWJsZV9zZWdtZW50czoKICAgICAgICBkaXN0YW5jZSA9ICgKICAgICAgICAgICAgd29yZC5zdGFydCAtIHNwZWVjaF9kaWFyaXphdGlvbltpXS5lbmQKICAgICAgICAgICAgaWYgd29yZC5zdGFydCA+IHNwZWVjaF9kaWFyaXphdGlvbltpXS5lbmQKICAgICAgICAgICAgZWxzZSBzcGVlY2hfZGlhcml6YXRpb25baV0uc3RhcnQgLSB3b3JkLmVuZAogICAgICAgICkKICAgICAgICBpZiBiZXN0X2Rpc3RhbmNlIGlzIE5vbmUgb3IgZGlzdGFuY2UgPCBiZXN0X2Rpc3RhbmNlOgogICAgICAgICAgICBiZXN0X2Rpc3RhbmNlID0gZGlzdGFuY2UKICAgICAgICAgICAgY2xvc2VzdF9zZWdtZW50ID0gaQogICAgcmV0dXJuIGNsb3Nlc3Rfc2VnbWVudAoKCmRlZiBfY29uc3RydWN0X3RyYW5zY3JpcHRpb24oCiAgICBzZWdtZW50czogTGlzdFtmYXN0ZXJfd2hpc3Blci50cmFuc2NyaWJlLlNlZ21lbnRdLAogICAgc3BlZWNoX2RpYXJpemF0aW9uOiBMaXN0W19EaWFyaXphdGlvblNlZ21lbnRdLAopIC0+IHN0cjoKICAgICMgSWYgdGhlcmUgaXMgbm8gZGlhcml6YXRpb24sIGNvbmNhdGVuYXRlIGFsbCBzZWdtZW50cyBhbmQgcmV0dXJuOgogICAgaWYgc3BlZWNoX2RpYXJpemF0aW9uIGlzIE5vbmU6CiAgICAgICAgcmV0dXJuICIgIi5qb2luKFtzZWdtZW50LnRleHQgZm9yIHNlZ21lbnQgaW4gc2VnbWVudHNdKQoKICAgICMgVGhlcmUgaXMgYSBkaWFyaXphdGlvbiwgdHJ5IHRvIG1hdGNoIHRoZSBXaGlzcGVyIG1vZGVsIHByZWRpY3RlZCB0aW1lc3RhbXBzIHRvIHRoZSBjbG9zZXN0IGRpYXJpemF0aW9uIHNlZ21lbnQKICAgICMgKGNsb3Nlc3QgZGlhcml6YXRpb24gc2VnbWVudCB3aWxsIGJlIHRoZSBtb3N0IG92ZXJsYXBwaW5nIHdpdGggdGhlIHdvcmQsIGFuZCBpZiB0aGVyZSBpcyBubyBvdmVybGFwLCB0aGUgY2xvc2VzdAogICAgIyBzZWdtZW50IHRvIHRoZSB3b3JkKToKICAgIGRpYXJpemF0aW9uX2luZGV4ID0gMAogICAgc3BlYWtlciA9IHNwZWVjaF9kaWFyaXphdGlvbltkaWFyaXphdGlvbl9pbmRleF0uc3BlYWtlcgogICAgdGV4dCA9IGYie3NwZWFrZXJ9OiIKICAgIGZvciBzZWdtZW50IGluIHNlZ21lbnRzOgogICAgICAgIGZvciB3b3JkIGluIHNlZ21lbnQud29yZHM6CiAgICAgICAgICAgICMgR2V0IHRoZSBuZXh0IGRpYXJpemF0aW9uIHNlZ21lbnQ6CiAgICAgICAgICAgIGRpYXJpemF0aW9uX2luZGV4ID0gX2dldF9uZXh0X2RpYXJpemF0aW9uX3NlZ21lbnQoCiAgICAgICAgICAgICAgICB3b3JkPXdvcmQsCiAgICAgICAgICAgICAgICBzcGVlY2hfZGlhcml6YXRpb249c3BlZWNoX2RpYXJpemF0aW9uLAogICAgICAgICAgICAgICAgbGFzdF9jaG9zZW5faW5kZXg9ZGlhcml6YXRpb25faW5kZXgsCiAgICAgICAgICAgICkKICAgICAgICAgICAgIyBDaGVjayBpZiB0aGUgc2VnbWVudCBpcyBvZiB0aGUgc2FtZSBzcGVha2VyOgogICAgICAgICAgICBpZiBzcGVlY2hfZGlhcml6YXRpb25bZGlhcml6YXRpb25faW5kZXhdLnNwZWFrZXIgPT0gc3BlYWtlcjoKICAgICAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgd29yZDoKICAgICAgICAgICAgICAgIHRleHQgKz0gd29yZC53b3JkCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEFwcGVuZCBhIG5ld2xpbmUgYW5kIHVwZGF0ZSB0aGUgbmV3IHNwZWFrZXI6CiAgICAgICAgICAgICAgICBzcGVha2VyID0gc3BlZWNoX2RpYXJpemF0aW9uW2RpYXJpemF0aW9uX2luZGV4XS5zcGVha2VyCiAgICAgICAgICAgICAgICB0ZXh0ICs9IGYiXG57c3BlYWtlcn06e3dvcmQud29yZH0iCgogICAgcmV0dXJuIHRleHQKCgpkZWYgX3RyYW5zY3JpYmUoCiAgICBhdWRpb19maWxlOiBwYXRobGliLlBhdGgsCiAgICBtb2RlbDogZmFzdGVyX3doaXNwZXIuV2hpc3Blck1vZGVsLAogICAgdHJhbnNjcmliZV9rd2FyZ3M6IGRpY3QsCiAgICBzcGVlY2hfZGlhcml6YXRpb246IExpc3RbX0RpYXJpemF0aW9uU2VnbWVudF0sCiAgICBhdWRpb19kdXJhdGlvbjogYm9vbCwKKSAtPiBVbmlvbltUdXBsZVtzdHIsIHN0ciwgZmxvYXRdLCBUdXBsZVtzdHIsIHN0ciwgZmxvYXQsIGZsb2F0XV06CiAgICAjIFRyYW5zY3JpYmUgKFNlZ21lbnRzIGlzIGEgZ2VuZXJhdG9yLCBzbyB3ZSBjYXN0IHRvIGxpc3QgdG8gYmVnaW4gdHJhbnNjcmlwdGlvbiBmcm9tIHN0YXJ0IHRvIGVuZCk6CiAgICBzZWdtZW50cywgaW5mbyA9IG1vZGVsLnRyYW5zY3JpYmUoCiAgICAgICAgYXVkaW89c3RyKGF1ZGlvX2ZpbGUpLAogICAgICAgICoqdHJhbnNjcmliZV9rd2FyZ3MsCiAgICAgICAgd29yZF90aW1lc3RhbXBzPXNwZWVjaF9kaWFyaXphdGlvbiBpcyBub3QgTm9uZSwKICAgICkKICAgIHNlZ21lbnRzID0gbGlzdChzZWdtZW50cykKCiAgICAjIENoZWNrIGlmIHNwZWVjaCBkaWFyaXphdGlvbiB3YXMgcHJvdmlkZWQ6CiAgICBpZiBzcGVlY2hfZGlhcml6YXRpb24gaXMgTm9uZToKICAgICAgICB0ZXh0ID0gIiIuam9pbihbc2VnbWVudC50ZXh0IGZvciBzZWdtZW50IGluIHNlZ21lbnRzXSkKICAgIGVsc2U6CiAgICAgICAgdGV4dCA9IF9jb25zdHJ1Y3RfdHJhbnNjcmlwdGlvbigKICAgICAgICAgICAgc2VnbWVudHM9c2VnbWVudHMsCiAgICAgICAgICAgIHNwZWVjaF9kaWFyaXphdGlvbj1zcGVlY2hfZGlhcml6YXRpb24sCiAgICAgICAgKQogICAgdGV4dCA9IHRleHQuc3RyaXAoKQoKICAgICMgUmV0dXJuIHRoZSB0cmFuc2NyaXB0aW9uIHRleHQgYW5kIHRoZSBhZGRpdGlvbmFsIGluZm9ybWF0aW9uOgogICAgaWYgYXVkaW9fZHVyYXRpb246CiAgICAgICAgcmV0dXJuIHRleHQuc3RyaXAoKSwgaW5mby5sYW5ndWFnZSwgaW5mby5sYW5ndWFnZV9wcm9iYWJpbGl0eSwgaW5mby5kdXJhdGlvbgogICAgcmV0dXJuIHRleHQuc3RyaXAoKSwgaW5mby5sYW5ndWFnZSwgaW5mby5sYW5ndWFnZV9wcm9iYWJpbGl0eQoKCmRlZiBfc2F2ZV90b19maWxlKAogICAgdHJhbnNjcmlwdGlvbjogc3RyLCBmaWxlX25hbWU6IHN0ciwgb3V0cHV0X2RpcmVjdG9yeTogcGF0aGxpYi5QYXRoCikgLT4gcGF0aGxpYi5QYXRoOgogICAgIyBQcmVwYXJlIHRoZSBmaWxlIGZ1bGwgcGF0aCAoY2hlY2tpbmcgZm9yIG5vIGR1cGxpY2F0aW9ucyk6CiAgICB0cmFuc2NyaXB0aW9uX2ZpbGUgPSBvdXRwdXRfZGlyZWN0b3J5IC8gZiJ7ZmlsZV9uYW1lfS50eHQiCiAgICBpID0gMQogICAgd2hpbGUgdHJhbnNjcmlwdGlvbl9maWxlLmV4aXN0cygpOgogICAgICAgIGkgKz0gMQogICAgICAgIHRyYW5zY3JpcHRpb25fZmlsZSA9IG91dHB1dF9kaXJlY3RvcnkgLyBmIntmaWxlX25hbWV9X3tpfS50eHQiCgogICAgIyBNYWtlIHN1cmUgYWxsIGRpcmVjdG9yaWVzIGFyZSBjcmVhdGVkOgogICAgdHJhbnNjcmlwdGlvbl9maWxlLnBhcmVudC5ta2RpcihleGlzdF9vaz1UcnVlLCBwYXJlbnRzPVRydWUpCgogICAgIyBXcml0ZSB0byBmaWxlOgogICAgd2l0aCBvcGVuKHRyYW5zY3JpcHRpb25fZmlsZSwgInciKSBhcyBmcDoKICAgICAgICBmcC53cml0ZSh0cmFuc2NyaXB0aW9uKQoKICAgIHJldHVybiB0cmFuc2NyaXB0aW9uX2ZpbGUK
    base_image: mlrun/mlrun
    commands: []
    code_origin: ''
    origin_filename: ''
    requirements:
    - openai-whisper
    - tqdm
  entry_points:
    open_mpi_handler:
      name: open_mpi_handler
      doc: ''
      parameters:
      - name: worker_inputs
        type: List[str]
      - name: root_worker_inputs
        type: Dict[str, Any]
        default: null
      outputs:
      - default: ''
      lineno: 29
    decorator:
      name: decorator
      doc: ''
      parameters:
      - name: handler
      outputs:
      - default: ''
      lineno: 41
    wrapper:
      name: wrapper
      doc: ''
      parameters: []
      outputs:
      - default: ''
      lineno: 46
    transcribe:
      name: transcribe
      doc: 'Transcribe audio files into text files and collect additional data. The
        end result is a directory of transcribed

        text files and a dataframe containing the following columns:


        * audio_file - The audio file path.

        * transcription_file - The transcribed text file name in the output directory.

        * language - The detected language in the audio file.

        * language_probability - The detected language probability.

        * duration - The duration (in seconds) of the audio file (only if `audio_duration`
        is set to True).'
      parameters:
      - name: data_path
        type: Union[str, List[str]]
        doc: A directory of audio files or a single file or a list of files to transcribe.
      - name: output_directory
        type: str
        doc: Path to a directory to save all transcribed audio files.
      - name: model_name
        type: str
        doc: 'One of the official model names of Whisper: {''tiny.en'', ''tiny'',
          ''base.en'', ''base'', ''small.en'', ''small'', ''medium.en'', ''medium'',
          ''large-v1'', ''large-v2'', ''large''} or a full name of a fine-tuned whisper
          model from the huggingface hub.'
        default: base
      - name: device
        type: Literal[, , ]
        doc: Device to load the model. Can be one of {"cuda", "cpu"}. Default will
          prefer "cuda" if available. To use a specific GPU or more than one GPU,
          pass the `device_index` argument via the `init_kwargs`.
        default: auto
      - name: compute_type
        type: str
        doc: 'The data type to use for computation. For more information, check https://opennmt.net/CTranslate2/quantization.html.
          Default: "default" - will use the default type depending on the device used.'
        default: default
      - name: language
        type: str
        doc: 'The spoken language to force Whisper the output language. If None, the
          Whisper model will automatically predict the output langauge. Default: None.'
        default: null
      - name: translate_to_english
        type: bool
        doc: 'Whether to translate the English post transcription. Default: False.'
        default: false
      - name: speech_diarization
        type: Dict[str, List[Tuple[float, float, str]]]
        doc: 'A speech diarization dictionary with the file names to transcribe as
          keys and their diarization as value. The diarization is a list of tuples:
          (start, end, speaker). The transcription result will be in the following
          format: "{speaker}: text text text.". Files with missing diarizations will
          print a warning. Pay attention the diarization must be for the entire duration
          of the audio file (as long as Whisper is predicting words up until then).'
        default: null
      - name: audio_duration
        type: bool
        doc: 'Whether to include the audio files duration (in seconds). The estimated
          duration is from bitrate and may be inaccurate. Default: False.'
        default: false
      - name: init_kwargs
        type: dict
        doc: Additional `WhisperModel.__init__` keyword arguments to use.
        default: null
      - name: transcribe_kwargs
        type: dict
        doc: Additional `WhisperModel.transcribe` keyword arguments to use.
        default: null
      - name: verbose
        type: bool
        doc: 'Whether to present logs of a progress bar and errors. Default: False.'
        default: false
      outputs:
      - doc: 'A tuple of:'
        default: ''
      lineno: 135
  description: Transcribe audio files into text files
  default_handler: transcribe
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
