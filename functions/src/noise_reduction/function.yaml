metadata:
  tag: ''
  name: noise-reduction
  categories:
  - data-preparation
  - audio
verbose: false
kind: job
spec:
  image: ''
  disable_auto_mount: false
  build:
    origin_filename: ''
    functionSourceCode: aW1wb3J0IGxvZ2dpbmcKZnJvbSBhYmMgaW1wb3J0IEFCQ01ldGEsIGFic3RyYWN0bWV0aG9kCmZyb20gbXVsdGlwcm9jZXNzaW5nIGltcG9ydCBQcm9jZXNzLCBRdWV1ZQpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKCmltcG9ydCBsaWJyb3NhCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgdG9yY2gKZnJvbSBzY2lweS5pbyBpbXBvcnQgd2F2ZmlsZQpmcm9tIHRxZG0gaW1wb3J0IHRxZG0KCiM6IFRoZSB2YWx1ZSB0byBzZW5kIGludG8gbXVsdGlwcm9jZXNzaW5nIHF1ZXVlcyB0byBzdG9wIHRoZSBwcm9jZXNzOgpfTVVMVElQUk9DRVNTSU5HX1NUT1BfTUFSSyA9ICJTVE9QIgoKIyBHZXQgdGhlIGdsb2JhbCBsb2dnZXI6CnRyeToKICAgIGltcG9ydCBtbHJ1bgoKICAgIF9MT0dHRVIgPSBtbHJ1bi5nZXRfb3JfY3JlYXRlX2N0eCgibm9pc2VfcmVkdWNlIikubG9nZ2VyCmV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yOgogICAgX0xPR0dFUiA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCkKCgpjbGFzcyBSZWR1Y2VOb2lzZUJhc2UobWV0YWNsYXNzPUFCQ01ldGEpOgogICAgIiIiCiAgICBCYXNlIGNsYXNzIGZvciBub2lzZSByZWR1Y3Rpb24uCiAgICBUaGlzIGNsYXNzIGlzIGFpbWVkIHRvIGJlIGluaGVyaXRlZCBieSBzcGVjaWZpYyBub2lzZSByZWR1Y3Rpb24gYWxnb3JpdGhtcy4KICAgIFlvdSBtdXN0IGltcGxlbWVudCB0aGUgZm9sbG93aW5nIG1ldGhvZHM6CiAgICAtIGNsZWFuX2F1ZGlvOiAgVGhlIG1ldGhvZCB0byBjbGVhbiB0aGUgYXVkaW8sIHdoZXJlIHRoZSBub2lzZSByZWR1Y3Rpb24gYWxnb3JpdGhtIGlzIGltcGxlbWVudGVkLgogICAgLSBzYXZlX2F1ZGlvOiAgIFRoZSBtZXRob2QgdG8gc2F2ZSB0aGUgYXVkaW8gdG8gYSBmaWxlLgogICAgLSBsb2FkX2F1ZGlvOiAgIFRoZSBtZXRob2QgdG8gbG9hZCB0aGUgYXVkaW8gZnJvbSBhIGZpbGUuCgogICAgQWZ0ZXIgaW1wbGVtZW50aW5nIHRoZSBhYm92ZSBtZXRob2RzLCB5b3UgY2FuIHVzZSB0aGUgcmVkdWNlX25vaXNlIG1ldGhvZCB0byByZWR1Y2Ugbm9pc2UgZnJvbSBhdWRpbyBmaWxlcy4KICAgICIiIgoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHRhcmdldF9kaXJlY3Rvcnk6IFBhdGgsCiAgICAgICAgdmVyYm9zZTogYm9vbCA9IFRydWUsCiAgICAgICAgc2lsZW5jZV90aHJlc2hvbGQ6IGZsb2F0ID0gTm9uZSwKICAgICk6CiAgICAgICAgc2VsZi50YXJnZXRfZGlyZWN0b3J5ID0gUGF0aCh0YXJnZXRfZGlyZWN0b3J5KQogICAgICAgIHNlbGYudmVyYm9zZSA9IHZlcmJvc2UKICAgICAgICBzZWxmLnNpbGVuY2VfdGhyZXNob2xkID0gc2lsZW5jZV90aHJlc2hvbGQKCiAgICBkZWYgcmVkdWNlX25vaXNlKHNlbGYsIGF1ZGlvX2ZpbGU6IFBhdGgpIC0+IHR1cGxlW2Jvb2wsIHR1cGxlW3N0ciwgc3RyXV06CiAgICAgICAgIiIiCiAgICAgICAgUmVkdWNlIG5vaXNlIGZyb20gdGhlIGdpdmVuIGF1ZGlvIGZpbGUuCgogICAgICAgIDpwYXJhbSBhdWRpb19maWxlOiAgVGhlIGF1ZGlvIGZpbGUgdG8gcmVkdWNlIG5vaXNlIGZyb20uCgogICAgICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgogICAgICAgICAtIGEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgYW4gZXJyb3Igb2NjdXJyZWQKICAgICAgICAgLSBhIHR1cGxlIG9mOgogICAgICAgICAgICAtIGF1ZGlvIGZpbGUgbmFtZQogICAgICAgICAgICAtIHRhcmdldCBwYXRoIGluIGNhc2Ugb2Ygc3VjY2VzcyAvIGVycm9yIG1lc3NhZ2UgaW4gY2FzZSBvZiBmYWlsdXJlLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgX0xPR0dFUi5pbmZvKGYiUmVkdWNpbmcgbm9pc2UgZnJvbSB7YXVkaW9fZmlsZS5uYW1lfS4iKQoKICAgICAgICAgICAgIyBMb2FkIGF1ZGlvIGRhdGE6CiAgICAgICAgICAgIGF1ZGlvID0gc2VsZi5sb2FkX2F1ZGlvKGZpbGU9c3RyKGF1ZGlvX2ZpbGUpKQoKICAgICAgICAgICAgIyBQZXJmb3JtIG5vaXNlIHJlZHVjdGlvbjoKICAgICAgICAgICAgcmVkdWNlZF9ub2lzZSA9IHNlbGYuY2xlYW5fYXVkaW8oZGF0YT1hdWRpbykKCiAgICAgICAgICAgICMgUmVtb3ZlIHNpbGVuY2UgZnJvbSB0aGUgYXVkaW8gaWYgbmVjZXNzYXJ5OgogICAgICAgICAgICByZWR1Y2VkX25vaXNlID0gc2VsZi5yZW1vdmVfc2lsZW5jZShhdWRpbz1yZWR1Y2VkX25vaXNlKQoKICAgICAgICAgICAgIyBQcmVwYXJlIHRhcmdldCBwYXRoOgogICAgICAgICAgICB0YXJnZXRfcGF0aCA9IHNlbGYudXBkYXRlX3RvX3dhdl9zdWZmaXgoYXVkaW9fZmlsZT1hdWRpb19maWxlKQoKICAgICAgICAgICAgIyBTYXZlIGZpbGU6CiAgICAgICAgICAgIHNlbGYuc2F2ZV9hdWRpbygKICAgICAgICAgICAgICAgIGF1ZGlvPXJlZHVjZWRfbm9pc2UsCiAgICAgICAgICAgICAgICB0YXJnZXRfcGF0aD10YXJnZXRfcGF0aCwKICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgX0xPR0dFUi5pbmZvKGYiU2F2ZWQgY2xlYW5lZCBhdWRpbyBmaWxlIHRvIHt0YXJnZXRfcGF0aH0uIikKCiAgICAgICAgICAgIHJldHVybiBGYWxzZSwgKGF1ZGlvX2ZpbGUubmFtZSwgc3RyKHRhcmdldF9wYXRoKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4Y2VwdGlvbjoKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgX0xPR0dFUi5lcnJvcihmIkZhaWxlZCB0byByZWR1Y2Ugbm9pc2UgZnJvbSB7YXVkaW9fZmlsZS5uYW1lfS4iKQogICAgICAgICAgICAgICAgX0xPR0dFUi5lcnJvcihmIkVycm9yOiB7ZXhjZXB0aW9ufSIpCiAgICAgICAgICAgICMgQ29sbGVjdCB0aGUgZXJyb3I6CiAgICAgICAgICAgIHJldHVybiBUcnVlLCAoYXVkaW9fZmlsZS5uYW1lLCBzdHIoZXhjZXB0aW9uKSkKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBjbGVhbl9hdWRpbyhzZWxmLCBkYXRhKSAtPiBucC5uZGFycmF5IHwgdG9yY2guVGVuc29yOgogICAgICAgICIiIgogICAgICAgIENsZWFuIHRoZSBhdWRpbyBmcm9tIG5vaXNlLiBIZXJlIHlvdSBzaG91bGQgaW1wbGVtZW50IHRoZSBub2lzZSByZWR1Y3Rpb24gYWxnb3JpdGhtLgoKICAgICAgICA6cGFyYW0gZGF0YTogICAgVGhlIGF1ZGlvIGRhdGEgdG8gY2xlYW4uCgogICAgICAgIDpyZXR1cm5zOiBUaGUgY2xlYW5lZCBhdWRpby4KICAgICAgICAiIiIKICAgICAgICBwYXNzCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgc2F2ZV9hdWRpbyhzZWxmLCBhdWRpbzogbnAubmRhcnJheSwgdGFyZ2V0X3BhdGg6IFBhdGgpOgogICAgICAgICIiIgogICAgICAgIFNhdmUgdGhlIGF1ZGlvIHRvIGEgZmlsZS4KCiAgICAgICAgOnBhcmFtIGF1ZGlvOiAgICAgICBUaGUgYXVkaW8gdG8gc2F2ZS4KICAgICAgICA6cGFyYW0gdGFyZ2V0X3BhdGg6IFRoZSB0YXJnZXQgcGF0aCB0byBzYXZlIHRoZSBhdWRpbyB0by4KICAgICAgICAiIiIKICAgICAgICBwYXNzCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgbG9hZF9hdWRpbyhzZWxmLCBmaWxlOiBzdHIpIC0+IHR1cGxlW25wLm5kYXJyYXkgfCB0b3JjaC5UZW5zb3IsIGludF06CiAgICAgICAgIiIiCiAgICAgICAgTG9hZCB0aGUgYXVkaW8gZnJvbSBhIGZpbGUuCgogICAgICAgIDpwYXJhbSBmaWxlOiAgICBUaGUgZmlsZSB0byBsb2FkIHRoZSBhdWRpbyBmcm9tLgoKICAgICAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKICAgICAgICAgICAgLSB0aGUgYXVkaW8gZGF0YQogICAgICAgICAgICAtIHRoZSBzYW1wbGUgcmF0ZQogICAgICAgICIiIgogICAgICAgIHBhc3MKCiAgICBkZWYgdXBkYXRlX3RvX3dhdl9zdWZmaXgoc2VsZiwgYXVkaW9fZmlsZTogUGF0aCk6CiAgICAgICAgdGFyZ2V0X3BhdGggPSBzZWxmLnRhcmdldF9kaXJlY3RvcnkgLyBhdWRpb19maWxlLm5hbWUKICAgICAgICBpZiB0YXJnZXRfcGF0aC5zdWZmaXggIT0gIi53YXYiOgogICAgICAgICAgICBvbGRfc3VmZml4ID0gdGFyZ2V0X3BhdGguc3VmZml4WzE6XQogICAgICAgICAgICB0YXJnZXRfcGF0aCA9IHRhcmdldF9wYXRoLndpdGhfc3RlbSh0YXJnZXRfcGF0aC5zdGVtICsgZiJfe29sZF9zdWZmaXh9IikKICAgICAgICAgICAgcmV0dXJuIHRhcmdldF9wYXRoLndpdGhfc3VmZml4KCIud2F2IikKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gdGFyZ2V0X3BhdGgKCiAgICBkZWYgcmVtb3ZlX3NpbGVuY2UoCiAgICAgICAgc2VsZiwKICAgICAgICBhdWRpbzogbnAubmRhcnJheSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgUmVtb3ZlIHNpbGVuY2Ugc2VjdGlvbnMgZnJvbSB0aGUgYXVkaW8uCgogICAgICAgIDpwYXJhbSBhdWRpbzogICBUaGUgYXVkaW8gdG8gcmVtb3ZlIHNpbGVuY2UgZnJvbS4KCiAgICAgICAgOnJldHVybnM6IFRoZSBhdWRpbyB3aXRob3V0IHNpbGVuY2UuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5zaWxlbmNlX3RocmVzaG9sZCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gYXVkaW8KCiAgICAgICAgIyBHZXQgdGhlIGluZGljZXMgb2YgdGhlIG5vbi1zaWxlbnQgZnJhbWVzOgogICAgICAgIG5vbl9zaWxlbnRfaW5kaWNlcyA9IGxpYnJvc2EuZWZmZWN0cy5zcGxpdCgKICAgICAgICAgICAgeT1hdWRpbywKICAgICAgICAgICAgdG9wX2RiPXNlbGYuc2lsZW5jZV90aHJlc2hvbGQsCiAgICAgICAgICAgIGZyYW1lX2xlbmd0aD0yMDQ4LAogICAgICAgICAgICBob3BfbGVuZ3RoPTI1NiwKICAgICAgICApCgogICAgICAgICMgR2V0IHRoZSBub24tc2lsZW50IGF1ZGlvOgogICAgICAgIG5vbl9zaWxlbnRfYXVkaW8gPSBucC5jb25jYXRlbmF0ZSgKICAgICAgICAgICAgW2F1ZGlvWzosIHN0YXJ0OmVuZF0gZm9yIHN0YXJ0LCBlbmQgaW4gbm9uX3NpbGVudF9pbmRpY2VzXSwgYXhpcz0xCiAgICAgICAgKQoKICAgICAgICByZXR1cm4gbm9uX3NpbGVudF9hdWRpbwoKCmNsYXNzIFJlZHVjZU5vaXNlKFJlZHVjZU5vaXNlQmFzZSk6CiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICB0YXJnZXRfZGlyZWN0b3J5OiBQYXRoLAogICAgICAgIHZlcmJvc2U6IGJvb2wgPSBUcnVlLAogICAgICAgIHNpbGVuY2VfdGhyZXNob2xkOiBmbG9hdCA9IE5vbmUsCiAgICAgICAgc2FtcGxlX3JhdGU6IGludCA9IDE2MDAwLAogICAgICAgIGR1cmF0aW9uOiBpbnQgPSBOb25lLAogICAgICAgIGNoYW5uZWw6IGludCA9IE5vbmUsCiAgICApOgogICAgICAgIHN1cGVyKCkuX19pbml0X18odGFyZ2V0X2RpcmVjdG9yeSwgdmVyYm9zZSwgc2lsZW5jZV90aHJlc2hvbGQpCiAgICAgICAgc2VsZi5zYW1wbGVfcmF0ZSA9IHNhbXBsZV9yYXRlCiAgICAgICAgc2VsZi5kdXJhdGlvbiA9IGR1cmF0aW9uCiAgICAgICAgc2VsZi5jaGFubmVsID0gY2hhbm5lbAoKICAgIGRlZiBzYXZlX2F1ZGlvKHNlbGYsIGF1ZGlvOiBucC5uZGFycmF5LCB0YXJnZXRfcGF0aDogUGF0aCk6CiAgICAgICAgIyBJZiB0aGUgYXVkaW8gaGFzIG1vcmUgdGhhbiBvbmUgY2hhbm5lbCwgdHJhbnNwb3NlIGl0IGluIG9yZGVyIHRvIHNhdmUgaXQ6CiAgICAgICAgaWYgbGVuKGF1ZGlvKSA+IDE6CiAgICAgICAgICAgIGF1ZGlvID0gYXVkaW8uVAoKICAgICAgICB3YXZmaWxlLndyaXRlKAogICAgICAgICAgICBmaWxlbmFtZT10YXJnZXRfcGF0aCwKICAgICAgICAgICAgcmF0ZT1zZWxmLnNhbXBsZV9yYXRlLAogICAgICAgICAgICBkYXRhPWF1ZGlvLAogICAgICAgICkKCiAgICBkZWYgbG9hZF9hdWRpbyhzZWxmLCBmaWxlOiBzdHIpIC0+IG5wLm5kYXJyYXk6CiAgICAgICAgZGF0YSwgc3IgPSBsaWJyb3NhLmxvYWQoCiAgICAgICAgICAgIHBhdGg9ZmlsZSwKICAgICAgICAgICAgc3I9c2VsZi5zYW1wbGVfcmF0ZSwKICAgICAgICAgICAgbW9ubz1GYWxzZSwgICMga2VlcCBjaGFubmVscyBzZXBhcmF0ZQogICAgICAgICAgICBkdXJhdGlvbj1zZWxmLmR1cmF0aW9uLAogICAgICAgICkKICAgICAgICAjIHNldCBzYW1wbGUgcmF0ZToKICAgICAgICBzZWxmLnNhbXBsZV9yYXRlID0gaW50KHNyKQoKICAgICAgICAjIGNvbnZlcnQgdG8gaW50IHdpdGggc2NhbGluZyBmb3IgMTYtYml0IGludGVnZXIKICAgICAgICBkYXRhICo9IDMyNzY3IC8gbnAubWF4KG5wLmFicyhkYXRhKSkgICMgcmUtc2NhbGluZwogICAgICAgIGRhdGEgPSBkYXRhLmFzdHlwZShucC5pbnQxNikgICMgY2hhbmdlIGRhdGEgdHlwZQoKICAgICAgICAjIHNlbGVjdCBjaGFubmVsCiAgICAgICAgZGF0YV90b19yZWR1Y2UgPSBkYXRhW3NlbGYuY2hhbm5lbF0gaWYgc2VsZi5jaGFubmVsIGlzIG5vdCBOb25lIGVsc2UgZGF0YQogICAgICAgIHJldHVybiBkYXRhX3RvX3JlZHVjZQoKICAgIGRlZiBjbGVhbl9hdWRpbyhzZWxmLCBkYXRhOiBucC5uZGFycmF5KSAtPiBucC5uZGFycmF5OgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IG5vaXNlcmVkdWNlCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJQbGVhc2UgaW5zdGFsbCBub2lzZXJlZHVjZSBwYWNrYWdlIikgZnJvbSBlCgogICAgICAgIHJlZHVjZWRfbm9pc2UgPSBub2lzZXJlZHVjZS5yZWR1Y2Vfbm9pc2UoeT1kYXRhLCBzcj1zZWxmLnNhbXBsZV9yYXRlKQoKICAgICAgICAjIGFkZCBjaGFubmVsIGJhY2sgYWZ0ZXIgbm9pc2UgcmVkdWN0aW9uCiAgICAgICAgaWYgc2VsZi5jaGFubmVsIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjIHB1dHRpbmcgdGhlIGNoYW5uZWwgYmFjayBpbiB0aGUgZGF0YQogICAgICAgICAgICBkYXRhW3NlbGYuY2hhbm5lbF0gPSByZWR1Y2VkX25vaXNlCiAgICAgICAgICAgICMgdXBkYXRpbmcgdGhlIGRhdGEgdG8gc2F2ZQogICAgICAgICAgICByZWR1Y2VkX25vaXNlID0gZGF0YQoKICAgICAgICByZXR1cm4gcmVkdWNlZF9ub2lzZQoKCmNsYXNzIERGTihSZWR1Y2VOb2lzZUJhc2UpOgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgdGFyZ2V0X2RpcmVjdG9yeTogUGF0aCwKICAgICAgICB2ZXJib3NlOiBib29sID0gVHJ1ZSwKICAgICAgICBzaWxlbmNlX3RocmVzaG9sZDogZmxvYXQgPSBOb25lLAogICAgICAgIHBhZDogYm9vbCA9IFRydWUsCiAgICAgICAgYXR0ZW5fbGltX2RiOiBpbnQgPSBOb25lLAogICAgICAgICoqa3dhcmdzLAogICAgKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKHRhcmdldF9kaXJlY3RvcnksIHZlcmJvc2UsIHNpbGVuY2VfdGhyZXNob2xkKQogICAgICAgIHNlbGYucGFkID0gcGFkCiAgICAgICAgc2VsZi5hdHRlbl9saW1fZGIgPSBhdHRlbl9saW1fZGIKICAgICAgICBzZWxmLmt3YXJncyA9IGt3YXJncwoKICAgICAgICAjIGltcG9ydCByZXF1aXJlZCBwYWNrYWdlcwogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBkZi5lbmhhbmNlIGltcG9ydCBpbml0X2RmCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJQbGVhc2UgaW5zdGFsbCBkZWVwZmlsdGVybmV0IHBhY2thZ2VzIikgZnJvbSBlCgogICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgX0xPR0dFUi5pbmZvKCJMb2FkaW5nIERlZXBGaWx0ZXJOZXQyIG1vZGVsLiIpCgogICAgICAgICMgTG9hZCB0aGUgbW9kZWw6CiAgICAgICAgbW9kZWwsIGRmX3N0YXRlLCBfID0gaW5pdF9kZigpCiAgICAgICAgc2VsZi5tb2RlbCA9IG1vZGVsCiAgICAgICAgc2VsZi5kZl9zdGF0ZSA9IGRmX3N0YXRlCiAgICAgICAgc2VsZi5zYW1wbGVfcmF0ZSA9IHNlbGYuZGZfc3RhdGUuc3IoKQoKICAgIGRlZiBzYXZlX2F1ZGlvKHNlbGYsIGF1ZGlvOiBucC5uZGFycmF5LCB0YXJnZXRfcGF0aDogUGF0aCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIGRmLmVuaGFuY2UgaW1wb3J0IHNhdmVfYXVkaW8KICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3IgYXMgZToKICAgICAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoIlBsZWFzZSBpbnN0YWxsIGRlZXBmaWx0ZXJuZXQgcGFja2FnZSIpIGZyb20gZQogICAgICAgIHNhdmVfYXVkaW8oCiAgICAgICAgICAgIGZpbGU9dGFyZ2V0X3BhdGgubmFtZSwKICAgICAgICAgICAgYXVkaW89YXVkaW8sCiAgICAgICAgICAgIHNyPXNlbGYuc2FtcGxlX3JhdGUsCiAgICAgICAgICAgIG91dHB1dF9kaXI9c3RyKHNlbGYudGFyZ2V0X2RpcmVjdG9yeSksCiAgICAgICAgKQoKICAgIGRlZiBsb2FkX2F1ZGlvKHNlbGYsIGZpbGU6IHN0cikgLT4gdG9yY2guVGVuc29yOgogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBkZi5lbmhhbmNlIGltcG9ydCBsb2FkX2F1ZGlvCiAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6CiAgICAgICAgICAgIHJhaXNlIEltcG9ydEVycm9yKCJQbGVhc2UgaW5zdGFsbCBkZWVwZmlsdGVybmV0IHBhY2thZ2UiKSBmcm9tIGUKICAgICAgICBhdWRpbywgXyA9IGxvYWRfYXVkaW8oZmlsZT1maWxlLCBzcj1zZWxmLnNhbXBsZV9yYXRlLCAqKnNlbGYua3dhcmdzKQogICAgICAgIHJldHVybiBhdWRpbwoKICAgIGRlZiBjbGVhbl9hdWRpbyhzZWxmLCBkYXRhOiB0b3JjaC5UZW5zb3IpIC0+IHRvcmNoLlRlbnNvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gZGYuZW5oYW5jZSBpbXBvcnQgZW5oYW5jZQogICAgICAgIGV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgICAgICAgICByYWlzZSBJbXBvcnRFcnJvcigiUGxlYXNlIGluc3RhbGwgZGVlcGZpbHRlcm5ldCBwYWNrYWdlIikgZnJvbSBlCiAgICAgICAgcmV0dXJuIGVuaGFuY2UoCiAgICAgICAgICAgIG1vZGVsPXNlbGYubW9kZWwsCiAgICAgICAgICAgIGRmX3N0YXRlPXNlbGYuZGZfc3RhdGUsCiAgICAgICAgICAgIGF1ZGlvPWRhdGEsCiAgICAgICAgICAgIHBhZD1zZWxmLnBhZCwKICAgICAgICAgICAgYXR0ZW5fbGltX2RiPXNlbGYuYXR0ZW5fbGltX2RiLAogICAgICAgICkKCgpkZWYgX211bHRpcHJvY2Vzc2luZ19jb21wbGV0ZV90YXNrcygKICAgIG5vaXNlX3JlZHVjZV90eXBlOiB0eXBlW1JlZHVjZU5vaXNlQmFzZV0sCiAgICBub2lzZV9yZWR1Y2VfYXJndW1lbnRzOiBkaWN0LAogICAgdGFza3NfcXVldWU6IFF1ZXVlLAogICAgcmVzdWx0c19xdWV1ZTogUXVldWUsCik6CiAgICAiIiIKICAgIENvbXBsZXRlIHRoZSB0YXNrcyBpbiB0aGUgZ2l2ZW4gcXVldWUgYW5kIHB1dCB0aGUgcmVzdWx0cyBpbiB0aGUgZ2l2ZW4gcmVzdWx0cyBxdWV1ZS4gVGhlIGZ1bmN0aW9uIHdpbGwgc3RvcCB3aGVuCiAgICB0aGUgZ2l2ZW4gdGFza3MgcXVldWUgd2lsbCByZWNlaXZlIHRoZSBzdG9wIG1hcmsuIEl0IGlzIGFpbWVkIHRvIGJlIHVzZWQgd2l0aCBtdWx0aXByb2Nlc3NpbmcgYXMgYSBwcm9jZXNzLgoKICAgIDpwYXJhbSBub2lzZV9yZWR1Y2VfdHlwZTogICAgICAgVGhlIG5vaXNlIHJlZHVjZSB0eXBlIHRvIHVzZS4KICAgIDpwYXJhbSBub2lzZV9yZWR1Y2VfYXJndW1lbnRzOiAgVGhlIG5vaXNlcmVkdWNlIGluaXRpYWxpemF0aW9uIGt3YXJncy4KICAgIDpwYXJhbSB0YXNrc19xdWV1ZTogICAgICAgICAgICAgQSBxdWV1ZSB0byBnZXQgdGhlIHRhc2tzIGZyb20uCiAgICA6cGFyYW0gcmVzdWx0c19xdWV1ZTogICAgICAgICAgIEEgcXVldWUgdG8gcHV0IHRoZSByZXN1bHRzIGluLgogICAgIiIiCiAgICAjIEluaXRpYWxpemUgdGhlIHJlZHVjZSBub2lzZSBvYmplY3QKICAgIG5vaXNlX3JlZHVjZXIgPSBub2lzZV9yZWR1Y2VfdHlwZSgqKm5vaXNlX3JlZHVjZV9hcmd1bWVudHMpCgogICAgIyBTdGFydCBsaXN0ZW5pbmcgdG8gdGhlIHRhc2tzIHF1ZXVlOgogICAgd2hpbGUgVHJ1ZToKICAgICAgICAjIEdldCB0aGUgYXVkaW9fZmlsZToKICAgICAgICBhdWRpb19maWxlID0gdGFza3NfcXVldWUuZ2V0KCkKICAgICAgICBpZiBhdWRpb19maWxlID09IF9NVUxUSVBST0NFU1NJTkdfU1RPUF9NQVJLOgogICAgICAgICAgICBicmVhawogICAgICAgIGF1ZGlvX2ZpbGUgPSBQYXRoKGF1ZGlvX2ZpbGUpCiAgICAgICAgIyBBcHBseSBub2lzZSByZWR1Y3Rpb24gYW5kIGNvbGxlY3QgdGhlIHJlc3VsdDoKICAgICAgICByZXN1bHRzX3F1ZXVlLnB1dChub2lzZV9yZWR1Y2VyLnJlZHVjZV9ub2lzZShhdWRpb19maWxlPWF1ZGlvX2ZpbGUpKQoKICAgICMgTWFyayB0aGUgZW5kIG9mIHRoZSB0YXNrczoKICAgIHJlc3VsdHNfcXVldWUucHV0KF9NVUxUSVBST0NFU1NJTkdfU1RPUF9NQVJLKQoKCmRlZiByZWR1Y2Vfbm9pc2VfZGZuKAogICAgYXVkaW9fc291cmNlOiBzdHIsCiAgICB0YXJnZXRfZGlyZWN0b3J5OiBzdHIsCiAgICBwYWQ6IGJvb2wgPSBUcnVlLAogICAgYXR0ZW5fbGltX2RiOiBpbnQgPSBOb25lLAogICAgc2lsZW5jZV90aHJlc2hvbGQ6IGZsb2F0ID0gTm9uZSwKICAgIHVzZV9tdWx0aXByb2Nlc3Npbmc6IGludCA9IDAsCiAgICB2ZXJib3NlOiBib29sID0gVHJ1ZSwKICAgICoqa3dhcmdzLAopOgogICAgIiIiCiAgICBSZWR1Y2Ugbm9pc2UgZnJvbSBhdWRpbyBmaWxlcyB1c2luZyBEZWVwRmlsdGVyTmV0LgogICAgRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgdGhlIG5vaXNlIHJlZHVjdGlvbiBhbGdvcml0aG0gc2VlOgogICAgaHR0cHM6Ly9naXRodWIuY29tL1Jpa29yb3NlL0RlZXBGaWx0ZXJOZXQKICAgIE5vdGljZSB0aGF0IHRoZSBzYXZlZCBmaWxlcyBhcmUgaW4gd2F2IGZvcm1hdCwgZXZlbiBpZiB0aGUgb3JpZ2luYWwgZmlsZXMgYXJlIGluIG90aGVyIGZvcm1hdC4KCiAgICA6cGFyYW0gYXVkaW9fc291cmNlOiAgICAgICAgcGF0aCB0byBhdWRpbyBmaWxlIG9yIGRpcmVjdG9yeSBvZiBhdWRpbyBmaWxlcwogICAgOnBhcmFtIHRhcmdldF9kaXJlY3Rvcnk6ICAgIHBhdGggdG8gdGFyZ2V0IGRpcmVjdG9yeSB0byBzYXZlIGNsZWFuZWQgYXVkaW8gZmlsZXMKICAgIDpwYXJhbSBwYWQ6ICAgICAgICAgICAgICAgICB3aGV0aGVyIHRvIHBhZCB0aGUgYXVkaW8gZmlsZSB3aXRoIHplcm9zIGJlZm9yZSBjbGVhbmluZwogICAgOnBhcmFtIGF0dGVuX2xpbV9kYjogICAgICAgIG1heGltdW0gYXR0ZW51YXRpb24gaW4gZEIKICAgIDpwYXJhbSBzaWxlbmNlX3RocmVzaG9sZDogICB0aGUgdGhyZXNob2xkIHRvIHJlbW92ZSBzaWxlbmNlIGZyb20gdGhlIGF1ZGlvLCBpbiBkQi4gSWYgTm9uZSwgbm8gc2lsZW5jZSByZW1vdmFsIGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVyZm9ybWVkLgogICAgOnBhcmFtIHVzZV9tdWx0aXByb2Nlc3Npbmc6IE51bWJlciBvZiBwcm9jZXNzZXMgdG8gdXNlIGZvciBjbGVhbmluZyB0aGUgYXVkaW8gZmlsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgMCwgbm8gbXVsdGlwcm9jZXNzaW5nIGlzIHVzZWQuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgdmVyYm9zaXR5IGxldmVsLiBJZiBUcnVlLCBkaXNwbGF5IHByb2dyZXNzIGJhciBhbmQgbG9ncy4KICAgIDpwYXJhbSBrd2FyZ3M6ICAgICAgICAgICAgICBhZGRpdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRvcmNoYXVkaW8ubG9hZCgpLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cHM6Ly9weXRvcmNoLm9yZy9hdWRpby9zdGFibGUvZ2VuZXJhdGVkL3RvcmNoYXVkaW8ubG9hZC5odG1sCiAgICAiIiIKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJSZWR1Y2luZyBub2lzZSBmcm9tIGF1ZGlvIGZpbGVzLiIpCgogICAgIyBjcmVhdGUgdGFyZ2V0IGRpcmVjdG9yeToKICAgIHRhcmdldF9kaXJlY3RvcnkgPSBfY3JlYXRlX3RhcmdldF9kaXJlY3RvcnkodGFyZ2V0X2RpcmVjdG9yeSkKCiAgICAjIGdldCBhdWRpbyBmaWxlczoKICAgIGF1ZGlvX2ZpbGVzID0gX2dldF9hdWRpb19maWxlcyhhdWRpb19zb3VyY2UpCgogICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50cyA9IHsKICAgICAgICAidGFyZ2V0X2RpcmVjdG9yeSI6IHRhcmdldF9kaXJlY3RvcnksCiAgICAgICAgInBhZCI6IHBhZCwKICAgICAgICAiYXR0ZW5fbGltX2RiIjogYXR0ZW5fbGltX2RiLAogICAgICAgICJzaWxlbmNlX3RocmVzaG9sZCI6IHNpbGVuY2VfdGhyZXNob2xkLAogICAgICAgICoqa3dhcmdzLAogICAgfQoKICAgIGlmIHVzZV9tdWx0aXByb2Nlc3Npbmc6CiAgICAgICAgcmVzdWx0cyA9IF9wYXJhbGxlbF9ydW4oCiAgICAgICAgICAgIG5vaXNlX3JlZHVjZV90eXBlPURGTiwKICAgICAgICAgICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50cz1ub2lzZV9yZWR1Y2VfYXJndW1lbnRzLAogICAgICAgICAgICBuX3dvcmtlcnM9dXNlX211bHRpcHJvY2Vzc2luZywKICAgICAgICAgICAgYXVkaW9fZmlsZXM9YXVkaW9fZmlsZXMsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uPSJOb2lzZS1yZWR1Y3Rpb24iLAogICAgICAgICAgICB2ZXJib3NlPXZlcmJvc2UsCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICByZXN1bHRzID0gX3J1bigKICAgICAgICAgICAgbm9pc2VfcmVkdWNlX3R5cGU9REZOLAogICAgICAgICAgICBub2lzZV9yZWR1Y2VfYXJndW1lbnRzPW5vaXNlX3JlZHVjZV9hcmd1bWVudHMsCiAgICAgICAgICAgIGF1ZGlvX2ZpbGVzPWF1ZGlvX2ZpbGVzLAogICAgICAgICAgICBkZXNjcmlwdGlvbj0iTm9pc2UtcmVkdWN0aW9uIiwKICAgICAgICAgICAgdmVyYm9zZT12ZXJib3NlLAogICAgICAgICkKCiAgICByZXR1cm4gX3Byb2Nlc3NfcmVzdWx0cyhyZXN1bHRzLCB2ZXJib3NlKQoKCmRlZiByZWR1Y2Vfbm9pc2UoCiAgICBhdWRpb19zb3VyY2U6IHN0ciwKICAgIHRhcmdldF9kaXJlY3Rvcnk6IHN0ciwKICAgIHNhbXBsZV9yYXRlOiBpbnQgPSAxNjAwMCwKICAgIGR1cmF0aW9uOiBpbnQgPSBOb25lLAogICAgY2hhbm5lbDogaW50ID0gTm9uZSwKICAgIHNpbGVuY2VfdGhyZXNob2xkOiBmbG9hdCA9IE5vbmUsCiAgICB1c2VfbXVsdGlwcm9jZXNzaW5nOiBpbnQgPSAwLAogICAgdmVyYm9zZTogYm9vbCA9IFRydWUsCik6CiAgICAiIiIKICAgIFJlZHVjZSBub2lzZSBmcm9tIGF1ZGlvIGZpbGUgb3IgZGlyZWN0b3J5IGNvbnRhaW5pbmcgYXVkaW8gZmlsZXMuCiAgICBUaGUgYXVkaW8gZmlsZXMgbXVzdCBiZSBpbiAud2F2IGZvcm1hdC4KICAgIFRoZSBjbGVhbmVkIGF1ZGlvIGZpbGVzIHdpbGwgYmUgc2F2ZWQgaW4gdGhlIHRhcmdldF9kaXJlY3RvcnkuCiAgICBGb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIG5vaXNlIHJlZHVjdGlvbiBhbGdvcml0aG0gc2VlOgogICAgaHR0cHM6Ly9naXRodWIuY29tL3RpbXNhaW5iL25vaXNlcmVkdWNlCiAgICBOb3RpY2UgdGhhdCB0aGUgc2F2ZWQgZmlsZXMgYXJlIGluIHdhdiBmb3JtYXQsIGV2ZW4gaWYgdGhlIG9yaWdpbmFsIGZpbGVzIGFyZSBpbiBvdGhlciBmb3JtYXQuCgogICAgOnBhcmFtIGF1ZGlvX3NvdXJjZTogICAgICAgIHBhdGggdG8gYXVkaW8gZmlsZSBvciBkaXJlY3RvcnkgY29udGFpbmluZyBhdWRpbyBmaWxlcwogICAgOnBhcmFtIHRhcmdldF9kaXJlY3Rvcnk6ICAgIHBhdGggdG8gZGlyZWN0b3J5IHRvIHNhdmUgdGhlIGNsZWFuZWQgYXVkaW8gZmlsZXMuCiAgICA6cGFyYW0gc2FtcGxlX3JhdGU6ICAgICAgICAgTnVtYmVyIG9mIHNhbXBsZXMgaW4gb25lIHNlY29uZCBpbiB0aGUgYXVkaW8gZmlsZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYXNzIGBOb25lYCB0byBrZWVwIHRoZSBvcmlnaW5hbCBzYW1wbGUgcmF0ZS4KICAgIDpwYXJhbSBkdXJhdGlvbjogICAgICAgICAgICBEdXJhdGlvbiBvZiB0aGUgYXVkaW8gZmlsZSB0byBjbGVhbiBpbiBzZWNvbmRzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhc3MgYE5vbmVgIHRvIGtlZXAgdGhlIG9yaWdpbmFsIGR1cmF0aW9uLgogICAgOnBhcmFtIGNoYW5uZWw6ICAgICAgICAgICAgIENoYW5uZWwgdG8gY2xlYW4uIFBhc3MgdGhlIG51bWJlciBvZiB0aGUgY2hhbm5lbCB0byBjbGVhbi4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUbyBjbGVhbiBhbGwgY2hhbm5lbHMgcGFzcyBOb25lLgogICAgOnBhcmFtIHNpbGVuY2VfdGhyZXNob2xkOiAgIFRoZSB0aHJlc2hvbGQgdG8gcmVtb3ZlIHNpbGVuY2UgZnJvbSB0aGUgYXVkaW8sIGluIGRCLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElmIE5vbmUsIG5vIHNpbGVuY2UgcmVtb3ZhbCBpcyBwZXJmb3JtZWQuCiAgICA6cGFyYW0gdXNlX211bHRpcHJvY2Vzc2luZzogTnVtYmVyIG9mIHByb2Nlc3NlcyB0byB1c2UgZm9yIGNsZWFuaW5nIHRoZSBhdWRpbyBmaWxlcy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiAwLCBubyBtdWx0aXByb2Nlc3NpbmcgaXMgdXNlZC4KICAgIDpwYXJhbSB2ZXJib3NlOiAgICAgICAgICAgICBWZXJib3NpdHkgbGV2ZWwuIElmIFRydWUsIGRpc3BsYXkgcHJvZ3Jlc3MgYmFyLgogICAgIiIiCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbygiUmVkdWNpbmcgbm9pc2UgZnJvbSBhdWRpbyBmaWxlcy4iKQoKICAgICMgY3JlYXRlIHRhcmdldCBkaXJlY3Rvcnk6CiAgICB0YXJnZXRfZGlyZWN0b3J5ID0gX2NyZWF0ZV90YXJnZXRfZGlyZWN0b3J5KHRhcmdldF9kaXJlY3RvcnkpCgogICAgIyBnZXQgYXVkaW8gZmlsZXM6CiAgICBhdWRpb19maWxlcyA9IF9nZXRfYXVkaW9fZmlsZXMoYXVkaW9fc291cmNlKQoKICAgICMgQ3JlYXRlIHRoZSByZWR1Y2Ugbm9pc2Ugb2JqZWN0OgogICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50cyA9IHsKICAgICAgICAidGFyZ2V0X2RpcmVjdG9yeSI6IHRhcmdldF9kaXJlY3RvcnksCiAgICAgICAgInNhbXBsZV9yYXRlIjogc2FtcGxlX3JhdGUsCiAgICAgICAgImR1cmF0aW9uIjogZHVyYXRpb24sCiAgICAgICAgImNoYW5uZWwiOiBjaGFubmVsLAogICAgICAgICJzaWxlbmNlX3RocmVzaG9sZCI6IHNpbGVuY2VfdGhyZXNob2xkLAogICAgfQoKICAgIGlmIHVzZV9tdWx0aXByb2Nlc3Npbmc6CiAgICAgICAgcmVzdWx0cyA9IF9wYXJhbGxlbF9ydW4oCiAgICAgICAgICAgIG5vaXNlX3JlZHVjZV90eXBlPVJlZHVjZU5vaXNlLAogICAgICAgICAgICBub2lzZV9yZWR1Y2VfYXJndW1lbnRzPW5vaXNlX3JlZHVjZV9hcmd1bWVudHMsCiAgICAgICAgICAgIG5fd29ya2Vycz11c2VfbXVsdGlwcm9jZXNzaW5nLAogICAgICAgICAgICBhdWRpb19maWxlcz1hdWRpb19maWxlcywKICAgICAgICAgICAgZGVzY3JpcHRpb249Ik5vaXNlLXJlZHVjdGlvbiIsCiAgICAgICAgICAgIHZlcmJvc2U9dmVyYm9zZSwKICAgICAgICApCiAgICBlbHNlOgogICAgICAgIHJlc3VsdHMgPSBfcnVuKAogICAgICAgICAgICBub2lzZV9yZWR1Y2VfdHlwZT1SZWR1Y2VOb2lzZSwKICAgICAgICAgICAgbm9pc2VfcmVkdWNlX2FyZ3VtZW50cz1ub2lzZV9yZWR1Y2VfYXJndW1lbnRzLAogICAgICAgICAgICBhdWRpb19maWxlcz1hdWRpb19maWxlcywKICAgICAgICAgICAgZGVzY3JpcHRpb249Ik5vaXNlLXJlZHVjdGlvbiIsCiAgICAgICAgICAgIHZlcmJvc2U9dmVyYm9zZSwKICAgICAgICApCgogICAgcmV0dXJuIF9wcm9jZXNzX3Jlc3VsdHMocmVzdWx0cywgdmVyYm9zZSkKCgpkZWYgX2NyZWF0ZV90YXJnZXRfZGlyZWN0b3J5KHRhcmdldF9kaXJlY3Rvcnk6IHN0cikgLT4gc3RyOgogICAgdGFyZ2V0X2RpcmVjdG9yeSA9IFBhdGgodGFyZ2V0X2RpcmVjdG9yeSkKICAgIGlmIG5vdCB0YXJnZXRfZGlyZWN0b3J5LmV4aXN0cygpOgogICAgICAgIHRhcmdldF9kaXJlY3RvcnkubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQogICAgcmV0dXJuIHN0cih0YXJnZXRfZGlyZWN0b3J5KQoKCmRlZiBfZ2V0X2F1ZGlvX2ZpbGVzKGF1ZGlvX3NvdXJjZTogc3RyKToKICAgIGF1ZGlvX3NvdXJjZSA9IFBhdGgoYXVkaW9fc291cmNlKQogICAgYXVkaW9fZmlsZXMgPSBbXQogICAgaWYgYXVkaW9fc291cmNlLmlzX2RpcigpOgogICAgICAgIGF1ZGlvX2ZpbGVzID0gbGlzdChhdWRpb19zb3VyY2UuZ2xvYigiKi4qIikpCiAgICBlbGlmIGF1ZGlvX3NvdXJjZS5pc19maWxlKCk6CiAgICAgICAgYXVkaW9fZmlsZXMuYXBwZW5kKGF1ZGlvX3NvdXJjZSkKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgZiJhdWRpb19zb3VyY2UgbXVzdCBiZSBhIGZpbGUgb3IgYSBkaXJlY3RvcnksIGdvdCB7YXVkaW9fc291cmNlfSIKICAgICAgICApCiAgICByZXR1cm4gYXVkaW9fZmlsZXMKCgpkZWYgX3BhcmFsbGVsX3J1bigKICAgIG5vaXNlX3JlZHVjZV90eXBlOiB0eXBlW1JlZHVjZU5vaXNlQmFzZV0sCiAgICBub2lzZV9yZWR1Y2VfYXJndW1lbnRzOiBkaWN0LAogICAgbl93b3JrZXJzOiBpbnQsCiAgICBhdWRpb19maWxlczogbGlzdFtQYXRoXSwKICAgIGRlc2NyaXB0aW9uOiBzdHIsCiAgICB2ZXJib3NlOiBib29sLAopIC0+IGxpc3RbdHVwbGVbYm9vbCwgdHVwbGVbc3RyLCBzdHJdXV06CiAgICAiIiIKICAgIFJ1biBtdWx0aXBsZSBub2lzZSByZWR1Y2Ugd29ya2VycyB3aXRoIG11bHRpcHJvY2Vzc2luZyB0byBjb21wbGV0ZSB0aGUgdGFza3MgdGhhdCB3aWxsIGJlIGNyZWF0ZWQgb24gdGhlIHByb3ZpZGVkCiAgICBmaWxlcyB1c2luZyB0aGUgZ2l2ZW4gdGFzayBjcmVhdG9yLgoKICAgIDpwYXJhbSBub2lzZV9yZWR1Y2VfdHlwZTogICBUaGUgbm9pc2UgcmVkdWNlIHR5cGUgdG8gdXNlLgogICAgOnBhcmFtIG5fd29ya2VyczogICAgICAgICAgIFRoZSBudW1iZXIgb2Ygd29ya2VycyB0byB1c2UuCiAgICA6cGFyYW0gYXVkaW9fZmlsZXM6ICAgICAgICAgVGhlIGF1ZGlvIGZpbGVzIHRvIHVzZS4KICAgIDpwYXJhbSBkZXNjcmlwdGlvbjogICAgICAgICBUaGUgZGVzY3JpcHRpb24gdG8gdXNlIGZvciB0aGUgcHJvZ3Jlc3MgYmFyLgogICAgOnBhcmFtIHZlcmJvc2U6ICAgICAgICAgICAgIFZlcmJvc2l0eS4KCiAgICA6cmV0dXJuczogVGhlIGNvbGxlY3RlZCByZXN1bHRzLgogICAgIiIiCiAgICAjIENoZWNrIHRoZSBudW1iZXIgb2Ygd29ya2VyczoKICAgIGlmIG5fd29ya2VycyA+IGxlbihhdWRpb19maWxlcyk6CiAgICAgICAgX0xPR0dFUi53YXJuaW5nKAogICAgICAgICAgICBmIlRoZSBudW1iZXIgb2Ygd29ya2VycyAoe25fd29ya2Vyc30pIGlzIGxhcmdlciB0aGFuIHRoZSBudW1iZXIgb2YgYXVkaW8gZmlsZXMgKHtsZW4oYXVkaW9fZmlsZXMpfSkuICIKICAgICAgICAgICAgZiJTZXR0aW5nIHRoZSBudW1iZXIgb2Ygd29ya2VycyB0byB7bGVuKGF1ZGlvX2ZpbGVzKX0uIgogICAgICAgICkKICAgICAgICBuX3dvcmtlcnMgPSBsZW4oYXVkaW9fZmlsZXMpCgogICAgIyBJbml0aWFsaXplIHRoZSBtdWx0aXByb2Nlc3NpbmcgcXVldWVzOgogICAgdGFza3NfcXVldWUgPSBRdWV1ZSgpCiAgICByZXN1bHRzX3F1ZXVlID0gUXVldWUoKQoKICAgICMgSW5pdGlhbGl6ZSB0aGUgbXVsdGlwcm9jZXNzaW5nIHByb2Nlc3NlczoKICAgIHRhc2tfY29tcGxldGlvbl9wcm9jZXNzZXMgPSBbCiAgICAgICAgUHJvY2VzcygKICAgICAgICAgICAgdGFyZ2V0PV9tdWx0aXByb2Nlc3NpbmdfY29tcGxldGVfdGFza3MsCiAgICAgICAgICAgIGt3YXJncz17CiAgICAgICAgICAgICAgICAibm9pc2VfcmVkdWNlX3R5cGUiOiBub2lzZV9yZWR1Y2VfdHlwZSwKICAgICAgICAgICAgICAgICJub2lzZV9yZWR1Y2VfYXJndW1lbnRzIjogbm9pc2VfcmVkdWNlX2FyZ3VtZW50cywKICAgICAgICAgICAgICAgICJ0YXNrc19xdWV1ZSI6IHRhc2tzX3F1ZXVlLAogICAgICAgICAgICAgICAgInJlc3VsdHNfcXVldWUiOiByZXN1bHRzX3F1ZXVlLAogICAgICAgICAgICB9LAogICAgICAgICkKICAgICAgICBmb3IgXyBpbiByYW5nZShuX3dvcmtlcnMpCiAgICBdCgogICAgIyBTdGFydCB0aGUgbXVsdGlwcm9jZXNzaW5nIHByb2Nlc3NlczoKICAgIGZvciBwIGluIHRhc2tfY29tcGxldGlvbl9wcm9jZXNzZXM6CiAgICAgICAgcC5zdGFydCgpCgogICAgIyBQdXQgdGhlIHRhc2tzIGluIHRoZSBxdWV1ZToKICAgIGZvciBhdWRpb19maWxlIGluIGF1ZGlvX2ZpbGVzOgogICAgICAgICMgdGFza3NfcXVldWUucHV0KHRhc2tfY3JlYXRvci5jcmVhdGVfdGFzayhhdWRpb19maWxlPWF1ZGlvX2ZpbGUpLnRvX3R1cGxlKCkpCiAgICAgICAgdGFza3NfcXVldWUucHV0KGF1ZGlvX2ZpbGUpCgogICAgIyBQdXQgdGhlIHN0b3AgbWFya3MgaW4gdGhlIHF1ZXVlOgogICAgZm9yIF8gaW4gcmFuZ2Uobl93b3JrZXJzKToKICAgICAgICB0YXNrc19xdWV1ZS5wdXQoX01VTFRJUFJPQ0VTU0lOR19TVE9QX01BUkspCgogICAgIyBDb2xsZWN0IHRoZSByZXN1bHRzOgogICAgcmVzdWx0cyA9IFtdCiAgICBzdG9wX21hcmtzX2NvdW50ZXIgPSAwCiAgICB3aXRoIHRxZG0oCiAgICAgICAgZGVzYz1kZXNjcmlwdGlvbiwKICAgICAgICB1bml0PSJmaWxlIiwKICAgICAgICB0b3RhbD1sZW4oYXVkaW9fZmlsZXMpLAogICAgICAgIGRpc2FibGU9bm90IHZlcmJvc2UsCiAgICApIGFzIHByb2dyZXNzYmFyOgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICMgR2V0IGEgcmVzdWx0IGZyb20gdGhlIHF1ZXVlOgogICAgICAgICAgICByZXN1bHQ6IHR1cGxlW2Jvb2wsIHR1cGxlW3N0ciwgc3RyXV0gPSByZXN1bHRzX3F1ZXVlLmdldCgpCiAgICAgICAgICAgIGlmIHJlc3VsdCA9PSBfTVVMVElQUk9DRVNTSU5HX1NUT1BfTUFSSzoKICAgICAgICAgICAgICAgIHN0b3BfbWFya3NfY291bnRlciArPSAxCiAgICAgICAgICAgICAgICBpZiBzdG9wX21hcmtzX2NvdW50ZXIgPT0gbl93b3JrZXJzOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIENvbGxlY3QgdGhlIHJlc3VsdDoKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKHJlc3VsdCkKICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyLnVwZGF0ZSgxKQoKICAgICMgV2FpdCBmb3IgdGhlIHByb2Nlc3NlcyB0byBmaW5pc2g6CiAgICBmb3IgcCBpbiB0YXNrX2NvbXBsZXRpb25fcHJvY2Vzc2VzOgogICAgICAgIHAuam9pbigpCgogICAgcmV0dXJuIHJlc3VsdHMKCgpkZWYgX3J1bigKICAgIG5vaXNlX3JlZHVjZV90eXBlOiB0eXBlW1JlZHVjZU5vaXNlQmFzZV0sCiAgICBub2lzZV9yZWR1Y2VfYXJndW1lbnRzOiBkaWN0LAogICAgYXVkaW9fZmlsZXM6IGxpc3RbUGF0aF0sCiAgICBkZXNjcmlwdGlvbjogc3RyLAogICAgdmVyYm9zZTogYm9vbCwKKSAtPiBsaXN0W3R1cGxlW2Jvb2wsIHR1cGxlW3N0ciwgc3RyXV1dOgogICAgIiIiCiAgICBSdW4gdGhlIG5vaXNlIHJlZHVjZSBhbGdvcml0aG0gb24gdGhlIGdpdmVuIGF1ZGlvIGZpbGVzIGFuZCBjb2xsZWN0IHRoZSByZXN1bHRzLgoKICAgIDpwYXJhbSBub2lzZV9yZWR1Y2VfdHlwZTogICAgICAgVGhlIG5vaXNlIHJlZHVjZSB0eXBlIHRvIHVzZS4KICAgIDpwYXJhbSBub2lzZV9yZWR1Y2VfYXJndW1lbnRzOiAgVGhlIG5vaXNlcmVkdWNlIGluaXRpYWxpemF0aW9uIGt3YXJncy4KICAgIDpwYXJhbSBhdWRpb19maWxlczogICAgICAgICAgICAgVGhlIGF1ZGlvIGZpbGVzIHRvIHVzZS4KICAgIDpwYXJhbSBkZXNjcmlwdGlvbjogICAgICAgICAgICAgVGhlIGRlc2NyaXB0aW9uIHRvIHVzZSBmb3IgdGhlIHByb2dyZXNzIGJhci4KICAgIDpwYXJhbSB2ZXJib3NlOiAgICAgICAgICAgICAgICAgVmVyYm9zaXR5LgoKICAgIDpyZXR1cm5zOiBUaGUgY29sbGVjdGVkIHJlc3VsdHMuCiAgICAiIiIKICAgICMgQ3JlYXRlIHRoZSByZWR1Y2Ugbm9pc2Ugb2JqZWN0OgogICAgbm9pc2VfcmVkdWNlciA9IG5vaXNlX3JlZHVjZV90eXBlKCoqbm9pc2VfcmVkdWNlX2FyZ3VtZW50cykKCiAgICAjIFJ1biB0aGUgbm9pc2UgcmVkdWNlIGFsZ29yaXRobSBvbiB0aGUgYXVkaW8gZmlsZXMgYW5kIGNvbGxlY3QgdGhlIHJlc3VsdHM6CiAgICByZXN1bHRzID0gW10KICAgIGZvciBhdWRpb19maWxlIGluIHRxZG0oCiAgICAgICAgYXVkaW9fZmlsZXMsCiAgICAgICAgZGVzYz1kZXNjcmlwdGlvbiwKICAgICAgICB1bml0PSJmaWxlIiwKICAgICAgICB0b3RhbD1sZW4oYXVkaW9fZmlsZXMpLAogICAgICAgIGRpc2FibGU9bm90IHZlcmJvc2UsCiAgICApOgogICAgICAgIHJlc3VsdHMuYXBwZW5kKG5vaXNlX3JlZHVjZXIucmVkdWNlX25vaXNlKGF1ZGlvX2ZpbGU9YXVkaW9fZmlsZSkpCgogICAgcmV0dXJuIHJlc3VsdHMKCgpkZWYgX3Byb2Nlc3NfcmVzdWx0cygKICAgIHJlc3VsdHM6IGxpc3RbdHVwbGVbYm9vbCwgdHVwbGVbc3RyLCBzdHJdXV0sIHZlcmJvc2U6IGJvb2wKKSAtPiB0dXBsZVtkaWN0LCBkaWN0XToKICAgICIiIgogICAgUHJvY2VzcyB0aGUgcmVzdWx0cyBvZiB0aGUgdGFza3MuCgogICAgOnBhcmFtIHJlc3VsdHM6IFRoZSByZXN1bHRzIHRvIHByb2Nlc3MuCiAgICA6cGFyYW0gdmVyYm9zZTogVmVyYm9zaXR5LgoKICAgIDpyZXR1cm5zOiBUaGUgcHJvY2Vzc2VkIHJlc3VsdHMgYXMgYSB0dXBsZSBvZiBzdWNjZXNzZXMgYW5kIGVycm9ycy4KICAgICIiIgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIlN1bW1hcml6aW5nIHRoZSByZXN1bHRzLiIpCiAgICBzdWNjZXNzZXMgPSB7fQogICAgZXJyb3JzID0ge30KICAgIGZvciBpc19lcnJvciwgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgaWYgaXNfZXJyb3I6CiAgICAgICAgICAgIGVycm9yc1tyZXN1bHRbMF1dID0gcmVzdWx0WzFdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc3VjY2Vzc2VzW3Jlc3VsdFswXV0gPSByZXN1bHRbMV0KICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKGYiRG9uZSAoe2xlbihzdWNjZXNzZXMpfS97bGVuKHN1Y2Nlc3NlcykgKyBsZW4oZXJyb3JzKX0pXG4iKQoKICAgIHJldHVybiBzdWNjZXNzZXMsIGVycm9ycwo=
    requirements:
    - librosa
    - noisereduce
    - deepfilternet
    - torchaudio>=2.1.2
    code_origin: ''
    base_image: mlrun/mlrun
  filename: noise_reduction.py
  entry_points:
    reduce_noise:
      parameters:
      - name: audio_source
        type: str
        doc: path to audio file or directory containing audio files
      - name: target_directory
        type: str
        doc: path to directory to save the cleaned audio files.
      - name: sample_rate
        type: int
        doc: Number of samples in one second in the audio file. Pass `None` to keep
          the original sample rate.
        default: 16000
      - name: duration
        type: int
        doc: Duration of the audio file to clean in seconds. Pass `None` to keep the
          original duration.
        default: null
      - name: channel
        type: int
        doc: Channel to clean. Pass the number of the channel to clean. To clean all
          channels pass None.
        default: null
      - name: silence_threshold
        type: float
        doc: The threshold to remove silence from the audio, in dB. If None, no silence
          removal is performed.
        default: null
      - name: use_multiprocessing
        type: int
        doc: Number of processes to use for cleaning the audio files. If 0, no multiprocessing
          is used.
        default: 0
      - name: verbose
        type: bool
        doc: Verbosity level. If True, display progress bar.
        default: true
      name: reduce_noise
      doc: 'Reduce noise from audio file or directory containing audio files.

        The audio files must be in .wav format.

        The cleaned audio files will be saved in the target_directory.

        For information about the noise reduction algorithm see:

        https://github.com/timsainb/noisereduce

        Notice that the saved files are in wav format, even if the original files
        are in other format.'
      has_kwargs: false
      has_varargs: false
      lineno: 388
    clean_audio:
      outputs:
      - type: torch.Tensor
      parameters:
      - name: self
      - name: data
        type: Tensor
      name: clean_audio
      doc: ''
      has_kwargs: false
      has_varargs: false
      lineno: 276
    save_audio:
      parameters:
      - name: self
      - name: audio
        type: ndarray
      - name: target_path
        type: Path
      name: save_audio
      doc: ''
      has_kwargs: false
      has_varargs: false
      lineno: 256
    load_audio:
      outputs:
      - type: torch.Tensor
      parameters:
      - name: self
      - name: file
        type: str
      name: load_audio
      doc: ''
      has_kwargs: false
      has_varargs: false
      lineno: 268
    update_to_wav_suffix:
      parameters:
      - name: self
      - name: audio_file
        type: Path
      name: update_to_wav_suffix
      doc: ''
      has_kwargs: false
      has_varargs: false
      lineno: 125
    remove_silence:
      outputs:
      - doc: The audio without silence.
      parameters:
      - name: self
      - name: audio
        type: ndarray
        doc: The audio to remove silence from.
      name: remove_silence
      doc: Remove silence sections from the audio.
      has_kwargs: false
      has_varargs: false
      lineno: 134
    reduce_noise_dfn:
      parameters:
      - name: audio_source
        type: str
        doc: path to audio file or directory of audio files
      - name: target_directory
        type: str
        doc: path to target directory to save cleaned audio files
      - name: pad
        type: bool
        doc: whether to pad the audio file with zeros before cleaning
        default: true
      - name: atten_lim_db
        type: int
        doc: maximum attenuation in dB
        default: null
      - name: silence_threshold
        type: float
        doc: the threshold to remove silence from the audio, in dB. If None, no silence
          removal is performed.
        default: null
      - name: use_multiprocessing
        type: int
        doc: Number of processes to use for cleaning the audio files. If 0, no multiprocessing
          is used.
        default: 0
      - name: verbose
        type: bool
        doc: verbosity level. If True, display progress bar and logs.
        default: true
      name: reduce_noise_dfn
      doc: 'Reduce noise from audio files using DeepFilterNet.

        For more information about the noise reduction algorithm see:

        https://github.com/Rikorose/DeepFilterNet

        Notice that the saved files are in wav format, even if the original files
        are in other format.'
      has_kwargs: true
      has_varargs: false
      lineno: 322
  command: ''
  description: Reduce noise from audio files
  default_handler: reduce_noise
