kind: job
metadata:
  name: test-classifier
  tag: latest
  hash: e3b2dc7c86800b0958916c3c45207a2cb4881196
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - testing
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: test_classifier
  entry_points:
    _gcf_clear:
      name: _gcf_clear
      doc: ''
      parameters:
      - name: plt
      outputs: []
      lineno: 27
    test_classifier:
      name: test_classifier
      doc: "Test one or more classifier models against held-out dataset\n\nUsing held-out\
        \ test features, evaluates the peformance of the estimated model\n\nCan be\
        \ part of a kubeflow pipeline as a test step that is run post EDA and \ntraining/validation\
        \ cycles"
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: models_dir
        type: str
        doc: artifact models representing a folder or a folder
      - name: test_set
        type: str
        doc: test features and labels
      - name: label_column
        type: str
        doc: column name for ground truth labels
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: key
        type: str
        doc: key for results artifact (maybe just a dir of artifacts for test like
          plots_dir)
      - name: plots_dir
        type: str
        doc: dir for test plots
        default: plots
      outputs: []
      lineno: 32
    _eval_model:
      name: _eval_model
      doc: ''
      parameters:
      - name: model
      outputs: []
      lineno: 61
    plot_roc:
      name: plot_roc
      doc: "plot roc curves\n\nTODO:  add averaging method (as string) that was used\
        \ to create probs, \ndisplay in legend"
      parameters:
      - name: context
        doc: the function context
      - name: y_labels
        doc: 'ground truth labels, hot encoded for multiclass  '
      - name: y_probs
        doc: model prediction probabilities
      - name: key
        doc: ("roc") key of plot in artifact store
        default: roc
      - name: plots_dir
        type: str
        doc: ("plots") destination folder relative path to artifact path
        default: plots
      - name: fmt
        doc: ("png") plot format
        default: png
      - name: fpr_label
        type: str
        doc: ("false positive rate") x-axis labels
        default: false positive rate
      - name: tpr_label
        type: str
        doc: ("true positive rate") y-axis labels
        default: true positive rate
      - name: title
        type: str
        doc: ("roc curve") title of plot
        default: roc curve
      - name: legend_loc
        type: str
        doc: ("best") location of plot legend
        default: best
      outputs: []
      lineno: 91
    plot_confusion_matrix:
      name: plot_confusion_matrix
      doc: 'Create a confusion matrix.

        Plot and save a confusion matrix using test data from a

        modelline step.


        See https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html


        TODO: fix label alignment

        TODO: consider using another packaged version

        TODO: refactor to take params dict for plot options'
      parameters:
      - name: context
        type: MLClientCtx
        doc: function context
      - name: labels
        doc: validation data ground-truth labels
      - name: predictions
        doc: validation data predictions
      - name: key
        type: str
        doc: str
        default: confusion_matrix
      - name: plots_dir
        type: str
        doc: relative path of plots in artifact store
        default: plots
      - name: colormap
        type: str
        doc: colourmap for confusion matrix
        default: Blues
      - name: fiel_ext
        type: str
        default: html
      - name: sample_weight
        doc: sample weights
      outputs: []
      lineno: 145
    plot_importance:
      name: plot_importance
      doc: Display estimated feature importances.
      parameters:
      - name: context
        doc: function context
      - name: model
        doc: fitted lightgbm model
      - name: key
        type: str
        default: feature-importances
      - name: file_ext
        default: html
      outputs: []
      lineno: 183
    _plot_confusion_matrix:
      name: _plot_confusion_matrix
      doc: 'This can be deprecated once intel python upgrades scikit-learn to >0.22


        This function prints and plots the confusion matrix.

        Normalization can be applied by setting `normalize=True`.


        https://scikit-learn.org/0.21/auto_examples/model_selection/plot_confusion_matrix.html#sphx-glr-auto-examples-model-selection-plot-confusion-matrix-py'
      parameters:
      - name: y_true
      - name: y_pred
      - name: classes
        default:
        - neg
        - pos
      - name: normalize
        default: true
      - name: title
      - name: cmap
        default: <_ast.Attribute object at 0x7f092aa97908>
      outputs: []
      lineno: 212
  description: test a classifier using held-out or new data
  image_pull_policy: Always
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI1IDEzOjE3CgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IGltcG9ydGxpYgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBsb2FkCgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZAoKaW1wb3J0IHNrbGVhcm4KZnJvbSBza2xlYXJuIGltcG9ydCBtZXRyaWNzCmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBsYWJlbF9iaW5hcml6ZQpmcm9tIHNrbGVhcm4udXRpbHMubXVsdGljbGFzcyBpbXBvcnQgdW5pcXVlX2xhYmVscwoKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdApmcm9tIG1hdHBsb3RsaWIuZmlndXJlIGltcG9ydCBGaWd1cmUKaW1wb3J0IHNlYWJvcm4gYXMgc25zCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBUYWJsZUFydGlmYWN0LCBQbG90QXJ0aWZhY3QKCmltcG9ydCB3YXJuaW5ncwp3YXJuaW5ncy5zaW1wbGVmaWx0ZXIoYWN0aW9uPSJpZ25vcmUiLCBjYXRlZ29yeT1GdXR1cmVXYXJuaW5nKQoKZGVmIF9nY2ZfY2xlYXIocGx0KToKICAgIHBsdC5jbGEoKQogICAgcGx0LmNsZigpCiAgICBwbHQuY2xvc2UoKSAgICAgICAgCgpkZWYgdGVzdF9jbGFzc2lmaWVyKAogICAgY29udGV4dDogTUxDbGllbnRDdHgsCiAgICBtb2RlbHNfZGlyOiBzdHIsIAogICAgdGVzdF9zZXQ6IHN0ciwKICAgIGxhYmVsX2NvbHVtbjogc3RyLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAnbWljcm8nLAogICAga2V5OiBzdHIgPSAiIiwKICAgIHBsb3RzX2Rpcjogc3RyID0gInBsb3RzIgopIC0+IE5vbmU6CiAgICAiIiJUZXN0IG9uZSBvciBtb3JlIGNsYXNzaWZpZXIgbW9kZWxzIGFnYWluc3QgaGVsZC1vdXQgZGF0YXNldAogICAgCiAgICBVc2luZyBoZWxkLW91dCB0ZXN0IGZlYXR1cmVzLCBldmFsdWF0ZXMgdGhlIHBlZm9ybWFuY2Ugb2YgdGhlIGVzdGltYXRlZCBtb2RlbAogICAgCiAgICBDYW4gYmUgcGFydCBvZiBhIGt1YmVmbG93IHBpcGVsaW5lIGFzIGEgdGVzdCBzdGVwIHRoYXQgaXMgcnVuIHBvc3QgRURBIGFuZCAKICAgIHRyYWluaW5nL3ZhbGlkYXRpb24gY3ljbGVzCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxzX2RpcjogICAgICBhcnRpZmFjdCBtb2RlbHMgcmVwcmVzZW50aW5nIGEgZm9sZGVyIG9yIGEgZm9sZGVyCiAgICA6cGFyYW0gdGVzdF9zZXQ6ICAgICAgICB0ZXN0IGZlYXR1cmVzIGFuZCBsYWJlbHMKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgIGNvbHVtbiBuYW1lIGZvciBncm91bmQgdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gc2NvcmVfbWV0aG9kOiAgICBmb3IgbXVsdGljbGFzcyBjbGFzc2lmaWNhdGlvbgogICAgOnBhcmFtIGtleTogICAgICAgICAgICAga2V5IGZvciByZXN1bHRzIGFydGlmYWN0IChtYXliZSBqdXN0IGEgZGlyIG9mIGFydGlmYWN0cyBmb3IgdGVzdCBsaWtlIHBsb3RzX2RpcikKICAgIDpwYXJhbSBwbG90c19kaXI6ICAgICAgIGRpciBmb3IgdGVzdCBwbG90cwogICAgIiIiCiAgICB4dGVzdCA9IHBkLnJlYWRfcGFycXVldChzdHIodGVzdF9zZXQpKQogICAgeXRlc3QgPSB4dGVzdC5wb3AobGFiZWxfY29sdW1uKQogICAgCiAgICBjb250ZXh0LmhlYWRlciA9IGxpc3QoeHRlc3QuY29sdW1ucy52YWx1ZXMpCiAgICAKICAgIGRlZiBfZXZhbF9tb2RlbChtb2RlbCk6CiAgICAgICAgeXRlc3RiID0gbGFiZWxfYmluYXJpemUoeXRlc3QsIGNsYXNzZXM9eXRlc3QudW5pcXVlKCkpCiAgICAgICAgY2xmID0gbG9hZChvcGVuKG9zLnBhdGguam9pbihzdHIobW9kZWxzX2RpciksIG1vZGVsKSwgInJiIikpCiAgICAgICAgaWYgY2FsbGFibGUoZ2V0YXR0cihjbGYsICJwcmVkaWN0X3Byb2JhIikpOgogICAgICAgICAgICB5X3Njb3JlID0gY2xmLnByZWRpY3RfcHJvYmEoeHRlc3QudmFsdWVzKQogICAgICAgICAgICB5cHJlZCA9IGNsZi5wcmVkaWN0KHh0ZXN0LnZhbHVlcykKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInlfc2NvcmUuc2hhcGUge3lfc2NvcmUuc2hhcGV9IikKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInl0ZXN0Yi5zaGFwZSB7eXRlc3RiLnNoYXBlfSIpCiAgICAgICAgICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl0ZXN0YiwgeV9zY29yZSwga2V5PWYicm9jIiwgcGxvdHNfZGlyPXBsb3RzX2RpcikKICAgICAgICBlbHNlOgogICAgICAgICAgICB5cHJlZCA9IGNsZi5wcmVkaWN0KHh0ZXN0LnZhbHVlcykgIyByZWZhY3RvcgogICAgICAgICAgICB5X3Njb3JlID0gTm9uZQogICAgICAgIHBsb3RfY29uZnVzaW9uX21hdHJpeChjb250ZXh0LCB5dGVzdCwgeXByZWQsIGtleT0iY29uZnVzaW9uIiwgZm10PSJwbmciKQogICAgICAgIGlmIGhhc2F0dHIoY2xmLCAiZmVhdHVyZV9pbXBvcnRhbmNlc18iKToKICAgICAgICAgICAgcGxvdF9pbXBvcnRhbmNlKGNvbnRleHQsIGNsZiwga2V5PWYiZmVhdGltcCIpCiAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl0ZXN0Yls6LDotMV0sIHlfc2NvcmUsIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImFjY3VyYWN5IiwgZmxvYXQoY2xmLnNjb3JlKHh0ZXN0LnZhbHVlcywgeXRlc3QudmFsdWVzKSkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl0ZXN0YiwgeV9zY29yZSkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiZjFfc2NvcmUiLCBtZXRyaWNzLmYxX3Njb3JlKHl0ZXN0LnZhbHVlcywgeXByZWQsIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhdmdfcHJlY3Njb3JlIiwgYXZlcmFnZV9wcmVjaXNpb24pCiAgICAKICAgIGJlc3RfbW9kZWwgPSBOb25lCiAgICBmb3IgbW9kZWwgaW4gb3MubGlzdGRpcihzdHIobW9kZWxzX2RpcikpOgogICAgICAgIGlmIG1vZGVsLmVuZHN3aXRoKCcucGtsJyk6CiAgICAgICAgICAgIF9ldmFsX21vZGVsKG1vZGVsKQogICAgICAgICAgICBiZXN0X21vZGVsID0gbW9kZWwKCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgnVE9EQVlTLU1PREVMUy1URVNULVJFUE9SVCcsIGxvY2FsX3BhdGg9YmVzdF9tb2RlbCkKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KCdERVBMT1knLCBib2R5PWIndHJ1ZScsIGxvY2FsX3BhdGg9J0RFUExPWScpCiAgICAKZGVmIHBsb3Rfcm9jKAogICAgY29udGV4dCwKICAgIHlfbGFiZWxzLAogICAgeV9wcm9icywKICAgIGtleT0icm9jIiwKICAgIHBsb3RzX2Rpcjogc3RyID0gInBsb3RzIiwKICAgIGZtdD0icG5nIiwKICAgIGZwcl9sYWJlbDogc3RyID0gImZhbHNlIHBvc2l0aXZlIHJhdGUiLAogICAgdHByX2xhYmVsOiBzdHIgPSAgInRydWUgcG9zaXRpdmUgcmF0ZSIsCiAgICB0aXRsZTogc3RyID0gInJvYyBjdXJ2ZSIsCiAgICBsZWdlbmRfbG9jOiBzdHIgPSAiYmVzdCIKKToKICAgICIiInBsb3Qgcm9jIGN1cnZlcwogICAgCiAgICBUT0RPOiAgYWRkIGF2ZXJhZ2luZyBtZXRob2QgKGFzIHN0cmluZykgdGhhdCB3YXMgdXNlZCB0byBjcmVhdGUgcHJvYnMsIAogICAgZGlzcGxheSBpbiBsZWdlbmQKICAgIAogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSB5X2xhYmVsczogICAgIGdyb3VuZCB0cnV0aCBsYWJlbHMsIGhvdCBlbmNvZGVkIGZvciBtdWx0aWNsYXNzICAKICAgIDpwYXJhbSB5X3Byb2JzOiAgICAgIG1vZGVsIHByZWRpY3Rpb24gcHJvYmFiaWxpdGllcwogICAgOnBhcmFtIGtleTogICAgICAgICAgKCJyb2MiKSBrZXkgb2YgcGxvdCBpbiBhcnRpZmFjdCBzdG9yZQogICAgOnBhcmFtIHBsb3RzX2RpcjogICAgKCJwbG90cyIpIGRlc3RpbmF0aW9uIGZvbGRlciByZWxhdGl2ZSBwYXRoIHRvIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBmbXQ6ICAgICAgICAgICgicG5nIikgcGxvdCBmb3JtYXQKICAgIDpwYXJhbSBmcHJfbGFiZWw6ICAgICgiZmFsc2UgcG9zaXRpdmUgcmF0ZSIpIHgtYXhpcyBsYWJlbHMKICAgIDpwYXJhbSB0cHJfbGFiZWw6ICAgICgidHJ1ZSBwb3NpdGl2ZSByYXRlIikgeS1heGlzIGxhYmVscwogICAgOnBhcmFtIHRpdGxlOiAgICAgICAgKCJyb2MgY3VydmUiKSB0aXRsZSBvZiBwbG90CiAgICA6cGFyYW0gbGVnZW5kX2xvYzogICAoImJlc3QiKSBsb2NhdGlvbiBvZiBwbG90IGxlZ2VuZAogICAgIiIiCiAgICBfZ2NmX2NsZWFyKHBsdCkKICAgIAogICAgcGx0LnBsb3QoWzAsIDFdLCBbMCwgMV0sICJrLS0iKQogICAgCiAgICBwbHQueGxhYmVsKGZwcl9sYWJlbCkKICAgIHBsdC55bGFiZWwodHByX2xhYmVsKQogICAgcGx0LnRpdGxlKHRpdGxlKQogICAgcGx0LmxlZ2VuZChsb2M9bGVnZW5kX2xvYykKICAgIAogICAgaWYgeV9sYWJlbHMuc2hhcGVbMV0gPiAxOgogICAgICAgIGZwciA9IGRpY3QoKQogICAgICAgIHRwciA9IGRpY3QoKQogICAgICAgIHJvY19hdWMgPSBkaWN0KCkKICAgICAgICBmb3IgaSBpbiByYW5nZSh5X2xhYmVsc1s6LDotMV0uc2hhcGVbMV0pOgogICAgICAgICAgICBmcHJbaV0sIHRwcltpXSwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzWzosIGldLCB5X3Byb2JzWzosIGldLCBwb3NfbGFiZWw9MSkKICAgICAgICAgICAgcm9jX2F1Y1tpXSA9IG1ldHJpY3MuYXVjKGZwcltpXSwgdHByW2ldKQogICAgICAgICAgICBwbHQucGxvdChmcHJbaV0sIHRwcltpXSwgbGFiZWw9ZiJjbGFzcyB7aX0iKQogICAgZWxzZToKICAgICAgICBmcHIsIHRwciwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzLCB5X3Byb2JzWzosIDFdLCBwb3NfbGFiZWw9MSkKICAgICAgICBwbHQucGxvdChmcHIsIHRwciwgbGFiZWw9ZiJwb3NpdGl2ZSBjbGFzcyIpCiAgICAgICAgCiAgICBmbmFtZSA9IGYie3Bsb3RzX2Rpcn0ve2tleX0ue2ZtdH0iCiAgICBwbHQuc2F2ZWZpZyhvcy5wYXRoLmpvaW4oY29udGV4dC5hcnRpZmFjdF9wYXRoLCBmbmFtZSkpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3Qoa2V5LCBib2R5PXBsdC5nY2YoKSksIGxvY2FsX3BhdGg9Zm5hbWUpCiAgICAKCmRlZiBwbG90X2NvbmZ1c2lvbl9tYXRyaXgoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGxhYmVscywKICAgIHByZWRpY3Rpb25zLAogICAga2V5OiBzdHIgPSAiY29uZnVzaW9uX21hdHJpeCIsCiAgICBwbG90c19kaXI6IHN0ciA9ICJwbG90cyIsCiAgICBjb2xvcm1hcDogc3RyID0gIkJsdWVzIiwKICAgIGZpZWxfZXh0OiBzdHIgPSAiaHRtbCIsCiAgICBzYW1wbGVfd2VpZ2h0PU5vbmUKKToKICAgICIiIkNyZWF0ZSBhIGNvbmZ1c2lvbiBtYXRyaXguCiAgICBQbG90IGFuZCBzYXZlIGEgY29uZnVzaW9uIG1hdHJpeCB1c2luZyB0ZXN0IGRhdGEgZnJvbSBhCiAgICBtb2RlbGxpbmUgc3RlcC4KICAgIAogICAgU2VlIGh0dHBzOi8vc2Npa2l0LWxlYXJuLm9yZy9zdGFibGUvbW9kdWxlcy9nZW5lcmF0ZWQvc2tsZWFybi5tZXRyaWNzLmNvbmZ1c2lvbl9tYXRyaXguaHRtbAogICAgCiAgICBUT0RPOiBmaXggbGFiZWwgYWxpZ25tZW50CiAgICBUT0RPOiBjb25zaWRlciB1c2luZyBhbm90aGVyIHBhY2thZ2VkIHZlcnNpb24KICAgIFRPRE86IHJlZmFjdG9yIHRvIHRha2UgcGFyYW1zIGRpY3QgZm9yIHBsb3Qgb3B0aW9ucwoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBsYWJlbHM6ICAgICAgICAgIHZhbGlkYXRpb24gZGF0YSBncm91bmQtdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gcHJlZGljdGlvbnM6ICAgICB2YWxpZGF0aW9uIGRhdGEgcHJlZGljdGlvbnMKICAgIDpwYXJhbSBrZXk6ICAgICAgICAgICAgIHN0cgogICAgOnBhcmFtIHBsb3RzX2RpcjogICAgICAgcmVsYXRpdmUgcGF0aCBvZiBwbG90cyBpbiBhcnRpZmFjdCBzdG9yZQogICAgOnBhcmFtIGNvbG9ybWFwOiAgICAgICAgY29sb3VybWFwIGZvciBjb25mdXNpb24gbWF0cml4CiAgICA6cGFyYW0gZm10OiAgICAgICAgICAgICBwbG90IGZvcm1hdAogICAgOnBhcmFtIHNhbXBsZV93ZWlnaHQ6ICAgc2FtcGxlIHdlaWdodHMKICAgICIiIgogICAgX2djZl9jbGVhcihwbHQpCiAgICAKICAgIGNtID0gbWV0cmljcy5jb25mdXNpb25fbWF0cml4KGxhYmVscywgcHJlZGljdGlvbnMsIHNhbXBsZV93ZWlnaHQ9Tm9uZSkKICAgIHNucy5oZWF0bWFwKGNtLCBhbm5vdD1UcnVlLCBjbWFwPWNvbG9ybWFwLCBzcXVhcmU9VHJ1ZSkKCiAgICBmaWcgPSBwbHQuZ2NmKCkKICAgIGZuYW1lID0gZiJ7cGxvdHNfZGlyfS97a2V5fS57Zm10fSIKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdChrZXksIGJvZHk9ZmlnKSwgbG9jYWxfcGF0aD1mbmFtZSkKCmRlZiBwbG90X2ltcG9ydGFuY2UoCiAgICBjb250ZXh0LAogICAgbW9kZWwsCiAgICBrZXk6IHN0ciA9ICJmZWF0dXJlLWltcG9ydGFuY2VzIiwKICAgIGZpbGVfZXh0ID0gImh0bWwiCik6CiAgICAiIiJEaXNwbGF5IGVzdGltYXRlZCBmZWF0dXJlIGltcG9ydGFuY2VzLgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWw6ICAgICAgIGZpdHRlZCBsaWdodGdibSBtb2RlbAogICAgIiIiCiAgICBfZ2NmX2NsZWFyKHBsdCkKICAgIAogICAgemlwcGVkID0gemlwKG1vZGVsLmZlYXR1cmVfaW1wb3J0YW5jZXNfLCBjb250ZXh0LmhlYWRlcikKCiAgICBmZWF0dXJlX2ltcCA9IHBkLkRhdGFGcmFtZShzb3J0ZWQoemlwcGVkKSwgY29sdW1ucz1bImZyZXEiLCJmZWF0dXJlIl0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApLnNvcnRfdmFsdWVzKGJ5PSJmcmVxIiwgYXNjZW5kaW5nPUZhbHNlKQoKICAgIHBsdC5maWd1cmUoZmlnc2l6ZT0oMjAsIDEwKSkKICAgIHNucy5iYXJwbG90KHg9ImZyZXEiLCB5PSJmZWF0dXJlIiwgZGF0YT1mZWF0dXJlX2ltcCkKICAgIHBsdC50aXRsZSgiZmVhdHVyZXMiKQogICAgcGx0LnRpZ2h0X2xheW91dCgpCgogICAgZmlnID0gcGx0LmdjZigpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QoZiJ7a2V5fS57Zm10fSIsIGJvZHk9ZmlnKSwgbG9jYWxfcGF0aD1mInBsb3RzL3trZXl9LntmbXR9IikKCiAgICBmZWF0dXJlX2ltcC50b19jc3Yob3MucGF0aC5qb2luKGNvbnRleHQuYXJ0aWZhY3RfcGF0aCwga2V5KyIuY3N2IikpCiAgICAKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KGtleSsiLmNzdiIsIGxvY2FsX3BhdGg9a2V5KyIuY3N2IikKCmRlZiBfcGxvdF9jb25mdXNpb25fbWF0cml4KHlfdHJ1ZSwgeV9wcmVkLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3Nlcz1bIm5lZyIsICJwb3MiXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICBjbWFwPXBsdC5jbS5CbHVlcyk6CiAgICAiIiJUaGlzIGNhbiBiZSBkZXByZWNhdGVkIG9uY2UgaW50ZWwgcHl0aG9uIHVwZ3JhZGVzIHNjaWtpdC1sZWFybiB0byA+MC4yMgogICAgCiAgICBUaGlzIGZ1bmN0aW9uIHByaW50cyBhbmQgcGxvdHMgdGhlIGNvbmZ1c2lvbiBtYXRyaXguCiAgICBOb3JtYWxpemF0aW9uIGNhbiBiZSBhcHBsaWVkIGJ5IHNldHRpbmcgYG5vcm1hbGl6ZT1UcnVlYC4KICAgIAogICAgaHR0cHM6Ly9zY2lraXQtbGVhcm4ub3JnLzAuMjEvYXV0b19leGFtcGxlcy9tb2RlbF9zZWxlY3Rpb24vcGxvdF9jb25mdXNpb25fbWF0cml4Lmh0bWwjc3BoeC1nbHItYXV0by1leGFtcGxlcy1tb2RlbC1zZWxlY3Rpb24tcGxvdC1jb25mdXNpb24tbWF0cml4LXB5CiAgICAiIiIKICAgIGlmIG5vdCB0aXRsZToKICAgICAgICBpZiBub3JtYWxpemU6CiAgICAgICAgICAgIHRpdGxlID0gIk5vcm1hbGl6ZWQgY29uZnVzaW9uIG1hdHJpeCIKICAgICAgICBlbHNlOgogICAgICAgICAgICB0aXRsZSA9ICJDb25mdXNpb24gbWF0cml4LCB3aXRob3V0IG5vcm1hbGl6YXRpb24iCgogICAgY20gPSBjb25mdXNpb25fbWF0cml4KHlfdHJ1ZSwgeV9wcmVkKQogICAgaWYgbm9ybWFsaXplOgogICAgICAgIGNtID0gY20uYXN0eXBlKCJmbG9hdCIpIC8gY20uc3VtKGF4aXM9MSlbOiwgbnAubmV3YXhpc10KCiAgICBmaWcsIGF4ID0gcGx0LnN1YnBsb3RzKCkKICAgIGltID0gYXguaW1zaG93KGNtLCBpbnRlcnBvbGF0aW9uPSJuZWFyZXN0IiwgY21hcD1jbWFwKQogICAgYXguZmlndXJlLmNvbG9yYmFyKGltLCBheD1heCkKICAgIGF4LnNldCh4dGlja3M9bnAuYXJhbmdlKGNtLnNoYXBlWzFdKSwKICAgICAgICAgICB5dGlja3M9bnAuYXJhbmdlKGNtLnNoYXBlWzBdKSwKICAgICAgICAgICB4dGlja2xhYmVscz1jbGFzc2VzLCB5dGlja2xhYmVscz1jbGFzc2VzLAogICAgICAgICAgIHRpdGxlPXRpdGxlLAogICAgICAgICAgIHlsYWJlbD0iVHJ1ZSBsYWJlbCIsCiAgICAgICAgICAgeGxhYmVsPSJQcmVkaWN0ZWQgbGFiZWwiKQoKICAgIHBsdC5zZXRwKGF4LmdldF94dGlja2xhYmVscygpLCByb3RhdGlvbj00NSwgaGE9InJpZ2h0IiwKICAgICAgICAgICAgIHJvdGF0aW9uX21vZGU9ImFuY2hvciIpCgogICAgZm10ID0gIi4yZiIgaWYgbm9ybWFsaXplIGVsc2UgImQiCiAgICB0aHJlc2ggPSBjbS5tYXgoKSAvIDIuCiAgICBmb3IgaSBpbiByYW5nZShjbS5zaGFwZVswXSk6CiAgICAgICAgZm9yIGogaW4gcmFuZ2UoY20uc2hhcGVbMV0pOgogICAgICAgICAgICBheC50ZXh0KGosIGksIGZvcm1hdChjbVtpLCBqXSwgZm10KSwKICAgICAgICAgICAgICAgICAgICBob3Jpem9udGFsYWxpZ25tZW50PSJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgIGNvbG9yPSJ3aGl0ZSIgaWYgY21baSwgal0gPiB0aHJlc2ggZWxzZSAiYmxhY2siKQogICAgZmlnLnRpZ2h0X2xheW91dCgpCiAgICByZXR1cm4gYXggICAgCgo=
    commands: []
    code_origin: https://github.com/mlrun/functions.git#ba3f8f6b27884c0830ca378bc124821b30f95e66:test_classifier.ipynb
