kind: job
metadata:
  name: batch-inference-v2
  tag: ''
  hash: e4a5180b9104c09a1f443ed3d8fbb0924aa5b656
  project: ''
  labels:
    author: eyald
  categories:
  - utils
  - data-analysis
  - monitoring
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCgpmcm9tIHR5cGluZyBpbXBvcnQgQW55LCBEaWN0LCBMaXN0LCBVbmlvbgoKaW1wb3J0IG1scnVuCgp0cnk6CiAgICBpbXBvcnQgbWxydW4ubW9kZWxfbW9uaXRvcmluZy5hcGkKZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3I6CiAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5Ob3RGb3VuZEVycm9yKAogICAgICAgIGYiUGxlYXNlIHVwZGF0ZSB5b3VyIGBtbHJ1bmAgdmVyc2lvbiB0byA+PTEuNS4wIG9yIHVzZSBhbiAiCiAgICAgICAgZiJvbGRlciB2ZXJzaW9uIG9mIHRoZSBiYXRjaCBpbmZlcmVuY2UgZnVuY3Rpb24uIgogICAgKQoKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gbWxydW4uZnJhbWV3b3Jrcy5hdXRvX21scnVuIGltcG9ydCBBdXRvTUxSdW4KCgpkZWYgX3ByZXBhcmVfcmVzdWx0X3NldCgKICAgIHg6IHBkLkRhdGFGcmFtZSwgbGFiZWxfY29sdW1uczogTGlzdFtzdHJdLCB5X3ByZWQ6IG5wLm5kYXJyYXkKKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAiIiIKICAgIFNldCBkZWZhdWx0IGxhYmVsIGNvbHVtbiBuYW1lcyBhbmQgdmFsaWRhdGUgZ2l2ZW4gbmFtZXMgdG8gcHJlcGFyZSB0aGUgcmVzdWx0IHNldCAtIGEgY29uY2F0ZW5hdGlvbiBvZiB0aGUgaW5wdXRzCiAgICAoeCkgYW5kIHRoZSBtb2RlbCBwcmVkaWN0aW9ucyAoeV9wcmVkKS4KCiAgICA6cGFyYW0geDogICAgICAgICAgICAgVGhlIGlucHV0cy4KICAgIDpwYXJhbSBsYWJlbF9jb2x1bW5zOiBBIGxpc3Qgb2Ygc3RyaW5ncyByZXByZXNlbnRpbmcgdGhlIHRhcmdldCBjb2x1bW4gbmFtZXMgdG8gYWRkIHRvIHRoZSBwcmVkaWN0aW9ucy4gRGVmYXVsdCBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSB1c2VkIGluIGNhc2UgdGhlIGxpc3QgaXMgZW1wdHkgKHByZWRpY3RlZF9sYWJlbF97aX0pLgogICAgOnBhcmFtIHlfcHJlZDogICAgICAgIFRoZSBtb2RlbCBwcmVkaWN0aW9ucyBvbiB0aGUgaW5wdXRzLgoKICAgIDpyZXR1cm5zOiBUaGUgcmVzdWx0IHNldC4KCiAgICByYWlzZXMgTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcjogSWYgdGhlIGxhYmVscyBjb2x1bW5zIGFtb3VudCBkbyBub3QgbWF0Y2ggdGhlIG91dHB1dHMgb3IgaWYgb25lIG9mIHRoZSBsYWJlbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW4gYWxyZWFkeSBleGlzdHMgaW4gdGhlIGRhdGFzZXQuCiAgICAiIiIKICAgICMgUHJlcGFyZSBkZWZhdWx0IHRhcmdldCBjb2x1bW5zIG5hbWVzIGlmIG5vdCBwcm92aWRlZDoKICAgIHByZWRpY3Rpb25fY29sdW1uc19hbW91bnQgPSAxIGlmIGxlbih5X3ByZWQuc2hhcGUpID09IDEgZWxzZSB5X3ByZWQuc2hhcGVbMV0KICAgIGlmIGxlbihsYWJlbF9jb2x1bW5zKSA9PSAwOgogICAgICAgICMgQWRkIGRlZmF1bHQgbGFiZWwgY29sdW1uIG5hbWVzOgogICAgICAgIGlmIHByZWRpY3Rpb25fY29sdW1uc19hbW91bnQgPT0gMToKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsicHJlZGljdGVkX2xhYmVsIl0KICAgICAgICBlbHNlOgogICAgICAgICAgICBsYWJlbF9jb2x1bW5zID0gWwogICAgICAgICAgICAgICAgZiJwcmVkaWN0ZWRfbGFiZWxfe2l9IiBmb3IgaSBpbiByYW5nZShwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50KQogICAgICAgICAgICBdCgogICAgIyBWYWxpZGF0ZSB0aGUgbGFiZWwgY29sdW1uczoKICAgIGlmIHByZWRpY3Rpb25fY29sdW1uc19hbW91bnQgIT0gbGVuKGxhYmVsX2NvbHVtbnMpOgogICAgICAgICMgTm8gZXF1YWxpdHkgYmV0d2VlbiBwcm92aWRlZCBsYWJlbCBjb2x1bW4gbmFtZXMgYW5kIG91dHB1dHMgYW1vdW50OgogICAgICAgIHJhaXNlIG1scnVuLmVycm9ycy5NTFJ1bkludmFsaWRBcmd1bWVudEVycm9yKAogICAgICAgICAgICBmIlRoZSBudW1iZXIgb2YgcHJlZGljdGVkIGxhYmVsczoge3ByZWRpY3Rpb25fY29sdW1uc19hbW91bnR9ICIKICAgICAgICAgICAgZiJpcyBub3QgZXF1YWwgdG8gdGhlIGdpdmVuIGxhYmVsIGNvbHVtbnM6IHtsZW4obGFiZWxfY29sdW1ucyl9IgogICAgICAgICkKICAgIGNvbW1vbl9sYWJlbHMgPSBzZXQobGFiZWxfY29sdW1ucykgJiBzZXQoeC5jb2x1bW5zLnRvbGlzdCgpKQogICAgaWYgY29tbW9uX2xhYmVsczoKICAgICAgICAjIExhYmVsIGNvbHVtbiBleGlzdCBpbiB0aGUgb3JpZ2luYWwgaW5wdXRzOgogICAgICAgIHJhaXNlIG1scnVuLmVycm9ycy5NTFJ1bkludmFsaWRBcmd1bWVudEVycm9yKAogICAgICAgICAgICBmIlRoZSBsYWJlbHM6IHtjb21tb25fbGFiZWxzfSBhcmUgYWxyZWFkeSBleGlzdGVkIGluIHRoZSBnaXZlbiBkYXRhc2V0LiIKICAgICAgICApCgogICAgcmV0dXJuIHBkLmNvbmNhdCgKICAgICAgICBbeCwgcGQuRGF0YUZyYW1lKHlfcHJlZCwgY29sdW1ucz1sYWJlbF9jb2x1bW5zLCBpbmRleD14LmluZGV4KV0sIGF4aXM9MQogICAgKQoKCmRlZiBpbmZlcigKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgZGF0YXNldDogVW5pb25bbWxydW4uRGF0YUl0ZW0sIGxpc3QsIGRpY3QsIHBkLkRhdGFGcmFtZSwgcGQuU2VyaWVzLCBucC5uZGFycmF5XSwKICAgIG1vZGVsX3BhdGg6IFVuaW9uW3N0ciwgbWxydW4uRGF0YUl0ZW1dLAogICAgZHJvcF9jb2x1bW5zOiBVbmlvbltzdHIsIExpc3Rbc3RyXSwgaW50LCBMaXN0W2ludF1dID0gTm9uZSwKICAgIGxhYmVsX2NvbHVtbnM6IFVuaW9uW3N0ciwgTGlzdFtzdHJdXSA9IE5vbmUsCiAgICBmZWF0dXJlX2NvbHVtbnM6IFVuaW9uW3N0ciwgTGlzdFtzdHJdXSA9IE5vbmUsCiAgICBsb2dfcmVzdWx0X3NldDogYm9vbCA9IFRydWUsCiAgICByZXN1bHRfc2V0X25hbWU6IHN0ciA9ICJwcmVkaWN0aW9uIiwKICAgIGJhdGNoX2lkOiBzdHIgPSBOb25lLAogICAgYXJ0aWZhY3RzX3RhZzogc3RyID0gIiIsCiAgICAjIERyaWZ0IGFuYWx5c2lzIHBhcmFtZXRlcnMKICAgIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXM6IGJvb2wgPSBOb25lLAogICAgdHJpZ2dlcl9tb25pdG9yaW5nX2pvYjogYm9vbCA9IEZhbHNlLAogICAgYmF0Y2hfaW1hZ2Vfam9iOiBzdHIgPSAibWxydW4vbWxydW4iLAogICAgZW5kcG9pbnRfaWQ6IHN0ciA9ICIiLAogICAgIyBUaGUgZm9sbG93aW5nIG1vZGVsIGVuZHBvaW50IHBhcmFtZXRlcnMgYXJlIHJlbGV2YW50IG9ubHkgaWY6CiAgICAjIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgaXMgbm90IGRpc2FibGVkCiAgICAjIGEgbmV3IG1vZGVsIGVuZHBvaW50IHJlY29yZCBpcyBnb2luZyB0byBiZSBnZW5lcmF0ZWQKICAgIG1vZGVsX2VuZHBvaW50X25hbWU6IHN0ciA9ICJiYXRjaC1pbmZlciIsCiAgICBtb2RlbF9lbmRwb2ludF9kcmlmdF90aHJlc2hvbGQ6IGZsb2F0ID0gMC43LAogICAgbW9kZWxfZW5kcG9pbnRfcG9zc2libGVfZHJpZnRfdGhyZXNob2xkOiBmbG9hdCA9IDAuNSwKICAgIG1vZGVsX2VuZHBvaW50X3NhbXBsZV9zZXQ6IFVuaW9uWwogICAgICAgIG1scnVuLkRhdGFJdGVtLCBsaXN0LCBkaWN0LCBwZC5EYXRhRnJhbWUsIHBkLlNlcmllcywgbnAubmRhcnJheQogICAgXSA9IE5vbmUsCiAgICAqKnByZWRpY3Rfa3dhcmdzOiBEaWN0W3N0ciwgQW55XSwKKToKICAgICIiIgogICAgUGVyZm9ybSBhIHByZWRpY3Rpb24gb24gYSBnaXZlbiBkYXRhc2V0IHdpdGggdGhlIGdpdmVuIG1vZGVsLiBQbGVhc2UgbWFrZSBzdXJlIHRoYXQgeW91IGhhdmUgYWxyZWFkeSBsb2dnZWQgdGhlIG1vZGVsCiAgICB1bmRlciB0aGUgY3VycmVudCBwcm9qZWN0LgogICAgQ2FuIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgYmV0d2VlbiB0aGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzIHN0b3JlZCBpbiB0aGUgbW9kZWwgdG8gdGhlIGN1cnJlbnQgaW5wdXQgZGF0YS4gVGhlCiAgICBkcmlmdCBydWxlIGlzIHRoZSB2YWx1ZSBwZXItZmVhdHVyZSBtZWFuIG9mIHRoZSBUVkQgYW5kIEhlbGxpbmdlciBzY29yZXMgYWNjb3JkaW5nIHRvIHRoZSB0aHJlc2hvbGRzIGNvbmZpZ3VyZXMKICAgIGhlcmUuIFdoZW4gcGVyZm9ybWluZyBkcmlmdCBhbmFseXNpcywgdGhpcyBmdW5jdGlvbiBlaXRoZXIgdXNlcyBhbiBleGlzdGluZyBtb2RlbCBlbmRwb2ludCByZWNvcmQgb3IgY3JlYXRlcwogICAgYSBuZXcgb25lLgogICAgQXQgdGhlIG1vbWVudCwgdGhpcyBmdW5jdGlvbiBpcyBzdXBwb3J0ZWQgZm9yIGBtbHJ1bj49MS41LjBgIHZlcnNpb25zLgoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1MUnVuIGNvbnRleHQuCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGF0YXNldCB0byBpbmZlciB0aHJvdWdoIHRoZSBtb2RlbC4gUHJvdmlkZWQgYXMgYW4gaW5wdXQgKERhdGFJdGVtKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdCByZXByZXNlbnRzIERhdGFzZXQgYXJ0aWZhY3QgLyBGZWF0dXJlIHZlY3RvciBVUkkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB1c2luZyBNTFJ1biBTREssIGBkYXRhc2V0YCBjYW4gYWxzbyBiZSBwcm92aWRlZCBhcyBhIGxpc3QsIGRpY3Rpb25hcnkgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bXB5IGFycmF5LgogICAgOnBhcmFtIG1vZGVsX3BhdGg6ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW9kZWwgc3RvcmUgdXJpIChzaG91bGQgc3RhcnQgd2l0aCBzdG9yZTovLykuIFByb3ZpZGVkIGFzIGFuIGlucHV0IChEYXRhSXRlbSkuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB1c2luZyBNTFJ1biBTREssIGBtb2RlbF9wYXRoYCBjYW4gYWxzbyBiZSBwcm92aWRlZCBhcyBhIHBhcmFtZXRlciAoc3RyaW5nKS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRvIGdlbmVyYXRlIGEgdmFsaWQgbW9kZWwgc3RvcmUgVVJJLCBwbGVhc2UgbG9nIHRoZSBtb2RlbCBiZWZvcmUgcnVubmluZyB0aGlzIGZ1bmN0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgYGVuZHBvaW50X2lkYCBvZiBleGlzdGluZyBtb2RlbCBlbmRwb2ludCBpcyBwcm92aWRlZCwgbWFrZSBzdXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0IGl0IGhhcyBhIHNpbWlsYXIgbW9kZWwgc3RvcmUgcGF0aCwgb3RoZXJ3aXNlIHRoZSBkcmlmdCBhbmFseXNpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29uJ3QgYmUgdHJpZ2dlcmVkLgogICAgOnBhcmFtIGRyb3BfY29sdW1uczogICAgICAgICAgICAgICAgICAgICAgICAgICAgQSBzdHJpbmcgLyBpbnRlZ2VyIG9yIGEgbGlzdCBvZiBzdHJpbmdzIC8gaW50ZWdlcnMgdGhhdCByZXByZXNlbnQgdGhlIGNvbHVtbiBuYW1lcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyBpbmRpY2VzIHRvIGRyb3AuIFdoZW4gdGhlIGRhdGFzZXQgaXMgYSBsaXN0IG9yIGEgbnVtcHkgYXJyYXkgdGhpcyBwYXJhbWV0ZXIgbXVzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmUgcmVwcmVzZW50ZWQgYnkgaW50ZWdlcnMuCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uczogICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgdGFyZ2V0IGxhYmVsKHMpIG9mIHRoZSBjb2x1bW4ocykgaW4gdGhlIGRhdGFzZXQgZm9yIFJlZ3Jlc3Npb24gb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENsYXNzaWZpY2F0aW9uIHRhc2tzLiBUaGUgbGFiZWwgY29sdW1uIGNhbiBiZSBhY2Nlc3NlZCBmcm9tIHRoZSBtb2RlbCBvYmplY3QsIG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgZmVhdHVyZSB2ZWN0b3IgcHJvdmlkZWQgaWYgYXZhaWxhYmxlLgogICAgOnBhcmFtIGZlYXR1cmVfY29sdW1uczogICAgICAgICAgICAgICAgICAgICAgICAgTGlzdCBvZiBmZWF0dXJlIGNvbHVtbnMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gYnVpbGQgdGhlIGRhdGFmcmFtZSB3aGVuIGRhdGFzZXQgaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gdHlwZSBsaXN0IG9yIG51bXB5IGFycmF5LgogICAgOnBhcmFtIGxvZ19yZXN1bHRfc2V0OiAgICAgICAgICAgICAgICAgICAgICAgICAgV2hldGhlciB0byBsb2cgdGhlIHJlc3VsdCBzZXQgLSBhIERhdGFGcmFtZSBvZiB0aGUgZ2l2ZW4gaW5wdXRzIGNvbmNhdGVuYXRlZCB3aXRoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgcHJlZGljdGlvbnMuIERlZmF1bHRlZCB0byBUcnVlLgogICAgOnBhcmFtIHJlc3VsdF9zZXRfbmFtZTogICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRiIGtleSB0byBzZXQgbmFtZSBvZiB0aGUgcHJlZGljdGlvbiByZXN1bHQgYW5kIHRoZSBmaWxlbmFtZS4gRGVmYXVsdGVkIHRvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncHJlZGljdGlvbicuCiAgICA6cGFyYW0gYmF0Y2hfaWQ6ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgSUQgb2YgdGhlIGdpdmVuIGJhdGNoIChpbmZlcmVuY2UgZGF0YXNldCkuIElmIGBOb25lYCwgaXQgd2lsbCBiZSBnZW5lcmF0ZWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBXaWxsIGJlIGxvZ2dlZCBhcyBhIHJlc3VsdCBvZiB0aGUgcnVuLgogICAgOnBhcmFtIGFydGlmYWN0c190YWc6ICAgICAgICAgICAgICAgICAgICAgICAgICAgVGFnIHRvIHVzZSBmb3IgYWxsIHRoZSBhcnRpZmFjdHMgcmVzdWx0ZWQgZnJvbSB0aGUgZnVuY3Rpb24gKHJlc3VsdCBzZXQgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbCBtb25pdG9yaW5nIGFydGlmYWN0cykKICAgIDpwYXJhbSBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzOiAgICAgICAgICAgICAgICAgIFdoZXRoZXIgdG8gcGVyZm9ybSBkcmlmdCBhbmFseXNpcyBiZXR3ZWVuIHRoZSBzYW1wbGUgc2V0IG9mIHRoZSBtb2RlbCBvYmplY3QgdG8gdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0IGdpdmVuLiBCeSBkZWZhdWx0LCBOb25lLCB3aGljaCBtZWFucyBpdCB3aWxsIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgaWYgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbCBhbHJlYWR5IGhhcyBmZWF0dXJlIHN0YXRzIHRoYXQgYXJlIGNvbnNpZGVyZWQgYXMgYSByZWZlcmVuY2Ugc2FtcGxlIHNldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBlcmZvcm1pbmcgZHJpZnQgYW5hbHlzaXMgb24gYSBuZXcgZW5kcG9pbnQgaWQgd2lsbCBnZW5lcmF0ZSBhIG5ldyBtb2RlbCBlbmRwb2ludAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkLiBQbGVhc2Ugbm90ZSB0aGF0IGluIG9yZGVyIHRvIHRyaWdnZXIgdGhlIGRyaWZ0IGFuYWx5c2lzIGpvYiwgeW91IG5lZWQgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldCBgdHJpZ2dlcl9tb25pdG9yaW5nX2pvYj1UcnVlYC4gT3RoZXJ3aXNlLCB0aGUgZHJpZnQgYW5hbHlzaXMgd2lsbCBiZSB0cmlnZ2VyZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHkgYXMgcGFydCB0aGUgc2NoZWR1bGVkIG1vbml0b3Jpbmcgam9iIChpZiBleGlzdCBpbiB0aGUgY3VycmVudCBwcm9qZWN0KSBvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdHJpZ2dlcmVkIG1hbnVhbGx5IGJ5IHRoZSB1c2VyLgogICAgOnBhcmFtIHRyaWdnZXJfbW9uaXRvcmluZ19qb2I6ICAgICAgICAgICAgICAgICAgV2hldGhlciB0byB0cmlnZ2VyIHRoZSBiYXRjaCBkcmlmdCBhbmFseXNpcyBhZnRlciB0aGUgaW5mZXIgam9iLgogICAgOnBhcmFtIGJhdGNoX2ltYWdlX2pvYjogICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIHJlZ2lzdGVyIHRoZSBtb25pdG9yaW5nIGJhdGNoIGpvYiBpZiBub3QgZXhpc3QuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCeSBkZWZhdWx0LCB0aGUgaW1hZ2UgaXMgbWxydW4vbWxydW4uCiAgICA6cGFyYW0gZW5kcG9pbnRfaWQ6ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNb2RlbCBlbmRwb2ludCB1bmlxdWUgSUQuIElmIGBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzYCB3YXMgc2V0LCB0aGUgZW5kcG9pbnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgdXNlZCBlaXRoZXIgdG8gcGVyZm9ybSB0aGUgYW5hbHlzaXMgb24gZXhpc3RpbmcgbW9kZWwgZW5kcG9pbnQgb3IgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlIGEgbmV3IG1vZGVsIGVuZHBvaW50IHJlY29yZC4KICAgIDpwYXJhbSBtb2RlbF9lbmRwb2ludF9uYW1lOiAgICAgICAgICAgICAgICAgICAgIElmIGEgbmV3IG1vZGVsIGVuZHBvaW50IGlzIGdlbmVyYXRlZCwgdGhlIG1vZGVsIG5hbWUgd2lsbCBiZSBwcmVzZW50ZWQgdW5kZXIgdGhpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnQuCiAgICA6cGFyYW0gbW9kZWxfZW5kcG9pbnRfZHJpZnRfdGhyZXNob2xkOiAgICAgICAgICBUaGUgdGhyZXNob2xkIG9mIHdoaWNoIHRvIG1hcmsgZHJpZnRzLiBEZWZhdWx0ZWQgdG8gMC43LgogICAgOnBhcmFtIG1vZGVsX2VuZHBvaW50X3Bvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIHBvc3NpYmxlIGRyaWZ0cy4gRGVmYXVsdGVkIHRvIDAuNS4KICAgIDpwYXJhbSBtb2RlbF9lbmRwb2ludF9zYW1wbGVfc2V0OiAgICAgICAgICAgICAgIEEgc2FtcGxlIGRhdGFzZXQgdG8gZ2l2ZSB0byBjb21wYXJlIHRoZSBpbnB1dHMgaW4gdGhlIGRyaWZ0IGFuYWx5c2lzLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2FuIGJlIHByb3ZpZGVkIGFzIGFuIGlucHV0IChEYXRhSXRlbSkgb3IgYXMgYSBwYXJhbWV0ZXIgKGUuZy4gc3RyaW5nLCBsaXN0LCBEYXRhRnJhbWUpLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgY2hvc2VuIHNhbXBsZSBzZXQgd2lsbCBhbHdheXMgYmUgdGhlIG9uZSB3aG8gaXMgc2V0IGluIHRoZSBtb2RlbCBhcnRpZmFjdCBpdHNlbGYuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IGlmIGJvdGggYG1vZGVsX3BhdGhgIGFuZCBgZW5kcG9pbnRfaWRgIGFyZSBub3QgcHJvdmlkZWQKICAgICIiIgoKICAgICMgTG9hZGluZyB0aGUgbW9kZWw6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9hZGluZyBtb2RlbC4uLiIpCiAgICBpZiBpc2luc3RhbmNlKG1vZGVsX3BhdGgsIG1scnVuLkRhdGFJdGVtKToKICAgICAgICBtb2RlbF9wYXRoID0gbW9kZWxfcGF0aC5hcnRpZmFjdF91cmwKICAgIGlmIG5vdCBtbHJ1bi5kYXRhc3RvcmUuaXNfc3RvcmVfdXJpKG1vZGVsX3BhdGgpOgogICAgICAgIHJhaXNlIG1scnVuLmVycm9ycy5NTFJ1bkludmFsaWRBcmd1bWVudEVycm9yKAogICAgICAgICAgICBmIlRoZSBwcm92aWRlZCBtb2RlbCBwYXRoICh7bW9kZWxfcGF0aH0pIGlzIGludmFsaWQgLSBzaG91bGQgc3RhcnQgd2l0aCBgc3RvcmU6Ly9gLiAiCiAgICAgICAgICAgIGYiUGxlYXNlIG1ha2Ugc3VyZSB0aGF0IHlvdSBoYXZlIGxvZ2dlZCB0aGUgbW9kZWwgdXNpbmcgYHByb2plY3QubG9nX21vZGVsKClgICIKICAgICAgICAgICAgZiJ3aGljaCBnZW5lcmF0ZXMgYSB1bmlxdWUgc3RvcmUgdXJpIGZvciB0aGUgbG9nZ2VkIG1vZGVsLiIKICAgICAgICApCiAgICBtb2RlbF9oYW5kbGVyID0gQXV0b01MUnVuLmxvYWRfbW9kZWwobW9kZWxfcGF0aD1tb2RlbF9wYXRoLCBjb250ZXh0PWNvbnRleHQpCgogICAgaWYgbGFiZWxfY29sdW1ucyBpcyBOb25lOgogICAgICAgIGxhYmVsX2NvbHVtbnMgPSBbCiAgICAgICAgICAgIG91dHB1dC5uYW1lIGZvciBvdXRwdXQgaW4gbW9kZWxfaGFuZGxlci5fbW9kZWxfYXJ0aWZhY3Quc3BlYy5vdXRwdXRzCiAgICAgICAgXQoKICAgIGlmIGZlYXR1cmVfY29sdW1ucyBpcyBOb25lOgogICAgICAgIGZlYXR1cmVfY29sdW1ucyA9IFsKICAgICAgICAgICAgaW5wdXQubmFtZSBmb3IgaW5wdXQgaW4gbW9kZWxfaGFuZGxlci5fbW9kZWxfYXJ0aWZhY3Quc3BlYy5pbnB1dHMKICAgICAgICBdCgogICAgIyBHZXQgZGF0YXNldCBieSBvYmplY3QsIFVSTCBvciBieSBGZWF0dXJlVmVjdG9yOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkxvYWRpbmcgZGF0YS4uLiIpCiAgICB4LCBsYWJlbF9jb2x1bW5zID0gbWxydW4ubW9kZWxfbW9uaXRvcmluZy5hcGkucmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZSgKICAgICAgICBkYXRhc2V0PWRhdGFzZXQsCiAgICAgICAgZmVhdHVyZV9jb2x1bW5zPWZlYXR1cmVfY29sdW1ucywKICAgICAgICBsYWJlbF9jb2x1bW5zPWxhYmVsX2NvbHVtbnMsCiAgICAgICAgZHJvcF9jb2x1bW5zPWRyb3BfY29sdW1ucywKICAgICkKCiAgICAjIFByZWRpY3Q6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiQ2FsY3VsYXRpbmcgcHJlZGljdGlvbi4uLiIpCiAgICB5X3ByZWQgPSBtb2RlbF9oYW5kbGVyLm1vZGVsLnByZWRpY3QoeCwgKipwcmVkaWN0X2t3YXJncykKCiAgICAjIFByZXBhcmUgdGhlIHJlc3VsdCBzZXQ6CiAgICByZXN1bHRfc2V0ID0gX3ByZXBhcmVfcmVzdWx0X3NldCh4PXgsIGxhYmVsX2NvbHVtbnM9bGFiZWxfY29sdW1ucywgeV9wcmVkPXlfcHJlZCkKCiAgICAjIENoZWNrIGZvciBsb2dnaW5nIHRoZSByZXN1bHQgc2V0OgogICAgaWYgbG9nX3Jlc3VsdF9zZXQ6CiAgICAgICAgbWxydW4ubW9kZWxfbW9uaXRvcmluZy5hcGkubG9nX3Jlc3VsdCgKICAgICAgICAgICAgY29udGV4dD1jb250ZXh0LAogICAgICAgICAgICByZXN1bHRfc2V0X25hbWU9cmVzdWx0X3NldF9uYW1lLAogICAgICAgICAgICByZXN1bHRfc2V0PXJlc3VsdF9zZXQsCiAgICAgICAgICAgIGFydGlmYWN0c190YWc9YXJ0aWZhY3RzX3RhZywKICAgICAgICAgICAgYmF0Y2hfaWQ9YmF0Y2hfaWQsCiAgICAgICAgKQoKICAgICMgQ2hlY2sgZm9yIHBlcmZvcm1pbmcgZHJpZnQgYW5hbHlzaXMKICAgIGlmICgKICAgICAgICBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzIGlzIE5vbmUKICAgICAgICBhbmQgbW9kZWxfaGFuZGxlci5fbW9kZWxfYXJ0aWZhY3Quc3BlYy5mZWF0dXJlX3N0YXRzIGlzIG5vdCBOb25lCiAgICApOgogICAgICAgIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXMgPSBUcnVlCiAgICBpZiBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzOgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIlBlcmZvcm1pbmcgZHJpZnQgYW5hbHlzaXMuLi4iKQogICAgICAgICMgR2V0IHRoZSBzYW1wbGUgc2V0IHN0YXRpc3RpY3MgKGVpdGhlciBmcm9tIHRoZSBzYW1wbGUgc2V0IG9yIGZyb20gdGhlIHN0YXRpc3RpY3MgbG9nZ2VkIHdpdGggdGhlIG1vZGVsKQogICAgICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljcyA9IG1scnVuLm1vZGVsX21vbml0b3JpbmcuYXBpLmdldF9zYW1wbGVfc2V0X3N0YXRpc3RpY3MoCiAgICAgICAgICAgIHNhbXBsZV9zZXQ9bW9kZWxfZW5kcG9pbnRfc2FtcGxlX3NldCwKICAgICAgICAgICAgbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0cz1tb2RlbF9oYW5kbGVyLl9tb2RlbF9hcnRpZmFjdC5zcGVjLmZlYXR1cmVfc3RhdHMsCiAgICAgICAgKQogICAgICAgIG1scnVuLm1vZGVsX21vbml0b3JpbmcuYXBpLnJlY29yZF9yZXN1bHRzKAogICAgICAgICAgICBwcm9qZWN0PWNvbnRleHQucHJvamVjdCwKICAgICAgICAgICAgY29udGV4dD1jb250ZXh0LAogICAgICAgICAgICBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgbW9kZWxfcGF0aD1tb2RlbF9wYXRoLAogICAgICAgICAgICBtb2RlbF9lbmRwb2ludF9uYW1lPW1vZGVsX2VuZHBvaW50X25hbWUsCiAgICAgICAgICAgIGluZmVyX3Jlc3VsdHNfZGY9cmVzdWx0X3NldC5jb3B5KCksCiAgICAgICAgICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljcz1zYW1wbGVfc2V0X3N0YXRpc3RpY3MsCiAgICAgICAgICAgIGRyaWZ0X3RocmVzaG9sZD1tb2RlbF9lbmRwb2ludF9kcmlmdF90aHJlc2hvbGQsCiAgICAgICAgICAgIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZD1tb2RlbF9lbmRwb2ludF9wb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQsCiAgICAgICAgICAgIGFydGlmYWN0c190YWc9YXJ0aWZhY3RzX3RhZywKICAgICAgICAgICAgdHJpZ2dlcl9tb25pdG9yaW5nX2pvYj10cmlnZ2VyX21vbml0b3Jpbmdfam9iLAogICAgICAgICAgICBkZWZhdWx0X2JhdGNoX2ltYWdlPWJhdGNoX2ltYWdlX2pvYiwKICAgICAgICApCg==
    commands: []
    code_origin: https://github.com/mlrun/functions#f94e8c893f193b93c3dac1231dc16f209fdf3172:/Users/Jonathan_Daniel/projects/functions/batch_inference_v2/batch_inference_v2.py
    origin_filename: /Users/Jonathan_Daniel/projects/functions/batch_inference_v2/batch_inference_v2.py
    with_mlrun: false
    auto_build: false
    requirements: []
  entry_points:
    infer:
      name: infer
      doc: 'Perform a prediction on a given dataset with the given model. Please make
        sure that you have already logged the model

        under the current project.

        Can perform drift analysis between the sample set statistics stored in the
        model to the current input data. The

        drift rule is the value per-feature mean of the TVD and Hellinger scores according
        to the thresholds configures

        here. When performing drift analysis, this function either uses an existing
        model endpoint record or creates

        a new one.

        At the moment, this function is supported for `mlrun>=1.5.0` versions.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: dataset
        type: Union[DataItem, list, dict, DataFrame, Series, ndarray]
        doc: The dataset to infer through the model. Provided as an input (DataItem)
          that represents Dataset artifact / Feature vector URI. If using MLRun SDK,
          `dataset` can also be provided as a list, dictionary or numpy array.
      - name: model_path
        type: Union[str, DataItem]
        doc: Model store uri (should start with store://). Provided as an input (DataItem).
          If using MLRun SDK, `model_path` can also be provided as a parameter (string).
          To generate a valid model store URI, please log the model before running
          this function. If `endpoint_id` of existing model endpoint is provided,
          make sure that it has a similar model store path, otherwise the drift analysis
          won't be triggered.
      - name: drop_columns
        type: Union[str, List[str], int, List[int]]
        doc: A string / integer or a list of strings / integers that represent the
          column names / indices to drop. When the dataset is a list or a numpy array
          this parameter must be represented by integers.
        default: null
      - name: label_columns
        type: Union[str, List[str]]
        doc: The target label(s) of the column(s) in the dataset for Regression or
          Classification tasks. The label column can be accessed from the model object,
          or the feature vector provided if available.
        default: null
      - name: feature_columns
        type: Union[str, List[str]]
        doc: List of feature columns that will be used to build the dataframe when
          dataset is from type list or numpy array.
        default: null
      - name: log_result_set
        type: bool
        doc: Whether to log the result set - a DataFrame of the given inputs concatenated
          with the predictions. Defaulted to True.
        default: true
      - name: result_set_name
        type: str
        doc: The db key to set name of the prediction result and the filename. Defaulted
          to 'prediction'.
        default: prediction
      - name: batch_id
        type: str
        doc: The ID of the given batch (inference dataset). If `None`, it will be
          generated. Will be logged as a result of the run.
        default: null
      - name: artifacts_tag
        type: str
        doc: Tag to use for all the artifacts resulted from the function (result set
          and model monitoring artifacts)
        default: ''
      - name: perform_drift_analysis
        type: bool
        doc: Whether to perform drift analysis between the sample set of the model
          object to the dataset given. By default, None, which means it will perform
          drift analysis if the model already has feature stats that are considered
          as a reference sample set. Performing drift analysis on a new endpoint id
          will generate a new model endpoint record. Please note that in order to
          trigger the drift analysis job, you need to set `trigger_monitoring_job=True`.
          Otherwise, the drift analysis will be triggered only as part the scheduled
          monitoring job (if exist in the current project) or if triggered manually
          by the user.
        default: null
      - name: trigger_monitoring_job
        type: bool
        doc: Whether to trigger the batch drift analysis after the infer job.
        default: false
      - name: batch_image_job
        type: str
        doc: The image that will be used to register the monitoring batch job if not
          exist. By default, the image is mlrun/mlrun.
        default: mlrun/mlrun
      - name: endpoint_id
        type: str
        doc: Model endpoint unique ID. If `perform_drift_analysis` was set, the endpoint_id
          will be used either to perform the analysis on existing model endpoint or
          to generate a new model endpoint record.
        default: ''
      - name: model_endpoint_name
        type: str
        doc: If a new model endpoint is generated, the model name will be presented
          under this endpoint.
        default: batch-infer
      - name: model_endpoint_drift_threshold
        type: float
        doc: The threshold of which to mark drifts. Defaulted to 0.7.
        default: 0.7
      - name: model_endpoint_possible_drift_threshold
        type: float
        doc: The threshold of which to mark possible drifts. Defaulted to 0.5.
        default: 0.5
      - name: model_endpoint_sample_set
        type: Union[DataItem, list, dict, DataFrame, Series, ndarray]
        doc: A sample dataset to give to compare the inputs in the drift analysis.
          Can be provided as an input (DataItem) or as a parameter (e.g. string, list,
          DataFrame). The default chosen sample set will always be the one who is
          set in the model artifact itself.
        default: null
      outputs:
      - default: ''
      lineno: 82
  description: Batch inference (also knows as prediction) for the common ML frameworks
    (SciKit-Learn, XGBoost and LightGBM) while performing data drift analysis.
  default_handler: infer
  disable_auto_mount: false
  allow_empty_resources: true
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
