kind: job
metadata:
  name: arc-to-parquet
  tag: ''
  hash: e64c1d51652d1a08cf785bd34c6f29b3ee48da3f
  project: ''
  labels:
    author: yjb
  categories:
  - data-movement
  - utils
spec:
  command: ''
  args: []
  image: yjbds/ml-base:0.4.8
  env: []
  default_handler: arc_to_parquet
  entry_points:
    arc_to_parquet:
      name: arc_to_parquet
      doc: "Open a file/object archive and save as a parquet file or dataset\n\nNotes\n\
        -----\n* this function is typically for large files, please be sure to check\
        \ all settings\n* partitioning requires precise specification of column types.\n\
        * the archive_url can be any file readable by pandas read_csv, which includes\
        \ tar files\n* if the `dataset` parameter is not empty, then a partitioned\
        \ dataset will be created\ninstead of a single file in the folder `dataset`\n\
        * if a key exists already then it will not be re-acquired unless the `refresh_data`\
        \ param\nis set to `True`.  This is in case the original file is corrupt,\
        \ or a refresh is \nrequired."
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: archive_url
        type: DataItem
        doc: MLRun data input (DataItem object)
      - name: header
        type: List[str]
        default:
        - null
      - name: chunksize
        type: int
        doc: (0) when > 0, row size (chunk) to retrieve per iteration
      - name: dtype
      - name: encoding
        type: str
        default: latin-1
      - name: key
        type: str
        doc: key in artifact store (when log_data=True)
        default: data
      - name: dataset
        type: str
        doc: (None) if not None then "target_path/dataset" is folder for partitioned
          files
        default: None
      - name: part_cols
        doc: ([]) list of partitioning columns
      - name: file_ext
        type: str
        doc: (parquet) csv/parquet file extension
        default: parquet
      - name: index
        type: bool
        doc: (False) pandas save index option
      - name: refresh_data
        type: bool
        doc: (False) overwrite existing data at that location
      - name: stats
        type: bool
        doc: (None) calculate table stats when logging artifact
      outputs: []
      lineno: 52
  description: retrieve remote archive, open and save as parquet
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmltcG9ydCBqc29uCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBweWFycm93LnBhcnF1ZXQgYXMgcHEKaW1wb3J0IHB5YXJyb3cgYXMgcGEKCmZyb20gbWxydW4uZXhlY3V0aW9uIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KCmZyb20gdHlwaW5nIGltcG9ydCBMaXN0LCBPcHRpb25hbAoKZGVmIF9jaHVua19yZWFkd3JpdGUoCiAgICBhcmNoaXZlX3VybCwKICAgIGRlc3RfcGF0aCwKICAgIGNodW5rc2l6ZSwgCiAgICBoZWFkZXIsIAogICAgZW5jb2RpbmcsIAogICAgZHR5cGUKKToKICAgICIiInN0cmVhbSByZWFkIGFuZCB3cml0ZSBhcmNoaXZlcwogICAgCiAgICBwYW5kYXMgcmVhZHMgYW5kIHBhcnF1ZXQgd3JpdGVzCiAgICAKICAgIG5vdGVzCiAgICAtLS0tLQogICAgKiBkZXN0X3BhdGggY2FuIGJlIGVpdGhlciBhIGZpbGUucGFycXVldCwgb3IgaW4gaHRlIGNhc2Ugb2YgcGFydGl0aW9uZWQgcGFycXVldAogICAgICBpdCB3aWxsIGJlIG9ubHkgdGhlIGRlc3RpbmF0aW9uIGZvbGRlciBvZiB0aGUgcGFycXVldCBwYXJ0aXRpb24gZmlsZXMKICAgICIiIgogICAgcHF3cml0ZXIgPSBOb25lCiAgICBoZWFkZXIgPSBbXQogICAgZm9yIGksIGRmIGluIGVudW1lcmF0ZShwZC5yZWFkX2NzdihhcmNoaXZlX3VybCwgY2h1bmtzaXplPWNodW5rc2l6ZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzPWhlYWRlciwgZW5jb2Rpbmc9ZW5jb2RpbmcsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdHlwZT1kdHlwZSkpOgogICAgICAgIHRhYmxlID0gcGEuVGFibGUuZnJvbV9wYW5kYXMoZGYpCiAgICAgICAgaWYgaSA9PSAwOgogICAgICAgICAgICBpZiBkYXRhc2V0OgogICAgICAgICAgICAgICAgaGVhZGVyID0gY29weSh0YWJsZS5zY2hlbWEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcXdyaXRlciA9IHBxLlBhcnF1ZXRXcml0ZXIoZGVzdF9wYXRoLCB0YWJsZS5zY2hlbWEpCiAgICAgICAgaWYgZGF0YXNldDoKICAgICAgICAgICAgcHEud3JpdGVfdG9fZGF0YXNldCh0YWJsZSwgcm9vdF9wYXRoPWRlc3RfcGF0aCwgcGFydGl0aW9uX2NvbHM9cGFydGl0aW9uX2NvbHMpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHF3cml0ZXIud3JpdGVfdGFibGUodGFibGUpCiAgICBpZiBwcXdyaXRlcjoKICAgICAgICBwcXdyaXRlci5jbG9zZSgpCiAgICAKICAgIHJldHVybiBoZWFkZXIKCmRlZiBhcmNfdG9fcGFycXVldCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgYXJjaGl2ZV91cmw6IERhdGFJdGVtLAogICAgaGVhZGVyOiBMaXN0W3N0cl0gPSBbTm9uZV0sCiAgICBjaHVua3NpemU6IGludCA9IDAsCiAgICBkdHlwZT1Ob25lLAogICAgZW5jb2Rpbmc6IHN0ciA9ICJsYXRpbi0xIiwKICAgIGtleTogc3RyID0gImRhdGEiLAogICAgZGF0YXNldDogc3RyID0gIk5vbmUiLAogICAgcGFydF9jb2xzID0gW10sCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgaW5kZXg6IGJvb2w9IEZhbHNlLAogICAgcmVmcmVzaF9kYXRhOiBib29sID0gRmFsc2UsCiAgICBzdGF0czogYm9vbCA9IEZhbHNlCikgLT4gTm9uZToKICAgICIiIk9wZW4gYSBmaWxlL29iamVjdCBhcmNoaXZlIGFuZCBzYXZlIGFzIGEgcGFycXVldCBmaWxlIG9yIGRhdGFzZXQKCiAgICBOb3RlcwogICAgLS0tLS0KICAgICogdGhpcyBmdW5jdGlvbiBpcyB0eXBpY2FsbHkgZm9yIGxhcmdlIGZpbGVzLCBwbGVhc2UgYmUgc3VyZSB0byBjaGVjayBhbGwgc2V0dGluZ3MKICAgICogcGFydGl0aW9uaW5nIHJlcXVpcmVzIHByZWNpc2Ugc3BlY2lmaWNhdGlvbiBvZiBjb2x1bW4gdHlwZXMuCiAgICAqIHRoZSBhcmNoaXZlX3VybCBjYW4gYmUgYW55IGZpbGUgcmVhZGFibGUgYnkgcGFuZGFzIHJlYWRfY3N2LCB3aGljaCBpbmNsdWRlcyB0YXIgZmlsZXMKICAgICogaWYgdGhlIGBkYXRhc2V0YCBwYXJhbWV0ZXIgaXMgbm90IGVtcHR5LCB0aGVuIGEgcGFydGl0aW9uZWQgZGF0YXNldCB3aWxsIGJlIGNyZWF0ZWQKICAgIGluc3RlYWQgb2YgYSBzaW5nbGUgZmlsZSBpbiB0aGUgZm9sZGVyIGBkYXRhc2V0YAogICAgKiBpZiBhIGtleSBleGlzdHMgYWxyZWFkeSB0aGVuIGl0IHdpbGwgbm90IGJlIHJlLWFjcXVpcmVkIHVubGVzcyB0aGUgYHJlZnJlc2hfZGF0YWAgcGFyYW0KICAgIGlzIHNldCB0byBgVHJ1ZWAuICBUaGlzIGlzIGluIGNhc2UgdGhlIG9yaWdpbmFsIGZpbGUgaXMgY29ycnVwdCwgb3IgYSByZWZyZXNoIGlzIAogICAgcmVxdWlyZWQuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIGFyY2hpdmVfdXJsOiAgICBNTFJ1biBkYXRhIGlucHV0IChEYXRhSXRlbSBvYmplY3QpCiAgICA6cGFyYW0gY2h1bmtzaXplOiAgICAgICgwKSB3aGVuID4gMCwgcm93IHNpemUgKGNodW5rKSB0byByZXRyaWV2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICBwZXIgaXRlcmF0aW9uCiAgICA6cGFyYW0gZHR5cGUgICAgICAgICAgIGRlc3RpbmF0aW9uIGRhdGEgdHlwZSBvZiBzcGVjaWZpZWQgY29sdW1ucwogICAgOnBhcmFtIGVuY29kaW5nICAgICAgICAoImxhdGluLTgiKSBmaWxlIGVuY29kaW5nCiAgICA6cGFyYW0ga2V5OiAgICAgICAgICAgIGtleSBpbiBhcnRpZmFjdCBzdG9yZSAod2hlbiBsb2dfZGF0YT1UcnVlKQogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAoTm9uZSkgaWYgbm90IE5vbmUgdGhlbiAidGFyZ2V0X3BhdGgvZGF0YXNldCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgaXMgZm9sZGVyIGZvciBwYXJ0aXRpb25lZCBmaWxlcwogICAgOnBhcmFtIHBhcnRfY29sczogICAgICAoW10pIGxpc3Qgb2YgcGFydGl0aW9uaW5nIGNvbHVtbnMKICAgIDpwYXJhbSBmaWxlX2V4dDogICAgICAgKHBhcnF1ZXQpIGNzdi9wYXJxdWV0IGZpbGUgZXh0ZW5zaW9uCiAgICA6cGFyYW0gaW5kZXg6ICAgICAgICAgIChGYWxzZSkgcGFuZGFzIHNhdmUgaW5kZXggb3B0aW9uCiAgICA6cGFyYW0gcmVmcmVzaF9kYXRhOiAgIChGYWxzZSkgb3ZlcndyaXRlIGV4aXN0aW5nIGRhdGEgYXQgdGhhdCBsb2NhdGlvbgogICAgOnBhcmFtIHN0YXRzOiAgICAgICAgICAoTm9uZSkgY2FsY3VsYXRlIHRhYmxlIHN0YXRzIHdoZW4gbG9nZ2luZyBhcnRpZmFjdAogICAgIiIiCiAgICBiYXNlX3BhdGggPSBjb250ZXh0LmFydGlmYWN0X3BhdGgKICAgIG9zLm1ha2VkaXJzKGJhc2VfcGF0aCwgZXhpc3Rfb2s9VHJ1ZSkKICAgIAogICAgYXJjaGl2ZV91cmwgPSBhcmNoaXZlX3VybC5sb2NhbCgpCiAgICAKICAgIGlmIGRhdGFzZXQgaXMgbm90IE5vbmU6CiAgICAgICAgZGVzdF9wYXRoID0gb3MucGF0aC5qb2luKGJhc2VfcGF0aCwgZGF0YXNldCkKICAgICAgICBleGlzdHMgPSBvcy5wYXRoLmlzZGlyKGRlc3RfcGF0aCkKICAgIGVsc2U6CiAgICAgICAgZGVzdF9wYXRoID0gb3MucGF0aC5qb2luKGJhc2VfcGF0aCwga2V5K2YiLntmaWxlX2V4dH0iKQogICAgICAgIGV4aXN0cyA9IG9zLnBhdGguaXNmaWxlKGRlc3RfcGF0aCkKICAgICAgICAKICAgIGlmIG5vdCBleGlzdHM6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiZGVzdGluYXRpb24gZmlsZSBkb2VzIG5vdCBleGlzdCwgZG93bmxvYWRpbmciKQogICAgICAgIGlmIGNodW5rc2l6ZSA+IDA6CiAgICAgICAgICAgIGhlYWRlciA9IF9jaHVua19yZWFkd3JpdGUoYXJjaGl2ZV91cmwsIGRlc3RfcGF0aCwgY2h1bmtzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kaW5nLCBkdHlwZSkKICAgICAgICAgICAgY29udGV4dC5sb2dfZGF0YXNldChrZXk9a2V5LCBzdGF0cz1zdGF0cywgZm9ybWF0PSdwYXJxdWV0JywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X3BhdGg9ZGVzdF9wYXRoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGRmID0gcGQucmVhZF9jc3YoYXJjaGl2ZV91cmwpCiAgICAgICAgICAgIGNvbnRleHQubG9nX2RhdGFzZXQoa2V5LCBkZj1kZiwgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1pbmRleCkKICAgIGVsc2U6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiZGVzdGluYXRpb24gZmlsZSBhbHJlYWR5IGV4aXN0cywgbm90aGluZyBkb25lIikKCg==
    commands: []
    code_origin: https://github.com/yjb-ds/functions#f1f5e14e2b8bd02aee868cf12ce33e8484595cb8:arc_to_parquet.ipynb
