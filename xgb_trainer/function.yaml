kind: job
metadata:
  name: xgb-trainer
  tag: ''
  hash: 86bddc1f0491ae616a35527d3e6fc8131cd3edac
  project: ''
  labels:
    author: yjb
    framework: xgboost
  categories:
  - training
  - ml
  - experimental
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.8
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: 'train an xgboost model.


        Note on imabalanced data:  the `imbal_vec` parameter represents the measured

        class representations in the sample and can be used as a first step in tuning

        an XGBoost model.  This isn''t a hyperparamter, merely an estimate that should

        be set as ''constant'' throughout tuning process.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_type
        type: str
        doc: the model type to train, "classifier", "regressor"...
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: encode_cols
        type: dict
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
      - name: enc_drop_first
        type: bool
        doc: (True) whether to drop the first column of hot encoded  variables (avoid
          column exact dependencies)
        default: true
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f92b1afd978>
      - name: imbal_vec
        doc: ([]) vector of class weights seen in sample
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.25
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: destination subfolder for model artifacts
        default: models
      - name: plots_dest
        type: str
        doc: destination subfolder for plot artifacts
        default: plots
      - name: eval_metrics
        type: list
        doc: (["error", "auc"]) learning curve metrics
        default:
        - error
        - auc
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
      outputs: []
      lineno: 60
  description: train multiple model types using xgboost
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IChnZXRfc2FtcGxlLAogICAgICAgICAgICAgICAgICAgICBnZXRfc3BsaXRzLAogICAgICAgICAgICAgICAgICAgICBnZW5fc2tsZWFybl9tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgY3JlYXRlX2NsYXNzLCAKICAgICAgICAgICAgICAgICAgICAgZXZhbF9jbGFzc19tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgZ2NmX2NsZWFyKQoKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0LCBUYWJsZUFydGlmYWN0Cgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBvcwpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdAoKZGVmIF9nZW5feGdiX21vZGVsKG1vZGVsX3R5cGU6IHN0ciwgeGdiX3BhcmFtczogZGljdCk6CiAgICAiIiJnZW5lcmF0ZSBhbiB4Z2Jvb3N0IG1vZGVsCiAgICAKICAgIE11bHRpcGxlIG1vZGVsIHR5cGVzIHRoYXQgY2FuIGJlIGVzdGltYXRlZCB1c2luZwogICAgdGhlIFhHQm9vc3QgU2Npa2l0LUxlYXJuIEFQSS4KICAgIAogICAgSW5wdXQgY2FuIGVpdGhlciBiZSBhIHByZWRlZmluZWQganNvbiBtb2RlbCBjb25maWd1cmF0aW9uIG9yIG9uZQogICAgb2YgdGhlIGZpdmUgeGdib29zdCBtb2RlbCB0eXBlczogImNsYXNzaWZpZXIiLCAicmVncmVzc29yIiwgInJhbmtlciIsCiAgICAicmZfY2xhc3NpZmllciIsIG9yICJyZl9yZWdyZXNzb3IiLgogICAgCiAgICBJbiBlaXRoZXIgY2FzZSBvbmUgY2FuIHBhc3MgaW4gYSBwYXJhbXMgZGljdCB0byBtb2RpZnkgZGVmYXVsdHMgdmFsdWVzLgogICAgCiAgICBCYXNlZCBvbiBgbWxydW4ubWx1dGlscy5tb2RlbHMuZ2VuX3NrbGVhcm5fbW9kZWxgLCBzZWUgdGhlIGZ1bmN0aW9uCiAgICBgc2tsZWFybl9jbGFzc2lmaWVyYCBpbiB0aGlzIHJlcG9zaXRvcnkuCiAgICAKICAgIDpwYXJhbSBtb2RlbF90eXBlOiBvbmUgb2YgImNsYXNzaWZpZXIiLCAicmVncmVzc29yIiwKICAgICAgICAgICAgICAgICAgICAgICAicmFua2VyIiwgInJmX2NsYXNzaWZpZXIiLCBvcgogICAgICAgICAgICAgICAgICAgICAgInJmX3JlZ3Jlc3NvciIKICAgIDpwYXJhbSB4Z2JfcGFyYW1zOiBjbGFzcyBpbml0IHBhcmFtZXRlcnMKICAgICIiIgogICAgZnJvbSBtbHJ1bi5tbHV0aWxzIGltcG9ydCBnZXRfY2xhc3NfZml0LCBnZW5fc2tsZWFybl9tb2RlbAoKICAgIG10eXBlcyA9IHsKICAgICAgICAiY2xhc3NpZmllciIgICA6ICJ4Z2Jvb3N0LlhHQkNsYXNzaWZpZXIiLAogICAgICAgICJyZWdyZXNzb3IiICAgIDogInhnYm9vc3QuWEdCUmVncmVzc29yIiwKICAgICAgICAicmFua2VyIiAgICAgICA6ICJ4Z2Jvb3N0LlhHQlJhbmtlciIsCiAgICAgICAgInJmX2NsYXNzaWZpZXIiOiAieGdib29zdC5YR0JSRkNsYXNzaWZpZXIiLAogICAgICAgICJyZl9yZWdyZXNzb3IiIDogInhnYm9vc3QuWEdCUkZSZWdyZXNzb3IiCiAgICB9CiAgICBpZiBtb2RlbF90eXBlLmVuZHN3aXRoKCJqc29uIik6CiAgICAgICAgbW9kZWxfY29uZmlnID0gbW9kZWxfdHlwZQogICAgZWxpZiBtb2RlbF90eXBlIGluIG10eXBlcy5rZXlzKCk6CiAgICAgICAgbW9kZWxfY29uZmlnID0gbXR5cGVzW21vZGVsX3R5cGVdCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbigidW5yZWNvZ25pemVkIG1vZGVsIHR5cGUsIHNlZSBoZWxwIGRvY3VtZW50YXRpb24iKQoKICAgIHJldHVybiBnZW5fc2tsZWFybl9tb2RlbChtb2RlbF9jb25maWcsIHhnYl9wYXJhbXMpCgpkZWYgdHJhaW5fbW9kZWwoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIG1vZGVsX3R5cGU6IHN0ciwKICAgIGRhdGFzZXQ6IERhdGFJdGVtLAogICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWxzIiwKICAgIGVuY29kZV9jb2xzOiBkaWN0ID0ge30sCiAgICBlbmNfZHJvcF9maXJzdDogYm9vbCA9IFRydWUsCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgaW1iYWxfdmVjID0gW10sCiAgICB0ZXN0X3NpemU6IGZsb2F0ID0gMC4yNSwKICAgIHZhbGlkX3NpemU6IGZsb2F0ID0gMC43NSwKICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gMSwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAibW9kZWxzIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBldmFsX21ldHJpY3M6IGxpc3Q9IFsiZXJyb3IiLCAiYXVjIl0sCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLCAgICAKKSAtPiBOb25lOgogICAgIiIidHJhaW4gYW4geGdib29zdCBtb2RlbC4KICAgIAogICAgTm90ZSBvbiBpbWFiYWxhbmNlZCBkYXRhOiAgdGhlIGBpbWJhbF92ZWNgIHBhcmFtZXRlciByZXByZXNlbnRzIHRoZSBtZWFzdXJlZAogICAgY2xhc3MgcmVwcmVzZW50YXRpb25zIGluIHRoZSBzYW1wbGUgYW5kIGNhbiBiZSB1c2VkIGFzIGEgZmlyc3Qgc3RlcCBpbiB0dW5pbmcKICAgIGFuIFhHQm9vc3QgbW9kZWwuICBUaGlzIGlzbid0IGEgaHlwZXJwYXJhbXRlciwgbWVyZWx5IGFuIGVzdGltYXRlIHRoYXQgc2hvdWxkCiAgICBiZSBzZXQgYXMgJ2NvbnN0YW50JyB0aHJvdWdob3V0IHR1bmluZyBwcm9jZXNzLgogICAgCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxfdHlwZTogICAgICAgIHRoZSBtb2RlbCB0eXBlIHRvIHRyYWluLCAiY2xhc3NpZmllciIsICJyZWdyZXNzb3IiLi4uCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICgiZGF0YSIpIG5hbWUgb2YgcmF3IGRhdGEgZmlsZQogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgICBncm91bmQtdHJ1dGggKHkpIGxhYmVscwogICAgOnBhcmFtIGVuY29kZV9jb2xzOiAgICAgICBkaWN0aW9uYXJ5IG9mIG5hbWVzIGFuZCBwcmVmaXhlcyBmb3IgY29sdW1ucyB0aGF0IGFyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBob3QgYmUgZW5jb2RlZC4KICAgIDpwYXJhbSBlbmNfZHJvcF9maXJzdDogICAgKFRydWUpIHdoZXRoZXIgdG8gZHJvcCB0aGUgZmlyc3QgY29sdW1uIG9mIGhvdCBlbmNvZGVkIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZXMgKGF2b2lkIGNvbHVtbiBleGFjdCBkZXBlbmRlbmNpZXMpCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSBpbWJhbF92ZWM6ICAgICAgICAgKFtdKSB2ZWN0b3Igb2YgY2xhc3Mgd2VpZ2h0cyBzZWVuIGluIHNhbXBsZQogICAgOnBhcmFtIHRlc3Rfc2l6ZTogICAgICAgICAoMC4wNSkgdGVzdCBzZXQgc2l6ZQogICAgOnBhcmFtIHZhbGlkX3NpemU6ICAgICAgICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHJhbmRvbV9zdGF0ZTogICAgICAoMSkgc2tsZWFybiBybmcgc2VlZAogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICBkZXN0aW5hdGlvbiBzdWJmb2xkZXIgZm9yIG1vZGVsIGFydGlmYWN0cwogICAgOnBhcmFtIHBsb3RzX2Rlc3Q6ICAgICAgICBkZXN0aW5hdGlvbiBzdWJmb2xkZXIgZm9yIHBsb3QgYXJ0aWZhY3RzCiAgICA6cGFyYW0gZXZhbF9tZXRyaWNzOiAgICAgIChbImVycm9yIiwgImF1YyJdKSBsZWFybmluZyBjdXJ2ZSBtZXRyaWNzCiAgICA6cGFyYW0gZmlsZV9leHQ6ICAgICAgICAgIGZvcm1hdCBmb3IgdGVzdF9zZXRfa2V5IGhvbGQgb3V0IGRhdGEKICAgICIiIgogICAgbW9kZWxzX2Rlc3QgPSBtb2RlbHNfZGVzdCBvciAibW9kZWxzIgogICAgcGxvdHNfZGVzdCA9IHBsb3RzX2Rlc3Qgb3IgZiJwbG90cy97Y29udGV4dC5uYW1lfSIKICAgIAogICAgcmF3LCBsYWJlbHMsIGhlYWRlciA9IGdldF9zYW1wbGUoZGF0YXNldCwgc2FtcGxlLCBsYWJlbF9jb2x1bW4pCiAgICAKICAgIGlmIGVuY29kZV9jb2xzOgogICAgICAgIHJhdyA9IHBkLmdldF9kdW1taWVzKHJhdywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1ucz1saXN0KGVuY29kZV9jb2xzLmtleXMoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeD1saXN0KGVuY29kZV9jb2xzLnZhbHVlcygpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJvcF9maXJzdD1lbmNfZHJvcF9maXJzdCkKICAgIAogICAgKHh0cmFpbiwgeXRyYWluKSwgKHh2YWxpZCwgeXZhbGlkKSwgKHh0ZXN0LCB5dGVzdCksIF8gPSBnZXRfc3BsaXRzKHJhdywgbGFiZWxzLCAzLCB0ZXN0X3NpemUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkX3NpemUsIFsibGFiZWxzIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX3N0YXRlKQogICAgCiAgICAKICAgIGNvbnRleHQubG9nX2RhdGFzZXQoInRlc3Qtc2V0IiwgZGY9cGQuY29uY2F0KFt4dGVzdCwgeXRlc3RdLCBheGlzPTEpLCBmb3JtYXQ9ZmlsZV9leHQsIGluZGV4PUZhbHNlKQoKICAgIG1vZGVsX2NvbmZpZyA9IF9nZW5feGdiX21vZGVsKG1vZGVsX3R5cGUsIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpKQoKICAgIGlmIGxlbihpbWJhbF92ZWMpID09IDI6CiAgICAgICAgc2NhbGVfcG9zX3dlaWdodCA9IGltYmFsX3ZlY1swXS9pbWJhbF92ZWNbMV0KICAgICAgICBtb2RlbF9jb25maWdbIkNMQVNTIl0udXBkYXRlKHsic2NhbGVfcG9zX3dlaWdodCI6IHNjYWxlX3Bvc193ZWlnaHR9KQogICAgCiAgICBYR0JCb29zdENsYXNzID0gY3JlYXRlX2NsYXNzKG1vZGVsX2NvbmZpZ1siTUVUQSJdWyJjbGFzcyJdKQogICAgbW9kZWwgPSBYR0JCb29zdENsYXNzKCoqbW9kZWxfY29uZmlnWyJDTEFTUyJdKQoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0cmFpbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInkiOiB5dHJhaW4udmFsdWVzLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXZhbF9zZXQiOlsoeHRyYWluLCB5dHJhaW4pLCAoeHZhbGlkLCB5dmFsaWQpXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXZhbF9tZXRyaWMiOiBldmFsX21ldHJpY3N9KQogICAgCiAgICBtb2RlbC5maXQoKiptb2RlbF9jb25maWdbIkZJVCJdKQoKICAgIGV2YWxfbWV0cmljcyA9IGV2YWxfY2xhc3NfbW9kZWwoY29udGV4dCwgeHZhbGlkLCB5dmFsaWQsIG1vZGVsKQogICAgCiAgICBtb2RlbF9wbG90cyA9IGV2YWxfbWV0cmljcy5wb3AoInBsb3RzIikKICAgIG1vZGVsX3RhYmxlcyA9IGV2YWxfbWV0cmljcy5wb3AoInRhYmxlcyIpCiAgICBmb3IgcGxvdCBpbiBtb2RlbF9wbG90czoKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChwbG90LCBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L3twbG90LmtleX0uaHRtbCIpCiAgICBmb3IgdGJsIGluIG1vZGVsX3RhYmxlczoKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCh0YmwsIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0ve3Bsb3Qua2V5fS5jc3YiKQogICAgICAgIAogICAgbW9kZWxfYmluID0gZHVtcHMobW9kZWwpICMgLmdldF9ib29zdGVyKCkpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgibW9kZWwiLCBib2R5PW1vZGVsX2JpbiwKICAgICAgICAgICAgICAgICAgICAgIGFydGlmYWN0X3BhdGg9b3MucGF0aC5qb2luKGNvbnRleHQuYXJ0aWZhY3RfcGF0aCwgbW9kZWxzX2Rlc3QpLAogICAgICAgICAgICAgICAgICAgICAgbW9kZWxfZmlsZT0ibW9kZWwucGtsIiwKICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3M9ZXZhbF9tZXRyaWNzKQoKICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoZXZhbF9tZXRyaWNzKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#bbaf91c5a14454dea6ba72cafa3f035608315b67:xgb_trainer.ipynb
