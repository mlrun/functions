kind: job
metadata:
  name: xgb-trainer
  tag: ''
  hash: 0b280b61e8f41faeec26aa544863876293a8fbaa
  project: ''
  labels:
    author: yjb
    framework: xgboost
  categories:
  - training
  - ml
  - experimental
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: 'train an xgboost model.


        Note on imabalanced data:  the `imbal_vec` parameter represents the measured

        class representations in the sample and can be used as a first step in tuning

        an XGBoost model.  This isn''t a hyperparamter, merely an estimate that should

        be set as ''constant'' throughout tuning process.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_type
        type: str
        doc: the model type to train, "classifier", "regressor"...
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: encode_cols
        type: dict
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f6315977dd8>
      - name: imbal_vec
        doc: ([]) vector of class weights seen in sample
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.25
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: destination subfolder for model artifacts
        default: models
      - name: plots_dest
        type: str
        doc: destination subfolder for plot artifacts
        default: plots
      - name: eval_metrics
        type: list
        doc: (["error", "auc"]) learning curve metrics
        default:
        - error
        - auc
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
      outputs: []
      lineno: 54
  description: train multiple model types using xgboost
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IChnZXRfc2FtcGxlLCBnZXRfc3BsaXRzLCBnZW5fc2tsZWFybl9tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlX2NsYXNzLCBldmFsX21vZGVsX3YyLCBnY2ZfY2xlYXIpCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QsIFRhYmxlQXJ0aWZhY3QKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG9zCmZyb20gdHlwaW5nIGltcG9ydCBMaXN0CgpkZWYgX2dlbl94Z2JfbW9kZWwobW9kZWxfdHlwZTogc3RyLCB4Z2JfcGFyYW1zOiBkaWN0KToKICAgICIiImdlbmVyYXRlIGFuIHhnYm9vc3QgbW9kZWwKICAgIAogICAgTXVsdGlwbGUgbW9kZWwgdHlwZXMgdGhhdCBjYW4gYmUgZXN0aW1hdGVkIHVzaW5nCiAgICB0aGUgWEdCb29zdCBTY2lraXQtTGVhcm4gQVBJLgogICAgCiAgICBJbnB1dCBjYW4gZWl0aGVyIGJlIGEgcHJlZGVmaW5lZCBqc29uIG1vZGVsIGNvbmZpZ3VyYXRpb24gb3Igb25lCiAgICBvZiB0aGUgZml2ZSB4Z2Jvb3N0IG1vZGVsIHR5cGVzOiAiY2xhc3NpZmllciIsICJyZWdyZXNzb3IiLCAicmFua2VyIiwKICAgICJyZl9jbGFzc2lmaWVyIiwgb3IgInJmX3JlZ3Jlc3NvciIuCiAgICAKICAgIEluIGVpdGhlciBjYXNlIG9uZSBjYW4gcGFzcyBpbiBhIHBhcmFtcyBkaWN0IHRvIG1vZGlmeSBkZWZhdWx0cyB2YWx1ZXMuCiAgICAKICAgIEJhc2VkIG9uIGBtbHV0aWxzLm1vZGVscy5nZW5fc2tsZWFybl9tb2RlbGAsIHNlZSB0aGUgZnVuY3Rpb24KICAgIGBza2xlYXJuX2NsYXNzaWZpZXJgIGluIHRoaXMgcmVwb3NpdG9yeS4KICAgIAogICAgOnBhcmFtIG1vZGVsX3R5cGU6IG9uZSBvZiAiY2xhc3NpZmllciIsICJyZWdyZXNzb3IiLAogICAgICAgICAgICAgICAgICAgICAgICJyYW5rZXIiLCAicmZfY2xhc3NpZmllciIsIG9yCiAgICAgICAgICAgICAgICAgICAgICAicmZfcmVncmVzc29yIgogICAgOnBhcmFtIHhnYl9wYXJhbXM6IGNsYXNzIGluaXQgcGFyYW1ldGVycwogICAgIiIiCiAgICBtdHlwZXMgPSB7CiAgICAgICAgImNsYXNzaWZpZXIiICAgOiAieGdib29zdC5YR0JDbGFzc2lmaWVyIiwKICAgICAgICAicmVncmVzc29yIiAgICA6ICJ4Z2Jvb3N0LlhHQlJlZ3Jlc3NvciIsCiAgICAgICAgInJhbmtlciIgICAgICAgOiAieGdib29zdC5YR0JSYW5rZXIiLAogICAgICAgICJyZl9jbGFzc2lmaWVyIjogInhnYm9vc3QuWEdCUkZDbGFzc2lmaWVyIiwKICAgICAgICAicmZfcmVncmVzc29yIiA6ICJ4Z2Jvb3N0LlhHQlJGUmVncmVzc29yIgogICAgfQogICAgaWYgbW9kZWxfdHlwZS5lbmRzd2l0aCgianNvbiIpOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IG1vZGVsX3R5cGUKICAgIGVsaWYgbW9kZWxfdHlwZSBpbiBtdHlwZXMua2V5cygpOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IG10eXBlc1ttb2RlbF90eXBlXQogICAgZWxzZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oInVucmVjb2duaXplZCBtb2RlbCB0eXBlLCBzZWUgaGVscCBkb2N1bWVudGF0aW9uIikKCiAgICByZXR1cm4gZ2VuX3NrbGVhcm5fbW9kZWwobW9kZWxfY29uZmlnLCB4Z2JfcGFyYW1zKQoKZGVmIHRyYWluX21vZGVsKAogICAgY29udGV4dDogTUxDbGllbnRDdHgsCiAgICBtb2RlbF90eXBlOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhSXRlbSwKICAgIGxhYmVsX2NvbHVtbjogc3RyID0gImxhYmVscyIsCiAgICBlbmNvZGVfY29sczogZGljdCA9IHt9LAogICAgc2FtcGxlOiBpbnQgPSAtMSwKICAgIGltYmFsX3ZlYyA9IFtdLAogICAgdGVzdF9zaXplOiBmbG9hdCA9IDAuMjUsCiAgICB2YWxpZF9zaXplOiBmbG9hdCA9IDAuNzUsCiAgICByYW5kb21fc3RhdGU6IGludCA9IDEsCiAgICBtb2RlbHNfZGVzdDogc3RyID0gIm1vZGVscyIsCiAgICBwbG90c19kZXN0OiBzdHIgPSAicGxvdHMiLAogICAgZXZhbF9tZXRyaWNzOiBsaXN0PSBbImVycm9yIiwgImF1YyJdLAogICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IiwKICAgIG1vZGVsX3BrZ19maWxlOiBzdHIgPSAiIiwgICAgCikgLT4gTm9uZToKICAgICIiInRyYWluIGFuIHhnYm9vc3QgbW9kZWwuCiAgICAKICAgIE5vdGUgb24gaW1hYmFsYW5jZWQgZGF0YTogIHRoZSBgaW1iYWxfdmVjYCBwYXJhbWV0ZXIgcmVwcmVzZW50cyB0aGUgbWVhc3VyZWQKICAgIGNsYXNzIHJlcHJlc2VudGF0aW9ucyBpbiB0aGUgc2FtcGxlIGFuZCBjYW4gYmUgdXNlZCBhcyBhIGZpcnN0IHN0ZXAgaW4gdHVuaW5nCiAgICBhbiBYR0Jvb3N0IG1vZGVsLiAgVGhpcyBpc24ndCBhIGh5cGVycGFyYW10ZXIsIG1lcmVseSBhbiBlc3RpbWF0ZSB0aGF0IHNob3VsZAogICAgYmUgc2V0IGFzICdjb25zdGFudCcgdGhyb3VnaG91dCB0dW5pbmcgcHJvY2Vzcy4KICAgIAogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIG1vZGVsX3R5cGU6ICAgICAgICB0aGUgbW9kZWwgdHlwZSB0byB0cmFpbiwgImNsYXNzaWZpZXIiLCAicmVncmVzc29yIi4uLgogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAoImRhdGEiKSBuYW1lIG9mIHJhdyBkYXRhIGZpbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBlbmNvZGVfY29sczogICAgICAgZGljdGlvbmFyeSBvZiBuYW1lcyBhbmQgcHJlZml4ZXMgZm9yIGNvbHVtbnMgdGhhdCBhcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gaG90IGJlIGVuY29kZWQuCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSBpbWJhbF92ZWM6ICAgICAgICAgKFtdKSB2ZWN0b3Igb2YgY2xhc3Mgd2VpZ2h0cyBzZWVuIGluIHNhbXBsZQogICAgOnBhcmFtIHRlc3Rfc2l6ZTogICAgICAgICAoMC4wNSkgdGVzdCBzZXQgc2l6ZQogICAgOnBhcmFtIHZhbGlkX3NpemU6ICAgICAgICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHJhbmRvbV9zdGF0ZTogICAgICAoMSkgc2tsZWFybiBybmcgc2VlZAogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICBkZXN0aW5hdGlvbiBzdWJmb2xkZXIgZm9yIG1vZGVsIGFydGlmYWN0cwogICAgOnBhcmFtIHBsb3RzX2Rlc3Q6ICAgICAgICBkZXN0aW5hdGlvbiBzdWJmb2xkZXIgZm9yIHBsb3QgYXJ0aWZhY3RzCiAgICA6cGFyYW0gZXZhbF9tZXRyaWNzOiAgICAgIChbImVycm9yIiwgImF1YyJdKSBsZWFybmluZyBjdXJ2ZSBtZXRyaWNzCiAgICA6cGFyYW0gZmlsZV9leHQ6ICAgICAgICAgIGZvcm1hdCBmb3IgdGVzdF9zZXRfa2V5IGhvbGQgb3V0IGRhdGEKICAgICIiIgogICAgbW9kZWxzX2Rlc3QgPSBtb2RlbHNfZGVzdCBvciAibW9kZWxzIgogICAgcGxvdHNfZGVzdCA9IHBsb3RzX2Rlc3Qgb3IgZiJwbG90cy97Y29udGV4dC5uYW1lfSIKICAgIAogICAgcmF3LCBsYWJlbHMsIGhlYWRlciA9IGdldF9zYW1wbGUoZGF0YXNldCwgc2FtcGxlLCBsYWJlbF9jb2x1bW4pCiAgICAKICAgIGlmIGVuY29kZV9jb2xzOgogICAgICAgIHJhdyA9IHBkLmdldF9kdW1taWVzKHJhdywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1ucz1saXN0KGVuY29kZV9jb2xzLmtleXMoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeD1saXN0KGVuY29kZV9jb2xzLnZhbHVlcygpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJvcF9maXJzdD1UcnVlKQogICAgCiAgICAoeHRyYWluLCB5dHJhaW4pLCAoeHZhbGlkLCB5dmFsaWQpLCAoeHRlc3QsIHl0ZXN0KSA9ICAgICAgICAgZ2V0X3NwbGl0cyhyYXcsIGxhYmVscywgMywgdGVzdF9zaXplLCB2YWxpZF9zaXplLCByYW5kb21fc3RhdGUpCiAgICAKICAgIGNvbnRleHQubG9nX2RhdGFzZXQoInRlc3Qtc2V0IiwgZGY9cGQuY29uY2F0KFt4dGVzdCwgeXRlc3RdLCBheGlzPTEpLCBmb3JtYXQ9ZmlsZV9leHQsIGluZGV4PUZhbHNlKQoKICAgIG1vZGVsX2NvbmZpZyA9IF9nZW5feGdiX21vZGVsKG1vZGVsX3R5cGUsIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpKQoKICAgIFhHQkJvb3N0Q2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IFhHQkJvb3N0Q2xhc3MoKiptb2RlbF9jb25maWdbIkNMQVNTIl0pCgogICAgbW9kZWxfY29uZmlnWyJGSVQiXS51cGRhdGUoeyJYIjogeHRyYWluLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAieSI6IHl0cmFpbi52YWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImV2YWxfc2V0IjpbKHh0cmFpbiwgeXRyYWluKSwgKHh2YWxpZCwgeXZhbGlkKV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImV2YWxfbWV0cmljIjogZXZhbF9tZXRyaWNzfSkKCiAgICBtb2RlbC5maXQoKiptb2RlbF9jb25maWdbIkZJVCJdKQoKICAgIGV2YWxfbWV0cmljcyA9IGV2YWxfbW9kZWxfdjIoY29udGV4dCwgeHZhbGlkLCB5dmFsaWQsIG1vZGVsKQoKICAgIGlmIGhhc2F0dHIoZXZhbF9tZXRyaWNzLCAicGxvdHMiKToKICAgICAgICBtb2RlbF9wbG90cyA9IGV2YWxfbWV0cmljcy5wb3AoInBsb3RzIikKICAgICAgICBmb3IgcGxvdCBpbiBtb2RlbF9wbG90czoKICAgICAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QocGxvdCwgbG9jYWxfcGF0aD1mIntwbG90c19kZXN0fS97cGxvdC5rZXl9Lmh0bWwiKQogICAgaWYgaGFzYXR0cihldmFsX21ldHJpY3MsICJ0YWJsZXMiKToKICAgICAgICBtb2RlbF90YWJsZXMgPSBldmFsX21ldHJpY3MucG9wKCJ0YWJsZXMiKQogICAgICAgIGZvciB0YmwgaW4gbW9kZWxfdGFibGVzOgogICAgICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCh0YmwsIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0ve3Bsb3Qua2V5fS5jc3YiKQoKICAgIG1vZGVsX2JpbiA9IGR1bXBzKG1vZGVsKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#38075b80f98ce9e00ce0ff287cb344420ea6537c:xgb_trainer.ipynb
