metadata:
  tag: ''
  name: azureml-utils
  categories:
  - model-serving
  - utils
verbose: false
kind: job
spec:
  image: ''
  disable_auto_mount: false
  build:
    origin_filename: ''
    with_mlrun: true
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IGpzb24KaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG9zCgppbXBvcnQgbWxydW4uZGF0YXN0b3JlCmltcG9ydCBtbHJ1bi5mZWF0dXJlX3N0b3JlIGFzIGZfc3RvcmUKaW1wb3J0IG1scnVuLnV0aWxzCmZyb20gYXp1cmVtbC5jb3JlLmF1dGhlbnRpY2F0aW9uIGltcG9ydCBTZXJ2aWNlUHJpbmNpcGFsQXV0aGVudGljYXRpb24KZnJvbSBhenVyZW1sLmNvcmUuY29tcHV0ZSBpbXBvcnQgQW1sQ29tcHV0ZSwgQ29tcHV0ZVRhcmdldApmcm9tIGF6dXJlbWwuY29yZS5jb21wdXRlX3RhcmdldCBpbXBvcnQgQ29tcHV0ZVRhcmdldEV4Y2VwdGlvbgpmcm9tIGF6dXJlbWwuY29yZS5kYXRhc2V0IGltcG9ydCBEYXRhc2V0CmZyb20gYXp1cmVtbC5jb3JlLmV4cGVyaW1lbnQgaW1wb3J0IEV4cGVyaW1lbnQKZnJvbSBhenVyZW1sLmNvcmUubW9kZWwgaW1wb3J0IE1vZGVsCmZyb20gYXp1cmVtbC5jb3JlLnNjcmlwdF9ydW4gaW1wb3J0IFNjcmlwdFJ1bgpmcm9tIGF6dXJlbWwuY29yZS53b3Jrc3BhY2UgaW1wb3J0IFdvcmtzcGFjZQpmcm9tIGF6dXJlbWwudHJhaW4uYXV0b21sIGltcG9ydCBBdXRvTUxDb25maWcKZnJvbSBhenVyZW1sLnRyYWluLmF1dG9tbC5ydW4gaW1wb3J0IEF1dG9NTFJ1bgpmcm9tIG1scnVuIGltcG9ydCBEYXRhSXRlbSwgTUxDbGllbnRDdHgsIGdldF9kYXRhaXRlbQpmcm9tIG1scnVuLmRhdGFzdG9yZS50YXJnZXRzIGltcG9ydCBQYXJxdWV0VGFyZ2V0CgoKZGVmIF9lbnZfb3Jfc2VjcmV0KGNvbnRleHQsIGtleSk6CiAgICBpZiBrZXkgaW4gb3MuZW52aXJvbjoKICAgICAgICByZXR1cm4gb3MuZW52aXJvbltrZXldCiAgICByZXR1cm4gY29udGV4dC5nZXRfc2VjcmV0KGtleSkKCgpkZWYgX2xvYWRfd29ya3NwYWNlKGNvbnRleHQ6IE1MQ2xpZW50Q3R4KSAtPiBXb3Jrc3BhY2U6CiAgICAiIiIKICAgIExvYWRpbmcgQXp1cmVNTCBXb3Jrc3BhY2Ugd2l0aCBBenVyZSBzZWNyZXRzLgoKICAgIDpwYXJhbSBjb250ZXh0OiBNTFJ1biBjb250ZXh0LgogICAgOnJldHVybnM6ICAgICAgIEF6dXJlTUwgV29ya3NwYWNlCiAgICAiIiIKCiAgICBpZiBoYXNhdHRyKGNvbnRleHQsICJfYXp1cmVfd29ya3NwYWNlIik6CiAgICAgICAgcmV0dXJuIGNvbnRleHQuX2F6dXJlX3dvcmtzcGFjZQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkxvYWRpbmcgQXp1cmVNTCBXb3Jrc3BhY2UiKQogICAgIyBBenVyZSBzZXJ2aWNlIGF1dGhlbnRpY2F0aW9uOgogICAgc2VydmljZV9hdXRoZW50aWNhdGlvbiA9IFNlcnZpY2VQcmluY2lwYWxBdXRoZW50aWNhdGlvbigKICAgICAgICB0ZW5hbnRfaWQ9X2Vudl9vcl9zZWNyZXQoY29udGV4dCwgIkFaVVJFX1RFTkFOVF9JRCIpLAogICAgICAgIHNlcnZpY2VfcHJpbmNpcGFsX2lkPV9lbnZfb3Jfc2VjcmV0KGNvbnRleHQsICJBWlVSRV9TRVJWSUNFX1BSSU5DSVBBTF9JRCIpLAogICAgICAgIHNlcnZpY2VfcHJpbmNpcGFsX3Bhc3N3b3JkPV9lbnZfb3Jfc2VjcmV0KAogICAgICAgICAgICBjb250ZXh0LCAiQVpVUkVfU0VSVklDRV9QUklOQ0lQQUxfUEFTU1dPUkQiCiAgICAgICAgKSwKICAgICkKCiAgICAjIExvYWRpbmcgQXp1cmUgd29ya3NwYWNlOgogICAgd29ya3NwYWNlID0gV29ya3NwYWNlKAogICAgICAgIHN1YnNjcmlwdGlvbl9pZD1fZW52X29yX3NlY3JldChjb250ZXh0LCAiQVpVUkVfU1VCU0NSSVBUSU9OX0lEIiksCiAgICAgICAgcmVzb3VyY2VfZ3JvdXA9X2Vudl9vcl9zZWNyZXQoY29udGV4dCwgIkFaVVJFX1JFU09VUkNFX0dST1VQIiksCiAgICAgICAgd29ya3NwYWNlX25hbWU9X2Vudl9vcl9zZWNyZXQoY29udGV4dCwgIkFaVVJFX1dPUktTUEFDRV9OQU1FIiksCiAgICAgICAgYXV0aD1zZXJ2aWNlX2F1dGhlbnRpY2F0aW9uLAogICAgKQoKICAgIGNvbnRleHQuX2F6dXJlX3dvcmtzcGFjZSA9IHdvcmtzcGFjZQogICAgcmV0dXJuIHdvcmtzcGFjZQoKCmRlZiBfaW5pdF9leHBlcmltZW50KAogICAgY29udGV4dDogTUxDbGllbnRDdHgsIGV4cGVyaW1lbnRfbmFtZTogc3RyCikgLT4gdHVwbGVbV29ya3NwYWNlLCBFeHBlcmltZW50XToKICAgICIiIgogICAgSW5pdGlhbGl6ZSB3b3Jrc3BhY2UgYW5kIGV4cGVyaW1lbnQgaW4gQXp1cmUgTUwuIFVzZXMgU2VydmljZQogICAgUHJpbmNpcGFsIGF1dGhlbnRpY2F0aW9uIHZpYSBlbnZpcm9ubWVudCB2YXJpYWJsZXMuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBleHBlcmltZW50X25hbWU6IE5hbWUgb2YgZXhwZXJpbWVudCB0byBjcmVhdGUgaW4gQXp1cmUgTUwuCiAgICA6cmV0dXJuczogICAgICAgICAgICAgICBBenVyZSBNTCBXb3Jrc3BhY2UgYW5kIEV4cGVyaW1lbnQuCiAgICAiIiIKCiAgICAjIEluaXRpYWxpemUgZXhwZXJpbWVudCB2aWEgU2VydmljZSBQcmluY2lwYWwgQXV0aGVudGljYXRpb246CiAgICAjIGh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL2F6dXJlL21hY2hpbmUtbGVhcm5pbmcvaG93LXRvLXNldHVwLWF1dGhlbnRpY2F0aW9uI3VzZS1zZXJ2aWNlLXByaW5jaXBhbC1hdXRoZW50aWNhdGlvbgoKICAgIHdvcmtzcGFjZSA9IF9sb2FkX3dvcmtzcGFjZShjb250ZXh0KQoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJJbml0aWFsaXppbmcgQXp1cmVNTCBleHBlcmltZW50IHtleHBlcmltZW50X25hbWV9IikKICAgICMgQ3JlYXRpbmcgZXhwZXJpbWVudDoKICAgIGV4cGVyaW1lbnQgPSBFeHBlcmltZW50KHdvcmtzcGFjZSwgZXhwZXJpbWVudF9uYW1lKQoKICAgIHJldHVybiB3b3Jrc3BhY2UsIGV4cGVyaW1lbnQKCgpkZWYgaW5pdF9jb21wdXRlKAogICAgY29udGV4dDogTUxDbGllbnRDdHgsCiAgICBjcHVfY2x1c3Rlcl9uYW1lOiBzdHIsCiAgICB2bV9zaXplOiBzdHIgPSAiU1RBTkRBUkRfRDJfVjIiLAogICAgbWF4X25vZGVzOiBpbnQgPSAxLAopIC0+IENvbXB1dGVUYXJnZXQ6CiAgICAiIiIKICAgIEluaXRpYWxpemUgQXp1cmUgTUwgY29tcHV0ZSB0YXJnZXQgdG8gcnVuIGV4cGVyaW1lbnQuIENoZWNrcyBmb3IKICAgIGV4aXN0aW5nIGNvbXB1dGUgdGFyZ2V0IGFuZCBjcmVhdGVzIG5ldyBpZiBkb2VzIG5vdCBleGlzdC4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBjcHVfY2x1c3Rlcl9uYW1lOiBOYW1lIG9mIEF6dXJlIE1MIGNvbXB1dGUgdGFyZ2V0LiBDcmVhdGVkIGlmIGRvZXMgbm90IGV4aXN0LgogICAgOnBhcmFtIHZtX3NpemU6ICAgICAgICAgIEF6dXJlIG1hY2hpbmUgdHlwZSBmb3IgY29tcHV0ZSB0YXJnZXQuCiAgICA6cGFyYW0gbWF4X25vZGVzOiAgICAgICAgTWF4aW11bSBudW1iZXIgb2YgY29uY3VycmVudCBjb21wdXRlIHRhcmdldHMuCiAgICA6cmV0dXJuczogICAgICAgICAgICAgICAgQXp1cmUgTUwgQ29tcHV0ZSBUYXJnZXQuCiAgICAiIiIKCiAgICB3b3Jrc3BhY2UgPSBfbG9hZF93b3Jrc3BhY2UoY29udGV4dCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJJbml0aWFsaXppbmcgQXp1cmVNTCBjb21wdXRlIHRhcmdldCB7Y3B1X2NsdXN0ZXJfbmFtZX0iKQoKICAgICMgVmVyaWZ5IHRoYXQgY2x1c3RlciBkb2VzIG5vdCBleGlzdCBhbHJlYWR5OgogICAgdHJ5OgogICAgICAgIGNvbXB1dGVfdGFyZ2V0ID0gQ29tcHV0ZVRhcmdldCh3b3Jrc3BhY2U9d29ya3NwYWNlLCBuYW1lPWNwdV9jbHVzdGVyX25hbWUpCiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiRm91bmQgZXhpc3RpbmcgY2x1c3Rlciwgd2lsbCB1c2UgaXQuIikKICAgIGV4Y2VwdCBDb21wdXRlVGFyZ2V0RXhjZXB0aW9uOgogICAgICAgIGNvbXB1dGVfY29uZmlnID0gQW1sQ29tcHV0ZS5wcm92aXNpb25pbmdfY29uZmlndXJhdGlvbigKICAgICAgICAgICAgdm1fc2l6ZT12bV9zaXplLCBtYXhfbm9kZXM9bWF4X25vZGVzCiAgICAgICAgKQogICAgICAgIGNvbXB1dGVfdGFyZ2V0ID0gQ29tcHV0ZVRhcmdldC5jcmVhdGUoCiAgICAgICAgICAgIHdvcmtzcGFjZSwgY3B1X2NsdXN0ZXJfbmFtZSwgY29tcHV0ZV9jb25maWcKICAgICAgICApCgogICAgY29tcHV0ZV90YXJnZXQud2FpdF9mb3JfY29tcGxldGlvbihzaG93X291dHB1dD1UcnVlKQogICAgcmV0dXJuIGNvbXB1dGVfdGFyZ2V0CgoKZGVmIHJlZ2lzdGVyX2RhdGFzZXQoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGRhdGFzZXRfbmFtZTogc3RyLAogICAgZGF0YXNldF9kZXNjcmlwdGlvbjogc3RyLAogICAgZGF0YTogRGF0YUl0ZW0sCiAgICBjcmVhdGVfbmV3X3ZlcnNpb246IGJvb2wgPSBGYWxzZSwKKToKICAgICIiIgogICAgUmVnaXN0ZXIgZGF0YXNldCBvYmplY3QgKGNhbiBiZSBhbHNvIGFuIElndWF6aW8gRmVhdHVyZVZlY3RvcikgaW4gQXp1cmUgTUwuCiAgICBVcGxvYWRzIHBhcnF1ZXQgZmlsZSB0byBBenVyZSBibG9iIHN0b3JhZ2UgYW5kIHJlZ2lzdGVycwogICAgdGhhdCBmaWxlIGFzIGEgZGF0YXNldCBpbiBBenVyZSBNTC4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgICBNTFJ1biBjb250ZXh0LgogICAgOnBhcmFtIGRhdGFzZXRfbmFtZTogICAgICAgICAgTmFtZSBvZiBBenVyZSBkYXRhc2V0IHRvIHJlZ2lzdGVyLgogICAgOnBhcmFtIGRhdGFzZXRfZGVzY3JpcHRpb246ICAgRGVzY3JpcHRpb24gb2YgQXp1cmUgZGF0YXNldCB0byByZWdpc3Rlci4KICAgIDpwYXJhbSBkYXRhOiAgICAgICAgICAgICAgICAgIE1MUnVuIEZlYXR1cmVWZWN0b3Igb3IgZGF0YXNldCBvYmplY3QgdG8gdXBsb2FkLgogICAgOnBhcmFtIGNyZWF0ZV9uZXdfdmVyc2lvbjogICAgUmVnaXN0ZXIgQXp1cmUgZGF0YXNldCBhcyBuZXcgdmVyc2lvbi4gTXVzdCBiZSB1c2VkIHdoZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeWluZyBkYXRhc2V0IHNjaGVtYS4KICAgICIiIgoKICAgICMgdGVzdCBmb3IgQXp1cmUgc3RvcmFnZSBjb25uZWN0aW9uIGVudmlyb25tZW50IHZhcmlhYmxlIG9yIHNlY3JldDoKICAgIGFzc2VydCBfZW52X29yX3NlY3JldChjb250ZXh0LCAiQVpVUkVfU1RPUkFHRV9DT05ORUNUSU9OX1NUUklORyIpLCAoCiAgICAgICAgIkFaVVJFX1NUT1JBR0VfQ09OTkVDVElPTl9TVFJJTkcgc2VjcmV0IG5vdCBzZXQiCiAgICApCgogICAgIyBDb25uZWN0IHRvIEF6dXJlTUwgZXhwZXJpbWVudCBhbmQgZGF0YXN0b3JlOgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiQ29ubmVjdGluZyB0byBBenVyZU1MIGV4cGVyaW1lbnQgZGVmYXVsdCBkYXRhc3RvcmUiKQoKICAgIHdvcmtzcGFjZSA9IF9sb2FkX3dvcmtzcGFjZShjb250ZXh0KQogICAgZGF0YXN0b3JlID0gd29ya3NwYWNlLmdldF9kZWZhdWx0X2RhdGFzdG9yZSgpCgogICAgIyBBenVyZSBibG9iIHBhdGggKGRlZmF1bHQgZGF0YXN0b3JlIGZvciB3b3Jrc3BhY2UpOgogICAgYmxvYl9wYXRoID0gZiJhejovL3tkYXRhc3RvcmUuY29udGFpbmVyX25hbWV9L3tkYXRhc2V0X25hbWV9IgoKICAgIHN0b3JlX3VyaV9wcmVmaXgsIF8gPSBtbHJ1bi5kYXRhc3RvcmUucGFyc2Vfc3RvcmVfdXJpKGRhdGEuYXJ0aWZhY3RfdXJsKQogICAgZmVhdHVyZV92ZWN0b3JfY2FzZSA9IG1scnVuLnV0aWxzLlN0b3JlUHJlZml4LkZlYXR1cmVWZWN0b3IgPT0gc3RvcmVfdXJpX3ByZWZpeAogICAgIyBSZXRyaWV2ZSBkYXRhIHNvdXJjZSBhcyBkYXRhZnJhbWU6CiAgICBpZiBmZWF0dXJlX3ZlY3Rvcl9jYXNlOgogICAgICAgICMgRmVhdHVyZVZlY3RvciBjYXNlOgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGYiUmV0cmlldmluZyBmZWF0dXJlIHZlY3RvciBhbmQgdXBsb2FkaW5nIHRvIEF6dXJlIGJsb2Igc3RvcmFnZToge2Jsb2JfcGF0aH0iCiAgICAgICAgKQogICAgICAgIGZfc3RvcmUuZ2V0X29mZmxpbmVfZmVhdHVyZXMoCiAgICAgICAgICAgIGRhdGEubWV0YS51cmksIHRhcmdldD1QYXJxdWV0VGFyZ2V0KHBhdGg9YmxvYl9wYXRoKQogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgYmxvYl9wYXRoICs9IGRhdGEuc3VmZml4CiAgICAgICAgIyBEYXRhSXRlbSBjYXNlOgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGYiUmV0cmlldmluZyBmZWF0dXJlIHZlY3RvciBhbmQgdXBsb2FkaW5nIHRvIEF6dXJlIGJsb2Igc3RvcmFnZToge2Jsb2JfcGF0aH0iCiAgICAgICAgKQogICAgICAgIGRhdGFfaW5fYnl0ZXMgPSBkYXRhLmdldCgpCiAgICAgICAgZ2V0X2RhdGFpdGVtKGJsb2JfcGF0aCkucHV0KGRhdGFfaW5fYnl0ZXMpCgogICAgIyBSZWdpc3RlciBkYXRhc2V0IGluIEF6dXJlTUw6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiUmVnaXN0ZXJpbmcgZGF0YXNldCB7ZGF0YXNldF9uYW1lfSBpbiBBenVyZSBNTCIpCiAgICBpZiBkYXRhLnN1ZmZpeCA9PSAiLnBhcnF1ZXQiIG9yIGZlYXR1cmVfdmVjdG9yX2Nhc2U6CiAgICAgICAgZGF0YXNldCA9IERhdGFzZXQuVGFidWxhci5mcm9tX3BhcnF1ZXRfZmlsZXMoCiAgICAgICAgICAgIHBhdGg9KGRhdGFzdG9yZSwgZiJ7ZGF0YXNldF9uYW1lfS5wYXJxdWV0IiksIHZhbGlkYXRlPUZhbHNlCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKAogICAgICAgICAgICAiT3BlblNTTCB2ZXJzaW9uIG11c3QgYmUgMS4xLiBPdmVycmlkaW5nIHRoZSBPcGVuU1NMIHZlcnNpb24gdG8gMS4xIgogICAgICAgICkKICAgICAgICAjIE9wZW5TU0wgdmVyc2lvbiBtdXN0IGJlIDEuMQogICAgICAgIG9zLmVudmlyb25bIkNMUl9PUEVOU1NMX1ZFUlNJT05fT1ZFUlJJREUiXSA9ICIxLjEiCiAgICAgICAgZGF0YXNldCA9IERhdGFzZXQuVGFidWxhci5mcm9tX2RlbGltaXRlZF9maWxlcygKICAgICAgICAgICAgcGF0aD0oZGF0YXN0b3JlLCBmIntkYXRhc2V0X25hbWV9e2RhdGEuc3VmZml4fSIpLCB2YWxpZGF0ZT1GYWxzZQogICAgICAgICkKCiAgICBkYXRhc2V0LnJlZ2lzdGVyKAogICAgICAgIHdvcmtzcGFjZT13b3Jrc3BhY2UsCiAgICAgICAgbmFtZT1kYXRhc2V0X25hbWUsCiAgICAgICAgZGVzY3JpcHRpb249ZGF0YXNldF9kZXNjcmlwdGlvbiwKICAgICAgICBjcmVhdGVfbmV3X3ZlcnNpb249Y3JlYXRlX25ld192ZXJzaW9uLAogICAgKQoKICAgICMgT3V0cHV0IHJlZ2lzdGVyZWQgZGF0YXNldCBuYW1lIGluIEF6dXJlOgogICAgY29udGV4dC5sb2dfcmVzdWx0KCJkYXRhc2V0X2Jsb2JfcGF0aCIsIGJsb2JfcGF0aCkKCgpkZWYgZG93bmxvYWRfbW9kZWwoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIG1vZGVsX25hbWU6IHN0ciwKICAgIG1vZGVsX3ZlcnNpb246IGludCwKICAgIHRhcmdldF9kaXI6IHN0ciA9ICIuIiwKKSAtPiBOb25lOgogICAgIiIiCiAgICBEb3dubG9hZCB0cmFpbmVkIG1vZGVsIGZyb20gQXp1cmUgTUwgdG8gbG9jYWwgZmlsZXN5c3RlbS4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBtb2RlbF9uYW1lOiAgICBOYW1lIG9mIHRyYWluZWQgYW5kIHJlZ2lzdGVyZWQgbW9kZWwuCiAgICA6cGFyYW0gbW9kZWxfdmVyc2lvbjogVmVyc2lvbiBvZiBtb2RlbCB0byBkb3dubG9hZC4KICAgIDpwYXJhbSB0YXJnZXRfZGlyOiAgICBUYXJnZXQgZGlyZWN0b3J5IHRvIGRvd25sb2FkIG1vZGVsLgogICAgIiIiCiAgICAjIExvYWRpbmcgd29ya3NwYWNlIGlmIG5vdCBwcm92aWRlZDoKICAgIHdvcmtzcGFjZSA9IF9sb2FkX3dvcmtzcGFjZShjb250ZXh0KQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkRvd25sb2FkaW5nIG1vZGVsIHttb2RlbF9uYW1lfTp7bW9kZWxfdmVyc2lvbn0iKQogICAgbW9kZWwgPSBNb2RlbCh3b3Jrc3BhY2UsIG1vZGVsX25hbWUsIHZlcnNpb249bW9kZWxfdmVyc2lvbikKICAgIG1vZGVsLmRvd25sb2FkKHRhcmdldF9kaXI9dGFyZ2V0X2RpciwgZXhpc3Rfb2s9VHJ1ZSkKCgpkZWYgdXBsb2FkX21vZGVsKAogICAgY29udGV4dDogTUxDbGllbnRDdHgsCiAgICBtb2RlbF9uYW1lOiBzdHIsCiAgICBtb2RlbF9wYXRoOiBzdHIsCiAgICBtb2RlbF9kZXNjcmlwdGlvbjogc3RyID0gTm9uZSwKICAgIG1vZGVsX3RhZ3M6IGRpY3QgPSBOb25lLAopIC0+IE5vbmU6CiAgICAiIiIKICAgIFVwbG9hZCBwcmUtdHJhaW5lZCBtb2RlbCBmcm9tIGxvY2FsIGZpbGVzeXN0ZW0gdG8gQXp1cmUgTUwuCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIE1MUnVuIGNvbnRleHQuCiAgICA6cGFyYW0gbW9kZWxfbmFtZTogICAgICAgIE5hbWUgb2YgdHJhaW5lZCBhbmQgcmVnaXN0ZXJlZCBtb2RlbC4KICAgIDpwYXJhbSBtb2RlbF9wYXRoOiAgICAgICAgUGF0aCB0byBmaWxlIG9uIGxvY2FsIGZpbGVzeXN0ZW0uCiAgICA6cGFyYW0gbW9kZWxfZGVzY3JpcHRpb246IERlc2NyaXB0aW9uIG9mIG1vZGVscy4KICAgIDpwYXJhbSBtb2RlbF90YWdzOiAgICAgICAgS1YgcGFpcnMgb2YgbW9kZWwgdGFncy4KICAgICIiIgogICAgIyBMb2FkaW5nIHdvcmtzcGFjZSBpZiBub3QgcHJvdmlkZWQ6CiAgICB3b3Jrc3BhY2UgPSBfbG9hZF93b3Jrc3BhY2UoY29udGV4dCkKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiVXBsb2FkIG1vZGVsIHttb2RlbF9uYW1lfSBmcm9tIHttb2RlbF9wYXRofSIpCiAgICBNb2RlbC5yZWdpc3RlcigKICAgICAgICB3b3Jrc3BhY2U9d29ya3NwYWNlLAogICAgICAgIG1vZGVsX3BhdGg9bW9kZWxfcGF0aCwKICAgICAgICBtb2RlbF9uYW1lPW1vZGVsX25hbWUsCiAgICAgICAgZGVzY3JpcHRpb249bW9kZWxfZGVzY3JpcHRpb24sCiAgICAgICAgdGFncz1tb2RlbF90YWdzLAogICAgKQoKCmRlZiBfZ2V0X3RvcF9uX3J1bnMoCiAgICByZW1vdGVfcnVuOiBBdXRvTUxSdW4sIG46IGludCA9IDUsIHByaW1hcnlfbWV0cmljOiBzdHIgPSAiYWNjdXJhY3kiCikgLT4gbGlzdFtTY3JpcHRSdW5dOgogICAgIiIiCiAgICBHZXQgdG9wIE4gY29tcGxldGUgcnVucyBmcm9tIGV4cGVyaW1lbnQgc29ydGVkIGJ5IHByaW1hcnkgbWV0cmljLgoKICAgIDpwYXJhbSByZW1vdGVfcnVuOiAgICAgQXp1cmUgTUwgUnVuLgogICAgOnBhcmFtIG46ICAgICAgICAgICAgICBOdW1iZXIgb2YgdG9wIHJ1bnMgdG8gcmV0dXJuLgogICAgOnBhcmFtIHByaW1hcnlfbWV0cmljOiBNZXRyaWMgdG8gc29ydCBieS4KCiAgICA6cmV0dXJuczogICAgICAgICAgICAgIExpc3Qgb2YgdG9wIE4gcnVucyBzb3J0ZWQgYnkgcHJpbWFyeSBtZXRyaWMuCiAgICAiIiIKICAgICMgQ29sbGVjdCBhbGwgbW9kZWxzOgogICAgY29tcGxldGVfcnVucyA9IFsKICAgICAgICBydW4KICAgICAgICBmb3IgcnVuIGluIHJlbW90ZV9ydW4uZ2V0X2NoaWxkcmVuKHN0YXR1cz0iQ29tcGxldGVkIikKICAgICAgICBpZiBub3QgYW55KHMgaW4gcnVuLmlkIGZvciBzIGluIFsic2V0dXAiLCAid29ya2VyIl0pCiAgICBdCgogICAgIyBDaGVja2luZyB0aGF0IHRoZSByZXF1aXJlZCBudW1iZXIgb2YgcnVucyBhcmUgZG9uZToKICAgIGlmIGxlbihjb21wbGV0ZV9ydW5zKSA8IG46CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIkV4cGVjdGVkIHtufSBydW5zIGJ1dCBvbmx5IHJlY2VpdmVkIHtsZW4oY29tcGxldGVfcnVucyl9IikKCiAgICAjIFNvcnRpbmcgYnkgdGhlIHByaW1hcnkgbWV0cmljOgogICAgc29ydGVkX3J1bnMgPSBzb3J0ZWQoCiAgICAgICAgY29tcGxldGVfcnVucywga2V5PWxhbWJkYSBydW46IHJ1bi5nZXRfbWV0cmljcygpW3ByaW1hcnlfbWV0cmljXSwgcmV2ZXJzZT1UcnVlCiAgICApCiAgICByZXR1cm4gc29ydGVkX3J1bnNbOm5dCgoKZGVmIF9nZXRfbW9kZWxfaHAoCiAgICBydW46IFNjcmlwdFJ1biwKKSAtPiBkaWN0OgogICAgIiIiCiAgICBHZXQgaHlwZXItcGFyYW1ldGVycyBvZiB0cmFpbmVkIEF6dXJlTUwgbW9kZWwuCiAgICBDb21iaW5lIHRoZSBoeXBlci1wYXJhbWV0ZXJzIG9mIHRoZSBkYXRhIHRyYW5zZm9ybWF0aW9uIGFuZCB0cmFpbmluZyB0byBhIGRpY3Rpb25hcnkuCiAgICBUaGUgcHJlZml4IG9mIHRoZSBkaWN0aW9uYXJ5IGtleXMgY29ycmVzcG9uZHMgdG8gJ2RhdGEgdHJhbnNmb3JtYXRpb24nIGFuZCAndHJhaW5pbmcnLgoKICAgIDpwYXJhbSBydW46IFJ1biBvYmplY3Qgb2YgQXp1cmVNTCB0cmFpbmVkIG1vZGVsLgoKICAgIDpyZXR1cm5zOiAgICBBIGRpY3Rpb25hcnkgYXMgZGVzY3JpYmVkIGluIHRoZSBkb2NzdHJpbmcuCiAgICAiIiIKCiAgICBzcGVjX2ZpZWxkID0gInBpcGVsaW5lX3NwZWMiCiAgICBpZiBzcGVjX2ZpZWxkIG5vdCBpbiBydW4ucHJvcGVydGllczoKICAgICAgICByZXR1cm4ge30KICAgIHNwZWNfc3RyaW5nID0gcnVuLnByb3BlcnRpZXNbc3BlY19maWVsZF0KICAgIHNwZWNfZGljdCA9IGpzb24ubG9hZHMoc3BlY19zdHJpbmcpCgogICAgaWYgIm9iamVjdHMiIG5vdCBpbiBzcGVjX2RpY3Q6CiAgICAgICAgIyBObyBoeXBlci1wYXJhbXMKICAgICAgICByZXR1cm4ge30KICAgIGhwX2RpY3RzID0gc3BlY19kaWN0WyJvYmplY3RzIl0KICAgICMgYWZ0ZXIgdHJhaW5pbmcgdGhlcmUgYXJlIHR3byBoeXBlci1wYXJhbWV0ZXJzIGRpY3RzIGluc2lkZSB0aGUgcnVuIG9iamVjdDoKICAgIGFzc2VydCBsZW4oaHBfZGljdHMpID09IDIsICgKICAgICAgICAiYWZ0ZXIgdHJhaW5pbmcgdGhlcmUgYXJlIHR3byBoeXBlci1wYXJhbWV0ZXJzIGRpY3RzIGluc2lkZSB0aGUgcnVuIG9iamVjdCIKICAgICkKICAgIHJlc3VsdF9kaWN0ID0ge30KICAgIGRpY3Rfa2V5cyA9IFsKICAgICAgICBbImRhdGFfdHJhbnNfY2xhc3NfbmFtZSIsICJkYXRhX3RyYW5zX21vZHVsZSIsICJkYXRhX3RyYW5zX3NwZWNfY2xhc3MiXSwKICAgICAgICBbCiAgICAgICAgICAgICJ0cmFpbl9jbGFzc19uYW1lIiwKICAgICAgICAgICAgInRyYWluX21vZHVsZSIsCiAgICAgICAgICAgICJ0cmFpbl9wYXJhbV9rd2FyZ3NfQyIsCiAgICAgICAgICAgICJ0cmFpbl9wYXJhbV9rd2FyZ3NfY2xhc3Nfd2VpZ2h0IiwKICAgICAgICAgICAgInRyYWluX3NwZWNfY2xhc3MiLAogICAgICAgIF0sCiAgICBdCgogICAgIyBjcmVhdGluZyBoeXBlci1wYXJhbXMgZGljdCB3aXRoIGtleSBwcmVmaXhlcyBmb3IgZWFjaCBwYXJ0OgogICAga3dhcmdzX3ByZWZpeCA9ICJwYXJhbV9rd2FyZ3MiCiAgICBmb3IgZCwgbmFtZSwga2V5cyBpbiB6aXAoaHBfZGljdHMsIFsiZGF0YV90cmFucyIsICJ0cmFpbiJdLCBkaWN0X2tleXMpOgogICAgICAgIGZvciBrZXkgaW4ga2V5czoKICAgICAgICAgICAgaWYga3dhcmdzX3ByZWZpeCBpbiBrZXk6CiAgICAgICAgICAgICAgICByZXN1bHRfZGljdFtrZXldID0gZFtrd2FyZ3NfcHJlZml4XVsKICAgICAgICAgICAgICAgICAgICBrZXkucmVwbGFjZShmIntuYW1lfV97a3dhcmdzX3ByZWZpeH1fIiwgIiIpCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXN1bHRfZGljdFtrZXldID0gZFtrZXkucmVwbGFjZShmIntuYW1lfV8iLCAiIildCiAgICAgICAgICAgIGlmIG5vdCByZXN1bHRfZGljdFtrZXldOgogICAgICAgICAgICAgICAgcmVzdWx0X2RpY3Rba2V5XSA9ICIiCgogICAgcmV0dXJuIHJlc3VsdF9kaWN0CgoKZGVmIHN1Ym1pdF90cmFpbmluZ19qb2IoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGV4cGVyaW1lbnQ6IEV4cGVyaW1lbnQsCiAgICBjb21wdXRlX3RhcmdldDogQ29tcHV0ZVRhcmdldCwKICAgIHJlZ2lzdGVyX21vZGVsX25hbWU6IHN0ciwKICAgIHJlZ2lzdGVyZWRfZGF0YXNldF9uYW1lOiBzdHIsCiAgICBhdXRvbWxfc2V0dGluZ3M6IGRpY3QsCiAgICB0cmFpbmluZ19zZXQ6IERhdGFJdGVtLAogICAgbGFiZWxfY29sdW1uX25hbWU6IHN0ciA9ICIiLAogICAgc2F2ZV9uX21vZGVsczogaW50ID0gMywKICAgIHNob3dfb3V0cHV0OiBib29sID0gVHJ1ZSwKKSAtPiBOb25lOgogICAgIiIiCiAgICBTdWJtaXQgdHJhaW5pbmcgam9iIHRvIEF6dXJlIEF1dG9NTCBhbmQgZG93bmxvYWQgdHJhaW5lZCBtb2RlbAogICAgd2hlbiBjb21wbGV0ZWQuIFVzZXMgcHJldmlvdXNseSByZWdpc3RlcmVkIGRhdGFzZXQgZm9yIHRyYWluaW5nLgoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBleHBlcmltZW50OiAgICAgICAgICAgICAgQXp1cmUgZXhwZXJpbWVudC4KICAgIDpwYXJhbSBjb21wdXRlX3RhcmdldDogICAgICAgICAgQXp1cmUgY29tcHV0ZSB0YXJnZXQuCiAgICA6cGFyYW0gcmVnaXN0ZXJfbW9kZWxfbmFtZTogICAgIE5hbWUgb2YgbW9kZWwgdG8gcmVnaXN0ZXIgaW4gQXp1cmUuCiAgICA6cGFyYW0gcmVnaXN0ZXJlZF9kYXRhc2V0X25hbWU6IE5hbWUgb2YgZGF0YXNldCByZWdpc3RlcmVkIGluIEF6dXJlIE1MLgogICAgOnBhcmFtIGxhYmVsX2NvbHVtbl9uYW1lOiAgICAgICBOYW1lIG9mIHRhcmdldCBjb2x1bW4gaW4gZGF0YXNldC4KICAgIDpwYXJhbSBhdXRvbWxfc2V0dGluZ3M6ICAgICAgICAgSlNPTiBzdHJpbmcgb2YgYWxsIEF6dXJlIEF1dG9NTCBzZXR0aW5ncy4KICAgIDpwYXJhbSB0cmFpbmluZ19zZXQ6ICAgICAgICAgICAgVHJhaW5pbmcgc2V0IHRvIGxvZyB3aXRoIG1vZGVsLiBGb3IgbW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9uaXRvcmluZyBpbnRlZ3JhdGlvbi4KICAgIDpwYXJhbSBzaG93X291dHB1dDogICAgICAgICAgICAgRGlzcGxheWluZyBBenVyZSBsb2dzLgogICAgOnBhcmFtIHNhdmVfbl9tb2RlbHM6ICAgICAgICAgICBIb3cgbWFueSBvZiB0aGUgdG9wIHBlcmZvcm1pbmcgbW9kZWxzIHRvIGxvZy4KICAgICIiIgogICAgIyBMb2FkaW5nIHdvcmtzcGFjZSBpZiBub3QgcHJvdmlkZWQ6CiAgICB3b3Jrc3BhY2UgPSBfbG9hZF93b3Jrc3BhY2UoY29udGV4dCkKCiAgICAjIFNldHVwIGV4cGVyaW1lbnQ6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJTZXR0aW5nIHVwIGV4cGVyaW1lbnQgcGFyYW1ldGVycyIpCiAgICBkYXRhc2V0ID0gRGF0YXNldC5nZXRfYnlfbmFtZSh3b3Jrc3BhY2UsIG5hbWU9cmVnaXN0ZXJlZF9kYXRhc2V0X25hbWUpCgogICAgIyBHZXQgdHJhaW5pbmcgc2V0IHRvIGxvZyB3aXRoIG1vZGVsOgogICAgZmVhdHVyZV92ZWN0b3IgPSBOb25lCiAgICBzdG9yZV91cmlfcHJlZml4LCBfID0gbWxydW4uZGF0YXN0b3JlLnBhcnNlX3N0b3JlX3VyaSh0cmFpbmluZ19zZXQuYXJ0aWZhY3RfdXJsKQogICAgaWYgbWxydW4udXRpbHMuU3RvcmVQcmVmaXguRmVhdHVyZVZlY3RvciA9PSBzdG9yZV91cmlfcHJlZml4OgogICAgICAgIGZlYXR1cmVfdmVjdG9yID0gdHJhaW5pbmdfc2V0Lm1ldGEudXJpCiAgICAgICAgbGFiZWxfY29sdW1uX25hbWUgPSBsYWJlbF9jb2x1bW5fbmFtZSBvciB0cmFpbmluZ19zZXQubWV0YS5zdGF0dXMubGFiZWxfY29sdW1uCiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmImxhYmVsIGNvbHVtbiBuYW1lOiB7bGFiZWxfY29sdW1uX25hbWV9IikKICAgICAgICB0cmFpbmluZ19zZXQgPSBmX3N0b3JlLmdldF9vZmZsaW5lX2ZlYXR1cmVzKGZlYXR1cmVfdmVjdG9yKS50b19kYXRhZnJhbWUoKQogICAgZWxzZToKICAgICAgICB0cmFpbmluZ19zZXQgPSB0cmFpbmluZ19zZXQuYXNfZGYoKQoKICAgIGF1dG9tbF9jb25maWcgPSBBdXRvTUxDb25maWcoCiAgICAgICAgY29tcHV0ZV90YXJnZXQ9Y29tcHV0ZV90YXJnZXQsCiAgICAgICAgdHJhaW5pbmdfZGF0YT1kYXRhc2V0LAogICAgICAgIHZlcmJvc2l0eT1sb2dnaW5nLklORk8sCiAgICAgICAgbGFiZWxfY29sdW1uX25hbWU9bGFiZWxfY29sdW1uX25hbWUsCiAgICAgICAgKiphdXRvbWxfc2V0dGluZ3MsCiAgICApCgogICAgIyBSdW4gZXhwZXJpbWVudCBvbiBBenVyZU1MOgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiU3VibWl0dGluZyBhbmQgcnVubmluZyBleHBlcmltZW50IikKICAgIHJlbW90ZV9ydW4gPSBleHBlcmltZW50LnN1Ym1pdChhdXRvbWxfY29uZmlnKQogICAgcmVtb3RlX3J1bi53YWl0X2Zvcl9jb21wbGV0aW9uKHNob3dfb3V0cHV0PXNob3dfb3V0cHV0KQogICAgaWYgc2hvd19vdXRwdXQ6CiAgICAgICAgIyBBenVyZSBsb2cgZW5kaW5nIHJvdzoKICAgICAgICBwcmludChmIlxueycqJyAqIDkyfVxuIikKICAgICMgR2V0IHRvcCBOIHJ1bnMgdG8gbG9nOgogICAgdG9wX3J1bnMgPSBfZ2V0X3RvcF9uX3J1bnMoCiAgICAgICAgcmVtb3RlX3J1bj1yZW1vdGVfcnVuLAogICAgICAgIG49c2F2ZV9uX21vZGVscywKICAgICAgICBwcmltYXJ5X21ldHJpYz1hdXRvbWxfc2V0dGluZ3NbInByaW1hcnlfbWV0cmljIl0sCiAgICApCgogICAgIyBSZWdpc3RlciwgZG93bmxvYWQsIGFuZCBsb2cgbW9kZWxzOgogICAgZm9yIGksIHJ1biBpbiBlbnVtZXJhdGUodG9wX3J1bnMpOgogICAgICAgICMgUmVnaXN0ZXIgbW9kZWw6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiUmVnaXN0ZXJpbmcgbW9kZWwiKQogICAgICAgIG1vZGVsID0gcnVuLnJlZ2lzdGVyX21vZGVsKAogICAgICAgICAgICBtb2RlbF9uYW1lPXJlZ2lzdGVyX21vZGVsX25hbWUsIG1vZGVsX3BhdGg9Im91dHB1dHMvbW9kZWwucGtsIgogICAgICAgICkKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKAogICAgICAgICAgICBmIlJlZ2lzdGVyZWQgbW9kZWwgd2l0aCBuYW1lICd7bW9kZWwubmFtZX0nLCBpZCAne21vZGVsLmlkfScsIHZlcnNpb24gJ3ttb2RlbC52ZXJzaW9ufSciCiAgICAgICAgKQoKICAgICAgICAjIERvd25sb2FkIG1vZGVsIGxvY2FsbHk6CiAgICAgICAgZG93bmxvYWRfbW9kZWwoCiAgICAgICAgICAgIGNvbnRleHQ9Y29udGV4dCwKICAgICAgICAgICAgbW9kZWxfbmFtZT1yZWdpc3Rlcl9tb2RlbF9uYW1lLAogICAgICAgICAgICBtb2RlbF92ZXJzaW9uPW1vZGVsLnZlcnNpb24sCiAgICAgICAgICAgIHRhcmdldF9kaXI9ZiIuL3ttb2RlbC52ZXJzaW9ufSIsCiAgICAgICAgKQoKICAgICAgICBtZXRyaWNzID0ge2subG93ZXIoKTogdmFsIGZvciBrLCB2YWwgaW4gcnVuLmdldF9tZXRyaWNzKCkuaXRlbXMoKX0KICAgICAgICBkZWwgbWV0cmljc1siY29uZnVzaW9uX21hdHJpeCJdCiAgICAgICAgZGVsIG1ldHJpY3NbImFjY3VyYWN5X3RhYmxlIl0KCiAgICAgICAgIyBDb2xsZWN0IG1vZGVsIGh5cGVyLXBhcmFtZXRlcnM6CiAgICAgICAgbW9kZWxfaHBfZGljdCA9IF9nZXRfbW9kZWxfaHAocnVuKQogICAgICAgIHdpdGggY29udGV4dC5nZXRfY2hpbGRfY29udGV4dCgqKm1vZGVsX2hwX2RpY3QpIGFzIGNoaWxkOgogICAgICAgICAgICBtb2RlbF9rZXkgPSBmIm1vZGVsX3tpICsgMX1fe21vZGVsX2hwX2RpY3RbJ2RhdGFfdHJhbnNfY2xhc3NfbmFtZSddLmxvd2VyKCl9X3ttb2RlbF9ocF9kaWN0Wyd0cmFpbl9jbGFzc19uYW1lJ10ubG93ZXIoKX0iCiAgICAgICAgICAgICMgTG9nIG1vZGVsOgogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9nZ2luZyB7bW9kZWxfa2V5fSBtb2RlbCB0byBNTFJ1biIpCiAgICAgICAgICAgIGNoaWxkLmxvZ19yZXN1bHRzKG1ldHJpY3MpCiAgICAgICAgICAgIGNoaWxkLmxvZ19tb2RlbCgKICAgICAgICAgICAgICAgICJtb2RlbCIsCiAgICAgICAgICAgICAgICBkYl9rZXk9bW9kZWxfa2V5LAogICAgICAgICAgICAgICAgYXJ0aWZhY3RfcGF0aD1jb250ZXh0LmFydGlmYWN0X3N1YnBhdGgoIm1vZGVscyIpLAogICAgICAgICAgICAgICAgbWV0cmljcz1tZXRyaWNzLAogICAgICAgICAgICAgICAgbW9kZWxfZmlsZT1mInttb2RlbC52ZXJzaW9ufS9tb2RlbC5wa2wiLAogICAgICAgICAgICAgICAgdHJhaW5pbmdfc2V0PXRyYWluaW5nX3NldCwKICAgICAgICAgICAgICAgIGxhYmVsX2NvbHVtbj1sYWJlbF9jb2x1bW5fbmFtZSwKICAgICAgICAgICAgICAgIGZlYXR1cmVfdmVjdG9yPWZlYXR1cmVfdmVjdG9yLAogICAgICAgICAgICAgICAgZnJhbWV3b3JrPSJBenVyZU1MIiwKICAgICAgICAgICAgICAgIGFsZ29yaXRobT1tb2RlbF9ocF9kaWN0LmdldCgidHJhaW5fY2xhc3NfbmFtZSIpLAogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIGkgPT0gMDoKICAgICAgICAgICAgICAgICMgVGhpcyBhbHNvIGxvZ3MgdGhlIG1vZGVsOgogICAgICAgICAgICAgICAgY2hpbGQubWFya19hc19iZXN0KCkKCgpkZWYgdHJhaW4oCiAgICAjIE1sUnVuCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGRhdGFzZXQ6IERhdGFJdGVtLAogICAgIyBJbml0IGV4cGVyaW1lbnQgYW5kIGNvbXB1dGUKICAgIGV4cGVyaW1lbnRfbmFtZTogc3RyID0gIiIsCiAgICBjcHVfY2x1c3Rlcl9uYW1lOiBzdHIgPSAiIiwKICAgIHZtX3NpemU6IHN0ciA9ICJTVEFOREFSRF9EMl9WMiIsCiAgICBtYXhfbm9kZXM6IGludCA9IDEsCiAgICAjIFJlZ2lzdGVyIGRhdGFzZXQKICAgIGRhdGFzZXRfbmFtZTogc3RyID0gIiIsCiAgICBkYXRhc2V0X2Rlc2NyaXB0aW9uOiBzdHIgPSAiIiwKICAgIGNyZWF0ZV9uZXdfdmVyc2lvbjogYm9vbCA9IEZhbHNlLAogICAgbGFiZWxfY29sdW1uX25hbWU6IHN0ciA9ICIiLAogICAgIyBTdWJtaXQgdHJhaW5pbmcgam9iCiAgICByZWdpc3Rlcl9tb2RlbF9uYW1lOiBzdHIgPSAiIiwKICAgIHNhdmVfbl9tb2RlbHM6IGludCA9IDEsCiAgICBsb2dfYXp1cmU6IGJvb2wgPSBUcnVlLAogICAgYXV0b21sX3NldHRpbmdzOiBzdHIgPSBOb25lLAopIC0+IE5vbmU6CiAgICAiIiIKICAgIFdob2xlIHRyYWluaW5nIGZsb3cgZm9yIEF6dXJlIEF1dG9NTC4gUmVnaXN0ZXJzIGRhdGFzZXQvZmVhdHVyZSB2ZWN0b3IsCiAgICBzdWJtaXRzIHRyYWluaW5nIGpvYiB0byBBenVyZSBBdXRvTUwsIGFuZCBkb3dubG9hZHMgdHJhaW5lZCBtb2RlbAogICAgd2hlbiBjb21wbGV0ZWQuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICAgIE1MUnVuIGNvbnRleHQuCgogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAgIE1MUnVuIEZlYXR1cmVWZWN0b3Igb3IgZGF0YXNldCBVUkkgdG8gdXBsb2FkLiBXaWxsIGRyb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCBiZWZvcmUgdXBsb2FkaW5nIHdoZW4gaXQgaXMgYSBGZWF0dXJlVmVjdG9yLgoKICAgIDpwYXJhbSBleHBlcmltZW50X25hbWU6ICAgICBOYW1lIG9mIGV4cGVyaW1lbnQgdG8gY3JlYXRlIGluIEF6dXJlIE1MLgogICAgOnBhcmFtIGNwdV9jbHVzdGVyX25hbWU6ICAgIE5hbWUgb2YgQXp1cmUgTUwgY29tcHV0ZSB0YXJnZXQuIENyZWF0ZWQgaWYgZG9lcyBub3QgZXhpc3QuCiAgICA6cGFyYW0gdm1fc2l6ZTogICAgICAgICAgICAgQXp1cmUgbWFjaGluZSB0eXBlIGZvciBjb21wdXRlIHRhcmdldC4KICAgIDpwYXJhbSBtYXhfbm9kZXM6ICAgICAgICAgICBNYXhpbXVtIG51bWJlciBvZiBjb25jdXJyZW50IGNvbXB1dGUgdGFyZ2V0cy4KCiAgICA6cGFyYW0gZGF0YXNldF9uYW1lOiAgICAgICAgTmFtZSBvZiBBenVyZSBkYXRhc2V0IHRvIHJlZ2lzdGVyLgogICAgOnBhcmFtIGRhdGFzZXRfZGVzY3JpcHRpb246IERlc2NyaXB0aW9uIG9mIEF6dXJlIGRhdGFzZXQgdG8gcmVnaXN0ZXIuCgogICAgOnBhcmFtIGNyZWF0ZV9uZXdfdmVyc2lvbjogIFJlZ2lzdGVyIEF6dXJlIGRhdGFzZXQgYXMgbmV3IHZlcnNpb24uIE11c3QgYmUgdXNlZCB3aGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5aW5nIGRhdGFzZXQgc2NoZW1hLgogICAgOnBhcmFtIGxhYmVsX2NvbHVtbl9uYW1lOiAgIFRhcmdldCBjb2x1bW4gaW4gZGF0YXNldC4KCiAgICA6cGFyYW0gcmVnaXN0ZXJfbW9kZWxfbmFtZTogTmFtZSBvZiBtb2RlbCB0byByZWdpc3RlciBpbiBBenVyZS4KICAgIDpwYXJhbSBzYXZlX25fbW9kZWxzOiAgICAgICBIb3cgbWFueSBvZiB0aGUgdG9wIHBlcmZvcm1pbmcgbW9kZWxzIHRvIGxvZy4KICAgIDpwYXJhbSBsb2dfYXp1cmU6ICAgICAgICAgICBEaXNwbGF5aW5nIEF6dXJlIGxvZ3MuCiAgICA6cGFyYW0gYXV0b21sX3NldHRpbmdzOiAgICAgSlNPTiBzdHJpbmcgb2YgYWxsIEF6dXJlIEF1dG9NTCBzZXR0aW5ncy4KICAgICIiIgogICAgaWYgbm90IGF1dG9tbF9zZXR0aW5nczoKICAgICAgICBhdXRvbWxfc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICJ0YXNrIjogImNsYXNzaWZpY2F0aW9uIiwKICAgICAgICAgICAgImRlYnVnX2xvZyI6ICJhdXRvbWxfZXJyb3JzLmxvZyIsCiAgICAgICAgICAgICMgImV4cGVyaW1lbnRfZXhpdF9zY29yZSI6IDAuOSwKICAgICAgICAgICAgImVuYWJsZV9lYXJseV9zdG9wcGluZyI6IEZhbHNlLAogICAgICAgICAgICAiYWxsb3dlZF9tb2RlbHMiOiBbIkxvZ2lzdGljUmVncmVzc2lvbiIsICJTR0QiLCAiU1ZNIl0sCiAgICAgICAgICAgICJpdGVyYXRpb25zIjogMywKICAgICAgICAgICAgIml0ZXJhdGlvbl90aW1lb3V0X21pbnV0ZXMiOiAyLAogICAgICAgICAgICAibWF4X2NvbmN1cnJlbnRfaXRlcmF0aW9ucyI6IDIsCiAgICAgICAgICAgICJtYXhfY29yZXNfcGVyX2l0ZXJhdGlvbiI6IC0xLAogICAgICAgICAgICAibl9jcm9zc192YWxpZGF0aW9ucyI6IDUsCiAgICAgICAgICAgICJwcmltYXJ5X21ldHJpYyI6ICJhY2N1cmFjeSIsCiAgICAgICAgICAgICJmZWF0dXJpemF0aW9uIjogIm9mZiIsCiAgICAgICAgICAgICJtb2RlbF9leHBsYWluYWJpbGl0eSI6IEZhbHNlLAogICAgICAgICAgICAiZW5hYmxlX3ZvdGluZ19lbnNlbWJsZSI6IEZhbHNlLAogICAgICAgICAgICAiZW5hYmxlX3N0YWNrX2Vuc2VtYmxlIjogRmFsc2UsCiAgICAgICAgfQoKICAgICMgSW5pdCBleHBlcmltZW50IGFuZCBjb21wdXRlCiAgICB3b3Jrc3BhY2UsIGV4cGVyaW1lbnQgPSBfaW5pdF9leHBlcmltZW50KAogICAgICAgIGNvbnRleHQ9Y29udGV4dCwgZXhwZXJpbWVudF9uYW1lPWV4cGVyaW1lbnRfbmFtZQogICAgKQoKICAgIGNvbXB1dGVfdGFyZ2V0ID0gaW5pdF9jb21wdXRlKAogICAgICAgIGNvbnRleHQ9Y29udGV4dCwKICAgICAgICBjcHVfY2x1c3Rlcl9uYW1lPWNwdV9jbHVzdGVyX25hbWUsCiAgICAgICAgdm1fc2l6ZT12bV9zaXplLAogICAgICAgIG1heF9ub2Rlcz1tYXhfbm9kZXMsCiAgICApCgogICAgIyBSZWdpc3RlciBkYXRhc2V0CiAgICByZWdpc3Rlcl9kYXRhc2V0KAogICAgICAgIGNvbnRleHQ9Y29udGV4dCwKICAgICAgICBkYXRhc2V0X25hbWU9ZGF0YXNldF9uYW1lLAogICAgICAgIGRhdGFzZXRfZGVzY3JpcHRpb249ZGF0YXNldF9kZXNjcmlwdGlvbiwKICAgICAgICBkYXRhPWRhdGFzZXQsCiAgICAgICAgY3JlYXRlX25ld192ZXJzaW9uPWNyZWF0ZV9uZXdfdmVyc2lvbiwKICAgICkKCiAgICAjIFN1Ym1pdCB0cmFpbmluZyBqb2IKICAgIHN1Ym1pdF90cmFpbmluZ19qb2IoCiAgICAgICAgY29udGV4dCwKICAgICAgICBleHBlcmltZW50PWV4cGVyaW1lbnQsCiAgICAgICAgY29tcHV0ZV90YXJnZXQ9Y29tcHV0ZV90YXJnZXQsCiAgICAgICAgcmVnaXN0ZXJfbW9kZWxfbmFtZT1yZWdpc3Rlcl9tb2RlbF9uYW1lLAogICAgICAgIHJlZ2lzdGVyZWRfZGF0YXNldF9uYW1lPWRhdGFzZXRfbmFtZSwKICAgICAgICBsYWJlbF9jb2x1bW5fbmFtZT1sYWJlbF9jb2x1bW5fbmFtZSwKICAgICAgICBhdXRvbWxfc2V0dGluZ3M9YXV0b21sX3NldHRpbmdzLAogICAgICAgIHRyYWluaW5nX3NldD1kYXRhc2V0LAogICAgICAgIHNob3dfb3V0cHV0PWxvZ19henVyZSwKICAgICAgICBzYXZlX25fbW9kZWxzPXNhdmVfbl9tb2RlbHMsCiAgICApCg==
    requirements:
    - azureml-core==1.54.0.post1
    - azureml-train-automl-client==1.54.0.post1
    - plotly~=5.23
    code_origin: ''
    commands:
    - apt-get update && apt-get install -y --no-install-recommends git
    - apt install -y liblttng-ust0
    auto_build: true
    base_image: python:3.9-bullseye
  allow_empty_resources: true
  filename: azureml_utils.py
  entry_points:
    init_compute:
      outputs:
      - doc: Azure ML Compute Target.
        type: ComputeTarget
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: cpu_cluster_name
        type: str
        doc: Name of Azure ML compute target. Created if does not exist.
      - name: vm_size
        type: str
        doc: Azure machine type for compute target.
        default: STANDARD_D2_V2
      - name: max_nodes
        type: int
        doc: Maximum number of concurrent compute targets.
        default: 1
      name: init_compute
      doc: 'Initialize Azure ML compute target to run experiment. Checks for

        existing compute target and creates new if does not exist.'
      has_kwargs: false
      has_varargs: false
      lineno: 99
    register_dataset:
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: dataset_name
        type: str
        doc: Name of Azure dataset to register.
      - name: dataset_description
        type: str
        doc: Description of Azure dataset to register.
      - name: data
        type: DataItem
        doc: MLRun FeatureVector or dataset object to upload.
      - name: create_new_version
        type: bool
        doc: Register Azure dataset as new version. Must be used when modifying dataset
          schema.
        default: false
      name: register_dataset
      doc: 'Register dataset object (can be also an Iguazio FeatureVector) in Azure
        ML.

        Uploads parquet file to Azure blob storage and registers

        that file as a dataset in Azure ML.'
      has_kwargs: false
      has_varargs: false
      lineno: 135
    download_model:
      outputs:
      - type: None
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: model_name
        type: str
        doc: Name of trained and registered model.
      - name: model_version
        type: int
        doc: Version of model to download.
      - name: target_dir
        type: str
        doc: Target directory to download model.
        default: .
      name: download_model
      doc: Download trained model from Azure ML to local filesystem.
      has_kwargs: false
      has_varargs: false
      lineno: 216
    upload_model:
      outputs:
      - type: None
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: model_name
        type: str
        doc: Name of trained and registered model.
      - name: model_path
        type: str
        doc: Path to file on local filesystem.
      - name: model_description
        type: str
        doc: Description of models.
        default: null
      - name: model_tags
        type: dict
        doc: KV pairs of model tags.
        default: null
      name: upload_model
      doc: Upload pre-trained model from local filesystem to Azure ML.
      has_kwargs: false
      has_varargs: false
      lineno: 237
    submit_training_job:
      outputs:
      - type: None
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: experiment
        type: Experiment
        doc: Azure experiment.
      - name: compute_target
        type: ComputeTarget
        doc: Azure compute target.
      - name: register_model_name
        type: str
        doc: Name of model to register in Azure.
      - name: registered_dataset_name
        type: str
        doc: Name of dataset registered in Azure ML.
      - name: automl_settings
        type: dict
        doc: JSON string of all Azure AutoML settings.
      - name: training_set
        type: DataItem
        doc: Training set to log with model. For model monitoring integration.
      - name: label_column_name
        type: str
        doc: Name of target column in dataset.
        default: ''
      - name: save_n_models
        type: int
        doc: How many of the top performing models to log.
        default: 3
      - name: show_output
        type: bool
        doc: Displaying Azure logs.
        default: true
      name: submit_training_job
      doc: 'Submit training job to Azure AutoML and download trained model

        when completed. Uses previously registered dataset for training.'
      has_kwargs: false
      has_varargs: false
      lineno: 350
    train:
      outputs:
      - type: None
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
      - name: dataset
        type: DataItem
        doc: MLRun FeatureVector or dataset URI to upload. Will drop index before
          uploading when it is a FeatureVector.
      - name: experiment_name
        type: str
        doc: Name of experiment to create in Azure ML.
        default: ''
      - name: cpu_cluster_name
        type: str
        doc: Name of Azure ML compute target. Created if does not exist.
        default: ''
      - name: vm_size
        type: str
        doc: Azure machine type for compute target.
        default: STANDARD_D2_V2
      - name: max_nodes
        type: int
        doc: Maximum number of concurrent compute targets.
        default: 1
      - name: dataset_name
        type: str
        doc: Name of Azure dataset to register.
        default: ''
      - name: dataset_description
        type: str
        doc: Description of Azure dataset to register.
        default: ''
      - name: create_new_version
        type: bool
        doc: Register Azure dataset as new version. Must be used when modifying dataset
          schema.
        default: false
      - name: label_column_name
        type: str
        doc: Target column in dataset.
        default: ''
      - name: register_model_name
        type: str
        doc: Name of model to register in Azure.
        default: ''
      - name: save_n_models
        type: int
        doc: How many of the top performing models to log.
        default: 1
      - name: log_azure
        type: bool
        doc: Displaying Azure logs.
        default: true
      - name: automl_settings
        type: str
        doc: JSON string of all Azure AutoML settings.
        default: null
      name: train
      doc: 'Whole training flow for Azure AutoML. Registers dataset/feature vector,

        submits training job to Azure AutoML, and downloads trained model

        when completed.'
      has_kwargs: false
      has_varargs: false
      lineno: 465
  command: ''
  description: Azure AutoML integration in MLRun, including utils functions for training
    models on Azure AutoML platfrom.
  default_handler: train
