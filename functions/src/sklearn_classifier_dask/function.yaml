spec:
  description: train any classifier using scikit-learn's API over Dask
  build:
    origin_filename: ''
    code_origin: ''
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKIyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG1scnVuCgppbXBvcnQgd2FybmluZ3MKCndhcm5pbmdzLmZpbHRlcndhcm5pbmdzKCJpZ25vcmUiKQoKaW1wb3J0IGpvYmxpYgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcwoKZnJvbSBkYXNrIGltcG9ydCBkYXRhZnJhbWUgYXMgZGQKZnJvbSBkYXNrLmRlbGF5ZWQgaW1wb3J0IGRlbGF5ZWQKZnJvbSBkYXNrX21sIGltcG9ydCBtb2RlbF9zZWxlY3Rpb24KZnJvbSBkYXNrX21sLnByZXByb2Nlc3NpbmcgaW1wb3J0IFN0YW5kYXJkU2NhbGVyLCBMYWJlbEVuY29kZXIKCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QKZnJvbSBtbHJ1bi5tbHV0aWxzLm1vZGVscyBpbXBvcnQgZ2VuX3NrbGVhcm5fbW9kZWwKZnJvbSBtbHJ1bi51dGlscy5oZWxwZXJzIGltcG9ydCBjcmVhdGVfY2xhc3MKCmltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKZnJvbSB5ZWxsb3dicmljay5jbGFzc2lmaWVyIGltcG9ydCBST0NBVUMsIENsYXNzaWZpY2F0aW9uUmVwb3J0LCBDb25mdXNpb25NYXRyaXgKZnJvbSB5ZWxsb3dicmljay5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IEZlYXR1cmVJbXBvcnRhbmNlcwoKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgZGF0YXNldDogbWxydW4uRGF0YUl0ZW0sCiAgICBtb2RlbF9wa2dfY2xhc3M6IHN0ciwKICAgIGxhYmVsX2NvbHVtbjogc3RyID0gImxhYmVsIiwKICAgIHRyYWluX3ZhbGlkYXRpb25fc2l6ZTogZmxvYXQgPSAwLjc1LAogICAgc2FtcGxlOiBmbG9hdCA9IDEuMCwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAibW9kZWxzIiwKICAgIHRlc3Rfc2V0X2tleTogc3RyID0gInRlc3Rfc2V0IiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBkYXNrX2Z1bmN0aW9uOiBzdHIgPSBOb25lLAogICAgZGFza19jbGllbnQ9Tm9uZSwKICAgIGZpbGVfZXh0OiBzdHIgPSAicGFycXVldCIsCiAgICByYW5kb21fc3RhdGU6IGludCA9IDQyLAopIC0+IE5vbmU6CgogICAgIiIiCiAgICBUcmFpbiBhIHNrbGVhcm4gY2xhc3NpZmllciB3aXRoIERhc2sKCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgICAgIEZ1bmN0aW9uIGNvbnRleHQuCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgICAgICAgICAgIFJhdyBkYXRhIGZpbGUuCiAgICA6cGFyYW0gbW9kZWxfcGtnX2NsYXNzOiAgICAgICAgIE1vZGVsIHRvIHRyYWluLCBlLmcsICJza2xlYXJuLmVuc2VtYmxlLlJhbmRvbUZvcmVzdENsYXNzaWZpZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBqc29uIG1vZGVsIGNvbmZpZy4KICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgICAgICAgKGxhYmVsKSBHcm91bmQtdHJ1dGggeSBsYWJlbHMuCiAgICA6cGFyYW0gdHJhaW5fdmFsaWRhdGlvbl9zaXplOiAgICgwLjc1KSBUcmFpbiB2YWxpZGF0aW9uIHNldCBwcm9wb3J0aW9uIG91dCBvZiB0aGUgZnVsbCBkYXRhc2V0LgogICAgOnBhcmFtIHNhbXBsZTogICAgICAgICAgICAgICAgICAoMS4wKSBTZWxlY3Qgc2FtcGxlIGZyb20gZGF0YXNldCAobi1yb3dzLyUgb2YgdG90YWwpLCByYW5kb216aWUgcm93cyBhcyBkZWZhdWx0LgogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICAgICAgICAobW9kZWxzKSBNb2RlbHMgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGguCiAgICA6cGFyYW0gdGVzdF9zZXRfa2V5OiAgICAgICAgICAgICh0ZXN0X3NldCkgTWxydW4gZGIga2V5IG9mIGhlbGQgb3V0IGRhdGEgaW4gYXJ0aWZhY3Qgc3RvcmUuCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgICAgICAgIChwbG90cykgUGxvdCBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aC4KICAgIDpwYXJhbSBkYXNrX2Z1bmN0aW9uOiAgICAgICAgICAgZGFzayBmdW5jdGlvbiB1cmwgKGRiOi8vLi4pCiAgICA6cGFyYW0gZGFza19jbGllbnQ6ICAgICAgICAgICAgIGRhc2sgY2xpZW50IG9iamVjdAogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICAgICAgICAocGFycXVldCkgZm9ybWF0IGZvciB0ZXN0X3NldF9rZXkgaG9sZCBvdXQgZGF0YQogICAgOnBhcmFtIHJhbmRvbV9zdGF0ZTogICAgICAgICAgICAoNDIpIHNrbGVhcm4gc2VlZAogICAgIiIiCiAgICBpZiBkYXNrX2Z1bmN0aW9uOgogICAgICAgIGNsaWVudCA9IG1scnVuLmltcG9ydF9mdW5jdGlvbihkYXNrX2Z1bmN0aW9uKS5jbGllbnQKICAgIGVsaWYgZGFza19jbGllbnQ6CiAgICAgICAgY2xpZW50ID0gZGFza19jbGllbnQKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiZGFzayBjbGllbnQgd2FzIG5vdCBwcm92aWRlZCIpCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiUmVhZCBEYXRhIikKICAgIGRmID0gZGF0YXNldC5hc19kZihkZl9tb2R1bGU9ZGQpCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiUHJlcCBEYXRhIikKICAgIG51bWVyaWNzID0gWyJpbnQxNiIsICJpbnQzMiIsICJpbnQ2NCIsICJmbG9hdDE2IiwgImZsb2F0MzIiLCAiZmxvYXQ2NCJdCiAgICBkZiA9IGRmLnNlbGVjdF9kdHlwZXMoaW5jbHVkZT1udW1lcmljcykKCiAgICBpZiBkZi5pc25hKCkuYW55KCkuYW55KCkuY29tcHV0ZSgpID09IFRydWU6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJOQXMgdmFsdXMgZm91bmQiKQoKICAgIGRmX2hlYWRlciA9IGRmLmNvbHVtbnMKCiAgICBkZiA9IGRmLnNhbXBsZShmcmFjPXNhbXBsZSkucmVzZXRfaW5kZXgoZHJvcD1UcnVlKQogICAgZW5jb2RlciA9IExhYmVsRW5jb2RlcigpCiAgICBlbmNvZGVyID0gZW5jb2Rlci5maXQoZGZbbGFiZWxfY29sdW1uXSkKICAgIFggPSBkZi5kcm9wKGxhYmVsX2NvbHVtbiwgYXhpcz0xKS50b19kYXNrX2FycmF5KGxlbmd0aHM9VHJ1ZSkKICAgIHkgPSBlbmNvZGVyLnRyYW5zZm9ybShkZltsYWJlbF9jb2x1bW5dKQoKICAgIGNsYXNzZXMgPSBkZltsYWJlbF9jb2x1bW5dLmRyb3BfZHVwbGljYXRlcygpICAjIG5vIHVuaXF1ZSB2YWx1ZXMgaW4gZGFzawogICAgY2xhc3NlcyA9IFtzdHIoaSkgZm9yIGkgaW4gY2xhc3Nlc10KCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJTcGxpdCBhbmQgVHJhaW4iKQogICAgWF90cmFpbiwgWF90ZXN0LCB5X3RyYWluLCB5X3Rlc3QgPSBtb2RlbF9zZWxlY3Rpb24udHJhaW5fdGVzdF9zcGxpdCgKICAgICAgICBYLCB5LCB0cmFpbl9zaXplPXRyYWluX3ZhbGlkYXRpb25fc2l6ZSwgcmFuZG9tX3N0YXRlPXJhbmRvbV9zdGF0ZQogICAgKQoKICAgIHNjYWxlciA9IFN0YW5kYXJkU2NhbGVyKCkKICAgIHNjYWxlciA9IHNjYWxlci5maXQoWF90cmFpbikKICAgIFhfdHJhaW5fdHJhbnNmb3JtZWQgPSBzY2FsZXIudHJhbnNmb3JtKFhfdHJhaW4pCiAgICBYX3Rlc3RfdHJhbnNmb3JtZWQgPSBzY2FsZXIudHJhbnNmb3JtKFhfdGVzdCkKCiAgICBtb2RlbF9jb25maWcgPSBnZW5fc2tsZWFybl9tb2RlbChtb2RlbF9wa2dfY2xhc3MsIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpKQoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IFhfdHJhaW5fdHJhbnNmb3JtZWQsICJ5IjogeV90cmFpbn0pCgogICAgQ2xhc3NpZmllckNsYXNzID0gY3JlYXRlX2NsYXNzKG1vZGVsX2NvbmZpZ1siTUVUQSJdWyJjbGFzcyJdKQoKICAgIG1vZGVsID0gQ2xhc3NpZmllckNsYXNzKCoqbW9kZWxfY29uZmlnWyJDTEFTUyJdKQoKICAgIHdpdGggam9ibGliLnBhcmFsbGVsX2JhY2tlbmQoImRhc2siKToKICAgICAgICBtb2RlbCA9IG1vZGVsLmZpdCgqKm1vZGVsX2NvbmZpZ1siRklUIl0pCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiRXZhbHVhdGUiKQogICAgZXh0cmFfZGF0YV9kaWN0ID0ge30KICAgIGZvciByZXBvcnQgaW4gKFJPQ0FVQywgQ2xhc3NpZmljYXRpb25SZXBvcnQsIENvbmZ1c2lvbk1hdHJpeCk6CiAgICAgICAgcmVwb3J0X25hbWUgPSBzdHIocmVwb3J0Ll9fbmFtZV9fKQogICAgICAgIHBsdC5jbGEoKQogICAgICAgIHBsdC5jbGYoKQogICAgICAgIHBsdC5jbG9zZSgpCgogICAgICAgIHZpeiA9IHJlcG9ydChtb2RlbCwgY2xhc3Nlcz1jbGFzc2VzLCBwZXJfY2xhc3M9VHJ1ZSwgaXNfZml0dGVkPVRydWUpCiAgICAgICAgdml6LmZpdChYX3RyYWluX3RyYW5zZm9ybWVkLCB5X3RyYWluKSAgIyBGaXQgdGhlIHRyYWluaW5nIGRhdGEgdG8gdGhlIHZpc3VhbGl6ZXIKICAgICAgICB2aXouc2NvcmUoCiAgICAgICAgICAgIFhfdGVzdF90cmFuc2Zvcm1lZCwgeV90ZXN0LmNvbXB1dGUoKQogICAgICAgICkgICMgRXZhbHVhdGUgdGhlIG1vZGVsIG9uIHRoZSB0ZXN0IGRhdGEKCiAgICAgICAgcGxvdCA9IGNvbnRleHQubG9nX2FydGlmYWN0KAogICAgICAgICAgICBQbG90QXJ0aWZhY3QocmVwb3J0X25hbWUsIGJvZHk9dml6LmZpZywgdGl0bGU9cmVwb3J0X25hbWUpLCBkYl9rZXk9RmFsc2UKICAgICAgICApCiAgICAgICAgZXh0cmFfZGF0YV9kaWN0W3N0cihyZXBvcnQpXSA9IHBsb3QKCiAgICAgICAgaWYgcmVwb3J0X25hbWUgPT0gIlJPQ0FVQyI6CiAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdHMoCiAgICAgICAgICAgICAgICB7Im1pY3JvIjogdml6LnJvY19hdWMuZ2V0KCJtaWNybyIpLCAibWFjcm8iOiB2aXoucm9jX2F1Yy5nZXQoIm1hY3JvIil9CiAgICAgICAgICAgICkKCiAgICAgICAgZWxpZiByZXBvcnRfbmFtZSA9PSAiQ2xhc3NpZmljYXRpb25SZXBvcnQiOgogICAgICAgICAgICBmb3Igc2NvcmVfbmFtZSBpbiB2aXouc2NvcmVzXzoKICAgICAgICAgICAgICAgIGZvciBzY29yZV9jbGFzcyBpbiB2aXouc2NvcmVzX1tzY29yZV9uYW1lXToKCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0cygKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVfbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAiLSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgc2NvcmVfY2xhc3M6IHZpei5zY29yZXNfW3Njb3JlX25hbWVdLmdldChzY29yZV9jbGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICkKCiAgICB2aXogPSBGZWF0dXJlSW1wb3J0YW5jZXMoCiAgICAgICAgbW9kZWwsCiAgICAgICAgY2xhc3Nlcz1jbGFzc2VzLAogICAgICAgIHBlcl9jbGFzcz1UcnVlLAogICAgICAgIGlzX2ZpdHRlZD1UcnVlLAogICAgICAgIGxhYmVscz1kZl9oZWFkZXIuZGVsZXRlKGRmX2hlYWRlci5nZXRfbG9jKGxhYmVsX2NvbHVtbikpLAogICAgKQogICAgdml6LmZpdChYX3RyYWluX3RyYW5zZm9ybWVkLCB5X3RyYWluKQogICAgdml6LnNjb3JlKFhfdGVzdF90cmFuc2Zvcm1lZCwgeV90ZXN0KQoKICAgIHBsb3QgPSBjb250ZXh0LmxvZ19hcnRpZmFjdCgKICAgICAgICBQbG90QXJ0aWZhY3QoIkZlYXR1cmVJbXBvcnRhbmNlcyIsIGJvZHk9dml6LmZpZywgdGl0bGU9IkZlYXR1cmVJbXBvcnRhbmNlcyIpLAogICAgICAgIGRiX2tleT1GYWxzZSwKICAgICkKICAgIGV4dHJhX2RhdGFfZGljdFsiRmVhdHVyZUltcG9ydGFuY2VzIl0gPSBwbG90CgogICAgcGx0LmNsYSgpCiAgICBwbHQuY2xmKCkKICAgIHBsdC5jbG9zZSgpCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiTG9nIGFydGlmYWN0cyIpCiAgICBhcnRpZmFjdF9wYXRoID0gY29udGV4dC5hcnRpZmFjdF9zdWJwYXRoKG1vZGVsc19kZXN0KQoKICAgIGNvbnRleHQuc2V0X2xhYmVsKCJjbGFzcyIsIG1vZGVsX3BrZ19jbGFzcykKCiAgICBjb250ZXh0LmxvZ19tb2RlbCgKICAgICAgICAibW9kZWwiLAogICAgICAgIGJvZHk9ZHVtcHMobW9kZWwpLAogICAgICAgIGFydGlmYWN0X3BhdGg9YXJ0aWZhY3RfcGF0aCwKICAgICAgICBtb2RlbF9maWxlPSJtb2RlbC5wa2wiLAogICAgICAgIGV4dHJhX2RhdGE9ZXh0cmFfZGF0YV9kaWN0LAogICAgICAgIG1ldHJpY3M9Y29udGV4dC5yZXN1bHRzLAogICAgICAgIGxhYmVscz17ImNsYXNzIjogbW9kZWxfcGtnX2NsYXNzfSwKICAgICkKCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgKICAgICAgICAic3RhbmRhcmRfc2NhbGVyIiwKICAgICAgICBib2R5PWR1bXBzKHNjYWxlciksCiAgICAgICAgYXJ0aWZhY3RfcGF0aD1hcnRpZmFjdF9wYXRoLAogICAgKQoKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KAogICAgICAgICJsYWJlbF9lbmNvZGVyIiwKICAgICAgICBib2R5PWR1bXBzKGVuY29kZXIpLAogICAgICAgIGFydGlmYWN0X3BhdGg9YXJ0aWZhY3RfcGF0aCwKICAgICkKCiAgICBkZl90b19zYXZlID0gZGVsYXllZChucC5jb2x1bW5fc3RhY2spKChYX3Rlc3QsIHlfdGVzdCkpLmNvbXB1dGUoKQogICAgY29udGV4dC5sb2dfZGF0YXNldCgKICAgICAgICB0ZXN0X3NldF9rZXksCiAgICAgICAgZGY9cGQuRGF0YUZyYW1lKGRmX3RvX3NhdmUsIGNvbHVtbnM9ZGZfaGVhZGVyKSwgICMgaW1wcm92ZSBsb2cgZGF0YXNldCBhYmlsaXR5CiAgICAgICAgZm9ybWF0PWZpbGVfZXh0LAogICAgICAgIGluZGV4PUZhbHNlLAogICAgICAgIGxhYmVscz17ImRhdGEtdHlwZSI6ICJoZWxkLW91dCJ9LAogICAgICAgIGFydGlmYWN0X3BhdGg9Y29udGV4dC5hcnRpZmFjdF9zdWJwYXRoKCJkYXRhIiksCiAgICApCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygiRG9uZSEiKQo=
  command: ''
  entry_points:
    train_model:
      doc: Train a sklearn classifier with Dask
      has_varargs: false
      name: train_model
      lineno: 42
      has_kwargs: false
      outputs:
      - type: None
      parameters:
      - name: context
        type: MLClientCtx
        doc: Function context.
      - name: dataset
        type: DataItem
        doc: Raw data file.
      - name: model_pkg_class
        type: str
        doc: Model to train, e.g, "sklearn.ensemble.RandomForestClassifier", or json
          model config.
      - name: label_column
        type: str
        doc: (label) Ground-truth y labels.
        default: label
      - name: train_validation_size
        type: float
        doc: (0.75) Train validation set proportion out of the full dataset.
        default: 0.75
      - name: sample
        type: float
        doc: (1.0) Select sample from dataset (n-rows/% of total), randomzie rows
          as default.
        default: 1.0
      - name: models_dest
        type: str
        doc: (models) Models subfolder on artifact path.
        default: models
      - name: test_set_key
        type: str
        doc: (test_set) Mlrun db key of held out data in artifact store.
        default: test_set
      - name: plots_dest
        type: str
        doc: (plots) Plot subfolder on artifact path.
        default: plots
      - name: dask_function
        type: str
        doc: dask function url (db://..)
        default: null
      - name: dask_client
        doc: dask client object
        default: null
      - name: file_ext
        type: str
        doc: (parquet) format for test_set_key hold out data
        default: parquet
      - name: random_state
        type: int
        doc: (42) sklearn seed
        default: 42
  image: mlrun/ml-models
  disable_auto_mount: false
  default_handler: train_model
verbose: false
metadata:
  name: sklearn-classifier-dask
  tag: ''
  categories:
  - machine-learning
  - model-training
kind: job
