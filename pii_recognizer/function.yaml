kind: job
metadata:
  name: pii-recognizer
  tag: ''
  hash: 6572c52742ff959c5b949b0c984a24f1715b08f1
  project: ''
  labels:
    author: pgw
  categories:
  - machine-learning
  - data-preparation
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCmltcG9ydCB3YXJuaW5ncwppbXBvcnQgb3MKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG1scnVuCmltcG9ydCBwYXRobGliCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgbmx0awpmcm9tIHRxZG0uYXV0byBpbXBvcnQgdHFkbQpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgVHVwbGUsIFNldCwgT3B0aW9uYWwsIERpY3QsIEFueSwgVW5pb24KZnJvbSBjb2xsZWN0aW9ucy5hYmMgaW1wb3J0IEl0ZXJhYmxlCmltcG9ydCBwcmVzaWRpb19hbmFseXplciBhcyBwYQppbXBvcnQgcHJlc2lkaW9fYW5vbnltaXplciBhcyBwcmVfYW5veW1pemVyCmZyb20gcHJlc2lkaW9fYW5vbnltaXplci5lbnRpdGllcyBpbXBvcnQgT3BlcmF0b3JDb25maWcKaW1wb3J0IGFubm90YXRlZF90ZXh0LnV0aWwgYXMgYXRfdXRpbAoKdHJ5OgogICAgaW1wb3J0IGZsYWlyIGFzIGZsCmV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yOgogICAgcHJpbnQoIkZsYWlyIGlzIG5vdCBpbnN0YWxsZWQiKQoKIyBUaGVyZSBpcyBhIGNvbmZsaWN0IGJldHdlZW4gUnVzdC1iYXNlZCB0b2tlbml6ZXJzJyBwYXJhbGxlbCBwcm9jZXNzaW5nCiMgYW5kIFB5dGhvbidzIGZvcmsgb3BlcmF0aW9ucyBkdXJpbmcgbXVsdGlwcm9jZXNzaW5nLiBUbyBhdm9pZCB0aGlzLCB3ZSBuZWVkCiMgdGhlIGZvbGxvd2luZyB0d28gbGluZXMKCm9zLmVudmlyb25bIlRPS0VOSVpFUlNfUEFSQUxMRUxJU00iXSA9ICJmYWxzZSIKd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoImlnbm9yZSIpCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcigicGlpLXJlY29nbml6ZXIiKQoKCiMgQWRkIHRoZSBjb25zdGFudCBjbGFzc2VzIG9mIE1vZGVscyBhbmQgRW50aXRpZXMgdG8gZ292ZXJuIHRoZSB3aG9sZSBwYWNrYWdlCmNsYXNzIE1vZGVsczoKICAgIFdIT0xFID0gIndob2xlIgogICAgUEFUVEVSTiA9ICJwYXR0ZXJuIgogICAgU1BBQ1kgPSAic3BhY3kiCiAgICBGTEFJUiA9ICJmbGFpciIKCgpjbGFzcyBFbnRpdGllczoKICAgIENSRURJVF9DQVJEID0gIkNSRURJVF9DQVJEIgogICAgU1NOID0gIlNTTiIKICAgIFBIT05FID0gIlBIT05FIgogICAgRU1BSUwgPSAiRU1BSUwiCiAgICBMT0NBVElPTiA9ICJMT0NBVElPTiIKICAgIFBFUlNPTiA9ICJQRVJTT04iCiAgICBOUlAgPSAiTlJQIgogICAgT1JHQU5JWkFUSU9OID0gIk9SR0FOSVpBVElPTiIKICAgIERBVEVfVElNRSA9ICJEQVRFX1RJTUUiCiAgICBHUEUgPSAoIkdQRSIsKQogICAgTUFDX0FERFJFU1MgPSAiTUFDX0FERFJFU1MiCiAgICBVU19CQU5LX05VTUJFUiA9ICJVU19CQU5LX05VTUJFUiIKICAgIElNRUkgPSAiSU1FSSIKICAgIFRJVExFID0gIlRJVExFIgogICAgTElDRU5TRV9QTEFURSA9ICJMSUNFTlNFX1BMQVRFIgogICAgVVNfUEFTU1BPUlQgPSAiVVNfUEFTU1BPUlQiCiAgICBDVVJSRU5DWSA9ICJDVVJSRU5DWSIKICAgIFJPVVRJTkdfTlVNQkVSID0gIlJPVVRJTkdfTlVNQkVSIgogICAgVVNfSVRJTiA9ICJVU19JVElOIgogICAgVVNfQkFOS19OVU1CRVIgPSAiVVNfQkFOS19OVU1CRVIiCiAgICBVU19EUklWRVJfTElDRU5TRSA9ICJVU19EUklWRVJfTElDRU5TRSIKICAgIEFHRSA9ICJBR0UiCiAgICBQQVNTV09SRCA9ICJQQVNTV09SRCIKICAgIFNXSUZUX0NPREUgPSAiU1dJRlRfQ09ERSIKCgpjbGFzcyBQYXR0ZXJuUmVjb2duaXplckZhY3Rvcnk6CiAgICAiIiIKICAgIEZhY3RvcnkgZm9yIGNyZWF0aW5nIHBhdHRlcm4gcmVjb2duaXplcnMsIGl0IGNhbiBiZSBleHRlbmRlZCBpbiB0aGUgZnV0dXJlIHRvCiAgICBhZGQgbW9yZSByZWdleCBwYXR0ZXJuIGZvciBkaWZmZXJlbnQgZW50aXRpZXMuIEZvciB0aGUgcGF0dGVybiByZWNvZ25pemVyIHRvIHdvcmssCiAgICB3ZSBuZWVkIGNvbnN0cnVjdCBhIGxpc3Qgb2YgcmVnZXggcGF0dGVybnMgZm9yIGVhY2ggZW50aXR5LgogICAgIiIiCgogICAgUkVDT0dOSVpBQkxFX0VOVElUSUVTID0gewogICAgICAgICJDUkVESVRfQ0FSRCI6IFtwYS5QYXR0ZXJuKCJDUkVESVRfQ0FSRCIsIHIiXGIoPzpcZFsgLV0qPyl7MTMsMTZ9XGIiLCAwLjUpXSwKICAgICAgICAiU1NOIjogW3BhLlBhdHRlcm4oIlNTTiIsIHIiXGJcZHszfS0/XGR7Mn0tP1xkezR9XGIiLCAwLjUpXSwKICAgICAgICAiUEhPTkUiOiBbcGEuUGF0dGVybigiUEhPTkUiLCByIlwoP1xkezN9XCk/Wy0uXHNdP1xkezN9Wy0uXHNdP1xkezR9IiwgMC41KV0sCiAgICAgICAgIkVNQUlMIjogW3BhLlBhdHRlcm4oIkVNQUlMIiwgciJcUytAXFMrIiwgMC41KV0sCiAgICB9CgogICAgIyBjcmVhdGUgYSBsaXN0IG9mIHBhdHRlcm4gcmVjb2duaXplcnMKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIF9jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKGNscyk6CiAgICAgICAgIiIiCiAgICAgICAgRm9yIGVhY2ggZW50aXR5LCBjcmVhdGUgYSBsaXN0IG9mIHBhdHRlcm5zIHRvIHJlY29nbml6ZSBpdAoKICAgICAgICA6cGFyYW0gY2xzOiBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkgY2xhc3MKCiAgICAgICAgOnJldHVybnM6IExpc3Qgb2YgcGF0dGVybiByZWNvZ25pemVycwogICAgICAgICIiIgoKICAgICAgICAjIEVudGl0aWVzIHRvIHJlY29nbml6ZSBhbmQgdGhlaXIgcmVnZXggcGF0dGVybnMKCiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgcGEuUGF0dGVyblJlY29nbml6ZXIoc3VwcG9ydGVkX2VudGl0eT1lbnRpdHksIHBhdHRlcm5zPXBhdHRlcm4pCiAgICAgICAgICAgIGZvciBlbnRpdHksIHBhdHRlcm4gaW4gY2xzLlJFQ09HTklaQUJMRV9FTlRJVElFUy5pdGVtcygpCiAgICAgICAgXQoKCmNsYXNzIEN1c3RvbVNwYWN5UmVjb2duaXplcihwYS5Mb2NhbFJlY29nbml6ZXIpOgogICAgIiIiCiAgICBDdXN0b20gU3BhY3kgUmVjb2duaXplciBmcm9tIFByZXNpZGlvIEFuYWx5emVyIHRyYWluZWQgb24gUHJpdnkgZGF0YS4KICAgIFRoZSBwcml2eSBkYXRhIGlzIGdlbmVyYXRlZCB1c2luZyB0aGlzIGh0dHBzOi8vZ2l0aHViLmNvbS9waXhpZS1pby9waXhpZS90cmVlL21haW4vc3JjL2RhdGFnZW4vcGlpL3ByaXZ5CiAgICBJdCBjYW4gYmUgdXNlZCB0byByZWNvZ25pemUgY3VzdG9tIGVudGl0aWVzLCBTaW5jZSB3ZSB3YW50IHRvIHVzZSBQcmVzaWRpbydzIFJlZ2lzdHJpZXMgdG8gZ2VuZXJhdGUgQW5hbHl6ZXJFbmdpbmUsCiAgICBpdCBpbmhlcml0cyBmcm9tIFByZXNpZGlvIEFuYWx5emVyJ3MgTG9jYWxSZWNvZ25pemVyIGNsYXNzLgogICAgIiIiCgogICAgIyBFbnRpdGllcyB0byByZWNvZ25pemUKCiAgICBSRUNPR05JWkFCTEVfRU5USVRJRVMgPSB7CiAgICAgICAgIkxPQ0FUSU9OIiwKICAgICAgICAiUEVSU09OIiwKICAgICAgICAiTlJQIiwKICAgICAgICAiT1JHQU5JWkFUSU9OIiwKICAgICAgICAiREFURV9USU1FIiwKICAgIH0KCiAgICAjIERlZmF1bHQgZXhwbGFuYXRpb24gZm9yIHRoaXMgcmVjb2duaXplcgoKICAgIF9ERUZBVUxUX0VYUExBTkFUSU9OID0gKAogICAgICAgICJJZGVudGlmaWVkIGFzIHt9IGJ5IFNwYWN5J3MgTmFtZWQgRW50aXR5IFJlY29nbml0aW9uIChQcml2eS10cmFpbmVkKSIKICAgICkKCiAgICAjIExhYmVsIGdyb3VwcyB0byBjaGVjawoKICAgIF9ERUZBVUxUX0NIRUNLX0xBQkVMX0dST1VQUyA9IFsKICAgICAgICAoeyJMT0NBVElPTiJ9LCB7IkxPQyIsICJMT0NBVElPTiIsICJTVFJFRVRfQUREUkVTUyIsICJDT09SRElOQVRFIn0pLAogICAgICAgICh7IlBFUlNPTiJ9LCB7IlBFUiIsICJQRVJTT04ifSksCiAgICAgICAgKHsiTlJQIn0sIHsiTk9SUCIsICJOUlAifSksCiAgICAgICAgKHsiT1JHQU5JWkFUSU9OIn0sIHsiT1JHIn0pLAogICAgICAgICh7IkRBVEVfVElNRSJ9LCB7IkRBVEVfVElNRSJ9KSwKICAgIF0KCiAgICAjIHByZXRyYWluZWQgbW9kZWwgZm9yIHRoaXMgcmVjb2duaXplcgoKICAgIF9ERUZBVUxUX01PREVMX0xBTkdVQUdFUyA9IHsKICAgICAgICAiZW4iOiAiYmVraS9lbl9zcGFjeV9waWlfZGlzdGlsYmVydCIsCiAgICB9CgogICAgX0RFRkFVTFRfUFJFU0lESU9fRVFVSVZBTEVOQ0VTID0gewogICAgICAgICJQRVIiOiAiUEVSU09OIiwKICAgICAgICAiTE9DIjogIkxPQ0FUSU9OIiwKICAgICAgICAiT1JHIjogIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIk5ST1AiOiAiTlJQIiwKICAgICAgICAiREFURV9USU1FIjogIkRBVEVfVElNRSIsCiAgICB9CgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlOiBzdHIgPSAiZW4iLAogICAgICAgIHN1cHBvcnRlZF9lbnRpdGllczogTGlzdFtzdHJdID0gTm9uZSwKICAgICAgICBjaGVja19sYWJlbF9ncm91cHM6IFR1cGxlW1NldCwgU2V0XSA9IE5vbmUsCiAgICAgICAgY29udGV4dDogTGlzdFtzdHJdID0gTm9uZSwKICAgICAgICBuZXJfc3RyZW5ndGg6IGZsb2F0ID0gMSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgSW5pdGlhbGl6ZSBTcGFjeSBSZWNvZ25pemVyLgoKICAgICAgICA6cGFyYW0gc3VwcG9ydGVkX2xhbmd1YWdlOiBMYW5ndWFnZSB0byB1c2UsIGRlZmF1bHQgaXMgRW5nbGlzaAogICAgICAgIDpwYXJhbSBzdXBwb3J0ZWRfZW50aXRpZXM6IEVudGl0aWVzIHRvIHVzZSBmb3IgcmVjb2duaXRpb24KICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sgZm9yIHRoZSBlbnRpdGllcwogICAgICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgIENvbnRleHQgdG8gdXNlIGlmIGFueQogICAgICAgIDpwYXJhbSBuZXJfc3RyZW5ndGg6ICAgICAgIERlZmF1bHQgY29uZmlkZW5jZSBmb3IgTkVSIHByZWRpY3Rpb24KCiAgICAgICAgOnJldHVybnM6IFNwYWN5UmVjb2duaXplciBvYmplY3QKICAgICAgICAiIiIKCiAgICAgICAgIyBEZWZhdWx0IGNvbmZpZGVuY2UgZm9yIE5FUiBwcmVkaWN0aW9uCiAgICAgICAgc2VsZi5uZXJfc3RyZW5ndGggPSBuZXJfc3RyZW5ndGgKCiAgICAgICAgc2VsZi5jaGVja19sYWJlbF9ncm91cHMgPSBjaGVja19sYWJlbF9ncm91cHMgb3Igc2VsZi5fREVGQVVMVF9DSEVDS19MQUJFTF9HUk9VUFMKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXMgPSBzdXBwb3J0ZWRfZW50aXRpZXMgb3Igc2VsZi5SRUNPR05JWkFCTEVfRU5USVRJRVMKICAgICAgICBzdXBlcigpLl9faW5pdF9fKAogICAgICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM9c3VwcG9ydGVkX2VudGl0aWVzLAogICAgICAgICAgICBzdXBwb3J0ZWRfbGFuZ3VhZ2U9c3VwcG9ydGVkX2xhbmd1YWdlLAogICAgICAgICkKCiAgICAjIGdldCB0aGUgcHJlc2lkaW8gZXhwbGFuYXRpb24gZm9yIHRoZSByZXN1bHQKCiAgICBkZWYgX2J1aWxkX3NwYWN5X2V4cGxhbmF0aW9uKAogICAgICAgIHNlbGYsIG9yaWdpbmFsX3Njb3JlOiBmbG9hdCwgZXhwbGFuYXRpb246IHN0cgogICAgKSAtPiBwYS5BbmFseXNpc0V4cGxhbmF0aW9uOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZSBleHBsYW5hdGlvbiBmb3Igd2h5IHRoaXMgcmVzdWx0IHdhcyBkZXRlY3RlZC4KCiAgICAgICAgOnBhcmFtIG9yaWdpbmFsX3Njb3JlOiBTY29yZSBnaXZlbiBieSB0aGlzIHJlY29nbml6ZXIKICAgICAgICA6cGFyYW0gZXhwbGFuYXRpb246ICAgIEV4cGxhbmF0aW9uIHN0cmluZwoKICAgICAgICA6cmV0dXJuczogUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbiBvYmplY3QKICAgICAgICAiIiIKICAgICAgICBleHBsYW5hdGlvbiA9IHBhLkFuYWx5c2lzRXhwbGFuYXRpb24oCiAgICAgICAgICAgIHJlY29nbml6ZXI9c2VsZi5fX2NsYXNzX18uX19uYW1lX18sCiAgICAgICAgICAgIG9yaWdpbmFsX3Njb3JlPW9yaWdpbmFsX3Njb3JlLAogICAgICAgICAgICB0ZXh0dWFsX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICkKICAgICAgICByZXR1cm4gZXhwbGFuYXRpb24KCiAgICAjIG1haW4gbWV0aG9kIGZvciB0aGUgcmVjb2duaXplcgogICAgZGVmIGFuYWx5emUoc2VsZiwgdGV4dDogc3RyLCBlbnRpdGllczogTGlzdFtzdHJdLCBubHBfYXJ0aWZhY3RzPU5vbmUpOiAgIyBub3FhIEQxMDIKICAgICAgICAiIiIKICAgICAgICBBbmFseXplIHRleHQgdXNpbmcgU3BhY3kuCgogICAgICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICBUZXh0IHRvIGFuYWx5emUKICAgICAgICA6cGFyYW0gZW50aXRpZXM6ICAgICAgRW50aXRpZXMgdG8gYW5hbHl6ZQogICAgICAgIDpwYXJhbSBubHBfYXJ0aWZhY3RzOiBOTFAgYXJ0aWZhY3RzIHRvIHVzZQoKICAgICAgICA6cmV0dXJuczogTGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IG9iamVjdHMKICAgICAgICAiIiIKICAgICAgICByZXN1bHRzID0gW10KICAgICAgICBpZiBub3QgbmxwX2FydGlmYWN0czoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlNraXBwaW5nIFNwYUN5LCBubHAgYXJ0aWZhY3RzIG5vdCBwcm92aWRlZC4uLiIpCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzCgogICAgICAgIG5lcl9lbnRpdGllcyA9IG5scF9hcnRpZmFjdHMuZW50aXRpZXMKCiAgICAgICAgIyByZWNvZ25pemUgdGhlIHN1cHBvcnRlZCBlbnRpdGllcwogICAgICAgIGZvciBlbnRpdHkgaW4gZW50aXRpZXM6CiAgICAgICAgICAgIGlmIGVudGl0eSBub3QgaW4gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXM6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBmb3IgZW50IGluIG5lcl9lbnRpdGllczoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9fY2hlY2tfbGFiZWwoZW50aXR5LCBlbnQubGFiZWxfLCBzZWxmLmNoZWNrX2xhYmVsX2dyb3Vwcyk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAjIHN0cmluZyBvZiB0aGUgZXhwbGFuYXRpb24gc2F5aW5nIHRoZSBlbnRpdHkgaXMgcmVjb2duaXplZCBieSBzcGFjeQogICAgICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbiA9IHNlbGYuX0RFRkFVTFRfRVhQTEFOQVRJT04uZm9ybWF0KGVudC5sYWJlbF8pCiAgICAgICAgICAgICAgICBleHBsYW5hdGlvbiA9IHNlbGYuX2J1aWxkX3NwYWN5X2V4cGxhbmF0aW9uKAogICAgICAgICAgICAgICAgICAgIHNlbGYubmVyX3N0cmVuZ3RoLCB0ZXh0dWFsX2V4cGxhbmF0aW9uCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgIyBjcmVhdGUgdGhlIHN0YW5kYXJkIHJlc3VsdCB3aXRoIHRoZSBlbnRpdHksIHN0YXJ0LCBlbmQsIHNjb3JlLCBhbmQgZXhwbGFuYXRpb24KICAgICAgICAgICAgICAgIHNwYWN5X3Jlc3VsdCA9IHBhLlJlY29nbml6ZXJSZXN1bHQoCiAgICAgICAgICAgICAgICAgICAgZW50aXR5X3R5cGU9ZW50aXR5LAogICAgICAgICAgICAgICAgICAgIHN0YXJ0PWVudC5zdGFydF9jaGFyLAogICAgICAgICAgICAgICAgICAgIGVuZD1lbnQuZW5kX2NoYXIsCiAgICAgICAgICAgICAgICAgICAgc2NvcmU9c2VsZi5uZXJfc3RyZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgYW5hbHlzaXNfZXhwbGFuYXRpb249ZXhwbGFuYXRpb24sCiAgICAgICAgICAgICAgICAgICAgcmVjb2duaXRpb25fbWV0YWRhdGE9ewogICAgICAgICAgICAgICAgICAgICAgICBwYS5SZWNvZ25pemVyUmVzdWx0LlJFQ09HTklaRVJfTkFNRV9LRVk6IHNlbGYubmFtZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByZXN1bHRzLmFwcGVuZChzcGFjeV9yZXN1bHQpCgogICAgICAgIHJldHVybiByZXN1bHRzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9fY2hlY2tfbGFiZWwoCiAgICAgICAgZW50aXR5OiBzdHIsIGxhYmVsOiBzdHIsIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdCiAgICApIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ2hlY2sgaWYgdGhlIGxhYmVsIGlzIGluIHRoZSBsYWJlbCBncm91cC4KCiAgICAgICAgOnBhcmFtIGVudGl0eTogICAgICAgICAgICAgRW50aXR5IHRvIGNoZWNrCiAgICAgICAgOnBhcmFtIGxhYmVsOiAgICAgICAgICAgICAgTGFiZWwgdG8gY2hlY2sKICAgICAgICA6cGFyYW0gY2hlY2tfbGFiZWxfZ3JvdXBzOiBMYWJlbCBncm91cHMgdG8gY2hlY2sKCiAgICAgICAgOnJldHVybnM6IFRydWUgaWYgdGhlIGxhYmVsIGlzIGluIHRoZSBsYWJlbCBncm91cCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGFueSgKICAgICAgICAgICAgZW50aXR5IGluIGVncnAgYW5kIGxhYmVsIGluIGxncnAgZm9yIGVncnAsIGxncnAgaW4gY2hlY2tfbGFiZWxfZ3JvdXBzCiAgICAgICAgKQoKCiMgQ2xhc3MgdG8gdXNlIEZsYWlyIHdpdGggUHJlc2lkaW8gYXMgYW4gZXh0ZXJuYWwgcmVjb2duaXplci4KY2xhc3MgRmxhaXJSZWNvZ25pemVyKHBhLkVudGl0eVJlY29nbml6ZXIpOgogICAgIiIiCiAgICBXcmFwcGVyIGZvciBhIGZsYWlyIG1vZGVsLCBpZiBuZWVkZWQgdG8gYmUgdXNlZCB3aXRoaW4gUHJlc2lkaW8gQW5hbHl6ZXIuCiAgICBUaGlzIGlzIHRvIG1ha2Ugc3VyZSB0aGUgcmVjb2duaXplciBjYW4gYmUgcmVnaXN0ZXJlZCB3aXRoIFByZXNpZGlvIHJlZ2lzdHJ5LgogICAgIiIiCgogICAgUkVDT0dOSVpBQkxFX0VOVElUSUVTID0gewogICAgICAgICJMT0NBVElPTiIsCiAgICAgICAgIlBFUlNPTiIsCiAgICAgICAgIk5SUCIsCiAgICAgICAgIkdQRSIsCiAgICAgICAgIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIk1BQ19BRERSRVNTIiwKICAgICAgICAiVVNfQkFOS19OVU1CRVIiLAogICAgICAgICJJTUVJIiwKICAgICAgICAiVElUTEUiLAogICAgICAgICJMSUNFTlNFX1BMQVRFIiwKICAgICAgICAiVVNfUEFTU1BPUlQiLAogICAgICAgICJDVVJSRU5DWSIsCiAgICAgICAgIlJPVVRJTkdfTlVNQkVSIiwKICAgICAgICAiVVNfSVRJTiIsCiAgICAgICAgIlVTX0JBTktfTlVNQkVSIiwKICAgICAgICAiVVNfRFJJVkVSX0xJQ0VOU0UiLAogICAgICAgICJBR0UiLAogICAgICAgICJQQVNTV09SRCIsCiAgICAgICAgIlNXSUZUX0NPREUiLAogICAgfQoKICAgICMgVGhpcyBpcyB1c2VkIHRvIGNvbnN0cnVjdCB0aGUgZXhwbGFuYXRpb24gZm9yIHRoZSByZXN1bHQKCiAgICBfREVGQVVMVF9FWFBMQU5BVElPTiA9ICJJZGVudGlmaWVkIGFzIHt9IGJ5IEZsYWlyJ3MgTmFtZWQgRW50aXR5IFJlY29nbml0aW9uIgoKICAgIF9ERUZBVUxUX0NIRUNLX0xBQkVMX0dST1VQUyA9IFsKICAgICAgICAoeyJMT0NBVElPTiJ9LCB7IkxPQyIsICJMT0NBVElPTiIsICJTVFJFRVRfQUREUkVTUyIsICJDT09SRElOQVRFIn0pLAogICAgICAgICh7IlBFUlNPTiJ9LCB7IlBFUiIsICJQRVJTT04ifSksCiAgICAgICAgKHsiTlJQIn0sIHsiTk9SUCIsICJOUlAifSksCiAgICAgICAgKHsiR1BFIn0sIHsiR1BFIn0pLAogICAgICAgICh7Ik9SR0FOSVpBVElPTiJ9LCB7Ik9SRyJ9KSwKICAgICAgICAoeyJNQUNfQUREUkVTUyJ9LCB7Ik1BQ19BRERSRVNTIn0pLAogICAgICAgICh7IlVTX0JBTktfTlVNQkVSIn0sIHsiVVNfQkFOS19OVU1CRVIifSksCiAgICAgICAgKHsiSU1FSSJ9LCB7IklNRUkifSksCiAgICAgICAgKHsiVElUTEUifSwgeyJUSVRMRSJ9KSwKICAgICAgICAoeyJMSUNFTlNFX1BMQVRFIn0sIHsiTElDRU5TRV9QTEFURSJ9KSwKICAgICAgICAoeyJVU19QQVNTUE9SVCJ9LCB7IlVTX1BBU1NQT1JUIn0pLAogICAgICAgICh7IkNVUlJFTkNZIn0sIHsiQ1VSUkVOQ1kifSksCiAgICAgICAgKHsiUk9VVElOR19OVU1CRVIifSwgeyJST1VUSU5HX05VTUJFUiJ9KSwKICAgICAgICAoeyJBR0UifSwgeyJBR0UifSksCiAgICAgICAgKHsiQ1VSUkVOQ1kifSwgeyJDVVJSRU5DWSJ9KSwKICAgICAgICAoeyJTV0lGVF9DT0RFIn0sIHsiU1dJRlRfQ09ERSJ9KSwKICAgICAgICAoeyJVU19JVElOIn0sIHsiVVNfSVRJTiJ9KSwKICAgICAgICAoeyJVU19CQU5LX05VTUJFUiJ9LCB7IlVTX0JBTktfTlVNQkVSIn0pLAogICAgICAgICh7IlVTX0RSSVZFUl9MSUNFTlNFIn0sIHsiVVNfRFJJVkVSX0xJQ0VOU0UifSksCiAgICBdCgogICAgX0RFRkFVTFRfTU9ERUxfTEFOR1VBR0VTID0gewogICAgICAgICJlbiI6ICJiZWtpL2ZsYWlyLXBpaS1kaXN0aWxiZXJ0IiwKICAgIH0KCiAgICBfREVGQVVMVF9QUkVTSURJT19FUVVJVkFMRU5DRVMgPSB7CiAgICAgICAgIlBFUiI6ICJQRVJTT04iLAogICAgICAgICJMT0MiOiAiTE9DQVRJT04iLAogICAgICAgICJPUkciOiAiT1JHQU5JWkFUSU9OIiwKICAgICAgICAiTlJPUCI6ICJOUlAiLAogICAgICAgICJVUkwiOiAiVVJMIiwKICAgICAgICAiVVNfSVRJTiI6ICJVU19JVElOIiwKICAgICAgICAiVVNfUEFTU1BPUlQiOiAiVVNfUEFTU1BPUlQiLAogICAgICAgICJJQkFOX0NPREUiOiAiSUJBTl9DT0RFIiwKICAgICAgICAiSVBfQUREUkVTUyI6ICJJUF9BRERSRVNTIiwKICAgICAgICAiRU1BSUxfQUREUkVTUyI6ICJFTUFJTCIsCiAgICAgICAgIlVTX0RSSVZFUl9MSUNFTlNFIjogIlVTX0RSSVZFUl9MSUNFTlNFIiwKICAgICAgICAiVVNfQkFOS19OVU1CRVIiOiAiVVNfQkFOS19OVU1CRVIiLAogICAgfQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZTogc3RyID0gImVuIiwKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICAgICAgY2hlY2tfbGFiZWxfZ3JvdXBzOiBUdXBsZVtTZXQsIFNldF0gPSBOb25lLAogICAgKToKICAgICAgICAiIiIKICAgICAgICBJbml0aWFsaXplIHRoZSBGbGFpclJlY29nbml6ZXIuCgogICAgICAgIDpwYXJhbSBzdXBwb3J0ZWRfbGFuZ3VhZ2U6IExhbmd1YWdlIHRvIHVzZQogICAgICAgIDpwYXJhbSBzdXBwb3J0ZWRfZW50aXRpZXM6IEVudGl0aWVzIHRvIHVzZQogICAgICAgIDpwYXJhbSBjaGVja19sYWJlbF9ncm91cHM6IExhYmVsIGdyb3VwcyB0byBjaGVjawoKICAgICAgICA6cmV0dXJuczogRmxhaXJSZWNvZ25pemVyIG9iamVjdAoKICAgICAgICAiIiIKICAgICAgICBzZWxmLmNoZWNrX2xhYmVsX2dyb3VwcyA9IGNoZWNrX2xhYmVsX2dyb3VwcyBvciBzZWxmLl9ERUZBVUxUX0NIRUNLX0xBQkVMX0dST1VQUwoKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXMgPSBzdXBwb3J0ZWRfZW50aXRpZXMgb3Igc2VsZi5SRUNPR05JWkFCTEVfRU5USVRJRVMKICAgICAgICBzZWxmLm1vZGVsID0gZmwubW9kZWxzLlNlcXVlbmNlVGFnZ2VyLmxvYWQoCiAgICAgICAgICAgIHNlbGYuX0RFRkFVTFRfTU9ERUxfTEFOR1VBR0VTLmdldChzdXBwb3J0ZWRfbGFuZ3VhZ2UpCiAgICAgICAgKQoKICAgICAgICBzdXBlcigpLl9faW5pdF9fKAogICAgICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM9c3VwcG9ydGVkX2VudGl0aWVzLAogICAgICAgICAgICBzdXBwb3J0ZWRfbGFuZ3VhZ2U9c3VwcG9ydGVkX2xhbmd1YWdlLAogICAgICAgICAgICBuYW1lPSJGbGFpciBBbmFseXRpY3MiLAogICAgICAgICkKCiAgICAjIG1haW4gbWV0aG9kIGZvciB0aGUgcmVjb2duaXplcgogICAgZGVmIGFuYWx5emUoCiAgICAgICAgc2VsZiwKICAgICAgICB0ZXh0OiBzdHIsCiAgICAgICAgZW50aXRpZXM6IExpc3Rbc3RyXSwKICAgICAgICBubHBfYXJ0aWZhY3RzOiBwYS5ubHBfZW5naW5lLk5scEFydGlmYWN0cyA9IE5vbmUsCiAgICApIC0+IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF06CiAgICAgICAgIiIiCiAgICAgICAgQW5hbHl6ZSB0ZXh0IGFuZCByZXR1cm4gdGhlIHJlc3VsdHMuCgogICAgICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICAgICAgOnBhcmFtIGVudGl0aWVzOiAgICAgIFRoZSBsaXN0IG9mIGVudGl0aWVzIHRvIHJlY29nbml6ZS4KICAgICAgICA6cGFyYW0gbmxwX2FydGlmYWN0czogTm90IHVzZWQgYnkgdGhpcyByZWNvZ25pemVyIGJ1dCBuZWVkZWQgZm9yIHRoZSBpbnRlcmZhY2UuCiAgICAgICAgOnBhcmFtIGxhbmd1YWdlOiAgICAgIFRleHQgbGFuZ3VhZ2UuIFN1cHBvcnRlZCBsYW5ndWFnZXMgaW4gTU9ERUxfTEFOR1VBR0VTCgogICAgICAgIDpyZXR1cm5zOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gdGhlIHJlY29nbml6ZWQgRmxhaXIgZGV0ZWN0aW9ucy4KICAgICAgICAiIiIKCiAgICAgICAgcmVzdWx0cyA9IFtdCgogICAgICAgIHNlbnRlbmNlcyA9IGZsLmRhdGEuU2VudGVuY2UodGV4dCkKICAgICAgICBzZWxmLm1vZGVsLnByZWRpY3Qoc2VudGVuY2VzKQoKICAgICAgICAjIElmIHRoZXJlIGFyZSBubyBzcGVjaWZpYyBsaXN0IG9mIGVudGl0aWVzLCB3ZSB3aWxsIGxvb2sgZm9yIGFsbCBvZiBpdC4KICAgICAgICBpZiBub3QgZW50aXRpZXM6CiAgICAgICAgICAgIGVudGl0aWVzID0gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXMKCiAgICAgICAgIyBHbyBvdmVyIHRoZSBlbnRpdGllcyBhbmQgY2hlY2sgaWYgdGhleSBhcmUgaW4gdGhlIHN1cHBvcnRlZCBlbnRpdGllcyBsaXN0LgogICAgICAgIGZvciBlbnRpdHkgaW4gZW50aXRpZXM6CiAgICAgICAgICAgIGlmIGVudGl0eSBub3QgaW4gc2VsZi5zdXBwb3J0ZWRfZW50aXRpZXM6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgIyBHbyBvdmVyIHRoZSBzZW50ZW5jZXMgYW5kIGNoZWNrIGlmIHRoZSBlbnRpdHkgaXMgaW4gdGhlIHNlbnRlbmNlLgogICAgICAgICAgICBmb3IgZW50IGluIHNlbnRlbmNlcy5nZXRfc3BhbnMoIm5lciIpOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX19jaGVja19sYWJlbCgKICAgICAgICAgICAgICAgICAgICBlbnRpdHksIGVudC5sYWJlbHNbMF0udmFsdWUsIHNlbGYuY2hlY2tfbGFiZWxfZ3JvdXBzCiAgICAgICAgICAgICAgICApOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgIyBJZiB0aGUgZW50aXR5IGlzIGluIHRoZSBzZW50ZW5jZSwgd2Ugd2lsbCBhZGQgaXQgdG8gdGhlIHJlc3VsdHMuCiAgICAgICAgICAgICAgICB0ZXh0dWFsX2V4cGxhbmF0aW9uID0gc2VsZi5fREVGQVVMVF9FWFBMQU5BVElPTi5mb3JtYXQoCiAgICAgICAgICAgICAgICAgICAgZW50LmxhYmVsc1swXS52YWx1ZQogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICMgQnVpbGQgdGhlIGV4cGxhbmF0aW9uIGZvciB0aGUgcmVzdWx0CiAgICAgICAgICAgICAgICBleHBsYW5hdGlvbiA9IHNlbGYuX2J1aWxkX2ZsYWlyX2V4cGxhbmF0aW9uKAogICAgICAgICAgICAgICAgICAgIHJvdW5kKGVudC5zY29yZSwgMiksIHRleHR1YWxfZXhwbGFuYXRpb24KICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBmbGFpcl9yZXN1bHQgPSBzZWxmLl9jb252ZXJ0X3RvX3JlY29nbml6ZXJfcmVzdWx0KGVudCwgZXhwbGFuYXRpb24pCgogICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoZmxhaXJfcmVzdWx0KQoKICAgICAgICByZXR1cm4gcmVzdWx0cwoKICAgIGRlZiBfY29udmVydF90b19yZWNvZ25pemVyX3Jlc3VsdCgKICAgICAgICBzZWxmLCBlbnRpdHk6IGZsLmRhdGEuU3BhbiwgZXhwbGFuYXRpb246IHN0cgogICAgKSAtPiBwYS5SZWNvZ25pemVyUmVzdWx0OgogICAgICAgICIiIgogICAgICAgIENvbnZlcnQgRmxhaXIgcmVzdWx0IHRvIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQuCgogICAgICAgIDpwYXJhbSBlbnRpdHk6ICAgICAgRmxhaXIgZW50aXR5IG9mIFNwYW4KICAgICAgICA6cGFyYW0gZXhwbGFuYXRpb246IFByZXNpZGlvIEFuYWx5c2lzRXhwbGFuYXRpb24KCiAgICAgICAgOnJldHVybnM6IFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQKICAgICAgICAiIiIKCiAgICAgICAgIyBDb252ZXJ0IHRoZSBlbnRpdHkgdHlwZSB0byBQcmVzaWRpbyBlbnRpdHkgdHlwZQogICAgICAgIGVudGl0eV90eXBlID0gc2VsZi5fREVGQVVMVF9QUkVTSURJT19FUVVJVkFMRU5DRVMuZ2V0KGVudGl0eS50YWcsIGVudGl0eS50YWcpCgogICAgICAgICMgQ29udmVydCB0aGUgc2NvcmUgdG8gUHJlc2lkaW8gc2NvcmUKICAgICAgICBmbGFpcl9zY29yZSA9IHJvdW5kKGVudGl0eS5zY29yZSwgMikKCiAgICAgICAgIyBDcmVhdGUgdGhlIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgZnJvbSB0aGUgRmxhaXIgZW50aXR5CiAgICAgICAgZmxhaXJfcmVzdWx0cyA9IHBhLlJlY29nbml6ZXJSZXN1bHQoCiAgICAgICAgICAgIGVudGl0eV90eXBlPWVudGl0eV90eXBlLAogICAgICAgICAgICBzdGFydD1lbnRpdHkuc3RhcnRfcG9zaXRpb24sCiAgICAgICAgICAgIGVuZD1lbnRpdHkuZW5kX3Bvc2l0aW9uLAogICAgICAgICAgICBzY29yZT1mbGFpcl9zY29yZSwKICAgICAgICAgICAgYW5hbHlzaXNfZXhwbGFuYXRpb249ZXhwbGFuYXRpb24sCiAgICAgICAgKQoKICAgICAgICByZXR1cm4gZmxhaXJfcmVzdWx0cwoKICAgIGRlZiBfYnVpbGRfZmxhaXJfZXhwbGFuYXRpb24oCiAgICAgICAgc2VsZiwgb3JpZ2luYWxfc2NvcmU6IGZsb2F0LCBleHBsYW5hdGlvbjogc3RyCiAgICApIC0+IHBhLkFuYWx5c2lzRXhwbGFuYXRpb246CiAgICAgICAgIiIiCiAgICAgICAgQ3JlYXRlIGV4cGxhbmF0aW9uIGZvciB3aHkgdGhpcyByZXN1bHQgd2FzIGRldGVjdGVkLgoKICAgICAgICA6cGFyYW0gb3JpZ2luYWxfc2NvcmU6IFNjb3JlIGdpdmVuIGJ5IHRoaXMgcmVjb2duaXplcgogICAgICAgIDpwYXJhbSBleHBsYW5hdGlvbjogICAgRXhwbGFuYXRpb24gc3RyaW5nCgogICAgICAgIDpyZXR1cm5zOiBQcmVzaWRpbyBBbmFseXNpc0V4cGxhbmF0aW9uCiAgICAgICAgIiIiCgogICAgICAgICMgQ3JlYXRlIHRoZSBQcmVzaWRpbyBBbmFseXNpc0V4cGxhbmF0aW9uIGZvciB0aGUgcmVzdWx0CiAgICAgICAgZXhwbGFuYXRpb24gPSBwYS5BbmFseXNpc0V4cGxhbmF0aW9uKAogICAgICAgICAgICByZWNvZ25pemVyPXNlbGYuX19jbGFzc19fLl9fbmFtZV9fLAogICAgICAgICAgICBvcmlnaW5hbF9zY29yZT1vcmlnaW5hbF9zY29yZSwKICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbj1leHBsYW5hdGlvbiwKICAgICAgICApCiAgICAgICAgcmV0dXJuIGV4cGxhbmF0aW9uCgogICAgIyBzYW5pdHkgY2hlY2sgb2YgdGhlIGVudGl0eSBhbmQgbGFiZWwgYmVmb3JlIHJlY29nbml0aW9uCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgX19jaGVja19sYWJlbCgKICAgICAgICBlbnRpdHk6IHN0ciwgbGFiZWw6IHN0ciwgY2hlY2tfbGFiZWxfZ3JvdXBzOiBUdXBsZVtTZXQsIFNldF0KICAgICkgLT4gYm9vbDoKICAgICAgICByZXR1cm4gYW55KAogICAgICAgICAgICBlbnRpdHkgaW4gZWdycCBhbmQgbGFiZWwgaW4gbGdycCBmb3IgZWdycCwgbGdycCBpbiBjaGVja19sYWJlbF9ncm91cHMKICAgICAgICApCgoKIyBnZXQgdGhlIGFuYWx5emVyIGVuZ2luZSBiYXNlZCBvbiB0aGUgbW9kZWwKZGVmIF9nZXRfYW5hbHl6ZXJfZW5naW5lKAogICAgbW9kZWw6IHN0ciA9IE5vbmUsIGVudGl0aWVzOiBMaXN0W3N0cl0gPSBOb25lCikgLT4gcGEuQW5hbHl6ZXJFbmdpbmU6CiAgICAiIiIKICAgIFJldHVybiBwYS5BbmFseXplckVuZ2luZS4KCiAgICA6cGFyYW0gbW9kZWw6IFRoZSBtb2RlbCB0byB1c2UuIENhbiBiZSAic3BhY3kiLCAiZmxhaXIiLCAicGF0dGVybiIgb3IgIndob2xlIi4KICAgIDpwYXJhbSBlbnRpdGllczogVGhlIGxpc3Qgb2YgZW50aXRpZXMgdG8gdXNlLgoKICAgIDpyZXR1cm5zOiBwYS5BbmFseXplckVuZ2luZQogICAgIiIiCiAgICAjIHJlY29nbml6ZXIgcmVnaXN0cnkgdGhhdCBjYW4gc3RvcmUgbXVsdGlwbGUgcmVjb2duaXplcnMKICAgIHJlZ2lzdHJ5ID0gcGEuUmVjb2duaXplclJlZ2lzdHJ5KCkKCiAgICBpZiBtb2RlbCA9PSBNb2RlbHMuU1BBQ1k6CiAgICAgICAgIyBjdXN0b20gc3BhY3kgcmVjb2duaXplcgogICAgICAgIHNwYWN5X3JlY29nbml6ZXIgPSBDdXN0b21TcGFjeVJlY29nbml6ZXIoKQogICAgICAgICMgYWRkIHRoZSBjdXN0b20gYnVpbGQgc3BhY3kgcmVjb2duaXplcgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHNwYWN5X3JlY29nbml6ZXIpCiAgICBlbGlmIG1vZGVsID09IE1vZGVscy5GTEFJUjoKICAgICAgICAjIHByZS10cmFpbmVkIGZsYWlyIHJlY29nbml6ZXIKICAgICAgICBmbGFpcl9yZWNvZ25pemVyID0gRmxhaXJSZWNvZ25pemVyKCkKICAgICAgICAjIGFkZCB0aGUgY3VzdG9tIGJ1aWxkIGZsYWlyIHJlY29nbml6ZXIKICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihmbGFpcl9yZWNvZ25pemVyKQogICAgZWxpZiBtb2RlbCA9PSBNb2RlbHMuUEFUVEVSTjoKICAgICAgICAjIGFkZCB0aGUgcGF0dGVybiByZWNvZ25pemVyCiAgICAgICAgcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkgPSBQYXR0ZXJuUmVjb2duaXplckZhY3RvcnkoKQogICAgICAgIGZvciByZWNvZ25pemVyIGluIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5Ll9jcmVhdGVfcGF0dGVybl9yZWNvZ25pemVyKCk6CiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCiAgICBlbGlmIG1vZGVsID09IE1vZGVscy5XSE9MRToKICAgICAgICBzcGFjeV9yZWNvZ25pemVyID0gQ3VzdG9tU3BhY3lSZWNvZ25pemVyKCkKICAgICAgICBmbGFpcl9yZWNvZ25pemVyID0gRmxhaXJSZWNvZ25pemVyKCkKICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihzcGFjeV9yZWNvZ25pemVyKQogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICBmb3IgcmVjb2duaXplciBpbiBwYXR0ZXJuX3JlY29nbml6ZXJfZmFjdG9yeS5fY3JlYXRlX3BhdHRlcm5fcmVjb2duaXplcigpOgogICAgICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihyZWNvZ25pemVyKQogICAgZWxpZiBub3QgbW9kZWwgYW5kIGVudGl0aWVzOgogICAgICAgIGlmIHNldChlbnRpdGllcykgJiBDdXN0b21TcGFjeVJlY29nbml6ZXIuUkVDT0dOSVpBQkxFX0VOVElUSUVTOgogICAgICAgICAgICBzcGFjeV9yZWNvZ25pemVyID0gQ3VzdG9tU3BhY3lSZWNvZ25pemVyKCkKICAgICAgICAgICAgcmVnaXN0cnkuYWRkX3JlY29nbml6ZXIoc3BhY3lfcmVjb2duaXplcikKICAgICAgICBpZiBzZXQoZW50aXRpZXMpICYgRmxhaXJSZWNvZ25pemVyLlJFQ09HTklaQUJMRV9FTlRJVElFUzoKICAgICAgICAgICAgZmxhaXJfcmVjb2duaXplciA9IEZsYWlyUmVjb2duaXplcigpCiAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIGlmIHNldChlbnRpdGllcykgJiAoc2V0KFBhdHRlcm5SZWNvZ25pemVyRmFjdG9yeS5SRUNPR05JWkFCTEVfRU5USVRJRVMua2V5cygpKSk6CiAgICAgICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICAgICAgZm9yIHJlY29nbml6ZXIgaW4gcGF0dGVybl9yZWNvZ25pemVyX2ZhY3RvcnkuX2NyZWF0ZV9wYXR0ZXJuX3JlY29nbml6ZXIoKToKICAgICAgICAgICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHJlY29nbml6ZXIpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiYXJndW1lbnQgb2YgbW9kZWwgYW5kIGVudGl0aWVzIGNhbiBub3QgYmUgTm9uZSBhdCB0aGUgc2FtZSB0aW1lIgogICAgICAgICkKCiAgICBhbmFseXplciA9IHBhLkFuYWx5emVyRW5naW5lKAogICAgICAgIHJlZ2lzdHJ5PXJlZ2lzdHJ5LAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZXM9WyJlbiJdLAogICAgKQoKICAgIHN1cHBvcnRlZF9lbnRpdGllcyA9IGFuYWx5emVyLmdldF9zdXBwb3J0ZWRfZW50aXRpZXMoKQoKICAgIGlmIGVudGl0aWVzIGFuZCBub3QgYWxsKGl0ZW0gaW4gc3VwcG9ydGVkX2VudGl0aWVzIGZvciBpdGVtIGluIGVudGl0aWVzKToKICAgICAgICBub3Rfc3VwcG9ydGVkX2VudGl0aWVzID0gWwogICAgICAgICAgICBpdGVtIGZvciBpdGVtIGluIGVudGl0aWVzIGlmIGl0ZW0gbm90IGluIHN1cHBvcnRlZF9lbnRpdGllcwogICAgICAgIF0KICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICBmIlRoZSBjdXJyZW50IG1vZGVsIHttb2RlbH0gZG9lc24ndCBzdXBwb3J0IHRoZSBmb2xsb3dpbmcgZW50aXRpZXM6IHtub3Rfc3VwcG9ydGVkX2VudGl0aWVzfS4gIgogICAgICAgICAgICBmIlN1cHBvcnRlZCBlbnRpdGllcyBhcmU6IHtzdXBwb3J0ZWRfZW50aXRpZXN9IgogICAgICAgICkKCiAgICByZXR1cm4gYW5hbHl6ZXIKCgpkZWYgX2dldF9hbm9ueW1pemVyX2VuZ2luZSgpIC0+IHByZV9hbm95bWl6ZXIuQW5vbnltaXplckVuZ2luZToKICAgICIiIgogICAgUmV0dXJuIEFub255bWl6ZXJFbmdpbmUuCgogICAgOnJldHVybnM6IFRoZSBBbm9ueW1pemVyRW5naW5lLgogICAgIiIiCiAgICByZXR1cm4gcHJlX2Fub3ltaXplci5Bbm9ueW1pemVyRW5naW5lKCkKCgpkZWYgX2Fub255bWl6ZSgKICAgIHRleHQ6IHN0ciwKICAgIGFuYWx5emVfcmVzdWx0czogTGlzdFtwYS5SZWNvZ25pemVyUmVzdWx0XSwKICAgIGVudGl0eV9vcGVyYXRvcl9tYXA6IGRpY3QgPSBOb25lLAogICAgaXNfZnVsbF90ZXh0OiBib29sID0gVHJ1ZSwKKSAtPiBzdHI6CiAgICAiIiIKICAgIEFub255bWl6ZSBpZGVudGlmaWVkIGlucHV0IHVzaW5nIFByZXNpZGlvIEFib255bWl6ZXIuCgogICAgOnBhcmFtIHRleHQ6ICAgICAgICAgICAgICAgIFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgIDpwYXJhbSBhbmFseXplX3Jlc3VsdHM6ICAgICBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20KICAgIDpwYXJhbSBlbnRpdHlfb3BlcmF0b3JfbWFwOiBUaGUgZW50aXR5X29wZXJhdG9yX21hcCBpcyBhIGRpY3Rpb25hcnkgdGhhdCBtYXBzIGVudGl0eSB0byBvcGVyYXRvciBuYW1lIGFuZCBvcGVyYXRvciBwYXJhbXMuCiAgICA6cGFyYW0gaXNfZnVsbF90ZXh0OiAgICAgICAgV2hldGhlciB0aGUgdGV4dCBpcyBmdWxsIHRleHQgb3Igbm90LgoKICAgIDpyZXR1cm5zOiBUaGUgYW5vbnltaXplZCB0ZXh0LgogICAgIiIiCiAgICBpZiBub3QgdGV4dDoKICAgICAgICByZXR1cm4gIiIKCiAgICBhbm9ueW1pemVyX2VuZ2luZSA9IF9nZXRfYW5vbnltaXplcl9lbmdpbmUoKQogICAgaWYgbm90IGVudGl0eV9vcGVyYXRvcl9tYXA6CiAgICAgICAgb3BlcmF0b3JzID0gTm9uZQogICAgZWxzZToKICAgICAgICAjIENyZWF0ZSBPcGVyYXRvckNvbmZpZyBiYXNlZCBvbiB0aGUgZW50aXR5X29wZXJhdG9yX21hcAogICAgICAgIG9wZXJhdG9ycyA9IHsKICAgICAgICAgICAgZW50aXR5OiBPcGVyYXRvckNvbmZpZyhvcGVyYXRvcl9uYW1lLCBvcGVyYXRvcl9wYXJhbXMpCiAgICAgICAgICAgIGZvciBlbnRpdHksIChvcGVyYXRvcl9uYW1lLCBvcGVyYXRvcl9wYXJhbXMpIGluIGVudGl0eV9vcGVyYXRvcl9tYXAuaXRlbXMoKQogICAgICAgIH0KCiAgICBpZiBpc19mdWxsX3RleHQ6CiAgICAgICAgIyBBbm9ueW1pemUgdGhlIGVudGlyZSB0ZXh0CiAgICAgICAgcmV0dXJuIGFub255bWl6ZXJfZW5naW5lLmFub255bWl6ZSgKICAgICAgICAgICAgdGV4dD10ZXh0LCBhbmFseXplcl9yZXN1bHRzPWFuYWx5emVfcmVzdWx0cywgb3BlcmF0b3JzPW9wZXJhdG9ycwogICAgICAgICkudGV4dAogICAgIyBUb2tlbml6ZSB0aGUgdGV4dCB0byBzZW50ZW5jZXMKICAgIHNlbnRlbmNlcyA9IG5sdGsuc2VudF90b2tlbml6ZSh0ZXh0KQogICAgYW5vbnltaXplZF9zZW50ZW5jZXMgPSBbXQogICAgY3VycmVudF9pZHggPSAwCgogICAgIyBGaW5kIHRoZSBzZW50ZW5jZSB0aGF0IGhhcyBwaWkgZW50aXR5CiAgICBmb3Igc2VudGVuY2UgaW4gc2VudGVuY2VzOgogICAgICAgIHN0YXJ0X2lkeCA9IGN1cnJlbnRfaWR4CiAgICAgICAgZW5kX2lkeCA9IHN0YXJ0X2lkeCArIGxlbihzZW50ZW5jZSkKCiAgICAgICAgIyBHZXQgdGhlIGVudGl0aWVzIHRoYXQgYXJlIGluIHRoZSBzZW50ZW5jZSwgdXBkYXRlIGh0ZSBzdGFydF9pZHggYW5kIGVuZF9pZHgKICAgICAgICBzZW50ZW5jZV9yZXN1bHRzID0gWwogICAgICAgICAgICBwYS5SZWNvZ25pemVyUmVzdWx0KAogICAgICAgICAgICAgICAgcmVzdWx0LmVudGl0eV90eXBlLAogICAgICAgICAgICAgICAgc3RhcnQ9cmVzdWx0LnN0YXJ0IC0gc3RhcnRfaWR4LAogICAgICAgICAgICAgICAgZW5kPXJlc3VsdC5lbmQgLSBzdGFydF9pZHgsCiAgICAgICAgICAgICAgICBzY29yZT1yZXN1bHQuc2NvcmUsCiAgICAgICAgICAgICkKICAgICAgICAgICAgZm9yIHJlc3VsdCBpbiBhbmFseXplX3Jlc3VsdHMKICAgICAgICAgICAgaWYgcmVzdWx0LnN0YXJ0ID49IHN0YXJ0X2lkeCBhbmQgcmVzdWx0LmVuZCA8PSBlbmRfaWR4CiAgICAgICAgXQoKICAgICAgICAjIElmIFBJSSBpcyBkZXRlY3RlZAogICAgICAgIGlmIHNlbnRlbmNlX3Jlc3VsdHM6CiAgICAgICAgICAgIGFub255bWl6ZWRfc2VudGVuY2UgPSBhbm9ueW1pemVyX2VuZ2luZS5hbm9ueW1pemUoCiAgICAgICAgICAgICAgICB0ZXh0PXNlbnRlbmNlLCBhbmFseXplcl9yZXN1bHRzPXNlbnRlbmNlX3Jlc3VsdHMsIG9wZXJhdG9ycz1vcGVyYXRvcnMKICAgICAgICAgICAgKS50ZXh0CiAgICAgICAgICAgIGFub255bWl6ZWRfc2VudGVuY2VzLmFwcGVuZChhbm9ueW1pemVkX3NlbnRlbmNlKQoKICAgICAgICBjdXJyZW50X2lkeCA9IGVuZF9pZHgKCiAgICByZXR1cm4gIiAiLmpvaW4oYW5vbnltaXplZF9zZW50ZW5jZXMpCgoKZGVmIF9nZXRfdG9rZW5zKAogICAgdGV4dDogc3RyLCBhbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sIGlzX2Z1bGw6IGJvb2wgPSBUcnVlCikgLT4gTGlzdFtzdHJdOgogICAgIiIiCiAgICBHZXQgdGhlIGZ1bGwgdG9rZW5zIG9yIG9ubHkgY29udGFpbnMgdGhlIGVudGl0aWVzIHRoYXQgY2FuIGZvcm0gYSBzZW50ZW5jZS4KCiAgICA6cGFyYW0gdGV4dDogICAgICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gYW5hbHl6ZV9yZXN1bHRzOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20KICAgIDpwYXJhbSBpc19mdWxsOiAgICAgICAgIFdoZXRoZXIgcmV0dXJuIGZ1bGwgdG9rZW5zIG9yIGp1c3QgdGhlIHRva2VucyB0aGF0IG9ubHkgY29udGFpbnMgdGhlIGVudGl0aWVzIHRoYXQgY2FuIGZvcm0gYSBzZW50ZW5jZS4KCiAgICA6cmV0dXJuczogVGhlIHRva2Vucy4KICAgICIiIgoKICAgIHRva2VucyA9IFtdCiAgICAjIHNvcnQgYnkgc3RhcnQgaW5kZXgKICAgIHJlc3VsdHMgPSBzb3J0ZWQoYW5hbHl6ZV9yZXN1bHRzLCBrZXk9bGFtYmRhIHg6IHguc3RhcnQpCiAgICBmb3IgaSwgcmVzIGluIGVudW1lcmF0ZShyZXN1bHRzKToKICAgICAgICBpZiBpID09IDA6CiAgICAgICAgICAgIHRva2Vucy5hcHBlbmQodGV4dFs6IHJlcy5zdGFydF0pCgogICAgICAgICMgYXBwZW5kIGVudGl0eSB0ZXh0IGFuZCBlbnRpdHkgdHlwZQogICAgICAgIHRva2Vucy5hcHBlbmQoKHRleHRbcmVzLnN0YXJ0IDogcmVzLmVuZF0sIHJlcy5lbnRpdHlfdHlwZSkpCgogICAgICAgICMgaWYgYW5vdGhlciBlbnRpdHkgY29taW5nIGkuZS4gd2UncmUgbm90IGF0IHRoZSBsYXN0IHJlc3VsdHMgZWxlbWVudCwKICAgICAgICAjIGFkZCB0ZXh0IHVwIHRvIG5leHQgZW50aXR5CiAgICAgICAgaWYgaSAhPSBsZW4ocmVzdWx0cykgLSAxOgogICAgICAgICAgICB0b2tlbnMuYXBwZW5kKHRleHRbcmVzLmVuZCA6IHJlc3VsdHNbaSArIDFdLnN0YXJ0XSkKICAgICAgICAjIGlmIG5vIG1vcmUgZW50aXRpZXMgY29taW5nLCBhZGQgYWxsIHJlbWFpbmluZyB0ZXh0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgdG9rZW5zLmFwcGVuZCh0ZXh0W3Jlcy5lbmQgOl0pCgogICAgIyBnZXQgdGhlIHRva2VucyB0aGF0IG9ubHkgY29udGFpbnMgdGhlIGVudGl0aWVzIHRoYXQgY2FuIGZvcm0gYSBzZW50ZW5jZQogICAgcGFydF9hbm5vbnRhdGVkX3Rva2VucyA9IFtdCiAgICBpZiBub3QgaXNfZnVsbDoKICAgICAgICBsYXN0X2VuZF9zZW50ZW5jZSA9IDAKICAgICAgICBmb3IgaSwgdG9rZW4gaW4gZW51bWVyYXRlKHRva2Vucyk6CiAgICAgICAgICAgIGlmIGFueShpdGVtIGluIHRva2VuIGZvciBpdGVtIGluIFsiLiIsICIhIiwgIj8iXSkgYW5kIGFueSgKICAgICAgICAgICAgICAgIHR5cGUoaXRlbSkgaXMgdHVwbGUgZm9yIGl0ZW0gaW4gdG9rZW5zW2xhc3RfZW5kX3NlbnRlbmNlOmldCiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBwYXJ0X2Fubm9udGF0ZWRfdG9rZW5zLmFwcGVuZCh0b2tlbnNbbGFzdF9lbmRfc2VudGVuY2U6aV0pCiAgICAgICAgICAgICAgICBsYXN0X2VuZF9zZW50ZW5jZSA9IGkKICAgICAgICByZXR1cm4gcGFydF9hbm5vbnRhdGVkX3Rva2VucwogICAgcmV0dXJuIHRva2VucwoKCmRlZiBfYW5ub3RhdGUoCiAgICB0ZXh0OiBzdHIsIHN0X2FuYWx5emVfcmVzdWx0czogTGlzdFtwYS5SZWNvZ25pemVyUmVzdWx0XSwgaXNfZnVsbF9odG1sOiBib29sID0gVHJ1ZQopIC0+IExpc3Rbc3RyXToKICAgICIiIgogICAgQW5ub3RhdGUgaWRlbnRpZmllZCBpbnB1dCB1c2luZyBQcmVzaWRpbyBBbm9ueW1pemVyLgoKICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICAgICAgIFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgIDpwYXJhbSBzdF9hbmFseXplX3Jlc3VsdHM6IFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KICAgIDpwYXJhbSBpc19mdWxsX2h0bWw6ICAgICAgIFdoZXRoZXIgZ2VuZXJhdGUgZnVsbCBodG1sIG9yIG5vdC4KCiAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgdG9rZW5zIHdpdGggdGhlIGlkZW50aWZpZWQgZW50aXRpZXMuCgogICAgIiIiCiAgICByZXR1cm4gX2dldF90b2tlbnModGV4dCwgc3RfYW5hbHl6ZV9yZXN1bHRzLCBpc19mdWxsX2h0bWwpCgoKZGVmIF9wcm9jZXNzKAogICAgdGV4dDogc3RyLAogICAgbW9kZWw6IHBhLkFuYWx5emVyRW5naW5lLAogICAgc2NvcmVfdGhyZXNob2xkOiBmbG9hdCwKICAgIGVudGl0aWVzOiBMaXN0W3N0cl0gPSBOb25lLAogICAgZW50aXRpZXNfb3BlcmF0b3JfbWFwOiBkaWN0ID0gTm9uZSwKICAgIGlzX2Z1bGxfdGV4dDogYm9vbCA9IFRydWUsCikgLT4gVHVwbGVbc3RyLCBzdHIsIHN0cl06CiAgICAiIiIKICAgIFByb2Nlc3MgdGhlIHRleHQgb2Ygc3RyIHVzaW5nIHRoZSBtb2RlbC4KCiAgICA6cGFyYW0gdHh0OiAgICAgICAgICAgICAgICAgICBUZXh0IHRvIHByb2Nlc3MKICAgIDpwYXJhbSBtb2RlbDogICAgICAgICAgICAgICAgIE1vZGVsIHRvIHVzZSBmb3IgcHJvY2Vzc2luZwogICAgOnBhcmFtIGVudGl0aWVzOiAgICAgICAgICAgICAgRW50aXRpZXMgdG8gcmVjb2duaXplCiAgICA6cGFyYW0gZW50aXRpZXNfb3BlcmF0b3JfbWFwOiBUaGUgZW50aXR5X29wZXJhdG9yX21hcCBpcyBhIGRpY3Rpb25hcnkgdGhhdCBtYXBzIGVudGl0eSB0byBvcGVyYXRvciBuYW1lIGFuZCBvcGVyYXRvciBwYXJhbXMuCiAgICA6cGFyYW0gc2NvcmVfdGhyZXNob2xkOiAgICAgICBUaGUgc2NvcmUgdGhyZXNob2xkIHRvIHVzZSBmb3IgcmVjb2duaXRpb24KICAgIDpwYXJhbSBpc19mdWxsX3RleHQ6ICAgICAgICAgIFdoZXRoZXIgdG8gcmV0dXJuIHRoZSBmdWxsIHRleHQgb3IganVzdCB0aGUgYW5ub3RhdGVkIHRleHQKCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKCiAgICAgICAgICAgICAgKiB0aGUgYW5vbnltaXplZCB0ZXh0CiAgICAgICAgICAgICAgKiB0aGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMKICAgICIiIgoKICAgICMgZ2V0IHRoZSBhbmFseXplciBlbmdpbmUKCiAgICBhbmFseXplciA9IG1vZGVsCgogICAgIyBhbmFseXplIHRoZSB0ZXh0IHRoYXQgY2FuIGJlIHVzZWQgZm9yIGFub255bWl6YXRpb24KICAgIHJlc3VsdHMgPSBhbmFseXplci5hbmFseXplKAogICAgICAgIHRleHQ9dGV4dCwKICAgICAgICBsYW5ndWFnZT0iZW4iLAogICAgICAgIGVudGl0aWVzPWVudGl0aWVzLAogICAgICAgIHNjb3JlX3RocmVzaG9sZD1zY29yZV90aHJlc2hvbGQsCiAgICAgICAgcmV0dXJuX2RlY2lzaW9uX3Byb2Nlc3M9VHJ1ZSwKICAgICkKCiAgICAjIGFub255bWl6ZSB0aGUgdGV4dCwgcmVwbGFjZSB0aGUgcGlpIGVudGl0aWVzIHdpdGggdGhlIGxhYmVscwogICAgYW5vbnltaXplZF90ZXh0ID0gX2Fub255bWl6ZSh0ZXh0LCByZXN1bHRzLCBlbnRpdGllc19vcGVyYXRvcl9tYXAsIGlzX2Z1bGxfdGV4dCkKCiAgICByZXR1cm4gYW5vbnltaXplZF90ZXh0LCByZXN1bHRzCgoKZGVmIF9nZXRfc2luZ2xlX2h0bWwoCiAgICB0ZXh0OiBzdHIsIHJlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUKKToKICAgICIiIgogICAgR2VuZXJhdGUgdGhlIGh0bWwgZm9yIGEgc2luZ2xlIHR4dCBmaWxlLgoKICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgIFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgIDpwYXJhbSByZXN1bHRzOiAgICAgIFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KICAgIDpwYXJhbSBpc19mdWxsX2h0bWw6IFdoZXRoZXIgZ2VuZXJhdGUgZnVsbCBodG1sIG9yIG5vdC4KCiAgICA6cmV0dXJuczogVGhlIGh0bWwgc3RyaW5nIGZvciBhIHNpbmdsZSB0eHQgZmlsZS4KICAgICIiIgogICAgIyBjb252ZXJ0IHRoZSByZXN1bHRzIHRvIHRva2VucyB0byBnZW5lcmF0ZSB0aGUgaHRtbAogICAgdG9rZW5zID0gX2Fubm90YXRlKHRleHQsIHJlc3VsdHMsIGlzX2Z1bGxfaHRtbCkKICAgIGh0bWwgPSBhdF91dGlsLmdldF9hbm5vdGF0ZWRfaHRtbCgqdG9rZW5zKQoKICAgICMgYXZvaWQgdGhlIGVycm9yIGR1cmluZyByZW5kZXJpbmcgb2YgdGhlIFxuIGluIHRoZSBodG1sCiAgICBiYWNrc2xhc2hfY2hhciA9ICJcXCIKCiAgICBodG1sX3N0ciA9IGYiPHA+e2h0bWwucmVwbGFjZSgne2JhY2tzbGFzaF9jaGFyfW4nLCAnPGJyPicpfTwvcD4iCgogICAgcmV0dXJuIGh0bWxfc3RyCgoKZGVmIF9nZXRfc2luZ2xlX2pzb24ocmVzdWx0czogTGlzdFtwYS5SZWNvZ25pemVyUmVzdWx0XSwgaXNfZnVsbF9yZXBvcnQ6IGJvb2wgPSBUcnVlKToKICAgICIiIgogICAgR2VuZXJhdGUgdGhlIGpzb24gZm9yIGEgc2luZ2xlIHR4dCBmaWxlLgoKICAgIDpwYXJhbSByZXN1bHRzOiAgICAgICAgVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIGFuYWx5c2lzLgogICAgOnBhcmFtIGlzX2Z1bGxfcmVwb3J0OiBXaGV0aGVyIGdlbmVyYXRlIGZ1bGwganNvbiBvciBub3QuCgogICAgOnJldHVybnM6IFRoZSBqc29uIHN0cmluZyBmb3IgYSBzaW5nbGUgdHh0IGZpbGUuCiAgICAiIiIKICAgICMgZ2VuZXJhdGUgdGhlIHN0YXRzIHJlcG9ydCBpZiBuZWVkZWQKICAgIGlmIG5vdCBpc19mdWxsX3JlcG9ydDoKICAgICAgICBzdGF0cyA9IFtdCiAgICAgICAgIyBhZGQgdGhlIHNpbXBsaWZ5IHN0YXRzIGxvZ2ljIGhlcmUKICAgICAgICBmb3IgaXRlbSBpbiByZXN1bHRzOgogICAgICAgICAgICBpdGVtLmFuYWx5c2lzX2V4cGxhbmF0aW9uID0gTm9uZQogICAgICAgICAgICBzdGF0cy5hcHBlbmQoaXRlbSkKICAgIGVsc2U6CiAgICAgICAgc3RhdHMgPSByZXN1bHRzCgogICAgcmV0dXJuIHN0YXRzCgoKZGVmIF9nZXRfYWxsX2h0bWwoCiAgICB0eHRfY29udGVudDogZGljdCwKICAgIHJlc19kaWN0OiBkaWN0LAogICAgaXNfZnVsbF9odG1sOiBib29sID0gVHJ1ZSwKKToKICAgICIiIgogICAgR2VuZXJhdGUgdGhlIGh0bWwgZm9yIGFsbCB0eHQgZmlsZXMuCgogICAgOnBhcmFtIHR4dF9jb250ZW50OiAgVGhlIGRpY3Rpb25hcnkgb2YgdHh0IGZpbGUgbmFtZSBhbmQgY29udGVudC4KICAgIDpwYXJhbSByZXNfZGljdDogICAgIFRoZSBkaWN0aW9uYXJ5IG9mIHR4dCBmaWxlIG5hbWUgYW5kIHRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KICAgIDpwYXJhbSBpc19mdWxsX2h0bWw6IFdoZXRoZXIgZ2VuZXJhdGUgZnVsbCBodG1sIG9yIG5vdC4KCiAgICA6cmV0dXJuczogVGhlIGh0bWwgc3RyaW5nIGZvciBhbGwgdHh0IGZpbGVzLgoKICAgICIiIgogICAgIyBUaGVzZSBhcmUgcGxhY2Vob2xkZXIgZm9yIHRoZSBodG1sIHN0cmluZwogICAgaHRtbF9pbmRleCA9ICI8aHRtbD48aGVhZD48dGl0bGU+SGlnaGxpZ2h0ZWQgUGlpIEVudGl0aWVzPC90aXRsZT48L2hlYWQ+PGJvZHk+PGgxPkhpZ2hsaWdodGVkIFBpaSBFbnRpdGllczwvaDE+PHVsPiIKICAgIGh0bWxfY29udGVudCA9ICIiCiAgICBmb3IgdHh0X2ZpbGUsIHJlc3VsdHMgaW4gcmVzX2RpY3QuaXRlbXMoKToKICAgICAgICB0eHQgPSB0eHRfY29udGVudFt0eHRfZmlsZV0KICAgICAgICBodG1sX2luZGV4ICs9IGYiPGxpPjxhIGhyZWY9JyN7dHh0X2ZpbGV9Jz57dHh0X2ZpbGV9PC9hPjwvbGk+IgogICAgICAgIGh0bWxfY29udGVudCArPSBmIjxsaT48aDI+e3R4dF9maWxlfTwvaDI+PHA+e19nZXRfc2luZ2xlX2h0bWwodHh0LCByZXN1bHRzLCBpc19mdWxsX2h0bWwpfTwvcD48L2xpPiIKICAgIGh0bWxfaW5kZXggKz0gIjwvdWw+IgogICAgaHRtbF9yZXMgPSBmIntodG1sX2luZGV4fXtodG1sX2NvbnRlbnR9PC9ib2R5PjwvaHRtbD4iCgogICAgcmV0dXJuIGh0bWxfcmVzCgoKZGVmIF9nZXRfYWxsX3JwdChyZXNfZGljdDogZGljdCwgaXNfZnVsbF9yZXBvcnQ6IGJvb2wgPSBUcnVlKToKICAgICIiIgogICAgR2VuZXJhdGUgdGhlIHN0YXRzIHJlcG9ydCBmb3IgYWxsIHR4dCBmaWxlcy4KCiAgICA6cGFyYW0gcmVzX2RpY3Q6ICAgICAgIFRoZSBkaWN0aW9uYXJ5IG9mIHR4dCBmaWxlIG5hbWUgYW5kIHRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KICAgIDpwYXJhbSBpc19mdWxsX3JlcG9ydDogV2hldGhlciBnZW5lcmF0ZSBmdWxsIHJlcG9ydCBvciBub3QuCgogICAgOnJldHVybnM6IFRoZSBzdGF0cyByZXBvcnQgZm9yIGFsbCB0eHQgZmlsZXMuCiAgICAiIiIKICAgICMgVGhlc2UgYXJlIHBsYWNlaG9sZGVyIGZvciB0aGUganNvbiByZXBvcnQKICAgIHN0YXRzX2RpY3QgPSB7fQogICAgZm9yIHR4dF9maWxlLCByZXN1bHRzIGluIHJlc19kaWN0Lml0ZW1zKCk6CiAgICAgICAgbmV3X3N0YXRzID0gW10KICAgICAgICBmb3IgaXRlbSBpbiBfZ2V0X3NpbmdsZV9qc29uKHJlc3VsdHMsIGlzX2Z1bGxfcmVwb3J0KToKICAgICAgICAgICAgaWYgaXNfZnVsbF9yZXBvcnQ6CiAgICAgICAgICAgICAgICBpdGVtLmFuYWx5c2lzX2V4cGxhbmF0aW9uID0gaXRlbS5hbmFseXNpc19leHBsYW5hdGlvbi50b19kaWN0KCkKICAgICAgICAgICAgICAgIG5ld19zdGF0cy5hcHBlbmQoaXRlbS50b19kaWN0KCkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0bXBfZGljdCA9IGl0ZW0udG9fZGljdCgpCiAgICAgICAgICAgICAgICB0bXBfZGljdC5wb3AoImFuYWx5c2lzX2V4cGxhbmF0aW9uIikKICAgICAgICAgICAgICAgIHRtcF9kaWN0LnBvcCgicmVjb2duaXRpb25fbWV0YWRhdGEiKQogICAgICAgICAgICAgICAgbmV3X3N0YXRzLmFwcGVuZCh0bXBfZGljdCkKICAgICAgICBzdGF0c19kaWN0W3R4dF9maWxlXSA9IG5ld19zdGF0cwogICAgcmV0dXJuIHN0YXRzX2RpY3QKCgpkZWYgcmVjb2duaXplX3BpaSgKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgaW5wdXRfcGF0aDogc3RyLAogICAgb3V0cHV0X3BhdGg6IHN0ciwKICAgIG91dHB1dF9zdWZmaXg6IHN0ciwKICAgIGh0bWxfa2V5OiBzdHIsCiAgICBzY29yZV90aHJlc2hvbGQ6IGZsb2F0LAogICAgZW50aXRpZXM6IExpc3RbCiAgICAgICAgc3RyCiAgICBdID0gTm9uZSwgICMgTGlzdCBvZiBlbnRpdGllcyB0byByZWNvZ25pemUsIGRlZmF1bHQgaXMgcmVjb2duaXppbmcgYWxsCiAgICBlbnRpdHlfb3BlcmF0b3JfbWFwOiBkaWN0ID0gTm9uZSwKICAgIG1vZGVsOiBzdHIgPSBOb25lLAogICAgZ2VuZXJhdGVfanNvbjogYm9vbCA9IFRydWUsCiAgICBnZW5lcmF0ZV9odG1sOiBib29sID0gVHJ1ZSwKICAgIGlzX2Z1bGxfdGV4dDogYm9vbCA9IFRydWUsCiAgICBpc19mdWxsX2h0bWw6IGJvb2wgPSBUcnVlLAogICAgaXNfZnVsbF9yZXBvcnQ6IGJvb2wgPSBUcnVlLAopIC0+IFR1cGxlW3BhdGhsaWIuUGF0aCwgZGljdCwgZGljdF06CiAgICAiIiIKICAgIFdhbGsgdGhyb3VnaCB0aGUgaW5wdXQgcGF0aCwgcmVjb2duaXplIFBJSSBpbiB0ZXh0IGFuZCBzdG9yZSB0aGUgYW5vbnltaXplZCB0ZXh0IGluIHRoZSBvdXRwdXQgcGF0aC4gR2VuZXJhdGUgdGhlIGh0bWwgd2l0aCBkaWZmZXJlbnQgY29sb3JzIGZvciBlYWNoIGVudGl0eSwganNvbiByZXBvcnQgb2YgdGhlIGV4cGxhaW5hdGlvbi4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgIFRoZSBNTFJ1biBjb250ZXh0LiB0aGlzIGlzIG5lZWRlZCBmb3IgbG9nIHRoZSBhcnRpZmFjdHMuCiAgICA6cGFyYW0gaW5wdXRfcGF0aDogICAgICAgICAgIFRoZSBpbnB1dCBwYXRoIG9mIHRoZSB0ZXh0IGZpbGVzIG5lZWRzIHRvIGJlIGFuYWx5emllZC4KICAgIDpwYXJhbSBvdXRwdXRfcGF0aDogICAgICAgICAgVGhlIG91dHB1dCBwYXRoIHRvIHN0b3JlIHRoZSBhbm9ueW1pemVkIHRleHQuCiAgICA6cGFyYW0gb3V0cHV0X3N1ZmZpeDogICAgICAgIFRoZSBzdXJmaXggb2Ygb3V0cHV0IGtleSBmb3IgdGhlIGFub255bWl6ZWQgdGV4dC4gZm9yIGV4YW1wbGUgaWYgdGhlIGlucHV0IGZpbGUgaXMgcGlpLnR4dCwgdGhlIG91dHB1dCBrZXkgaXMgYW5veW1pemVkLCB0aGUgb3V0cHV0IGZpbGUgbmFtZSB3aWxsIGJlIHBpaV9hbm9ueW1pemVkLnR4dC4KICAgIDpwYXJhbSBodG1sX2tleTogICAgICAgICAgICAgVGhlIGh0bWwga2V5IGZvciB0aGUgYXJ0aWZhY3QuCiAgICA6cGFyYW0gc2NvcmVfdGhyZXNob2xkOiAgICAgIFRoZSBzY29yZSB0aHJlc2hvbGQgdG8gbWFyayB0aGUgcmVjb2duaXRpb24gYXMgdHJ1c3RlZC4KICAgIDpwYXJhbSBlbnRpdGllczogICAgICAgICAgICAgVGhlIGxpc3Qgb2YgZW50aXRpZXMgdG8gcmVjb2duaXplLgogICAgOnBhcmFtIGVudGl0eV9vcGVyYXRvcl9tYXA6ICBUaGUgbWFwIG9mIGVudGl0eSB0byBvcGVyYXRvciAobWFzaywgcmVkYWN0LCByZXBsYWNlLCBrZWVwLCBoYXNoLCBhbmQgaXRzIHBhcmFtcykKICAgIDpwYXJhbSBtb2RlbDogICAgICAgICAgICAgICAgVGhlIG1vZGVsIHRvIHVzZS4gQ2FuIGJlICJzcGFjeSIsICJmbGFpciIsICJwYXR0ZXJuIiBvciAid2hvbGUiLgogICAgOnBhcmFtIGdlbmVyYXRlX2pzb246ICAgICAgICBXaGV0aGVyIHRvIGdlbmVyYXRlIHRoZSBqc29uIHJlcG9ydCBvZiB0aGUgZXhwbGFpbmF0aW9uLgogICAgOnBhcmFtIGdlbmVyYXRlX2h0bWw6ICAgICAgICBXaGV0aGVyIHRvIGdlbmVyYXRlIHRoZSBodG1sIHJlcG9ydCBvZiB0aGUgZXhwbGFpbmF0aW9uLgogICAgOnBhcmFtIGlzX2Z1bGxfdGV4dDogICAgICAgICBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCB0ZXh0IG9yIG9ubHkgdGhlIG1hc2tlZCB0ZXh0LgogICAgOnBhcmFtIGlzX2Z1bGxfaHRtbDogICAgICAgICBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCBodG1sIG9yIGp1c3QgdGhlIGFubm90YXRlZCB0ZXh0CiAgICA6cGFyYW0gaXNfZnVsbF9yZXBvcnQ6ICAgICAgIFdoZXRoZXIgdG8gcmV0dXJuIHRoZSBmdWxsIHJlcG9ydCBvciBqdXN0IHRoZSBzY29yZSBhbmQgc3RhcnQsIGVuZCBpbmRleAoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgoKICAgICAgICAgICAgICAqIFBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkKICAgICAgICAgICAgICAqIFRoZSBqc29uIHJlcG9ydCBvZiB0aGUgZXhwbGFpbmF0aW9uIChpZiBnZW5lcmF0ZV9qc29uIGlzIFRydWUpCiAgICAgICAgICAgICAgKiBBIGRpY3Rpb25hcnkgb2YgZXJyb3JzIGZpbGVzIHRoYXQgd2VyZSBub3QgcHJvY2Vzc2VkCgogICAgIiIiCgogICAgIyBTZXQgb3V0cHV0IGRpcmVjdG9yeQogICAgaWYgb3V0cHV0X3BhdGggaXMgTm9uZToKICAgICAgICBvdXRwdXRfcGF0aCA9IHRlbXBmaWxlLm1rZHRlbXAoKQoKICAgICMgQ3JlYXRlIHRoZSBvdXRwdXQgZGlyZWN0b3J5OgogICAgb3V0cHV0X2RpcmVjdG9yeSA9IHBhdGhsaWIuUGF0aChvdXRwdXRfcGF0aCkKICAgIGlmIG5vdCBvdXRwdXRfZGlyZWN0b3J5LmV4aXN0cygpOgogICAgICAgIG91dHB1dF9kaXJlY3RvcnkubWtkaXIoKQoKICAgIHR4dF9maWxlc19kaXJlY3RvcnkgPSBwYXRobGliLlBhdGgoaW5wdXRfcGF0aCkKICAgIGVycm9ycyA9IHt9CgogICAgcmVzX2RpY3QgPSB7fQogICAgdHh0X2NvbnRlbnQgPSB7fQogICAgIyBMb2FkIHRoZSBtb2RlbDoKICAgIHRyeToKICAgICAgICBhbmFseXplciA9IF9nZXRfYW5hbHl6ZXJfZW5naW5lKG1vZGVsLCBlbnRpdGllcykKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcnNbIm1vZGVsIl0gPSBzdHIoZSkKICAgICAgICBsb2dnZXIuZXJyb3IoZiJFcnJvciB3aGVuIGdldCB0aGUgbW9kZWw6IHtlfSIpCgogICAgbG9nZ2VyLmluZm8oIk1vZGVsIGxvYWRlZCIpCiAgICAjIEdvIG92ZXIgdGhlIHRleHQgZmlsZXMgaW4gdGhlIGlucHV0IHBhdGgsIGFuYWx5emUgYW5kIGFub255bWl6ZSB0aGVtOgogICAgZm9yIGksIHR4dF9maWxlIGluIGVudW1lcmF0ZSgKICAgICAgICB0cWRtKAogICAgICAgICAgICBsaXN0KHR4dF9maWxlc19kaXJlY3RvcnkuZ2xvYigiKi50eHQiKSksCiAgICAgICAgICAgIGRlc2M9IlByb2Nlc3NpbmcgZmlsZXMiLAogICAgICAgICAgICB1bml0PSJmaWxlIiwKICAgICAgICApCiAgICApOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBMb2FkIHRoZSBzdHIgZnJvbSB0aGUgdGV4dCBmaWxlCiAgICAgICAgICAgIHRleHQgPSB0eHRfZmlsZS5yZWFkX3RleHQoKQogICAgICAgICAgICB0eHRfY29udGVudFtzdHIodHh0X2ZpbGUpXSA9IHRleHQKICAgICAgICAgICAgIyBQcm9jZXNzIHRoZSB0ZXh0IHRvIHJlY29naW56ZSB0aGUgcGlpIGVudGl0aWVzIGluIGl0CiAgICAgICAgICAgIGFub255bWl6ZWRfdGV4dCwgcmVzdWx0cyA9IF9wcm9jZXNzKAogICAgICAgICAgICAgICAgdGV4dCwKICAgICAgICAgICAgICAgIGFuYWx5emVyLAogICAgICAgICAgICAgICAgZW50aXRpZXMsCiAgICAgICAgICAgICAgICBlbnRpdHlfb3BlcmF0b3JfbWFwLAogICAgICAgICAgICAgICAgc2NvcmVfdGhyZXNob2xkLAogICAgICAgICAgICAgICAgaXNfZnVsbF90ZXh0LAogICAgICAgICAgICApCiAgICAgICAgICAgIHJlc19kaWN0W3N0cih0eHRfZmlsZSldID0gcmVzdWx0cwogICAgICAgICAgICAjIFN0b3JlIHRoZSBhbm9ueW1pemVkIHRleHQgaW4gdGhlIG91dHB1dCBwYXRoCiAgICAgICAgICAgIG91dHB1dF9maWxlID0gKAogICAgICAgICAgICAgICAgb3V0cHV0X2RpcmVjdG9yeQogICAgICAgICAgICAgICAgLyBmIntzdHIodHh0X2ZpbGUucmVsYXRpdmVfdG8odHh0X2ZpbGVzX2RpcmVjdG9yeSkpLnNwbGl0KCcuJylbMF19X3tvdXRwdXRfc3VmZml4fS50eHQiCiAgICAgICAgICAgICkKICAgICAgICAgICAgb3V0cHV0X2ZpbGUucGFyZW50Lm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAgICAgd2l0aCBvcGVuKG91dHB1dF9maWxlLCAidyIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGFub255bWl6ZWRfdGV4dCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcnNbc3RyKHR4dF9maWxlKV0gPSBzdHIoZSkKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRXJyb3IgcHJvY2Vzc2luZyB7dHh0X2ZpbGV9OiB7ZX0iKQogICAgaWYgZ2VuZXJhdGVfaHRtbDoKICAgICAgICAjIEdlbmVyYXRlIHRoZSBodG1sIHJlcG9ydAogICAgICAgIGh0bWxfcmVzID0gX2dldF9hbGxfaHRtbCh0eHRfY29udGVudCwgcmVzX2RpY3QsIGlzX2Z1bGxfaHRtbCkKICAgICAgICAjIFN0b3JlIHRoZSBodG1sIHJlcG9ydCBpbiB0aGUgY29udGV4dAogICAgICAgIGFydGlfaHRtbCA9IG1scnVuLmFydGlmYWN0cy5BcnRpZmFjdChib2R5PWh0bWxfcmVzLCBmb3JtYXQ9Imh0bWwiLCBrZXk9aHRtbF9rZXkpCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoYXJ0aV9odG1sKQogICAgaWYgZ2VuZXJhdGVfanNvbjoKICAgICAgICAjIEdlbmVyYXRlIHRoZSBqc29uIHJlcG9ydAogICAgICAgIGpzb25fcmVzID0gX2dldF9hbGxfcnB0KHJlc19kaWN0LCBpc19mdWxsX3JlcG9ydCkKICAgICAgICByZXR1cm4gb3V0cHV0X3BhdGgsIGpzb25fcmVzLCBlcnJvcnMKICAgIHJldHVybiBvdXRwdXRfcGF0aCwgZXJyb3JzCg==
    commands:
    - python -m pip install nltk pandas presidio-anonymizer presidio-analyzer torch
      flair@git+https://github.com/flairNLP/flair.git@d4ed67bf663e4066517f00397412510d90043653
      st-annotated-text https://huggingface.co/beki/en_spacy_pii_distilbert/resolve/main/en_spacy_pii_distilbert-any-py3-none-any.whl
    code_origin: git@github.com-personal:pengwei715/functions.git#5468a7acb9b9fde12832e27daac2624f43746ee7:/Users/Peng_Wei/work/mlrun_related/functions/pii_recognizer/pii_recognizer.py
    origin_filename: /Users/Peng_Wei/work/mlrun_related/functions/pii_recognizer/pii_recognizer.py
  entry_points:
    recognize_pii:
      name: recognize_pii
      doc: Walk through the input path, recognize PII in text and store the anonymized
        text in the output path. Generate the html with different colors for each
        entity, json report of the explaination.
      parameters:
      - name: context
        type: MLClientCtx
        doc: The MLRun context. this is needed for log the artifacts.
        default: ''
      - name: input_path
        type: str
        doc: The input path of the text files needs to be analyzied.
        default: ''
      - name: output_path
        type: str
        doc: The output path to store the anonymized text.
        default: ''
      - name: output_suffix
        type: str
        doc: The surfix of output key for the anonymized text. for example if the
          input file is pii.txt, the output key is anoymized, the output file name
          will be pii_anonymized.txt.
        default: ''
      - name: html_key
        type: str
        doc: The html key for the artifact.
        default: ''
      - name: score_threshold
        type: float
        doc: The score threshold to mark the recognition as trusted.
        default: ''
      - name: entities
        type: List[str]
        doc: The list of entities to recognize.
        default: null
      - name: entity_operator_map
        type: dict
        doc: The map of entity to operator (mask, redact, replace, keep, hash, and
          its params)
        default: null
      - name: model
        type: str
        doc: The model to use. Can be "spacy", "flair", "pattern" or "whole".
        default: null
      - name: generate_json
        type: bool
        doc: Whether to generate the json report of the explaination.
        default: true
      - name: generate_html
        type: bool
        doc: Whether to generate the html report of the explaination.
        default: true
      - name: is_full_text
        type: bool
        doc: Whether to return the full text or only the masked text.
        default: true
      - name: is_full_html
        type: bool
        doc: Whether to return the full html or just the annotated text
        default: true
      - name: is_full_report
        type: bool
        doc: Whether to return the full report or just the score and start, end index
        default: true
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 850
  description: This function is used to recognize PII in a directory of text files
  default_handler: recognize_pii
  disable_auto_mount: false
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
