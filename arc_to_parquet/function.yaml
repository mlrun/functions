kind: job
metadata:
  name: arc-to-parquet
  tag: latest
  hash: 726cff9c4175487cf7f47b5c3f81e9fe910e73b8
  project: ''
  labels:
    author: yjb
  categories:
  - filesutils
  - retrieve
spec:
  command: ''
  args: []
  image: mlrun/ml-base
  env: []
  default_handler: arc_to_parquet
  entry_points:
    arc_to_parquet:
      name: arc_to_parquet
      doc: 'Open a file/object archive and save as a parquet file.


        Partitioning requires precise specification of column types.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: function context
      - name: archive_url
        type: Union[str, DataItem]
        doc: any valid string path consistent with the path variable of pandas.read_csv,
          including strings as file paths, as urls,  pathlib.Path objects, etc...
      - name: header
        type: Optional[List[str]]
        doc: column names
      - name: chunksize
        type: int
        doc: (0) row size retrieved per iteration
        default: 10000
      - name: dtype
      - name: encoding
        type: str
        default: latin-1
      - name: key
        type: str
        doc: key in artifact store (when log_data=True)
        default: data
      - name: dataset
        type: Optional[str]
        doc: (None) if not None then "target_path/dataset" is folder for partitioned
          files
      - name: part_cols
        doc: ([]) list of partitioning columns
      - name: file_ext
        type: str
        doc: (parquet) csv/parquet file extension
        default: parquet
      outputs: []
      lineno: 27
  description: retrieve remote archive, open and save as parquet
  image_pull_policy: Always
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI0IDIyOjIwCgoKaW1wb3J0IHNzbAoKdHJ5OgogICAgX2NyZWF0ZV91bnZlcmlmaWVkX2h0dHBzX2NvbnRleHQgPSBzc2wuX2NyZWF0ZV91bnZlcmlmaWVkX2NvbnRleHQKZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHBhc3MKZWxzZToKICAgIHNzbC5fY3JlYXRlX2RlZmF1bHRfaHR0cHNfY29udGV4dCA9IF9jcmVhdGVfdW52ZXJpZmllZF9odHRwc19jb250ZXh0CgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IHB5YXJyb3cucGFycXVldCBhcyBwcQppbXBvcnQgcHlhcnJvdyBhcyBwYQpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wLCBsb2FkCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QsIFRhYmxlQXJ0aWZhY3QKCmZyb20gdHlwaW5nIGltcG9ydCBJTywgQW55U3RyLCBVbmlvbiwgTGlzdCwgT3B0aW9uYWwKCmRlZiBhcmNfdG9fcGFycXVldCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgYXJjaGl2ZV91cmw6IFVuaW9uW3N0ciwgRGF0YUl0ZW1dLAogICAgaGVhZGVyOiBPcHRpb25hbFtMaXN0W3N0cl1dID0gTm9uZSwKICAgIGNodW5rc2l6ZTogaW50ID0gMTBfMDAwLAogICAgZHR5cGU9Tm9uZSwKICAgIGVuY29kaW5nOiBzdHIgPSAibGF0aW4tMSIsCiAgICBrZXk6IHN0ciA9ICJkYXRhIiwKICAgIGRhdGFzZXQ6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgcGFydF9jb2xzID0gW10sCiAgICBmaWxlX2V4dDogc3RyID0gJ3BhcnF1ZXQnCikgLT4gTm9uZToKICAgICIiIk9wZW4gYSBmaWxlL29iamVjdCBhcmNoaXZlIGFuZCBzYXZlIGFzIGEgcGFycXVldCBmaWxlLgoKICAgIFBhcnRpdGlvbmluZyByZXF1aXJlcyBwcmVjaXNlIHNwZWNpZmljYXRpb24gb2YgY29sdW1uIHR5cGVzLgoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBhcmNoaXZlX3VybDogIGFueSB2YWxpZCBzdHJpbmcgcGF0aCBjb25zaXN0ZW50IHdpdGggdGhlIHBhdGggdmFyaWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgIG9mIHBhbmRhcy5yZWFkX2NzdiwgaW5jbHVkaW5nIHN0cmluZ3MgYXMgZmlsZSBwYXRocywgYXMgdXJscywgCiAgICAgICAgICAgICAgICAgICAgICAgICBwYXRobGliLlBhdGggb2JqZWN0cywgZXRjLi4uCiAgICA6cGFyYW0gaGVhZGVyOiAgICAgICBjb2x1bW4gbmFtZXMKICAgIDpwYXJhbSBjaHVua3NpemU6ICAgICgwKSByb3cgc2l6ZSByZXRyaWV2ZWQgcGVyIGl0ZXJhdGlvbgogICAgOnBhcmFtIGR0eXBlICAgICAgICAgZGVzdGluYXRpb24gZGF0YSB0eXBlIG9mIHNwZWNpZmllZCBjb2x1bW5zCiAgICA6cGFyYW0gZW5jb2RpbmcgICAgICAoImxhdGluLTgiKSBmaWxlIGVuY29kaW5nCiAgICA6cGFyYW0ga2V5OiAgICAgICAgICBrZXkgaW4gYXJ0aWZhY3Qgc3RvcmUgKHdoZW4gbG9nX2RhdGE9VHJ1ZSkKICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgIChOb25lKSBpZiBub3QgTm9uZSB0aGVuICJ0YXJnZXRfcGF0aC9kYXRhc2V0IgogICAgICAgICAgICAgICAgICAgICAgICAgaXMgZm9sZGVyIGZvciBwYXJ0aXRpb25lZCBmaWxlcwogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgKHBhcnF1ZXQpIGNzdi9wYXJxdWV0IGZpbGUgZXh0ZW5zaW9uCiAgICA6cGFyYW0gcGFydF9jb2xzOiAgICAoW10pIGxpc3Qgb2YgcGFydGl0aW9uaW5nIGNvbHVtbnMKCiAgICAiIiIKICAgIGJhc2VfcGF0aCA9IGNvbnRleHQuYXJ0aWZhY3RfcGF0aAogICAgb3MubWFrZWRpcnMoYmFzZV9wYXRoLCBleGlzdF9vaz1UcnVlKQoKICAgIGlmIGRhdGFzZXQgaXMgbm90IE5vbmU6CiAgICAgICAgZGVzdF9wYXRoID0gb3MucGF0aC5qb2luKGJhc2VfcGF0aCwgZGF0YXNldCkKICAgICAgICBleGlzdHMgPSBvcy5wYXRoLmlzZGlyKGRlc3RfcGF0aCkKICAgIGVsc2U6CiAgICAgICAgZGVzdF9wYXRoID0gb3MucGF0aC5qb2luKGJhc2VfcGF0aCwga2V5K2YiLntmaWxlX2V4dH0iKQogICAgICAgIGV4aXN0cyA9IG9zLnBhdGguaXNmaWxlKGRlc3RfcGF0aCkKCiAgICBpZiBub3QgZXhpc3RzOgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oImRlc3RpbmF0aW9uIGZpbGUgZG9lcyBub3QgZXhpc3QsIGRvd25sb2FkaW5nIikKICAgICAgICBwcXdyaXRlciA9IE5vbmUKICAgICAgICBmb3IgaSwgZGYgaW4gZW51bWVyYXRlKHBkLnJlYWRfY3N2KGFyY2hpdmVfdXJsLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rc2l6ZT1jaHVua3NpemUsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXM9aGVhZGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2Rpbmc9ZW5jb2RpbmcsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHR5cGU9ZHR5cGUpKToKICAgICAgICAgICAgdGFibGUgPSBwYS5UYWJsZS5mcm9tX3BhbmRhcyhkZikKICAgICAgICAgICAgaWYgaSA9PSAwOgogICAgICAgICAgICAgICAgaWYgZGF0YXNldDoKICAgICAgICAgICAgICAgICAgICBwcS5QYXJxdWV0V3JpdGVyKG9zLnBhdGguam9pbihiYXNlX3BhdGgsZiJoZWFkZXItb25seS57ZmlsZV9leHR9IiksIHRhYmxlLnNjaGVtYSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHF3cml0ZXIgPSBwcS5QYXJxdWV0V3JpdGVyKGRlc3RfcGF0aCwgdGFibGUuc2NoZW1hKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoImhlYWRlciIsIGxvY2FsX3BhdGg9ZiJoZWFkZXItb25seS57ZmlsZV9leHR9IikKICAgICAgICAgICAgaWYgZGF0YXNldDoKICAgICAgICAgICAgICAgIHBxLndyaXRlX3RvX2RhdGFzZXQodGFibGUsIHJvb3RfcGF0aD1kZXN0X3BhdGgsIHBhcnRpdGlvbl9jb2xzPXBhcnRpdGlvbl9jb2xzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHF3cml0ZXIud3JpdGVfdGFibGUodGFibGUpCiAgICAgICAgaWYgcHF3cml0ZXI6CiAgICAgICAgICAgIHBxd3JpdGVyLmNsb3NlKCkKCiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInNhdmVkIHRhYmxlIHRvIHtkZXN0X3BhdGh9IikKICAgIGVsc2U6CiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygiZGVzdGluYXRpb24gZmlsZSBhbHJlYWR5IGV4aXN0cyIpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChrZXksIGxvY2FsX3BhdGg9a2V5K2YiLntmaWxlX2V4dH0iKQoK
    commands: []
    code_origin: https://git-codecommit.us-east-1.amazonaws.com/v1/repos/functions#5f56581e3fc4d0c162157a36ce56c3598032ce0b:arc_to_parquet.ipynb
