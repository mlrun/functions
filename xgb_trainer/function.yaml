kind: job
metadata:
  name: xgb-trainer
  tag: ''
  hash: 5e6f83892ba98844bd17aa21f990670007825a9b
  project: ''
  labels:
    author: yjb
    framework: xgboost
  categories:
  - training
  - ml
  - experimental
spec:
  command: ''
  args: []
  image: yjbds/ml-models:0.4.8
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train an xgboost model.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_type
        type: str
        doc: the model type to train, "classifier", "regressor"...
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: encode_cols
        type: dict
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7fdd7c312d30>
      - name: imbal_vec
        doc: ([]) vector of class weights seen in sample
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.25
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: model_evaluator
        doc: (None) a custom model evaluator can be specified
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: destination subfolder for model artifacts
        default: models
      - name: plots_dest
        type: str
        doc: destination subfolder for plot artifacts
        default: plots
      - name: eval_metrics
        doc: (["error", "auc"]) learning curve metrics
        default: error
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
      outputs: []
      lineno: 58
  description: train multiple model types using xgboost
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpmcm9tIG1sdXRpbHMgaW1wb3J0IChnZXRfc2FtcGxlLAogICAgICAgICAgICAgICAgICAgICBnZXRfc3BsaXRzLAogICAgICAgICAgICAgICAgICAgICBnZW5fc2tsZWFybl9tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgY3JlYXRlX2NsYXNzLCAKICAgICAgICAgICAgICAgICAgICAgZXZhbF9jbGFzc19tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgbG9nX21vZGVsKQoKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0LCBUYWJsZUFydGlmYWN0Cgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBvcwpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdAoKZGVmIF9nZW5feGdiX21vZGVsKG1vZGVsX3R5cGU6IHN0ciwgeGdiX3BhcmFtczogZGljdCk6CiAgICAiIiJnZW5lcmF0ZSBhbiB4Z2Jvb3N0IG1vZGVsCiAgICAKICAgIE11bHRpcGxlIG1vZGVsIHR5cGVzIHRoYXQgY2FuIGJlIGVzdGltYXRlZCB1c2luZwogICAgdGhlIFhHQm9vc3QgU2Npa2l0LUxlYXJuIEFQSS4KICAgIAogICAgSW5wdXQgY2FuIGVpdGhlciBiZSBhIHByZWRlZmluZWQganNvbiBtb2RlbCBjb25maWd1cmF0aW9uIG9yIG9uZQogICAgb2YgdGhlIGZpdmUgeGdib29zdCBtb2RlbCB0eXBlczogImNsYXNzaWZpZXIiLCAicmVncmVzc29yIiwgInJhbmtlciIsCiAgICAicmZfY2xhc3NpZmllciIsIG9yICJyZl9yZWdyZXNzb3IiLgogICAgCiAgICBJbiBlaXRoZXIgY2FzZSBvbmUgY2FuIHBhc3MgaW4gYSBwYXJhbXMgZGljdCB0byBtb2RpZnkgZGVmYXVsdHMgdmFsdWVzLgogICAgCiAgICBCYXNlZCBvbiBgbWx1dGlscy5tb2RlbHMuZ2VuX3NrbGVhcm5fbW9kZWxgLCBzZWUgdGhlIGZ1bmN0aW9uCiAgICBgc2tsZWFybl9jbGFzc2lmaWVyYCBpbiB0aGlzIHJlcG9zaXRvcnkuCiAgICAKICAgIDpwYXJhbSBtb2RlbF90eXBlOiBvbmUgb2YgImNsYXNzaWZpZXIiLCAicmVncmVzc29yIiwKICAgICAgICAgICAgICAgICAgICAgICAicmFua2VyIiwgInJmX2NsYXNzaWZpZXIiLCBvcgogICAgICAgICAgICAgICAgICAgICAgInJmX3JlZ3Jlc3NvciIKICAgIDpwYXJhbSB4Z2JfcGFyYW1zOiBjbGFzcyBpbml0IHBhcmFtZXRlcnMKICAgICIiIgogICAgbXR5cGVzID0gewogICAgICAgICJjbGFzc2lmaWVyIiAgIDogInhnYm9vc3QuWEdCQ2xhc3NpZmllciIsCiAgICAgICAgInJlZ3Jlc3NvciIgICAgOiAieGdib29zdC5YR0JSZWdyZXNzb3IiLAogICAgICAgICJyYW5rZXIiICAgICAgIDogInhnYm9vc3QuWEdCUmFua2VyIiwKICAgICAgICAicmZfY2xhc3NpZmllciI6ICJ4Z2Jvb3N0LlhHQlJGQ2xhc3NpZmllciIsCiAgICAgICAgInJmX3JlZ3Jlc3NvciIgOiAieGdib29zdC5YR0JSRlJlZ3Jlc3NvciIKICAgIH0KICAgIGlmIG1vZGVsX3R5cGUuZW5kc3dpdGgoImpzb24iKToKICAgICAgICBtb2RlbF9jb25maWcgPSBtb2RlbF90eXBlCiAgICBlbGlmIG1vZGVsX3R5cGUgaW4gbXR5cGVzLmtleXMoKToKICAgICAgICBtb2RlbF9jb25maWcgPSBtdHlwZXNbbW9kZWxfdHlwZV0KICAgIGVsc2U6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJ1bnJlY29nbml6ZWQgbW9kZWwgdHlwZSwgc2VlIGhlbHAgZG9jdW1lbnRhdGlvbiIpCgogICAgcmV0dXJuIGdlbl9za2xlYXJuX21vZGVsKG1vZGVsX2NvbmZpZywgeGdiX3BhcmFtcykKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfdHlwZTogc3RyLAogICAgZGF0YXNldDogRGF0YUl0ZW0sCiAgICBsYWJlbF9jb2x1bW46IHN0ciA9ICJsYWJlbHMiLAogICAgZW5jb2RlX2NvbHM6IGRpY3QgPSB7fSwKICAgIHNhbXBsZTogaW50ID0gLTEsCiAgICBpbWJhbF92ZWMgPSBbXSwKICAgIHRlc3Rfc2l6ZTogZmxvYXQgPSAwLjI1LAogICAgdmFsaWRfc2l6ZTogZmxvYXQgPSAwLjc1LAogICAgbW9kZWxfZXZhbHVhdG9yID0gTm9uZSwKICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gMSwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAibW9kZWxzIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBldmFsX21ldHJpY3MgPSAiZXJyb3IiLAogICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IiwKICAgIG1vZGVsX3BrZ19maWxlOiBzdHIgPSAiIiwgICAgCikgLT4gTm9uZToKICAgICIiInRyYWluIGFuIHhnYm9vc3QgbW9kZWwuCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbF90eXBlOiAgICAgICAgdGhlIG1vZGVsIHR5cGUgdG8gdHJhaW4sICJjbGFzc2lmaWVyIiwgInJlZ3Jlc3NvciIuLi4KICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgKCJkYXRhIikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uOiAgICAgIGdyb3VuZC10cnV0aCAoeSkgbGFiZWxzCiAgICA6cGFyYW0gZW5jb2RlX2NvbHM6ICAgICAgIGRpY3Rpb25hcnkgb2YgbmFtZXMgYW5kIHByZWZpeGVzIGZvciBjb2x1bW5zIHRoYXQgYXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGhvdCBiZSBlbmNvZGVkLgogICAgOnBhcmFtIHNhbXBsZTogICAgICAgICAgICBTZWxlY3RzIHRoZSBmaXJzdCBuIHJvd3MsIG9yIHNlbGVjdCBhIHNhbXBsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydGluZyBmcm9tIHRoZSBmaXJzdC4gSWYgbmVnYXRpdmUgPC0xLCBzZWxlY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYSByYW5kb20gc2FtcGxlCiAgICA6cGFyYW0gaW1iYWxfdmVjOiAgICAgICAgIChbXSkgdmVjdG9yIG9mIGNsYXNzIHdlaWdodHMgc2VlbiBpbiBzYW1wbGUKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgICAgKDAuMDUpIHRlc3Qgc2V0IHNpemUKICAgIDpwYXJhbSB2YWxpZF9zaXplOiAgICAgICAgKDAuNzUpIE9uY2UgdGhlIHRlc3Qgc2V0IGhhcyBiZWVuIHJlbW92ZWQgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWluaW5nIHNldCBnZXRzIHRoaXMgcHJvcG9ydGlvbi4KICAgIDpwYXJhbSBtb2RlbF9ldmFsdWF0b3I6ICAgKE5vbmUpIGEgY3VzdG9tIG1vZGVsIGV2YWx1YXRvciBjYW4gYmUgc3BlY2lmaWVkCiAgICA6cGFyYW0gcmFuZG9tX3N0YXRlOiAgICAgICgxKSBza2xlYXJuIHJuZyBzZWVkCiAgICA6cGFyYW0gbW9kZWxzX2Rlc3Q6ICAgICAgIGRlc3RpbmF0aW9uIHN1YmZvbGRlciBmb3IgbW9kZWwgYXJ0aWZhY3RzCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgIGRlc3RpbmF0aW9uIHN1YmZvbGRlciBmb3IgcGxvdCBhcnRpZmFjdHMKICAgIDpwYXJhbSBldmFsX21ldHJpY3M6ICAgICAgKFsiZXJyb3IiLCAiYXVjIl0pIGxlYXJuaW5nIGN1cnZlIG1ldHJpY3MKICAgIDpwYXJhbSBmaWxlX2V4dDogICAgICAgICAgZm9ybWF0IGZvciB0ZXN0X3NldF9rZXkgaG9sZCBvdXQgZGF0YQogICAgIiIiCiAgICBtb2RlbHNfZGVzdCA9IG1vZGVsc19kZXN0IG9yICJtb2RlbHMiCiAgICBwbG90c19kZXN0ID0gcGxvdHNfZGVzdCBvciBmInBsb3RzL3tjb250ZXh0Lm5hbWV9IgogICAgCiAgICByYXcsIGxhYmVscywgaGVhZGVyID0gZ2V0X3NhbXBsZShkYXRhc2V0LCBzYW1wbGUsIGxhYmVsX2NvbHVtbikKICAgIAogICAgaWYgZW5jb2RlX2NvbHM6CiAgICAgICAgcmF3ID0gcGQuZ2V0X2R1bW1pZXMocmF3LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zPWxpc3QoZW5jb2RlX2NvbHMua2V5cygpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4PWxpc3QoZW5jb2RlX2NvbHMudmFsdWVzKCkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcm9wX2ZpcnN0PVRydWUpCiAgICAKICAgICh4dHJhaW4sIHl0cmFpbiksICh4dmFsaWQsIHl2YWxpZCksICh4dGVzdCwgeXRlc3QpID0gICAgICAgICBnZXRfc3BsaXRzKHJhdywgbGFiZWxzLCAzLCB0ZXN0X3NpemUsIDEtdmFsaWRfc2l6ZSwgcmFuZG9tX3N0YXRlKQogICAgCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KCJ0ZXN0LXNldCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGRmPXBkLmNvbmNhdChbeHRlc3QsIHl0ZXN0XSwgYXhpcz0xKSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKCiAgICBtb2RlbF9jb25maWcgPSBfZ2VuX3hnYl9tb2RlbChtb2RlbF90eXBlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpKQoKICAgIGlmIGxlbihpbWJhbF92ZWMpID09IDI6CiAgICAgICAgc2NhbGVfcG9zX3dlaWdodCA9IGltYmFsX3ZlY1swXS9pbWJhbF92ZWNbMV0KICAgICAgICBtb2RlbF9jb25maWdbIkNMQVNTIl0udXBkYXRlKHsic2NhbGVfcG9zX3dlaWdodCI6IHNjYWxlX3Bvc193ZWlnaHR9KQoKICAgIFhHQkJvb3N0Q2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCgogICAgbW9kZWwgPSBYR0JCb29zdENsYXNzKCoqbW9kZWxfY29uZmlnWyJDTEFTUyJdKQoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0cmFpbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInkiOiB5dHJhaW4udmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJldmFsX3NldCI6Wyh4dHJhaW4sIHl0cmFpbiksICh4dmFsaWQsIHl2YWxpZCldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJldmFsX21ldHJpYyI6IGV2YWxfbWV0cmljc30pCgogICAgbW9kZWwuZml0KCoqbW9kZWxfY29uZmlnWyJGSVQiXSkKCiAgICBpZiBtb2RlbF9ldmFsdWF0b3I6CiAgICAgICAgZXZhbF9tZXRyaWNzID0gbW9kZWxfZXZhbHVhdG9yKGNvbnRleHQsIHh2YWxpZCwgeXZhbGlkLCBtb2RlbCkKICAgIGVsc2U6CiAgICAgICAgZXZhbF9tZXRyaWNzID0gZXZhbF9jbGFzc19tb2RlbChjb250ZXh0LCB4dmFsaWQsIHl2YWxpZCwgbW9kZWwpCgogICAgbG9nX21vZGVsKGNvbnRleHQsIGR1bXBzKG1vZGVsKSwgZXZhbF9tZXRyaWNzKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#e31612d99ae3c5e096dbe9e21f50d42105e90066:xgb_trainer.ipynb
