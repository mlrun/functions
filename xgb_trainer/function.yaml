kind: job
metadata:
  name: xgb-trainer
  tag: latest
  hash: 5646134c4779bea6806f6e2b343e33f261aad9af
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: train_model
  entry_points:
    gen_xgb_model:
      name: gen_xgb_model
      doc: 'generate an xgboost model


        Multiple model types that can be estimated using

        the XGBoost Scikit-Learn API'
      parameters:
      - name: model_type
        type: str
        doc: one of "classifier", "regressor", "ranker", "rf_classifier", or "rf_regressor"
      - name: xgb_params
        type: dict
        doc: parameters passed through the  function execution context
      outputs: []
      lineno: 6
    test_gen_xgb_model:
      name: test_gen_xgb_model
      doc: ''
      parameters: []
      outputs: []
      lineno: 45
    get_sample:
      name: get_sample
      doc: "generate data sample to be split (candidate for mlrun)\n \nReturns features\
        \ matrix and header (x), and labels (y)"
      parameters:
      - name: src
        type: str
        doc: full path and filename of data artifact
      - name: sample
        type: int
        doc: sample size from data source, use negative  integers to sample randomly,
          positive to sample consecutively from the first row
      - name: label
        type: str
        doc: label column title
      - name: reader
        doc: pandas type reader (read_csv, read_parquet, ...) returning a pandas dataframe,
          and with a `dropna` attribute
      outputs: []
      lineno: 51
    test_get_sample:
      name: test_get_sample
      doc: ''
      parameters: []
      outputs: []
      lineno: 84
    get_splits:
      name: get_splits
      doc: 'generate train and test sets (candidate for mlrun)


        cross validation:

        1. cut out a test set

        2a. use the training set in a cross validation scheme, or

        2b. make another split to generate a validation set'
      parameters:
      - name: raw
        doc: dataframe or numpy array of raw features
      - name: labels
        doc: label names
      - name: three_way
        type: bool
        default: true
      - name: test_size
        type: float
        doc: proportion of raw data to set asid as test data
        default: 0.15
      - name: valid_size
        type: float
        doc: proportion of remaining data to be set as validation
        default: 0.3
      - name: label_names
        type: list
        default:
        - labels
      - name: random_state
        type: int
        doc: (1) random number seed
        default: 1
      outputs: []
      lineno: 90
    test_get_splits:
      name: test_get_splits
      doc: ''
      parameters: []
      outputs: []
      lineno: 136
    save_test_set:
      name: save_test_set
      doc: save a held out test set
      parameters:
      - name: context
        doc: the function execution context
      - name: xtest
        doc: test features, as np.ndarray output from `get_splits`
      - name: ytest
        doc: test labels, as np.ndarray output from `get_splits`
      - name: header
        type: list
        doc: ([])features header if required
      - name: label
        type: str
        doc: ("labels") name of label column
        default: labels
      - name: file_ext
        type: str
        doc: format of test set file
        default: parquet
      - name: index
        type: bool
        doc: preserve index column
      outputs: []
      lineno: 143
    test_save_test_set:
      name: test_save_test_set
      doc: ''
      parameters:
      - name: params
      outputs: []
      lineno: 171
    dump_xgb_model:
      name: dump_xgb_model
      doc: 'serialize/log model


        XGBoost model can be save in 3 different ways:

        1. pickle the internal _booster object, inside the model

        2. using model.save_model("fn.bin") using a legacy binary xgb format

        2. using model.save_model("fn.json") using a portable json format'
      parameters:
      - name: context
        doc: the function"s execution context
      - name: model
        doc: the fitted xgboost model
      - name: dump_type
        type: str
        doc: '"pickle" legacy", or "json", '
      - name: dest_folder
        type: str
        doc: 'path for serialized model '
      - name: dest_name
        type: str
        doc: name for serialized model file
      outputs: []
      lineno: 177
    test_dump_xgb_model_pickle:
      name: test_dump_xgb_model_pickle
      doc: 'note that this approach doesn''t require information

        about the underlying package, xgboost'
      parameters: []
      outputs: []
      lineno: 211
    test_dump_xgb_save_model:
      name: test_dump_xgb_save_model
      doc: ''
      parameters: []
      outputs: []
      lineno: 224
    test_dump_xgb_json_save_model:
      name: test_dump_xgb_json_save_model
      doc: ''
      parameters: []
      outputs: []
      lineno: 234
    plot_confusion_matrix:
      name: plot_confusion_matrix
      doc: prints and plots the confusion matrix.
      parameters:
      - name: labels
      - name: predictions
      - name: classes
      - name: normalize
        default: all
      - name: title
        default: Confusion matrix
      - name: cmap
      outputs: []
      lineno: 244
    gen_proba:
      name: gen_proba
      doc: generate predictions and validation stats
      parameters:
      - name: context
        doc: the function execution context
      - name: feats
        doc: 'validation features array '
      - name: labels
        doc: validation ground-truth labels
      - name: model
        doc: estimated model
      - name: score_method
      - name: plots_dest
        doc: destination folder for plot artifacts
      - name: ntree_limit
        doc: (None) limit no. trees used in prediction
      - name: validate_features
        doc: (True) ensure consistent feature names  between model and input data
        default: true
      - name: base_margin
        doc: (None) undefined
      outputs: []
      lineno: 280
    plot_roc:
      name: plot_roc
      doc: "plot roc curves\n\nTODO:  add averaging method (as string) that was used\
        \ to create probs, \ndisplay in legend"
      parameters:
      - name: context
        doc: the function context
      - name: y_labels
        doc: 'ground truth labels, hot encoded for multiclass  '
      - name: y_probs
        doc: model prediction probabilities
      - name: fpr_label
        type: str
        doc: ("false positive rate") x-axis labels
        default: false positive rate
      - name: tpr_label
        type: str
        doc: ("true positive rate") y-axis labels
        default: true positive rate
      - name: title
        type: str
        doc: ("roc curve") title of plot
        default: roc curve
      - name: legend_loc
        type: str
        doc: ("best") location of plot legend
        default: best
      outputs: []
      lineno: 334
    test_gen_proba:
      name: test_gen_proba
      doc: ''
      parameters: []
      outputs: []
      lineno: 389
    train_model:
      name: train_model
      doc: train an xgboost model.
      parameters:
      - name: context
        doc: the function context
      - name: model_type
        type: str
      - name: dataset
        doc: ("data") name of raw data file
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f4a0a8d3d68>
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      - name: model_pkg_file
        type: str
        doc: json model config file
      outputs: []
      lineno: 403
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTI3IDIwOjU5CgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiBnZW5feGdiX21vZGVsKG1vZGVsX3R5cGU6IHN0ciwgeGdiX3BhcmFtczogZGljdCk6CiAgICAiIiJnZW5lcmF0ZSBhbiB4Z2Jvb3N0IG1vZGVsCiAgICAKICAgIE11bHRpcGxlIG1vZGVsIHR5cGVzIHRoYXQgY2FuIGJlIGVzdGltYXRlZCB1c2luZwogICAgdGhlIFhHQm9vc3QgU2Npa2l0LUxlYXJuIEFQSQogICAgCiAgICA6cGFyYW0gbW9kZWxfdHlwZTogb25lIG9mICJjbGFzc2lmaWVyIiwgInJlZ3Jlc3NvciIsCiAgICAgICAgICAgICAgICAgICAgICAgInJhbmtlciIsICJyZl9jbGFzc2lmaWVyIiwgb3IKICAgICAgICAgICAgICAgICAgICAgICJyZl9yZWdyZXNzb3IiCiAgICA6cGFyYW0geGdiX3BhcmFtczogcGFyYW1ldGVycyBwYXNzZWQgdGhyb3VnaCB0aGUgCiAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZXhlY3V0aW9uIGNvbnRleHQKICAgICIiIgogICAgZnJvbSBqc29uIGltcG9ydCBsb2FkCiAgICBmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IGdldF9jbGFzc19maXQsIGNyZWF0ZV9jbGFzcwoKICAgIGlmIG1vZGVsX3R5cGUgPT0gImNsYXNzaWZpZXIiOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGdldF9jbGFzc19maXQoInhnYm9vc3QuWEdCQ2xhc3NpZmllciIpCiAgICBlbGlmIG1vZGVsX3R5cGUgPT0gInJlZ3Jlc3NvciI6CiAgICAgICAgbW9kZWxfY29uZmlnID0gZ2V0X2NsYXNzX2ZpdCgieGdib29zdC5YR0JSZWdyZXNzb3IiKQogICAgZWxpZiBtb2RlbF90eXBlID09ICJyYW5rZXIiOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGdldF9jbGFzc19maXQoInhnYm9vc3QuWEdCQ2xhc3NpZmllciIpCiAgICBlbGlmIG1vZGVsX3R5cGUgPT0gInJmX3JlZ3Jlc3NvciI6CiAgICAgICAgbW9kZWxfY29uZmlnID0gZ2V0X2NsYXNzX2ZpdCgieGdib29zdC5YR0JSRlJlZ3Jlc3NvciIpCiAgICBlbGlmIG1vZGVsX3R5cGUgPT0gInJmX2NsYXNzaWZpZXIiOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGdldF9jbGFzc19maXQoInhnYm9vc3QuWEdCUkZDbGFzc2lmaWVyIikKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmInVua25vd24gdHJhaW5lciB0eXBlIHttb2RlbF90eXBlfSIpCgogICAgZm9yIGssIHYgaW4geGdiX3BhcmFtczoKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoIkNMQVNTXyIpOgogICAgICAgICAgICBtb2RlbF9jb25maWdbIkNMQVNTIl1ba1s2Ol1dID0gdgogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgiRklUXyIpOgogICAgICAgICAgICBtb2RlbF9jb25maWdbIkZJVCJdW2tbNDpdXSA9IHYKCiAgICBDbGFzc2lmaWVyQ2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKCiAgICByZXR1cm4gbW9kZWwsIG1vZGVsX2NvbmZpZwoKZGVmIHRlc3RfZ2VuX3hnYl9tb2RlbCgpOgogICAgaW1wb3J0IHhnYm9vc3QKICAgIGMsIGogPSBnZW5feGdiX21vZGVsKCJyZl9jbGFzc2lmaWVyIiwge30pCiAgICBhc3NlcnQgaXNpbnN0YW5jZShjLCB4Z2Jvb3N0LlhHQlJGQ2xhc3NpZmllcikKdGVzdF9nZW5feGdiX21vZGVsKCkgICAgCgpkZWYgZ2V0X3NhbXBsZShzcmM6c3RyLCBzYW1wbGU6IGludCwgbGFiZWw6IHN0ciwgcmVhZGVyPU5vbmUpOgogICAgIiIiZ2VuZXJhdGUgZGF0YSBzYW1wbGUgdG8gYmUgc3BsaXQgKGNhbmRpZGF0ZSBmb3IgbWxydW4pCiAgICAgCiAgICBSZXR1cm5zIGZlYXR1cmVzIG1hdHJpeCBhbmQgaGVhZGVyICh4KSwgYW5kIGxhYmVscyAoeSkKICAgIDpwYXJhbSBzcmM6ICAgIGZ1bGwgcGF0aCBhbmQgZmlsZW5hbWUgb2YgZGF0YSBhcnRpZmFjdAogICAgOnBhcmFtIHNhbXBsZTogc2FtcGxlIHNpemUgZnJvbSBkYXRhIHNvdXJjZSwgdXNlIG5lZ2F0aXZlIAogICAgICAgICAgICAgICAgICAgaW50ZWdlcnMgdG8gc2FtcGxlIHJhbmRvbWx5LCBwb3NpdGl2ZSB0bwogICAgICAgICAgICAgICAgICAgc2FtcGxlIGNvbnNlY3V0aXZlbHkgZnJvbSB0aGUgZmlyc3Qgcm93CiAgICA6cGFyYW0gbGFiZWw6ICBsYWJlbCBjb2x1bW4gdGl0bGUKICAgIDpwYXJhbSByZWFkZXI6IHBhbmRhcyB0eXBlIHJlYWRlciAocmVhZF9jc3YsIHJlYWRfcGFycXVldCwgLi4uKSByZXR1cm5pbmcKICAgICAgICAgICAgICAgICAgIGEgcGFuZGFzIGRhdGFmcmFtZSwgYW5kIHdpdGggYSBgZHJvcG5hYCBhdHRyaWJ1dGUKICAgICIiIgogICAgaW1wb3J0IHBhbmRhcyBhcyBwZAogICAgCiAgICBpZiBub3QgcmVhZGVyOgogICAgICAgIGlmIHNyYy5lbmRzd2l0aCgiY3N2Iik6CiAgICAgICAgICAgIHJlYWRlciA9IHBkLnJlYWRfY3N2CiAgICAgICAgZWxpZiBzcmMuZW5kc3dpdGgoInBhcnF1ZXQiKSBvciBzcmMuZW5kc3dpdGgoInBxIik6CiAgICAgICAgICAgIHJlYWRlciA9IHBkLnJlYWRfcGFycXVldAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmImZpbGUgdHlwZSB1bmhhbmRsZWQge3NyY30iKQoKICAgIGlmIChzYW1wbGUgPT0gLTEpIG9yIChzYW1wbGUgPj0gMSk6CiAgICAgICAgcmF3ID0gcmVhZGVyKHNyYykuZHJvcG5hKCkKICAgICAgICBsYWJlbHMgPSByYXcucG9wKGxhYmVsKQogICAgICAgIHJhdyA9IHJhdy5pbG9jWzpzYW1wbGUsIDpdCiAgICAgICAgbGFiZWxzID0gbGFiZWxzLmlsb2NbOnNhbXBsZV0KICAgIGVsc2U6CiAgICAgICAgcmF3ID0gcmVhZGVyKHNyYykuZHJvcG5hKCkuc2FtcGxlKHNhbXBsZSAqIC0xKQogICAgICAgIGxhYmVscyA9IHJhdy5wb3AobGFiZWwpCgogICAgcmV0dXJuIHJhdywgbGFiZWxzLCByYXcuY29sdW1ucy52YWx1ZXMKCmRlZiB0ZXN0X2dldF9zYW1wbGUoKToKICAgIGZyb20gbWxydW4gaW1wb3J0IG1sY29uZgogICAgciwgbCwgaCA9IGdldF9zYW1wbGUobWxjb25mLmFydGlmYWN0X3BhdGgrIi9icmVhc3RfY2FuY2VyLnBhcnF1ZXQiLCAtMSwgImxhYmVscyIpCiAgICBhc3NlcnQgci5zaGFwZVswXT09bC5zaGFwZVswXQp0ZXN0X2dldF9zYW1wbGUoKQoKZGVmIGdldF9zcGxpdHMoCiAgICByYXcsIAogICAgbGFiZWxzLCAKICAgIHRocmVlX3dheTogYm9vbCA9IFRydWUsCiAgICB0ZXN0X3NpemU6IGZsb2F0ID0gMC4xNSwKICAgIHZhbGlkX3NpemU6IGZsb2F0ID0gMC4zMCwKICAgIGxhYmVsX25hbWVzOiBsaXN0ID0gWyJsYWJlbHMiXSwKICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gMQopOgogICAgIiIiZ2VuZXJhdGUgdHJhaW4gYW5kIHRlc3Qgc2V0cyAoY2FuZGlkYXRlIGZvciBtbHJ1bikKCiAgICBjcm9zcyB2YWxpZGF0aW9uOgogICAgMS4gY3V0IG91dCBhIHRlc3Qgc2V0CiAgICAyYS4gdXNlIHRoZSB0cmFpbmluZyBzZXQgaW4gYSBjcm9zcyB2YWxpZGF0aW9uIHNjaGVtZSwgb3IKICAgIDJiLiBtYWtlIGFub3RoZXIgc3BsaXQgdG8gZ2VuZXJhdGUgYSB2YWxpZGF0aW9uIHNldAogICAgCiAgICA6cGFyYW0gcmF3OiAgICAgICAgICAgIGRhdGFmcmFtZSBvciBudW1weSBhcnJheSBvZiByYXcgZmVhdHVyZXMKICAgIDpwYXJhbSBsYWJlbHM6ICAgICAgICAgZGF0YWZyYW1lIG9yIG51bXB5IGFycmF5IG9mIHJhdyBsYWJlbHMKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgcHJvcG9ydGlvbiBvZiByYXcgZGF0YSB0byBzZXQgYXNpZCBhcyB0ZXN0IGRhdGEKICAgIDpwYXJhbSB2YWxpZF9zaXplOiAgICAgcHJvcG9ydGlvbiBvZiByZW1haW5pbmcgZGF0YSB0byBiZSBzZXQgYXMgdmFsaWRhdGlvbgogICAgOnBhcmFtIGxhYmVsczogICAgICAgICBsYWJlbCBuYW1lcwogICAgOnBhcmFtIHJhbmRvbV9zdGF0ZTogICAoMSkgcmFuZG9tIG51bWJlciBzZWVkCiAgICAiIiIKICAgIGltcG9ydCBwYW5kYXMgYXMgcGQKICAgIGltcG9ydCBudW1weSBhcyBucAogICAgZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgdHJhaW5fdGVzdF9zcGxpdAogICAgCiAgICBpZiBpc2luc3RhbmNlKHJhdywgbnAubmRhcnJheSk6CiAgICAgICAgaWYgbGFiZWxzLm5kaW09PTE6CiAgICAgICAgICAgIGxhYmVscz1sYWJlbHMucmVzaGFwZSgtMSwxKQogICAgICAgIHh5ID0gbnAuY29uY2F0ZW5hdGUoW3JhdywgbGFiZWxzXSwgYXhpcz0xKQogICAgZWxzZToKICAgICAgICBpZiBpc2luc3RhbmNlKGxhYmVscywgcGQuU2VyaWVzKToKICAgICAgICAgICAgbGFiZWxzID0gcGQuRGF0YUZyYW1lKGRhdGE9bGFiZWxzLCBjb2x1bW5zPWxhYmVsX25hbWVzKQogICAgICAgIHh5ID0gcGQuY29uY2F0KFtyYXcsIGxhYmVsc10sIGF4aXM9MSkKICAgICAgICAKICAgIHgsIHh0ZSwgeSwgeXRlID0gdHJhaW5fdGVzdF9zcGxpdCh4eSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbHMsIHRlc3Rfc2l6ZT10ZXN0X3NpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX3N0YXRlPXJhbmRvbV9zdGF0ZSkKICAgIGlmIG5vdCB0aHJlZV93YXk6CiAgICAgICAgcmV0dXJuICh4LCB5KSwgKHh0ZSwgeXRlKSwgTm9uZQogICAgZWxzZToKICAgICAgICB4dHIsIHh2YSwgeXRyLCB5dmEgPSB0cmFpbl90ZXN0X3NwbGl0KHgsIHksdHJhaW5fc2l6ZT12YWxpZF9zaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX3N0YXRlPXJhbmRvbV9zdGF0ZSkKICAgICAgICByZXR1cm4gKHh0ciwgeXRyKSwgKHh2YSwgeXZhKSwgKHh0ZSwgeXRlKQoKZGVmIHRlc3RfZ2V0X3NwbGl0cygpOgogICAgZnJvbSBtbHJ1biBpbXBvcnQgbWxjb25mCiAgICByLCBsLCBoID0gZ2V0X3NhbXBsZShtbGNvbmYuYXJ0aWZhY3RfcGF0aCsiL2JyZWFzdF9jYW5jZXIucGFycXVldCIsIC0xLCAibGFiZWxzIikKICAgICh4dHIsIHl0ciksICh4dmEsIHl2YSksICh4dGUsIHl0ZSkgPSBnZXRfc3BsaXRzKHIsbCkKICAgIGFzc2VydCB4dHIuc2hhcGVbMF0reHZhLnNoYXBlWzBdK3h0ZS5zaGFwZVswXSA9PSByLnNoYXBlWzBdCnRlc3RfZ2V0X3NwbGl0cygpCgpkZWYgc2F2ZV90ZXN0X3NldCgKICAgIGNvbnRleHQsIAogICAgeHRlc3QsIAogICAgeXRlc3QsIAogICAgaGVhZGVyOiBsaXN0LCAKICAgIGxhYmVsOiBzdHIgPSAibGFiZWxzIiwgCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLCAKICAgIGluZGV4OiBib29sID0gRmFsc2UgCik6CiAgICAiIiJzYXZlIGEgaGVsZCBvdXQgdGVzdCBzZXQKCiAgICA6cGFyYW0gY29udGV4dDogICAgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbiBjb250ZXh0CiAgICA6cGFyYW0geHRlc3Q6ICAgICAgdGVzdCBmZWF0dXJlcywgYXMgbnAubmRhcnJheSBvdXRwdXQgZnJvbSBgZ2V0X3NwbGl0c2AKICAgIDpwYXJhbSB5dGVzdDogICAgICB0ZXN0IGxhYmVscywgYXMgbnAubmRhcnJheSBvdXRwdXQgZnJvbSBgZ2V0X3NwbGl0c2AKICAgIDpwYXJhbSBoZWFkZXI6ICAgICAoW10pZmVhdHVyZXMgaGVhZGVyIGlmIHJlcXVpcmVkCiAgICA6cGFyYW0gbGFiZWw6ICAgICAgKCJsYWJlbHMiKSBuYW1lIG9mIGxhYmVsIGNvbHVtbgogICAgOnBhcmFtIGZpbGVfZXh0OiAgIGZvcm1hdCBvZiB0ZXN0IHNldCBmaWxlCiAgICA6cGFyYW0gaW5kZXg6ICAgICAgcHJlc2VydmUgaW5kZXggY29sdW1uCiAgICAiIiIKICAgIGltcG9ydCBwYW5kYXMgYXMgcGQKICAgIAogICAgdGVzdF9zZXQgPSBwZC5jb25jYXQoCiAgICAgICAgW3BkLkRhdGFGcmFtZShkYXRhPXh0ZXN0LCBjb2x1bW5zPWhlYWRlciksCiAgICAgICAgIHBkLkRhdGFGcmFtZShkYXRhPXl0ZXN0LnZhbHVlcywgY29sdW1ucz1bbGFiZWxdKV0sCiAgICAgICAgYXhpcz0xLCkKICAgIAogICAgY29udGV4dC5sb2dfZGF0YXNldCgidGVzdF9zZXQiLCBkZj10ZXN0X3NldCwgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKCmRlZiB0ZXN0X3NhdmVfdGVzdF9zZXQocGFyYW1zKToKICAgIHIsIGwsIGggPSBnZXRfc2FtcGxlKG1sY29uZi5hcnRpZmFjdF9wYXRoKyIvYnJlYXN0X2NhbmNlci5wYXJxdWV0IiwgLTEsICJsYWJlbHMiKQogICAgKHh0ciwgeXRyKSwgKHh2YSwgeXZhKSwgKHh0ZSwgeXRlKSA9IGdldF9zcGxpdHMocixsKQogICAgc2F2ZV90ZXN0X3NldCh4dGUsIHl0ZSkKICAgIGltcG9ydCBwYW5kYXMgYXMgcGQKCmRlZiBkdW1wX3hnYl9tb2RlbCgKICAgIGNvbnRleHQsIAogICAgbW9kZWwsCiAgICBkdW1wX3R5cGU6IHN0ciwKICAgIGRlc3RfZm9sZGVyOiBzdHIsCiAgICBkZXN0X25hbWU6IHN0cgopOgogICAgIiIic2VyaWFsaXplL2xvZyBtb2RlbAogICAgCiAgICBYR0Jvb3N0IG1vZGVsIGNhbiBiZSBzYXZlIGluIDMgZGlmZmVyZW50IHdheXM6CiAgICAxLiBwaWNrbGUgdGhlIGludGVybmFsIF9ib29zdGVyIG9iamVjdCwgaW5zaWRlIHRoZSBtb2RlbAogICAgMi4gdXNpbmcgbW9kZWwuc2F2ZV9tb2RlbCgiZm4uYmluIikgdXNpbmcgYSBsZWdhY3kgYmluYXJ5IHhnYiBmb3JtYXQKICAgIDIuIHVzaW5nIG1vZGVsLnNhdmVfbW9kZWwoImZuLmpzb24iKSB1c2luZyBhIHBvcnRhYmxlIGpzb24gZm9ybWF0CiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgdGhlIGZ1bmN0aW9uInMgZXhlY3V0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbDogICAgICAgdGhlIGZpdHRlZCB4Z2Jvb3N0IG1vZGVsCiAgICA6cGFyYW0gZHVtcF90eXBlOiAgICJwaWNrbGUiIGxlZ2FjeSIsIG9yICJqc29uIiwgCiAgICA6cGFyYW0gZGVzdF9mb2xkZXI6IHBhdGggZm9yIHNlcmlhbGl6ZWQgbW9kZWwgCiAgICA6cGFyYW0gZGVzdF9uYW1lOiAgIG5hbWUgZm9yIHNlcmlhbGl6ZWQgbW9kZWwgZmlsZQogICAgIiIiCiAgICBmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcwogICAgdHJ5OgogICAgICAgIG1vZGVsLnNhdmVfbW9kZWwoZiJ7ZGVzdF9mb2xkZXJ9L3tkZXN0X25hbWV9LXNhdmVfbW9kZWwucGtsIikKICAgICAgICAKICAgICAgICBtb2RlbC5zYXZlX21vZGVsKGYie2Rlc3RfZm9sZGVyfS97ZGVzdF9uYW1lfS1zYXZlX21vZGVsLmpzb24iKQogICAgICAgIAogICAgICAgIF9ib29zdGVyID0gbW9kZWwuZ2V0X2Jvb3N0ZXIoKQogICAgICAgIGR1bXAoX2Jvb3N0ZXIsIG9wZW4oZiJ7ZGVzdF9mb2xkZXJ9L3tkZXN0X25hbWV9LWR1bXAucGtsIiwgIndiIikpCiAgICAgICAgCiAgICAgICAgZGF0YSA9IGR1bXBzKF9ib29zdGVyKQogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KCJtb2RlbCIsIGJvZHk9ZGF0YSwgbG9jYWxfcGF0aD1mIntkZXN0X2ZvbGRlcn0ve2Rlc3RfbmFtZX0ucGtsIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludCgieGdib29zdCBtb2RlbCBzZXJpYWxpemF0aW9uIGVycm9yIiwgc3RyKGUpKQoKZGVmIHRlc3RfZHVtcF94Z2JfbW9kZWxfcGlja2xlKCk6CiAgICAiIiIKICAgIG5vdGUgdGhhdCB0aGlzIGFwcHJvYWNoIGRvZXNuJ3QgcmVxdWlyZSBpbmZvcm1hdGlvbgogICAgYWJvdXQgdGhlIHVuZGVybHlpbmcgcGFja2FnZSwgeGdib29zdAogICAgIiIiCiAgICBmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBsb2FkCiAgICBmcm9tIG1scnVuIGltcG9ydCBtbGNvbmYKICAgIAogICAgYm9vc3RlciA9IGxvYWQob3BlbihtbGNvbmYuYXJ0aWZhY3RfcGF0aCArICIvbW9kZWxzL3hnYi1kdW1wLnBrbCIsICJyYiIpKQogICAgYXNzZXJ0ICJib29zdGVyIiBpbiBib29zdGVyLl9fZGljdF9fLmtleXMoKQoKdGVzdF9kdW1wX3hnYl9tb2RlbF9waWNrbGUoKQoKZGVmIHRlc3RfZHVtcF94Z2Jfc2F2ZV9tb2RlbCgpOgogICAgaW1wb3J0IHhnYm9vc3QgYXMgeGdiCiAgICBmcm9tIG1scnVuIGltcG9ydCBtbGNvbmYKCiAgICBib29zdGVyID0geGdiLkJvb3N0ZXIoKQogICAgYm9vc3Rlci5sb2FkX21vZGVsKGZuYW1lPW1sY29uZi5hcnRpZmFjdF9wYXRoICsgIi9tb2RlbHMveGdiLXNhdmVfbW9kZWwucGtsIikKICAgIGFzc2VydCAiYm9vc3RlciIgaW4gYm9vc3Rlci5fX2RpY3RfXy5rZXlzKCkKCnRlc3RfZHVtcF94Z2Jfc2F2ZV9tb2RlbCgpCgpkZWYgdGVzdF9kdW1wX3hnYl9qc29uX3NhdmVfbW9kZWwoKToKICAgIGltcG9ydCB4Z2Jvb3N0IGFzIHhnYgogICAgZnJvbSBtbHJ1biBpbXBvcnQgbWxjb25mCgogICAgYm9vc3RlciA9IHhnYi5Cb29zdGVyKCkKICAgIGJvb3N0ZXIubG9hZF9tb2RlbChmbmFtZT1tbGNvbmYuYXJ0aWZhY3RfcGF0aCArICIvbW9kZWxzL3hnYi1zYXZlX21vZGVsLmpzb24iKQogICAgYXNzZXJ0ICJib29zdGVyIiBpbiBib29zdGVyLl9fZGljdF9fLmtleXMoKQoKdGVzdF9kdW1wX3hnYl9qc29uX3NhdmVfbW9kZWwoKQoKZGVmIHBsb3RfY29uZnVzaW9uX21hdHJpeCgKICAgIGxhYmVscywKICAgIHByZWRpY3Rpb25zLAogICAgY2xhc3NlcywKICAgIG5vcm1hbGl6ZT0iYWxsIiwKICAgIHRpdGxlPSdDb25mdXNpb24gbWF0cml4JywKICAgIGNtYXA9Tm9uZQopOgogICAgIiIicHJpbnRzIGFuZCBwbG90cyB0aGUgY29uZnVzaW9uIG1hdHJpeC4KICAgIAogICAgIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICBmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKICAgIGltcG9ydCBpdGVydG9vbHMKICAgIAogICAgaWYgbm90IGNtYXA6CiAgICAgICAgY21hcCA9IHBsdC5jbS5CbHVlcwoKICAgIGNtID0gbWV0cmljcy5jb25mdXNpb25fbWF0cml4KGxhYmVscywgcHJlZGljdGlvbnMsIG5vcm1hbGl6ZT1ub3JtYWxpemUpCiAgICAKICAgIHBsdC5pbXNob3coY20sIGludGVycG9sYXRpb249J25lYXJlc3QnLCBjbWFwPWNtYXApCiAgICBwbHQudGl0bGUodGl0bGUpCiAgICBwbHQuY29sb3JiYXIoKQogICAgdGlja19tYXJrcyA9IG5wLmFyYW5nZShsZW4oY2xhc3NlcykpCiAgICBwbHQueHRpY2tzKHRpY2tfbWFya3MsIGNsYXNzZXMsIHJvdGF0aW9uPTQ1KQogICAgcGx0Lnl0aWNrcyh0aWNrX21hcmtzLCBjbGFzc2VzKQoKICAgIHRocmVzaCA9IGNtLm1heCgpIC8gMi4KICAgIGZvciBpLCBqIGluIGl0ZXJ0b29scy5wcm9kdWN0KHJhbmdlKGNtLnNoYXBlWzBdKSwgcmFuZ2UoY20uc2hhcGVbMV0pKToKICAgICAgICBwbHQudGV4dChqLCBpLCByb3VuZChjbVtpLCBqXSwgMiksCiAgICAgICAgICAgICAgICAgaG9yaXpvbnRhbGFsaWdubWVudD0iY2VudGVyIiwKICAgICAgICAgICAgICAgICBjb2xvcj0id2hpdGUiIGlmIGNtW2ksIGpdID4gdGhyZXNoIGVsc2UgImJsYWNrIikKCiAgICBwbHQueWxhYmVsKCdUcnVlIGxhYmVsJykKICAgIHBsdC54bGFiZWwoJ1ByZWRpY3RlZCBsYWJlbCcpCgpkZWYgZ2VuX3Byb2JhKAogICAgY29udGV4dCwKICAgIGZlYXRzLAogICAgbGFiZWxzLAogICAgbW9kZWwsCiAgICBzY29yZV9tZXRob2QsCiAgICBwbG90c19kZXN0LAogICAgbnRyZWVfbGltaXQ9Tm9uZSwKICAgIHZhbGlkYXRlX2ZlYXR1cmVzPVRydWUsCiAgICBiYXNlX21hcmdpbj1Ob25lCik6CiAgICAiIiIgZ2VuZXJhdGUgcHJlZGljdGlvbnMgYW5kIHZhbGlkYXRpb24gc3RhdHMKICAgIAogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBmZWF0czogICAgICAgICAgICAgdmFsaWRhdGlvbiBmZWF0dXJlcyBhcnJheSAKICAgIDpwYXJhbSBsYWJlbHM6ICAgICAgICAgICAgdmFsaWRhdGlvbiBncm91bmQtdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gbW9kZWw6ICAgICAgICAgICAgIGVzdGltYXRlZCBtb2RlbAogICAgOnBhcmFtIHNjcm9yZV9tZXRob2Q6ICAgICAoImF2ZXJhZ2UiKSBtdWx0aWNsYXNzIHNjb3JpbmcKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICAgZGVzdGluYXRpb24gZm9sZGVyIGZvciBwbG90IGFydGlmYWN0cwogICAgOnBhcmFtIG50cmVlX2xpbWl0OiAgICAgICAoTm9uZSkgbGltaXQgbm8uIHRyZWVzIHVzZWQgaW4gcHJlZGljdGlvbgogICAgOnBhcmFtIHZhbGlkYXRlX2ZlYXR1cmVzOiAoVHJ1ZSkgZW5zdXJlIGNvbnNpc3RlbnQgZmVhdHVyZSBuYW1lcyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmV0d2VlbiBtb2RlbCBhbmQgaW5wdXQgZGF0YQogICAgOnBhcmFtIGJhc2VfbWFyZ2luOiAgICAgICAoTm9uZSkgdW5kZWZpbmVkCiAgICAiIiIKICAgIGZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwogICAgZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IFBsb3RBcnRpZmFjdAogICAgZnJvbSBtbHJ1bi5tbHV0aWxzIGltcG9ydCBnY2ZfY2xlYXIKICAgIGZyb20geGdib29zdCBpbXBvcnQgWEdCQ2xhc3NpZmllciwgRE1hdHJpeAogICAgaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAogICAgCiAgICBjbGYgPSBYR0JDbGFzc2lmaWVyKCkKICAgIGNsZi5fQm9vc3RlciA9IG1vZGVsCiAgICB5cHJlZCA9IG1vZGVsLnByZWRpY3QoRE1hdHJpeChmZWF0cykpICMsIEZhbHNlLCBudHJlZV9saW1pdCwgdmFsaWRhdGVfZmVhdHVyZXMsIGJhc2VfbWFyZ2luKQogICAgCiAgICB5X3Byb2JhID0gW10KICAgIGlmIGhhc2F0dHIoY2xmLCAicHJlZGljdF9wcm9iYSIpOgogICAgICAgIHlfcHJvYmEgPSBjbGYucHJlZGljdF9wcm9iYShmZWF0cywgbnRyZWVfbGltaXQsIHZhbGlkYXRlX2ZlYXR1cmVzLCBiYXNlX21hcmdpbikKICAgIHlwcmVkX2JpbmFyeSA9IFtyb3VuZCh2YWx1ZSkgZm9yIHZhbHVlIGluIHlfcHJvYmFbOiwtMV1dCiAgICAKICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZShsYWJlbHMsIHlfcHJvYmFbOiwtMV0sIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgY29udGV4dC5sb2dfcmVzdWx0KGYiYXZnX3ByZWNpc2lvbiIsIGF2ZXJhZ2VfcHJlY2lzaW9uKQogICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKGxhYmVscywgeV9wcm9iYVs6LC0xXSkpCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhY2N1cmFjeV9zY29yZSIsIGZsb2F0KG1ldHJpY3MuYWNjdXJhY3lfc2NvcmUobGFiZWxzLCB5cHJlZF9iaW5hcnkpKSkKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZShsYWJlbHMsIHlwcmVkX2JpbmFyeSwgYXZlcmFnZT1zY29yZV9tZXRob2QpKQogICAgCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QoInJvYyIsIGJvZHk9cGxvdF9yb2MoY29udGV4dCwgbGFiZWxzLCB5X3Byb2JhKSksCiAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L3JvYy5odG1sIikKICAgIGdjZl9jbGVhcihwbHQpCgogICAgcGxvdF9jb25mdXNpb25fbWF0cml4KGxhYmVscywgeXByZWRfYmluYXJ5LCBjbGFzc2VzPWxhYmVscy5sYWJlbHMudW5pcXVlKCkpIAogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoUGxvdEFydGlmYWN0KCJjb25mdXNpb24iLCBib2R5PXBsdC5nY2YoKSksIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0vY29uZnVzaW9uLmh0bWwiKQogICAgCiAgICByZXR1cm4geV9wcm9iYQoKZGVmIHBsb3Rfcm9jKAogICAgY29udGV4dCwKICAgIHlfbGFiZWxzLAogICAgeV9wcm9icywKICAgIGZwcl9sYWJlbDogc3RyID0gImZhbHNlIHBvc2l0aXZlIHJhdGUiLAogICAgdHByX2xhYmVsOiBzdHIgPSAidHJ1ZSBwb3NpdGl2ZSByYXRlIiwKICAgIHRpdGxlOiBzdHIgPSAicm9jIGN1cnZlIiwKICAgIGxlZ2VuZF9sb2M6IHN0ciA9ICJiZXN0IiwKKToKICAgICIiInBsb3Qgcm9jIGN1cnZlcwoKICAgIFRPRE86ICBhZGQgYXZlcmFnaW5nIG1ldGhvZCAoYXMgc3RyaW5nKSB0aGF0IHdhcyB1c2VkIHRvIGNyZWF0ZSBwcm9icywgCiAgICBkaXNwbGF5IGluIGxlZ2VuZAoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0geV9sYWJlbHM6ICAgICBncm91bmQgdHJ1dGggbGFiZWxzLCBob3QgZW5jb2RlZCBmb3IgbXVsdGljbGFzcyAgCiAgICA6cGFyYW0geV9wcm9iczogICAgICBtb2RlbCBwcmVkaWN0aW9uIHByb2JhYmlsaXRpZXMKICAgIDpwYXJhbSBrZXk6ICAgICAgICAgICgicm9jIikga2V5IG9mIHBsb3QgaW4gYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBwbG90c19kaXI6ICAgICgicGxvdHMiKSBkZXN0aW5hdGlvbiBmb2xkZXIgcmVsYXRpdmUgcGF0aCB0byBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gZm10OiAgICAgICAgICAoInBuZyIpIHBsb3QgZm9ybWF0CiAgICA6cGFyYW0gZnByX2xhYmVsOiAgICAoImZhbHNlIHBvc2l0aXZlIHJhdGUiKSB4LWF4aXMgbGFiZWxzCiAgICA6cGFyYW0gdHByX2xhYmVsOiAgICAoInRydWUgcG9zaXRpdmUgcmF0ZSIpIHktYXhpcyBsYWJlbHMKICAgIDpwYXJhbSB0aXRsZTogICAgICAgICgicm9jIGN1cnZlIikgdGl0bGUgb2YgcGxvdAogICAgOnBhcmFtIGxlZ2VuZF9sb2M6ICAgKCJiZXN0IikgbG9jYXRpb24gb2YgcGxvdCBsZWdlbmQKICAgICIiIgogICAgZnJvbSBza2xlYXJuIGltcG9ydCBtZXRyaWNzCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICBmcm9tIG1scnVuLm1sdXRpbHMgaW1wb3J0IGdjZl9jbGVhcgogICAgCiAgICBnY2ZfY2xlYXIocGx0KQoKICAgIHBsdC5wbG90KFswLCAxXSwgWzAsIDFdLCAiay0tIikKCiAgICBwbHQueGxhYmVsKGZwcl9sYWJlbCkKICAgIHBsdC55bGFiZWwodHByX2xhYmVsKQogICAgcGx0LnRpdGxlKHRpdGxlKQogICAgcGx0LmxlZ2VuZChsb2M9bGVnZW5kX2xvYykKCiAgICBwcmludCh5X2xhYmVscy5uZGltKQogICAgaWYgeV9sYWJlbHMubmRpbSA+IDE6CiAgICAgICAgZnByID0gZGljdCgpCiAgICAgICAgdHByID0gZGljdCgpCiAgICAgICAgcm9jX2F1YyA9IGRpY3QoKQogICAgICAgIGZvciBpIGluIHJhbmdlKHlfbGFiZWxzWzosIDotMV0uc2hhcGVbMV0pOgogICAgICAgICAgICBmcHJbaV0sIHRwcltpXSwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKAogICAgICAgICAgICAgICAgeV9sYWJlbHNbOiwgaV0sIHlfcHJvYnNbOiwgaV0sIHBvc19sYWJlbD0xCiAgICAgICAgICAgICkKICAgICAgICAgICAgcm9jX2F1Y1tpXSA9IG1ldHJpY3MuYXVjKGZwcltpXSwgdHByW2ldKQogICAgICAgICAgICBwbHQucGxvdChmcHJbaV0sIHRwcltpXSwgbGFiZWw9ZiJjbGFzcyB7aX0iKQogICAgZWxzZToKICAgICAgICBmcHIsIHRwciwgXyA9IG1ldHJpY3Mucm9jX2N1cnZlKHlfbGFiZWxzLCB5X3Byb2JzWzosLTFdKQogICAgICAgIHBsdC5wbG90KGZwciwgdHByLCBsYWJlbD1mInBvc2l0aXZlIGNsYXNzIikKCiAgICByZXR1cm4gcGx0LmdjZigpCgpkZWYgdGVzdF9nZW5fcHJvYmEoKToKICAgIGZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGxvYWQKICAgIGZyb20gbWxydW4gaW1wb3J0IG1sY29uZiwgZ2V0X29yX2NyZWF0ZV9jdHgKICAgIAogICAgbW9kZWwgPSBsb2FkKG9wZW4obWxjb25mLmFydGlmYWN0X3BhdGgrJy9tb2RlbHMveGdiLWR1bXAucGtsJywgJ3JiJykpCiAgICByLCBsLCBoID0gZ2V0X3NhbXBsZShtbGNvbmYuYXJ0aWZhY3RfcGF0aCsiL2JyZWFzdF9jYW5jZXIucGFycXVldCIsIC0xLCAibGFiZWxzIikKICAgICh4dHIsIHl0ciksICh4dmEsIHl2YSksICh4dGUsIHl0ZSkgPSBnZXRfc3BsaXRzKHIsbCkKICAgIHlfcHJvYmEgPSBnZW5fcHJvYmEoZ2V0X29yX2NyZWF0ZV9jdHgoJ3Rlc3QnKSwKICAgICAgICAgICAgICAgICAgICAgICAgeHRyLCB5dHIsIG1vZGVsLCAibWFjcm8iLAogICAgICAgICAgICAgICAgICAgICAgICBtbGNvbmYuYXJ0aWZhY3RfcGF0aCsnL3Bsb3RzJykKICAgIHJldHVybiB5X3Byb2JhLCBjbGYKCnlfcHJvYmEsIGNsZiA9IHRlc3RfZ2VuX3Byb2JhKCkKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQsCiAgICBtb2RlbF90eXBlOiBzdHIsCiAgICBkYXRhc2V0LAogICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWxzIiwKICAgIHNhbXBsZTogaW50ID0gLTEsCiAgICB0ZXN0X3NpemU6IGZsb2F0ID0gMC4wNSwKICAgIHZhbGlkX3NpemU6IGZsb2F0ID0gMC43NSwKICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gMSwKICAgIG1vZGVsX2ZpbGVuYW1lOiBzdHIgPSAibW9kZWwiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICIiLAogICAgcGxvdHNfZGVzdDogc3RyID0gIiIsCiAgICBzY29yZV9tZXRob2Q6IHN0ciA9ICJtaWNybyIsCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLCAgICAKKSAtPiBOb25lOgogICAgIiIidHJhaW4gYW4geGdib29zdCBtb2RlbC4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxfcGtnX2NsYXNzOiAgIHRoZSBtb2RlbCB0byB0cmFpbiwgZS5nLCAic2tsZWFybi5uZXVyYWxfbmV0d29ya3MuTUxQQ2xhc3NpZmllciIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBqc29uIG1vZGVsIGNvbmZpZwogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAoImRhdGEiKSBuYW1lIG9mIHJhdyBkYXRhIGZpbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBzYW1wbGU6ICAgICAgICAgICAgU2VsZWN0cyB0aGUgZmlyc3QgbiByb3dzLCBvciBzZWxlY3QgYSBzYW1wbGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRpbmcgZnJvbSB0aGUgZmlyc3QuIElmIG5lZ2F0aXZlIDwtMSwgc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEgcmFuZG9tIHNhbXBsZQogICAgOnBhcmFtIG1vZGVsX2ZpbGVuYW1lOiAgICBtb2RlbCBmaWxlIGZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludHMgdG8gYSBkaXJlY3RvcnkKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgICAgKDAuMDUpIHRlc3Qgc2V0IHNpemUKICAgIDpwYXJhbSB2YWxpZF9zaXplOiAgICAgICAgICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHJhbmRvbV9zdGF0ZTogICAgICAoMSkgc2tsZWFybiBybmcgc2VlZAogICAgOnBhcmFtIG1vZGVsc19kZXN0OiAgICAgICBtb2RlbHMgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICAgcGxvdCBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aAogICAgOnBhcmFtIHNjb3JlX21ldGhvZDogICAgICBmb3IgbXVsdGljbGFzcyBjbGFzc2lmaWNhdGlvbgogICAgCiAgICA6cGFyYW0gZmlsZV9leHQ6ICAgICAgICAgIGZvcm1hdCBmb3IgdGVzdF9zZXRfa2V5IGhvbGQgb3V0IGRhdGEKICAgIDpwYXJhbSBtb2RlbF9wa2dfZmlsZTogICAganNvbiBtb2RlbCBjb25maWcgZmlsZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICIiIgogICAgbW9kZWxzX2Rlc3QgPSBtb2RlbHNfZGVzdCBvciAibW9kZWxzIgogICAgcGxvdHNfZGVzdCA9IHBsb3RzX2Rlc3Qgb3IgZiJwbG90cy97Y29udGV4dC5uYW1lfSIKICAgIAogICAgcmF3LCBsYWJlbHMsIGhlYWRlciA9IGdldF9zYW1wbGUoc3RyKGRhdGFzZXQpLCBzYW1wbGUsIGxhYmVsX2NvbHVtbikKICAgIAogICAgKHh0cix5dHIpLCAoeHZhLHl2YSksICh4dGUseXRlKSA9IGdldF9zcGxpdHMocmF3LCBsYWJlbHMsIHRlc3Rfc2l6ZSwgdmFsaWRfc2l6ZSwgcmFuZG9tX3N0YXRlKQogICAgICAgIAogICAgbW9kZWwsIG1vZGVsX2NvbmZpZyA9IGdlbl94Z2JfbW9kZWwobW9kZWxfdHlwZSwgY29udGV4dC5wYXJhbWV0ZXJzLml0ZW1zKCkpCiAgICAKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0ciwieSI6IHl0ci52YWx1ZXN9KQogICAgCiAgICBtb2RlbC5maXQoKiptb2RlbF9jb25maWdbIkZJVCJdKQogICAgCiAgICBkdW1wX3hnYl9tb2RlbChjb250ZXh0LCBtb2RlbCwgImpzb24iLCBtb2RlbHNfZGVzdCwgbW9kZWxfZmlsZW5hbWUpCgogICAgeV9wcm9iYSA9IGdlbl9wcm9iYShjb250ZXh0LCB4dmEsIHl2YSwgbW9kZWwsIHNjb3JlX21ldGhvZCwgcGxvdHNfZGVzdCkKCg==
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#0ffe3348e53ab7786b4e21a055bbc81f39b0bebf:xgb_trainer.ipynb
