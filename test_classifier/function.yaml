kind: job
metadata:
  name: test-classifier
  tag: latest
  hash: ab51ea991dde6891a8ac28c5e3fc14023ce413a8
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - testing
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: test_classifier
  entry_points:
    _gcf_clear:
      name: _gcf_clear
      doc: ''
      parameters:
      - name: plt
      outputs: []
      lineno: 26
    test_classifier:
      name: test_classifier
      doc: "Test one or more classifier models against held-out dataset\n\nUsing held-out\
        \ test features, evaluates the peformance of the estimated model\n\nCan be\
        \ part of a kubeflow pipeline as a test step that is run post EDA and \ntraining/validation\
        \ cycles"
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: models_dir
        type: str
        doc: artifact models representing a folder or a folder
      - name: test_set
        type: str
        doc: test features and labels
      - name: label_column
        type: str
        doc: column name for ground truth labels
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: key
        type: str
        doc: key for results artifact (maybe just a dir of artifacts for test like
          plots_dest)
      - name: plots_dest
        type: str
        doc: dir for test plots
        default: plots
      outputs: []
      lineno: 31
    _eval_model:
      name: _eval_model
      doc: ''
      parameters:
      - name: model
      outputs: []
      lineno: 60
  description: test a classifier using held-out or new data
  image_pull_policy: Always
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI2IDE1OjE1CgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IGltcG9ydGxpYgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBsb2FkCgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZAoKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdApmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IGxhYmVsX2JpbmFyaXplCmZyb20gc2tsZWFybi51dGlscy5tdWx0aWNsYXNzIGltcG9ydCB1bmlxdWVfbGFiZWxzCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBUYWJsZUFydGlmYWN0LCBQbG90QXJ0aWZhY3QKCmZyb20gbWx1dGlscy5tb2RlbHMgaW1wb3J0IGdldF9tb2RlbF9jb25maWdzCmZyb20gbWx1dGlscy5wbG90cyBpbXBvcnQgcGxvdF9yb2MsIHBsb3RfaW1wb3J0YW5jZSwgZ2NmX2NsZWFyCgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiBfZ2NmX2NsZWFyKHBsdCk6CiAgICBwbHQuY2xhKCkKICAgIHBsdC5jbGYoKQogICAgcGx0LmNsb3NlKCkgICAgICAgIAoKZGVmIHRlc3RfY2xhc3NpZmllcigKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxzX2Rpcjogc3RyLCAKICAgIHRlc3Rfc2V0OiBzdHIsCiAgICBsYWJlbF9jb2x1bW46IHN0ciwKICAgIHNjb3JlX21ldGhvZDogc3RyID0gJ21pY3JvJywKICAgIGtleTogc3RyID0gIiIsCiAgICBwbG90c19kZXN0OiBzdHIgPSAicGxvdHMiCikgLT4gTm9uZToKICAgICIiIlRlc3Qgb25lIG9yIG1vcmUgY2xhc3NpZmllciBtb2RlbHMgYWdhaW5zdCBoZWxkLW91dCBkYXRhc2V0CiAgICAKICAgIFVzaW5nIGhlbGQtb3V0IHRlc3QgZmVhdHVyZXMsIGV2YWx1YXRlcyB0aGUgcGVmb3JtYW5jZSBvZiB0aGUgZXN0aW1hdGVkIG1vZGVsCiAgICAKICAgIENhbiBiZSBwYXJ0IG9mIGEga3ViZWZsb3cgcGlwZWxpbmUgYXMgYSB0ZXN0IHN0ZXAgdGhhdCBpcyBydW4gcG9zdCBFREEgYW5kIAogICAgdHJhaW5pbmcvdmFsaWRhdGlvbiBjeWNsZXMKICAgIAogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbHNfZGlyOiAgICAgIGFydGlmYWN0IG1vZGVscyByZXByZXNlbnRpbmcgYSBmb2xkZXIgb3IgYSBmb2xkZXIKICAgIDpwYXJhbSB0ZXN0X3NldDogICAgICAgIHRlc3QgZmVhdHVyZXMgYW5kIGxhYmVscwogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgY29sdW1uIG5hbWUgZm9yIGdyb3VuZCB0cnV0aCBsYWJlbHMKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgIGZvciBtdWx0aWNsYXNzIGNsYXNzaWZpY2F0aW9uCiAgICA6cGFyYW0ga2V5OiAgICAgICAgICAgICBrZXkgZm9yIHJlc3VsdHMgYXJ0aWZhY3QgKG1heWJlIGp1c3QgYSBkaXIgb2YgYXJ0aWZhY3RzIGZvciB0ZXN0IGxpa2UgcGxvdHNfZGVzdCkKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICBkaXIgZm9yIHRlc3QgcGxvdHMKICAgICIiIgogICAgeHRlc3QgPSBwZC5yZWFkX3BhcnF1ZXQoc3RyKHRlc3Rfc2V0KSkKICAgIHl0ZXN0ID0geHRlc3QucG9wKGxhYmVsX2NvbHVtbikKICAgIAogICAgY29udGV4dC5oZWFkZXIgPSBsaXN0KHh0ZXN0LmNvbHVtbnMudmFsdWVzKQogICAgCiAgICBkZWYgX2V2YWxfbW9kZWwobW9kZWwpOgogICAgICAgIHl0ZXN0YiA9IGxhYmVsX2JpbmFyaXplKHl0ZXN0LCBjbGFzc2VzPXl0ZXN0LnVuaXF1ZSgpKQogICAgICAgIGNsZiA9IGxvYWQob3Blbihvcy5wYXRoLmpvaW4oc3RyKG1vZGVsc19kaXIpLCAibW9kZWwiKSsiLnBrbCIsICJyYiIpKQogICAgICAgIGlmIGNhbGxhYmxlKGdldGF0dHIoY2xmLCAicHJlZGljdF9wcm9iYSIpKToKICAgICAgICAgICAgeV9zY29yZSA9IGNsZi5wcmVkaWN0X3Byb2JhKHh0ZXN0LnZhbHVlcykKICAgICAgICAgICAgeXByZWQgPSBjbGYucHJlZGljdCh4dGVzdC52YWx1ZXMpCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5X3Njb3JlLnNoYXBlIHt5X3Njb3JlLnNoYXBlfSIpCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5dGVzdGIuc2hhcGUge3l0ZXN0Yi5zaGFwZX0iKQogICAgICAgICAgICBwbG90X3JvYyhjb250ZXh0LCB5dGVzdGIsIHlfc2NvcmUsIGtleT1mInJvYyIsIHBsb3RzX2Rlc3Q9cGxvdHNfZGVzdCkKICAgICAgICBlbHNlOgogICAgICAgICAgICB5cHJlZCA9IGNsZi5wcmVkaWN0KHh0ZXN0LnZhbHVlcykgIyByZWZhY3RvcgogICAgICAgICAgICB5X3Njb3JlID0gTm9uZQogICAgICAgICAgICAKICAgICAgICBnY2ZfY2xlYXIocGx0KQogICAgICAgCiAgICAgICAgbWV0cmljcy5wbG90X2NvbmZ1c2lvbl9tYXRyaXgoY2xmLCB4dGVzdCwgeXRlc3QsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVscz15dGVzdC51bmlxdWUoKSwgbm9ybWFsaXplPSd0cnVlJykgCiAgICAgICAgCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoUGxvdEFydGlmYWN0KCJjb25mdXNpb24iLCBib2R5PXBsdC5nY2YoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0vY29uZnVzaW9uLmh0bWwiKSAgICAgICAgCiAgICAKICAgICAgICBpZiBoYXNhdHRyKGNsZiwgImZlYXR1cmVfaW1wb3J0YW5jZXNfIik6CiAgICAgICAgICAgIHBsb3RfaW1wb3J0YW5jZShjb250ZXh0LCBjbGYsIGtleT1mImZlYXRpbXAiKQogICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dGVzdGJbOiw6LTFdLCB5X3Njb3JlLCBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhY2N1cmFjeSIsIGZsb2F0KGNsZi5zY29yZSh4dGVzdC52YWx1ZXMsIHl0ZXN0LnZhbHVlcykpKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dGVzdGIsIHlfc2NvcmUpKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZSh5dGVzdC52YWx1ZXMsIHlwcmVkLCBhdmVyYWdlPXNjb3JlX21ldGhvZCkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiYXZnX3ByZWNzY29yZSIsIGF2ZXJhZ2VfcHJlY2lzaW9uKQogICAgCiAgICBiZXN0X21vZGVsID0gTm9uZQogICAgZm9yIG1vZGVsIGluIG9zLmxpc3RkaXIoc3RyKG1vZGVsc19kaXIpKToKICAgICAgICBpZiBtb2RlbC5lbmRzd2l0aCgnLnBrbCcpOgogICAgICAgICAgICBfZXZhbF9tb2RlbChtb2RlbCkKICAgICAgICAgICAgYmVzdF9tb2RlbCA9IG1vZGVsCgogICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoJ1RPREFZUy1NT0RFTFMtVEVTVC1SRVBPUlQnLCBsb2NhbF9wYXRoPWJlc3RfbW9kZWwpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgnREVQTE9ZJywgYm9keT1iJ3RydWUnLCBsb2NhbF9wYXRoPSdERVBMT1knKQoK
    commands: []
    code_origin: https://github.com/mlrun/functions.git#a1589155ada27ed97d157791c6eaa95c94594501:test_classifier.ipynb
