kind: job
metadata:
  name: aggregate
  tag: ''
  hash: 28572aa0f173ce4d5b8dd509ee54c58fe185fd52
  project: ''
  labels:
    author: avia
  categories:
  - data-preparation
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKIyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCgpmcm9tIHR5cGluZyBpbXBvcnQgVW5pb24KCgpkZWYgYWdncmVnYXRlKGNvbnRleHQsCiAgICAgICAgICAgICAgZGZfYXJ0aWZhY3Q6IFVuaW9uW0RhdGFJdGVtLCBwZC5jb3JlLmZyYW1lLkRhdGFGcmFtZV0sCiAgICAgICAgICAgICAgc2F2ZV90bzogc3RyID0gJ2FnZ3JlZ2F0ZWQtZGYucHEnLAogICAgICAgICAgICAgIGtleXM6IGxpc3QgPSBOb25lLAogICAgICAgICAgICAgIG1ldHJpY3M6IGxpc3QgPSBOb25lLAogICAgICAgICAgICAgIGxhYmVsczogbGlzdCA9IE5vbmUsCiAgICAgICAgICAgICAgbWV0cmljX2FnZ3JlZ2F0aW9uczogbGlzdCA9IFsnbWVhbiddLAogICAgICAgICAgICAgIGxhYmVsX2FnZ3JlZ2F0aW9uczogbGlzdCA9IFsnbWF4J10sCiAgICAgICAgICAgICAgc3VmZml4OiBzdHIgPSAnJywKICAgICAgICAgICAgICB3aW5kb3c6IGludCA9IDMsCiAgICAgICAgICAgICAgY2VudGVyOiBib29sID0gRmFsc2UsCiAgICAgICAgICAgICAgaW5wbGFjZTogYm9vbCA9IEZhbHNlLAogICAgICAgICAgICAgIGRyb3BfbmE6IGJvb2wgPSBUcnVlLAogICAgICAgICAgICAgIGZpbGVzX3RvX3NlbGVjdDogaW50ID0gMSk6CiAgICAiIiJUaW1lLXNlcmllcyBhZ2dyZWdhdGlvbiBmdW5jdGlvbgogICAgCiAgICBXaWxsIHBlcmZvcm0gYSByb2xsaW5nIGFnZ3JlZ2F0aW9uIG9uIHtkZl9hcnRpZmFjdH0sIG92ZXIge3dpbmRvd30gYnkgdGhlIHNlbGVjdGVkIHtrZXlzfQogICAgYXBwbHlpbmcge21ldHJpY19hZ2dyZWdhdGlvbnN9IG9uIHttZXRyaWNzfSBhbmQge2xhYmVsX2FnZ3JlZ2F0aW9uc30gb24ge2xhYmVsc30uIGFkZGluZyB7c3VmZml4fSB0byB0aGUKICAgIGZlYXR1cmUgbmFtZXMuCiAgICAKICAgIGlmIG5vdCB7aW5wbGFjZX0sIHdpbGwgcmV0dXJuIHRoZSBvcmlnaW5hbCB7ZGZfYXJ0aWZhY3R9LCBqb2luZWQgYnkgdGhlIGFnZ3JlZ2F0ZWQgcmVzdWx0LgoKICAgIDpwYXJhbSBjb250ZXh0OiBBZnRlciBydW5uaW5nIGEgam9iLCB5b3UgbmVlZCB0byBiZSBhYmxlIHRvIHRyYWNrIGl0LiBUbyBnYWluIHRoZSBtYXhpbXVtIHZhbHVlLCBNTFJ1biB1c2VzIHRoZQogICAgICAgICAgICAgICAgICAgIGpvYiBjb250ZXh0IG9iamVjdCBpbnNpZGUgdGhlIGNvZGUuIFRoaXMgcHJvdmlkZXMgYWNjZXNzIHRvIGpvYiBtZXRhZGF0YSwgcGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICBpbnB1dHMsIHNlY3JldHMsIGFuZCBBUEkgZm9yIGxvZ2dpbmcgYW5kIG1vbml0b3JpbmcgdGhlIHJlc3VsdHMsIGFzIHdlbGwgYXMgbG9nIHRleHQsIGZpbGVzLAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0cywgYW5kIGxhYmVscy4KICAgIAogICAgOnBhcmFtIGRmX2FydGlmYWN0OiBNTFJ1biBpbnB1dCBwb2ludGluZyB0byBwYW5kYXMgZGF0YWZyYW1lIChjc3YvcGFycXVldCBmaWxlIHBhdGgpIG9yIGEgCiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdG9yeSBjb250YWluaW5nIHBhcnF1ZXQgZmlsZXMuCiAgICAgICAgICAgICAgICAgICAgICAgICogV2hlbiBnaXZlbiBhIGRpcmVjdG9yeSB0aGUgbGF0ZXN0IHtmaWxlc190b19zZWxlY3R9IHdpbGwgYmUgc2VsZWN0ZWQKICAgIDpwYXJhbSBzYXZlX3RvOiAgICAgV2hlcmUgdG8gc2F2ZSB0aGUgcmVzdWx0IGRhdGFmcmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgKiBJZiByZWxhdGl2ZSB3aWxsIGFkZCB0byB0aGUge2FydGlmYWN0X3BhdGh9CiAgICA6cGFyYW0ga2V5czogICAgICAgIFN1YnNldCBvZiBpbmRleGVzIGZyb20gdGhlIHNvdXJjZSBkYXRhZnJhbWUgdG8gYWdncmVnYXRlIGJ5IChkZWZhdWx0PWFsbCkKICAgIDpwYXJhbSBtZXRyaWNzOiAgICAgQXJyYXkgY29udGFpbmluZyBhIGxpc3Qgb2YgbWV0cmljcyB0byBydW4gdGhlIGFnZ3JlZ2F0aW9ucyBvbi4gKGRlZmF1bHQ9Tm9uZSkgCiAgICA6cGFyYW0gbGFiZWxzOiAgICAgIEFycmF5IGNvbnRhaW5pbmcgYSBsaXN0IG9mIGxhYmVscyB0byBydW4gdGhlIGFnZ3JlZ2F0aW9ucyBvbi4gKGRlZmF1bHQ9Tm9uZSkgCiAgICA6cGFyYW0gbWV0cmljX2FnZ3JlZ2F0aW9uczogQXJyYXkgY29udGFpbmluZyBhIGxpc3Qgb2YgYWdncmVnYXRpb24gZnVuY3Rpb24gbmFtZXMgdG8gcnVuIG9uIHttZXRyaWNzfS4KICAgICAgICAgICAgICAgICAgICAgICAgKEV4OiAnbWVhbicsICdzdGQnKSAoZGVmYXVsdD0nbWVhbicpCiAgICA6cGFyYW0gbGFiZWxfYWdncmVnYXRpb25zOiAgQXJyYXkgY29udGFpbmluZyBhIGxpc3Qgb2YgYWdncmVnYXRpb24gZnVuY3Rpb24gbmFtZXMgdG8gcnVuIG9uIHttZXRyaWNzfS4KICAgICAgICAgICAgICAgICAgICAgICAgKEV4OiAnbWF4JywgJ21pbicpIChkZWZhdWx0PSdtYXgnKSAKICAgIDpwYXJhbSBzdWZmaXg6ICAgICAgU3VmZml4IHRvIGFkZCB0byB0aGUgZmVhdHVyZSBuYW1lLCBFLmc6IDxGZWF0dXJlX05hbWU+XzxBZ2dfRnVuY3Rpb24+XzxTdWZmaXg+CiAgICAgICAgICAgICAgICAgICAgICAgIChFeDogJ2xhc3RfNjBfbWludXRlcycpIChkZWZhdWx0PScnKQogICAgOnBhcmFtIHdpbmRvdzogICAgICBXaW5kb3cgc2l6ZSB0byBwZXJmb3JtIHRoZSByb2xsaW5nIGFnZ3JlZ2F0ZSBvbi4gKGRlZmF1bHQ9MykKICAgIDpwYXJhbSBjZW50ZXI6ICAgICAgSWYgVHJ1ZSwgU2V0cyB0aGUgdmFsdWUgZm9yIHRoZSBjZW50cmFsIHNhbXBsZSBpbiB0aGUgd2luZG93LAogICAgICAgICAgICAgICAgICAgICAgICBJZiBGYWxzZSwgd2lsbCBzZXQgdGhlIHZhbHVlIHRvIHRoZSBsYXN0IHNhbXBsZS4gKGRlZmF1bHQ9RmFsc2UpCiAgICA6cGFyYW0gaW5wbGFjZTogICAgIElmIFRydWUsIHdpbGwgcmV0dXJuIG9ubHkgdGhlIGFnZ3JlZ2F0ZWQgcmVzdWx0cy4KICAgICAgICAgICAgICAgICAgICAgICAgSWYgRmFsc2UsIHdpbGwgam9pbiB0aGUgYWdncmVnYXRlZCByZXN1bHRzIHdpdGggdGhlIG9yaWdpbmFsIGRhdGFmcmFtZQogICAgOnBhcmFtIGRyb3BfbmE6ICAgICBXaWxsIGRyb3AgbmEgbGluZXMgZHVlIHRvIHRoZSBSb2xsaW5nLgogICAgOnBhcmFtIGZpbGVzX3RvX3NlbGVjdDogU3BlY2lmaWVzIHRoZSBudW1iZXIgb2YgKmxhdGVzdCogZmlsZXMgdG8gc2VsZWN0IChhbmQgY29uY2F0KSBmb3IgYWdncmVnYXRpb24uCiAgICAiIiIKICAgIHByaW50KCJjaS10ZXN0IikgICMgZGVsZXRlCiAgICBmcm9tX21vZGVsID0gdHlwZShkZl9hcnRpZmFjdCkgPT0gcGQuRGF0YUZyYW1lCiAgICBpZiBmcm9tX21vZGVsOgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ0FnZ3JlZ2F0aW5nIGZyb20gQnVmZmVyJykKICAgICAgICBpbnB1dF9kZiA9IGRmX2FydGlmYWN0CiAgICBlbHNlOgogICAgICAgIGlmIGRmX2FydGlmYWN0LnVybC5lbmRzd2l0aCgnLycpOiAgICMgaXMgYSBkaXJlY3Rvcnk/CiAgICAgICAgICAgIG1wYXRoID0gW29zLnBhdGguam9pbihkZl9hcnRpZmFjdC51cmwsIGZpbGUpIGZvciBmaWxlIGluIGRmX2FydGlmYWN0Lmxpc3RkaXIoKSBpZiBmaWxlLmVuZHN3aXRoKCgncGFycXVldCcsICdwcScpKV0KICAgICAgICAgICAgZmlsZXNfYnlfdXBkYXRlZCA9IHNvcnRlZChtcGF0aCwga2V5PW9zLnBhdGguZ2V0bXRpbWUsIHJldmVyc2U9VHJ1ZSkKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmaWxlc19ieV91cGRhdGVkKQogICAgICAgICAgICBsYXRlc3QgPSBmaWxlc19ieV91cGRhdGVkWzpmaWxlc190b19zZWxlY3RdCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidBZ2dyZWdhdGluZyB7bGF0ZXN0fScpCiAgICAgICAgICAgIGlucHV0X2RmID0gcGQuY29uY2F0KFtjb250ZXh0LmdldF9kYXRhaXRlbShkZikuYXNfZGYoKSBmb3IgZGYgaW4gbGF0ZXN0XSkKICAgICAgICBlbHNlOiAgIyBBIHJlZ3VsYXIgYXJ0aWZhY3QKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ0FnZ3JlZ2F0aW5nIHtkZl9hcnRpZmFjdC51cmx9JykKICAgICAgICAgICAgaW5wdXRfZGYgPSBkZl9hcnRpZmFjdC5hc19kZigpCiAgICAKICAgIGlmIG5vdCAobWV0cmljcyBvciBsYWJlbHMpOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ3BsZWFzZSBzcGVjaWZ5IG1ldHJpY3Mgb3IgbGFiZWxzIHBhcmFtJykKICAgIAogICAgaWYga2V5czoKICAgICAgICBjdXJyZW50X2luZGV4ID0gaW5wdXRfZGYuaW5kZXgubmFtZXMKICAgICAgICBpbmRleGVzX3RvX2Ryb3AgPSBbY29sIGZvciBjb2wgaW4gaW5wdXRfZGYuaW5kZXgubmFtZXMgaWYgY29sIG5vdCBpbiBrZXlzXQogICAgICAgIGRmID0gaW5wdXRfZGYucmVzZXRfaW5kZXgobGV2ZWw9aW5kZXhlc190b19kcm9wKQogICAgZWxzZToKICAgICAgICBkZiA9IGlucHV0X2RmCiAgICAgICAgCiAgICBpZiBtZXRyaWNzOgogICAgICAgIG1ldHJpY3NfZGYgPSBkZi5sb2NbOiwgbWV0cmljc10ucm9sbGluZyh3aW5kb3c9d2luZG93LCBjZW50ZXI9Y2VudGVyKS5hZ2dyZWdhdGUobWV0cmljX2FnZ3JlZ2F0aW9ucykKICAgICAgICBtZXRyaWNzX2RmLmNvbHVtbnMgPSBbJ18nLmpvaW4oY29sKS5zdHJpcCgpIGZvciBjb2wgaW4gbWV0cmljc19kZi5jb2x1bW5zLnZhbHVlc10KICAgICAgICAKICAgICAgICBpZiBzdWZmaXg6CiAgICAgICAgICAgIG1ldHJpY3NfZGYuY29sdW1ucyA9IFtmJ3ttZXRyaWN9X3tzdWZmaXh9JyBmb3IgbWV0cmljIGluIG1ldHJpY3NfZGYuY29sdW1uc10KICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlucGxhY2U6CiAgICAgICAgICAgIGZpbmFsX2RmID0gcGQubWVyZ2UoaW5wdXRfZGYsIG1ldHJpY3NfZGYsIHN1ZmZpeGVzPSgnJywgc3VmZml4KSwgbGVmdF9pbmRleD1UcnVlLCByaWdodF9pbmRleD1UcnVlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZpbmFsX2RmID0gbWV0cmljc19kZgoKICAgIGlmIGxhYmVsczoKICAgICAgICBsYWJlbHNfZGYgPSBkZi5sb2NbOiwgbGFiZWxzXS5yb2xsaW5nKHdpbmRvdz13aW5kb3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXI9Y2VudGVyKS5hZ2dyZWdhdGUobGFiZWxfYWdncmVnYXRpb25zKQogICAgICAgIGxhYmVsc19kZi5jb2x1bW5zID0gWydfJy5qb2luKGNvbCkuc3RyaXAoKSBmb3IgY29sIGluIGxhYmVsc19kZi5jb2x1bW5zLnZhbHVlc10KICAgICAgICAKICAgICAgICBpZiBzdWZmaXg6CiAgICAgICAgICAgIGxhYmVsc19kZi5jb2x1bW5zID0gW2Yne2xhYmVsfV97c3VmZml4fScgZm9yIGxhYmVsIGluIGxhYmVsc19kZi5jb2x1bW5zXQogICAgICAgICAgICAKICAgICAgICBpZiBtZXRyaWNzOgogICAgICAgICAgICBmaW5hbF9kZiA9IHBkLm1lcmdlKGZpbmFsX2RmLCBsYWJlbHNfZGYsIHN1ZmZpeGVzPSgnJywgc3VmZml4KSwgbGVmdF9pbmRleD1UcnVlLCByaWdodF9pbmRleD1UcnVlKSAgIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5vdCBpbnBsYWNlOgogICAgICAgICAgICAgICAgZmluYWxfZGYgPSBwZC5tZXJnZShpbnB1dF9kZiwgbGFiZWxzX2RmLCBzdWZmaXhlcz0oJycsIHN1ZmZpeCksIGxlZnRfaW5kZXg9VHJ1ZSwgcmlnaHRfaW5kZXg9VHJ1ZSkgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZpbmFsX2RmID0gbGFiZWxzX2RmCiAgICAgICAgICAgICAgICAKICAgIGlmIGRyb3BfbmE6CiAgICAgICAgZmluYWxfZGYgPSBmaW5hbF9kZi5kcm9wbmEoKQogICAgICAgIAogICAgY29udGV4dC5sb2dnZXIuaW5mbygnTG9nZ2luZyBhcnRpZmFjdCcpCiAgICBpZiBub3QgZnJvbV9tb2RlbDoKICAgICAgICBjb250ZXh0LmxvZ19kYXRhc2V0KGtleT0nYWdncmVnYXRlJywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZj1maW5hbF9kZiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQ9J3BhcnF1ZXQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxfcGF0aD1zYXZlX3RvKQogICAgZWxzZToKICAgICAgICByZXR1cm4gZmluYWxfZGYKCg==
    commands: []
    code_origin: https://github.com/yonishelach/functions.git#63fa485600797edb8020f86b20a56e20e2928946:/Users/Yonatan_Shelach/projects/functions/aggregate/aggregate.py
    origin_filename: /Users/Yonatan_Shelach/projects/functions/aggregate/aggregate.py
    requirements: []
  entry_points:
    aggregate:
      name: aggregate
      doc: 'Time-series aggregation function


        Will perform a rolling aggregation on {df_artifact}, over {window} by the
        selected {keys}

        applying {metric_aggregations} on {metrics} and {label_aggregations} on {labels}.
        adding {suffix} to the

        feature names.


        if not {inplace}, will return the original {df_artifact}, joined by the aggregated
        result.'
      parameters:
      - name: context
        doc: After running a job, you need to be able to track it. To gain the maximum
          value, MLRun uses the job context object inside the code. This provides
          access to job metadata, parameters, inputs, secrets, and API for logging
          and monitoring the results, as well as log text, files, artifacts, and labels.
        default: ''
      - name: df_artifact
        type: Union[DataItem, pd.core.frame.DataFrame]
        doc: MLRun input pointing to pandas dataframe (csv/parquet file path) or a  directory
          containing parquet files. * When given a directory the latest {files_to_select}
          will be selected
        default: ''
      - name: save_to
        type: str
        doc: Where to save the result dataframe. * If relative will add to the {artifact_path}
        default: aggregated-df.pq
      - name: keys
        type: list
        doc: Subset of indexes from the source dataframe to aggregate by (default=all)
        default: null
      - name: metrics
        type: list
        doc: 'Array containing a list of metrics to run the aggregations on. (default=None) '
        default: null
      - name: labels
        type: list
        doc: 'Array containing a list of labels to run the aggregations on. (default=None) '
        default: null
      - name: metric_aggregations
        type: list
        doc: 'Array containing a list of aggregation function names to run on {metrics}.
          (Ex: ''mean'', ''std'') (default=''mean'')'
        default:
        - mean
      - name: label_aggregations
        type: list
        doc: 'Array containing a list of aggregation function names to run on {metrics}.
          (Ex: ''max'', ''min'') (default=''max'') '
        default:
        - max
      - name: suffix
        type: str
        doc: 'Suffix to add to the feature name, E.g: <Feature_Name>_<Agg_Function>_<Suffix>
          (Ex: ''last_60_minutes'') (default='''')'
        default: ''
      - name: window
        type: int
        doc: Window size to perform the rolling aggregate on. (default=3)
        default: 3
      - name: center
        type: bool
        doc: If True, Sets the value for the central sample in the window, If False,
          will set the value to the last sample. (default=False)
        default: false
      - name: inplace
        type: bool
        doc: If True, will return only the aggregated results. If False, will join
          the aggregated results with the original dataframe
        default: false
      - name: drop_na
        type: bool
        doc: Will drop na lines due to the Rolling.
        default: true
      - name: files_to_select
        type: int
        doc: Specifies the number of *latest* files to select (and concat) for aggregation.
        default: 1
      outputs:
      - default: ''
      lineno: 24
  description: Rolling aggregation over Metrics and Lables according to specifications
  default_handler: aggregate
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
