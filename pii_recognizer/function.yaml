kind: job
metadata:
  name: pii-recognizer
  tag: ''
  hash: 84a4076c150813cbfbc3993f6f2f8fede4634dd9
  project: default
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCmltcG9ydCB3YXJuaW5ncwppbXBvcnQgb3MKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG1scnVuCmltcG9ydCBwYXRobGliCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgbmx0awpmcm9tIHRxZG0uYXV0byBpbXBvcnQgdHFkbQpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgVHVwbGUsIFNldCwgT3B0aW9uYWwsIERpY3QsIEFueSwgVW5pb24KZnJvbSBjb2xsZWN0aW9ucy5hYmMgaW1wb3J0IEl0ZXJhYmxlCmltcG9ydCBwcmVzaWRpb19hbmFseXplciBhcyBwYQppbXBvcnQgcHJlc2lkaW9fYW5vbnltaXplciBhcyBwcmVfYW5veW1pemVyCmZyb20gcHJlc2lkaW9fYW5vbnltaXplci5lbnRpdGllcyBpbXBvcnQgT3BlcmF0b3JDb25maWcKaW1wb3J0IGFubm90YXRlZF90ZXh0LnV0aWwgYXMgYXRfdXRpbAoKdHJ5OgogICAgaW1wb3J0IGZsYWlyIGFzIGZsCmV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yOgogICAgcHJpbnQoIkZsYWlyIGlzIG5vdCBpbnN0YWxsZWQiKQoKIyBUaGVyZSBpcyBhIGNvbmZsaWN0IGJldHdlZW4gUnVzdC1iYXNlZCB0b2tlbml6ZXJzJyBwYXJhbGxlbCBwcm9jZXNzaW5nCiMgYW5kIFB5dGhvbidzIGZvcmsgb3BlcmF0aW9ucyBkdXJpbmcgbXVsdGlwcm9jZXNzaW5nLiBUbyBhdm9pZCB0aGlzLCB3ZSBuZWVkCiMgdGhlIGZvbGxvd2luZyB0d28gbGluZXMKCm9zLmVudmlyb25bIlRPS0VOSVpFUlNfUEFSQUxMRUxJU00iXSA9ICJmYWxzZSIKd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoImlnbm9yZSIpCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcigicGlpLXJlY29nbml6ZXIiKQoKCmNsYXNzIFBhdHRlcm5SZWNvZ25pemVyRmFjdG9yeToKICAgICIiIgogICAgRmFjdG9yeSBmb3IgY3JlYXRpbmcgcGF0dGVybiByZWNvZ25pemVycywgaXQgY2FuIGJlIGV4dGVuZGVkIGluIHRoZSBmdXR1cmUgdG8KICAgIGFkZCBtb3JlIHJlZ2V4IHBhdHRlcm4gZm9yIGRpZmZlcmVudCBlbnRpdGllcy4gRm9yIHRoZSBwYXR0ZXJuIHJlY29nbml6ZXIgdG8gd29yaywKICAgIHdlIG5lZWQgY29uc3RydWN0IGEgbGlzdCBvZiByZWdleCBwYXR0ZXJucyBmb3IgZWFjaCBlbnRpdHkuCiAgICAiIiIKCiAgICBfREVGQVVMVF9FTlRJVElFUyA9IHsKICAgICAgICAiQ1JFRElUX0NBUkQiOiBbcGEuUGF0dGVybigiQ1JFRElUX0NBUkQiLCByIlxiKD86XGRbIC1dKj8pezEzLDE2fVxiIiwgMC41KV0sCiAgICAgICAgIlNTTiI6IFtwYS5QYXR0ZXJuKCJTU04iLCByIlxiXGR7M30tP1xkezJ9LT9cZHs0fVxiIiwgMC41KV0sCiAgICAgICAgIlBIT05FIjogW3BhLlBhdHRlcm4oIlBIT05FIiwgciJcKD9cZHszfVwpP1stLlxzXT9cZHszfVstLlxzXT9cZHs0fSIsIDAuNSldLAogICAgICAgICJFTUFJTCI6IFtwYS5QYXR0ZXJuKCJFTUFJTCIsIHIiXFMrQFxTKyIsIDAuNSldLAogICAgfQoKICAgICMgY3JlYXRlIGEgbGlzdCBvZiBwYXR0ZXJuIHJlY29nbml6ZXJzCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBfY3JlYXRlX3BhdHRlcm5fcmVjb2duaXplcihjbHMpOgogICAgICAgICIiIgogICAgICAgIEZvciBlYWNoIGVudGl0eSwgY3JlYXRlIGEgbGlzdCBvZiBwYXR0ZXJucyB0byByZWNvZ25pemUgaXQKCiAgICAgICAgOnBhcmFtIGNsczogUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5IGNsYXNzCgogICAgICAgIDpyZXR1cm5zOiBMaXN0IG9mIHBhdHRlcm4gcmVjb2duaXplcnMKICAgICAgICAiIiIKCiAgICAgICAgIyBFbnRpdGllcyB0byByZWNvZ25pemUgYW5kIHRoZWlyIHJlZ2V4IHBhdHRlcm5zCgogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIHBhLlBhdHRlcm5SZWNvZ25pemVyKHN1cHBvcnRlZF9lbnRpdHk9ZW50aXR5LCBwYXR0ZXJucz1wYXR0ZXJuKQogICAgICAgICAgICBmb3IgZW50aXR5LCBwYXR0ZXJuIGluIGNscy5fREVGQVVMVF9FTlRJVElFUy5pdGVtcygpCiAgICAgICAgXQoKCmNsYXNzIEN1c3RvbVNwYWN5UmVjb2duaXplcihwYS5Mb2NhbFJlY29nbml6ZXIpOgogICAgIiIiCiAgICBDdXN0b20gU3BhY3kgUmVjb2duaXplciBmcm9tIFByZXNpZGlvIEFuYWx5emVyIHRyYWluZWQgb24gUHJpdnkgZGF0YS4KICAgIFRoZSBwcml2eSBkYXRhIGlzIGdlbmVyYXRlZCB1c2luZyB0aGlzIGh0dHBzOi8vZ2l0aHViLmNvbS9waXhpZS1pby9waXhpZS90cmVlL21haW4vc3JjL2RhdGFnZW4vcGlpL3ByaXZ5CiAgICBJdCBjYW4gYmUgdXNlZCB0byByZWNvZ25pemUgY3VzdG9tIGVudGl0aWVzLCBTaW5jZSB3ZSB3YW50IHRvIHVzZSBQcmVzaWRpbydzIFJlZ2lzdHJpZXMgdG8gZ2VuZXJhdGUgQW5hbHl6ZXJFbmdpbmUsCiAgICBpdCBpbmhlcml0cyBmcm9tIFByZXNpZGlvIEFuYWx5emVyJ3MgTG9jYWxSZWNvZ25pemVyIGNsYXNzLgogICAgIiIiCgogICAgIyBFbnRpdGllcyB0byByZWNvZ25pemUKCiAgICBfREVGQVVMVF9FTlRJVElFUyA9IFsKICAgICAgICAiTE9DQVRJT04iLAogICAgICAgICJQRVJTT04iLAogICAgICAgICJOUlAiLAogICAgICAgICJPUkdBTklaQVRJT04iLAogICAgICAgICJEQVRFX1RJTUUiLAogICAgXQoKICAgICMgRGVmYXVsdCBleHBsYW5hdGlvbiBmb3IgdGhpcyByZWNvZ25pemVyCgogICAgX0RFRkFVTFRfRVhQTEFOQVRJT04gPSAoCiAgICAgICAgIklkZW50aWZpZWQgYXMge30gYnkgU3BhY3kncyBOYW1lZCBFbnRpdHkgUmVjb2duaXRpb24gKFByaXZ5LXRyYWluZWQpIgogICAgKQoKICAgICMgTGFiZWwgZ3JvdXBzIHRvIGNoZWNrCgogICAgX0RFRkFVTFRfQ0hFQ0tfTEFCRUxfR1JPVVBTID0gWwogICAgICAgICh7IkxPQ0FUSU9OIn0sIHsiTE9DIiwgIkxPQ0FUSU9OIiwgIlNUUkVFVF9BRERSRVNTIiwgIkNPT1JESU5BVEUifSksCiAgICAgICAgKHsiUEVSU09OIn0sIHsiUEVSIiwgIlBFUlNPTiJ9KSwKICAgICAgICAoeyJOUlAifSwgeyJOT1JQIiwgIk5SUCJ9KSwKICAgICAgICAoeyJPUkdBTklaQVRJT04ifSwgeyJPUkcifSksCiAgICAgICAgKHsiREFURV9USU1FIn0sIHsiREFURV9USU1FIn0pLAogICAgXQoKICAgICMgcHJldHJhaW5lZCBtb2RlbCBmb3IgdGhpcyByZWNvZ25pemVyCgogICAgX0RFRkFVTFRfTU9ERUxfTEFOR1VBR0VTID0gewogICAgICAgICJlbiI6ICJiZWtpL2VuX3NwYWN5X3BpaV9kaXN0aWxiZXJ0IiwKICAgIH0KCiAgICBfREVGQVVMVF9QUkVTSURJT19FUVVJVkFMRU5DRVMgPSB7CiAgICAgICAgIlBFUiI6ICJQRVJTT04iLAogICAgICAgICJMT0MiOiAiTE9DQVRJT04iLAogICAgICAgICJPUkciOiAiT1JHQU5JWkFUSU9OIiwKICAgICAgICAiTlJPUCI6ICJOUlAiLAogICAgICAgICJEQVRFX1RJTUUiOiAiREFURV9USU1FIiwKICAgIH0KCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBzdXBwb3J0ZWRfbGFuZ3VhZ2U6IHN0ciA9ICJlbiIsCiAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzOiBMaXN0W3N0cl0gPSBOb25lLAogICAgICAgIGNoZWNrX2xhYmVsX2dyb3VwczogVHVwbGVbU2V0LCBTZXRdID0gTm9uZSwKICAgICAgICBjb250ZXh0OiBMaXN0W3N0cl0gPSBOb25lLAogICAgICAgIG5lcl9zdHJlbmd0aDogZmxvYXQgPSAxLAogICAgKToKICAgICAgICAiIiIKICAgICAgICBJbml0aWFsaXplIFNwYWN5IFJlY29nbml6ZXIuCgogICAgICAgIDpwYXJhbSBzdXBwb3J0ZWRfbGFuZ3VhZ2U6IExhbmd1YWdlIHRvIHVzZSwgZGVmYXVsdCBpcyBFbmdsaXNoCiAgICAgICAgOnBhcmFtIHN1cHBvcnRlZF9lbnRpdGllczogRW50aXRpZXMgdG8gdXNlIGZvciByZWNvZ25pdGlvbgogICAgICAgIDpwYXJhbSBjaGVja19sYWJlbF9ncm91cHM6IExhYmVsIGdyb3VwcyB0byBjaGVjayBmb3IgdGhlIGVudGl0aWVzCiAgICAgICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICAgQ29udGV4dCB0byB1c2UgaWYgYW55CiAgICAgICAgOnBhcmFtIG5lcl9zdHJlbmd0aDogICAgICAgRGVmYXVsdCBjb25maWRlbmNlIGZvciBORVIgcHJlZGljdGlvbgoKICAgICAgICA6cmV0dXJuczogU3BhY3lSZWNvZ25pemVyIG9iamVjdAogICAgICAgICIiIgoKICAgICAgICAjIERlZmF1bHQgY29uZmlkZW5jZSBmb3IgTkVSIHByZWRpY3Rpb24KICAgICAgICBzZWxmLm5lcl9zdHJlbmd0aCA9IG5lcl9zdHJlbmd0aAoKICAgICAgICBzZWxmLmNoZWNrX2xhYmVsX2dyb3VwcyA9IGNoZWNrX2xhYmVsX2dyb3VwcyBvciBzZWxmLl9ERUZBVUxUX0NIRUNLX0xBQkVMX0dST1VQUwogICAgICAgIHN1cHBvcnRlZF9lbnRpdGllcyA9IHN1cHBvcnRlZF9lbnRpdGllcyBvciBzZWxmLl9ERUZBVUxUX0VOVElUSUVTCiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygKICAgICAgICAgICAgc3VwcG9ydGVkX2VudGl0aWVzPXN1cHBvcnRlZF9lbnRpdGllcywKICAgICAgICAgICAgc3VwcG9ydGVkX2xhbmd1YWdlPXN1cHBvcnRlZF9sYW5ndWFnZSwKICAgICAgICApCgogICAgIyBnZXQgdGhlIHByZXNpZGlvIGV4cGxhbmF0aW9uIGZvciB0aGUgcmVzdWx0CgogICAgZGVmIF9idWlsZF9zcGFjeV9leHBsYW5hdGlvbigKICAgICAgICBzZWxmLCBvcmlnaW5hbF9zY29yZTogZmxvYXQsIGV4cGxhbmF0aW9uOiBzdHIKICAgICkgLT4gcGEuQW5hbHlzaXNFeHBsYW5hdGlvbjoKICAgICAgICAiIiIKICAgICAgICBDcmVhdGUgZXhwbGFuYXRpb24gZm9yIHdoeSB0aGlzIHJlc3VsdCB3YXMgZGV0ZWN0ZWQuCgogICAgICAgIDpwYXJhbSBvcmlnaW5hbF9zY29yZTogU2NvcmUgZ2l2ZW4gYnkgdGhpcyByZWNvZ25pemVyCiAgICAgICAgOnBhcmFtIGV4cGxhbmF0aW9uOiAgICBFeHBsYW5hdGlvbiBzdHJpbmcKCiAgICAgICAgOnJldHVybnM6IFByZXNpZGlvIEFuYWx5c2lzRXhwbGFuYXRpb24gb2JqZWN0CiAgICAgICAgIiIiCiAgICAgICAgZXhwbGFuYXRpb24gPSBwYS5BbmFseXNpc0V4cGxhbmF0aW9uKAogICAgICAgICAgICByZWNvZ25pemVyPXNlbGYuX19jbGFzc19fLl9fbmFtZV9fLAogICAgICAgICAgICBvcmlnaW5hbF9zY29yZT1vcmlnaW5hbF9zY29yZSwKICAgICAgICAgICAgdGV4dHVhbF9leHBsYW5hdGlvbj1leHBsYW5hdGlvbiwKICAgICAgICApCiAgICAgICAgcmV0dXJuIGV4cGxhbmF0aW9uCgogICAgIyBtYWluIG1ldGhvZCBmb3IgdGhlIHJlY29nbml6ZXIKICAgIGRlZiBhbmFseXplKHNlbGYsIHRleHQ6IHN0ciwgZW50aXRpZXM6IExpc3Rbc3RyXSwgbmxwX2FydGlmYWN0cz1Ob25lKTogICMgbm9xYSBEMTAyCiAgICAgICAgIiIiCiAgICAgICAgQW5hbHl6ZSB0ZXh0IHVzaW5nIFNwYWN5LgoKICAgICAgICA6cGFyYW0gdGV4dDogICAgICAgICAgVGV4dCB0byBhbmFseXplCiAgICAgICAgOnBhcmFtIGVudGl0aWVzOiAgICAgIEVudGl0aWVzIHRvIGFuYWx5emUKICAgICAgICA6cGFyYW0gbmxwX2FydGlmYWN0czogTkxQIGFydGlmYWN0cyB0byB1c2UKCiAgICAgICAgOnJldHVybnM6IExpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBvYmplY3RzCiAgICAgICAgIiIiCiAgICAgICAgcmVzdWx0cyA9IFtdCiAgICAgICAgaWYgbm90IG5scF9hcnRpZmFjdHM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJTa2lwcGluZyBTcGFDeSwgbmxwIGFydGlmYWN0cyBub3QgcHJvdmlkZWQuLi4iKQogICAgICAgICAgICByZXR1cm4gcmVzdWx0cwoKICAgICAgICBuZXJfZW50aXRpZXMgPSBubHBfYXJ0aWZhY3RzLmVudGl0aWVzCgogICAgICAgICMgcmVjb2duaXplIHRoZSBzdXBwb3J0ZWQgZW50aXRpZXMKICAgICAgICBmb3IgZW50aXR5IGluIGVudGl0aWVzOgogICAgICAgICAgICBpZiBlbnRpdHkgbm90IGluIHNlbGYuc3VwcG9ydGVkX2VudGl0aWVzOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgZm9yIGVudCBpbiBuZXJfZW50aXRpZXM6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fX2NoZWNrX2xhYmVsKGVudGl0eSwgZW50LmxhYmVsXywgc2VsZi5jaGVja19sYWJlbF9ncm91cHMpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgIyBzdHJpbmcgb2YgdGhlIGV4cGxhbmF0aW9uIHNheWluZyB0aGUgZW50aXR5IGlzIHJlY29nbml6ZWQgYnkgc3BhY3kKICAgICAgICAgICAgICAgIHRleHR1YWxfZXhwbGFuYXRpb24gPSBzZWxmLl9ERUZBVUxUX0VYUExBTkFUSU9OLmZvcm1hdChlbnQubGFiZWxfKQogICAgICAgICAgICAgICAgZXhwbGFuYXRpb24gPSBzZWxmLl9idWlsZF9zcGFjeV9leHBsYW5hdGlvbigKICAgICAgICAgICAgICAgICAgICBzZWxmLm5lcl9zdHJlbmd0aCwgdGV4dHVhbF9leHBsYW5hdGlvbgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICMgY3JlYXRlIHRoZSBzdGFuZGFyZCByZXN1bHQgd2l0aCB0aGUgZW50aXR5LCBzdGFydCwgZW5kLCBzY29yZSwgYW5kIGV4cGxhbmF0aW9uCiAgICAgICAgICAgICAgICBzcGFjeV9yZXN1bHQgPSBwYS5SZWNvZ25pemVyUmVzdWx0KAogICAgICAgICAgICAgICAgICAgIGVudGl0eV90eXBlPWVudGl0eSwKICAgICAgICAgICAgICAgICAgICBzdGFydD1lbnQuc3RhcnRfY2hhciwKICAgICAgICAgICAgICAgICAgICBlbmQ9ZW50LmVuZF9jaGFyLAogICAgICAgICAgICAgICAgICAgIHNjb3JlPXNlbGYubmVyX3N0cmVuZ3RoLAogICAgICAgICAgICAgICAgICAgIGFuYWx5c2lzX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICAgICAgICAgICAgIHJlY29nbml0aW9uX21ldGFkYXRhPXsKICAgICAgICAgICAgICAgICAgICAgICAgcGEuUmVjb2duaXplclJlc3VsdC5SRUNPR05JWkVSX05BTUVfS0VZOiBzZWxmLm5hbWUKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoc3BhY3lfcmVzdWx0KQoKICAgICAgICByZXR1cm4gcmVzdWx0cwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfX2NoZWNrX2xhYmVsKAogICAgICAgIGVudGl0eTogc3RyLCBsYWJlbDogc3RyLCBjaGVja19sYWJlbF9ncm91cHM6IFR1cGxlW1NldCwgU2V0XQogICAgKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIENoZWNrIGlmIHRoZSBsYWJlbCBpcyBpbiB0aGUgbGFiZWwgZ3JvdXAuCgogICAgICAgIDpwYXJhbSBlbnRpdHk6ICAgICAgICAgICAgIEVudGl0eSB0byBjaGVjawogICAgICAgIDpwYXJhbSBsYWJlbDogICAgICAgICAgICAgIExhYmVsIHRvIGNoZWNrCiAgICAgICAgOnBhcmFtIGNoZWNrX2xhYmVsX2dyb3VwczogTGFiZWwgZ3JvdXBzIHRvIGNoZWNrCgogICAgICAgIDpyZXR1cm5zOiBUcnVlIGlmIHRoZSBsYWJlbCBpcyBpbiB0aGUgbGFiZWwgZ3JvdXAsIEZhbHNlIG90aGVyd2lzZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBhbnkoCiAgICAgICAgICAgIGVudGl0eSBpbiBlZ3JwIGFuZCBsYWJlbCBpbiBsZ3JwIGZvciBlZ3JwLCBsZ3JwIGluIGNoZWNrX2xhYmVsX2dyb3VwcwogICAgICAgICkKCgojIENsYXNzIHRvIHVzZSBGbGFpciB3aXRoIFByZXNpZGlvIGFzIGFuIGV4dGVybmFsIHJlY29nbml6ZXIuCmNsYXNzIEZsYWlyUmVjb2duaXplcihwYS5FbnRpdHlSZWNvZ25pemVyKToKICAgICIiIgogICAgV3JhcHBlciBmb3IgYSBmbGFpciBtb2RlbCwgaWYgbmVlZGVkIHRvIGJlIHVzZWQgd2l0aGluIFByZXNpZGlvIEFuYWx5emVyLgogICAgVGhpcyBpcyB0byBtYWtlIHN1cmUgdGhlIHJlY29nbml6ZXIgY2FuIGJlIHJlZ2lzdGVyZWQgd2l0aCBQcmVzaWRpbyByZWdpc3RyeS4KICAgICIiIgoKICAgIF9ERUZBVUxUX0VOVElUSUVTID0gWwogICAgICAgICJMT0NBVElPTiIsCiAgICAgICAgIlBFUlNPTiIsCiAgICAgICAgIk5SUCIsCiAgICAgICAgIkdQRSIsCiAgICAgICAgIk9SR0FOSVpBVElPTiIsCiAgICAgICAgIk1BQ19BRERSRVNTIiwKICAgICAgICAiVVNfQkFOS19OVU1CRVIiLAogICAgICAgICJJTUVJIiwKICAgICAgICAiVElUTEUiLAogICAgICAgICJMSUNFTlNFX1BMQVRFIiwKICAgICAgICAiVVNfUEFTU1BPUlQiLAogICAgICAgICJDVVJSRU5DWSIsCiAgICAgICAgIlJPVVRJTkdfTlVNQkVSIiwKICAgICAgICAiVVNfSVRJTiIsCiAgICAgICAgIlVTX0JBTktfTlVNQkVSIiwKICAgICAgICAiVVNfRFJJVkVSX0xJQ0VOU0UiLAogICAgICAgICJBR0UiLAogICAgICAgICJQQVNTV09SRCIsCiAgICAgICAgIlNXSUZUX0NPREUiLAogICAgXQoKICAgICMgVGhpcyBpcyB1c2VkIHRvIGNvbnN0cnVjdCB0aGUgZXhwbGFuYXRpb24gZm9yIHRoZSByZXN1bHQKCiAgICBfREVGQVVMVF9FWFBMQU5BVElPTiA9ICJJZGVudGlmaWVkIGFzIHt9IGJ5IEZsYWlyJ3MgTmFtZWQgRW50aXR5IFJlY29nbml0aW9uIgoKICAgIF9ERUZBVUxUX0NIRUNLX0xBQkVMX0dST1VQUyA9IFsKICAgICAgICAoeyJMT0NBVElPTiJ9LCB7IkxPQyIsICJMT0NBVElPTiIsICJTVFJFRVRfQUREUkVTUyIsICJDT09SRElOQVRFIn0pLAogICAgICAgICh7IlBFUlNPTiJ9LCB7IlBFUiIsICJQRVJTT04ifSksCiAgICAgICAgKHsiTlJQIn0sIHsiTk9SUCIsICJOUlAifSksCiAgICAgICAgKHsiR1BFIn0sIHsiR1BFIn0pLAogICAgICAgICh7Ik9SR0FOSVpBVElPTiJ9LCB7Ik9SRyJ9KSwKICAgICAgICAoeyJNQUNfQUREUkVTUyJ9LCB7Ik1BQ19BRERSRVNTIn0pLAogICAgICAgICh7IlVTX0JBTktfTlVNQkVSIn0sIHsiVVNfQkFOS19OVU1CRVIifSksCiAgICAgICAgKHsiSU1FSSJ9LCB7IklNRUkifSksCiAgICAgICAgKHsiVElUTEUifSwgeyJUSVRMRSJ9KSwKICAgICAgICAoeyJMSUNFTlNFX1BMQVRFIn0sIHsiTElDRU5TRV9QTEFURSJ9KSwKICAgICAgICAoeyJVU19QQVNTUE9SVCJ9LCB7IlVTX1BBU1NQT1JUIn0pLAogICAgICAgICh7IkNVUlJFTkNZIn0sIHsiQ1VSUkVOQ1kifSksCiAgICAgICAgKHsiUk9VVElOR19OVU1CRVIifSwgeyJST1VUSU5HX05VTUJFUiJ9KSwKICAgICAgICAoeyJBR0UifSwgeyJBR0UifSksCiAgICAgICAgKHsiQ1VSUkVOQ1kifSwgeyJDVVJSRU5DWSJ9KSwKICAgICAgICAoeyJTV0lGVF9DT0RFIn0sIHsiU1dJRlRfQ09ERSJ9KSwKICAgICAgICAoeyJVU19JVElOIn0sIHsiVVNfSVRJTiJ9KSwKICAgICAgICAoeyJVU19CQU5LX05VTUJFUiJ9LCB7IlVTX0JBTktfTlVNQkVSIn0pLAogICAgICAgICh7IlVTX0RSSVZFUl9MSUNFTlNFIn0sIHsiVVNfRFJJVkVSX0xJQ0VOU0UifSksCiAgICBdCgogICAgX0RFRkFVTFRfTU9ERUxfTEFOR1VBR0VTID0gewogICAgICAgICJlbiI6ICJiZWtpL2ZsYWlyLXBpaS1kaXN0aWxiZXJ0IiwKICAgIH0KCiAgICBfREVGQVVMVF9QUkVTSURJT19FUVVJVkFMRU5DRVMgPSB7CiAgICAgICAgIlBFUiI6ICJQRVJTT04iLAogICAgICAgICJMT0MiOiAiTE9DQVRJT04iLAogICAgICAgICJPUkciOiAiT1JHQU5JWkFUSU9OIiwKICAgICAgICAiTlJPUCI6ICJOUlAiLAogICAgICAgICJVUkwiOiAiVVJMIiwKICAgICAgICAiVVNfSVRJTiI6ICJVU19JVElOIiwKICAgICAgICAiVVNfUEFTU1BPUlQiOiAiVVNfUEFTU1BPUlQiLAogICAgICAgICJJQkFOX0NPREUiOiAiSUJBTl9DT0RFIiwKICAgICAgICAiSVBfQUREUkVTUyI6ICJJUF9BRERSRVNTIiwKICAgICAgICAiRU1BSUxfQUREUkVTUyI6ICJFTUFJTCIsCiAgICAgICAgIlVTX0RSSVZFUl9MSUNFTlNFIjogIlVTX0RSSVZFUl9MSUNFTlNFIiwKICAgICAgICAiVVNfQkFOS19OVU1CRVIiOiAiVVNfQkFOS19OVU1CRVIiLAogICAgfQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZTogc3RyID0gImVuIiwKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXM6IExpc3Rbc3RyXSA9IE5vbmUsCiAgICAgICAgY2hlY2tfbGFiZWxfZ3JvdXBzOiBUdXBsZVtTZXQsIFNldF0gPSBOb25lLAogICAgKToKICAgICAgICAiIiIKICAgICAgICBJbml0aWFsaXplIHRoZSBGbGFpclJlY29nbml6ZXIuCgogICAgICAgIDpwYXJhbSBzdXBwb3J0ZWRfbGFuZ3VhZ2U6IExhbmd1YWdlIHRvIHVzZQogICAgICAgIDpwYXJhbSBzdXBwb3J0ZWRfZW50aXRpZXM6IEVudGl0aWVzIHRvIHVzZQogICAgICAgIDpwYXJhbSBjaGVja19sYWJlbF9ncm91cHM6IExhYmVsIGdyb3VwcyB0byBjaGVjawoKICAgICAgICA6cmV0dXJuczogRmxhaXJSZWNvZ25pemVyIG9iamVjdAoKICAgICAgICAiIiIKICAgICAgICBzZWxmLmNoZWNrX2xhYmVsX2dyb3VwcyA9IGNoZWNrX2xhYmVsX2dyb3VwcyBvciBzZWxmLl9ERUZBVUxUX0NIRUNLX0xBQkVMX0dST1VQUwoKICAgICAgICBzdXBwb3J0ZWRfZW50aXRpZXMgPSBzdXBwb3J0ZWRfZW50aXRpZXMgb3Igc2VsZi5fREVGQVVMVF9FTlRJVElFUwogICAgICAgIHNlbGYubW9kZWwgPSBmbC5tb2RlbHMuU2VxdWVuY2VUYWdnZXIubG9hZCgKICAgICAgICAgICAgc2VsZi5fREVGQVVMVF9NT0RFTF9MQU5HVUFHRVMuZ2V0KHN1cHBvcnRlZF9sYW5ndWFnZSkKICAgICAgICApCgogICAgICAgIHN1cGVyKCkuX19pbml0X18oCiAgICAgICAgICAgIHN1cHBvcnRlZF9lbnRpdGllcz1zdXBwb3J0ZWRfZW50aXRpZXMsCiAgICAgICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZT1zdXBwb3J0ZWRfbGFuZ3VhZ2UsCiAgICAgICAgICAgIG5hbWU9IkZsYWlyIEFuYWx5dGljcyIsCiAgICAgICAgKQoKICAgICMgbWFpbiBtZXRob2QgZm9yIHRoZSByZWNvZ25pemVyCiAgICBkZWYgYW5hbHl6ZSgKICAgICAgICBzZWxmLAogICAgICAgIHRleHQ6IHN0ciwKICAgICAgICBlbnRpdGllczogTGlzdFtzdHJdLAogICAgICAgIG5scF9hcnRpZmFjdHM6IHBhLm5scF9lbmdpbmUuTmxwQXJ0aWZhY3RzID0gTm9uZSwKICAgICkgLT4gTGlzdFtwYS5SZWNvZ25pemVyUmVzdWx0XToKICAgICAgICAiIiIKICAgICAgICBBbmFseXplIHRleHQgYW5kIHJldHVybiB0aGUgcmVzdWx0cy4KCiAgICAgICAgOnBhcmFtIHRleHQ6ICAgICAgICAgIFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgICAgICA6cGFyYW0gZW50aXRpZXM6ICAgICAgVGhlIGxpc3Qgb2YgZW50aXRpZXMgdG8gcmVjb2duaXplLgogICAgICAgIDpwYXJhbSBubHBfYXJ0aWZhY3RzOiBOb3QgdXNlZCBieSB0aGlzIHJlY29nbml6ZXIgYnV0IG5lZWRlZCBmb3IgdGhlIGludGVyZmFjZS4KICAgICAgICA6cGFyYW0gbGFuZ3VhZ2U6ICAgICAgVGV4dCBsYW5ndWFnZS4gU3VwcG9ydGVkIGxhbmd1YWdlcyBpbiBNT0RFTF9MQU5HVUFHRVMKCiAgICAgICAgOnJldHVybnM6IFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSB0aGUgcmVjb2duaXplZCBGbGFpciBkZXRlY3Rpb25zLgogICAgICAgICIiIgoKICAgICAgICByZXN1bHRzID0gW10KCiAgICAgICAgc2VudGVuY2VzID0gZmwuZGF0YS5TZW50ZW5jZSh0ZXh0KQogICAgICAgIHNlbGYubW9kZWwucHJlZGljdChzZW50ZW5jZXMpCgogICAgICAgICMgSWYgdGhlcmUgYXJlIG5vIHNwZWNpZmljIGxpc3Qgb2YgZW50aXRpZXMsIHdlIHdpbGwgbG9vayBmb3IgYWxsIG9mIGl0LgogICAgICAgIGlmIG5vdCBlbnRpdGllczoKICAgICAgICAgICAgZW50aXRpZXMgPSBzZWxmLnN1cHBvcnRlZF9lbnRpdGllcwoKICAgICAgICAjIEdvIG92ZXIgdGhlIGVudGl0aWVzIGFuZCBjaGVjayBpZiB0aGV5IGFyZSBpbiB0aGUgc3VwcG9ydGVkIGVudGl0aWVzIGxpc3QuCiAgICAgICAgZm9yIGVudGl0eSBpbiBlbnRpdGllczoKICAgICAgICAgICAgaWYgZW50aXR5IG5vdCBpbiBzZWxmLnN1cHBvcnRlZF9lbnRpdGllczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIEdvIG92ZXIgdGhlIHNlbnRlbmNlcyBhbmQgY2hlY2sgaWYgdGhlIGVudGl0eSBpcyBpbiB0aGUgc2VudGVuY2UuCiAgICAgICAgICAgIGZvciBlbnQgaW4gc2VudGVuY2VzLmdldF9zcGFucygibmVyIik6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fX2NoZWNrX2xhYmVsKAogICAgICAgICAgICAgICAgICAgIGVudGl0eSwgZW50LmxhYmVsc1swXS52YWx1ZSwgc2VsZi5jaGVja19sYWJlbF9ncm91cHMKICAgICAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAjIElmIHRoZSBlbnRpdHkgaXMgaW4gdGhlIHNlbnRlbmNlLCB3ZSB3aWxsIGFkZCBpdCB0byB0aGUgcmVzdWx0cy4KICAgICAgICAgICAgICAgIHRleHR1YWxfZXhwbGFuYXRpb24gPSBzZWxmLl9ERUZBVUxUX0VYUExBTkFUSU9OLmZvcm1hdCgKICAgICAgICAgICAgICAgICAgICBlbnQubGFiZWxzWzBdLnZhbHVlCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgIyBCdWlsZCB0aGUgZXhwbGFuYXRpb24gZm9yIHRoZSByZXN1bHQKICAgICAgICAgICAgICAgIGV4cGxhbmF0aW9uID0gc2VsZi5fYnVpbGRfZmxhaXJfZXhwbGFuYXRpb24oCiAgICAgICAgICAgICAgICAgICAgcm91bmQoZW50LnNjb3JlLCAyKSwgdGV4dHVhbF9leHBsYW5hdGlvbgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGZsYWlyX3Jlc3VsdCA9IHNlbGYuX2NvbnZlcnRfdG9fcmVjb2duaXplcl9yZXN1bHQoZW50LCBleHBsYW5hdGlvbikKCiAgICAgICAgICAgICAgICByZXN1bHRzLmFwcGVuZChmbGFpcl9yZXN1bHQpCgogICAgICAgIHJldHVybiByZXN1bHRzCgogICAgZGVmIF9jb252ZXJ0X3RvX3JlY29nbml6ZXJfcmVzdWx0KAogICAgICAgIHNlbGYsIGVudGl0eTogZmwuZGF0YS5TcGFuLCBleHBsYW5hdGlvbjogc3RyCiAgICApIC0+IHBhLlJlY29nbml6ZXJSZXN1bHQ6CiAgICAgICAgIiIiCiAgICAgICAgQ29udmVydCBGbGFpciByZXN1bHQgdG8gUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdC4KCiAgICAgICAgOnBhcmFtIGVudGl0eTogICAgICBGbGFpciBlbnRpdHkgb2YgU3BhbgogICAgICAgIDpwYXJhbSBleHBsYW5hdGlvbjogUHJlc2lkaW8gQW5hbHlzaXNFeHBsYW5hdGlvbgoKICAgICAgICA6cmV0dXJuczogUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdAogICAgICAgICIiIgoKICAgICAgICAjIENvbnZlcnQgdGhlIGVudGl0eSB0eXBlIHRvIFByZXNpZGlvIGVudGl0eSB0eXBlCiAgICAgICAgZW50aXR5X3R5cGUgPSBzZWxmLl9ERUZBVUxUX1BSRVNJRElPX0VRVUlWQUxFTkNFUy5nZXQoZW50aXR5LnRhZywgZW50aXR5LnRhZykKCiAgICAgICAgIyBDb252ZXJ0IHRoZSBzY29yZSB0byBQcmVzaWRpbyBzY29yZQogICAgICAgIGZsYWlyX3Njb3JlID0gcm91bmQoZW50aXR5LnNjb3JlLCAyKQoKICAgICAgICAjIENyZWF0ZSB0aGUgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBmcm9tIHRoZSBGbGFpciBlbnRpdHkKICAgICAgICBmbGFpcl9yZXN1bHRzID0gcGEuUmVjb2duaXplclJlc3VsdCgKICAgICAgICAgICAgZW50aXR5X3R5cGU9ZW50aXR5X3R5cGUsCiAgICAgICAgICAgIHN0YXJ0PWVudGl0eS5zdGFydF9wb3NpdGlvbiwKICAgICAgICAgICAgZW5kPWVudGl0eS5lbmRfcG9zaXRpb24sCiAgICAgICAgICAgIHNjb3JlPWZsYWlyX3Njb3JlLAogICAgICAgICAgICBhbmFseXNpc19leHBsYW5hdGlvbj1leHBsYW5hdGlvbiwKICAgICAgICApCgogICAgICAgIHJldHVybiBmbGFpcl9yZXN1bHRzCgogICAgZGVmIF9idWlsZF9mbGFpcl9leHBsYW5hdGlvbigKICAgICAgICBzZWxmLCBvcmlnaW5hbF9zY29yZTogZmxvYXQsIGV4cGxhbmF0aW9uOiBzdHIKICAgICkgLT4gcGEuQW5hbHlzaXNFeHBsYW5hdGlvbjoKICAgICAgICAiIiIKICAgICAgICBDcmVhdGUgZXhwbGFuYXRpb24gZm9yIHdoeSB0aGlzIHJlc3VsdCB3YXMgZGV0ZWN0ZWQuCgogICAgICAgIDpwYXJhbSBvcmlnaW5hbF9zY29yZTogU2NvcmUgZ2l2ZW4gYnkgdGhpcyByZWNvZ25pemVyCiAgICAgICAgOnBhcmFtIGV4cGxhbmF0aW9uOiAgICBFeHBsYW5hdGlvbiBzdHJpbmcKCiAgICAgICAgOnJldHVybnM6IFByZXNpZGlvIEFuYWx5c2lzRXhwbGFuYXRpb24KICAgICAgICAiIiIKCiAgICAgICAgIyBDcmVhdGUgdGhlIFByZXNpZGlvIEFuYWx5c2lzRXhwbGFuYXRpb24gZm9yIHRoZSByZXN1bHQKICAgICAgICBleHBsYW5hdGlvbiA9IHBhLkFuYWx5c2lzRXhwbGFuYXRpb24oCiAgICAgICAgICAgIHJlY29nbml6ZXI9c2VsZi5fX2NsYXNzX18uX19uYW1lX18sCiAgICAgICAgICAgIG9yaWdpbmFsX3Njb3JlPW9yaWdpbmFsX3Njb3JlLAogICAgICAgICAgICB0ZXh0dWFsX2V4cGxhbmF0aW9uPWV4cGxhbmF0aW9uLAogICAgICAgICkKICAgICAgICByZXR1cm4gZXhwbGFuYXRpb24KCiAgICAjIHNhbml0eSBjaGVjayBvZiB0aGUgZW50aXR5IGFuZCBsYWJlbCBiZWZvcmUgcmVjb2duaXRpb24KICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfX2NoZWNrX2xhYmVsKAogICAgICAgIGVudGl0eTogc3RyLCBsYWJlbDogc3RyLCBjaGVja19sYWJlbF9ncm91cHM6IFR1cGxlW1NldCwgU2V0XQogICAgKSAtPiBib29sOgogICAgICAgIHJldHVybiBhbnkoCiAgICAgICAgICAgIGVudGl0eSBpbiBlZ3JwIGFuZCBsYWJlbCBpbiBsZ3JwIGZvciBlZ3JwLCBsZ3JwIGluIGNoZWNrX2xhYmVsX2dyb3VwcwogICAgICAgICkKCgojIGdldCB0aGUgYW5hbHl6ZXIgZW5naW5lIGJhc2VkIG9uIHRoZSBtb2RlbApkZWYgX2dldF9hbmFseXplcl9lbmdpbmUoCiAgICBzY29yZV90aHJlc2hvbGQ6IGZsb2F0LCBtb2RlbDogc3RyID0gIndob2xlIgopIC0+IHBhLkFuYWx5emVyRW5naW5lOgogICAgIiIiCiAgICBSZXR1cm4gcGEuQW5hbHl6ZXJFbmdpbmUuCgogICAgOnBhcmFtIG1vZGVsOiBUaGUgbW9kZWwgdG8gdXNlLiBDYW4gYmUgInNwYWN5IiwgImZsYWlyIiwgInBhdHRlcm4iIG9yICJ3aG9sZSIuCgogICAgOnJldHVybnM6IHBhLkFuYWx5emVyRW5naW5lCiAgICAiIiIKICAgICMgcmVjb2duaXplciByZWdpc3RyeSB0aGF0IGNhbiBzdG9yZSBtdWx0aXBsZSByZWNvZ25pemVycwogICAgcmVnaXN0cnkgPSBwYS5SZWNvZ25pemVyUmVnaXN0cnkoKQoKICAgIGlmIG1vZGVsID09ICJzcGFjeSI6CiAgICAgICAgIyBjdXN0b20gc3BhY3kgcmVjb2duaXplcgogICAgICAgIHNwYWN5X3JlY29nbml6ZXIgPSBDdXN0b21TcGFjeVJlY29nbml6ZXIoKQogICAgICAgICMgYWRkIHRoZSBjdXN0b20gYnVpbGQgc3BhY3kgcmVjb2duaXplcgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKHNwYWN5X3JlY29nbml6ZXIpCiAgICBpZiBtb2RlbCA9PSAiZmxhaXIiOgogICAgICAgICMgcHJlLXRyYWluZWQgZmxhaXIgcmVjb2duaXplcgogICAgICAgIGZsYWlyX3JlY29nbml6ZXIgPSBGbGFpclJlY29nbml6ZXIoKQogICAgICAgICMgYWRkIHRoZSBjdXN0b20gYnVpbGQgZmxhaXIgcmVjb2duaXplcgogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICBpZiBtb2RlbCA9PSAicGF0dGVybiI6CiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICBmb3IgcmVjb2duaXplciBpbiBwYXR0ZXJuX3JlY29nbml6ZXJfZmFjdG9yeS5fY3JlYXRlX3BhdHRlcm5fcmVjb2duaXplcigpOgogICAgICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihyZWNvZ25pemVyKQogICAgaWYgbW9kZWwgPT0gIndob2xlIjoKICAgICAgICBzcGFjeV9yZWNvZ25pemVyID0gQ3VzdG9tU3BhY3lSZWNvZ25pemVyKCkKICAgICAgICBmbGFpcl9yZWNvZ25pemVyID0gRmxhaXJSZWNvZ25pemVyKCkKICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihzcGFjeV9yZWNvZ25pemVyKQogICAgICAgIHJlZ2lzdHJ5LmFkZF9yZWNvZ25pemVyKGZsYWlyX3JlY29nbml6ZXIpCiAgICAgICAgIyBhZGQgdGhlIHBhdHRlcm4gcmVjb2duaXplcgogICAgICAgIHBhdHRlcm5fcmVjb2duaXplcl9mYWN0b3J5ID0gUGF0dGVyblJlY29nbml6ZXJGYWN0b3J5KCkKICAgICAgICBmb3IgcmVjb2duaXplciBpbiBwYXR0ZXJuX3JlY29nbml6ZXJfZmFjdG9yeS5fY3JlYXRlX3BhdHRlcm5fcmVjb2duaXplcigpOgogICAgICAgICAgICByZWdpc3RyeS5hZGRfcmVjb2duaXplcihyZWNvZ25pemVyKQoKICAgIGFuYWx5emVyID0gcGEuQW5hbHl6ZXJFbmdpbmUoCiAgICAgICAgZGVmYXVsdF9zY29yZV90aHJlc2hvbGQ9c2NvcmVfdGhyZXNob2xkLAogICAgICAgIHJlZ2lzdHJ5PXJlZ2lzdHJ5LAogICAgICAgIHN1cHBvcnRlZF9sYW5ndWFnZXM9WyJlbiJdLAogICAgKQogICAgcmV0dXJuIGFuYWx5emVyCgoKZGVmIF9nZXRfYW5vbnltaXplcl9lbmdpbmUoKSAtPiBwcmVfYW5veW1pemVyLkFub255bWl6ZXJFbmdpbmU6CiAgICAiIiIKICAgIFJldHVybiBBbm9ueW1pemVyRW5naW5lLgoKICAgIDpyZXR1cm5zOiBUaGUgQW5vbnltaXplckVuZ2luZS4KICAgICIiIgogICAgcmV0dXJuIHByZV9hbm95bWl6ZXIuQW5vbnltaXplckVuZ2luZSgpCgoKZGVmIF9hbm9ueW1pemUoCiAgICB0ZXh0OiBzdHIsCiAgICBhbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sCiAgICBlbnRpdHlfb3BlcmF0b3JfbWFwOiBkaWN0ID0gTm9uZSwKICAgIGlzX2Z1bGxfdGV4dDogYm9vbCA9IFRydWUsCikgLT4gc3RyOgogICAgIiIiCiAgICBBbm9ueW1pemUgaWRlbnRpZmllZCBpbnB1dCB1c2luZyBQcmVzaWRpbyBBYm9ueW1pemVyLgoKICAgIDpwYXJhbSB0ZXh0OiAgICAgICAgICAgIFRoZSB0ZXh0IGZvciBhbmFseXNpcy4KICAgIDpwYXJhbSBhbmFseXplX3Jlc3VsdHM6IFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbQogICAgOnBhcmFtIGVudGl0eV9vcGVyYXRvcl9tYXA6IFRoZSBlbnRpdHlfb3BlcmF0b3JfbWFwIGlzIGEgZGljdGlvbmFyeSB0aGF0IG1hcHMgZW50aXR5IHRvIG9wZXJhdG9yIG5hbWUgYW5kIG9wZXJhdG9yIHBhcmFtcy4KICAgIDpwYXJhbSBpc19mdWxsX3RleHQ6ICAgIFdoZXRoZXIgdGhlIHRleHQgaXMgZnVsbCB0ZXh0IG9yIG5vdC4KCiAgICA6cmV0dXJuczogVGhlIGFub255bWl6ZWQgdGV4dC4KICAgICIiIgogICAgaWYgbm90IHRleHQ6CiAgICAgICAgcmV0dXJuICIiCgogICAgYW5vbnltaXplcl9lbmdpbmUgPSBfZ2V0X2Fub255bWl6ZXJfZW5naW5lKCkKICAgIGlmIG5vdCBlbnRpdHlfb3BlcmF0b3JfbWFwOgogICAgICAgIG9wZXJhdG9ycyA9IE5vbmUKICAgIGVsc2U6CiAgICAgICAgIyBDcmVhdGUgT3BlcmF0b3JDb25maWcgYmFzZWQgb24gdGhlIGVudGl0eV9vcGVyYXRvcl9tYXAKICAgICAgICBvcGVyYXRvcnMgPSB7CiAgICAgICAgICAgIGVudGl0eTogT3BlcmF0b3JDb25maWcob3BlcmF0b3JfbmFtZSwgb3BlcmF0b3JfcGFyYW1zKQogICAgICAgICAgICBmb3IgZW50aXR5LCAob3BlcmF0b3JfbmFtZSwgb3BlcmF0b3JfcGFyYW1zKSBpbiBlbnRpdHlfb3BlcmF0b3JfbWFwLml0ZW1zKCkKICAgICAgICB9CgogICAgaWYgaXNfZnVsbF90ZXh0OgogICAgICAgICMgQW5vbnltaXplIHRoZSBlbnRpcmUgdGV4dAogICAgICAgIHJldHVybiBhbm9ueW1pemVyX2VuZ2luZS5hbm9ueW1pemUoCiAgICAgICAgICAgIHRleHQ9dGV4dCwgYW5hbHl6ZXJfcmVzdWx0cz1hbmFseXplX3Jlc3VsdHMsIG9wZXJhdG9ycz1vcGVyYXRvcnMKICAgICAgICApLnRleHQKICAgICMgVG9rZW5pemUgdGhlIHRleHQgdG8gc2VudGVuY2VzCiAgICBzZW50ZW5jZXMgPSBubHRrLnNlbnRfdG9rZW5pemUodGV4dCkKICAgIGFub255bWl6ZWRfc2VudGVuY2VzID0gW10KICAgIGN1cnJlbnRfaWR4ID0gMAoKICAgIGZvciBzZW50ZW5jZSBpbiBzZW50ZW5jZXM6CiAgICAgICAgc3RhcnRfaWR4ID0gY3VycmVudF9pZHgKICAgICAgICBlbmRfaWR4ID0gc3RhcnRfaWR4ICsgbGVuKHNlbnRlbmNlKQogICAgICAgIHNlbnRlbmNlX3Jlc3VsdHMgPSBbCiAgICAgICAgICAgIHBhLlJlY29nbml6ZXJSZXN1bHQoCiAgICAgICAgICAgICAgICByZXN1bHQuZW50aXR5X3R5cGUsCiAgICAgICAgICAgICAgICBzdGFydD1yZXN1bHQuc3RhcnQgLSBzdGFydF9pZHgsCiAgICAgICAgICAgICAgICBlbmQ9cmVzdWx0LmVuZCAtIHN0YXJ0X2lkeCwKICAgICAgICAgICAgICAgIHNjb3JlPXJlc3VsdC5zY29yZSwKICAgICAgICAgICAgKQogICAgICAgICAgICBmb3IgcmVzdWx0IGluIGFuYWx5emVfcmVzdWx0cwogICAgICAgICAgICBpZiByZXN1bHQuc3RhcnQgPj0gc3RhcnRfaWR4IGFuZCByZXN1bHQuZW5kIDw9IGVuZF9pZHgKICAgICAgICBdCgogICAgICAgIGlmIHNlbnRlbmNlX3Jlc3VsdHM6ICAjIElmIFBJSSBpcyBkZXRlY3RlZAogICAgICAgICAgICBhbm9ueW1pemVkX3NlbnRlbmNlID0gYW5vbnltaXplcl9lbmdpbmUuYW5vbnltaXplKAogICAgICAgICAgICAgICAgdGV4dD1zZW50ZW5jZSwgYW5hbHl6ZXJfcmVzdWx0cz1zZW50ZW5jZV9yZXN1bHRzLCBvcGVyYXRvcnM9b3BlcmF0b3JzCiAgICAgICAgICAgICkudGV4dAogICAgICAgICAgICBhbm9ueW1pemVkX3NlbnRlbmNlcy5hcHBlbmQoYW5vbnltaXplZF9zZW50ZW5jZSkKCiAgICAgICAgY3VycmVudF9pZHggPSBlbmRfaWR4CgogICAgcmV0dXJuICIgIi5qb2luKGFub255bWl6ZWRfc2VudGVuY2VzKQoKCmRlZiBfZ2V0X3Rva2VucygKICAgIHRleHQ6IHN0ciwgYW5hbHl6ZV9yZXN1bHRzOiBMaXN0W3BhLlJlY29nbml6ZXJSZXN1bHRdLCBpc19mdWxsOiBib29sID0gVHJ1ZQopIC0+IExpc3Rbc3RyXToKICAgICIiIgogICAgR2V0IHRoZSBmdWxsIHRva2VucyBvciBvbmx5IGNvbnRhaW5zIHRoZSBlbnRpdGllcyB0aGF0IGNhbiBmb3JtIGEgc2VudGVuY2UuCgogICAgOnBhcmFtIHRleHQ6ICAgICAgICAgICAgVGhlIHRleHQgZm9yIGFuYWx5c2lzLgogICAgOnBhcmFtIGFuYWx5emVfcmVzdWx0czogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tCiAgICA6cGFyYW0gaXNfZnVsbDogICAgICAgICBXaGV0aGVyIHJldHVybiBmdWxsIHRva2VucyBvciBqdXN0IHRoZSB0b2tlbnMgdGhhdCBvbmx5IGNvbnRhaW5zIHRoZSBlbnRpdGllcyB0aGF0IGNhbiBmb3JtIGEgc2VudGVuY2UuCgogICAgOnJldHVybnM6IFRoZSB0b2tlbnMuCiAgICAiIiIKCiAgICB0b2tlbnMgPSBbXQogICAgIyBzb3J0IGJ5IHN0YXJ0IGluZGV4CiAgICByZXN1bHRzID0gc29ydGVkKGFuYWx5emVfcmVzdWx0cywga2V5PWxhbWJkYSB4OiB4LnN0YXJ0KQogICAgZm9yIGksIHJlcyBpbiBlbnVtZXJhdGUocmVzdWx0cyk6CiAgICAgICAgaWYgaSA9PSAwOgogICAgICAgICAgICB0b2tlbnMuYXBwZW5kKHRleHRbOiByZXMuc3RhcnRdKQoKICAgICAgICAjIGFwcGVuZCBlbnRpdHkgdGV4dCBhbmQgZW50aXR5IHR5cGUKICAgICAgICB0b2tlbnMuYXBwZW5kKCh0ZXh0W3Jlcy5zdGFydCA6IHJlcy5lbmRdLCByZXMuZW50aXR5X3R5cGUpKQoKICAgICAgICAjIGlmIGFub3RoZXIgZW50aXR5IGNvbWluZyBpLmUuIHdlJ3JlIG5vdCBhdCB0aGUgbGFzdCByZXN1bHRzIGVsZW1lbnQsCiAgICAgICAgIyBhZGQgdGV4dCB1cCB0byBuZXh0IGVudGl0eQogICAgICAgIGlmIGkgIT0gbGVuKHJlc3VsdHMpIC0gMToKICAgICAgICAgICAgdG9rZW5zLmFwcGVuZCh0ZXh0W3Jlcy5lbmQgOiByZXN1bHRzW2kgKyAxXS5zdGFydF0pCiAgICAgICAgIyBpZiBubyBtb3JlIGVudGl0aWVzIGNvbWluZywgYWRkIGFsbCByZW1haW5pbmcgdGV4dAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRva2Vucy5hcHBlbmQodGV4dFtyZXMuZW5kIDpdKQoKICAgICMgZ2V0IHRoZSB0b2tlbnMgdGhhdCBvbmx5IGNvbnRhaW5zIHRoZSBlbnRpdGllcyB0aGF0IGNhbiBmb3JtIGEgc2VudGVuY2UKICAgIHBhcnRfYW5ub250YXRlZF90b2tlbnMgPSBbXQogICAgaWYgbm90IGlzX2Z1bGw6CiAgICAgICAgbGFzdF9lbmRfc2VudGVuY2UgPSAwCiAgICAgICAgZm9yIGksIHRva2VuIGluIGVudW1lcmF0ZSh0b2tlbnMpOgogICAgICAgICAgICBpZiBhbnkoaXRlbSBpbiB0b2tlbiBmb3IgaXRlbSBpbiBbIi4iLCAiISIsICI/Il0pIGFuZCBhbnkoCiAgICAgICAgICAgICAgICB0eXBlKGl0ZW0pIGlzIHR1cGxlIGZvciBpdGVtIGluIHRva2Vuc1tsYXN0X2VuZF9zZW50ZW5jZTppXQogICAgICAgICAgICApOgogICAgICAgICAgICAgICAgcGFydF9hbm5vbnRhdGVkX3Rva2Vucy5hcHBlbmQodG9rZW5zW2xhc3RfZW5kX3NlbnRlbmNlOmldKQogICAgICAgICAgICAgICAgbGFzdF9lbmRfc2VudGVuY2UgPSBpCiAgICAgICAgcmV0dXJuIHBhcnRfYW5ub250YXRlZF90b2tlbnMKICAgIHJldHVybiB0b2tlbnMKCgpkZWYgX2Fubm90YXRlKAogICAgdGV4dDogc3RyLCBzdF9hbmFseXplX3Jlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUKKSAtPiBMaXN0W3N0cl06CiAgICAiIiIKICAgIEFubm90YXRlIGlkZW50aWZpZWQgaW5wdXQgdXNpbmcgUHJlc2lkaW8gQW5vbnltaXplci4KCiAgICA6cGFyYW0gdGV4dDogICAgICAgICAgICAgICBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gc3RfYW5hbHl6ZV9yZXN1bHRzOiBUaGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMuCiAgICA6cGFyYW0gaXNfZnVsbF9odG1sOiAgICAgICBXaGV0aGVyIGdlbmVyYXRlIGZ1bGwgaHRtbCBvciBub3QuCiAgICA6cmV0dXJuczogVGhlIGxpc3Qgb2YgdG9rZW5zIHdpdGggdGhlIGlkZW50aWZpZWQgZW50aXRpZXMuCgogICAgIiIiCiAgICByZXR1cm4gX2dldF90b2tlbnModGV4dCwgc3RfYW5hbHl6ZV9yZXN1bHRzLCBpc19mdWxsX2h0bWwpCgoKZGVmIF9wcm9jZXNzKAogICAgdGV4dDogc3RyLAogICAgbW9kZWw6IHBhLkFuYWx5emVyRW5naW5lLAogICAgc2NvcmVfdGhyZXNob2xkOiBmbG9hdCwKICAgIGVudGl0aWVzOiBMaXN0W3N0cl0gPSBOb25lLAogICAgZW50aXRpZXNfb3BlcmF0b3JfbWFwOiBkaWN0ID0gTm9uZSwKICAgIGlzX2Z1bGxfdGV4dDogYm9vbCA9IFRydWUsCikgLT4gVHVwbGVbc3RyLCBzdHIsIHN0cl06CiAgICAiIiIKICAgIFByb2Nlc3MgdGhlIHRleHQgb2Ygc3RyIHVzaW5nIHRoZSBtb2RlbC4KCiAgICA6cGFyYW0gdHh0OiAgICAgICAgICAgICAgICAgICBUZXh0IHRvIHByb2Nlc3MKICAgIDpwYXJhbSBtb2RlbDogICAgICAgICAgICAgICAgIE1vZGVsIHRvIHVzZSBmb3IgcHJvY2Vzc2luZwogICAgOnBhcmFtIGVudGl0aWVzOiAgICAgICAgICAgICAgRW50aXRpZXMgdG8gcmVjb2duaXplCiAgICA6cGFyYW0gZW50aXRpZXNfb3BlcmF0b3JfbWFwOiBUaGUgZW50aXR5X29wZXJhdG9yX21hcCBpcyBhIGRpY3Rpb25hcnkgdGhhdCBtYXBzIGVudGl0eSB0byBvcGVyYXRvciBuYW1lIGFuZCBvcGVyYXRvciBwYXJhbXMuCiAgICA6cGFyYW0gc2NvcmVfdGhyZXNob2xkOiAgICAgICBUaGUgc2NvcmUgdGhyZXNob2xkIHRvIHVzZSBmb3IgcmVjb2duaXRpb24KICAgIDpwYXJhbSBpc19mdWxsX3RleHQ6ICAgICAgICAgIFdoZXRoZXIgdG8gcmV0dXJuIHRoZSBmdWxsIHRleHQgb3IganVzdCB0aGUgYW5ub3RhdGVkIHRleHQKCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKCiAgICAgICAgICAgICAgKiB0aGUgYW5vbnltaXplZCB0ZXh0CiAgICAgICAgICAgICAgKiB0aGUgbGlzdCBvZiBQcmVzaWRpbyBSZWNvZ25pemVyUmVzdWx0IGNvbnN0cnVjdGVkIGZyb20gYW5hbHlzaXMKICAgICIiIgoKICAgICMgZ2V0IHRoZSBhbmFseXplciBlbmdpbmUKCiAgICBhbmFseXplciA9IG1vZGVsCgogICAgIyBhbmFseXplIHRoZSB0ZXh0IHRoYXQgY2FuIGJlIHVzZWQgZm9yIGFub255bWl6YXRpb24KICAgIHJlc3VsdHMgPSBhbmFseXplci5hbmFseXplKAogICAgICAgIHRleHQ9dGV4dCwKICAgICAgICBsYW5ndWFnZT0iZW4iLAogICAgICAgIGVudGl0aWVzPWVudGl0aWVzLAogICAgICAgIHNjb3JlX3RocmVzaG9sZD1zY29yZV90aHJlc2hvbGQsCiAgICAgICAgcmV0dXJuX2RlY2lzaW9uX3Byb2Nlc3M9VHJ1ZSwKICAgICkKCiAgICAjIGFub255bWl6ZSB0aGUgdGV4dCwgcmVwbGFjZSB0aGUgcGlpIGVudGl0aWVzIHdpdGggdGhlIGxhYmVscwogICAgYW5vbnltaXplZF90ZXh0ID0gX2Fub255bWl6ZSh0ZXh0LCByZXN1bHRzLCBlbnRpdGllc19vcGVyYXRvcl9tYXAsIGlzX2Z1bGxfdGV4dCkKCiAgICByZXR1cm4gYW5vbnltaXplZF90ZXh0LCByZXN1bHRzCgoKZGVmIF9nZXRfc2luZ2xlX2h0bWwoCiAgICB0ZXh0OiBzdHIsIHJlc3VsdHM6IExpc3RbcGEuUmVjb2duaXplclJlc3VsdF0sIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUKKToKICAgICIiIgogICAgR2VuZXJhdGUgdGhlIGh0bWwgZm9yIGEgc2luZ2xlIHR4dCBmaWxlLgoKICAgIDpwYXJhbSB0ZXh0OiBUaGUgdGV4dCBmb3IgYW5hbHlzaXMuCiAgICA6cGFyYW0gcmVzdWx0czogVGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIGFuYWx5c2lzLgogICAgOnBhcmFtIGlzX2Z1bGxfaHRtbDogV2hldGhlciBnZW5lcmF0ZSBmdWxsIGh0bWwgb3Igbm90LgoKICAgIDpyZXR1cm5zOiBUaGUgaHRtbCBzdHJpbmcgZm9yIGEgc2luZ2xlIHR4dCBmaWxlLgogICAgIiIiCiAgICAjIGNvbnZlcnQgdGhlIHJlc3VsdHMgdG8gdG9rZW5zIHRvIGdlbmVyYXRlIHRoZSBodG1sCiAgICB0b2tlbnMgPSBfYW5ub3RhdGUodGV4dCwgcmVzdWx0cywgaXNfZnVsbF9odG1sKQogICAgaHRtbCA9IGF0X3V0aWwuZ2V0X2Fubm90YXRlZF9odG1sKCp0b2tlbnMpCgogICAgIyBhdm9pZCB0aGUgZXJyb3IgZHVyaW5nIHJlbmRlcmluZyBvZiB0aGUgXG4gaW4gdGhlIGh0bWwKICAgIGJhY2tzbGFzaF9jaGFyID0gIlxcIgoKICAgIGh0bWxfc3RyID0gZiI8cD57aHRtbC5yZXBsYWNlKCd7YmFja3NsYXNoX2NoYXJ9bicsICc8YnI+Jyl9PC9wPiIKCiAgICByZXR1cm4gaHRtbF9zdHIKCgpkZWYgX2dldF9zaW5nbGVfanNvbihyZXN1bHRzOiBMaXN0W3BhLlJlY29nbml6ZXJSZXN1bHRdLCBpc19mdWxsX3JlcG9ydDogYm9vbCA9IFRydWUpOgogICAgIiIiCiAgICBHZW5lcmF0ZSB0aGUganNvbiBmb3IgYSBzaW5nbGUgdHh0IGZpbGUuCgogICAgOnBhcmFtIHJlc3VsdHM6IFRoZSBsaXN0IG9mIFByZXNpZGlvIFJlY29nbml6ZXJSZXN1bHQgY29uc3RydWN0ZWQgZnJvbSBhbmFseXNpcy4KICAgIDpwYXJhbSBpc19mdWxsX3JlcG9ydDogV2hldGhlciBnZW5lcmF0ZSBmdWxsIGpzb24gb3Igbm90LgoKICAgIDpyZXR1cm5zOiBUaGUganNvbiBzdHJpbmcgZm9yIGEgc2luZ2xlIHR4dCBmaWxlLgogICAgIiIiCiAgICAjIGdlbmVyYXRlIHRoZSBzdGF0cyByZXBvcnQgaWYgbmVlZGVkCiAgICBpZiBub3QgaXNfZnVsbF9yZXBvcnQ6CiAgICAgICAgc3RhdHMgPSBbXQogICAgICAgICMgYWRkIHRoZSBzaW1wbGlmeSBzdGF0cyBsb2dpYyBoZXJlCiAgICAgICAgZm9yIGl0ZW0gaW4gcmVzdWx0czoKICAgICAgICAgICAgaXRlbS5hbmFseXNpc19leHBsYW5hdGlvbiA9IE5vbmUKICAgICAgICAgICAgc3RhdHMuYXBwZW5kKGl0ZW0pCiAgICBlbHNlOgogICAgICAgIHN0YXRzID0gcmVzdWx0cwoKICAgIHJldHVybiBzdGF0cwoKCmRlZiBfZ2V0X2FsbF9odG1sKAogICAgdHh0X2NvbnRlbnQ6IGRpY3QsCiAgICByZXNfZGljdDogZGljdCwKICAgIGlzX2Z1bGxfaHRtbDogYm9vbCA9IFRydWUsCik6CiAgICAiIiIKICAgIEdlbmVyYXRlIHRoZSBodG1sIGZvciBhbGwgdHh0IGZpbGVzLgoKICAgIDpwYXJhbSB0eHRfY29udGVudDogVGhlIGRpY3Rpb25hcnkgb2YgdHh0IGZpbGUgbmFtZSBhbmQgY29udGVudC4KICAgIDpwYXJhbSByZXNfZGljdDogICAgVGhlIGRpY3Rpb25hcnkgb2YgdHh0IGZpbGUgbmFtZSBhbmQgdGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIGFuYWx5c2lzLgogICAgOnBhcmFtIGlzX2Z1bGxfaHRtbDogV2hldGhlciBnZW5lcmF0ZSBmdWxsIGh0bWwgb3Igbm90LgoKICAgIDpyZXR1cm5zOiBUaGUgaHRtbCBzdHJpbmcgZm9yIGFsbCB0eHQgZmlsZXMuCgogICAgIiIiCiAgICAjIFRoZXNlIGFyZSBwbGFjZWhvbGRlciBmb3IgdGhlIGh0bWwgc3RyaW5nCiAgICBodG1sX2luZGV4ID0gIjxodG1sPjxoZWFkPjx0aXRsZT5IaWdobGlnaHRlZCBQaWkgRW50aXRpZXM8L3RpdGxlPjwvaGVhZD48Ym9keT48aDE+SGlnaGxpZ2h0ZWQgUGlpIEVudGl0aWVzPC9oMT48dWw+IgogICAgaHRtbF9jb250ZW50ID0gIiIKICAgIGZvciB0eHRfZmlsZSwgcmVzdWx0cyBpbiByZXNfZGljdC5pdGVtcygpOgogICAgICAgIHR4dCA9IHR4dF9jb250ZW50W3R4dF9maWxlXQogICAgICAgIGh0bWxfaW5kZXggKz0gZiI8bGk+PGEgaHJlZj0nI3t0eHRfZmlsZX0nPnt0eHRfZmlsZX08L2E+PC9saT4iCiAgICAgICAgaHRtbF9jb250ZW50ICs9IGYiPGxpPjxoMj57dHh0X2ZpbGV9PC9oMj48cD57X2dldF9zaW5nbGVfaHRtbCh0eHQsIHJlc3VsdHMsIGlzX2Z1bGxfaHRtbCl9PC9wPjwvbGk+IgogICAgaHRtbF9pbmRleCArPSAiPC91bD4iCiAgICBodG1sX3JlcyA9IGYie2h0bWxfaW5kZXh9e2h0bWxfY29udGVudH08L2JvZHk+PC9odG1sPiIKCiAgICByZXR1cm4gaHRtbF9yZXMKCgpkZWYgX2dldF9hbGxfcnB0KHJlc19kaWN0OiBkaWN0LCBpc19mdWxsX3JlcG9ydDogYm9vbCA9IFRydWUpOgogICAgIiIiCiAgICBHZW5lcmF0ZSB0aGUgc3RhdHMgcmVwb3J0IGZvciBhbGwgdHh0IGZpbGVzLgoKICAgIDpwYXJhbSByZXNfZGljdDogVGhlIGRpY3Rpb25hcnkgb2YgdHh0IGZpbGUgbmFtZSBhbmQgdGhlIGxpc3Qgb2YgUHJlc2lkaW8gUmVjb2duaXplclJlc3VsdCBjb25zdHJ1Y3RlZCBmcm9tIGFuYWx5c2lzLgogICAgOnBhcmFtIGlzX2Z1bGxfcmVwb3J0OiBXaGV0aGVyIGdlbmVyYXRlIGZ1bGwgcmVwb3J0IG9yIG5vdC4KCiAgICA6cmV0dXJuczogVGhlIHN0YXRzIHJlcG9ydCBmb3IgYWxsIHR4dCBmaWxlcy4KICAgICIiIgogICAgIyBUaGVzZSBhcmUgcGxhY2Vob2xkZXIgZm9yIHRoZSBodG1sIHN0cmluZwogICAgc3RhdHNfZGljdCA9IHt9CiAgICBmb3IgdHh0X2ZpbGUsIHJlc3VsdHMgaW4gcmVzX2RpY3QuaXRlbXMoKToKICAgICAgICBuZXdfc3RhdHMgPSBbXQogICAgICAgIGZvciBpdGVtIGluIF9nZXRfc2luZ2xlX2pzb24ocmVzdWx0cywgaXNfZnVsbF9yZXBvcnQpOgogICAgICAgICAgICBpZiBpc19mdWxsX3JlcG9ydDoKICAgICAgICAgICAgICAgIGl0ZW0uYW5hbHlzaXNfZXhwbGFuYXRpb24gPSBpdGVtLmFuYWx5c2lzX2V4cGxhbmF0aW9uLnRvX2RpY3QoKQogICAgICAgICAgICAgICAgbmV3X3N0YXRzLmFwcGVuZChpdGVtLnRvX2RpY3QoKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHRtcF9kaWN0ID0gaXRlbS50b19kaWN0KCkKICAgICAgICAgICAgICAgIHRtcF9kaWN0LnBvcCgiYW5hbHlzaXNfZXhwbGFuYXRpb24iKQogICAgICAgICAgICAgICAgdG1wX2RpY3QucG9wKCJyZWNvZ25pdGlvbl9tZXRhZGF0YSIpCiAgICAgICAgICAgICAgICBuZXdfc3RhdHMuYXBwZW5kKHRtcF9kaWN0KQogICAgICAgIHN0YXRzX2RpY3RbdHh0X2ZpbGVdID0gbmV3X3N0YXRzCiAgICByZXR1cm4gc3RhdHNfZGljdAoKCmRlZiByZWNvZ25pemVfcGlpKAogICAgY29udGV4dDogbWxydW4uTUxDbGllbnRDdHgsCiAgICBpbnB1dF9wYXRoOiBzdHIsCiAgICBvdXRwdXRfcGF0aDogc3RyLAogICAgb3V0cHV0X3N1ZmZpeDogc3RyLAogICAgaHRtbF9rZXk6IHN0ciwKICAgIHNjb3JlX3RocmVzaG9sZDogZmxvYXQsCiAgICBlbnRpdGllczogTGlzdFsKICAgICAgICBzdHIKICAgIF0gPSBOb25lLCAgIyBMaXN0IG9mIGVudGl0aWVzIHRvIHJlY29nbml6ZSwgZGVmYXVsdCBpcyByZWNvZ25pemUgYWxsCiAgICBlbnRpdHlfb3BlcmF0b3JfbWFwOiBkaWN0ID0gTm9uZSwKICAgIG1vZGVsOiBzdHIgPSAid2hvbGUiLAogICAgZ2VuZXJhdGVfanNvbjogYm9vbCA9IFRydWUsCiAgICBnZW5lcmF0ZV9odG1sOiBib29sID0gVHJ1ZSwKICAgIGlzX2Z1bGxfdGV4dDogYm9vbCA9IFRydWUsCiAgICBpc19mdWxsX2h0bWw6IGJvb2wgPSBUcnVlLAogICAgaXNfZnVsbF9yZXBvcnQ6IGJvb2wgPSBUcnVlLAopIC0+IFR1cGxlW3BhdGhsaWIuUGF0aCwgZGljdCwgZGljdF06CiAgICAiIiIKICAgIFdhbGsgdGhyb3VnaCB0aGUgaW5wdXQgcGF0aCwgcmVjb2duaXplIFBJSSBpbiB0ZXh0IGFuZCBzdG9yZSB0aGUgYW5vbnltaXplZCB0ZXh0IGluIHRoZSBvdXRwdXQgcGF0aC4gR2VuZXJhdGUgdGhlIGh0bWwgd2l0aCBkaWZmZXJlbnQgY29sb3JzIGZvciBlYWNoIGVudGl0eSwganNvbiByZXBvcnQgb2YgdGhlIGV4cGxhaW5hdGlvbi4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgICAgIFRoZSBNTFJ1biBjb250ZXh0LiB0aGlzIGlzIG5lZWRlZCBmb3IgbG9nIHRoZSBhcnRpZmFjdHMuCiAgICA6cGFyYW0gZW50aXRpZXM6ICAgICAgICAgICAgIFRoZSBsaXN0IG9mIGVudGl0aWVzIHRvIHJlY29nbml6ZS4KICAgIDpwYXJhbSBlbnRpdHlfb3BlcmF0b3JfbWFwOiAgVGhlIG1hcCBvZiBlbnRpdHkgdG8gb3BlcmF0b3IgKG1hc2ssIHJlZGFjdCwgcmVwbGFjZSwga2VlcCwgaGFzaCwgYW5kIGl0cyBwYXJhbXMpCiAgICA6cGFyYW0gaW5wdXRfcGF0aDogICAgICAgICAgIFRoZSBpbnB1dCBwYXRoIG9mIHRoZSB0ZXh0IGZpbGVzIG5lZWRzIHRvIGJlIGFuYWx5emllZC4KICAgIDpwYXJhbSBvdXRwdXRfcGF0aDogICAgICAgICAgVGhlIG91dHB1dCBwYXRoIHRvIHN0b3JlIHRoZSBhbm9ueW1pemVkIHRleHQuCiAgICA6cGFyYW0gb3V0cHV0X3N1ZmZpeDogICAgICAgIFRoZSBzdXJmaXggb2Ygb3V0cHV0IGtleSBmb3IgdGhlIGFub255bWl6ZWQgdGV4dC4gZm9yIGV4YW1wbGUgaWYgdGhlIGlucHV0IGZpbGUgaXMgcGlpLnR4dCwgdGhlIG91dHB1dCBrZXkgaXMgYW5veW1pemVkLCB0aGUgb3V0cHV0IGZpbGUgbmFtZSB3aWxsIGJlIHBpaV9hbm9ueW1pemVkLnR4dC4KICAgIDpwYXJhbSBodG1sX2tleTogICAgICAgICAgICAgVGhlIGh0bWwga2V5IGZvciB0aGUgYXJ0aWZhY3QuCiAgICA6cGFyYW0gc2NvcmVfdGhyZXNob2xkOiAgICAgIFRoZSBzY29yZSB0aHJlc2hvbGQgdG8gbWFyayB0aGUgcmVjb2duaXRpb24gYXMgdHJ1c3RlZC4KICAgIDpwYXJhbSBtb2RlbDogICAgICAgICAgICAgICAgVGhlIG1vZGVsIHRvIHVzZS4gQ2FuIGJlICJzcGFjeSIsICJmbGFpciIsICJwYXR0ZXJuIiBvciAid2hvbGUiLgogICAgOnBhcmFtIGlzX2dlbmVyYXRlX2pzb25fcnB0OiBXaGV0aGVyIHRvIGdlbmVyYXRlIHRoZSBqc29uIHJlcG9ydCBvZiB0aGUgZXhwbGFpbmF0aW9uLgogICAgOnBhcmFtIGlzX2dlbmVyYXRlX2h0bWw6ICAgICBXaGV0aGVyIHRvIGdlbmVyYXRlIHRoZSBodG1sIHJlcG9ydCBvZiB0aGUgZXhwbGFpbmF0aW9uLgogICAgOnBhcmFtIGlzX2Z1bGxfdGV4dDogICAgICAgICBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCB0ZXh0IG9yIG9ubHkgdGhlIG1hc2tlZCB0ZXh0LgogICAgOnBhcmFtIGlzX2Z1bGxfaHRtbDogICAgICAgICBXaGV0aGVyIHRvIHJldHVybiB0aGUgZnVsbCBodG1sIG9yIGp1c3QgdGhlIGFubm90YXRlZCB0ZXh0CiAgICA6cGFyYW0gaXNfZnVsbF9yZXBvcnQ6ICAgICAgIFdoZXRoZXIgdG8gcmV0dXJuIHRoZSBmdWxsIHJlcG9ydCBvciBqdXN0IHRoZSBzY29yZSBhbmQgc3RhcnQsIGVuZCBpbmRleAoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgoKICAgICAgICAgICAgICAqIFBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkKICAgICAgICAgICAgICAqIFRoZSBqc29uIHJlcG9ydCBvZiB0aGUgZXhwbGFpbmF0aW9uIChpZiBpc19nZW5lcmF0ZV9qc29uX3JwdCBpcyBUcnVlKQogICAgICAgICAgICAgICogQSBkaWN0aW9uYXJ5IG9mIGVycm9ycyBmaWxlcyB0aGF0IHdlcmUgbm90IHByb2Nlc3NlZAoKICAgICIiIgoKICAgICMgU2V0IG91dHB1dCBkaXJlY3RvcnkKICAgIGlmIG91dHB1dF9wYXRoIGlzIE5vbmU6CiAgICAgICAgb3V0cHV0X3BhdGggPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKCiAgICAjIENyZWF0ZSB0aGUgb3V0cHV0IGRpcmVjdG9yeToKICAgIG91dHB1dF9kaXJlY3RvcnkgPSBwYXRobGliLlBhdGgob3V0cHV0X3BhdGgpCiAgICBpZiBub3Qgb3V0cHV0X2RpcmVjdG9yeS5leGlzdHMoKToKICAgICAgICBvdXRwdXRfZGlyZWN0b3J5Lm1rZGlyKCkKCiAgICAjIExvYWQgdGhlIG1vZGVsOgogICAgYW5hbHl6ZXIgPSBfZ2V0X2FuYWx5emVyX2VuZ2luZShtb2RlbCkKICAgIHByaW50KCJNb2RlbCBsb2FkZWQiKQoKICAgICMgR28gb3ZlciB0aGUgdGV4dCBmaWxlcyBpbiB0aGUgaW5wdXQgcGF0aCwgYW5hbHl6ZSBhbmQgYW5vbnltaXplIHRoZW06CiAgICB0eHRfZmlsZXNfZGlyZWN0b3J5ID0gcGF0aGxpYi5QYXRoKGlucHV0X3BhdGgpCiAgICBlcnJvcnMgPSB7fQoKICAgIHJlc19kaWN0ID0ge30KICAgIHR4dF9jb250ZW50ID0ge30KICAgICMgR28gb3ZlciB0aGUgdGV4dCBmaWxlcyBpbiB0aGUgaW5wdXQgcGF0aCwgYW5hbHl6ZSBhbmQgYW5vbnltaXplIHRoZW06CiAgICBmb3IgaSwgdHh0X2ZpbGUgaW4gZW51bWVyYXRlKAogICAgICAgIHRxZG0oCiAgICAgICAgICAgIGxpc3QodHh0X2ZpbGVzX2RpcmVjdG9yeS5nbG9iKCIqLnR4dCIpKSwKICAgICAgICAgICAgZGVzYz0iUHJvY2Vzc2luZyBmaWxlcyIsCiAgICAgICAgICAgIHVuaXQ9ImZpbGUiLAogICAgICAgICkKICAgICk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIExvYWQgdGhlIHN0ciBmcm9tIHRoZSB0ZXh0IGZpbGUKICAgICAgICAgICAgdGV4dCA9IHR4dF9maWxlLnJlYWRfdGV4dCgpCiAgICAgICAgICAgIHR4dF9jb250ZW50W3N0cih0eHRfZmlsZSldID0gdGV4dAogICAgICAgICAgICAjIFByb2Nlc3MgdGhlIHRleHQgdG8gcmVjb2dpbnplIHRoZSBwaWkgZW50aXRpZXMgaW4gaXQKICAgICAgICAgICAgYW5vbnltaXplZF90ZXh0LCByZXN1bHRzID0gX3Byb2Nlc3MoCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgYW5hbHl6ZXIsCiAgICAgICAgICAgICAgICBlbnRpdGllcywKICAgICAgICAgICAgICAgIGVudGl0eV9vcGVyYXRvcl9tYXAsCiAgICAgICAgICAgICAgICBzY29yZV90aHJlc2hvbGQsCiAgICAgICAgICAgICAgICBpc19mdWxsX3RleHQsCiAgICAgICAgICAgICkKICAgICAgICAgICAgcmVzX2RpY3Rbc3RyKHR4dF9maWxlKV0gPSByZXN1bHRzCiAgICAgICAgICAgICMgU3RvcmUgdGhlIGFub255bWl6ZWQgdGV4dCBpbiB0aGUgb3V0cHV0IHBhdGgKICAgICAgICAgICAgb3V0cHV0X2ZpbGUgPSAoCiAgICAgICAgICAgICAgICBvdXRwdXRfZGlyZWN0b3J5CiAgICAgICAgICAgICAgICAvIGYie3N0cih0eHRfZmlsZS5yZWxhdGl2ZV90byh0eHRfZmlsZXNfZGlyZWN0b3J5KSkuc3BsaXQoJy4nKVswXX1fe291dHB1dF9zdWZmaXh9LnR4dCIKICAgICAgICAgICAgKQogICAgICAgICAgICBvdXRwdXRfZmlsZS5wYXJlbnQubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQogICAgICAgICAgICB3aXRoIG9wZW4ob3V0cHV0X2ZpbGUsICJ3IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoYW5vbnltaXplZF90ZXh0KQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yc1tzdHIodHh0X2ZpbGUpXSA9IHN0cihlKQogICAgICAgICAgICBwcmludChmIkVycm9yIHByb2Nlc3Npbmcge3R4dF9maWxlfToge2V9IikKICAgIGlmIGdlbmVyYXRlX2h0bWw6CiAgICAgICAgIyBHZW5lcmF0ZSB0aGUgaHRtbCByZXBvcnQKICAgICAgICBodG1sX3JlcyA9IF9nZXRfYWxsX2h0bWwodHh0X2NvbnRlbnQsIHJlc19kaWN0LCBpc19mdWxsX2h0bWwpCiAgICAgICAgIyBTdG9yZSB0aGUgaHRtbCByZXBvcnQgaW4gdGhlIGNvbnRleHQKICAgICAgICBhcnRpX2h0bWwgPSBtbHJ1bi5hcnRpZmFjdHMuQXJ0aWZhY3QoYm9keT1odG1sX3JlcywgZm9ybWF0PSJodG1sIiwga2V5PWh0bWxfa2V5KQogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KGFydGlfaHRtbCkKICAgIGlmIGdlbmVyYXRlX2pzb246CiAgICAgICAgIyBHZW5lcmF0ZSB0aGUganNvbiByZXBvcnQKICAgICAgICBqc29uX3JlcyA9IF9nZXRfYWxsX3JwdChyZXNfZGljdCwgaXNfZnVsbF9yZXBvcnQpCiAgICAgICAgcmV0dXJuIG91dHB1dF9wYXRoLCBqc29uX3JlcywgZXJyb3JzCiAgICByZXR1cm4gb3V0cHV0X3BhdGgsIGVycm9ycwo=
    base_image: mlrun/mlrun
    commands: []
    code_origin: git@github.com-personal:pengwei715/functions.git#260a134fcfbfa28def1b6fd974a77e7699ac08af:pii_recognizer.py
    origin_filename: pii_recognizer.py
    requirements:
    - mlrun==1.4.0-rc19
    - pandas
    - presidio-anonymizer
    - presidio-analyzer
    - torch
    - flair@git+https://github.com/flairNLP/flair.git@d4ed67bf663e4066517f00397412510d90043653
    - st-annotated-text
    - https://huggingface.co/beki/en_spacy_pii_distilbert/resolve/main/en_spacy_pii_distilbert-any-py3-none-any.whl
  entry_points:
    recognize_pii:
      name: recognize_pii
      doc: Walk through the input path, recognize PII in text and store the anonymized
        text in the output path. Generate the html with different colors for each
        entity, json report of the explaination.
      parameters:
      - name: context
        type: MLClientCtx
        doc: The MLRun context. this is needed for log the artifacts.
        default: ''
      - name: input_path
        type: str
        doc: The input path of the text files needs to be analyzied.
        default: ''
      - name: output_path
        type: str
        doc: The output path to store the anonymized text.
        default: ''
      - name: output_suffix
        type: str
        doc: The surfix of output key for the anonymized text. for example if the
          input file is pii.txt, the output key is anoymized, the output file name
          will be pii_anonymized.txt.
        default: ''
      - name: html_key
        type: str
        doc: The html key for the artifact.
        default: ''
      - name: score_threshold
        type: float
        doc: The score threshold to mark the recognition as trusted.
        default: ''
      - name: entities
        type: List[str]
        doc: The list of entities to recognize.
        default: null
      - name: entity_operator_map
        type: dict
        doc: The map of entity to operator (mask, redact, replace, keep, hash, and
          its params)
        default: null
      - name: model
        type: str
        doc: The model to use. Can be "spacy", "flair", "pattern" or "whole".
        default: whole
      - name: generate_json
        type: bool
        default: true
      - name: generate_html
        type: bool
        default: true
      - name: is_full_text
        type: bool
        doc: Whether to return the full text or only the masked text.
        default: true
      - name: is_full_html
        type: bool
        doc: Whether to return the full html or just the annotated text
        default: true
      - name: is_full_report
        type: bool
        doc: Whether to return the full report or just the score and start, end index
        default: true
      outputs:
      - default: ''
        doc: 'A tuple of:'
      lineno: 782
  description: This function is used to recognize PII in a given text
  default_handler: recognize_pii
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
