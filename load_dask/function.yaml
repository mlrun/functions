kind: dask
metadata:
  name: load-dask
  tag: ''
  hash: 914b15ffbf95594505f38379cf6e8203f5d9e9ff
  project: ''
  labels:
    author: yjb
  categories:
  - data-movement
  - utils
spec:
  command: ''
  image: mlrun/ml-models
  env: []
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmltcG9ydCBqc29uCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCgppbXBvcnQgZGFzawppbXBvcnQgZGFzay5kYXRhZnJhbWUgYXMgZGQKZnJvbSBkYXNrLmRpc3RyaWJ1dGVkIGltcG9ydCBDbGllbnQsIExvY2FsQ2x1c3RlcgoKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQoKZGVmIGxvYWRfZGFzaygKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgc3JjX2RhdGE6IERhdGFJdGVtLAogICAgZGFza19rZXk6IHN0ciA9ICJkYXNrX2tleSIsCiAgICBpbmNfY29scyA9IFtdLAogICAgaW5kZXhfY29scyA9IFtdLAogICAgZGFza19wZXJzaXN0OiBib29sID0gVHJ1ZSwKICAgIHJlZnJlc2hfZGF0YTogYm9vbCA9IFRydWUsCiAgICBzY2hlZHVsZXJfa2V5OiBzdHIgPSAic2NoZWR1bGVyIgopIC0+IE5vbmU6CiAgICAiIiJMb2FkIGRhdGFzZXQgaW50byBhbiBleGlzdGluZyBkYXNrIGNsdXN0ZXIKICAgIAogICAgZGFzayBqb2JzIGRlZmluZSB0aGUgZGFzayBjbGllbnQgcGFyYW1ldGVycyBhdCB0aGUgam9iIGxldmVsLCB0aGlzIG1ldGhvZCB3aWxsIHJhaXNlIGFuIGVycm9yIGlmIG5vIGNsaWVudCBpcyBkZXRlY3RlZC4KICAgIAogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBzcmNfZGF0YTogICAgICAgIHVybCBvZiB0aGUgZGF0YSBmaWxlIG9yIHBhcnRpdGlvbmVkIGRhdGFzZXQgYXMgZWl0aGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdCBEYXRhSXRlbSwgc3RyaW5nLCBvciBwYXRoIG9iamVjdCAoc2ltaWxhciB0byAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhbmRhcyByZWFkX2NzdikKICAgIDpwYXJhbSBkYXNrX2tleTogICAgICAgIGRlc3RpbmF0aW9uIGtleSBvZiBkYXRhIG9uIGRhc2sgY2x1c3RlciBhbmQgYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBpbmNfY29sczogICAgICAgIGluY2x1ZGUgb25seSB0aGVzZSBjb2x1bW5zIChmYXN0KQogICAgOnBhcmFtIGluZGV4X2NvbHM6ICAgICAgbGlzdCBvZiBpbmRleCBjb2x1bW4gbmFtZXMgKGNhbiBiZSBhIGxvbmctcnVubmluZyBwcm9jZXNzKQogICAgOnBhcmFtIGRhc2tfcGVyc2lzdDogICAgKFRydWUpIHNob3VsZCB0aGUgZGF0YSBiZSBwZXJzaXN0ZWQgKHRocm91Z2ggdGhlIGBjbGllbnQucGVyc2lzdGAgb3ApCiAgICA6cGFyYW0gcmVmcmVzaF9kYXRhOiAgICAoRmFsc2UpIGlmIHRoZSBkYXNrX2tleSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgZGFzayBjbHVzdGVyLCB0aGlzIHdpbGwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBhbiBFeGNlcHRpb24uICBTZXQgdG8gVHJ1ZSB0byByZXBsYWNlIHRoZSBleGlzdGluZyBjbHVzdGVyIGRhdGEuCiAgICA6cGFyYW0gc2NoZWR1bGVyX2tleTogICAoc2NoZWR1bGVyKSB0aGUgZGFzayBzY2hlZHVsZXIgY29uZmlndXJhdGlvbiwganNvbiBhbHNvIGxvZ2dlZCBhcyBhbiBhcnRpZmFjdAogICAgIiIiCiAgICBpZiBoYXNhdHRyKGNvbnRleHQsICJkYXNrX2NsaWVudCIpOgogICAgICAgIGRhc2tfY2xpZW50ID0gY29udGV4dC5kYXNrX2NsaWVudAogICAgZWxzZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oImRhc2sgY2xpZW50IG5vdCBmb3VuZCBpbiB0aGUgZXhlY3V0aW9uIGNvbnRleHQiKQogICAgCiAgICBkZiA9IHNyY19kYXRhLmFzX2RmKGRmX21vZHVsZT1kZCkKICAgIAogICAgaWYgZGFza19wZXJzaXN0OgogICAgICAgIGRmID0gZGFza19jbGllbnQucGVyc2lzdChkZikKICAgICAgICBpZiBkYXNrX2NsaWVudC5kYXRhc2V0cyBhbmQgZGFza19rZXkgaW4gZGFza19jbGllbnQuZGF0YXNldHM6CiAgICAgICAgICAgIGRhc2tfY2xpZW50LnVucHVibGlzaF9kYXRhc2V0KGRhc2tfa2V5KQogICAgICAgIGRhc2tfY2xpZW50LnB1Ymxpc2hfZGF0YXNldChkZiwgbmFtZT1kYXNrX2tleSkKICAgIGlmIGNvbnRleHQ6CiAgICAgICAgY29udGV4dC5kYXNrX2NsaWVudCA9IGRhc2tfY2xpZW50CiAgICAKICAgIGRhc2tfY2xpZW50LndyaXRlX3NjaGVkdWxlcl9maWxlKHNjaGVkdWxlcl9rZXkrIi5qc29uIikKICAgIAogICAgY29udGV4dC5sb2dfYXJ0aWZhY3Qoc2NoZWR1bGVyX2tleSwgbG9jYWxfcGF0aD1zY2hlZHVsZXJfa2V5KyIuanNvbiIpCgo=
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#bbaf91c5a14454dea6ba72cafa3f035608315b67:load_dask.ipynb
  default_handler: load_dask
  entry_points:
    load_dask:
      name: load_dask
      doc: 'Load dataset into an existing dask cluster


        dask jobs define the dask client parameters at the job level, this method
        will raise an error if no client is detected.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: src_data
        type: DataItem
        doc: url of the data file or partitioned dataset as either artifact DataItem,
          string, or path object (similar to  pandas read_csv)
      - name: dask_key
        type: str
        doc: destination key of data on dask cluster and artifact store
        default: dask_key
      - name: inc_cols
        doc: include only these columns (fast)
      - name: index_cols
        doc: list of index column names (can be a long-running process)
      - name: dask_persist
        type: bool
        doc: (True) should the data be persisted (through the `client.persist` op)
        default: true
      - name: refresh_data
        type: bool
        doc: (False) if the dask_key already exists in the dask cluster, this will  raise
          an Exception.  Set to True to replace the existing cluster data.
        default: true
      - name: scheduler_key
        type: str
        doc: (scheduler) the dask scheduler configuration, json also logged as an
          artifact
        default: scheduler
      outputs: []
      lineno: 15
  description: load dask cluster with data
  replicas: 4
  remote: true
  service_type: NodePort
  nthreads: 1
  min_replicas: 0
  max_replicas: 8
  scheduler_timeout: 60 minutes
