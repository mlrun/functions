metadata:
  tag: ''
  name: model-server-tester
  categories:
  - monitoring
  - model-serving
verbose: false
kind: job
spec:
  image: mlrun/mlrun
  disable_auto_mount: false
  build:
    origin_filename: ''
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKIyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IGpzb24KZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcmVxdWVzdHMKZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IENoYXJ0QXJ0aWZhY3QKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCgoKZGVmIG1vZGVsX3NlcnZlcl90ZXN0ZXIoCiAgICBjb250ZXh0LAogICAgdGFibGU6IERhdGFJdGVtLAogICAgYWRkcjogc3RyLAogICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWwiLAogICAgbW9kZWw6IHN0ciA9ICIiLAogICAgbWF0Y2hfZXJyOiBib29sID0gRmFsc2UsCiAgICByb3dzOiBpbnQgPSAyMCwKKToKICAgICIiIlRlc3QgYSBtb2RlbCBzZXJ2ZXIKCiAgICA6cGFyYW0gdGFibGU6ICAgICAgICAgY3N2L3BhcnF1ZXQgdGFibGUgd2l0aCB0ZXN0IGRhdGEKICAgIDpwYXJhbSBhZGRyOiAgICAgICAgICBmdW5jdGlvbiBhZGRyZXNzL3VybAogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogIG5hbWUgb2YgdGhlIGxhYmVsIGNvbHVtbiBpbiB0YWJsZQogICAgOnBhcmFtIG1vZGVsOiAgICAgICAgIHRlc3RlZCBtb2RlbCBuYW1lCiAgICA6cGFyYW0gbWF0Y2hfZXJyOiAgICAgcmFpc2UgZXJyb3Igb24gdmFsaWRhdGlvbiAocmVxdWlyZSBwcm9wZXIgdGVzdCBzZXQpCiAgICA6cGFyYW0gcm93czogICAgICAgICAgbnVtYmVyIG9mIHJvd3MgdG8gdXNlIGZyb20gdGVzdCBzZXQKICAgICIiIgoKICAgIHRhYmxlID0gdGFibGUuYXNfZGYoKQoKICAgIHlfbGlzdCA9IHRhYmxlLnBvcChsYWJlbF9jb2x1bW4pLnZhbHVlcy50b2xpc3QoKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInRlc3Rpbmcgd2l0aCBkYXRhc2V0IGFnYWluc3Qge2FkZHJ9LCBtb2RlbDoge21vZGVsfSIpCiAgICBpZiByb3dzIGFuZCByb3dzIDwgdGFibGUuc2hhcGVbMF06CiAgICAgICAgdGFibGUgPSB0YWJsZS5zYW1wbGUocm93cykKCiAgICBjb3VudCA9IGVycl9jb3VudCA9IG1hdGNoID0gMAogICAgdGltZXMgPSBbXQogICAgZm9yIHgsIHkgaW4gemlwKHRhYmxlLnZhbHVlcywgeV9saXN0KToKICAgICAgICBjb3VudCArPSAxCiAgICAgICAgZXZlbnRfZGF0YSA9IGpzb24uZHVtcHMoeyJpbnN0YW5jZXMiOiBbeC50b2xpc3QoKV19KQogICAgICAgIGhhZF9lcnIgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgc3RhcnQgPSBkYXRldGltZS5ub3coKQogICAgICAgICAgICByZXNwID0gcmVxdWVzdHMucHV0KGYie2FkZHJ9L3ttb2RlbH0vcHJlZGljdCIsIGpzb249ZXZlbnRfZGF0YSkKICAgICAgICAgICAgaWYgbm90IHJlc3Aub2s6CiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5lcnJvcihmImJhZCBmdW5jdGlvbiByZXNwISFcbntyZXNwLnRleHR9IikKICAgICAgICAgICAgICAgIGVycl9jb3VudCArPSAxCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0aW1lcy5hcHBlbmQoKGRhdGV0aW1lLm5vdygpIC0gc3RhcnQpLm1pY3Jvc2Vjb25kcykKCiAgICAgICAgZXhjZXB0IE9TRXJyb3IgYXMgZXJyOgogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5lcnJvcihmImVycm9yIGluIHJlcXVlc3QsIGRhdGE6e2V2ZW50X2RhdGF9LCBlcnJvcjoge2Vycn0iKQogICAgICAgICAgICBlcnJfY291bnQgKz0gMQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICB5X3Jlc3AgPSByZXNwLmpzb24oKVswXQogICAgICAgIGlmIHkgPT0geV9yZXNwOgogICAgICAgICAgICBtYXRjaCArPSAxCgogICAgY29udGV4dC5sb2dfcmVzdWx0KCJ0b3RhbF90ZXN0cyIsIGNvdW50KQogICAgY29udGV4dC5sb2dfcmVzdWx0KCJlcnJvcnMiLCBlcnJfY291bnQpCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoIm1hdGNoIiwgbWF0Y2gpCiAgICBpZiBjb3VudCAtIGVycl9jb3VudCA+IDA6CiAgICAgICAgdGltZXNfYXJyID0gbnAuYXJyYXkodGltZXMpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KCJhdmdfbGF0ZW5jeSIsIGludChucC5tZWFuKHRpbWVzX2FycikpKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdCgibWluX2xhdGVuY3kiLCBpbnQobnAuYW1pbih0aW1lc19hcnIpKSkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoIm1heF9sYXRlbmN5IiwgaW50KG5wLmFtYXgodGltZXNfYXJyKSkpCgogICAgICAgIGNoYXJ0ID0gQ2hhcnRBcnRpZmFjdCgibGF0ZW5jeSIsIGhlYWRlcj1bIlRlc3QiLCAiTGF0ZW5jeSAobWljcm9zZWMpIl0pCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKHRpbWVzKSk6CiAgICAgICAgICAgIGNoYXJ0LmFkZF9yb3coW2kgKyAxLCBpbnQodGltZXNbaV0pXSkKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChjaGFydCkKCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKAogICAgICAgIGYicnVuIHtjb3VudH0gdGVzdHMsIHtlcnJfY291bnR9IGVycm9ycyBhbmQge21hdGNofSBtYXRjaCBleHBlY3RlZCB2YWx1ZSIKICAgICkKCiAgICBpZiBlcnJfY291bnQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmImZhaWxlZCBvbiB7ZXJyX2NvdW50fSB0ZXN0cyBvZiB7Y291bnR9IikKCiAgICBpZiBtYXRjaF9lcnIgYW5kIG1hdGNoICE9IGNvdW50OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJvbmx5IHttYXRjaH0gcmVzdWx0cyBtYXRjaCBvdXQgb2Yge2NvdW50fSIpCg==
    code_origin: ''
  filename: model_server_tester.py
  entry_points:
    model_server_tester:
      parameters:
      - name: context
      - name: table
        type: DataItem
        doc: csv/parquet table with test data
      - name: addr
        type: str
        doc: function address/url
      - name: label_column
        type: str
        doc: name of the label column in table
        default: label
      - name: model
        type: str
        doc: tested model name
        default: ''
      - name: match_err
        type: bool
        doc: raise error on validation (require proper test set)
        default: false
      - name: rows
        type: int
        doc: number of rows to use from test set
        default: 20
      name: model_server_tester
      doc: Test a model server
      has_kwargs: false
      has_varargs: false
      lineno: 26
  command: ''
  description: test model servers
  default_handler: model_server_tester
