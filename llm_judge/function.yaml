kind: job
metadata:
  name: llm-judge
  tag: ''
  hash: 944bc5677dca3283d350c63ce8551c99109e80d9
  project: ''
  labels:
    author: pgw
  categories:
  - machine-learning
  - monitoring
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyNCBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAojCiMgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQojIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiMgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiMgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAojIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgojCgppbXBvcnQgcmUKZnJvbSBhYmMgaW1wb3J0IEFCQywgYWJzdHJhY3RtZXRob2QKZnJvbSBmdW5jdG9vbHMgaW1wb3J0IHdyYXBzCmZyb20gdHlwaW5nIGltcG9ydCBBbnksIENsYXNzVmFyLCBEaWN0LCBUdXBsZSwgVW5pb24sIFR5cGVWYXIKaW1wb3J0IG1waTRweQppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCB0cmFuc2Zvcm1lcnMKCmltcG9ydCBtbHJ1bgpmcm9tIG1scnVuLm1vZGVsIGltcG9ydCBNb2RlbE9iagpmcm9tIG1scnVuLnV0aWxzIGltcG9ydCBsb2dnZXIKaW1wb3J0IG9wZW5haQppbXBvcnQganNvbgppbXBvcnQgcGF0aGxpYgoKIyBUaGVzZSBwcm1vcHQgYXJlIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIGdyYWRlIGZvciBMTE0tYXMgYSBqdWRnZQoKIiIiCkBtaXNje3poZW5nMjAyM2p1ZGdpbmcsCiAgICAgIHRpdGxlPXtKdWRnaW5nIExMTS1hcy1hLWp1ZGdlIHdpdGggTVQtQmVuY2ggYW5kIENoYXRib3QgQXJlbmF9LAogICAgICBhdXRob3I9e0xpYW5taW4gWmhlbmcgYW5kIFdlaS1MaW4gQ2hpYW5nIGFuZCBZaW5nIFNoZW5nIGFuZCBTaXl1YW4gWmh1YW5nCiAgICAgIGFuZCBaaGFuZ2hhbyBXdSBhbmQgWW9uZ2hhbyBaaHVhbmcgYW5kIFppIExpbiBhbmQgWmh1b2hhbiBMaQogICAgICBhbmQgRGFjaGVuZyBMaSBhbmQgRXJpYy4gUCBYaW5nIGFuZCBIYW8gWmhhbmcgYW5kIEpvc2VwaCBFLiBHb256YWxlegogICAgICBhbmQgSW9uIFN0b2ljYX0sCiAgICAgIHllYXI9ezIwMjN9LAogICAgICBlcHJpbnQ9ezIzMDYuMDU2ODV9LAogICAgICBhcmNoaXZlUHJlZml4PXthclhpdn0sCiAgICAgIHByaW1hcnlDbGFzcz17Y3MuQ0x9Cn0KIiIiCgpTSU5HTEVfR1JBREVfUFJPTVBUID0gIiIiClRhc2s6ClBsZWFzZSBhY3QgYXMgYW4gaW1wYXJ0aWFsIGp1ZGdlIGFuZCBldmFsdWF0ZSB0aGUgcXVhbGl0eSBvZiB0aGUgcmVzcG9uc2UgcHJvdmlkZWQgYnkgYW4KQUkgYXNzaXN0YW50IHRvIHRoZSB1c2VyIHF1ZXN0aW9uIGRpc3BsYXllZCBiZWxvdy4gWW91IHdpbGwgYmUgZ2l2ZW4gdGhlIGRlZmluaXRpb24gb2Yge25hbWV9LCBncmFkaW5nIHJ1YnJpYywgY29udGV4dCBpbmZvcm1hdGlvbi4KWW91ciB0YXNrIGlzIHRvIGRldGVybWluZSBhIG51bWVyaWNhbCBzY29yZSBvZiB7bmFtZX0gZm9yIHRoZSByZXNwb25zZS4gWW91IG11c3QgdXNlIHRoZSBncmFkaW5nIHJ1YnJpYyB0byBkZXRlcm1pbmUgeW91ciBzY29yZS4gWW91IG11c3QgYWxzbyBnaXZlIGEgZXhwbGFuYXRpb24gYWJvdXQgaG93IGRpZCB5b3UgZGV0ZXJtaW5lIHRoZSBzY29yZSBzdGVwLWJ5LXN0ZXAuIFBsZWFzZSB1c2UgY2hhaW4gb2YgdGhpbmtpbmcuCkV4YW1wbGVzIGNvdWxkIGJlIGluY2x1ZGVkIGJlYmxvdyBmb3IgeW91ciByZWZlcmVuY2UuIE1ha2Ugc3VyZSB5b3UgdW5kZXJzdGFuZCB0aGUgZ3JhZGluZyBydWJyaWMgYW5kIHVzZSB0aGUgZXhhbXBsZXMgYmVmb3JlIGNvbXBsZXRpbmcgdGhlIHRhc2suCltFeGFtcGxlc106CntleGFtcGxlc30KW1VzZXIgUXVlc3Rpb25dOgp7cXVlc3Rpb259CltSZXNwb25zZV06CnthbnN3ZXJ9CltEZWZpbml0aW9uIG9mIHtuYW1lfV06CntkZWZpbml0aW9ufQpbR3JhZGluZyBSdWJyaWNdOgp7cnVicmljfQpZb3UgbXVzdCByZXR1cm4gdGhlIGZvbGxvd2luZyBmaWVsZHMgaW4geW91ciBvdXRwdXQ6Ci0gc2NvcmU6IGEgbnVtZXJpY2FsIHNjb3JlIG9mIHtuYW1lfSBmb3IgdGhlIHJlc3BvbnNlCi0gZXhwbGFuYXRpb246IGEgZXhwbGFuYXRpb24gYWJvdXQgaG93IGRpZCB5b3UgZGV0ZXJtaW5lIHRoZSBzY29yZSBzdGVwLWJ5LXN0ZXAKW091dHB1dF06CiIiIgoKUEFJUl9HUkFERV9QUk9NUFQgPSAiIiIKVGFzazoKWW91ciB0YXNrIGlzIHRvIGRldGVybWluZSB0d28gbnVtZXJpY2FsIHNjb3JlIG9mIHtuYW1lfSBmb3IgdGhlIHJlc3BvbnNlcyBmcm9tIHR3byBBSSBhc3Npc3RhbnRzLiBZb3UgbXVzdCB1c2UgdGhlIGdyYWRpbmcgcnVicmljIHRvIGRldGVybWluZSB5b3VyIHNjb3Jlcy4gWW91IG11c3QgYWxzbyBnaXZlIGEgZXhwbGFuYXRpb24gYWJvdXQgaG93IGRpZCB5b3UgZGV0ZXJtaW5lIHRoZSBzY29yZXMgc3RlcC1ieS1zdGVwLiBQbGVhc2UgdXNpbmcgY2hhaW4gb2YgdGhpbmtpbmcuCkV4YW1wbGVzIGNvdWxkIGJlIGluY2x1ZGVkIGJlYmxvdyBmb3IgeW91ciByZWZlcmVuY2UuIE1ha2Ugc3VyZSB5b3UgdW5kZXJzdGFuZCB0aGUgZ3JhZGluZyBydWJyaWMgYW5kIHVzZSB0aGUgZXhhbXBsZXMgYmVmb3JlIGNvbXBsZXRpbmcgdGhlIHRhc2suCltFeGFtcGxlc106CntleGFtcGxlc30KW1VzZXIgUXVlc3Rpb25dOgp7cXVlc3Rpb259CltSZXNwb25zZSBvZiBhc3Npc3RhbnQgQV06CnthbnN3ZXJBfQpbUmVzcG9uc2Ugb2YgYXNzaXN0YW50IEJdOgp7YW5zd2VyQn0KW0RlZmluaXRpb24gb2Yge25hbWV9XToKe2RlZmluaXRpb259CltHcmFkaW5nIFJ1YnJpY106CntydWJyaWN9CllvdSBtdXN0IHJldHVybiB0aGUgZm9sbG93aW5nIGZpZWxkcyBpbiB5b3VyIG91dHB1dDoKLSBzY29yZSBvZiBhc3Npc3RhbnQgYTogYSBudW1lcmljYWwgc2NvcmUgb2Yge25hbWV9IGZvciB0aGUgcmVzcG9uc2UKLSBleHBsYW5hdGlvbiBvZiBhc3Npc3RhbnQgYTogYSBleHBsYW5hdGlvbiBhYm91dCBob3cgZGlkIHlvdSBkZXRlcm1pbmUgdGhlIHNjb3JlIHN0ZXAtYnktc3RlcAotIHNjb3JlIG9mIGFzc2lzdGFudCBiOiBhIG51bWVyaWNhbCBzY29yZSBvZiB7bmFtZX0gZm9yIHRoZSByZXNwb25zZQotIGV4cGxhbmF0aW9uIG9mIGFzc2lzdGFudCBiOiBhIGV4cGxhbmF0aW9uIGFib3V0IGhvdyBkaWQgeW91IGRldGVybWluZSB0aGUgc2NvcmUgc3RlcC1ieS1zdGVwCltPdXRwdXRdOgoiIiIKClJFRl9HUkFERV9QUk9NUFQgPSAiIiIKVGFzazoKWW91ciB0YXNrIGlzIHRvIGRldGVybWluZSB0d28gbnVtZXJpY2FsIHNjb3JlIG9mIHtuYW1lfSBmb3IgdGhlIHJlc3BvbnNlcyBmcm9tIHR3byBBSSBhc3Npc3RhbnRzIHdpdGggdGhlIGdyb3VuZCB0cnV0aCBvZiB0aGUgcmVzcG9uc2UuIFlvdSBtdXN0IHVzZSB0aGUgZ3JhZGluZyBydWJyaWMgdG8gZGV0ZXJtaW5lIHlvdXIgc2NvcmVzLiBZb3UgbXVzdCB1c2UgdGhlIGdyb3VuZCB0cnV0aCBvZiB0aGUgcmVzcG9uc2UuIFlvdSBuZWVkIHRvIGdpdmUgYSBleHBsYW5hdGlvbiBhYm91dCBob3cgZGlkIHlvdSBjb21wYXJlIHdpdGggdGhlIGdyb3VuZCB0cnV0aCBvZiB0aGUgcmVzcG9uc2UgdG8gZGV0ZXJtaW5lIHRoZSBzY29yZXMgc3RlcC1ieS1zdGVwLiBQbGVhc2UgdXNpbmcgY2hhaW4gb2YgdGhpbmtpbmcuCkV4YW1wbGVzIGNvdWxkIGJlIGluY2x1ZGVkIGJlYmxvdyBmb3IgeW91ciByZWZlcmVuY2UuIE1ha2Ugc3VyZSB5b3UgdW5kZXJzdGFuZCB0aGUgZ3JhZGluZyBydWJyaWMgYW5kIHVzZSB0aGUgZXhhbXBsZXMgYmVmb3JlIGNvbXBsZXRpbmcgdGhlIHRhc2suCltFeGFtcGxlc106CntleGFtcGxlc30KW1VzZXIgUXVlc3Rpb25dOgp7cXVlc3Rpb259CltSZXNwb25zZSBvZiBhc3Npc3RhbnQgQV06CnthbnN3ZXJBfQpbUmVzcG9uc2Ugb2YgYXNzaXN0YW50IEJdOgp7YW5zd2VyQn0KW0dyb3VuZCB0cnV0aCBvZiB0aGUgcmVzcG9uc2VdOgp7cmVmZXJlbmNlfQpbRGVmaW5pdGlvbiBvZiB7bmFtZX1dOgp7ZGVmaW5pdGlvbn0KW0dyYWRpbmcgUnVicmljXToKe3J1YnJpY30KWW91IG11c3QgcmV0dXJuIHRoZSBmb2xsb3dpbmcgZmllbGRzIGluIHlvdXIgb3V0cHV0OgotIHNjb3JlIG9mIGFzc2lzdGFudCBhOiBhIG51bWVyaWNhbCBzY29yZSBvZiB7bmFtZX0gZm9yIHRoZSByZXNwb25zZQotIGV4cGxhbmF0aW9uIG9mIGFzc2lzdGFudCBhOiBhIGV4cGxhbmF0aW9uIGFib3V0IGhvdyBkaWQgeW91IGNvbXBhcmUgd2l0aCB0aGUgZ3JvdW5kIHRydXRoIG9mIHRoZSByZXNwb25zZSB0byBkZXRlcm1pbmUgdGhlIHNjb3JlIHN0ZXAtYnktc3RlcAotIHNjb3JlIG9mIGFzc2lzdGFudCBiOiBhIG51bWVyaWNhbCBzY29yZSBvZiB7bmFtZX0gZm9yIHRoZSByZXNwb25zZQotIGV4cGxhbmF0aW9uIG9mIGFzc2lzdGFudCBiOiBhIGV4cGxhbmF0aW9uIGFib3V0IGhvdyBkaWQgeW91IGNvbXBhcmUgd2l0aCB0aGUgZ3JvdW5kIHRydXRoIG9mIHRoZSByZXNwb25zZSB0byBkZXRlcm1pbmUgdGhlIHNjb3JlIHN0ZXAtYnktc3RlcApbT3V0cHV0XToKIiIiCgoKZGVmIF9jaGVja19tbHJ1bl9hbmRfb3Blbl9tcGkoKSAtPiBUdXBsZVsibWxydW4uTUxDbGllbnRDdHgiLCAibXBpNHB5Lk1QSS5JbnRyYWNvbW0iXToKICAgIGlzX21waSA9IEZhbHNlCiAgICB0cnk6CiAgICAgICAgY29udGV4dCA9IG1scnVuLmdldF9vcl9jcmVhdGVfY3R4KG5hbWU9Im1scnVuIikKICAgICAgICBpc19tcGkgPSBjb250ZXh0LmxhYmVscy5nZXQoImtpbmQiLCAiam9iIikgPT0gIm1waWpvYiIKCiAgICAgICAgaWYgaXNfbXBpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIG1waTRweSBpbXBvcnQgTVBJCgogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQsIE1QSS5DT01NX1dPUkxECiAgICAgICAgICAgIGV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yIGFzIG1waTRweV9ub3RfZm91bmQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlRvIGRpc3RyaWJ1dGUgdGhlIGZ1bmN0aW9uIHVzaW5nIE1MUnVuJ3MgJ21waWpvYicgeW91IG5lZWQgdG8gaGF2ZSBgbXBpNHB5YCBwYWNrYWdlIGluIHlvdXIgIgogICAgICAgICAgICAgICAgICAgICJpbnRlcnByZXRlci4gUGxlYXNlIHJ1biBgcGlwIGluc3RhbGwgbXBpNHB5YCBhbmQgbWFrZSBzdXJlIHlvdSBoYXZlIG9wZW4tbXBpLiIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHJhaXNlIG1waTRweV9ub3RfZm91bmQKICAgIGV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yIGFzIG1vZHVsZV9ub3RfZm91bmQ6CiAgICAgICAgaWYgaXNfbXBpOgogICAgICAgICAgICByYWlzZSBtb2R1bGVfbm90X2ZvdW5kCiAgICByZXR1cm4gTm9uZSwgTm9uZQoKCmRlZiBfb3Blbl9tcGlfaGFuZGxlcigKICAgIHdvcmtlcl9pbnB1dHM6IHN0ciwKKToKICAgICMgQ2hlY2sgZm9yIE1MUnVuIGFuZCBPcGVuTVBJIGF2YWlsYWJpbGl0eToKICAgIGNvbnRleHQsIGNvbW0gPSBfY2hlY2tfbWxydW5fYW5kX29wZW5fbXBpKCkKCiAgICBkZWYgX2RlY29yYXRvcihoYW5kbGVyKToKICAgICAgICBpZiBjb21tIGlzIE5vbmUgb3IgY29tbS5HZXRfc2l6ZSgpID09IDE6CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVyCgogICAgICAgIEB3cmFwcyhoYW5kbGVyKQogICAgICAgIGRlZiBfd3JhcHBlcigqKmt3YXJncyk6CiAgICAgICAgICAgICMgR2V0IHRoZSBvcGVuIG1waSBlbnZpcm9ubWVudCBwcm9wZXJ0aWVzOgogICAgICAgICAgICBzaXplID0gY29tbS5HZXRfc2l6ZSgpCiAgICAgICAgICAgIHJhbmsgPSBjb21tLkdldF9yYW5rKCkKICAgICAgICAgICAgc2FtcGxlX2RmID0ga3dhcmdzW3dvcmtlcl9pbnB1dHNdCgogICAgICAgICAgICAjIEdpdmUgdGhlIGNvcnJlY3QgY2h1bmsgb2YgdGhlIHdvcmtlcnMgaW5wdXRzOgogICAgICAgICAgICBldmVuX2NodW5rX3NpemUgPSBsZW4oc2FtcGxlX2RmKSAvLyBzaXplCiAgICAgICAgICAgIGNodW5rX3N0YXJ0ID0gcmFuayAqIGV2ZW5fY2h1bmtfc2l6ZQogICAgICAgICAgICBjaHVua19lbmQgPSAoCiAgICAgICAgICAgICAgICAocmFuayArIDEpICogZXZlbl9jaHVua19zaXplIGlmIHJhbmsgKyAxIDwgc2l6ZSBlbHNlIGxlbihzYW1wbGVfZGYpCiAgICAgICAgICAgICkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgICAgICBmIlJhbmsgI3tyYW5rfTogUHJvY2Vzc2luZyBpbnB1dCBjaHVuayBzYW1wbGUgZGF0YWZyYW1lIgogICAgICAgICAgICAgICAgZiJmcm9tIGluZGV4IHtjaHVua19zdGFydH0gdG8ge2NodW5rX2VuZH0uIgogICAgICAgICAgICApCiAgICAgICAgICAgIHNhbXBsZV9kZiA9IHNhbXBsZV9kZi5pbG9jW2NodW5rX3N0YXJ0OmNodW5rX2VuZDosIDpdCiAgICAgICAgICAgIGt3YXJnc1t3b3JrZXJfaW5wdXRzXSA9IHNhbXBsZV9kZgoKICAgICAgICAgICAgIyBSdW4gdGhlIHdvcmtlcjoKICAgICAgICAgICAgb3V0cHV0ID0gaGFuZGxlcigqKmt3YXJncykKCiAgICAgICAgICAgICMgU2VuZCB0aGUgb3V0cHV0IHRvIHRoZSByb290IHJhbmsgKHJhbmsgIzApOgogICAgICAgICAgICBvdXRwdXQgPSBjb21tLmdhdGhlcihvdXRwdXQsIHJvb3Q9MCkKICAgICAgICAgICAgaWYgcmFuayA9PSAwOgogICAgICAgICAgICAgICAgIyBKb2luIHRoZSBvdXRwdXRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNvbGxlY3RpbmcgZGF0YSBmcm9tIHdvcmtlcnMgdG8gcm9vdCB3b3JrZXIuIikKICAgICAgICAgICAgICAgIGRhdGFmcmFtZSA9IHBkLmNvbmNhdChvYmpzPVtkZiBmb3IgZGYsIF8gaW4gb3V0cHV0XSwgYXhpcz0wKQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFmcmFtZQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICByZXR1cm4gX3dyYXBwZXIKCiAgICByZXR1cm4gX2RlY29yYXRvcgoKCmNsYXNzIExMTUp1ZGdlQmFzZU1ldHJpYyhNb2RlbE9iaiwgQUJDKToKICAgICIiIgogICAgQmFzZSBjbGFzcyBvZiB0aGUgbWV0cmljcyB0aGF0IGNvbXB1dGVkIGJ5IExMTSBhcyBhIGp1ZGdlCiAgICBXZSBkb24ndCBuZWVkIHRoZSB5X3RydWUgYXMgcmVmZXJlbmNlLiBUaGVzZSBtZXRyaWNzIGFyZSB1c2VkIGZvciBtb3JlIG9wZW4tZW5kZWQgcXVlc3Rpb24gZm9yIHRoZSBtb2RlbAogICAgYW5kIHRoZSBhbGdvcml0aG0gaXMgYmFzZWQgb24gdGhlIHBhcGVyIGh0dHBzOi8vYXJ4aXYub3JnL3BkZi8yMzA2LjA1Njg1LnBkZgogICAgIiIiCgogICAgX2RpY3RfZmllbGRzID0gWwogICAgICAgICJuYW1lIiwKICAgICAgICAibW9kZWxfanVkZ2UiLAogICAgICAgICJwcm9tcHRfdGVtcGxhdGUiLAogICAgICAgICJwcm9tcHRfY29uZmlnIiwKICAgICAgICAibW9kZWxfanVkZ2VfY29uZmlnIiwKICAgICAgICAidG9rZW5pemVyX2p1ZGdlX2NvbmZpZyIsCiAgICAgICAgIm1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZyIsCiAgICBdCiAgICBraW5kID0gImxsbV9qdWRnZV9tZXRyaWMiCiAgICBkZWZhdWx0X25hbWU6IENsYXNzVmFyW3N0cl0gPSAibGxtX2p1ZGdlX21ldHJpYyIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBuYW1lOiBzdHIsCiAgICAgICAgbW9kZWxfanVkZ2U6IHN0ciwKICAgICAgICBwcm9tcHRfdGVtcGxhdGU6IHN0ciwKICAgICAgICBwcm9tcHRfY29uZmlnOiBEaWN0W3N0ciwgQW55XSwKICAgICAgICBtb2RlbF9qdWRnZV9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICAgICB0b2tlbml6ZXJfanVkZ2VfY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUsCiAgICAgICAgbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUsCiAgICApOgogICAgICAgICIiIgogICAgICAgIFRoZXNlIG1ldHJpY3MgYXJlIHVzZWQgdG8gZXZhbHVhdGUgdGhlIG1vZGVsIHBlcmZvcm1hbmNlIG9uIGEgZ2l2ZW4gZGF0YXNldAogICAgICAgIDpwYXJhbSBuYW1lOiBuYW1lIG9mIHRoZSBtZXRyaWMKICAgICAgICA6cGFyYW0gbW9kZWxfanVkZ2U6IHRoZSBtb2RlbCBqdWRnZSB0byB1c2UKICAgICAgICA6cGFyYW0gbW9kZWxfanVkZ2VfY29uZmlnOiB0aGUgbW9kZWwganVkZ2UgY29uZmlnCiAgICAgICAgOnBhcmFtIHRva2VuaXplcl9qdWRnZV9jb25maWc6IHRoZSB0b2tlbml6ZXIganVkZ2UgY29uZmlnCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZzogdGhlIG1vZGVsIGp1ZGdlIGluZmVyIGNvbmZpZwogICAgICAgIDpwYXJhbSBwcm9tcHRfdGVtcGxhdGU6IHRoZSBwcm9tcHQgdGVtcGxhdGUgdG8gZmlsbAogICAgICAgIDpwYXJhbSBwcm9tcHRfY29uZmlnOiB0aGUgcHJvbXB0IGNvbmZpZyB0byBmaWxsIHRoZSB0ZW1wbGF0ZSB3aXRoCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5uYW1lID0gbmFtZSBvciBzZWxmLmRlZmF1bHRfbmFtZQogICAgICAgIHNlbGYubW9kZWxfanVkZ2UgPSBtb2RlbF9qdWRnZQogICAgICAgIHNlbGYubW9kZWxfanVkZ2VfY29uZmlnID0gbW9kZWxfanVkZ2VfY29uZmlnCiAgICAgICAgc2VsZi50b2tlbml6ZXJfanVkZ2VfY29uZmlnID0gdG9rZW5pemVyX2p1ZGdlX2NvbmZpZwogICAgICAgIHNlbGYubW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnID0gbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnCiAgICAgICAgc2VsZi5wcm9tcHRfdGVtcGxhdGUgPSBwcm9tcHRfdGVtcGxhdGUKICAgICAgICBzZWxmLnByb21wdF9jb25maWcgPSBwcm9tcHRfY29uZmlnCgogICAgZGVmIF9maWxsX3Byb21wdChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgRmlsbCB0aGUgcHJvbXB0IHRlbXBsYXRlIHdpdGggdGhlIHByb21wdCBjb25maWcKICAgICAgICA6cGFyYW0gcHJvbXB0X3RlbXBsYXRlOiB0aGUgcHJvbXB0IHRlbXBsYXRlIHRvIGZpbGwKICAgICAgICA6cGFyYW0gcHJvbXB0X2NvbmZpZzogdGhlIHByb21wdCBjb25maWcgdG8gZmlsbCB0aGUgdGVtcGxhdGUgd2l0aAogICAgICAgIDpyZXR1cm5zOiB0aGUgZmlsbGVkIHByb21wdAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJGaWxsaW5nIHRoZSBwcm9tcHQgdGVtcGxhdGUgd2l0aCB0aGUgcHJvbXB0IGNvbmZpZyIpCiAgICAgICAgcmV0dXJuIHNlbGYucHJvbXB0X3RlbXBsYXRlLmZvcm1hdCgqKnNlbGYucHJvbXB0X2NvbmZpZykKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBfcHJlcGFyZV9qdWRnZShzZWxmKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIFByZXBhcmUgdGhlIGp1ZGdlIG1vZGVsCiAgICAgICAgIiIiCiAgICAgICAgcGFzcwoKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIF9jb21wdXRlX292ZXJfb25lX2RhdGEoc2VsZiwgcXVlc3Rpb246IHN0ciwgcmVzcG9uc2U6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIG9uZSBkYXRhIHBvaW50CiAgICAgICAgOnBhcmFtIHF1ZXN0aW9uOiB0aGUgcXVlc3Rpb24gdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnBhcmFtIHJlc3BvbnNlOiB0aGUgcmVzcG9uc2UgdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnJldHVybnM6IHRoZSBtZXRyaWNzIHNjb3JlIGFuZCB0aGUgZXhwbGFuYXRpb24KICAgICAgICAiIiIKICAgICAgICBwYXNzCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgX2NvbXB1dGVfb3Zlcl9kYXRhKHNlbGYsIHNhbXBsZV9kZjogcGQuRGF0YUZyYW1lKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAgICAgIiIiCiAgICAgICAgQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIG9uZSBkYXRhIHBvaW50CiAgICAgICAgOnBhcmFtIHNhbXBsZV9kZjogdGhlIHNhbXBsZSBkYXRhZnJhbWUgdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnJldHVybnM6IHRoZSBtZXRyaWNzIHNjb3JlIGFuZCB0aGUgZXhwbGFuYXRpb24KICAgICAgICAiIiIKICAgICAgICBwYXNzCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgX2V4dHJhY3Rfc2NvcmVfZXhwbGFuYXRpb24oc2VsZiwgcmVzdWx0OiBzdHIpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEFic3RyYWN0IHRoZSBzdG9yZSBvZiB0aGUgcmVzdWx0CiAgICAgICAgOnBhcmFtIHJlc3VsdDogdGhlIHJlc3VsdCB0ZXh0CiAgICAgICAgOnJldHVybnM6IHRoZSBzdG9yZWQgcmVzdWx0CiAgICAgICAgIiIiCiAgICAgICAgcGFzcwoKCmNsYXNzIExMTUp1ZGdlU2luZ2xlR3JhZGluZyhMTE1KdWRnZUJhc2VNZXRyaWMpOgogICAgIiIiCiAgICBCYXNlIGNsYXNzIGZvciBMTE0gYXMgYSBqdWRnZSB1c2luZyBzaW5nbGUgZ3JhZGluZy4KICAgIHlvdSBuZWVkIHRvIGRlZmluZSB0aGUgZGVmbml0aW9uIG9mIHRoZSBtZXRyaWNzIGFuZCBnaXZlIHRoZSBncmFkaW5nIG9mIHRoZSBydWJpYwogICAgIiIiCgogICAgX2RpY3RfZmllbGRzID0gWwogICAgICAgICJuYW1lIiwKICAgICAgICAibW9kZWxfanVkZ2UiLAogICAgICAgICJtb2RlbF9qdWRnZV9jb25maWciLAogICAgICAgICJtb2RlbF9qdWRnZV9pbmZlcl9jb25maWciLAogICAgICAgICJwcm9tcHRfY29uZmlnIiwKICAgICAgICAidG9rZW5pemVyX2p1ZGdlX2NvbmZpZyIsCiAgICAgICAgInByb21wdF90ZW1wbGF0ZSIsCiAgICBdCiAgICBraW5kID0gImxsbV9qdWRnZV9zaW5nbGVfZ3JhZGluZyIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBuYW1lOiBzdHIsCiAgICAgICAgbW9kZWxfanVkZ2U6IHN0ciwKICAgICAgICBtb2RlbF9qdWRnZV9jb25maWc6IERpY3Rbc3RyLCBBbnldLAogICAgICAgIG1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgcHJvbXB0X2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgcHJvbXB0X3RlbXBsYXRlOiBzdHIgPSBTSU5HTEVfR1JBREVfUFJPTVBULAogICAgICAgIHRva2VuaXplcl9qdWRnZV9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgaW5pdCB0aGUgY2xhc3MKICAgICAgICA6cGFyYW0gbmFtZTogbmFtZSBvZiB0aGUgbWV0cmljCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlOiB0aGUgbW9kZWwganVkZ2UgdG8gdXNlCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlX2NvbmZpZzogdGhlIG1vZGVsIGp1ZGdlIGNvbmZpZwogICAgICAgIDpwYXJhbSB0b2tlbml6ZXJfanVkZ2VfY29uZmlnOiB0aGUgdG9rZW5pemVyIGp1ZGdlIGNvbmZpZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IHRoZSBtb2RlbCBqdWRnZSBpbmZlciBjb25maWcKICAgICAgICA6cGFyYW0gcHJvbXB0X3RlbXBsYXRlOiB0aGUgcHJvbXB0IHRlbXBsYXRlIHRvIGZpbGwKICAgICAgICA6cGFyYW0gcHJvbXB0X2NvbmZpZzogdGhlIHByb21wdCBjb25maWcgdG8gZmlsbCB0aGUgdGVtcGxhdGUgd2l0aAogICAgICAgICIiIgogICAgICAgIHN1cGVyKCkuX19pbml0X18oCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIG1vZGVsX2p1ZGdlLAogICAgICAgICAgICBwcm9tcHRfdGVtcGxhdGUsCiAgICAgICAgICAgIHByb21wdF9jb25maWcsCiAgICAgICAgICAgIG1vZGVsX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgdG9rZW5pemVyX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnLAogICAgICAgICkKCiAgICBkZWYgX3ByZXBhcmVfanVkZ2Uoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBQcmVwYXJlIHRoZSBqdWRnZSBtb2RlbCBpdCB3aWxsIGluaXQgdGhlIHRva2VuaXplciBhbmQgdGhlIG1vZGVsCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJQcmVwYXJpbmcgdGhlIGp1ZGdlIG1vZGVsIHtzZWxmLm1vZGVsX2p1ZGdlfSIpCiAgICAgICAgc2VsZi50b2tlbml6ZXIgPSB0cmFuc2Zvcm1lcnMuQXV0b1Rva2VuaXplci5mcm9tX3ByZXRyYWluZWQoCiAgICAgICAgICAgIHNlbGYubW9kZWxfanVkZ2UsICoqc2VsZi50b2tlbml6ZXJfanVkZ2VfY29uZmlnCiAgICAgICAgKQogICAgICAgIHNlbGYubW9kZWwgPSB0cmFuc2Zvcm1lcnMuQXV0b01vZGVsRm9yQ2F1c2FsTE0uZnJvbV9wcmV0cmFpbmVkKAogICAgICAgICAgICBzZWxmLm1vZGVsX2p1ZGdlLCAqKnNlbGYubW9kZWxfanVkZ2VfY29uZmlnCiAgICAgICAgKQoKICAgIGRlZiBfY29tcHV0ZV9vdmVyX29uZV9kYXRhKHNlbGYsIHF1ZXN0aW9uLCByZXNwb25zZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIG9uZSBkYXRhIHBvaW50CiAgICAgICAgOnBhcmFtIHF1ZXN0aW9uOiB0aGUgcXVlc3Rpb24gdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnBhcmFtIHJlc3BvbnNlOiB0aGUgcmVzcG9uc2UgdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnJldHVybnM6IHRoZSBtZXRyaWNzIHNjb3JlIGFuZCB0aGUgZXhwbGFuYXRpb24KICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgZiJDb21wdXRpbmcgdGhlIG1ldHJpY3Mgb3ZlciBvbmUgZGF0YSBwb2ludCB3aXRoIHtxdWVzdGlvbn0gYW5kIHtyZXNwb25zZX0iCiAgICAgICAgKQogICAgICAgIHNlbGYucHJvbXB0X2NvbmZpZ1sicXVlc3Rpb24iXSA9IHF1ZXN0aW9uCiAgICAgICAgc2VsZi5wcm9tcHRfY29uZmlnWyJhbnN3ZXIiXSA9IHJlc3BvbnNlCiAgICAgICAgaW5wdXRfaWRzID0gc2VsZi50b2tlbml6ZXIoc2VsZi5fZmlsbF9wcm9tcHQoKSwgcmV0dXJuX3RlbnNvcnM9InB0IikuaW5wdXRfaWRzCiAgICAgICAgb3V0cHV0cyA9IHNlbGYubW9kZWwuZ2VuZXJhdGUoCiAgICAgICAgICAgIGlucHV0X2lkcywKICAgICAgICAgICAgcGFkX3Rva2VuX2lkPXNlbGYudG9rZW5pemVyLnBhZF90b2tlbl9pZCwKICAgICAgICAgICAgZW9zX3Rva2VuX2lkPXNlbGYudG9rZW5pemVyLmVvc190b2tlbl9pZCwKICAgICAgICAgICAgKipzZWxmLm1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZywKICAgICAgICApCgogICAgICAgIHJlc3BvbnNlX2lkcyA9IG91dHB1dHNbMF0KICAgICAgICByZXNwb25zZSA9IHNlbGYudG9rZW5pemVyLmRlY29kZShyZXNwb25zZV9pZHMsIHNraXBfc3BlY2lhbF90b2tlbnM9VHJ1ZSkKICAgICAgICByZXNfZGljID0gc2VsZi5fZXh0cmFjdF9zY29yZV9leHBsYW5hdGlvbihyZXNwb25zZSkKICAgICAgICByZXR1cm4gcmVzX2RpYwoKICAgIEBfb3Blbl9tcGlfaGFuZGxlcih3b3JrZXJfaW5wdXRzPSJzYW1wbGVfZGYiKQogICAgZGVmIF9jb21wdXRlX292ZXJfZGF0YSgKICAgICAgICBzZWxmLAogICAgICAgIHNhbXBsZV9kZjogcGQuRGF0YUZyYW1lLAogICAgKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAgICAgIiIiCiAgICAgICAgQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIGFsbCBkYXRhCiAgICAgICAgOnBhcmFtIHNhbXBsZV9kZjogdGhlIHNhbXBsZSBkYXRhZnJhbWUKICAgICAgICA6cmV0dXJuczogdGhlIG1ldHJpY3Mgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbgogICAgICAgICIiIgogICAgICAgIHNlbGYuX3ByZXBhcmVfanVkZ2UoKQogICAgICAgIHJlc19kZiA9IHBkLkRhdGFGcmFtZShjb2x1bW5zPVsicXVlc3Rpb24iLCAiYW5zd2VyIiwgInNjb3JlIiwgImV4cGxhbmF0aW9uIl0pCgogICAgICAgIGxvZ2dlci5pbmZvKCJDb21wdXRpbmcgdGhlIG1ldHJpY3Mgb3ZlciBhbGwgZGF0YSIpCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKHNhbXBsZV9kZikpOgogICAgICAgICAgICByZXNfZGljID0gc2VsZi5fY29tcHV0ZV9vdmVyX29uZV9kYXRhKAogICAgICAgICAgICAgICAgc2FtcGxlX2RmLmxvY1tpLCAicXVlc3Rpb24iXSwgc2FtcGxlX2RmLmxvY1tpLCAiYW5zd2VyIl0KICAgICAgICAgICAgKQogICAgICAgICAgICByZXNfZGYubG9jW2ldID0gWwogICAgICAgICAgICAgICAgc2FtcGxlX2RmLmxvY1tpLCAicXVlc3Rpb24iXSwKICAgICAgICAgICAgICAgIHNhbXBsZV9kZi5sb2NbaSwgImFuc3dlciJdLAogICAgICAgICAgICAgICAgcmVzX2RpY1sic2NvcmUiXSwKICAgICAgICAgICAgICAgIHJlc19kaWNbImV4cGxhbmF0aW9uIl0sCiAgICAgICAgICAgIF0KCiAgICAgICAgcmV0dXJuIHJlc19kZgoKICAgIGRlZiBfZXh0cmFjdF9zY29yZV9leHBsYW5hdGlvbihzZWxmLCByZXN1bHQ6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQWJzdHJhY3QgdGhlIHN0b3JlIG9mIHRoZSByZXN1bHQKICAgICAgICA6cGFyYW0gcmVzdWx0OiB0aGUgcmVzdWx0IHRvIHN0b3JlCiAgICAgICAgOnJldHVybnM6IHRoZSBzdG9yZWQgcmVzdWx0CiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJFeHRyYWN0aW5nIHRoZSBzY29yZSBhbmQgZXhwbGFuYXRpb24gZnJvbSB7cmVzdWx0fSIpCiAgICAgICAgc2NvcmVfcGF0dGVybiA9IHIiXGJzY29yZTpccyooXGQrKVxiIgogICAgICAgIGV4cGxhbmF0aW9uX3BhdHRlcm4gPSByImV4cGxhbmF0aW9uOlxzKiguKj8pXHMqKD89XGJTY29yZTp8JCkiCgogICAgICAgIHNjb3JlX21hdGNoID0gcmUuc2VhcmNoKHNjb3JlX3BhdHRlcm4sIHJlc3VsdCkKICAgICAgICBzY29yZSA9IGludChzY29yZV9tYXRjaC5ncm91cCgxKSkgaWYgc2NvcmVfbWF0Y2ggZWxzZSBOb25lCgogICAgICAgIGV4cGxhbmF0aW9uX21hdGNoID0gcmUuc2VhcmNoKGV4cGxhbmF0aW9uX3BhdHRlcm4sIHJlc3VsdCwgcmUuRE9UQUxMKQogICAgICAgIGV4cGxhbmF0aW9uID0gZXhwbGFuYXRpb25fbWF0Y2guZ3JvdXAoMSkuc3RyaXAoKSBpZiBleHBsYW5hdGlvbl9tYXRjaCBlbHNlIE5vbmUKCiAgICAgICAgcmV0dXJuIHsic2NvcmUiOiBzY29yZSwgImV4cGxhbmF0aW9uIjogZXhwbGFuYXRpb259CgoKY2xhc3MgTExNSnVkZ2VQYWlyd2lzZUdyYWRpbmcoTExNSnVkZ2VCYXNlTWV0cmljKToKICAgICIiIgogICAgQmFzZSBjbGFzcyBmb3IgTExNIGFzIGEganVkZ2UgdXNpbmcgcGFpcndpc2UgZ3JhZGluZy4KICAgIHlvdSBuZWVkIHRvIGRlZmluZSB0aGUgZGVmbml0aW9uIG9mIHRoZSBtZXRyaWNzIGFuZCBnaXZlIHRoZSBncmFkaW5nIG9mIHRoZSBydWJpYwogICAgeW91IG5lZWQgdG8gZ2l2ZSBhIGJhc2UgbW9kZWwgdG8gY29tcGFyZSB0aGUgbW9kZWwgdG8KICAgICIiIgoKICAgIF9kaWN0X2ZpZWxkcyA9IFsKICAgICAgICAibmFtZSIsCiAgICAgICAgIm1vZGVsX2p1ZGdlIiwKICAgICAgICAibW9kZWxfanVkZ2VfY29uZmlnIiwKICAgICAgICAibW9kZWxfYmVuY2hfbWFyayIsCiAgICAgICAgIm1vZGVsX2JlbmNoX21hcmtfY29uZmlnIiwKICAgICAgICAibW9kZWxfYmVuY2hfbWFya19pbmZlcl9jb25maWciLAogICAgICAgICJ0b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWciLAogICAgICAgICJwcm9tcHRfdGVtcGxhdGUiLAogICAgICAgICJwcm9tcHRfY29uZmlnIiwKICAgICAgICAidG9rZW5pemVyX2p1ZGdlX2NvbmZpZyIsCiAgICAgICAgIm1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZyIsCiAgICBdCiAgICBraW5kID0gImxsbV9qdWRnZV9wYWlyd2lzZV9ncmFkaW5nIgoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIG5hbWU6IHN0ciwKICAgICAgICBtb2RlbF9qdWRnZTogc3RyLAogICAgICAgIG1vZGVsX2p1ZGdlX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgbW9kZWxfYmVuY2hfbWFyazogc3RyLAogICAgICAgIG1vZGVsX2JlbmNoX21hcmtfY29uZmlnOiBEaWN0W3N0ciwgQW55XSwKICAgICAgICBtb2RlbF9iZW5jaF9tYXJrX2luZmVyX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgdG9rZW5pemVyX2JlbmNoX21hcmtfY29uZmlnOiBEaWN0W3N0ciwgQW55XSwKICAgICAgICBwcm9tcHRfY29uZmlnOiBEaWN0W3N0ciwgQW55XSwKICAgICAgICBwcm9tcHRfdGVtcGxhdGU6IHN0ciA9IFBBSVJfR1JBREVfUFJPTVBULAogICAgICAgIHRva2VuaXplcl9qdWRnZV9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICAgICBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgaW5pdCB0aGUgY2xhc3MKICAgICAgICA6cGFyYW0gbmFtZTogbmFtZSBvZiB0aGUgbWV0cmljCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlOiB0aGUgbW9kZWwganVkZ2UgdG8gdXNlCiAgICAgICAgOnBhcmFtIHRva2VuaXplcl9qdWRnZV9jb25maWc6IHRoZSB0b2tlbml6ZXIganVkZ2UgY29uZmlnCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlX2NvbmZpZzogdGhlIG1vZGVsIGp1ZGdlIGNvbmZpZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IHRoZSBtb2RlbCBqdWRnZSBpbmZlciBjb25maWcKICAgICAgICA6cGFyYW0gbW9kZWxfYmVuY2hfbWFyazogdGhlIG1vZGVsIGJlbmNoIG1hcmsgdG8gdXNlCiAgICAgICAgOnBhcmFtIG1vZGVsX2JlbmNoX21hcmtfY29uZmlnOiB0aGUgbW9kZWwgYmVuY2ggbWFyayBjb25maWcKICAgICAgICA6cGFyYW0gbW9kZWxfYmVuY2hfbWFya19pbmZlcl9jb25maWc6IHRoZSBtb2RlbCBiZW5jaCBtYXJrIGluZmVyIGNvbmZpZwogICAgICAgIDpwYXJhbSB0b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWc6IHRoZSB0b2tlbml6ZXIgYmVuY2ggbWFyayBjb25maWcKICAgICAgICA6cGFyYW0gcHJvbXB0X3RlbXBsYXRlOiB0aGUgcHJvbXB0IHRlbXBsYXRlIHRvIGZpbGwKICAgICAgICA6cGFyYW0gcHJvbXB0X2NvbmZpZzogdGhlIHByb21wdCBjb25maWcgdG8gZmlsbCB0aGUgdGVtcGxhdGUgd2l0aAogICAgICAgICIiIgogICAgICAgIHN1cGVyKCkuX19pbml0X18oCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIG1vZGVsX2p1ZGdlLAogICAgICAgICAgICBwcm9tcHRfdGVtcGxhdGUsCiAgICAgICAgICAgIHByb21wdF9jb25maWcsCiAgICAgICAgICAgIG1vZGVsX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgdG9rZW5pemVyX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnLAogICAgICAgICkKICAgICAgICBzZWxmLm1vZGVsX2JlbmNoX21hcmsgPSBtb2RlbF9iZW5jaF9tYXJrCiAgICAgICAgc2VsZi5tb2RlbF9iZW5jaF9tYXJrX2NvbmZpZyA9IG1vZGVsX2JlbmNoX21hcmtfY29uZmlnCiAgICAgICAgc2VsZi5tb2RlbF9iZW5jaF9tYXJrX2luZmVyX2NvbmZpZyA9IG1vZGVsX2JlbmNoX21hcmtfaW5mZXJfY29uZmlnCiAgICAgICAgc2VsZi50b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWcgPSB0b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWcKCiAgICBkZWYgX3ByZXBhcmVfanVkZ2Uoc2VsZikgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBpbml0IHRoZSB0b2tlbml6ZXIgYW5kIHRoZSBtb2RlbAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKGYiUHJlcGFyaW5nIHRoZSBqdWRnZSBtb2RlbCB7c2VsZi5tb2RlbF9qdWRnZX0iKQogICAgICAgIHNlbGYudG9rZW5pemVyID0gdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkKAogICAgICAgICAgICBzZWxmLm1vZGVsX2p1ZGdlLCAqKnNlbGYudG9rZW5pemVyX2p1ZGdlX2NvbmZpZwogICAgICAgICkKICAgICAgICBzZWxmLm1vZGVsID0gdHJhbnNmb3JtZXJzLkF1dG9Nb2RlbEZvckNhdXNhbExNLmZyb21fcHJldHJhaW5lZCgKICAgICAgICAgICAgc2VsZi5tb2RlbF9qdWRnZSwgKipzZWxmLm1vZGVsX2p1ZGdlX2NvbmZpZwogICAgICAgICkKCiAgICBkZWYgX3ByZXBhcmVfYmVuY2hfbWFya19tb2RlbChzZWxmKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIFByZXBhcmUgdGhlIG1vZGVsIHRoYXQgdXNlZCBmb3IgYmVuY2ggbWFya2luZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKGYiUHJlcGFyaW5nIHRoZSBiZW5jaCBtYXJrIG1vZGVsIHtzZWxmLm1vZGVsX2JlbmNoX21hcmt9IikKICAgICAgICBzZWxmLnRva2VuaXplcl9iZW5jaF9tYXJrID0gdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkKAogICAgICAgICAgICBzZWxmLm1vZGVsX2JlbmNoX21hcmssICoqc2VsZi50b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWcKICAgICAgICApCiAgICAgICAgc2VsZi5tb2RlbF9iZW5jaF9tYXJrID0gdHJhbnNmb3JtZXJzLkF1dG9Nb2RlbEZvckNhdXNhbExNLmZyb21fcHJldHJhaW5lZCgKICAgICAgICAgICAgc2VsZi5tb2RlbF9iZW5jaF9tYXJrLCAqKnNlbGYubW9kZWxfYmVuY2hfbWFya19jb25maWcKICAgICAgICApCgogICAgZGVmIF9jb21wdXRlX2JlbmNoX21hcmtfcmVzcG9uc2Uoc2VsZiwgcXVlc3Rpb24pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBDb21wdXRlIHRoZSByZXNwb25zZSBvZiB0aGUgYmVuY2ggbWFyayBtb2RlbAogICAgICAgIDpwYXJhbSBxdWVzdGlvbjogdGhlIHF1ZXN0aW9uIHRvIGFzayB0aGUgbW9kZWwKICAgICAgICA6cmV0dXJuczogdGhlIHJlc3BvbnNlCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJDb21wdXRpbmcgdGhlIGJlbmNoIG1hcmsgcmVzcG9uc2UgZm9yIHtxdWVzdGlvbn0iKQogICAgICAgIGlucHV0X2lkcyA9IHNlbGYudG9rZW5pemVyX2JlbmNoX21hcmsocXVlc3Rpb24sIHJldHVybl90ZW5zb3JzPSJwdCIpLmlucHV0X2lkcwogICAgICAgIG91dHB1dHMgPSBzZWxmLm1vZGVsX2JlbmNoX21hcmsuZ2VuZXJhdGUoCiAgICAgICAgICAgIGlucHV0X2lkcywKICAgICAgICAgICAgcGFkX3Rva2VuX2lkPXNlbGYudG9rZW5pemVyX2JlbmNoX21hcmsucGFkX3Rva2VuX2lkLAogICAgICAgICAgICBlb3NfdG9rZW5faWQ9c2VsZi50b2tlbml6ZXJfYmVuY2hfbWFyay5lb3NfdG9rZW5faWQsCiAgICAgICAgICAgICoqc2VsZi5tb2RlbF9iZW5jaF9tYXJrX2luZmVyX2NvbmZpZywKICAgICAgICApCgogICAgICAgIHJlc3BvbnNlX2lkcyA9IG91dHB1dHNbMF0KICAgICAgICByZXNwb25zZSA9IHNlbGYudG9rZW5pemVyX2JlbmNoX21hcmsuZGVjb2RlKAogICAgICAgICAgICByZXNwb25zZV9pZHMsIHNraXBfc3BlY2lhbF90b2tlbnM9VHJ1ZQogICAgICAgICkKICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc3BvbnNlIG9mIHRoZSBiZW5jaCBtYXJrIG1vZGVsIGlzIHtyZXNwb25zZX0iKQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UKCiAgICBkZWYgX2NvbXB1dGVfb3Zlcl9vbmVfZGF0YSgKICAgICAgICBzZWxmLCBxdWVzdGlvbiwgcmVzcG9uc2UsIHJlZmVyZW5jZT1Ob25lCiAgICApIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIENvbXB1dGUgdGhlIG1ldHJpY3Mgb3ZlciBvbmUgZGF0YSBwb2ludAogICAgICAgIDpwYXJhbSBxdWVzdGlvbgogICAgICAgIDpyZXR1cm5zOiB0aGUgbWV0cmljcyBzY29yZSBhbmQgdGhlIGV4cGxhbmF0aW9uCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJDb21wdXRpbmcgdGhlIG1ldHJpY3Mgb3ZlciB7cXVlc3Rpb259IGFuZCB7cmVzcG9uc2V9IikKICAgICAgICBzZWxmLnByb21wdF9jb25maWdbInF1ZXN0aW9uIl0gPSBxdWVzdGlvbgogICAgICAgIHNlbGYucHJvbXB0X2NvbmZpZ1siYW5zd2VyQSJdID0gcmVzcG9uc2UKICAgICAgICBpZiByZWZlcmVuY2U6CiAgICAgICAgICAgIHNlbGYucHJvbXB0X2NvbmZpZ1sicmVmZXJlbmNlIl0gPSByZWZlcmVuY2UKICAgICAgICBzZWxmLnByb21wdF9jb25maWdbImFuc3dlckIiXSA9IHNlbGYuX2NvbXB1dGVfYmVuY2hfbWFya19yZXNwb25zZShxdWVzdGlvbikKICAgICAgICBpbnB1dF9pZHMgPSBzZWxmLnRva2VuaXplcihzZWxmLl9maWxsX3Byb21wdCgpLCByZXR1cm5fdGVuc29ycz0icHQiKS5pbnB1dF9pZHMKICAgICAgICBvdXRwdXRzID0gc2VsZi5tb2RlbC5nZW5lcmF0ZSgKICAgICAgICAgICAgaW5wdXRfaWRzLAogICAgICAgICAgICBwYWRfdG9rZW5faWQ9c2VsZi50b2tlbml6ZXIucGFkX3Rva2VuX2lkLAogICAgICAgICAgICBlb3NfdG9rZW5faWQ9c2VsZi50b2tlbml6ZXIuZW9zX3Rva2VuX2lkLAogICAgICAgICAgICAqKnNlbGYubW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnLAogICAgICAgICkKCiAgICAgICAgcmVzcG9uc2VfaWRzID0gb3V0cHV0c1swXQogICAgICAgIHJlc3BvbnNlID0gc2VsZi50b2tlbml6ZXIuZGVjb2RlKHJlc3BvbnNlX2lkcywgc2tpcF9zcGVjaWFsX3Rva2Vucz1UcnVlKQoKICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc3BvbnNlIG9mIHRoZSBqdWRnZSBtb2RlbCBpcyB7cmVzcG9uc2V9IikKICAgICAgICByZXNfZGljID0gc2VsZi5fZXh0cmFjdF9zY29yZV9leHBsYW5hdGlvbihyZXNwb25zZSkKICAgICAgICByZXNfZGljWyJhbnN3ZXJCIl0gPSBzZWxmLnByb21wdF9jb25maWdbImFuc3dlckIiXQogICAgICAgIHJldHVybiByZXNfZGljCgogICAgQF9vcGVuX21waV9oYW5kbGVyKHdvcmtlcl9pbnB1dHM9InNhbXBsZV9kZiIpCiAgICBkZWYgX2NvbXB1dGVfb3Zlcl9kYXRhKAogICAgICAgIHNlbGYsCiAgICAgICAgc2FtcGxlX2RmOiBwZC5EYXRhRnJhbWUsCiAgICApIC0+IHBkLkRhdGFGcmFtZToKICAgICAgICAiIiIKICAgICAgICBDb21wdXRlIHRoZSBtZXRyaWNzIG92ZXIgYWxsIGRhdGEKICAgICAgICA6cGFyYW0gc2FtcGxlX2RmOiB0aGUgc2FtcGxlIGRhdGFmcmFtZQogICAgICAgIDpyZXR1cm5zOiB0aGUgbWV0cmljcyBzY29yZSBhbmQgdGhlIGV4cGxhbmF0aW9uCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5fcHJlcGFyZV9qdWRnZSgpCiAgICAgICAgc2VsZi5fcHJlcGFyZV9iZW5jaF9tYXJrX21vZGVsKCkKICAgICAgICBjb2xzID0gc2FtcGxlX2RmLmNvbHVtbnMKCiAgICAgICAgcmVzX2RmID0gcGQuRGF0YUZyYW1lKAogICAgICAgICAgICBjb2x1bW5zPVsKICAgICAgICAgICAgICAgICJxdWVzdGlvbiIsCiAgICAgICAgICAgICAgICAiYW5zd2VyQSIsCiAgICAgICAgICAgICAgICAiYW5zd2VyQiIsCiAgICAgICAgICAgICAgICAic2NvcmVfb2ZfYXNzaXN0YW50X2EiLAogICAgICAgICAgICAgICAgImV4cGxhbmF0aW9uX29mX2Fzc2lzdGFudF9hIiwKICAgICAgICAgICAgICAgICJzY29yZV9vZl9hc3Npc3RhbnRfYiIsCiAgICAgICAgICAgICAgICAiZXhwbGFuYXRpb25fb2ZfYXNzaXN0YW50X2IiLAogICAgICAgICAgICBdCiAgICAgICAgKQoKICAgICAgICBmb3IgaSBpbiByYW5nZShsZW4oc2FtcGxlX2RmKSk6CiAgICAgICAgICAgIGlmICJyZWZlcmVuY2UiIGluIGNvbHM6CiAgICAgICAgICAgICAgICByZWYgPSBzYW1wbGVfZGYubG9jW2ksICJyZWZlcmVuY2UiXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmVmID0gTm9uZQoKICAgICAgICAgICAgcmVzX2RpYyA9IHNlbGYuX2NvbXB1dGVfb3Zlcl9vbmVfZGF0YSgKICAgICAgICAgICAgICAgIHNhbXBsZV9kZi5sb2NbaSwgInF1ZXN0aW9uIl0sIHNhbXBsZV9kZi5sb2NbaSwgImFuc3dlciJdLCByZWYKICAgICAgICAgICAgKQogICAgICAgICAgICByZXNfZGYubG9jW2ldID0gWwogICAgICAgICAgICAgICAgc2FtcGxlX2RmLmxvY1tpLCAicXVlc3Rpb24iXSwKICAgICAgICAgICAgICAgIHNhbXBsZV9kZi5sb2NbaSwgImFuc3dlciJdLAogICAgICAgICAgICAgICAgcmVzX2RpY1siYW5zd2VyQiJdLAogICAgICAgICAgICAgICAgcmVzX2RpY1sic2NvcmVfb2ZfYXNzaXN0YW50X2EiXSwKICAgICAgICAgICAgICAgIHJlc19kaWNbImV4cGxhbmF0aW9uX29mX2Fzc2lzdGFudF9hIl0sCiAgICAgICAgICAgICAgICByZXNfZGljWyJzY29yZV9vZl9hc3Npc3RhbnRfYiJdLAogICAgICAgICAgICAgICAgcmVzX2RpY1siZXhwbGFuYXRpb25fb2ZfYXNzaXN0YW50X2IiXSwKICAgICAgICAgICAgXQoKICAgICAgICByZXR1cm4gcmVzX2RmCgogICAgZGVmIF9leHRyYWN0X3Njb3JlX2V4cGxhbmF0aW9uKHNlbGYsIHJlc3BvbnNlKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBFeHRyYWN0IHRoZSBzY29yZSBhbmQgdGhlIGV4cGxhbmF0aW9uIGZyb20gdGhlIHJlc3BvbnNlCiAgICAgICAgOnBhcmFtIHJlc3BvbnNlOiB0aGUgcmVzcG9uc2UgdG8gZXh0cmFjdCB0aGUgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbiBmcm9tCiAgICAgICAgOnJldHVybnM6IHRoZSBzY29yZSBhbmQgdGhlIGV4cGxhbmF0aW9uCiAgICAgICAgIiIiCiAgICAgICAgIyBGaW5kIHRoZSBwb3NpdGlvbiBvZiB0aGUgIltPdXRwdXRdOiIgbWFya2VyCiAgICAgICAgb3V0cHV0X21hcmtlcl9pbmRleCA9IHJlc3BvbnNlLmZpbmQoIltPdXRwdXRdOiIpCiAgICAgICAgaWYgb3V0cHV0X21hcmtlcl9pbmRleCA9PSAtMToKICAgICAgICAgICAgcmV0dXJuICJObyAnW091dHB1dF06JyBtYXJrZXIgZm91bmQiCgogICAgICAgICMgRXh0cmFjdCB0aGUgcGFydCBvZiB0aGUgcmVzcG9uc2UgYWZ0ZXIgdGhlICJbT3V0cHV0XToiIG1hcmtlcgogICAgICAgIHJlc3BvbnNlX2FmdGVyX291dHB1dCA9IHJlc3BvbnNlW291dHB1dF9tYXJrZXJfaW5kZXggKyBsZW4oIltPdXRwdXRdOiIpIDpdCgogICAgICAgICMgQWRqdXN0ZWQgcGF0dGVybiB0byBtYXRjaCB0aGUgdGV4dCBmb3JtYXQgYW5kIHNlcGFyYXRlIGxpbmVzCiAgICAgICAgcGF0dGVybiA9IHIiLSBzY29yZSBvZiBhc3Npc3RhbnQgKFthYkFCXSk6IChcZClccyotIGV4cGxhbmF0aW9uIG9mIGFzc2lzdGFudCBcMTogKC4qPylccyooPz0tIHNjb3JlIG9mIGFzc2lzdGFudHwkKSIKICAgICAgICBtYXRjaGVzID0gcmUuZmluZGFsbChwYXR0ZXJuLCByZXNwb25zZV9hZnRlcl9vdXRwdXQsIHJlLkRPVEFMTCkKCiAgICAgICAgaWYgbWF0Y2hlczoKICAgICAgICAgICAgcmVzdWx0X2RpY3QgPSB7fQogICAgICAgICAgICBmb3IgbWF0Y2ggaW4gbWF0Y2hlczoKICAgICAgICAgICAgICAgIGFzc2lzdGFudCwgc2NvcmUsIGV4cGxhbmF0aW9uID0gbWF0Y2gKICAgICAgICAgICAgICAgIHJlc3VsdF9kaWN0W2Yic2NvcmVfb2ZfYXNzaXN0YW50X3thc3Npc3RhbnR9Ii5sb3dlcigpXSA9IGludChzY29yZSkKICAgICAgICAgICAgICAgIHJlc3VsdF9kaWN0WwogICAgICAgICAgICAgICAgICAgIGYiZXhwbGFuYXRpb25fb2ZfYXNzaXN0YW50X3thc3Npc3RhbnR9Ii5sb3dlcigpCiAgICAgICAgICAgICAgICBdID0gZXhwbGFuYXRpb24uc3RyaXAoKQogICAgICAgICAgICByZXR1cm4gcmVzdWx0X2RpY3QKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgIk5vIG1hdGNoZXMgZm91bmQgYWZ0ZXIgJ1tPdXRwdXRdOicgbWFya2VyLiAiCiAgICAgICAgICAgICAgICAiUGxlYXNlIGNoZWNrIHRoZSBmb3JtYXQgb2YgdGhlIHJlc3BvbnNlLiIKICAgICAgICAgICAgKQoKCmNsYXNzIExMTUp1ZGdlUmVmZXJlbmNlR3JhZGluZyhMTE1KdWRnZVBhaXJ3aXNlR3JhZGluZyk6CiAgICAiIiIKICAgIExMTSBKdWRnZSBSZWZlcmVuY2UgR3JhZGluZyBjbGFzcwogICAgeW91IG5lZWQgdG8gZ2l2ZSB0aGUgbmFtZSBvZiB0aGUgbWV0cmljcywgZ2l2ZSB0aGUgZ3JhZGluZyBydWJyaWMgYW5kIHRoZSBiZW5jaCBtYXJrIG1vZGVsIHRvIHVzZQogICAgVGhpcyBjbGFzcyByZXF1cmllIHlvdSBrbm93IHRoZSB5X3RydWUgb2YgdGhlIHJlc3BvbnNlCiAgICAiIiIKCiAgICBfZGljdF9maWVsZHMgPSBbCiAgICAgICAgIm5hbWUiLAogICAgICAgICJtb2RlbF9qdWRnZSIsCiAgICAgICAgIm1vZGVsX2p1ZGdlX2NvbmZpZyIsCiAgICAgICAgIm1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZyIsCiAgICAgICAgInRva2VuaXplcl9qdWRnZV9jb25maWciLAogICAgICAgICJtb2RlbF9iZW5jaF9tYXJrIiwKICAgICAgICAibW9kZWxfYmVuY2hfbWFya19jb25maWciLAogICAgICAgICJtb2RlbF9iZW5jaF9tYXJrX2luZmVyX2NvbmZpZyIsCiAgICAgICAgInRva2VuaXplcl9iZW5jaF9tYXJrX2NvbmZpZyIsCiAgICAgICAgInByb21wdF90ZW1wbGF0ZSIsCiAgICAgICAgInByb21wdF9jb25maWciLAogICAgXQogICAga2luZCA9ICJsbG1fanVkZ2VfcmVmZXJlbmNlX2dyYWRpbmciCgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgbmFtZTogc3RyLAogICAgICAgIG1vZGVsX2p1ZGdlOiBzdHIsCiAgICAgICAgbW9kZWxfanVkZ2VfY29uZmlnOiBEaWN0W3N0ciwgQW55XSwKICAgICAgICBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IERpY3Rbc3RyLCBBbnldLAogICAgICAgIHRva2VuaXplcl9qdWRnZV9jb25maWc6IERpY3Rbc3RyLCBBbnldLAogICAgICAgIG1vZGVsX2JlbmNoX21hcms6IHN0ciwKICAgICAgICBtb2RlbF9iZW5jaF9tYXJrX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgdG9rZW5pemVyX2JlbmNoX21hcmtfY29uZmlnOiBEaWN0W3N0ciwgQW55XSwKICAgICAgICBtb2RlbF9iZW5jaF9tYXJrX2luZmVyX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgcHJvbXB0X2NvbmZpZzogRGljdFtzdHIsIHN0cl0sCiAgICAgICAgcHJvbXB0X3RlbXBsYXRlOiBzdHIgPSBSRUZfR1JBREVfUFJPTVBULAogICAgKToKICAgICAgICAiIiIKICAgICAgICBpbml0IHRoZSBncmFkaW5nIHdpdGggcmVmZXJlbmNlIGNsYXNzCiAgICAgICAgOnBhcmFtIG5hbWU6IHRoZSBuYW1lIG9mIHRoZSBtZXRyaWNzCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlOiB0aGUgbW9kZWwgdG8gdXNlIGZvciBncmFkaW5nCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlX2NvbmZpZzogdGhlIGNvbmZpZyBvZiB0aGUgbW9kZWwgdG8gdXNlIGZvciBncmFkaW5nCiAgICAgICAgOnBhcmFtIG1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZzogdGhlIGNvbmZpZyBvZiB0aGUgbW9kZWwgdG8gdXNlIGZvciBpbmZlcmVuY2UKICAgICAgICA6cGFyYW0gdG9rZW5pemVyX2p1ZGdlX2NvbmZpZzogdGhlIGNvbmZpZyBvZiB0aGUgdG9rZW5pemVyIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9iZW5jaF9tYXJrOiB0aGUgbW9kZWwgdG8gdXNlIGZvciBiZW5jaCBtYXJraW5nCiAgICAgICAgOnBhcmFtIG1vZGVsX2JlbmNoX21hcmtfY29uZmlnOiB0aGUgY29uZmlnIG9mIHRoZSBtb2RlbCB0byB1c2UgZm9yIGJlbmNoIG1hcmtpbmcKICAgICAgICA6cGFyYW0gdG9rZW5pemVyX2JlbmNoX21hcmtfY29uZmlnOiB0aGUgY29uZmlnIG9mIHRoZSB0b2tlbml6ZXIgdG8gdXNlIGZvciBiZW5jaCBtYXJraW5nCiAgICAgICAgOnBhcmFtIG1vZGVsX2JlbmNoX21hcmtfaW5mZXJfY29uZmlnOiB0aGUgY29uZmlnIG9mIHRoZSBtb2RlbCB0byB1c2UgZm9yIGluZmVyZW5jZQogICAgICAgIDpwYXJhbSBwcm9tcHRfdGVtcGxhdGU6IHRoZSB0ZW1wbGF0ZSBvZiB0aGUgcHJvbXB0IHRvIHVzZQogICAgICAgIDpwYXJhbSBwcm9tcHRfY29uZmlnOiB0aGUgY29uZmlnIG9mIHRoZSBwcm9tcHQgdG8gdXNlCiAgICAgICAgIiIiCiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgbW9kZWxfanVkZ2UsCiAgICAgICAgICAgIG1vZGVsX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgbW9kZWxfYmVuY2hfbWFyaywKICAgICAgICAgICAgbW9kZWxfYmVuY2hfbWFya19jb25maWcsCiAgICAgICAgICAgIG1vZGVsX2JlbmNoX21hcmtfaW5mZXJfY29uZmlnLAogICAgICAgICAgICB0b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWcsCiAgICAgICAgICAgIHByb21wdF9jb25maWcsCiAgICAgICAgICAgIHByb21wdF90ZW1wbGF0ZSwKICAgICAgICAgICAgdG9rZW5pemVyX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnLAogICAgICAgICkKCiAgICBAX29wZW5fbXBpX2hhbmRsZXIod29ya2VyX2lucHV0cz0ic2FtcGxlX2RmIikKICAgIGRlZiBfY29tcHV0ZV9vdmVyX2RhdGEoCiAgICAgICAgc2VsZiwKICAgICAgICBzYW1wbGVfZGY6IHBkLkRhdGFGcmFtZSwKICAgICkgLT4gcGQuRGF0YUZyYW1lOgogICAgICAgICIiIgogICAgICAgIENvbXB1dGUgdGhlIG1ldHJpY3Mgb3ZlciBhIGRhdGFzZXQKICAgICAgICA6cGFyYW0gc2FtcGxlX2RmOiB0aGUgZGF0YSB0byBjb21wdXRlIHRoZSBtZXRyaWNzIG92ZXIKICAgICAgICA6cmV0dXJuczogdGhlIG1ldHJpY3Mgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbgogICAgICAgICIiIgogICAgICAgIGRmID0gc3VwZXIoKS5fY29tcHV0ZV9vdmVyX2RhdGEoc2FtcGxlX2RmKQogICAgICAgIGRmWyJyZWZlcmVuY2UiXSA9IHNhbXBsZV9kZlsicmVmZXJlbmNlIl0KICAgICAgICByZXR1cm4gZGYKCgpjbGFzcyBPUEVOQUlKdWRnZVNpbmdsZUdyYWRpbmcoTExNSnVkZ2VTaW5nbGVHcmFkaW5nKToKICAgICIiIgogICAgVXNpbmcgQVBJIHRvIGp1ZGdlIHRoZSByZXNwb25zZQogICAgIiIiCgogICAgX2RpY3RfZmllbGRzID0gWwogICAgICAgICJuYW1lIiwKICAgICAgICAibW9kZWxfanVkZ2UiLAogICAgICAgICJtb2RlbF9qdWRnZV9jb25maWciLAogICAgICAgICJwcm9tcHRfdGVtcGxhdGUiLAogICAgICAgICJwcm9tcHRfY29uZmlnIiwKICAgICAgICAibW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnIiwKICAgIF0KICAgIGtpbmQgPSAiT1BFTkFJX2p1ZGdlX3NpbmdsZV9ncmFkaW5nIgoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIG5hbWU6IHN0ciwKICAgICAgICBtb2RlbF9qdWRnZTogc3RyLAogICAgICAgIHByb21wdF9jb25maWc6IERpY3Rbc3RyLCBzdHJdLAogICAgICAgIHByb21wdF90ZW1wbGF0ZTogc3RyID0gU0lOR0xFX0dSQURFX1BST01QVCwKICAgICAgICBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICAgICBtb2RlbF9qdWRnZV9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgaW5pdCB0aGUgZ3JhZGluZyB3aXRoIHJlZmVyZW5jZSBjbGFzcwogICAgICAgIDpwYXJhbSBuYW1lOiB0aGUgbmFtZSBvZiB0aGUgbWV0cmljcwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZTogdGhlIG1vZGVsIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgaW5mZXJlbmNlCiAgICAgICAgOnBhcmFtIHByb21wdF90ZW1wbGF0ZTogdGhlIHRlbXBsYXRlIG9mIHRoZSBwcm9tcHQgdG8gdXNlCiAgICAgICAgOnBhcmFtIHByb21wdF9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIHByb21wdCB0byB1c2UKICAgICAgICAiIiIKICAgICAgICBzdXBlcigpLl9faW5pdF9fKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBtb2RlbF9qdWRnZSwKICAgICAgICAgICAgbW9kZWxfanVkZ2VfY29uZmlnLAogICAgICAgICAgICBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWcsCiAgICAgICAgICAgIHByb21wdF9jb25maWcsCiAgICAgICAgICAgIHByb21wdF90ZW1wbGF0ZSwKICAgICAgICApCgogICAgZGVmIF9wcmVwYXJlX2p1ZGdlKHNlbGYpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgUHJlcGFyZSB0aGUganVkZ2UgbW9kZWwKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiUHJlcGFyZSB0aGUgb3BlbkFJIG1vZGVsIGFzIGp1ZGdlIikKCiAgICAgICAgaWYgbm90IHNlbGYubW9kZWxfanVkZ2VfY29uZmlnOgogICAgICAgICAgICBpbXBvcnQgb3MKICAgICAgICAgICAgZnJvbSBkb3RlbnYgaW1wb3J0IGxvYWRfZG90ZW52CgogICAgICAgICAgICBsb2FkX2RvdGVudigpCiAgICAgICAgICAgIGFwaV9rZXkgPSBvcy5nZXRlbnYoIk9QRU5BSV9BUElfS0VZIikKICAgICAgICAgICAgYmFzZV91cmwgPSBvcy5nZXRlbnYoIk9QRU5BSV9BUElfQkFTRSIpCiAgICAgICAgICAgIE9QRU5BSV9KVURHRV9DT05GSUcgPSB7CiAgICAgICAgICAgICAgICAiYXBpX2tleSI6IGFwaV9rZXksCiAgICAgICAgICAgICAgICAiYmFzZV91cmwiOiBiYXNlX3VybCwKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLm1vZGVsX2p1ZGdlX2NvbmZpZyA9IE9QRU5BSV9KVURHRV9DT05GSUcKCiAgICAgICAgc2VsZi5tb2RlbCA9IG9wZW5haS5PcGVuQUkoCiAgICAgICAgICAgIGFwaV9rZXk9c2VsZi5tb2RlbF9qdWRnZV9jb25maWdbImFwaV9rZXkiXSwKICAgICAgICAgICAgYmFzZV91cmw9c2VsZi5tb2RlbF9qdWRnZV9jb25maWdbImJhc2VfdXJsIl0sCiAgICAgICAgKQoKICAgIGRlZiBfZXh0cmFjdF9zY29yZV9leHBsYW5hdGlvbihzZWxmLCByZXN1bHQ6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQWJzdHJhY3QgdGhlIHN0b3JlIG9mIHRoZSByZXN1bHQKICAgICAgICA6cGFyYW0gcmVzdWx0OiB0aGUgcmVzdWx0IHRvIHN0b3JlCiAgICAgICAgOnJldHVybnM6IHRoZSBzdG9yZWQgcmVzdWx0CiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJFeHRyYWN0aW5nIHRoZSBzY29yZSBhbmQgZXhwbGFuYXRpb24gZnJvbSB7cmVzdWx0fSIpCiAgICAgICAgc2NvcmVfcGF0dGVybiA9IHInW3NTXWNvcmU6XHMqKFxkKyknCiAgICAgICAgZXhwbGFuYXRpb25fcGF0dGVybiA9IHInW2VFXXhwbGFuYXRpb246XHMqIihbXiJdKykiJwoKICAgICAgICBzY29yZV9tYXRjaCA9IHJlLnNlYXJjaChzY29yZV9wYXR0ZXJuLCByZXN1bHQpCiAgICAgICAgc2NvcmUgPSBpbnQoc2NvcmVfbWF0Y2guZ3JvdXAoMSkpIGlmIHNjb3JlX21hdGNoIGVsc2UgTm9uZQoKICAgICAgICBleHBsYW5hdGlvbl9tYXRjaCA9IHJlLnNlYXJjaChleHBsYW5hdGlvbl9wYXR0ZXJuLCByZXN1bHQsIHJlLkRPVEFMTCkKICAgICAgICBleHBsYW5hdGlvbiA9IGV4cGxhbmF0aW9uX21hdGNoLmdyb3VwKDEpLnN0cmlwKCkgaWYgZXhwbGFuYXRpb25fbWF0Y2ggZWxzZSBOb25lCgogICAgICAgIHJldHVybiB7InNjb3JlIjogc2NvcmUsICJleHBsYW5hdGlvbiI6IGV4cGxhbmF0aW9ufQoKICAgIGRlZiBfY29tcHV0ZV9vdmVyX29uZV9kYXRhKHNlbGYsIHF1ZXN0aW9uLCByZXNwb25zZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIG9uZSBkYXRhIHBvaW50CiAgICAgICAgOnBhcmFtIGt3YXJnczogdGhlIGRhdGEgdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnJldHVybnM6IHRoZSBtZXRyaWNzIHNjb3JlIGFuZCB0aGUgZXhwbGFuYXRpb24KICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIG9uZSBkYXRhIHBvaW50IHVzaW5nIG9wZW5BSSdzIG1vZGVsIikKICAgICAgICBzZWxmLnByb21wdF9jb25maWdbImFuc3dlciJdID0gcmVzcG9uc2UKICAgICAgICBzZWxmLnByb21wdF9jb25maWdbInF1ZXN0aW9uIl0gPSBxdWVzdGlvbgogICAgICAgIHByb21wdCA9IHNlbGYuX2ZpbGxfcHJvbXB0KCkKICAgICAgICByZXMgPSBzZWxmLm1vZGVsLmNoYXQuY29tcGxldGlvbnMuY3JlYXRlKAogICAgICAgICAgICBtb2RlbD1zZWxmLm1vZGVsX2p1ZGdlLCBtZXNzYWdlcz1beyJyb2xlIjogInVzZXIiLCAiY29udGVudCI6IHByb21wdH1dCiAgICAgICAgKQogICAgICAgIHJlc19kaWMgPSBzZWxmLl9leHRyYWN0X3Njb3JlX2V4cGxhbmF0aW9uKHJlcy5jaG9pY2VzWzBdLm1lc3NhZ2UuY29udGVudCkKICAgICAgICByZXR1cm4gcmVzX2RpYwoKCmNsYXNzIE9QRU5BSUp1ZGdlUGFpcndpc2VHcmFkaW5nKExMTUp1ZGdlUGFpcndpc2VHcmFkaW5nKToKICAgICIiIgogICAgVXNpbmcgQVBJIHRvIGp1ZGdlIHRoZSByZXNwb25zZQogICAgIiIiCgogICAgX2RpY3RfZmllbGRzID0gWwogICAgICAgICJuYW1lIiwKICAgICAgICAibW9kZWxfanVkZ2UiLAogICAgICAgICJtb2RlbF9qdWRnZV9jb25maWciLAogICAgICAgICJtb2RlbF9iZW5jaF9tYXJrIiwKICAgICAgICAibW9kZWxfYmVuY2hfbWFya19jb25maWciLAogICAgICAgICJtb2RlbF9iZW5jaF9tYXJrX2luZmVyX2NvbmZpZyIsCiAgICAgICAgInRva2VuaXplcl9iZW5jaF9tYXJrX2NvbmZpZyIsCiAgICAgICAgInByb21wdF90ZW1wbGF0ZSIsCiAgICAgICAgInByb21wdF9jb25maWciLAogICAgICAgICJtb2RlbF9qdWRnZV9pbmZlcl9jb25maWciLAogICAgXQogICAga2luZCA9ICJPUEVOQUlfanVkZ2VfcGFpcl9ncmFkaW5nIgoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIG5hbWU6IHN0ciwKICAgICAgICBtb2RlbF9qdWRnZTogc3RyLAogICAgICAgIG1vZGVsX2JlbmNoX21hcms6IHN0ciwKICAgICAgICBtb2RlbF9iZW5jaF9tYXJrX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgbW9kZWxfYmVuY2hfbWFya19pbmZlcl9jb25maWc6IERpY3Rbc3RyLCBBbnldLAogICAgICAgIHRva2VuaXplcl9iZW5jaF9tYXJrX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgcHJvbXB0X2NvbmZpZzogRGljdFtzdHIsIHN0cl0sCiAgICAgICAgbW9kZWxfanVkZ2VfY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUsCiAgICAgICAgbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUsCiAgICAgICAgcHJvbXB0X3RlbXBsYXRlOiBzdHIgPSBQQUlSX0dSQURFX1BST01QVCwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgaW5pdCB0aGUgZ3JhZGluZyB3aXRoIHJlZmVyZW5jZSBjbGFzcwogICAgICAgIDpwYXJhbSBuYW1lOiB0aGUgbmFtZSBvZiB0aGUgbWV0cmljcwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZTogdGhlIG1vZGVsIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgaW5mZXJlbmNlCiAgICAgICAgOnBhcmFtIHByb21wdF90ZW1wbGF0ZTogdGhlIHRlbXBsYXRlIG9mIHRoZSBwcm9tcHQgdG8gdXNlCiAgICAgICAgOnBhcmFtIHByb21wdF9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIHByb21wdCB0byB1c2UKICAgICAgICAiIiIKICAgICAgICBzdXBlcigpLl9faW5pdF9fKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBtb2RlbF9qdWRnZSwKICAgICAgICAgICAgbW9kZWxfanVkZ2VfY29uZmlnLAogICAgICAgICAgICBtb2RlbF9iZW5jaF9tYXJrLAogICAgICAgICAgICBtb2RlbF9iZW5jaF9tYXJrX2NvbmZpZywKICAgICAgICAgICAgbW9kZWxfYmVuY2hfbWFya19pbmZlcl9jb25maWcsCiAgICAgICAgICAgIHRva2VuaXplcl9iZW5jaF9tYXJrX2NvbmZpZywKICAgICAgICAgICAgcHJvbXB0X2NvbmZpZywKICAgICAgICAgICAgcHJvbXB0X3RlbXBsYXRlLAogICAgICAgICAgICBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWcsCiAgICAgICAgKQoKICAgIGRlZiBfcHJlcGFyZV9qdWRnZShzZWxmKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIFByZXBhcmUgdGhlIGp1ZGdlIG1vZGVsCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIlByZXBhcmUgdGhlIG9wZW5BSSBtb2RlbCBhcyBqdWRnZSIpCiAgICAgICAgaWYgbm90IHNlbGYubW9kZWxfanVkZ2VfY29uZmlnOgogICAgICAgICAgICBpbXBvcnQgb3MKICAgICAgICAgICAgZnJvbSBkb3RlbnYgaW1wb3J0IGxvYWRfZG90ZW52CgogICAgICAgICAgICBsb2FkX2RvdGVudigpCiAgICAgICAgICAgIGFwaV9rZXkgPSBvcy5nZXRlbnYoIk9QRU5BSV9BUElfS0VZIikKICAgICAgICAgICAgYmFzZV91cmwgPSBvcy5nZXRlbnYoIk9QRU5BSV9BUElfQkFTRSIpCiAgICAgICAgICAgIE9QRU5BSV9KVURHRV9DT05GSUcgPSB7CiAgICAgICAgICAgICAgICAiYXBpX2tleSI6IGFwaV9rZXksCiAgICAgICAgICAgICAgICAiYmFzZV91cmwiOiBiYXNlX3VybCwKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLm1vZGVsX2p1ZGdlX2NvbmZpZyA9IE9QRU5BSV9KVURHRV9DT05GSUcKICAgICAgICBzZWxmLm1vZGVsID0gb3BlbmFpLk9wZW5BSSgKICAgICAgICAgICAgYXBpX2tleT1zZWxmLm1vZGVsX2p1ZGdlX2NvbmZpZ1siYXBpX2tleSJdLAogICAgICAgICAgICBiYXNlX3VybD1zZWxmLm1vZGVsX2p1ZGdlX2NvbmZpZ1siYmFzZV91cmwiXSwKICAgICAgICApCgogICAgZGVmIF9jb21wdXRlX292ZXJfb25lX2RhdGEoc2VsZiwgcXVlc3Rpb24sIHJlc3BvbnNlLCByZWZlcmVuY2U9Tm9uZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyIG9uZSBkYXRhIHBvaW50CiAgICAgICAgOnBhcmFtIGt3YXJnczogdGhlIGRhdGEgdG8gY29tcHV0ZSB0aGUgbWV0cmljcyBvdmVyCiAgICAgICAgOnJldHVybnM6IHRoZSBtZXRyaWNzIHNjb3JlIGFuZCB0aGUgZXhwbGFuYXRpb24KICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbyhmIkNvbXB1dGluZyB0aGUgbWV0cmljcyBvdmVyIHtxdWVzdGlvbn0gYW5kIHtyZXNwb25zZX0iKQogICAgICAgIHNlbGYucHJvbXB0X2NvbmZpZ1sicXVlc3Rpb24iXSA9IHF1ZXN0aW9uCiAgICAgICAgc2VsZi5wcm9tcHRfY29uZmlnWyJhbnN3ZXJBIl0gPSByZXNwb25zZQogICAgICAgIGlmIHJlZmVyZW5jZToKICAgICAgICAgICAgc2VsZi5wcm9tcHRfY29uZmlnWydyZWZlcmVuY2UnXSA9IHJlZmVyZW5jZQogICAgICAgIHNlbGYucHJvbXB0X2NvbmZpZ1siYW5zd2VyQiJdID0gc2VsZi5fY29tcHV0ZV9iZW5jaF9tYXJrX3Jlc3BvbnNlKHF1ZXN0aW9uKQogICAgICAgIHByb21wdCA9IHNlbGYuX2ZpbGxfcHJvbXB0KCkKICAgICAgICByZXMgPSBzZWxmLm1vZGVsLmNoYXQuY29tcGxldGlvbnMuY3JlYXRlKAogICAgICAgICAgICBtb2RlbD1zZWxmLm1vZGVsX2p1ZGdlLAogICAgICAgICAgICBtZXNzYWdlcz1beyJyb2xlIjogInVzZXIiLCAiY29udGVudCI6IHByb21wdH1dLAogICAgICAgICkKICAgICAgICByZXNfZGljID0gc2VsZi5fZXh0cmFjdF9zY29yZV9leHBsYW5hdGlvbihyZXMuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnQpCiAgICAgICAgcmVzX2RpY1siYW5zd2VyQiJdID0gc2VsZi5wcm9tcHRfY29uZmlnWyJhbnN3ZXJCIl0KICAgICAgICByZXR1cm4gcmVzX2RpYwoKICAgIGRlZiBfZXh0cmFjdF9zY29yZV9leHBsYW5hdGlvbihzZWxmLCByZXNwb25zZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgRXh0cmFjdCB0aGUgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbiBmcm9tIHRoZSByZXNwb25zZQogICAgICAgIDpwYXJhbSByZXNwb25zZTogdGhlIHJlc3BvbnNlIHRvIGV4dHJhY3QgdGhlIHNjb3JlIGFuZCB0aGUgZXhwbGFuYXRpb24gZnJvbQogICAgICAgIDpyZXR1cm5zOiB0aGUgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbgogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKGYiRXh0cmFjdCB0aGUgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbiBmcm9tIHRoZSB7cmVzcG9uc2V9IikKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcyA9IGpzb24ubG9hZHMocmVzcG9uc2UpCiAgICAgICAgICAgIHJlc3VsdF9kaWN0ID0ge30KICAgICAgICAgICAgcmVzdWx0X2RpY3RbInNjb3JlX29mX2Fzc2lzdGFudF9hIl0gPSByZXNbInNjb3JlIG9mIGFzc2lzdGFudCBhIl0KICAgICAgICAgICAgcmVzdWx0X2RpY3RbInNjb3JlX29mX2Fzc2lzdGFudF9iIl0gPSByZXNbInNjb3JlIG9mIGFzc2lzdGFudCBiIl0KICAgICAgICAgICAgcmVzdWx0X2RpY3RbImV4cGxhbmF0aW9uX29mX2Fzc2lzdGFudF9hIl0gPSByZXNbCiAgICAgICAgICAgICAgICAiZXhwbGFuYXRpb24gb2YgYXNzaXN0YW50IGEiCiAgICAgICAgICAgIF0KICAgICAgICAgICAgcmVzdWx0X2RpY3RbImV4cGxhbmF0aW9uX29mX2Fzc2lzdGFudF9iIl0gPSByZXNbCiAgICAgICAgICAgICAgICAiZXhwbGFuYXRpb24gb2YgYXNzaXN0YW50IGIiCiAgICAgICAgICAgIF0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdF9kaWN0CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBBZGp1c3RlZCBwYXR0ZXJuIHRvIG1hdGNoIHRoZSB0ZXh0IGZvcm1hdCBhbmQgc2VwYXJhdGUgbGluZXMKICAgICAgICAgICAgcGF0dGVybiA9IHIiLT9ccz9bU3NdY29yZSBvZiBbYUFdc3Npc3RhbnQgKFthLXpBLVpdKyk6IChcZCspLio/LT9ccz9bRWVdeHBsYW5hdGlvbiBvZiBbYUFdc3Npc3RhbnQgW2EtekEtWl0rOiAoLio/KSg/PS0/XHM/W3NTXWNvcmUgb2YgW2FBXXNzaXN0YW50IFthLXpBLVpdKzp8JCkiCiAgICAgICAgICAgIG1hdGNoZXMgPSByZS5maW5kYWxsKHBhdHRlcm4sIHJlc3BvbnNlLCByZS5ET1RBTEwpCgogICAgICAgICAgICBpZiBtYXRjaGVzOgogICAgICAgICAgICAgICAgcmVzdWx0X2RpY3QgPSB7fQogICAgICAgICAgICAgICAgZm9yIG1hdGNoIGluIG1hdGNoZXM6CiAgICAgICAgICAgICAgICAgICAgYXNzaXN0YW50LCBzY29yZSwgZXhwbGFuYXRpb24gPSBtYXRjaAogICAgICAgICAgICAgICAgICAgIHJlc3VsdF9kaWN0W2Yic2NvcmVfb2ZfYXNzaXN0YW50X3thc3Npc3RhbnR9Ii5sb3dlcigpXSA9IGludChzY29yZSkKICAgICAgICAgICAgICAgICAgICByZXN1bHRfZGljdFsKICAgICAgICAgICAgICAgICAgICAgICAgZiJleHBsYW5hdGlvbl9vZl9hc3Npc3RhbnRfe2Fzc2lzdGFudH0iLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICBdID0gZXhwbGFuYXRpb24uc3RyaXAoKQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdF9kaWN0CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgICJObyBtYXRjaGVzIGZvdW5kIGFmdGVyICdbT3V0cHV0XTonIG1hcmtlci4gIgogICAgICAgICAgICAgICAgICAgICJQbGVhc2UgY2hlY2sgdGhlIGZvcm1hdCBvZiB0aGUgcmVzcG9uc2UuIgogICAgICAgICAgICAgICAgKQoKCmNsYXNzIE9QRU5BSUp1ZGdlUmVmZXJlbmNlR3JhZGluZyhPUEVOQUlKdWRnZVBhaXJ3aXNlR3JhZGluZyk6CiAgICAiIiIKICAgIE9QRU5BSSBKdWRnZSBSZWZlcmVuY2UgR3JhZGluZyBjbGFzcwogICAgeW91IG5lZWQgdG8gZ2l2ZSB0aGUgbmFtZSBvZiB0aGUgbWV0cmljcywgZ2l2ZSB0aGUgZ3JhZGluZyBydWJyaWMgYW5kIHRoZSBiZW5jaCBtYXJrIG1vZGVsIHRvIHVzZQogICAgVGhpcyBjbGFzcyByZXF1cmllIHlvdSBrbm93IHRoZSB5X3RydWUgb2YgdGhlIHJlc3BvbnNlCiAgICAiIiIKCiAgICBfZGljdF9maWVsZHMgPSBbCiAgICAgICAgIm5hbWUiLAogICAgICAgICJtb2RlbF9qdWRnZSIsCiAgICAgICAgIm1vZGVsX2p1ZGdlX2NvbmZpZyIsCiAgICAgICAgIm1vZGVsX2JlbmNoX21hcmsiLAogICAgICAgICJtb2RlbF9iZW5jaF9tYXJrX2NvbmZpZyIsCiAgICAgICAgIm1vZGVsX2JlbmNoX21hcmtfaW5mZXJfY29uZmlnIiwKICAgICAgICAidG9rZW5pemVyX2JlbmNoX21hcmtfY29uZmlnIiwKICAgICAgICAicHJvbXB0X3RlbXBsYXRlIiwKICAgICAgICAicHJvbXB0X2NvbmZpZyIsCiAgICAgICAgIm1vZGVsX2p1ZGdlX2luZmVyX2NvbmZpZyIsCiAgICBdCiAgICBraW5kID0gIk9QRU5BSV9qdWRnZV9yZWZlcmVuY2VfZ3JhZGluZyIKCiAgICBkZWYgX19pbml0X18oCiAgICAgICAgc2VsZiwKICAgICAgICBuYW1lOiBzdHIsCiAgICAgICAgbW9kZWxfanVkZ2U6IHN0ciwKICAgICAgICBtb2RlbF9iZW5jaF9tYXJrOiBzdHIsCiAgICAgICAgbW9kZWxfYmVuY2hfbWFya19jb25maWc6IERpY3Rbc3RyLCBBbnldLAogICAgICAgIHRva2VuaXplcl9iZW5jaF9tYXJrX2NvbmZpZzogRGljdFtzdHIsIEFueV0sCiAgICAgICAgbW9kZWxfYmVuY2hfbWFya19pbmZlcl9jb25maWc6IERpY3Rbc3RyLCBBbnldLAogICAgICAgIHByb21wdF9jb25maWc6IERpY3Rbc3RyLCBzdHJdLAogICAgICAgIG1vZGVsX2p1ZGdlX2NvbmZpZzogRGljdFtzdHIsIEFueV0gPSBOb25lLAogICAgICAgIHByb21wdF90ZW1wbGF0ZTogc3RyID0gUkVGX0dSQURFX1BST01QVCwKICAgICAgICBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IERpY3Rbc3RyLCBBbnldID0gTm9uZSwKICAgICk6CiAgICAgICAgIiIiCiAgICAgICAgaW5pdCB0aGUgZ3JhZGluZyB3aXRoIHJlZmVyZW5jZSBjbGFzcwogICAgICAgIDpwYXJhbSBuYW1lOiB0aGUgbmFtZSBvZiB0aGUgbWV0cmljcwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZTogdGhlIG1vZGVsIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgZ3JhZGluZwogICAgICAgIDpwYXJhbSBtb2RlbF9qdWRnZV9pbmZlcl9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgaW5mZXJlbmNlCiAgICAgICAgOnBhcmFtIG1vZGVsX2JlbmNoX21hcms6IHRoZSBtb2RlbCB0byB1c2UgZm9yIGJlbmNoIG1hcmtpbmcKICAgICAgICA6cGFyYW0gbW9kZWxfYmVuY2hfbWFya19jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgYmVuY2ggbWFya2luZwogICAgICAgIDpwYXJhbSB0b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIHRva2VuaXplciB0byB1c2UgZm9yIGJlbmNoIG1hcmtpbmcKICAgICAgICA6cGFyYW0gbW9kZWxfYmVuY2hfbWFya19pbmZlcl9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIG1vZGVsIHRvIHVzZSBmb3IgaW5mZXJlbmNlCiAgICAgICAgOnBhcmFtIHByb21wdF90ZW1wbGF0ZTogdGhlIHRlbXBsYXRlIG9mIHRoZSBwcm9tcHQgdG8gdXNlCiAgICAgICAgOnBhcmFtIHByb21wdF9jb25maWc6IHRoZSBjb25maWcgb2YgdGhlIHByb21wdCB0byB1c2UKICAgICAgICAiIiIKICAgICAgICBzdXBlcigpLl9faW5pdF9fKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBtb2RlbF9qdWRnZSwKICAgICAgICAgICAgbW9kZWxfYmVuY2hfbWFyaywKICAgICAgICAgICAgbW9kZWxfYmVuY2hfbWFya19jb25maWcsCiAgICAgICAgICAgIG1vZGVsX2JlbmNoX21hcmtfaW5mZXJfY29uZmlnLAogICAgICAgICAgICB0b2tlbml6ZXJfYmVuY2hfbWFya19jb25maWcsCiAgICAgICAgICAgIHByb21wdF9jb25maWcsCiAgICAgICAgICAgIG1vZGVsX2p1ZGdlX2NvbmZpZywKICAgICAgICAgICAgbW9kZWxfanVkZ2VfaW5mZXJfY29uZmlnLAogICAgICAgICAgICBwcm9tcHRfdGVtcGxhdGUsCiAgICAgICAgKQoKTWV0cmljc1R5cGVfZGljID0gewogICAgIkxMTUp1ZGdlU2luZ2xlR3JhZGluZyI6IExMTUp1ZGdlU2luZ2xlR3JhZGluZywKICAgICJMTE1KdWRnZVBhaXJ3aXNlR3JhZGluZyI6IExMTUp1ZGdlUGFpcndpc2VHcmFkaW5nLAogICAgIkxMTUp1ZGdlUmVmZXJlbmNlR3JhZGluZyI6IExMTUp1ZGdlUmVmZXJlbmNlR3JhZGluZywKICAgICJPUEVOQUlKdWRnZVNpbmdsZUdyYWRpbmciOiBPUEVOQUlKdWRnZVNpbmdsZUdyYWRpbmcsCiAgICAiT1BFTkFJSnVkZ2VQYWlyd2lzZUdyYWRpbmciOiBPUEVOQUlKdWRnZVBhaXJ3aXNlR3JhZGluZywKICAgICJPUEVOQUlKdWRnZVJlZmVyZW5jZUdyYWRpbmciOiBPUEVOQUlKdWRnZVJlZmVyZW5jZUdyYWRpbmcsCn0KCk1ldHJpY3NUeXBlID0gVHlwZVZhcigKICAgICJNZXRyaWNzVHlwZSIsCiAgICBMTE1KdWRnZVNpbmdsZUdyYWRpbmcsCiAgICBMTE1KdWRnZVBhaXJ3aXNlR3JhZGluZywKICAgIExMTUp1ZGdlUmVmZXJlbmNlR3JhZGluZywKICAgIE9QRU5BSUp1ZGdlU2luZ2xlR3JhZGluZywKICAgIE9QRU5BSUp1ZGdlUGFpcndpc2VHcmFkaW5nLAogICAgT1BFTkFJSnVkZ2VSZWZlcmVuY2VHcmFkaW5nLAopCgoKZGVmIF9nZXRfbWV0cmljcygKICAgIG1ldHJpY190eXBlOiBzdHIsCiAgICAqKmt3YXJnczogQW55LAopIC0+IE1ldHJpY3NUeXBlOgogICAgIiIiCiAgICBJbml0IHRoZSBtZXRyaWMgY2xhc3MgYmFzZWQgb24gZGlmZmVyZW50IHR5cGUgb2YgbWV0cmljcwogICAgOnBhcmFtIG1ldHJpY190eXBlOiB0aGUgdHlwZSBvZiB0aGUgbWV0cmljCiAgICA6cGFyYW0ga3dhcmdzOiB0aGUgY29uZmlnIG9mIHRoZSBtZXRyaWMKICAgIDpyZXR1cm5zOiB0aGUgbWV0cmljIG9iagogICAgIiIiCiAgICByZXR1cm4gTWV0cmljc1R5cGVfZGljW21ldHJpY190eXBlXSgqKmt3YXJncykKCgpkZWYgbGxtX2p1ZGdlKAogICAgaW5wdXRfcGF0aDogVW5pb25bc3RyLCBwYXRobGliLlBhdGhdLAogICAgKiprd2FyZ3MsCikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBDb21wdXRlIHRoZSBtZXRyaWNzIG92ZXIgYSBkYXRhc2V0CgogICAgOnBhcmFtIGlucHV0X3BhdGg6IHRoZSBwYXRoIHRvIHRoZSBpbnB1dCBkYXRhCiAgICA6cGFyYW0ga3dhcmdzOiB0aGUgY29uZmlnIG9mIHRoZSBtZXRyaWMKCiAgICA6cmV0dXJuczogdGhlIG1ldHJpY3Mgc2NvcmUgYW5kIHRoZSBleHBsYW5hdGlvbgogICAgIiIiCiAgICBtZXRyaWMgPSBfZ2V0X21ldHJpY3MoKiprd2FyZ3MpCiAgICBzYW1wbGVfZGYgPSBwZC5yZWFkX2NzdihpbnB1dF9wYXRoKQogICAgcmVzX2RmID0gbWV0cmljLl9jb21wdXRlX292ZXJfZGF0YShzYW1wbGVfZGYpCiAgICByZXR1cm4gcmVzX2RmCg==
    base_image: mlrun/mlrun
    commands: []
    code_origin: ''
    origin_filename: ''
    requirements:
    - pytest==5.2.0
    - pandas
    - openai
    - mlrun==1.4.0
    - auto-gptq
    - openmpi
    - mpi4py
    - transformers
    - torch=2.0.0
    - accelerate
    - einops
    - optimum
  entry_points:
    llm_judge:
      name: llm_judge
      doc: Compute the metrics over a dataset
      parameters:
      - name: input_path
        type: Union[str, Path]
        doc: the path to the input data
      outputs:
      - doc: the metrics score and the explanation
        default: ''
      lineno: 1045
  description: This function is used to compute the metrics using llm as a judge
  default_handler: llm_judge
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  resources:
    requests:
      memory: 1Mi
      cpu: 25m
    limits:
      memory: 20Gi
      cpu: '2'
  priority_class_name: igz-workload-medium
  preemption_mode: prevent
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: app.iguazio.com/lifecycle
            operator: NotIn
            values:
            - preemptible
          - key: eks.amazonaws.com/capacityType
            operator: NotIn
            values:
            - SPOT
          - key: node-lifecycle
            operator: NotIn
            values:
            - spot
  tolerations: null
  security_context: {}
verbose: false
