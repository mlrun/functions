kind: job
metadata:
  name: test-classifier
  tag: ''
  hash: ddc8ff8b66cfb4ef4f591ee496da9d1681d7b45e
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - testing
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: test_classifier
  entry_points:
    test_classifier:
      name: test_classifier
      doc: "Test one or more classifier models against held-out dataset\n\nUsing held-out\
        \ test features, evaluates the peformance of the estimated model\n\nCan be\
        \ part of a kubeflow pipeline as a test step that is run post EDA and \ntraining/validation\
        \ cycles"
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: models_path
        type: str
        doc: artifact models representing a file or a folder
      - name: test_set
        type: str
        doc: test features and labels
      - name: label_column
        type: str
        doc: column name for ground truth labels
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: plots_dest
        type: str
        doc: dir for test plots
      outputs: []
      lineno: 28
  description: test a classifier using held-out or new data
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTI1IDE0OjU3CgppbXBvcnQgbWxydW4KCmltcG9ydCBvcwppbXBvcnQganNvbgppbXBvcnQgaW1wb3J0bGliCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGxvYWQKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCgppbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwpmcm9tIHNrbGVhcm4ucHJlcHJvY2Vzc2luZyBpbXBvcnQgbGFiZWxfYmluYXJpemUKZnJvbSBza2xlYXJuLnV0aWxzLm11bHRpY2xhc3MgaW1wb3J0IHVuaXF1ZV9sYWJlbHMKCmZyb20gbWxydW4uZXhlY3V0aW9uIGltcG9ydCBNTENsaWVudEN0eApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KZnJvbSBtbHJ1bi5hcnRpZmFjdHMgaW1wb3J0IFRhYmxlQXJ0aWZhY3QsIFBsb3RBcnRpZmFjdAoKZnJvbSBtbHJ1bi5tbHV0aWxzIGltcG9ydCBwbG90X3JvYywgcGxvdF9pbXBvcnRhbmNlLCBnY2ZfY2xlYXIKCmltcG9ydCB3YXJuaW5ncwp3YXJuaW5ncy5zaW1wbGVmaWx0ZXIoYWN0aW9uPSJpZ25vcmUiLCBjYXRlZ29yeT1GdXR1cmVXYXJuaW5nKQoKCmRlZiB0ZXN0X2NsYXNzaWZpZXIoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIG1vZGVsc19wYXRoOiBzdHIsIAogICAgdGVzdF9zZXQ6IHN0ciwKICAgIGxhYmVsX2NvbHVtbjogc3RyLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAnbWljcm8nLAogICAgcGxvdHNfZGVzdDogc3RyID0gIiIKKSAtPiBOb25lOgogICAgIiIiVGVzdCBvbmUgb3IgbW9yZSBjbGFzc2lmaWVyIG1vZGVscyBhZ2FpbnN0IGhlbGQtb3V0IGRhdGFzZXQKICAgIAogICAgVXNpbmcgaGVsZC1vdXQgdGVzdCBmZWF0dXJlcywgZXZhbHVhdGVzIHRoZSBwZWZvcm1hbmNlIG9mIHRoZSBlc3RpbWF0ZWQgbW9kZWwKICAgIAogICAgQ2FuIGJlIHBhcnQgb2YgYSBrdWJlZmxvdyBwaXBlbGluZSBhcyBhIHRlc3Qgc3RlcCB0aGF0IGlzIHJ1biBwb3N0IEVEQSBhbmQgCiAgICB0cmFpbmluZy92YWxpZGF0aW9uIGN5Y2xlcwogICAgCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIG1vZGVsc19wYXRoOiAgICAgYXJ0aWZhY3QgbW9kZWxzIHJlcHJlc2VudGluZyBhIGZpbGUgb3IgYSBmb2xkZXIKICAgIDpwYXJhbSB0ZXN0X3NldDogICAgICAgIHRlc3QgZmVhdHVyZXMgYW5kIGxhYmVscwogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgY29sdW1uIG5hbWUgZm9yIGdyb3VuZCB0cnV0aCBsYWJlbHMKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgIGZvciBtdWx0aWNsYXNzIGNsYXNzaWZpY2F0aW9uCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgZGlyIGZvciB0ZXN0IHBsb3RzCiAgICAiIiIKICAgIHh0ZXN0ID0gcGQucmVhZF9wYXJxdWV0KHN0cih0ZXN0X3NldCkpCiAgICB5dGVzdCA9IHh0ZXN0LnBvcChsYWJlbF9jb2x1bW4pCiAgICAKICAgIGNvbnRleHQuaGVhZGVyID0gbGlzdCh4dGVzdC5jb2x1bW5zLnZhbHVlcykKICAgIGRlZiBfZXZhbF9tb2RlbChtb2RlbCk6CiAgICAgICAgeXRlc3RiID0gbGFiZWxfYmluYXJpemUoeXRlc3QsIGNsYXNzZXM9eXRlc3QudW5pcXVlKCkpCiAgICAgICAgY2xmID0gbG9hZChvcGVuKG1vZGVsLCAicmIiKSkKICAgICAgICBpZiBjYWxsYWJsZShnZXRhdHRyKGNsZiwgInByZWRpY3RfcHJvYmEiKSk6CiAgICAgICAgICAgIHlfc2NvcmUgPSBjbGYucHJlZGljdF9wcm9iYSh4dGVzdC52YWx1ZXMpCiAgICAgICAgICAgIHlwcmVkID0gY2xmLnByZWRpY3QoeHRlc3QudmFsdWVzKQogICAgICAgICAgICBwbG90X3JvYyhjb250ZXh0LCB5dGVzdGIsIHlfc2NvcmUsIGtleT0ncm9jJywgcGxvdHNfZGlyPXBsb3RzX2Rlc3QpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeXByZWQgPSBjbGYucHJlZGljdCh4dGVzdC52YWx1ZXMpICMgcmVmYWN0b3IKICAgICAgICAgICAgeV9zY29yZSA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgZ2NmX2NsZWFyKHBsdCkKICAgICAgICBtZXRyaWNzLnBsb3RfY29uZnVzaW9uX21hdHJpeChjbGYsIHh0ZXN0LnZhbHVlcywgeXRlc3QsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVscz15dGVzdC51bmlxdWUoKSwgbm9ybWFsaXplPSd0cnVlJykgCiAgICAgICAgCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoUGxvdEFydGlmYWN0KCJjb25mdXNpb24iLCBib2R5PXBsdC5nY2YoKSksIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0vY29uZnVzaW9uLmh0bWwiKSAgICAgICAgCiAgICAKICAgICAgICBpZiBoYXNhdHRyKGNsZiwgImZlYXR1cmVfaW1wb3J0YW5jZXNfIik6CiAgICAgICAgICAgIHBsb3RfaW1wb3J0YW5jZShjb250ZXh0LCBjbGYsIGtleT1mImZlYXRpbXAiKQoKICAgICAgICB5dGVzdGIgPSBsYWJlbF9iaW5hcml6ZSh5dGVzdCwgY2xhc3Nlcz15dGVzdC51bmlxdWUoKSkKCiAgICAgICAgaWYgeXRlc3RiLnNoYXBlWzFdID4gMToKICAgICAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl0ZXN0YiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl0ZXN0YiwgeV9zY29yZSkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl0ZXN0YiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmVbOiwgMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYicm9jYXVjIiwgbWV0cmljcy5yb2NfYXVjX3Njb3JlKHl0ZXN0YiwgeV9zY29yZVs6LCAxXSkpCgogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImF2Z19wcmVjc2NvcmUiLCBhdmVyYWdlX3ByZWNpc2lvbikKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhY2N1cmFjeSIsIGZsb2F0KGNsZi5zY29yZSh4dGVzdC52YWx1ZXMsIHl0ZXN0KSkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiZjFfc2NvcmUiLCBtZXRyaWNzLmYxX3Njb3JlKHl0ZXN0LCB5cHJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpKQogICAgICAgIGlmIHlfc2NvcmUgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHlfc2NvcmUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4geXByZWQKICAgIAogICAgbW9kZWxzX3BhdGggPSBzdHIobW9kZWxzX3BhdGgpCiAgICBmb3IgbW9kZWwgaW4gb3MubGlzdGRpcihtb2RlbHNfcGF0aCk6CiAgICAgICAgaWYgbW9kZWwuZW5kc3dpdGgoJy5wa2wnKToKICAgICAgICAgICAgeV9oYXQgPSBfZXZhbF9tb2RlbChvcy5wYXRoLmpvaW4obW9kZWxzX3BhdGgsIG1vZGVsKSkKICAgICAgICAgICAgaWYgeV9oYXQubmRpbSA9PSAxIG9yIHlfaGF0LnNoYXBlWzFdID09IDE6CiAgICAgICAgICAgICAgICBzY29yZV9uYW1lcyA9IFsieXNjb3JlIl0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNjb3JlX25hbWVzID0gWyJ5c2NvcmVfIiArIHN0cih4KSBmb3IgeCBpbiByYW5nZSh5X2hhdC5zaGFwZVsxXSldCiAgICAgICAgICAgIGRmID0gcGQuY29uY2F0KFt4dGVzdCwgeXRlc3QsIHBkLkRhdGFGcmFtZSh5X2hhdCwgY29sdW1ucz1zY29yZV9uYW1lcyldLCBheGlzPTEpCiAgICAgICAgICAgIGNvbnRleHQubG9nX2RhdGFzZXQoInRlc3Rfc2V0X3ByZWRzIiwgZGY9ZGYsIGZvcm1hdD0icGFycXVldCIsIGluZGV4PUZhbHNlKQoK
    commands: []
    code_origin: https://github.com/yjb-ds/functions.git#a21da8bbcb1047785df2e6a31d108cad9026a158:test_classifier.ipynb
